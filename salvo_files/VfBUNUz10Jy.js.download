;/*FB_PKG_DELIM*/

__d("MAWCommonWebWorkerErrorLogging",["Env","ErrorGuard","ErrorPubSub","ErrorSetup","ErrorTransport","JSErrorLoggingConfig","SiteData","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(){(e||(e=r("ErrorGuard"))).skipGuardGlobal((s||(s=r("Env"))).nocatch),r("ErrorSetup").setup({appId:r("JSErrorLoggingConfig").appId,client_revision:r("SiteData").client_revision,extra:r("JSErrorLoggingConfig").extra,loggingFramework:"worker",projectBlocklist:r("JSErrorLoggingConfig").projectBlocklist,report_source:r("JSErrorLoggingConfig").report_source,report_source_ref:r("JSErrorLoggingConfig").report_source_ref,sample_weight:r("JSErrorLoggingConfig").sampleWeight!=null?r("JSErrorLoggingConfig").sampleWeight:0,site_category:"armadillo-worker"},o("ErrorTransport").log),t.addEventListener("unhandledrejection",function(e){var t=e.reason;(u||(u=r("ErrorPubSub"))).reportError(r("getErrorSafe")(t))})}r("ErrorSetup").preSetup(),l.init=c}),98);
__d("WAAbPropsHelpers",["WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=86400,m=600,p=604800;function _(e){return e==null?d:Math.max(m,Math.min(p,e))}function f(e){var t=[];return Object.keys(e).forEach(function(n){var r=e[n],o=r[0],a=r[1],i=r[2];typeof o=="number"&&t.push({configName:n,configCode:o,configDefault:i})}),t}function g(e,t){var n=e[t][0];return typeof n=="number"?n:null}function h(t,n){switch(typeof n){case"boolean":return t==="1";case"number":return parseFloat(t);case"string":return t;default:return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["parseValue: unsure how to read ",""])),t),null}}function y(e,t){var n=new Map;t.forEach(function(e){var t=e.configCode,r=e.configExpoKey,o=e.configValue;n.set(t,{configValue:o,configExpoKey:r})});var r={},o={};return f(e).forEach(function(e){var t=e.configCode,a=e.configDefault,i=e.configName,l=n.get(t);if(l!=null){var s=l.configExpoKey,u=l.configValue,c=h(u,a);c!=null&&(r[i]=c),o[t]=s!=null?s:null}}),{values:r,expoKeys:o}}function C(e,t,n){var r=babelHelpers.extends({},t,e),a={};return Object.keys(r).forEach(function(e){if(n[e]==null){o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdatePropValues: deleting config ",""])),e);return}a[e]=r[e]}),a}function b(e,t,n){var r=babelHelpers.extends({},t,e),a={},i=f(n).map(function(e){return e.configCode}),l=new Set(i),s=new Set;return Object.keys(r).forEach(function(e){var n=parseInt(e,10),i=t?t[n]:null;l.has(n)?(r[n]!==i&&(o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdateExpoKeys: config_expo_key "," changed"])),n),i!=null&&i.trim()&&s.add(i)),a[n]=r[n]):(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdateExpoKeys: deleting config_expo_key ",""])),n),i!=null&&i.trim()&&s.add(i))}),{propExpoKeys:a,expoKeysToDelete:s}}function v(e,t){if(t!=null){var n=t;if(e.forEach(function(e){n.delete(e)}),n.size!==0)return{internalExpoKeys:n,expoKeyStr:Array.from(n).join(",")}}}l.maybeUpdateRefresh=_,l.asAbList=f,l.asAbCode=g,l.parseAbProps=y,l.maybeUpdatePropValues=C,l.maybeUpdateExpoKeys=b,l.maybeUpdateInternalExpoKeys=v}),98);
__d("WAAbProps",["WAAbPropsHelpers","err"],(function(t,n,r,o,a,i,l){"use strict";var e=null;function s(t){if(e)return e;throw r("err")("abProps::"+t+" called before startAbProps")}function u(t,n){e==null&&(e={config:n,db:t})}function c(){return s("getHash").db.getHash()}function d(){return s("getRefreshSecs").db.getRefreshSecs().then(function(e){return o("WAAbPropsHelpers").maybeUpdateRefresh(e)})}function m(){return s("getConfig").config}function p(){return s("getAbProps").db.getAbProps()}function _(e){return s("getAbProps").db.setAbProps(e)}l.startAbProps=u,l.getHash=c,l.getRefreshSecs=d,l.getConfig=m,l.getAbProps=p,l.setAbProps=_}),98);
__d("WAAbPropConverters",[],(function(t,n,r,o,a,i){"use strict";function e(e){if(!e)return{};var t={};return Object.keys(e).forEach(function(n){var r=e[n];r!=null&&(t[n]=r)}),t}i.convertAbPropsToPlainObject=e}),66);
__d("WAAbPropsCache",["WAAbPropConverters"],(function(t,n,r,o,a,i,l){"use strict";var e=86400,s=(function(){function t(e){var t=e.abHash,n=e.abKey,r=e.expoKeyStr,o=e.internalExpoKeys,a=e.lastSyncTime,i=e.overridePropValues,l=e.propExpoKeys,s=e.propValues,u=e.refresh;this.$1=i!=null?i:{},this.$2=s,this.$4=t,this.$3=n,this.$5=a,this.$7=u,this.$6=r,this.$8=o,this.$9=l}var n=t.prototype;return n.getAbProp=function(t){var e;return this.$1[t]!=null?this.$1[t]:(e=this.$2)==null?void 0:e[t]},n.getHash=function(){return this.$4},n.getRefreshSecs=function(){var t;return(t=this.$7)!=null?t:e},n.overrideAbProp=function(t,n){this.$1[t]=n},n.readAll=function(){var e={abKey:this.$3,hash:this.getHash(),refresh:this.getRefreshSecs(),lastSyncTime:this.$5||0};if(this.$9!=null&&(e.propExpoKeys=this.$9),this.$8!=null&&(e.internalExpoKeys=this.$8),this.$6!=null&&(e.expoKeyStr=this.$6),this.$2!=null){var t=this.$2;t!=null&&(e.propValues=o("WAAbPropConverters").convertAbPropsToPlainObject(t),this.$1!=null&&(e.propValues=babelHelpers.extends({},e.propValues,o("WAAbPropConverters").convertAbPropsToPlainObject(this.$1))))}return e},n.rewrite=function(t){var e=t.abHash,n=t.abKey,r=t.expoKeyStr,o=t.internalExpoKeys,a=t.lastSyncTime,i=t.propExpoKeys,l=t.propValues,s=t.refresh;this.$2=l,this.$4=e,this.$3=n,this.$5=a,this.$7=s,this.$6=r,this.$8=o,this.$9=i},t})();l.AbPropsCache=s}),98);
__d("WAAbPropsConverters",["WAAbPropsTypes","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){var n={expoKeyStr:t.expoKeyStr,internalExpoKeys:t.internalExpoKeys?Array.from(t.internalExpoKeys):[],lastSyncTime:t.lastSyncTime,refresh:t.refresh};if(t.abHash!=null&&(n.abHash=t.abHash),t.abKey!=null&&(n.abKey=t.abKey),t.propExpoKeys){var r=t.propExpoKeys,a=[];Object.keys(r).forEach(function(e){var t=Number(e),n={expoKey:t};r[t]!=null&&(n.value=r[t]),a.push(n)}),n.propExpoKeys=a}if(t.propValues){var i=t.propValues,l=[];Object.keys(i).forEach(function(t){var n={name:t,value:{}};switch(typeof i[t]){case"boolean":n.value.boolValue=i[t];break;case"number":n.value.intValue=i[t];break;case"string":n.value.strValue=i[t];break;default:o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["convertAbPropsParsedToDbEntity: unsure how to read ",""])),i[t]);return}l.push(n)}),n.propValues=l}return n}function c(e){var t={expoKeyStr:e.expoKeyStr,internalExpoKeys:e.internalExpoKeys,lastSyncTime:e.lastSyncTime,propExpoKeys:e.propExpoKeys,refresh:e.refresh};if(e.hash!=null&&(t.abHash=e.hash),e.abKey!=null&&(t.abKey=e.abKey),e.propValues){var n=e.propValues,r={};Object.keys(n).forEach(function(e){n[e]!=null&&(r[e]=n[e])}),t.propValues=r}return t}function d(e){var t=e.abHash,n=e.abKey,r=e.expoKeyStr,a=e.internalExpoKeys,i=e.lastSyncTime,l=e.propExpoKeys,u=e.propValues,c=e.refresh,d={abHash:t,abKey:n,expoKeyStr:r,lastSyncTime:i,refresh:c};if(a!=null&&(d.internalExpoKeys=new Set(a)),l!=null){var m={};l.forEach(function(e){e.expoKey!=null&&(m[e.expoKey]=e.value)}),d.propExpoKeys=m}if(u!=null){var p={};u.forEach(function(e){var t=e.name,n=o("WAAbPropsTypes").ABPropConfigs[t];if(!(n==null||n.length<3)){var r=n[2];switch(typeof r){case"boolean":p[t]=e.value.boolValue;return;case"number":p[t]=e.value.intValue;return;case"string":p[t]=e.value.strValue;return;default:o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["convertDbAbPropsToParsed: unsure how to read ",""])),r);return}}}),d.propValues=p}return d}l.convertAbPropsParsedToDbEntity=u,l.convertAbPropsDataToParsed=c,l.convertDbAbPropsToParsed=d}),98);
__d("WAHandleFailureUtils",["FBLogger","MAWODSProxy","WABridge","WAOdsEnums","getErrorSafe","promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("MAWClearSignalAndTempStores").__setRef("WAHandleFailureUtils"),s={GENERIC_FAILURE:"400",NOT_AUTHORIZED:"401",TEMP_BANNED:"402",BANNED:"403",CAT_EXPIRED:"413",CAT_INVALID:"414",NOT_FOUND:"415",CAT_SESSION_INVALID:"418",INTERNAL_ERROR:"500",SERVER_UNAVAILABLE:"503"};function u(){return new Promise(function(t,n){e.onReady(function(e){r("promiseDone")(e.clearSignalAndTempStores(),function(){return t()},function(e){var t=r("getErrorSafe")(e);r("FBLogger")("wmi").catching(t).mustfix("Failed to clear signal and temp stores"),n(t)})})})}function c(){return u().then(function(){o("WABridge").getBridge().fireAndForget("event","logout",{})})}async function d(){await u(),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WA_REREGISTRATION,key:"reregister_phone"}),o("WABridge").getBridge().fireAndForget("event","reregisterDevice",{})}l.FAILURE_CODES=s,l.clearRegistrationAndTempData=u,l.deregisterPhone=c,l.reregisterPhone=d}),98);
__d("WASignalDB",["BrowserLockManager","QPLFlow","WAHandleFailureUtils","WAHex","WAIDBTypes","WALogger","WAResolvable","Worm","WormEAR","WormIDbDriver","WormIDbUtils","err","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s={identity:{primaryKey:"deviceJid",indexes:{userJid:{fields:["userJid"],unique:!1}}},contacts:{primaryKey:"contactJid",indexes:{}},session:{indexes:{},primaryKey:"id"},senderKeySessions:{primaryKey:"id",indexes:{groupJid:{fields:["groupJid"],unique:!1},userJid:{fields:["userJid"],unique:!1}}},prekey:{indexes:{},primaryKey:"keyId"},prekeyGeneration:{indexes:{},primaryKey:"generationId"},signedPrekey:{indexes:{},primaryKey:"keyId"},meta:{indexes:{},primaryKey:"key"},plaintextMeta:{indexes:{},primaryKey:"key",secure:!1},icdcFails:{indexes:{},primaryKey:"contactJid"},personalSenderKeyStatuses:{indexes:{},primaryKey:"groupJid"}},u,c=new(o("WAResolvable")).Resolvable;async function d(t,n,a,i,l,d){var m=d!=null?o("QPLFlow").startQPLFlow(d,{timeoutInMs:r("justknobx")._("3415"),annotations:{string:{operationType:"initDb"}}}):null;try{await f(async function(){var e=o("WAHex").parseHex(n),r="signalDb",p=new(o("WormEAR")).WormEAR(s,r,e),_=new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(t,r,s,p,l,{blockingErrorThreshold:a,onBlockingError:i,safeToDeleteStores:new Set(["stanzaQueue","danglingQueue","migration"]),onTransactionError:function(n){if(n instanceof o("WormEAR").DecryptionError){var e=n;if(e.store==="icdcFails")return;o("WormIDbUtils").promisifyIDbRequest(o("WAIDBTypes").idb().deleteDatabase(t)).then(function(){return o("WAHandleFailureUtils").reregisterPhone()})}}}),d);u=_,await _.init({eventFlow:m}),c.resolve(_),m==null||m.endSuccess()})}catch(t){throw m==null||m.endFail("error"),o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[WORM] Error performing initDb: ",""])),t),t}}function m(){if(u==null)throw r("err")("Signal Db v3 is not initialized");return u}function p(){return c.promise}function _(e){return"Signal - "+e}function f(e){return r("BrowserLockManager")!=null?r("BrowserLockManager").request("wajs_make_signal_v3_db",e):e()}l.makeSignalDb=d,l.getDb=m,l.getDbPromise=p,l.signalOp=_}),98);
__d("WAGetMetaApi",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return o("WASignalDB").getDb().runInTransaction(["meta"],"readonly",function(e){return e.stores.meta.bulkGet(["certificateChain","deviceId","identityKeyPair","abProps","edgeInfo","clockSkew","authKeyPair"]).then(function(e){var t,n,r,o,a,i,l,s=e[0],u=e[1],c=e[2],d=e[3],m=e[4],p=e[5],_=e[6];return{abProps:d==null||(t=d.value)==null?void 0:t.abProps,authKeyPair:_==null||(n=_.value)==null?void 0:n.authKeyPair,certificateChain:s==null||(r=s.value)==null?void 0:r.certificateChain,clockSkew:p==null||(o=p.value)==null?void 0:o.clockSkew,deviceId:u==null||(a=u.value)==null?void 0:a.deviceId,edgeInfo:m==null||(i=m.value)==null?void 0:i.edgeInfo,identityKeyPair:c==null||(l=c.value)==null?void 0:l.identityKeyPair}})},o("WASignalDB").signalOp("getMeta"))};l.getMeta=e}),98);
__d("WAGetAbPropsApi",["WAGetMetaApi"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return o("WAGetMetaApi").getMeta().then(function(e){var t=e.abProps;return t})};l.getAbProps=e}),98);
__d("WASetMetaApi",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().runInTransaction(["meta"],"readwrite",function(e){return e.stores.meta.bulkPut(Object.entries(t).map(function(e){var t,n=e[0],r=e[1];return{key:n,value:(t={},t[n]=r,t)}}))},o("WASignalDB").signalOp("setMeta")).then(function(){})};l.setMeta=e}),98);
__d("WASetAbPropsApi",["WASetMetaApi"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASetMetaApi").setMeta({abProps:t})};l.setAbProps=e}),98);
__d("WAAbPropsInit",["WAAbProps","WAAbPropsCache","WAAbPropsConverters","WAAbPropsToUI","WAAbPropsTypes","WABridge","WAGetAbPropsApi","WALogger","WASetAbPropsApi","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(){if(!u)throw r("err")("Trying to get hash before AbProps gets initialized");return Promise.resolve(u.getHash())}function d(){if(!u)throw r("err")("Trying to get refresh secs before AbProps gets initialized");return Promise.resolve(u.getRefreshSecs())}var m={getAbProps:function(){if(!u)throw r("err")("Trying to read ABProps before they gets initialized");return Promise.resolve(u.readAll())},getHash:c,getRefreshSecs:d,setAbProps:async function(t){var e,n=o("WAAbPropsConverters").convertAbPropsDataToParsed(t);(e=u)==null||e.rewrite(n),await o("WASetAbPropsApi").setAbProps(o("WAAbPropsConverters").convertAbPropsParsedToDbEntity(n)),p(n)}};function p(e){if(e.propValues){var t=o("WAAbPropsToUI").prepareAbPropsForUI(e.propValues);o("WABridge").getBridge().fireAndForget("event","abPropsUpdated",{abProps:t})}}async function _(){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Starting ABProps store"])));var t=await o("WAGetAbPropsApi").getAbProps(),n={};t&&(n=o("WAAbPropsConverters").convertDbAbPropsToParsed(t)),u=new(o("WAAbPropsCache")).AbPropsCache(n),o("WAAbProps").startAbProps(m,o("WAAbPropsTypes").ABPropConfigs),p(n),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ABProps inited"])))}function f(e,t){if(u==null)throw r("err")("Trying to override ABProp before they get initialized");var n=u;n.overrideAbProp(e,t),p(o("WAAbPropsConverters").convertAbPropsDataToParsed(n.readAll()))}function g(e){return o("WAAbPropsTypes").ABPropConfigs[e][2]}function h(){if(!u)throw r("err")("Trying to read ABProps before they get initialized");return u.readAll()}function y(e){if(!u)throw r("err")("Trying to read ABProp "+e+" before AbProps gets initialized");var t=u.getAbProp(e);return t!=null?t:g(e)}l.getHash=c,l.getRefreshSecs=d,l.initAbProps=_,l.overrideAbProp=f,l.getAbDefault=g,l.getAbProps=h,l.getAbProp=y}),98);
__d("MAWWebWorkerLogger",["MAWBridge","MAWConsoleLogger","MAWLeakDetection","MAWLoggingSwitches","MAWSaveLogToDisk","WAAbPropsInit","WAJids","WATagsLogger","err","fb-error","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e=2;function s(){o("WATagsLogger").initializeWaLogger(c)}function u(){return r("gkx")("19609")}var c={count:function(t,n){m("count",t,n),o("MAWConsoleLogger").logToConsole("count",t,n)},debug:function(t,n,r){o("MAWConsoleLogger").logToConsole("log",t,n,r)},devConsole:function(t,n,r,a){for(var e=arguments.length,i=new Array(e>4?e-4:0),l=4;l<e;l++)i[l-4]=arguments[l];switch(t){case"COUNT":o("MAWConsoleLogger").logToConsole.apply(void 0,["count",n,r,a].concat(i));break;case"DEV":o("MAWConsoleLogger").logToConsole.apply(void 0,["log",n,r,a].concat(i));break;case"DEV_XMPP":o("MAWConsoleLogger").logToConsole.apply(void 0,["log",n,r,a].concat(i));break;case"LOG":o("MAWConsoleLogger").logToConsole.apply(void 0,["info",n,r,a].concat(i));break;case"WARN":o("MAWConsoleLogger").logToConsole.apply(void 0,["warn",n,r,a].concat(i));break;case"ERROR":o("MAWConsoleLogger").logToConsole.apply(void 0,["error",n,r,a].concat(i));break;case"CATCHING":o("MAWConsoleLogger").logToConsole.apply(void 0,["error",n,r,a].concat(i));break}},error:function(t,n,a){var e=o("MAWLeakDetection").maybeReplaceVaultedString(t);a?_(e,n,a):_("webworker",n,r("err")(o("WAJids").maybeSanitizeLogLineText(e))),o("MAWConsoleLogger").logToConsole("error",e,n)},info:function(t,n){m("log",t,n),o("MAWConsoleLogger").logToConsole("info",t,n)},logRestricted:function(t,n){m("logRestricted",t,n),o("MAWConsoleLogger").logToConsole("log",t,n)},warn:function(t,n){m("warn",t,n),o("MAWConsoleLogger").logToConsole("warn",t,n)}};function d(){try{return o("WAAbPropsInit").getAbProp("msgrw_logger_entries")}catch(e){return o("WAAbPropsInit").getAbDefault("msgrw_logger_entries")}}function m(e,t,n){if(o("MAWLoggingSwitches").removeLoggingFromBridge){if(o("MAWSaveLogToDisk").saveLogEntry("worker",o("MAWSaveLogToDisk").formatLog({date:Date.now(),logLevel:e,logString:t,tags:n})),!u()){e==="count"&&o("MAWBridge").getBridge().fireAndForget("event","log",{logLevel:e,logString:t,tags:n},!0);return}e!=="debug"&&o("MAWBridge").getBridge().fireAndForget("event","log",{logLevel:e,logString:t,tags:n},!0)}}async function p(){await o("MAWSaveLogToDisk").forceCachedLogEntryPersist()}function _(t,n,a){var i=0;if(a.taalOpcodes!=null){var l;(l=a.taalOpcodes)==null||l.forEach(function(e){e===r("fb-error").TAALOpcode.PREVIOUS_FRAME&&i++})}else i=e;o("MAWLoggingSwitches").removeLoggingFromBridge&&o("MAWSaveLogToDisk").saveLogEntry("worker",o("MAWSaveLogToDisk").formatErrorForLogging(t,n,a,i,d(),a.stack)),u()||o("MAWBridge").getBridge().fireAndForget("event","logError",{entriesToReport:d(),framesToPop:i,logString:t,message:a.message,stack:a.stack,tags:n},!0)}l.setupWebWorkerWaLogger=s,l.flushLogs=p}),98);
__d("MAWKeychain",["MWEARKeychainV3"],(function(t,n,r,o,a,i,l){"use strict";var e={getDbEncryptionKey:o("MWEARKeychainV3").getDbEncryptionKey,getLatestVersion:o("MWEARKeychainV3").getLatestVersion,init:o("MWEARKeychainV3").init};l.default=e}),98);
__d("MWSetupDBEncryption",["BrowserLockManager","ExecutionEnvironment","FBLogger","MAWEncryptionIndexedDbV2","MAWKeychain","MWEARKeychainV3","WAResultOrError","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(t,n){return n()};function u(e){s=e}var c="mw_ear_db";async function d(e){try{return await o("MAWEncryptionIndexedDbV2").makeEncryptionDB(e),await s("init_setup_keychain",function(){return r("MAWKeychain").init("global_ear",e)})}catch(n){var t=n instanceof Error?n:r("getErrorSafe")(n);return r("FBLogger")("messenger_web").catching(t).mustfix("[%s] EAR setup error",String(e)),o("WAResultOrError").DEPRECATED_makeError("keychain-setup-failure",t)}}function m(e){return o("MAWEncryptionIndexedDbV2").getEncryptionDB()!=null&&o("MWEARKeychainV3").isKeychainInitialised("global_ear")?Promise.resolve(o("WAResultOrError").makeResult(o("MWEARKeychainV3").getLatestVersion("global_ear"))):r("BrowserLockManager")!=null?new Promise(function(t,n){r("promiseDone")(r("BrowserLockManager").request(c,async function(){try{var r=await d(e);t(r)}catch(e){n(e)}}),function(e){},function(e){n(e)})}):d(e)}function p(e,t){t===void 0&&(t=function(t){return!0});var n=null;return function(o){return n==null&&(n=e(o).then(function(e){return n=t(e)?Promise.resolve(e):null,e}).catch(function(e){throw n=null,e})),n}}var _=p(function(t){return m(t)},function(e){return(e==null?void 0:e.success)===!0}),f=(e||(e=r("ExecutionEnvironment"))).isInWorker?_:m;l.setPerformanceMeasurementTool=u,l.init=f}),98);
__d("BackendInitLoggingUtils",["ErrorMetadata","MAWCommonWebWorkerErrorLogging","MAWLoggerUtils","MAWQplProxy","MAWWebWorkerLogger","MWSetupDBEncryption","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n){return o("MAWQplProxy").measurePerfInQPL_USE_WITH_CARE(r("qpl")._(25310776,"6155"),"backend_"+t,n)},s=function(t){return o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25310776,"6155"),t)},u=function(t){return o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056839232,"112"),t)};function c(){o("MAWWebWorkerLogger").setupWebWorkerWaLogger(),o("MAWCommonWebWorkerErrorLogging").init(),r("ErrorMetadata").addGlobalMetadata("MESSENGER_E2EE_WEB","ENVIRONMENT","worker"),o("MAWLoggerUtils").initMessengerWebLogging(),o("MWSetupDBEncryption").setPerformanceMeasurementTool(e)}l.measureMawInit=e,l.MAWInitPoint=s,l.MAWMICPoint=u,l.initializeBackendLogging=c}),98);
__d("Cache",["TimeSlice"],(function(t,n,r,o,a,i,l){"use strict";var e=6e4,s=(function(){function t(){this.$1=new Map}var n=t.prototype;return n.has=function(t){return this.$1.has(t)},n.get=function(t,n){var e=this.__getRaw(t);return e?e.$2:n},n.getAll=function(t,n){var e=this,r=new Map;return t.forEach(function(t){return r.set(t,e.get(t,n))}),r},n.delete=function(t){var e=this.__getRaw(t);return e&&e.$3&&clearTimeout(e.$3),this.$1.delete(t)},n.clear=function(){this.$1.forEach(function(e){e&&e.$3&&clearTimeout(e.$3)}),this.$1.clear()},n.set=function(n,o,a,i){if(!this.shouldUpdate(n,a))return!1;var t=this.__getRaw(n);return t||(t=this.__getNewRawObject()),delete t.$2,delete t.$4,t.$3&&clearTimeout(t.$3),delete t.$3,t.$2=o,a!=null&&(t.$4=a),i!=null&&i>=0&&(t.$3=setTimeout(r("TimeSlice").guard(this.delete.bind(this,n),"Cache expiration timeout"),i*e)),this.__setRaw(n,t),!0},n.shouldUpdate=function(t,n){var e=this.__getRaw(t);return e==null||e.$4==null||n==null||n>e.$4},n.size=function(){return this.$1.size},n.__getRaw=function(t){return this.$1.get(t)},n.__setRaw=function(t,n){this.$1.set(t,n)},n.__getNewRawObject=function(){return{$2:null,$3:null,$4:null,$5:null,$6:null}},n.__keys=function(){return this.$1.keys()},t})();l.default=s}),98);
__d("CoalescingLoader",[],(function(t,n,r,o,a,i){"use strict";function e(){return new Promise(function(e){return globalThis.setTimeout(e,0)})}var l=(function(){function t(t,n){n===void 0&&(n=e),this.$1=t,this.$2=[],this.$3=null,this.$4=n}var n=t.prototype;return n.gen=async function(t){this.$2.push(t);var e=this.$2.length-1,n=await this.$5();return n[e]},n.$5=function(){return this.$3!=null?this.$3:(this.$3=this.$6(),this.$3)},n.$6=async function(){await this.$4();var e=this.$2;return this.$2=[],this.$3=null,this.$1([].concat(e))},t})();i.CoalescingLoader=l}),66);
__d("EBAPI",["MAWEBCombinedSwitch","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(e=r("requireDeferred"))("EBAPIMinosVerifySingleEpoch").__setRef("EBAPI"),u=e("EBAPIWriteMinosPublicKeysForRecipient").__setRef("EBAPI"),c=e("EBGetContactEpochHead").__setRef("EBAPI"),d=e("EBGetMessageKeys").__setRef("EBAPI"),m=e("EBIsEbEnabled").__setRef("EBAPI"),p=e("EBMinosWriteKeyChangeAdminMessage").__setRef("EBAPI"),_=e("EBMinosWriteSecureStorageAlert").__setRef("EBAPI"),f={getContactEpochHead:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return c.load().then(function(e){return e.getContactEpochHead.apply(e,t)})},getMessageKeys:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return d.load().then(function(e){return e.getMessageKeys.apply(e,t)})},isEBEnabled:function(){return o("MAWEBCombinedSwitch").MAWEBCombinedSwitch.isEnabled()},isEbEnabledEbSwitch:function(){return m.load().then(function(e){return e.isEbEnabledEbSwitch()})},minosVerifySingleEpoch:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return s.load().then(function(e){return e.minosVerifySingleEpoch.apply(e,t)})},writeMinosKeyChangeAdminMessage:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return p.load().then(function(e){return e.writeMinosKeyChangeAdminMessage.apply(e,t)})},writeMinosMailboxKeysForRecipientAPI:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return u.load().then(function(e){return e.writeMinosMailboxKeysForRecipientAPI.apply(e,t)})},writeMinosSecureStorageAlert:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return _.load().then(function(e){return e.writeMinosSecureStorageAlert.apply(e,t)})}},g=f;l.default=g}),98);
__d("EBLSResignCdnUrlDeferred",["gkx","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("EBLSResignCdnUrl").__setRef("EBLSResignCdnUrlDeferred");function s(t){return e.load().then(function(e){return r("gkx")("12896")?e.resignCdnUrlUsingEbdb(t):e.DEPRECATED_eblsResignCdnUrlWithGraphQL(t)})}l.eblsResignCdnUrlWithGraphQL=s}),98);
__d("EncryptedBackupsAttachmentProductType",["$InternalEnum"],(function(t,n,r,o,a,i){var e=n("$InternalEnum")({MSGR:"msgr",IGD:"igd"}),l=e;i.default=l}),66);
__d("EncryptedBackupsUtils",["FBLogger","WAJids","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return Date.now()-t>o("WATimeUtils").DAY_MILLISECONDS*30},s=function(t){return Date.now()-t>o("WATimeUtils").DAY_MILLISECONDS*30};function u(e,t,n,r,o){var a={frankingTag:r==null?void 0:r.frankingTag,reportingTag:r==null?void 0:r.reportingTag},i={frankingMetadata:a,messageId:t,senderId:e,timestampMs:n};return{encryptedTransportMessage:o,metadata:i}}function c(e){return JSON.stringify([e.author,e.chat,e.externalId])}function d(e){var t=JSON.parse(e);if(!Array.isArray(t))throw r("FBLogger")("wmi_eb").mustfixThrow("Unable to parse msg id string as proper json");if(t.length!==3)throw r("FBLogger")("wmi_eb").mustfixThrow("Parsed array should have 3 components");var n=o("WAJids").unsafeCoerceToUserJid(t[0]),a=o("WAJids").unsafeCoerceToChatJid(t[1]),i=o("WAStanzaUtils").toStanzaId(t[2]);return{author:n,chat:a,externalId:i}}l.entryOlderThan30Days=e,l.timestampOlderThan30Days=s,l.asBackupMessage=u,l.convertWAMsgIdToStringId=c,l.convertStringIdToWAMsgId=d}),98);
__d("MAWExtractMsFromExternalId",["I64","MAWExternalId","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=2199023255551;function c(t){try{var n=(s||(s=o("I64"))).of_string_opt(t);if(n!=null){var r;return(r=d(n))!=null?r:0}}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to convert externalId to number: ",""])),t)}return 0}function d(e){var t=Number((s||(s=o("I64"))).to_string(s.and_(s.lsr_(e,22),s.of_float(u))));return o("MAWExternalId").getThreeMostSignificantDigitsForSortOrderTimestamp(t)}l.extractMsFromStanzaId=c,l.extractMsFromExternalId=d}),98);
__d("IGDWEBUploadMessageUtils",["I64","MAWExtractMsFromExternalId","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n){var r=o("MAWExtractMsFromExternalId").extractMsFromExternalId((s||(s=o("I64"))).of_string(t));return r==null&&o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Could not extract ms from externalId: ",""])),t),o("WATimeUtils").castToMillisTime(Number(n)*1e3+(r!=null?r:0))}l.generateProtobufServerTs=u}),98);
__d("EncryptedBackupsUploadEntity",["$InternalEnum","EncryptedBackupsUtils","IGDWEBUploadMessageUtils","WAArmadilloBackupMessage.pb","WAByteArray","WAGlobals","WAJids","WATimeUtils","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e instanceof ArrayBuffer?new Uint8Array(e):e}var s=n("$InternalEnum").Mirrored(["NEEDS_BACKUP","COMPLETED","NEEDS_BACKUP_RETRY","PERMANENT_FAILURE","EXPIRED","THREAD_DELETED","DELETION_PURGED","MESSAGE_DELETED","UPLOADING"]),u=n("$InternalEnum")({INVALID:"-1",IMAGE:"0",PTT:"1",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",XMA:"22",MESSENGER_PREVIEW:"25"});function c(e){return e}function d(e){var t=e.messageApplication,n=e.msgId,r=e.reportingMeta,a=e.sortOrderMs,i=o("WAJids").authorToUserId(n.author,o("WAJids").extractUserId(o("WAGlobals").getMyUserJid()));return o("encodeProtobuf").encodeProtobuf(o("WAArmadilloBackupMessage.pb").BackupMessageSpec,o("EncryptedBackupsUtils").asBackupMessage(i,n.externalId,a,r!=null?r:{frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},t)).readByteArrayView()}function m(e){return o("WAByteArray").uint8ArrayToBuffer(e)}function p(e){var t=e.attachmentContext,n=e.backupDirective,r=e.dbMsgType,a=e.instanceKey,i=e.isOpenEB,l=e.isRetroactiveUpload,u=e.legacyAttachmentContext,c=e.messageApplication,m=e.msgId,p=e.originalMsgProtocolId,_=e.reportingMeta,f=e.retryCount,g=e.senderId,h=e.serverTs,y=e.sortOrderMs,C=e.tags,b=e.triggerSource,v=d({messageApplication:c,msgId:m,reportingMeta:_,sortOrderMs:n.actionType===4?o("IGDWEBUploadMessageUtils").generateProtobufServerTs(m.externalId,h):y}),S={backupActionType:n.actionType,backupDirective:n,dbMsgType:r,failTsMs:o("WATimeUtils").castToMillisTime(0),instanceKey:a,isOpenEB:i,isRetroactiveUpload:l,msgId:m,msgIdKey:o("EncryptedBackupsUtils").convertWAMsgIdToStringId(m),msgType:"text",originalMsgProtocolId:p,protobuf:v,retryCount:f,senderId:g,serverTs:h,sortOrderMs:y,supplementalKey:n.supplementalKey,tags:C,triggerSource:b,uploadStatus:s.NEEDS_BACKUP,uploadTsSec:o("WATimeUtils").unixTime()};return t!=null&&(S=babelHelpers.extends({},S,{attachmentContext:t,legacyAttachmentContext:u,msgType:"media"})),S}l.toEbBackupMessageBytes=e,l.EbUploadStatus=s,l.AttachmentContextMediaType=u,l.castToEBQueueId=c,l.encodeBackupMessage=d,l.getEbBackupMessageBytesBuffer=m,l.asEBUploadEntity=p}),98);
__d("WormPersistedQueueSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e}var s={autoIncrement:!1,primaryKey:"queueId",secure:!0},u={ebUploadQueueV3:babelHelpers.extends({},s,{indexes:{"[attemptCount+addedAtMs]":{fields:["attemptCount","addedAtMs"],unique:!1}},nonEncryptedFields:["attemptCount","addedAtMs"]}),ftsIndexQueue:babelHelpers.extends({},s,{indexes:{"[kind+addedAtMs]":{fields:["kind","addedAtMs"],unique:!1}},nonEncryptedFields:["kind","addedAtMs"]}),mediaDownloadQueue:babelHelpers.extends({},s,{indexes:{attemptCount:{fields:["attemptCount"],unique:!1}},nonEncryptedFields:["attemptCount"]})};function c(e,t,n,r,a,i){var l=o("WAHex").parseHex(t),s="worm_pqdb",c=new(o("WormEAR")).WormEAR(u,s,l);return new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,s,u,c,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:r,onTransactionError:a}),i)}l.toWormPersistedQueueId=e,l.makePersistedQueueSchema=c}),98);
__d("WormPersistedQueueDb",["FBLogger","WAResolvable","WormEAR","WormPersistedQueueSchema","err","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;async function u(t){var n=t.blockingErrorThreshold,a=t.dbName,i=t.onBlockingError,l=t.qplEvent,u=t.strEncKey;try{var c=o("WormPersistedQueueSchema").makePersistedQueueSchema(a,u,n,i,function(t){if(t instanceof o("WormEAR").DecryptionError){var n,a,i=t;r("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",i.store),r("promiseDone")((n=(a=e)==null?void 0:a.runInTransaction([i.store],"readwrite",function(e){var t=e.stores[i.store];return i.maybeHashedPk!=null?t.delete(i.maybeHashedPk):t.clear()},"delete-corrupted-entity"))!=null?n:Promise.resolve())}},l);return e=c,await c.init(),s.resolve(c),c}catch(e){throw r("FBLogger")("messenger_web").catching(r("getErrorSafe")(e)).mustfix("Error performing WORM PersistedQueue init"),e}}function c(){if(e==null)throw r("err")("PersistedQueue is not initialized");return e}function d(){return s.promise}l.makePersistedQueueDb=u,l.getPersistedQueues=c,l.getDbPromise=d}),98);
__d("WormPersistedQueue",["FBLogger","WAPubSub","WormPersistedQueueDb","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(){return r("FBLogger")("wmi").tags(["worm-persisted-queue"])},u=36e5,c=(function(){function t(e){this.$1=o("WAPubSub").simplePubSub(),this.$4=0,this.$2=o("WormPersistedQueueDb").getPersistedQueues(),this.$3=e}var n=t.prototype;return n.$5=function(t){return"WormPersistedQueue:"+this.$3+":"+t},n.$6=function(){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",async function(t){var n=t.stores[e.$3],r=await n.readAll({limit:1});r.length===0&&await n.clear()},this.$5("clearIfEmpty"))},n.$7=async function(){if(Date.now()-this.$4>u)try{await this.$6(),this.$4=Date.now()}catch(n){var t=r("getErrorSafe")(n);s().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error during PersistedQueue cleanup: ",""])),t.message)}},n.subscribe=function(t){return this.$1.subscribe(t)},n.ack=function(t){return this.delete(t)},n.delete=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",async function(n){var r=n.stores[e.$3];await r.bulkDelete(t),e.$7()},this.$5("delete"))},n.read=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readonly",async function(n){var r=n.stores[e.$3];return await r.readAll(t)},this.$5("read"))},n.readFromIndex=function(t,n){var e=this;return this.$2.runInTransaction([this.$3],"readonly",async function(r){var o=r.stores[e.$3];return await o.readIndex(t,void 0,n)},this.$5("readIndex"))},n.readFromIndexRange=function(t,n,r){var e=this;return this.$2.runInTransaction([this.$3],"readonly",async function(o){var a=o.stores[e.$3];return await a.readIndexRange(t,n,r)},this.$5("readIndexRange"))},n.add=function(t){return this.put(t)},n.put=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",async function(n){var r=n.stores[e.$3];await r.bulkPut(t),e.$1.publish({type:"new_entities"})},this.$5("put"))},t})();l.WormPersistedQueue=c}),98);
__d("FtsIndexEntity",["WATimeUtils","WormPersistedQueue","WormPersistedQueueSchema","qex"],(function(t,n,r,o,a,i,l){"use strict";var e="migrate_fts_backlog_to_wpq";function s(e){var t=o("WATimeUtils").millisTime();return{addedAtMs:t,id:e,kind:"INDEX_MESSAGE",queueId:o("WormPersistedQueueSchema").toWormPersistedQueueId(e+"."+t.toString())}}function u(e){var t=o("WATimeUtils").millisTime();return{addedAtMs:t,id:e,kind:"PURGE_MESSAGE",queueId:o("WormPersistedQueueSchema").toWormPersistedQueueId(e+"."+t.toString())}}function c(e){var t=o("WATimeUtils").millisTime();return{addedAtMs:t,id:e,kind:"PURGE_THREAD",queueId:o("WormPersistedQueueSchema").toWormPersistedQueueId(e+"."+t.toString())}}function d(e){return e}var m=null;function p(){return m==null&&(m=new(o("WormPersistedQueue")).WormPersistedQueue("ftsIndexQueue")),m}function _(e){return(e==null?void 0:e.silent)===!0?r("qex")._("355")===!0:r("qex")._("427")===!0}l.MIGRATE_FTS_BACKLOG_TO_WPQ_ODS_ENTITY_NAME=e,l.toIndexMessageEntity=s,l.toPurgeMessageEntity=u,l.toPurgeThreadEntity=c,l.toFtsIndexId=d,l.getFtsIndexQueue=p,l.isFtsIndexQueueExperiment=_}),98);
__d("LFUCache",["Cache","ExecutionEnvironment"],(function(t,n,r,o,a,i,l){"use strict";var e,s=15,u=1,c=6e4,d=(function(t){function n(n,o){var a;return a=t.call(this)||this,a.$LFUCache2=n&&n>0?n:s,a.$LFUCache3=o&&o>0?o:u,((e||(e=r("ExecutionEnvironment"))).canUseDOM||(e||(e=r("ExecutionEnvironment"))).isInWorker)&&a.$LFUCache4(),a}babelHelpers.inheritsLoose(n,t);var o=n.prototype;return o.$LFUCache4=function(){clearTimeout(this.$LFUCache1),this.$LFUCache1=setTimeout(this.purge.bind(this),this.$LFUCache2*c)},o.destroy=function(){clearTimeout(this.$LFUCache1)},o.get=function(n,r){return this.has(n)&&this.$LFUCache5(n),t.prototype.get.call(this,n,r)},o.set=function(n,r,o,a){var e=this.has(n),i=t.prototype.set.call(this,n,r,o,a);return i&&(e?this.$LFUCache5(n):this.$LFUCache6(n,this.$LFUCache3)),i},o.purge=function(){var e=this,t=Array.from(this.__keys());t.forEach(function(t){e.$LFUCache7(t)<e.$LFUCache3?e.delete(t):e.$LFUCache6(t,0)}),this.$LFUCache4()},o.$LFUCache5=function(t){var e=this.$LFUCache7(t)+1;return this.$LFUCache6(t,e),e},o.$LFUCache7=function(t){var e=this.__getRaw(t);return e&&e.$LFUCache8?e.$LFUCache8:0},o.$LFUCache6=function(t,n){var e=this.__getRaw(t);return e||(e=this.__getNewRawObject()),e.$LFUCache8=n,this.__setRaw(t,e),!0},n})(r("Cache"));l.default=d}),98);
__d("LSMEBTaskCreationSource",[],(function(t,n,r,o,a,i){var e=Object.freeze({UNKNOWN:-1,TEST_ONLY:0,TAM:1,MEM:2,RETROACTIVE_BACKUP:3,TAM_WEB:4,ACT_MESSAGE_DELETE:5,ACT_THREAD_DELETE:6,ACT_UPDATE_ATTACHMENT:7,TAM_PERSISTENCE_TASK:8,TAM_XMA_TOMBSTONE:9,MEM_RECEIVE:10,MEM_SEND:11,MEM_PEER_SYNC:12,MEM_RECEIVE_PROTOBUF:13,MEM_SEND_PROTOBUF:14,MEM_PEER_SYNC_PROTOBUF:15,MEM_RECEIVE_PROTOBUF_ONLY_FBN:16,MEM_SEND_PROTOBUF_ONLY_FBN:17,MEM_PEER_SYNC_PROTOBUF_ONLY_FBN:18,EB_ADD_DEVICE:21,OPTIMISTIC_THREAD_CREATE_VIA_SHIM:22,ACT_THREAD_INSERT_VIA_SHIM:23,MI_THREAD_INSERT_VIA_SHIM:24,POINT_QUERY_FROM_EB:25,MESSENGER_SEARCH:26,ACT_MESSAGE_RANGE_TASK_HANDLER:27,POINT_QUERY_ON_FULLY_LOADED_THREAD:28,THREAD_CUTOVER:29,HYBRID_THREAD_VERIFY_OR_CREATE_VIA_SHIM:30,BURNER_INTERNAL_LOAD_TESTING_FRAMEWORK:31,THREAD_GALLERY_RESTORE:32,ACT_SURROUNDING_QUERY:33,EB_SNAPSHOT_RESTORE:34,PROTOBUF_RESTORE:39,FTS_INDEX_EB_MESSAGES:40,INSTAMADILLO_DYI:41,MESSENGER_MESSAGE_LIST_PAGINATION:45,DELTA_GENERIC_MESSAGE_SYNC:55,MEDIA_GALLERY_RESTORE:57,EB_PROTOBUF_RESTORE_NO_OP:58,NEW_MEMBER_EXPORT:59,THREAD_POINT_QUERY:76,EB_RESTORE_REPLIED_MESSAGES_AFTER_RANGE_RESTORE:35,REPL_TESTING:36,EB_POINT_QUERY_IN_ACT:37,EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES:38,IGD_DYI:42,FTS_INDEX_EB_MESSAGES_WEB:43,BULK_QUERY_FOR_SEARCH_RESULT:44,MSGR_DYI:46,EB_RESTORE_ON_REGISTRATION:47,EB_RESTORE_ON_OFFLINE_QUEUE_COUNT_LIMIT:48,EB_POINT_QUERY_RESTORE_ON_ACK_DROP:49,EB_POINT_QUERY_RESTORE_ON_DECRYPTION_FAILURE:50,EB_POINT_QUERY_RESTORE_ON_UNAVAILABLE_DEVICE:51,EB_RANGE_QUERY_RESTORE_ON_THREAD_SESSION_ACTIVATE:52,EB_POINT_QUERY_PINNED_MESSAGES:53,EB_POINT_QUERY_RESTORE_PROTOBUF:54,EB_POINT_QUERY_IN_ACT_REACTIONS:56,EB_POINT_QUERY_BUMP_MESSAGES:60,EB_POINT_QUERY_IN_ACT_FOR_INCOMING_RETRY_RECEIPT:61,EB_POINT_QUERY_IN_ACT_FOR_REPORTING:62,EB_POINT_QUERY_IN_ACT_FOR_MESSAGE_STATUS_UPDATE:63,EB_POINT_QUERY_IN_ACT_FOR_REPL_TEST:64,EB_POINT_QUERY_IN_ACT_FOR_FACEBOOK_APP_NSE_NOTIFICATION_RENDERING:65,EB_POINT_QUERY_IN_ACT_FOR_MESSAGE_EXPORT_HANDLING:66,EB_POINT_QUERY_IN_ACT_FOR_TAM_ACT_PROXY:67,EB_POINT_QUERY_IN_ACT_FOR_REALTIME_INCOMING_MESSAGE:68,EB_POINT_QUERY_IN_ACT_FOR_REALTIME_INCOMING_AI_BOT_MESSAGE:69,EB_POINT_QUERY_IN_ACT_FOR_ENCRYPTED_BACKUPS_RESTORE_FOR_PERSISTENCE:70,EB_POINT_QUERY_IN_ACT_FOR_ENCRYPTED_BACKUPS_RESTORE_FOR_INDEXING:71,EB_POINT_QUERY_IN_ACT_FOR_ENCRYPTED_BACKUPS_RESTORE_FOR_NEW_MEMBER_HYDRATION:72,EB_POINT_QUERY_IN_ACT_FOR_ENCRYPTED_BACKUPS_RESTORE_FOR_ECHO_TO_PROTO_CONVERSION:73,EB_POINT_QUERY_IN_ACT_FOR_PENDING_MESSAGE_RECOVERY_HISTORICAL_FUTURE_PROOF:74,EB_POINT_QUERY_IN_ACT_FOR_PENDING_MESSAGE_RECOVERY_REALTIME_BLOCKED:75,EB_POINT_QUERY_TO_FETCH_SENDER_DEVICE_KEYS:77,RESONANCE_UTILS:80,MPS_RESTORE_REVERB_RESTORE:81,REPORTING:82,CLIENT_MESSAGE_TRUNCATION:83,CALLING_XMA:84,EB_ACT_ATTACHMENT_RESTORE:85,EB_MEB_ATTACHMENT_ACCESS_CONTROL_RESTORE:86,FORCE_CLIENT_MESSAGE_TRUNCATION:87,ACT_EDIT_MESSAGE_VALIDATION:88,ACT_REVOKE_MESSAGE_VALIDATION:89,REVERB_CLEANUP_HANDLER_SINGLE_MESSAGE_POINT_QUERY:90,REVERB_CLEANUP_HANDLER_RESTORE_MESSAGES_BEFORE_QUERY:91,REVERB_CLEANUP_HANDLER_RESTORE_MESSAGES_AFTER_QUERY:92,REVERB_CLEANUP_HANDLER_RESTORE_MESSAGES_SURROUNDING_QUERY:93,ACT_FETCH_LOCAL_ONLY_MESSAGE_PK_AND_LOCAL_BACKUP_RESTORE:94,ACT_FETCH_LOCAL_ONLY_MESSAGE_PK_AND_ENCRYPTED_BACKUP_RESTORE:95,FILE_GALLERY_RESTORE:96,MPS_READ_APIS:97});i.default=e}),66);
__d("MAWBridgeThread",["MAWTimeUtils","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a){var i=o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(t){return!0},user:function(t){return!1}});return{authoritativeThreadKey:n,cannotReplyReason:e.cannotReplyReason,clientThreadKey:t,description:r,folder:e.folder,instanceKey:a,isGroup:i,jid:e.jid,lastReadTs:o("MAWTimeUtils").ensureValidMillisTime(e.lastReadMsgTs)||o("WATimeUtils").castToMillisTime(0)}}l.createBridgeThread=e}),98);
__d("MAWBridgeTypesCreators",["FBLogger","MAWAudioUtils","MAWDbMsg","MAWImageUtils","MAWMsgType","MAWUserJidWrapper","WAJids","WAMediaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{threadJid:e}}function s(e){var t,n=e.ts;switch(e.type){case o("MAWMsgType").MSG_TYPE.REVOKED:n=(t=e.originalTs)!=null?t:e.ts;break;default:n=o("MAWDbMsg").getCanonicalTsFromMsg(e)}return{msgId:e.msgId,ts:n}}function u(e,t){var n=t.map(s);return{messages:n,threadJid:e}}function c(e){return{ravenMsgId:e.msgId,threadJid:e.threadJid}}function d(e,t){return e.filter(function(e){return t===e.threadJid}).map(function(e){return e.msgId})}function m(e){var t,n,a,i,l,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R=e.chatJid,L=e.filteredMsgIds,E=e.hasMediaForUI,k=e.hdTypes,I=e.media,T=e.offlineAttachmentId,D=e.ravenSettings,x=e.sortOrderMs,$=e.transportKey;switch(I.mediaType){case"Image":return{duration:null,ephemeralMediaState:D==null?void 0:D.ephemeralMediaState,ephemeralMediaViewMode:D==null?void 0:D.ephemeralMediaViewMode,filesize:I.size,hasMedia:E,hasPreviewMedia:((t=I.validatedImageInfo)==null?void 0:t.jpegThumbnail)!=null,hdTypes:k,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(n=I.validatedImageInfo)==null?void 0:n.jpegThumbnailHeight,previewHeightLarge:(a=I.validatedImageInfo)==null?void 0:a.height,previewWidth:(i=I.validatedImageInfo)==null?void 0:i.jpegThumbnailWidth,previewWidthLarge:(l=I.validatedImageInfo)==null?void 0:l.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Video":return{duration:((s=I.validatedVideoInfo)==null?void 0:s.duration)!=null?((u=I.validatedVideoInfo)==null?void 0:u.duration)*1e3:0,ephemeralMediaState:D==null?void 0:D.ephemeralMediaState,ephemeralMediaViewMode:D==null?void 0:D.ephemeralMediaViewMode,filesize:I.size,gifPlayback:((c=I.validatedVideoInfo)==null?void 0:c.gifPlayback)===!0||I.isVideoGif===!0,hasMedia:E,hasPreviewMedia:((d=I.validatedVideoInfo)==null?void 0:d.jpegThumbnail)!=null,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(m=I.validatedVideoInfo)==null?void 0:m.jpegThumbnailHeight,previewHeightLarge:(p=I.validatedVideoInfo)==null?void 0:p.height,previewWidth:(_=I.validatedVideoInfo)==null?void 0:_.jpegThumbnailWidth,previewWidthLarge:(f=I.validatedVideoInfo)==null?void 0:f.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Ptt":return{duration:(g=I.validatedAudioInfo)!=null&&g.duration?I.validatedAudioInfo.duration*1e3:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts),waveformData:((h=I.validatedAudioInfo)==null?void 0:h.waveform)!=null?o("MAWAudioUtils").serializeWaveform(I.validatedAudioInfo.waveform):void 0};case"Gif":return{accessibilitySummaryText:(y=I.accessibilitySummaryText)!=null?y:void 0,duration:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:I.msgIds,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(C=I.validatedImageInfo)==null?void 0:C.jpegThumbnailHeight,previewHeightLarge:(b=I.validatedImageInfo)==null?void 0:b.height,previewWidth:(v=I.validatedImageInfo)==null?void 0:v.jpegThumbnailWidth,previewWidthLarge:(S=I.validatedImageInfo)==null?void 0:S.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Sticker":{var P,N,M,w=o("MAWImageUtils").boundHeightWidth((P=I.validatedImageInfo)==null?void 0:P.jpegThumbnailHeight,(N=I.validatedImageInfo)==null?void 0:N.jpegThumbnailWidth,o("MAWImageUtils").STICKER_THUMBNAIL_MAX_SIZE),A=w.height,F=w.width;return{accessibilitySummaryText:(M=I.accessibilitySummaryText)!=null?M:void 0,duration:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:I.msgIds,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:A,previewHeightLarge:A,previewWidth:F,previewWidthLarge:F,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)}}case"DocumentFile":{var O,B={};for(var W of I.mediaEntries){var q=W[0],U=W[1],V=o("WAMediaUtils").mediaEntryDataToRawData(I.plaintextHash,U),H=V.filename;H!=null&&(B[q]=H)}return{defaultFilename:(O=I.validatedDocumentFileInfo)==null?void 0:O.filename,duration:null,filenames:B,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)}}default:throw I.mediaType,r("FBLogger")("messenger_web").mustfixThrow("[createBridgeMedia] Unsupported media type: "+I.mediaType)}}function p(e,t,n){return{chatJid:e,deliveredWatermarkTs:n!=null?n:o("WATimeUtils").castToUnixTime(0),fbid:t,lastReadActionTs:o("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:o("WATimeUtils").castToUnixTime(0)}}function _(e){var t=e.cannotReplyReason,n=e.folder,r=e.snippetParams,o=e.snippetSenderContactId,a=e.snippetType,i=e.threadJid;return{cannotReplyReason:t,folder:n,snippetContactIDs:r==null?void 0:r.contactIDs,snippetMentionJIDs:r==null?void 0:r.mentionJIDs,snippetParams:r==null?void 0:r.strings,snippetSenderContactId:o,snippetType:a,threadJid:i}}function f(e){return{chatJid:e.groupJid,memberAddMode:e.memberAddMode,threadName:e.name}}var g={snippetContactIDs:[],snippetMentionJIDs:[],snippetParams:[],snippetSenderContactId:null,snippetType:null};function h(e){var t,n=e.bumpTimestampMs,r=e.description,o=e.isMessageAuthorMe,a=e.isUnbump,i=e.skipBumpTimestampValidation,l=e.skipServerThreadBump,s=e.snippetData,u=e.threadJid,c=s==null?g:{snippetContactIDs:s.params.contactIDs,snippetMentionJIDs:(t=s.params.mentionJIDs)!=null?t:[],snippetParams:s.params.strings,snippetSenderContactId:s.senderContactId,snippetType:s.type};return babelHelpers.extends({},c,{bumpTimestampMs:n,description:r,isMessageAuthorMe:o,isUnbump:a,skipBumpTimestampValidation:i!=null?i:!1,skipServerThreadBump:l!=null?l:!1,threadJid:u})}function y(e){var t=e.author,n=e.chatJid,r=e.reaction,a=e.reactToMsgId,i=e.ts;return{actorId:o("WAJids").authorToUserId(t,o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid())),chatJid:n,messageId:a,reaction:r,ts:i}}function C(e){var t=o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid()),n=e.author,r=e.chatJid,a=e.reactToMsgId;return{actorId:o("WAJids").authorToUserId(n,t),chatJid:r,messageId:a}}function b(e){return{creationTs:e.creationTs,creator:e.creator,groupJid:e.groupJid,msgExpiration:e.msgExpiration,name:e.name,nameOwner:e.nameOwner,nameTs:e.nameTs,participantVersion:e.participantVersion}}function v(e){var t=e.threadJid,n=e.inviteeJid;return{caption:e.caption,inviteCode:e.inviteCode,inviteeId:n,inviteExpireTs:e.inviteExpirationTs,inviterId:o("WAJids").extractUserId(e.inviterJid),threadJid:t}}function S(e){return{threadJid:e}}function R(e,t,n){return{senderId:o("WAJids").extractUserId(t),state:n,threadJid:e}}l.createBridgeUpdateE2EEMetadataParticipants=e,l.createBridgeDeletedMessage=s,l.createBridgeDeleteMessages=u,l.createBridgeRavenAction=c,l.getMsgIdsFilteredByJid=d,l.createBridgeMedia=m,l.createBridgeReceivedReceipt=p,l.createBridgeUpdatedThread=_,l.createBridgeUpdatedGroupInfo=f,l.createBridgeBumpedThreadV2=h,l.createBridgeUpsertReaction=y,l.createBridgeDeleteReaction=C,l.createBridgeGroupInfo=b,l.createBridgeGroupInvite=v,l.createBridgeDeleteGroupInvite=S,l.createBridgeReceivedChatState=R}),98);
__d("MAWBridgeReceiverFetchInfo",["WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,r,o){var a=o.accessibilitySummaryText,i=o.mimetype,l=o.previewHeight,s=o.previewUrl,u=o.previewUrlExpirationTimestampMs,m=o.previewWidth,p=o.receiverFetchId,_=o.type;return{accessibilitySummaryText:a,mimetype:i,msgId:t,previewHeight:l,previewUrl:s,previewUrlExpirationTimestampMs:d(u),previewWidth:m,receiverFetchId:p,sortOrderMs:c(n,r),threadJid:e,type:_}}function u(e,t,n,r,o){var a=o.mimetype,i=o.previewHeight,l=o.previewWidth,s=o.receiverFetchId,u=o.type;return{mimetype:a,msgId:t,previewHeight:i,previewWidth:l,receiverFetchId:s,sortOrderMs:c(n,r),threadJid:e,type:u}}function c(e,t){return o("WATimeUtils").castToMillisTime(e!=null?e:t*1e3)}function d(t){if(t!=null)try{return o("WATimeUtils").castLongIntToMillisTime(t)}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast previewUrlExpirationTimestampMs to millis time: ",""])),t);return}}l.createBridgeReceiverFetchInfoPayloadFromDbInfo=s,l.createBridgeReceiverFetchInfoPayloadFromUnstoredInfo=u}),98);
__d("MAWLoadReplyMediaTxns",["MAWBridgeReceiverFetchInfo","MAWDbMedia","MAWDbMsg","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWMediaUtils","MAWMsgType","MAWUserJidWrapper","MAWXMAUtils","MWPBumpEntityKey","WAAssertUnreachable","WAJids","WALogger","WAMsgType","WAResultOrError","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;function f(e,t,n){if(r("gkx")("2419")&&n!=null){var a=o("MAWMediaUtils").genHMACPlaintextHash(n);return e.media.where("hashedPlaintextHash").equals(a).first()}else return e.media.get(t)}var g=new Set([(_=o("MAWDbMedia")).MEDIA_TYPE.IMAGE,_.MEDIA_TYPE.GIF,_.MEDIA_TYPE.PTT,_.MEDIA_TYPE.STICKER,_.MEDIA_TYPE.VIDEO,_.MEDIA_TYPE.DOCUMENT_FILE]);function h(e){var t;switch(e.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:case o("MAWDbMedia").MEDIA_TYPE.GIF:case o("MAWDbMedia").MEDIA_TYPE.STICKER:t=e.validatedImageInfo;break;case o("MAWDbMedia").MEDIA_TYPE.VIDEO:t=e.validatedVideoInfo;break}var n=t||{},r=n.height,a=n.jpegThumbnailHeight,i=n.jpegThumbnailWidth,l=n.width;return{replyMediaPreviewHeight:a!=null?a:r,replyMediaPreviewWidth:i!=null?i:l}}function y(e){switch(e.type){case o("MAWMsgType").MSG_TYPE.IMAGE:case o("MAWMsgType").MSG_TYPE.VIDEO:case o("MAWMsgType").MSG_TYPE.PTT:case o("MAWMsgType").MSG_TYPE.GIF:case o("MAWMsgType").MSG_TYPE.STICKER:case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return!0;case o("MAWMsgType").MSG_TYPE.XMA:return r("gkx")("9921")?!0:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(e.xmaMessageType)||o("MAWXMAUtils").isXMAStoryReply(e.xmaMessageType);case o("MAWMsgType").MSG_TYPE.TEXT:case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:case o("MAWMsgType").MSG_TYPE.REVOKED:case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:case o("WAMsgType").NOTE_REPLY:case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:case o("MAWMsgType").MSG_TYPE.RAVEN:return!1;default:return r("WAAssertUnreachable")(e.type)}}function C(t,n,r){if(n==null)return o("MAWDexieTable").dexieResolve();var a=f(t,n,r).then(function(e){if(e==null)return o("WAResultOrError").makeError("reply_media_not_found");if(!g.has(e.mediaType))return o("WAResultOrError").makeError("reply_media_type_unknown");var t=h(e),r=t.replyMediaPreviewHeight,a=t.replyMediaPreviewWidth;return n!=null&&e.plaintextHash==null&&o("MWPBumpEntityKey").bumpEntityKeyWithAppId("maw.reply_attachment_media_missing_plaintext_hash","load_reply_media_txns_for_reply_type_'unknown'}"),o("WAResultOrError").makeResult({replyMediaId:n,replyMediaPreviewHeight:r,replyMediaPreviewWidth:a,replyPlaintextHash:e.plaintextHash})});return a.then(function(t){if(t.success!==!0){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unable to fetch reply media with id ",": ",""])),n,t.error);return}return t.value})}function b(e,t){var n=t.defaultPreviewMediaId;if(n==null)return o("MAWDexieTable").dexieResolve({replyXMAId:t.xmaId});var r=f(e,n).then(function(e){if(e==null)return o("WAResultOrError").makeError("reply_xma_media_not_found - "+t.targetType);if(!g.has(e.mediaType))return o("WAResultOrError").makeError("reply_xma_media_type_unknown");var n=h(e),r=n.replyMediaPreviewHeight,a=n.replyMediaPreviewWidth;return o("WAResultOrError").makeResult({replyMediaPreviewHeight:r,replyMediaPreviewWidth:a,replyPlaintextHash:e.plaintextHash,replyXMAId:t.xmaId})});return r.then(function(e){if(e.success!==!0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unable to fetch reply media XMA with id ",": ",""])),t.xmaId,e.error);return}return e.value})}function v(e,t,n){var a,i,l;n===void 0&&(n=!1);var s=((a=t.quote)==null?void 0:a.content)||{},u=s.author,c=s.externalId,d=s.mediaId,m=s.msgId,p=s.plaintextHash,_=s.type,f=s.xmaMessageType;if(((i=t.quote)==null?void 0:i.content)==null||!y((l=t.quote)==null?void 0:l.content))return o("MAWDexieTable").dexieResolve();var g=t.threadJid,h=u===o("MAWUserJidWrapper").getMyUserJid(),b=h?o("WAJids").AUTHOR_ME:u;return(r("gkx")("9921")?_===o("MAWMsgType").MSG_TYPE.XMA:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(f))?S(e,o("MAWJidUtils").maybeToProtocolMsgId(b,g,c)):_===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?E(e,m):C(e,d,n?null:p)}function S(e,t){return t==null?o("MAWDexieTable").dexieResolve():o("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(e,t).then(function(t){if(!(t==null||o("MAWXMAUtils").isXMAExpired(t.isTombstoned,t.targetExpiringAtSec)))return b(e,t)})}function R(e,t){var n=t.author,a=t.externalId,i=t.mediaId,l=t.plaintextHash,s=t.threadJid,u=t.type,c=t.xmaMessageType,d=r("gkx")("9921")?u===o("MAWMsgType").MSG_TYPE.XMA:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(c),m=u===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH;return!o("MAWDbMsg").isMediaMsg(t)&&!d&&!m?o("MAWDexieTable").dexieResolve():d?S(e,o("MAWJidUtils").maybeToProtocolMsgId(n,s,a)):m?L(e,t.receiverFetchId):C(e,i,l)}function L(e,t,n){return t==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Missing receiverFetchId for getReplyMediaForReceiverFetchWithReceiverFetchId"]))),o("MAWDexieTable").dexieResolve()):e.receiverFetchInfo.get({receiverFetchId:t}).then(function(e){if(e==null){o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Missing receiverFetchInfo for getReplyMediaForReceiverFetchWithReceiverFetchId"])));return}try{var t=o("MAWDbMedia").convertNumberToMediaId(parseInt(e.receiverFetchId,10));return n!=null&&o("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:o("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(n.threadJid,n.msgId,n.sortOrderMs,n.ts,e)}),{replyMediaId:t,replyMediaPreviewHeight:e.previewHeight,replyMediaPreviewWidth:e.previewWidth}}catch(e){o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unable to convert receiver fetch id to media id: ",""])),e);return}})}function E(e,t){return t==null?(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Missing msgId for getReplyMediaForReceiverFetch"]))),o("MAWDexieTable").dexieResolve()):e.messages.get({msgId:t}).then(function(t){if(t==null||t.type!==o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH||t.receiverFetchId==null){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Invalid msg for getReplyMediaForReceiverFetch with type: ",""])),t==null?void 0:t.type);return}return L(e,t.receiverFetchId,t)})}l.getMedia=f,l.MSG_MEDIA_TYPE=g,l.getImageAttributes=h,l.isMediaReplyContent=y,l.getReplyMediaForMsgQuote=v,l.getReplyMediaForMsg=R}),98);
__d("MAWDbMsgUtil",["WAJids","WALogger","WAMsgMap"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return t.reduce(function(t,n){var r=n.threadJid;return r==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Missing jid prevents adding message to array map"]))),t):n.author==="@system"?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Invalid author when converting msg array to map"]))),t):(t.set({author:n.author,chat:r,externalId:n.externalId},n),t)},new(o("WAMsgMap")).MsgMap)}function c(e){return o("WAJids").isAuthorSystem(e.author)||e.threadJid==null?null:{author:e.author,chat:e.threadJid,externalId:e.externalId}}l.convertMsgArrayToMap=u,l.getProtocolMsgIdFromDbMsg=c}),98);
__d("MAWDbUnrenderedMsgTxns",["MAWAckLevel","MAWDbMsg","MAWDbMsgUtil","MAWDexieTable","WAJids","WALogger","WAMsgMap","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){var n=t.author,r=t.chat,a=t.externalId;return e.threads.get({jid:r}).then(function(t){return t==null?o("WAResultOrError").makeError("missing_thread_unrendered_msg"):m(e,a,r,n).then(function(e){return e==null?o("WAResultOrError").makeError("missing_unrendered_msg"):o("WAResultOrError").makeResult(e)})})}function d(e,t){var n=t.map(function(e){var t=e.externalId;return t});return e.unrenderedMessages.where("externalId").anyOf(n).toArray().then(function(e){var n=o("MAWDbMsgUtil").convertMsgArrayToMap(e),r=new(o("WAMsgMap")).MsgMap;return t.forEach(function(e){var t=n.get(e);t!=null&&r.set(e,t)}),r})}function m(e,t,n,r){return e.unrenderedMessages.where("externalId").equals(t).filter(function(e){return e.author===r&&e.threadJid===n}).first()}function p(e,t){return e+"_"+t}function _(e,t){var n=t.map(function(e){var t=e.externalId;return t}),r=Array.from(new Set(t.map(function(e){return e.chat})));return o("MAWDexieTable").dexieAll([e.threads.where("jid").anyOf(r).toArray(),e.unrenderedMessages.where("externalId").anyOf(n).toArray()]).then(function(e){var n=e[0],r=e[1];if(r.length===0||n.length===0)return[];var o=new Map;return t.forEach(function(e){var t=e.author,n=e.chat,r=e.externalId,a=o.get(r)||new Set;a.add(p(t,n)),o.set(r,a)}),r.filter(function(e){var t=e.author,n=e.externalId,r=e.threadJid,a=o.get(n);return a!=null&&r!=null&&a.has(p(t,r))})})}function f(t,n,r){return g(t,[{ack:r,msgId:n}]).then(function(t){var n=t[0];return n==null?(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["updateSystemAckForUnrenderedMsg on non existing message"]))),null):n})}function g(e,t){var n=t.map(function(e){return e.msgId}),r=new Map;return t.forEach(function(e){return r.set(e.msgId,{ack:e.ack})}),e.unrenderedMessages.where("msgId").anyOf(n).toArray().then(function(t){if(t.length===0)return t;var n=[],a=[];return t.forEach(function(e){var t;if(e.author!==o("WAJids").AUTHOR_ME){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on incoming message"]))),n.push(e);return}if(e.ack>o("MAWAckLevel").ACK.clock){o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on sent message"]))),n.push(e);return}var i=(t=r.get(e.msgId))==null?void 0:t.ack;if(i==null)return null;var l=babelHelpers.extends({},e,{ack:i});i===o("MAWAckLevel").ACK.sent&&delete l.resendCount,a.push(l)}),e.unrenderedMessages.bulkPut(a).then(function(){return[].concat(a,n)})})}function h(e,t){var n=t.map(function(t){return e.unrenderedMessages.get({msgId:t})});return o("MAWDexieTable").dexieAll(n)}function y(e,t){return e.unrenderedMessages.where("msgId").between(o("MAWDbMsg").msgIdsInChatLowerBound(t.chatId),o("MAWDbMsg").msgIdsInChatUpperBound(t.chatId)).last().then(function(e){var t=e==null?0:o("MAWDbMsg").getInChatMsgIdFromMsgId(e.msgId);return t+1})}l.maybeGetUnrenderedMsgByProtocolMsgId=c,l.getUnrenderedMsgMapByProtocolMsgId=d,l.maybeGetUnrenderedMsgByExternalId=m,l.getUnrenderedMsgsByProtocolMsgId=_,l.updateSystemAckForUnrenderedMsg=f,l.bulkUpdateSystemAckForUnrenderedMsgs=g,l.getUnrenderedMsgsByMsgIds=h,l.getNextUnrenderedMsgIdNumberForThread=y}),98);
__d("MAWMessageSortOrderUtils",["I64","MAWDbMsg","MAWExtractMsFromExternalId","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(t){var n=t.revokedExternalId!=null?t.revokedExternalId:t.externalId;n==null&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["generateAuthoritativeMessageSortOrder called without ID"])));var r=(d||(d=o("I64"))).of_string_opt(n);if(t.serverTs==null){var a;if(t.sortOrderMs!=null)return t.sortOrderMs;r==null&&o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] ExternalId is not present"])));var i=r==null?null:o("MAWExtractMsFromExternalId").extractMsFromExternalId(r);return Math.floor((a=t.originalTs)!=null?a:o("MAWDbMsg").getCanonicalTsFromMsg(t))*1e3+(i!=null?i:0)}if(r!=null){var l=o("MAWExtractMsFromExternalId").extractMsFromExternalId(r);if(l!=null){var m=t.originalTs!=null?t.originalTs:t.serverTs;return Number(m)*1e3+l}else o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Timestamp bits in externalId not valid"])))}else o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] externalId is not a valid int64"])));return o("MAWDbMsg").getSortOrderWithFallback(t)}l.generateAuthoritativeMessageSortOrder=m}),98);
__d("WAArrayGroupBy",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){for(var n=new Map,r=0;r<e.length;r++){var o=t(e[r]),a=n.get(o);a==null?n.set(o,[e[r]]):a.push(e[r])}return Array.from(n.entries())}i.groupBy=e}),66);
__d("MAWDbMsgTxns",["EncryptedBackupsUtils","FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbMsg","MAWDbMsgUtil","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWMessageSortOrderUtils","MAWMsgType","MAWODSProxy","MAWTransactionMode","MAWTransactor","Random","WAArrayGroupBy","WAJids","WALogger","WAMsg","WAMsgMap","WAOdsEnums","WAResultOrError","WATimeUtils","emptyFunction","gkx","justknobx","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g;function h(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.messages.get({msgId:t})}function y(e,t){return e.messages.where("threadJid").equals(t).count().then(function(e){return e===0})}function C(e,t,n){return e.messages.where("threadJid").equals(t).filter(n).first().then(function(e){return e!=null})}function b(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).between([t,Number.MIN_SAFE_INTEGER],[t,Number.MAX_SAFE_INTEGER],n,r)}function v(e,t){return b(e,t,!1,!1).last()}function S(e,t){return v(e,t).then(function(e){return e==null?void 0:e.msgId})}function R(e,t){return v(e,t).then(function(e){return(e==null?void 0:e.sortOrderMs)==null?null:o("WATimeUtils").castToMillisTime(e.sortOrderMs)})}function L(e,t,n){return r("vulture")("ST6o7qk-BKGl46ZXS71LYr_2y6I="),b(e,t,!1,!1).reverse().limit(n).toArray()}function E(e,t){return b(e,t,!1,!1).first()}function k(e,t){return E(e,t).then(function(e){return e==null?void 0:e.msgId})}function I(e,t){return e.messages.where("externalId").equals(t.externalId).filter(function(e){return e.author===t.author&&e.threadJid===t.chat}).toArray().then(D)}function T(e,t){var n=new Set(t.map(function(e){var t=e.author,n=e.chat,r=e.externalId;return o("WAMsg").craftWAMsgIdString({author:t,chat:n,externalId:r})}));return e.messages.where("externalId").anyOf(t.map(function(e){var t=e.externalId;return t})).filter(function(e){var t=e.author,r=e.externalId,a=e.threadJid;return n.has(o("WAMsg").craftWAMsgIdString({author:t,chat:a,externalId:r}))}).toArray().then(function(e){return o("WAArrayGroupBy").groupBy(e,function(e){return o("WAMsg").craftWAMsgIdString({author:e.author,chat:e.threadJid,externalId:e.externalId})}).map(function(e){var t=e[0],n=e[1];return D(n)}).filter(Boolean)})}function D(t){if(t.length>1){var n=t.map(function(e){var t,n;return e.type+":"+((t=e.serverTs)!=null?t:0).toString()+":"+((n=e.ts)!=null?n:0).toString()}),a=new Set(n).size===1;a?o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByProtocolMsgId] Suspected multiple instances of same message!"]))):o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByProtocolMsgId] Can't have "," messages with the same protocolMsgId!"])),t.length),(r("gkx")("5039")||o("Random").coinflip(r("justknobx")._("3594")))&&x(t)}return t[0]}function x(e){var t=e.length;if(!(t<=1)){var n=t-1,a=e[n],i={editCount:0,mediaId:0,revokedStatus:0,serverTs:0,sortOrderMs:0,ts:0,type:0};e.slice(0,n).forEach(function(e){var t=[];if((e==null?void 0:e.editCount)!==(a==null?void 0:a.editCount)){var n,l;i.editCount++,t.push("editCount, reference: "+((n=a==null?void 0:a.editCount)!=null?n:"")+", duplicate: "+((l=e==null?void 0:e.editCount)!=null?l:"")+". ")}if((e==null?void 0:e.mediaId)!==(a==null?void 0:a.mediaId)&&(i.mediaId++,t.push("mediaId, reference: "+((a==null?void 0:a.mediaId)!=null?String(a.mediaId):"")+", duplicate: "+((e==null?void 0:e.mediaId)!=null?String(e.mediaId):"")+". ")),e.sortOrderMs!==a.sortOrderMs&&(i.sortOrderMs++,t.push("sortOrderMs, reference: "+String(a.sortOrderMs)+", duplicate: "+String(e.sortOrderMs)+". ")),e.serverTs!==a.serverTs&&(i.serverTs++,t.push("serverTs, reference: "+String(a.serverTs)+", duplicate: "+String(e.serverTs)+". ")),e.ts!==a.ts&&(i.ts++,t.push("ts, reference: "+String(a.ts)+", duplicate: "+String(e.ts)+". ")),e.type!==a.type){var s,u;(e.type===o("MAWMsgType").MSG_TYPE.REVOKED||a.type===o("MAWMsgType").MSG_TYPE.REVOKED)&&(i.revokedStatus++,r("FBLogger")("MAWDuplicateMessageComparison").info("Revoked duplicate msg conflict, duplicate message, %s, has type: %s, externalId: %s, revokedExternalId: %s, sortOrderMs: %s, serverTs: %s, ts: %s, rowId: %s, reference msg, %s, has type: %s, externalId: %s, revokedExternalId: %s, sortOrderMs: %s, serverTs: %s, ts: %s, rowId: %s",e.msgId,e.type,e.externalId,e.revokedExternalId,e.sortOrderMs,e.serverTs,e.ts,e.rowId,a.msgId,a.type,a.externalId,a.revokedExternalId,e.sortOrderMs,e.serverTs,e.ts,e.rowId)),i.type++,t.push("type, reference: "+((s=a.type)!=null?s:"")+", duplicate: "+((u=e.type)!=null?u:"")+". ")}var c=t.join("");c.length>0?r("FBLogger")("MAWDuplicateMessageComparison").info("Duplicate msg, %s, has conflicting field values to reference msg, %s: %s",e.msgId,a.msgId,c):r("FBLogger")("MAWDuplicateMessageComparison").info("Duplicate msg, %s, has no conflicting field values to reference msg, %s",e.msgId,a.msgId)}),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"sets_of_duplicate_msgs"}),Object.keys(i).forEach(function(e){var t=i[e];t>0&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"sets_of_duplicate_msgs_with_"+e+"_field_differences"})}),o("MAWODSProxy").odsBumpEntityKey({amount:t-1,entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"number_of_duplicate_msgs"}),Object.keys(i).forEach(function(e){var t=i[e];t>0&&o("MAWODSProxy").odsBumpEntityKey({amount:t,entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"number_of_duplicate_msgs_with_"+e+"_field_differences"})})}}function $(e,t,n,r){var o={author:r,chat:n,externalId:t};return I(e,o)}function P(e,t){return e.messages.where("msgId").equals(t).toArray()}function N(e,t){return A(e,t).then(function(e){return e.success,e})}function M(e,t){var n=t.map(function(e){var t=e.externalId;return t});return e.messages.where("externalId").anyOf(n).toArray().then(function(e){var n=o("MAWDbMsgUtil").convertMsgArrayToMap(e),r=new(o("WAMsgMap")).MsgMap;return t.forEach(function(e){var t=n.get(e);t!=null&&r.set(e,t)}),r})}function w(e,t){return e.messages.where("msgId").equals(t).first().then(function(e){return e==null?void 0:e.sortOrderMs})}function A(e,t){var n=t.author,r=t.chat,a=t.externalId;return e.threads.get({jid:r}).then(function(t){return t==null?o("WAResultOrError").makeError("missing_thread_msg"):$(e,a,t.jid,n).then(function(e){return e==null?o("WAResultOrError").makeError("missing_msg"):o("WAResultOrError").makeResult(e)})})}function F(e,t){var n=t.author,r=t.chat,o=t.externalId;return e.threads.get({jid:r}).then(function(t){if(t!=null)return e.messages.where("revokedExternalId").equals(o).filter(function(e){return e.author===n&&e.threadJid===t.jid&&e.type==="Revoked"}).first()})}function O(e,t,n,r){var a=e.messages.where("revokedExternalId").equals(t).filter(function(e){return e.author===r&&e.threadJid===n&&e.type===o("MAWMsgType").MSG_TYPE.REVOKED}).first(),i=o("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByExternalId(e,t,n,r).then(function(e){if((e==null?void 0:e.type)===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return e});return o("MAWDexieTable").dexieAll([a,i]).then(function(e){var t=e[0],n=e[1];return t!=null||n!=null})}function B(e,t){var n=new Array(t.length),r=new Set;return t.forEach(function(e){n.push(e.externalId),r.add(o("EncryptedBackupsUtils").convertWAMsgIdToStringId(e))}),e.messages.where("externalId").anyOf(n).filter(function(e){return r.has(o("EncryptedBackupsUtils").convertWAMsgIdToStringId({author:e.author,chat:e.threadJid,externalId:e.externalId}))}).toArray()}function W(e,t,n,r,a,i){return q(e,[{ack:n,applicationErrorCode:i,msgId:t,reportingMeta:a,serverTs:r}]).then(function(e){var n=e.find(function(e){return e.msgId===t});return n==null?(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["updateSystemAck on non existing message"]))),null):n})}function q(e,t){var n=t.map(function(e){return e.msgId});return o("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(e,n).then(function(r){var a=new Map;t.forEach(function(e){a.set(e.msgId,{ack:e.ack,applicationErrorCode:e.applicationErrorCode,reportingMeta:e.reportingMeta,serverTs:e.serverTs});var t=r.get(e.msgId);t!=null&&a.set(t,{ack:e.ack,applicationErrorCode:e.applicationErrorCode,reportingMeta:e.reportingMeta,serverTs:e.serverTs})});var i=Array.from(new Set(n.concat(Array.from(r.values()))));return e.messages.where("msgId").anyOf(i).toArray().then(function(t){if(t.length===0)return t;var n=[],r=[];return t.forEach(function(e){var t,i,l;if(e.author!==o("WAJids").AUTHOR_ME||e.ack>o("MAWAckLevel").ACK.clock){n.push(e);return}var s=(t=a.get(e.msgId))==null?void 0:t.ack,u=(i=a.get(e.msgId))==null?void 0:i.serverTs;if(s==null)return null;var c=babelHelpers.extends({},e,{ack:s});U(c,u);var d=(l=a.get(e.msgId))==null?void 0:l.reportingMeta;d!=null&&(c.reportingMeta=d),s===o("MAWAckLevel").ACK.sent&&delete c.resendCount,r.push(c)}),n.length>0&&o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck: not updating ",""])),n.map(function(e){return e.msgId}).toString()),e.messages.bulkPut(r).then(function(){return o("MAWDexieTable").dexieAll(r.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)}))}).then(function(e){return r.forEach(function(t,n){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e[n])})}),[].concat(r,n)})})})}function U(e,t){if(t!=null){e.serverTs=t;var n=e.sortOrderMs;e.type!==o("MAWMsgType").MSG_TYPE.REVOKED&&(e.sortOrderMs=o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(e),o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Message was acked by server (serverTs = ","), override sortOrderMs: "," -> ",""])),t,n,e.sortOrderMs))}}function V(e,t,n,a){return o("MAWDbThreadTxns").getThread(e,t).then(function(t){if(!(!t.success||a==null)){var i=t.value,l=[e.messages.where(["threadJid","sortOrderMs"]).above([i.jid,a]).first(),e.messages.where(["threadJid","sortOrderMs"]).below([i.jid,a]).last()];return o("MAWDexieTable").dexieAll(l).then(function(t){var a=t[0],l=t[1];return o("MAWDbThreadTxns").updateThread(e,babelHelpers.extends({},i,{newestMsgTs:(l==null?void 0:l.ts)==null?i.newestMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(l.ts),oldestMsg:i.oldestMsg===n?a==null?void 0:a.msgId:i.oldestMsg})).then(r("emptyFunction"))})}})}function H(e){return e.messages.where("altIndex").equals(o("MAWDbMsg").FUTUREPROOF_ALT_INDEX).toArray().then(function(e){var t=[];return e.forEach(function(e){if(e.type!==o("MAWMsgType").MSG_TYPE.FUTUREPROOF){o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["getFutureproofMsg gets a message "," with unsupported type ",""])),e.msgId,e.type);return}t.push(e)}),t})}function G(e){return e.toString()}function z(e,t,n,a){var i=t.mediaId;if(i===n)return o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["updateMediaId on message "," that already has this mediaId ",""])),t.msgId,n),o("MAWDexieTable").dexieResolve();var l=i!=null?e.media.get(i):o("MAWDexieTable").dexieResolve();return l.then(function(i){i&&o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Replacing mediaId for message with pre-existing media. type=",""])),t.type);var l=a!=null?a:void 0,s=babelHelpers.extends({},t,{mediaId:n,plaintextHash:l});return e.messages.put(s).then(r("emptyFunction"))})}function j(e,t){var n=Array.from(t.keys());return e.messages.where("msgId").anyOf(n).toArray().then(function(n){var a=[];return n.map(function(e){var n=t.get(e.msgId),i=e.mediaId;if(i!=null&&i!==n){if(n!=null)throw r("FBLogger")("messenger_web").mustfixThrow("mediaId "+G(i)+" in message "+e.msgId+" is different with the "+G(n)+" in bulkUpdateMediaId");o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["updateMediaId on message "," that already has this mediaId ",""])),e.msgId,n);return}var l=babelHelpers.extends({},e,{mediaId:n,plaintextHash:e.plaintextHash});a.push(l)}),e.messages.bulkPut(a).then(r("emptyFunction"))})}function K(e,t){return Q(e,[t]).then(r("emptyFunction"))}function Q(e,t){return e.messages.where("msgId").anyOf(t).toArray().then(function(t){var n=t.map(function(e){return babelHelpers.extends({},e,{isExpiredXmaMsg:!0})});return e.messages.bulkPut(n).then(function(){return n})})}function X(e,t,n,r){if(r!=null&&r<=0)return o("MAWDexieTable").dexieResolve([]);var a=e.messages.where("altIndex").equals(o("MAWDbMsg").craftToBeReadAltIndex(t)).filter(function(e){return o("MAWDbMsg").getSortOrderWithFallback(e)<=n});return r!=null&&(a=a.limit(r)),a.toArray()}function Y(e,t,n){return X(e,t,n).then(function(t){var n=t.map(function(e){return babelHelpers.extends({altIndex:null},e)});return e.messages.bulkPut(n).then(function(){return n})})}function J(e,t){return e.messages.delete(t)}function Z(e,t){return e.messages.bulkDelete(t)}function ee(e,t,n){var r=t.map(function(e){return e.rowId}),a=n!=null?t.map(function(e){var t=o("MAWJidUtils").toProtocolMsgId(e);if(t)return babelHelpers.extends({},t,{reason:n})}).filter(Boolean):[];return o("MAWDexieTable").dexieAll([e.deletedMessages.bulkAdd(a),e.messages.bulkDelete(r)]).then(function(e){var t=e[0],n=e[1];o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Successfull deleted "," messages"])),n)})}function te(e,t){return e.messages.where("msgId").anyOf(t).toArray()}function ne(e){return e.messages.where("altIndex").anyOf([o("MAWDbMsg").SPAM_ALT_INDEX,o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX]).toArray()}function re(e,t,n,r,a,i,l,s){l===void 0&&(l="before"),s===void 0&&(s=null);var u=n==null?null:o("MAWDbMsg").getSortOrderWithFallback(n);return l==="before"?e.messages.where(["threadJid","sortOrderMs"]).between([t,s!=null?s:Number.MIN_SAFE_INTEGER],[t,u!=null?u:Number.MAX_SAFE_INTEGER],!0,r).reverse().filter(i).limit(a).toArray():e.messages.where(["threadJid","sortOrderMs"]).between([t,u!=null?u:Number.MIN_SAFE_INTEGER],[t,s!=null?s:Number.MAX_SAFE_INTEGER],r,!0).filter(i).limit(a).toArray().then(function(e){return e.sort(function(e,t){return t.ts-e.ts})})}function oe(e,t,n,r){var o=n.msgId;if(r==null){var a;return{oldestMsg:(a=e==null?void 0:e.msgId)!=null?a:o}}var i=[e,t,n].filter(Boolean);return{oldestMsg:i.reduce(function(e,t){return ae(e,o,r)<ae(t,o,r)?e:t}).msgId}}function ae(e,t,n){return e.msgId===t?n:o("MAWDbMsg").getSortOrderWithFallback(e)}function ie(e,t){return e.messages.where("msgId").between(o("MAWDbMsg").msgIdsInChatLowerBound(t.chatId),o("MAWDbMsg").msgIdsInChatUpperBound(t.chatId)).last().then(function(e){var t=e==null?0:o("MAWDbMsg").getInChatMsgIdFromMsgId(e.msgId);return t+1})}function le(e){return o("MAWTransactor").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY},"checkMessagesExistenceByProtocolMsgIds",function(t){return function(){return o("MAWDexieTable").dexieAll(e.map(function(e){return t.messages.get({protocolMsgId:e.chat+"."+e.externalId})}))}})()}function se(e,t){return e.messages.where("externalId").anyOf(t).toArray()}l.maybeGetMsg=h,l.getIsThreadEmpty=y,l.doesThreadHaveMsgsMatchCriteria=C,l.getThreadMessagesBySortOrder=b,l.getThreadNewestMessageBySortOrder=v,l.getThreadNewestMessageId=S,l.getThreadNewestMessageMs=R,l.getThreadNewestNumMessagesBySortOrder=L,l.getThreadOldestMessageBySortOrder=E,l.getThreadOldestMessageId=k,l.maybeGetMsgByProtocolMsgId=I,l.getUniqueMsgsByProtocolMsgIds=T,l.maybeGetMsgByExternalId=$,l.maybeGetMsgListByMsgId_I_KNOW_WHAT_I_AM_DOING=P,l.maybeGetMsgResultByProtocolMsgId=N,l.getMsgMapByProtocolMsgId=M,l.getSortOrderFromMsgId=w,l.maybeGetRevokedMsgByProtocolMsgId=F,l.checkIfMsgIsDeletedForMeOrRevoked=O,l.getMsgsByProtocolMsgId=B,l.updateSystemAck=W,l.bulkUpdateSystemAck=q,l.maybeUpdateThreadMsgsForDeleteForMe=V,l.getFutureProofMsgs=H,l.updateMediaId=z,l.bulkUpdateMediaId=j,l.updateDbMsgXMAExpiration=K,l.bulkUpdateDbMsgXMAExpired=Q,l.getMsgsNeedingRetroactiveReadReceiptsUpTo=X,l.clearRetroactiveReadReceiptStatusFromMsgsUpTo=Y,l.deleteDbMsg=J,l.bulkDeleteDbMsg=Z,l.deleteMessages=ee,l.getMsgsByMsgIds=te,l.getSpamMsgs=ne,l.fetchMessagesFromDbWithSortOrderMs=re,l.calculateOldestMsg=oe,l.getNextMsgIdNumberForThread=ie,l.checkMessagesExistenceByProtocolMsgIds=le,l.UNSAFE_getMultipleMsgsByExternalId=se}),98);
__d("MAWAuthoritativeThreadsCache",[],(function(t,n,r,o,a,i){"use strict";var e=new Set;i.AuthoritativeThreadsCache=e}),66);
__d("MaybeCreateOrUpdateThreadResultCache",[],(function(t,n,r,o,a,i){"use strict";var e=new Map;function l(t){e.delete(t)}i.cache__I_KNOW_WHAT_I_AM_DOING=e,i.deleteCachedThreadResult=l}),66);
__d("MAWDbThreadTxns",["MAWAuthoritativeThreadsCache","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MaybeCreateOrUpdateThreadResultCache","WAArrayZip","WALogger","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return e.threads.get({deduplicationKey:t}).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function d(e,t){return e.threads.get({jid:t}).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function m(e,t){return e.threads.where("jid").anyOf(t).toArray()}function p(e,t){return e.threads.where("jid").startsWith(t+"@").first().then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function _(e){o("MaybeCreateOrUpdateThreadResultCache").deleteCachedThreadResult(e),o("MAWAuthoritativeThreadsCache").AuthoritativeThreadsCache.delete(e)}function f(e,t){return e.threads.where("jid").equals(t).delete().then(function(){return _(t)})}function g(e,t){return e.participants.where("userJid").equals(t).toArray().then(function(t){var n=t.map(function(e){return e.threadJid});return m(e,n)})}function h(e,t){return e.participants.where("userJid").anyOf(t).toArray().then(function(t){var n=new Map,r=new Set;return t.forEach(function(e){var t,o=e.userJid,a=(t=n.get(o))!=null?t:[];a.push(e.threadJid),n.set(o,a),r.add(e.threadJid)}),m(e,Array.from(r)).then(function(e){var t=e.reduce(function(e,t){return e.set(t.jid,t),e},new Map);return new Map(Array.from(n.entries()).map(function(e){var n=e[0],r=e[1];return[n,r.map(function(e){return t.get(e)}).filter(Boolean)]}))})})}function y(e,t,n){return(t==null?void 0:t.lastReadMsgReceiptSent)==null?o("MAWDexieTable").dexieResolve(!1):o("MAWDbMsgTxns").getSortOrderFromMsgId(e,t.lastReadMsgReceiptSent).then(function(e){return n.sortOrderMs==null||e==null?!1:n.sortOrderMs<=e})}function C(e,t){return e.threads.get({jid:t.threadJid}).then(function(n){return y(e,n,t)})}function b(e,t){return e.threads.where("jid").anyOf(t.map(function(e){return e.threadJid})).toArray().then(function(n){return o("MAWDexieTable").dexieAll(o("WAArrayZip").zip(t,n).map(function(t){var n=t[0],r=t[1];return y(e,r,n)}))})}function v(e,t,n){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var r=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{archived:!0,cannotReplyReason:n?"viewer_not_subscribed":e.cannotReplyReason,folder:o("MAWFolderTypes").FOLDER_ID.ARCHIVED})});return e.threads.bulkPut(r).then(function(){r.forEach(function(e){n&&o("WALogger").LOG(["[Occamadillo] Leaving a group thread\n          "+e.jid.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:e.cannotReplyReason,folder:o("MAWFolderTypes").FOLDER_ID.ARCHIVED,threadJid:e.jid})})})})})}function S(e,t){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var n=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{cannotReplyReason:null})});return e.threads.bulkPut(n).then(function(){n.forEach(function(e){var t={cannotReplyReason:null,threadJid:e.jid};o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread(t)})})})})}function R(e,t){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var n=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{archived:!1,cannotReplyReason:e.cannotReplyReason==="viewer_not_subscribed"?e.cannotReplyReason:null,folder:o("MAWFolderTypes").FOLDER_ID.INBOX})});return e.threads.bulkPut(n).then(function(){n.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:e.cannotReplyReason,folder:o("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:e.jid})})})})})}function L(e,t){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var n=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{cannotReplyReason:"viewer_not_subscribed"})});return e.threads.bulkPut(n).then(function(){n.forEach(function(e){var t={cannotReplyReason:"viewer_not_subscribed",threadJid:e.jid};o("WALogger").LOG(["[Occamadillo] User is unsubscribed from thread\n          "+e.jid.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread(t)})})})})}function E(t,n){return d(t,n).then(function(n){if(!n.success){o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["markThreadAsMigratedLocally failed to get the thread"])));return}var a=n.value;if(a.isMigratedLocally===!0){o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["markThreadAsMigratedLocally failed because thread is already migrated"])));return}var i=babelHelpers.extends({},a,{isMigratedLocally:!0});return t.threads.put(i).then(r("emptyFunction"))})}function k(e,t){if(t.isMigratedLocally===!1)return o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["markCutoverThreadAsNotMigratedLocally failed because thread is already unmigrated"]))),o("MAWDexieTable").dexieResolve(t);var n=babelHelpers.extends({},t,{isMigratedLocally:!1});return e.threads.put(n).then(function(){return n})}function I(e,t){return e.threads.put(t).then(r("emptyFunction"))}function T(e,t,n,r,a){return I(e,babelHelpers.extends({},t,{newestMsgTs:(a==null?void 0:a.ts)==null?t.newestMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(a.ts),oldestMsg:r==null?void 0:r.msgId}))}l.getThreadByDeduplicationKey=c,l.getThread=d,l.getThreads=m,l.getThreadPrimaryId=p,l.deleteThread=f,l.getAllThreadsForUser=g,l.getAllThreadsForUsers=h,l.needsRetroactiveReadReceiptInThread=C,l.bulkNeedsRetroactiveReadReceiptInThread=b,l.archiveThreads=v,l.subscribeToThreads=S,l.unarchiveThreads=R,l.unsubscribeFromThreads=L,l.markCutoverThreadAsMigratedLocally=E,l.markCutoverThreadAsNotMigratedLocally=k,l.updateThread=I,l.updateThreadMsgsForUndefinedOldestOrNewestMsgs=T}),98);
__d("MAWDbChunkTxns",["MAWDexieTable","MAWMediaUtils","MAWODSProxy","MWFBLogger","WAErrorMessage","WAOdsEnums"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MWFBLogger").MWLogger().tags(["maw_db","txn","MAWDbChunkTxns"]),m=function(t,n,r,a,i,l){l===void 0&&(l=0);var e=o("MAWMediaUtils").genHMACPlaintextHash(n);return p(t,n,e,r,a,i,l)},p=function(n,r,a,i,l,m,_){return _===void 0&&(_=0),n.chunk.where("hashedPlaintextHash").equals(a).first().then(function(t){var f={blobData:i,hashedPlaintextHash:a,isProgressivePreview:m!=null?m:void 0,mimetype:l,plaintextHash:r};if(t){_>0&&d.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Chunk found after retry for hashedPlaintextHash: ",""])),a);var g=m!==!0&&t.isProgressivePreview===!0;if(g){var h=babelHelpers.extends({},f,{chunkId:t.chunkId});return n.chunk.put(h).then(function(){return h})}else return t}return n.chunk.add(f).then(function(e){return babelHelpers.extends({},f,{chunkId:e})}).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);if(_>0)throw d.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk for hashedPlaintextHash: ",". Error: ",""])),a,t),d.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk after retry. Error: ",""])),t),e;return d.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk. Possible duplicate? Will attempt a retry. For hashedPlaintextHash: ",". Error: ",""])),a,t),o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_MEDIA_DB_DUPLICATE_CHUNK,key:"retry"}),p(n,r,a,i,l,m,_+1)})})},_=function(t,n){return t.chunk.where("hashedPlaintextHash").equals(n)},f=function(t,n){return _(t,n).count().then(function(e){return e>0})},g=function(t,n){return o("MAWDexieTable").dexieAll(n.map(function(e){return f(t,e).then(function(t){return[e,t]})})).then(function(e){return new Map(e)})},h=function(t,n){return _(t,n).first()},y=function(t,n){return t.chunk.where("hashedPlaintextHash").anyOf(n).toArray().then(function(e){return new Map(e.map(function(e){return[e.hashedPlaintextHash,e]}))})},C=function(t,n){var e=n.map(o("MAWMediaUtils").genHMACPlaintextHash);return t.chunk.where("hashedPlaintextHash").anyOf(e).toArray().then(function(e){return new Map(e.map(function(e){return[e.plaintextHash,e]}))})};function b(e,t){return e.chunk.bulkGet(t)}l.getOrCreateMediaChunkWithPlaintextHash=m,l.getOrCreateMediaChunkWithHashedPlaintextHash=p,l.hasMediaChunk=f,l.hasMediaChunks=g,l.maybeGetChunkFromHash=h,l.maybeBulkGetChunksFromHash=y,l.maybeBulkGetChunksFromPlaintextHash=C,l.bulkGetChunks=b}),98);
__d("MAWDbMediaTxns",["MAWDbMsg","MAWDexieTable","MAWMediaUtils","MAWMsgType","MAWODSProxy","WAHashUtils","WALogger","WAOdsEnums","WAResultOrError","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.media.get({mediaId:t})}function m(e,t){return t.length===0?o("MAWDexieTable").dexieResolve(new Map):e.media.bulkGet(t).then(function(e){return new Map(e.filter(Boolean).map(function(e){return[e.mediaId,e]}))})}function p(e,t){return e.media.where("hashedPlaintextHash").equals(t).first()}function _(e,t){var n=o("MAWMediaUtils").genHMACPlaintextHash(t);return p(e,n)}function f(e,t){var n=t.map(function(e){return o("MAWMediaUtils").genHMACPlaintextHash(e)});return g(e,n)}function g(e,t){return e.media.where("hashedPlaintextHash").anyOf(t).toArray()}function h(e,t){return t==null?o("MAWDexieTable").dexieResolve():y(e,t).then(function(n){var r=n==null?void 0:n.mediaId;return r!=null?e.media.get({mediaId:r}):e.media.get({objectId:t})})}function y(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.mediaBackup.get({objectId:t})}function C(e,t){if(t==null)return o("MAWDexieTable").dexieResolve();var n=e.mediaBackup.where("msgId").equals(t).toArray();return n}function b(t,n){var a=n.filter(o("MAWDbMsg").isMediaMsg);if(a.length===0)return o("MAWDexieTable").dexieResolve([]);o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[getMsgMediaPairFromMsgs] msgs: ",""])),a.map(function(e){return""+e.msgId}));var i=a.reduce(function(e,t){return t.mediaId==null?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["mediaId is null for media msg with msgId: "," and msg type ",""])),t.msgId,t.type),e):e.set(t.mediaId,t)},new Map),l=Array.from(i.keys());return R(t,l).then(function(e){var t=[];return e.forEach(function(e){if(e==null)throw r("err")("Error missing media");var n=i.get(e.mediaId);if(n==null)throw r("err")("Error missing media");var a=o("MAWMediaUtils").genHMACPlaintextHash(e.plaintextHash);a!==e.hashedPlaintextHash&&(o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[getMsgMediaPairFromMsgs] encountered mismatched hashedPlaintextHash for media. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(e.plaintextHash)),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_MEDIA_MISMATCH_HASHED_PLAINTEXT_HASH,key:"mismatch."+n.type})),t.push([n,e])}),t})}function v(e,t){if(t.length===0)return o("MAWDexieTable").dexieResolve([]);var n=t.filter(o("MAWDbMsg").isMediaMsg).map(function(e){var t=e.mediaId;if(t==null)throw o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["mediaId is null for media msg with msgId: ",""])),e.msgId),r("err")("mediaId is missing");return t});return R(e,n).then(function(e){var t=[];return e.forEach(function(e){e!=null&&t.push(e)}),t})}function S(e,t){if(t.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME||o("MAWDbMsg").isMediaMsg(t)){var n=t.mediaId;return n==null?t.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult()):o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing")):e.media.get(n).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}else return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult())}function R(e,t){return e.media.bulkGet(t)}function L(e,t){var n=t.previewMediaIds!=null?R(e,t.previewMediaIds):o("MAWDexieTable").dexieResolve(),r=t.headerMediaId!=null?e.media.get(t.headerMediaId):o("MAWDexieTable").dexieResolve(),a=t.faviconMediaId!=null?e.media.get(t.faviconMediaId):o("MAWDexieTable").dexieResolve(),i=t.defaultPreviewMediaId!=null?e.media.get(t.defaultPreviewMediaId):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([n,r,a,i]).then(function(e){var n=e[0],r=e[1],a=e[2],i=e[3];if(t.headerMediaId!=null&&r==null||t.faviconMediaId!=null&&a==null||n==null)return o("WAResultOrError").makeError("missing");var l=[];for(var s of n){if(s==null)return o("WAResultOrError").makeError("missing");l.push(s)}return o("WAResultOrError").makeResult({defaultPreview:i,favicon:a,header:r,previews:l})})}function E(e,t,n){var r=babelHelpers.extends({},t,n);return e.media.put(r)}l.maybeGetMediaFromMediaId=d,l.maybeBulkGetMediaFromMediaId=m,l.maybeGetMediaFromHashedPlaintextHash=p,l.maybeGetMediaFromPlaintextHash=_,l.maybeBulkGetMediaFromPlaintextHash=f,l.maybeBulkGetMediaFromHashedPlaintextHash=g,l.maybeGetMediaFromObjectId=h,l.maybeGetMediaBackupRowFromObjectId=y,l.maybeGetMediaBackupRowFromMsgId=C,l.getMsgMediaPairFromMsgs=b,l.getMediaFromMsgs=v,l.getAndCheckMediaFromMsg=S,l.bulkGetMedias=R,l.getMediaForXMA=L,l.updateMedia=E}),98);
__d("MAWDbXMATxns",["MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWJidUtils","MAWXMAUtils","WAResultOrError","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return e.xma.bulkGet(t)}function s(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.xma.get({xmaId:t})}function u(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.xma.where("associatedMessageId").equals(t).first()}function c(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.xma.where("externalId").equals(t.externalId).filter(function(e){return e.author===t.author&&e.threadJid===t.chat}).first()}function d(e,t){return c(e,t).then(function(t){return t==null?o("WAResultOrError").makeError("missing"):o("MAWDexieTable").dexieAll([o("MAWDbMediaTxns").getMediaForXMA(e,t),o("MAWDbMsgTxns").maybeGetMsg(e,t.associatedMessageId)]).then(function(e){var n=e[0],r=e[1];if(!n.success)return o("WAResultOrError").makeError("missing");var a=n.value,i=a.defaultPreview,l=a.favicon,s=a.header,u=a.previews;return o("WAResultOrError").makeResult({associatedMessage:r,defaultPreview:i,favicon:l,header:s,previews:u,xma:t})})})}function m(e,t){return u(e,t).then(function(t){if(t!=null)return o("MAWDbMsgTxns").maybeGetMsg(e,t.msgId)})}function p(e,t){if(t.length===0)return o("MAWDexieTable").dexieResolve([]);var n=t.filter(o("MAWDbMsg").isXMAMsg).map(function(e){return o("MAWJidUtils").maybeToProtocolMsgId(e.author,e.threadJid,e.externalId)}).filter(Boolean),r=n.map(function(t){return c(e,t)});return o("MAWDexieTable").dexieAll(r).then(function(e){return e.filter(Boolean)})}function _(e,t){return e.xma.where("associatedMessageId").anyOf(t).toArray().then(function(e){var t=e.filter(function(e){return e.msgId!=null&&r("gkx")("9841")?e.targetType!=null:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(e.targetType)});return t.reduce(function(e,t){return t.associatedMessageId!=null&&t.msgId!=null?e.set(t.associatedMessageId,t.msgId):e},new Map)})}function f(e,t){return e.xma.where("associatedMessageId").equals(t).first()}function g(e,t){return e.xma.where("associatedMessageId").equals(t).first().then(function(t){if(t!=null){var n=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.externalId);if(n!=null)return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,n)}})}function h(e,t){return f(e,t).then(function(t){return t==null?o("WAResultOrError").makeResult():o("MAWDexieTable").dexieAll([o("MAWDbMediaTxns").getMediaForXMA(e,t),o("MAWDbMsgTxns").maybeGetMsg(e,t.associatedMessageId)]).then(function(e){var n=e[0],r=e[1];if(!n.success)return o("WAResultOrError").makeError("missing");var a=n.value,i=a.defaultPreview,l=a.favicon,s=a.header,u=a.previews;return o("WAResultOrError").makeResult({associatedMessage:r,defaultPreview:i,favicon:l,header:s,previews:u,xma:t})})})}function y(e,t,n){return o("MAWDbThreadTxns").getThread(e,n).then(function(n){if(n.success){var r=n.value;if(t==null)return o("MAWDexieTable").dexieResolve();var a={author:t.author,chat:r.jid,externalId:t.externalId};return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,a)}})}function C(e,t){return c(e,t).then(function(t){if(t==null)return o("MAWDexieTable").dexieResolve();if(!o("MAWXMAUtils").isXMAStoryReply(t.targetType))return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t.defaultPreviewMediaId).then(function(n){return n==null?{hasMedia:!1,xma:t}:o("MAWDexieTable").dexieAll([n,o("MAWDbChunkTxns").hasMediaChunk(e,n.hashedPlaintextHash)]).then(function(e){var n=e[0],r=e[1];return{hasMedia:r,previewMedia:n,xma:t}})})})}function b(e,t){return e.xma.where("externalId").anyOf(t).toArray()}l.bulkGetXMAs=e,l.maybeGetXMAFromXMAId=s,l.maybeGetXMAFromAssociatedMsgId=u,l.maybeGetXMAFromProtocolMsgId=c,l.maybeGetXMAPayloadFromProtocolMsgId=d,l.getDbXMAMsgFromAssociatedMsgId=m,l.getXMAFromMsgs=p,l.getXMAMsgIdsFromAssociatedMsgIds=_,l.maybeGetDbXMAMsgByAssociatedMsgId=g,l.maybeGetXMAPayloadFromAssociatedMsgId=h,l.maybeGetAssociatedXMAMsg=y,l.maybeGetXMAAndDefaultPreviewMediaFromProtocolMsg=C,l.getMultipleXMAByExternalId=b}),98);
__d("MAWGetOrCreateThreadTxns",["MAWAdminMsgTxns","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWQplProxy","MAWThreadMappingQPL","MAWWriteBulkWriteIncomingAdminMsgTxns","WATimeUtils","getErrorSafe","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(e!=null&&t!=null){var n=o("WATimeUtils").fromMillisTime(e),r=o("WATimeUtils").fromMillisTime(t);return o("WATimeUtils").castToMillisTime(Math.max(n,r))}return e!=null?e:t}function s(e,t){return e.threads.get({jid:t})}function u(e,t){return(r("gkx")("10029")?o("MAWDexieTable").dexieAll(t.map(function(t){return e.threads.get({jid:t})})).then(function(e){return e.filter(Boolean)}):e.threads.where("jid").anyOf(t).toArray()).then(function(e){var n=new Map;for(var r of e)n.set(r.jid,r);return t.map(function(e){return n.get(e)})})}function c(e,t,n){var a=t.instanceKey,i=t.jid;return o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"get_or_create_thread_start",{instanceKey:a}),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_start",{instanceKey:n}),s(e,i).then(function(a){return a==null?(n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"create-1-1-thread-start",{instanceKey:n}),p(e,t,n).then(function(e){return{created:!0,thread:e}})):g(e,t,a).then(function(e){return{created:!1,thread:e}})}).then(function(e){return o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"get_or_create_thread_end",{instanceKey:a}),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_end",{instanceKey:n}),e})}function d(e,t,n){var r=n===void 0?{}:n,a=r.logState;return u(e,t.map(function(e){var t=e.jid;return t})).then(function(n){a==null||a("threadMapping2FetchedThreads");var r={},i=[],l=[];for(var s of n.entries()){var u=s[0],c=s[1];c==null?i.push(t[u]):l.push({params:t[u],thread:c})}return o("MAWDexieTable").dexieAll([i.length?_(e,i):o("MAWDexieTable").dexieResolve([]),l.length?h(e,l):o("MAWDexieTable").dexieResolve([])]).then(function(e){var n=e[0],o=e[1];a==null||a("threadMapping3ThreadsUpdated");for(var i of n){var l=i.adminMsgParams,s=i.thread;r[s.jid]={adminMsgParams:l,created:!0,thread:s}}for(var u of o)r[u.jid]={adminMsgParams:null,created:!1,thread:u};return t.map(function(e){var t=e.jid;return r[t]})})})}function m(e){var t,n=e.authoritativeThreadKey,r=e.clientThreadKey,a=e.createTs,i=e.deduplicationKey,l=e.folder,s=e.jid,u=e.lastActivityTimestamp,c=o("WATimeUtils").millisTime(),d=(t=u!=null?u:a)!=null?t:c,m={authoritativeThreadKey:n!=null?n:void 0,deduplicationKey:i,folder:l!=null?l:o("MAWFolderTypes").FOLDER_ID.INBOX,jid:s,lastReadMsg:null,lastReadMsgReceiptSent:null,newestMsgTs:d,oldestMsg:null,optimisticThreadKey:r!=null?r:void 0,threadOrder:o("MAWDbThread").craftThreadOrder(d,s)};return m}function p(e,t,n){var a=t.authoritativeThreadKey,i=t.description,l=t.instanceKey,s=t.skipVerifyThread,u=m(t);return e.threads.add(u).then(function(t){var c=babelHelpers.extends({},u,{chatId:t});return s!==!0&&(l!=null&&o("MAWThreadMappingQPL").addPoint("create_thread_verify_thread_exists",l),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(c,c.optimisticThreadKey,a,i,l)})),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-e2ee-admin-msg-in-new-thread",{instanceKey:n}),o("MAWAdminMsgTxns").writeE2EEThreadDescriptionMsg(e,c,n)}).catch(function(e){var t=r("getErrorSafe")(e);throw l!=null&&o("MAWThreadMappingQPL").endFailureInWorker("create_thread_failed",l,{string:{createThreadFailureReason:t.message}}),t.message="Error creating thread: "+t.message,t})}function _(e,t){var n=t.map(m);return e.threads.bulkAdd(n,{allKeys:!0}).then(function(r){var a=r.map(function(e,r){return{data:babelHelpers.extends({},n[r],{chatId:e}),params:t[r]}});for(var i of a)i.params.skipVerifyThread!==!0&&(i.params.instanceKey!=null&&o("MAWThreadMappingQPL").addPoint("bulk_create_thread_verify_thread_exists",i.params.instanceKey),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(i.data,i.data.optimisticThreadKey,i.params.authoritativeThreadKey,i.params.description,i.params.instanceKey)}));return o("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns(e,a.map(function(e){return e.data}))}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error bulk creating threads: "+t.message,t})}function f(t,n,r){var o=n.authoritativeThreadKey,a=n.clientThreadKey,i=n.deduplicationKey,l=n.folder,s=n.lastActivityTimestamp,u={authoritativeThreadKey:o!=null?o:t.authoritativeThreadKey,cannotReplyReason:l!=null||a!=null?null:t.cannotReplyReason,deduplicationKey:l!=null||a!=null?i:t.deduplicationKey,folder:l!=null?l:t.folder,newestMsgTs:e(r,s),optimisticThreadKey:a!=null?a:t.optimisticThreadKey};return babelHelpers.extends({},t,u)}function g(e,t,n){var a=t.authoritativeThreadKey,i=t.description,l=t.instanceKey,s=t.skipVerifyThread;return o("MAWDbMsgTxns").getThreadNewestMessageMs(e,n.jid).then(function(u){var c=f(n,t,u);return e.threads.update(n.chatId,c).then(function(){var e;return s!==!0&&(l!=null&&o("MAWThreadMappingQPL").addPoint("update_thread_verify_thread_exists",l),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(c,c.optimisticThreadKey,a,i,l)})),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:(e=c==null?void 0:c.folder)!=null?e:o("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:c.jid})}),c}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error updating thread: "+t.message,t})})}function h(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.params,r=t.thread;return o("MAWDbMsgTxns").getThreadNewestMessageMs(e,r.jid).then(function(e){var t=f(r,n,e);return{params:n,thread:t}})})).then(function(t){return e.threads.bulkUpdate(t.map(function(e){var t=e.thread;return{changes:t,key:t.chatId}})).then(function(){for(var e of t){var n=e.params,r=n.authoritativeThreadKey,a=n.description,i=n.instanceKey,l=n.skipVerifyThread,s=e.thread;l!==!0&&(i!=null&&o("MAWThreadMappingQPL").addPoint("bulk_update_thread_verify_thread_exists",i),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(s,s.optimisticThreadKey,r,a,i)}))}return t.map(function(e){var t=e.thread;return t})})}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error bulk updating threads: "+t.message,t})}l.getExistingThread=s,l.bulkGetExistingThread=u,l.getOrCreateThread=c,l.bulkGetOrCreateThread=d,l.createThread=p,l.prepareUpdatedThreadData=f}),98);
__d("MAWLocalizationUtils",["MAWAckLevel","MAWLocalizationType","MAWMsgType","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new Set([(e=o("MAWLocalizationType")).LOCALIZATION_TYPE.CURRENT_USER_CREATED_POLL,e.LOCALIZATION_TYPE.PARTICIPANT_CREATED_POLL,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_OPTION,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_OPTION,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_OPTIONS,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_OPTIONS,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_VOTE,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_VOTE,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.CURRENT_USER_REMOVED_POLL_VOTE,e.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_POLL_VOTE,e.LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.CURRENT_USER_MIXED_POLL_UPDATE,e.LOCALIZATION_TYPE.PARTICIPANT_MIXED_POLL_UPDATE,e.LOCALIZATION_TYPE.CURRENT_USER_CHANGED_POLL_VOTE,e.LOCALIZATION_TYPE.PARTICIPANT_CHANGED_POLL_VOTE,e.LOCALIZATION_TYPE.CURRENT_USER_CHANGED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.PARTICIPANT_CHANGED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.POLL_UNSENT_UPDATE]);function u(e,t,n,r,a,i){return{ack:o("MAWAckLevel").ACK.sent,altIndex:a!=null?a:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:n,msgContent:e,sortOrderMs:i,threadJid:t,ts:r!=null?r:o("WATimeUtils").unixTime(),type:o("MAWMsgType").MSG_TYPE.ADMIN}}function c(e){if(s.has(e))return!0;switch(e){case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_NAMED_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_NAMED_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_NAMED_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SELF_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_PROMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_DEMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_GOT_PROMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_GOT_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_GOT_PROMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_GOT_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SELF_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_HOTLIKE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_THEME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_PHOTO:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_PINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UNPINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_HOTLIKE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_THEME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PHOTO:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UNPINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PARTICIPANT_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_PARTICIPANT_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_CURRENT_USER_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CLEAR_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CLEAR_PARTICIPANT_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_CURRENT_USER_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_MINUTES:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_MINUTES:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_HOURS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_HOURS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_DAYS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_DAYS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_OFF:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_SECONDS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_SECONDS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_TAKE_SCREENSHOT:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_RECORD_SCREEN:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ADMIN_ONLY:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ALL_MEMBERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ADMIN_ONLY:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ALL_MEMBERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ADMIN_ONLY:case o("MAWLocalizationType").LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ALL_MEMBERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_UK_OSA_ADMIN_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_LIMIT_SHARING_DISABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_LIMIT_SHARING_ENABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LIMIT_SHARING_DISABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LIMIT_SHARING_ENABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE_OTHER_USER_NAME_UNKNOWN:case o("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE_SELF_THREAD:case o("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE_WITH_OTHER_USER_NAME:return!0}return!1}function d(e){switch(e){case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE:return!0}return!1}function m(e){switch(e){case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_MORE_THAN_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU_AND_MORE_THAN_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP:return!0}return!1}l.POLL_ADMIN_MSG_TYPES=s,l.buildUnstoredDbAdminMsg=u,l.isAdminMsgNormalized=c,l.isDeviceChangeAdminMsg=d,l.isParticipantChangeAdminMsg=m}),98);
__d("MAWAdminMsgTxns",["MAWDbMsg","MAWDbThread","MAWDbThreadTxns","MAWExternalId","MAWLocalizationType","MAWLocalizationUtils","MAWTimeUtils","MAWWriteBulkWriteIncomingAdminMsgTxns","MAWWriteMsgTxns","WALogger","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){var r=e.ts,a=o("WATimeUtils").castUnixTimeToMillisTime(r),i=o("MAWTimeUtils").ensureValidMillisTime(n)||o("WATimeUtils").castToMillisTime(0),l=a>i?a:i;return babelHelpers.extends({},t,{newestMsgTs:l,oldestMsg:e.msgId,snippetMsg:e.msgId,snippetMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(e)),threadOrder:o("MAWDbThread").craftThreadOrder(l,t.jid)})}function u(t,n){return o("MAWDbThreadTxns").getThread(t,n).then(function(n){if(!n.success){o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["writeReachabilityErrorAdminMsg failed to create or get 1:1 thread"])));return}var a=n.value,i=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR,version:0},a.jid,o("MAWExternalId").generateExternalId(),o("WATimeUtils").castMillisTimeToUnixTime(o("WATimeUtils").millisTime()));return o("MAWWriteMsgTxns").writeMsg(t,i,a).then(r("emptyFunction"))})}function c(e,t,n){return o("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns(e,[t],n).then(function(e){var t=e[0];return t})}function d(e){var t=o("MAWDbMsg").craftE2eeAdminMsgAltIndex(e.chatId),n=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION,version:0},e.jid,o("MAWExternalId").generateExternalId(),o("WATimeUtils").castToUnixTime(0),t);return babelHelpers.extends({},n,{msgId:o("MAWDbMsg").craftMsgIdV2(e.chatId,1,n),sortOrderMs:0})}l.getUpdatedThreadForAdminMsg=s,l.writeReachabilityErrorAdminMsg=u,l.writeE2EEThreadDescriptionMsg=c,l.buildE2EEThreadDescriptionMsg=d}),98);
__d("MAWBridgeTrace",["WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a,i,l,s){var u=e.ack,c=e.externalId,d=e.ts,m=e.type,p=o("WAJids").switchOnMsgrChatJidType(t,{group:function(t){return"Group"},user:function(t){return"User"}});return{ack:u,externalId:c,isFirstMsg:!!a,openMessageOtid:r,openMessageParticipantCount:i,participantCount:l,threadJid:t,threadKey:s,threadType:p,traceType:n,ts:d,type_:m}}function s(e,t,n){return{traceContext:n,traceId:t,traceType:e}}function u(e,t,n,r){return{errorMessage:r,event:t,externalIds:e,traceType:n}}function c(e,t,n,r,o,a){return{checkPointId:e,dataTraceId:t,errorMessage:n,shouldFlush:r,syncChannel:o,tags:a}}l.createBridgeStartTraceData=e,l.createBridgeStartTraceWithTraceIdData=s,l.createBridgeUpdateTraceData=u,l.createBridgeTraceRecordCheckpointData=c}),98);
__d("MAWAfterWriteMsgUtil",["$InternalEnum","ArmadilloDataTraceType","MAWBridgeMsg","MAWBridgeTrace","MAWDbMsg","MAWIndexedDb","MAWXMAUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum").Mirrored(["DO_NOT_BUMP_THREAD","BUMP_LOCAL_ONLY","BUMP_LOCAL_AND_SERVER"]);function s(e){var t=e.dbMsg,n=e.isFirstMsg,r=e.openMessageOtid,a=e.openMessageParticipantCount,i=e.participantCount,l=e.quotedReplyAttachmentMeta,s=e.updatedThread,u=s.authoritativeThreadKey,c=s.jid;t.altIndex===o("MAWDbMsg").SPAM_ALT_INDEX||t.altIndex===o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX||(o("MAWIndexedDb").afterTransaction({tag:"StartTrace",value:o("MAWBridgeTrace").createBridgeStartTraceData(t,c,o("ArmadilloDataTraceType").armadilloMessageSend,r,n,a,i,u)}),o("MAWXMAUtils").isXMAStoryReply(t.xmaMessageType)||o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(t,l)}))}l.WriteMsgAfterTxnBumpThreadOption=e,l.writeMsgAfterTransaction=s}),98);
__d("MAWWriteBulkWriteIncomingAdminMsgTxns",["MAWAdminMsgTxns","MAWAfterWriteMsgUtil","MAWDbMsgTxns","MAWDexieTable","MAWQplProxy","WALogger","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n){var r=[],a=[],i=[],l=new Map,s=new Map,u=n.map(function(e){return o("MAWDbMsgTxns").getThreadOldestMessageId(t,e.jid).then(function(t){return l.set(e.jid,t)})}),c=n.map(function(e){return o("MAWDbMsgTxns").getThreadNewestMessageMs(t,e.jid).then(function(t){return s.set(e.jid,t)})});return o("MAWDexieTable").dexieAll([u,c]).then(function(){return n.forEach(function(t){t==null&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["OfflineBulkWriteAdminmsg - Missing thread when write e2ee thread description"])));var n=o("MAWAdminMsgTxns").buildE2EEThreadDescriptionMsg(t),l=o("MAWAdminMsgTxns").getUpdatedThreadForAdminMsg(n,t,s.get(t.jid));r.push(n),i.push(l),a.push({dbMsg:n,isFirstMsg:!1,updatedThread:l})}),{afterTransactionSyncMsgsData:a,e2eeThreadAdminMsgs:r,threadsToUpdate:i}})}function u(e,t,n){return d(e,t,n).then(function(e){var t=e.afterTransactionSyncMsgsData,n=e.threadsToUpdate,r=new Map;return t.forEach(function(e){var t=e.updatedThread.jid;r.set(t,{externalId:e.dbMsg.externalId,msgId:e.dbMsg.msgId})}),n.map(function(e){return{adminMsgParams:r.get(e.jid),thread:e}})})}function c(e,t,n){return d(e,t,n).then(function(e){var t=e.afterTransactionSyncMsgsData,n=e.threadsToUpdate;return t.forEach(function(e){return o("MAWAfterWriteMsgUtil").writeMsgAfterTransaction(e)}),n})}function d(e,t,n){return s(e,t).then(function(t){var a=t.afterTransactionSyncMsgsData,i=t.e2eeThreadAdminMsgs,l=t.threadsToUpdate;return n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-start",{instanceKey:n}),o("MAWDexieTable").dexieAll([e.messages.bulkAdd(i),e.threads.bulkPut(l)]).then(function(){return n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-end",{instanceKey:n}),{afterTransactionSyncMsgsData:a,threadsToUpdate:l}})})}l.writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns=u,l.writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns=c}),98);
__d("MAWBuildIncomingMsgs",["MAWAckLevel","MAWDbMsg","MAWMsgType","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=6*o("WATimeUtils").HOUR_SECONDS;function s(e,t){var n=e.author,r=e.externalId;return{ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:n,externalId:r,serverTs:t,ts:t,type:o("MAWMsgType").MSG_TYPE.CIPHERTEXT}}function u(e,t){var n=e.author,r=e.externalId;return{ack:o("MAWAckLevel").ACK.failed,altIndex:void 0,author:n,externalId:r,serverTs:t,ts:t,type:o("MAWMsgType").MSG_TYPE.UNAVAILABLE}}function c(t,n){var r;return{ack:t.ack,author:t.author,externalId:t.externalId,messageDeleteForMeTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e),msgContent:(r=o("MAWDbMsg").getMsgContent(t))==null?void 0:r.content,threadJid:n.jid,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME}}function d(t,n,r){return{ack:t.ack,altIndex:void 0,author:t.author,externalId:r.externalId,msgContent:o("MAWDbMsg").getMsgContent(t),originalTs:t.ts,revokedExternalId:r.revokedExternalId,threadJid:n.jid,ts:r.ts,type:o("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e)}}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=e,l.buildUnstoredCiphertextMsg=s,l.buildUnstoredUnavailableMsg=u,l.buildUnstoredDeleteForMeMsg=c,l.buildUnstoredRevokedMsg=d}),98);
__d("MAWDbEditMsgHistoryTxns",["MAWAckLevel","MAWDbEditMsgHistory","MAWDexieTable","MAWVault","MWFBLogger","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MWFBLogger").MWLogger().tags(["maw_db","txn","MAWDbEditMsgHistoryTxns"]);function m(t,n){var r=[];if(n.length===0)return o("MAWDexieTable").dexieResolve(r);var a=n.filter(function(e){return e.editCount!=null&&e.editCount>0}),i=a.map(function(e){return[e.externalId,e.threadJid]});if(i.length===0)return o("MAWDexieTable").dexieResolve([]);var l=a.reduce(function(e,t){return t.msgId!=null&&e.set(t.externalId,t.msgId),e},new Map),u=a.reduce(function(e,t){return t.msgId!=null&&e.set(t.externalId,t),e},new Map);return p(t,i).then(function(t){if(t.length===0)return d.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["No edit history found for the messages despite there being an editCount greater than 0"]))),[];for(var n of t){var a=l.get(n.originalMsgExternalId);a!=null&&r.push(babelHelpers.extends({},n,{editMsgHistoryId:o("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(n.editMsgHistoryId),originalMsgId:a}));var i=u.get(n.originalMsgExternalId);i!=null&&n.threadJid!==i.threadJid&&d.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Edit history threadJid does not match original message threadJid"])))}return r})}function p(e,t){return e.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(t).toArray()}function _(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.editMsgHistory.get({editMsgHistoryId:t})}function f(e,t,n){return e.editMsgHistory.where("originalMsgExternalId").equals(n).filter(function(e){return e.editExternalId===t.externalId&&e.author===t.author&&e.threadJid===t.chat}).toArray().then(function(e){if(e.length>1){var t=e.map(function(e){return""+e.editTs.toString()}),n=new Set(t).size===1;n?d.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Suspected multiple instances of same message!"]))):d.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Can't have "," messages with the same editExternalId!"])),e.length)}return e[0]})}function g(e,t){return t==null?o("MAWDexieTable").dexieResolve([]):e.editMsgHistory.where("originalMsgExternalId").equals(t.externalId).filter(function(e){return e.author===t.author&&e.threadJid===t.chat}).toArray().then(function(e){var t=[];return e.forEach(function(e){e!=null&&t.push(e)}),t})}function h(e,t){return e.editMsgHistory.bulkGet(t)}function y(e,t){return e.editMsgHistory.bulkAdd(t,{allKeys:!0}).then(function(e){return o("MAWDexieTable").dexieResolve(e)})}function C(e,t,n,r){return r.then(function(r){return b(e,t,n,r)})}function b(e,t,n,r){var a=[];return e.editMsgHistory.where("originalMsgExternalId").equals(t).filter(function(e){return e.threadJid===r&&e.author===n&&(e.sendStatus==null||e.sendStatus>=o("MAWAckLevel").ACK.sent)}).toArray().then(function(e){return e.forEach(function(e){a.push({messageId:e.editExternalId,originalMessageId:e.originalMsgExternalId,text:o("MAWVault").unvault(e.msgContent.content),timestamp:e.editTs})}),a})}function v(e,t,n,o){return e.editMsgHistory.where("originalMsgExternalId").equals(t).filter(function(e){return e.threadJid===o&&e.author===n}).delete().then(r("emptyFunction"))}var S=function(t,n){return t.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(n).delete().then(function(){return o("MAWDexieTable").dexieResolve(n.length)})};function R(e,t,n){return e.editMsgHistory.put(babelHelpers.extends({},t,{msgContent:n.msgContent})).then(function(){})}l.loadEditMsgHistory=m,l.getEditHistoryByOriginalMsgExternalIdAndThreadJid=p,l.maybeGetEditMsgHistoryFromEditMsgHistoryId=_,l.getEditHistoryMsgByEditedProtocolMsgId=f,l.maybeGetEditMsgHistoryFromProtocolMsgId=g,l.bulkGetEditMsgHistorys=h,l.bulkAddEditMsgHistory=y,l.getEditHistoryAsEchoWithJidPromise=C,l.getEditHistoryAsEcho=b,l.bulkRemoveEditHistory=v,l.deleteExpiredEditMsgHistory=S,l.updateEditMsgHistoryWithNewIncomingMsg=R}),98);
__d("MAWDbPendingStanza",["WAAssertUnreachable"],(function(t,n,r,o,a,i,l){"use strict";var e="revoked",s="deleteForMe",u="deleteThread",c="Revoked",d="DeleteForMe",m="DeleteThread",p={DELETE_FOR_ME:d,DELETE_THREAD:m,REVOKED:c};function _(t){switch(t){case"Revoked":return e;case"DeleteForMe":return s;case"DeleteThread":return u;default:return r("WAAssertUnreachable")(t)}}l.PENDING_REVOKED=e,l.PENDING_DELETE_FOR_ME=s,l.REVOKED=c,l.DELETE_FOR_ME=d,l.PENDING_TYPE=p,l.getPendingSuffix=_}),98);
__d("MAWDeleteThreadUtil",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=[];if(e.forEach(function(e){if(e.pendingContent.type==="DeleteThread"){var n=e.pendingContent.content.metaSyncMessageRange.lastMessageTimestamp;n!=null&&t.push(n)}}),t.length===0)return null;t.sort(function(e,t){return t-e});var n=t[0];return{lastMessageTimestamp:n}}function l(e,t){return t!=null&&t.lastMessageTimestamp>=e}i.getLatestDeleteThreadInfo=e,i.isMsgDeletedViaDeleteThread=l}),66);
__d("MAWMsgCleaner",["MAWLoggerUtils","MWFBLogger","Promise","WAAssertUnreachable","WAShiftTimer","WATimeUtils","WorkerScheduler","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="Unsend",m="Ephemeral",p="DeleteForMe",_="PendingStanza",f="Xma",g="IGDDM",h="Quote",y=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerUpdate]),C={DELETE_FOR_ME:p,EPHEMERAL:m,IGDDM:g,PENDING_STANZA:_,QUOTE:h,UNSEND:d,XMA:f},b;function v(){return b==null&&(b=o("WorkerScheduler").makeScheduler("cleaner",{concurrency:1,maxTaskLimit:1,maxThrottleMs:8e3})),b}var S=(function(){function t(e,t){var n=this;this.$1=new(o("WAShiftTimer")).ShiftTimer(function(){r("promiseDone")(n.$2())}),this.getNextTs=e.getNextTs,this.removeExpired=e.removeExpired,this.cleanerType=t,this.purgeEnabled=e.purgeEnabled,this.$1.forceRunNow()}var a=t.prototype;return a.update=function(n){var t=R(this.cleanerType);y.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["","::update ",""])),t,n),this.$1.onOrBefore(o("WATimeUtils").cappedMillisecondsUntil(n))},a.$2=function(){var e=this,t=function(){if(!e.purgeEnabled())return(c||(c=n("Promise"))).resolve();var t=R(e.cleanerType);return y.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow"])),t),e.removeExpired().then(function(n){return n>0&&y.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow "," msgs' content cleaned"])),t,n),e.getNextTs()}).then(function(t){t!=null&&e.update(t)})};return this.$3!=null?(c||(c=n("Promise"))).resolve():(this.$3=v().task({fn:t,name:this.cleanerType,priority:o("WorkerScheduler").BACKGROUND_PRIORITY}),this.$3.run().finally(function(){e.$3=null}))},t})();function R(e){switch(e){case"Unsend":return"UnsendMsgCleaner";case"Ephemeral":return"EphemeralCleaner";case"DeleteForMe":return"DeleteForMeCleaner";case"PendingStanza":return"PendingStanzaCleaner";case"Xma":return"XmaCleaner";case"IGDDM":return"IGDDisappearingMsgCleaner";case"Quote":return"QuoteCleaner";default:return r("WAAssertUnreachable")(e)}}var L=S;l.CLEANER_TYPE=C,l.MsgCleaner=S,l.MSG_CLEANER_FOR_TESTING_ONLY=L}),98);
__d("MAWPendingStanzaCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.PENDING_STANZA))}function d(t){if(u==null){var n="Trying to add new PendingStanzaCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["PendingStanzaCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startPendingStanzaCleaner=c,l.addNewPendingStanzaCleanerTimestamp=d,l.getPendingStanzaCleaner_FOR_TESTING_ONLY=m,l.resetPendingStanzaCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWDbPendingStanzaTxns",["MAWDbPendingStanza","MAWDeleteThreadUtil","MAWPendingStanzaCleaner","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a){var i=o("MAWDbPendingStanza").getPendingSuffix(a);return e.pendingStanzas.where("externalIdWithType").equals(t+"_"+i).filter(function(e){var t=e.pendingContent;return t.type===a&&t.content.author===n&&t.content.threadJid===r}).first()}function s(t,n,r,a){return e(t,n,r,a,o("MAWDbPendingStanza").PENDING_TYPE.REVOKED)}function u(t,n,r,a){return e(t,n,r,a,o("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)}function c(e,t){var n=t.map(function(e){var t=e.expirationInSeconds;return o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+t)}),a=t.map(function(e,t){var r=e.content,a=e.externalId,i=e.pendingStanzaType;return{deleteTs:n[t],externalIdWithType:a+"_"+o("MAWDbPendingStanza").getPendingSuffix(i),pendingContent:r}});return e.pendingStanzas.bulkAdd(a).then(function(){return n.forEach(o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp)}).then(r("emptyFunction"))}function d(e,t,n,r,a){var i=o("MAWDbPendingStanza").getPendingSuffix(a),l=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+n),s={deleteTs:l,externalIdWithType:r+"_"+i,pendingContent:t};return e.pendingStanzas.add(s).then(function(){o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(l)})}function m(e,t){var n=o("MAWDbPendingStanza").getPendingSuffix(o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);return e.pendingStanzas.where("externalIdWithType").equals(t+"_"+n).toArray().then(function(e){return o("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(e)})}function p(e){return e.pendingStanzas.toArray()}function _(e,t){var n=t.map(function(e){return e.rowId});return e.pendingStanzas.bulkDelete(n)}function f(e){var t,n;return(e==null||(t=e.pendingContent)==null?void 0:t.type)===o("MAWDbPendingStanza").PENDING_TYPE.REVOKED?e==null||(n=e.pendingContent)==null?void 0:n.content:null}function g(e,t){var n=o("MAWDbPendingStanza").getPendingSuffix(o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD),r=t.map(function(e){return e+"_"+n});return e.pendingStanzas.where("externalIdWithType").anyOf(r).toArray().then(function(e){var t=e.reduce(function(e,t){var n=e.get(t.externalIdWithType);return n==null?e.set(t.externalIdWithType,[t]):n.push(t),e},new Map),n=new Map;return t.forEach(function(e,t){var r=o("WAJids").unsafeCoerceToChatJid(t.split("_")[0]),a=o("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(e);a!=null&&n.set(r,a)}),n})}l.maybeGetPendingStanzaByExternalId=e,l.maybeGetPendingRevokedStanza=s,l.maybeGetPendingDeletedStanza=u,l.bulkPutPendingStanzas=c,l.putPendingStanza=d,l.maybeGetDeleteThreadFromPendingStanza=m,l.getAllPendingStanzas=p,l.deletePendingStanzas=_,l.getRevokedContent=f,l.bulkGetDeleteThreadPendingStanzas=g}),98);
__d("MAWAuthor",["MAWUserJidWrapper","WAJids","isStringNullOrEmpty"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){if(t==null||t===o("WAJids").AUTHOR_SYSTEM)return null;if(o("WAJids").isAuthorMe(t))return o("MAWUserJidWrapper").getMyUserJid();var e=o("WAJids").authorAsUserJid(t);return e==null||r("isStringNullOrEmpty")(o("WAJids").userIdFromJid(e))?null:o("WAJids").authorAsUserJid(t)};l.getAuthorUserJid=e}),98);
__d("MAWDbReactionsTxns",["FBLogger","MAWAuthor","MAWBridgeTypesCreators","MAWDbMsg","MAWDexieTable","MAWIndexedDb","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=function(t){return t};function d(e,t){return e.reactions.put(c(t))}function m(t,n){return t.reactions.delete(n.rowId).then(function(){var t=n.author,r=n.reactionId,a=n.reactToMsgId,i=n.threadJid;a!=null&&(o("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:o("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:t,chatJid:i,reactToMsgId:a})}),o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted reaction with id : ","."])),r))})}function p(e,t){var n=o("MAWAuthor").getAuthorUserJid(t.author);return e.reactions.where("reactToExternalId").equals(t.externalId).filter(function(e){return(e.reactToAuthor===n||e.reactToAuthor===t.author)&&e.threadJid===t.chat}).toArray()}function _(e,t){var n=t.reduce(function(e,t){return e.set(t.msgId,t),e},new Map);return e.reactions.where("reactToMsgId").anyOf(t.map(function(e){return e.msgId})).toArray().then(function(e){var t=e.filter(function(e){var t,r=e.reactToExternalId,o=e.reactToMsgId;return o!=null&&r===((t=n.get(o))==null?void 0:t.externalId)});return t.length<e.length&&r("FBLogger")("messenger_web").mustfix("Reactions query by reactToMsgId returns reactions with mismatching externalId"),t})}function f(e,t){return e.reactions.where("reactToMsgId").equals(t.msgId).toArray().then(function(e){var n=e.filter(function(e){var n=e.reactToExternalId;return n===t.externalId});return n.length<e.length&&r("FBLogger")("messenger_web").mustfix("Reactions query by reactToMsgId returns reactions with mismatching externalId"),n})}function g(e,t){return _(e,[t])}function h(e,t){var n=t.author,r=t.chat,o=t.externalId;return e.reactions.where("externalId").equals(o).filter(function(e){return e.author===n&&e.threadJid===r}).first()}function y(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.author,r=t.externalId,a=o("MAWAuthor").getAuthorUserJid(n);return e.reactions.where("reactToExternalId").equals(r).filter(function(e){return o("MAWAuthor").getAuthorUserJid(e.reactToAuthor)===a}).toArray()})).then(function(t){var n=t.flat();if(n.forEach(function(e){var t=e.author,n=e.reactToMsgId,r=e.threadJid;n!=null&&o("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:o("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:t,chatJid:r,reactToMsgId:n})})}),n.length!==0)return o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," reactions rows."])),n.length),e.reactions.bulkDelete(n.map(function(e){return e.rowId}))})}function C(e,t){return e.reactions.where("reactToMsgId").anyOf(t.map(function(e){return e.msgId})).delete().then(function(e){o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Deleted "," reactions"])),e)})}function b(e,t){return e.reactions.where("reactionId").between(o("MAWDbMsg").msgIdsInChatLowerBound(t.chatId),o("MAWDbMsg").msgIdsInChatUpperBound(t.chatId)).last().then(function(e){var t=e==null?0:o("MAWDbMsg").getInChatMsgIdFromMsgId(e.reactionId);return t+1})}function v(e,t,n,r,a,i,l){var s,u,c=(s=r==null?void 0:r.ts)!=null?s:o("WATimeUtils").unixTime();return e.reactions.where(["threadJid","ts"]).between([t,(u=o("WATimeUtils").castMillisTimeToUnixTime(n))!=null?u:o("WATimeUtils").castToUnixTime(0)],[t,c],!0,a).reverse().filter(l).limit(i).toArray()}l.coerceToReaction=c,l.putReaction=d,l.deleteReaction=m,l.getReactionForEcho=p,l.getReactionsFromMessages=_,l.getReactionsForMessage=f,l.getReactionsFromMessage=g,l.maybeGetReactionByProtocolMsgId=h,l.deleteReactionsByUniqueMsgIdentifiers=y,l.deleteAllReactionsForMessages=C,l.getNextReactionIdNumberForThread=b,l.fetchReactionsFromDbWithTimestamp=v}),98);
__d("MAWDeleteForMeMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.DELETE_FOR_ME))}function d(t){if(u==null){var n="Trying to add new DeleteForMeContentCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["DeleteForMeMsgContentCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startDeleteForMeMsgContentCleaner=c,l.addNewDeleteForMeMsgContentCleanerTimestamp=d,l.getDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=m,l.resetDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWBridgeMsgCountdown",["MAWDbMsg","MAWLoggerUtils","MWFBLogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("MWFBLogger").MWLogger().tags(["bridge",o("MAWLoggerUtils").Tag.Countdown]);function c(t){return{msgs:t.map(function(t){var n,r=t.messageExpirationTs,a=(n=t.ephemeralSetting)==null?void 0:n.ephemeralExpirationInSec;if(!(r==null||a==null)){var i=o("WATimeUtils").cappedMillisecondsUntil(r);if(i<=0){u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Calling the messages starting countdown bridge event with remaning time less or equal to 0 (expired message)"])));return}var l=a*1e3;return i>l&&(i=l),u.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["createBridgeMsgsStartCountdown: msg ",", expiration ",", ms until countdown ",", duration ",""])),t.msgId,r,i,a),{countdownTs:r,millisecondsUntilCountdownTs:i,msgId:t.msgId,threadJid:t.threadJid,ts:o("MAWDbMsg").getCanonicalTsFromMsg(t)}}}).filter(Boolean)}}function d(e,t){return{countdownTs:t,msgId:e}}l.createBridgeMsgsStartCountdown=c,l.createBridgeMsgClearCountdown=d}),98);
__d("MAWEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=null,u=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerTimestamp,"backend"]);function c(e){var t=e.expiryFns,n=e.purgeDeletionsFns;if(s==null){var r;s={expiry:new(r=o("MAWMsgCleaner")).MsgCleaner(t,r.CLEANER_TYPE.EPHEMERAL),purgeDeletions:new r.MsgCleaner(n,r.CLEANER_TYPE.EPHEMERAL)}}}function d(t,n){if(s==null)throw u.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");var r=s,o=r.expiry,a=r.purgeDeletions;u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for expiry(",") and deletion(",")"])),t,n),o.update(t),a.update(n)}function m(){return s}function p(){s=null}l.startEphemeralCleaner=c,l.addNewEphemeralTimestamp=d,l.getEphemeralCleaner_FOR_TESTING_ONLY=m,l.resetEphemeralCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWEphemeralMsgUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return function(t){return!e.has(t.msgId)&&t.ephemeralMsgDisappeared!==!0}}i.filterNonExpiredMsg=e}),66);
__d("MAWEphemeralSettingsCache",["MAWBridge","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map;function s(t,n){e.set(t,n)}function u(t){var n,r={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:o("WATimeUtils").castToUnixTime(0)};return(n=e.get(t))!=null?n:r}async function c(t){var n={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:o("WATimeUtils").castToUnixTime(0)};if(!e.has(t)){var r=await o("MAWBridge").getBridge().sendAndReceive("event","getLSDBEphemeralSetting",{chatJid:t});s(t,r!=null?r:n)}}l.setEphemeralSettingCache=s,l.getEphemeralSettingCache=u,l.requestLSDBCacheForJid=c}),98);
__d("MAWEphemeralUtil",["FBLogger","MAWAckLevel","MAWBridgeMsgCountdown","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWMsgType","WAArmadilloApplication.pb","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){var n=t.ephemeralExpirationInSec!==e.ephemeralExpirationInSec&&t.ephemeralLastUpdatedOrSetTimestamp===e.ephemeralLastUpdatedOrSetTimestamp;return n||e.ephemeralLastUpdatedOrSetTimestamp>t.ephemeralLastUpdatedOrSetTimestamp}function c(t,n,r){if(t==null)return!0;var a=t.ephemeralSetting;return a!=null&&a.ephemeralExpirationInSec===n?(o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["New ephemeral duration should be different from the existing duration"]))),!1):a!=null&&a.ephemeralLastUpdatedOrSetTimestamp>r?(o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["The new ephemeral setting timestamp should be greater than the existing timestamp"]))),!1):!0}function d(e){var t={ack:o("MAWAckLevel").ACK.sent,altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES},ts:e,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};return{unstoredDbMedia:null,unstoredDbMsg:t,unstoredDbReaction:null}}function m(e,t){var n;switch(t){case o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:n=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE;break;case o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:n=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING;break;default:throw r("FBLogger")("messenger_web").mustfixThrow("Received unexpected screenshot action type")}var a={ack:o("MAWAckLevel").ACK.sent,altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT,screenshotActionType:n},ts:e,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return{unstoredDbMedia:null,unstoredDbMsg:a,unstoredDbReaction:void 0}}function p(e){return o("WAJids").switchOnMsgrChatJidType(e,{group:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("Received invalid chatJid. We only support ephemeral messaging in 1:1 threads.")},user:function(t){return t}})}function _(e){e!=null&&e.messageExpirationTs!=null&&e.ephemeralCounterStarted===!0&&o("MAWIndexedDb").afterTransaction({tag:"MsgClearCountdown",value:o("MAWBridgeMsgCountdown").createBridgeMsgClearCountdown(e.msgId,e.messageExpirationTs)})}l.isLocalSettingOutdated=u,l.shouldUpdateForOutgoingUserEphemeralSettingChange=c,l.buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder=d,l.buildUnstoredDbEphemeralScreenshotActionMsgWithoutContentPlaceholder=m,l.getUserJidForEphemeralSetting=p,l.maybeClearEphemeralMsgCountdown=_}),98);
__d("MAWEphemeralSettingsTxns",["DateConsts","MAWDbThreadTxns","MAWDexieTable","MAWEphemeralSettingsCache","MAWEphemeralUtil","MAWIndexedDb","MAWLoggerUtils","MAWUserJidWrapper","MWFBLogger","WAJids","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("MWFBLogger").MWLogger().tags(["maw_db","txn",(_=o("MAWLoggerUtils")).Tag.Ephemeral,_.Tag.SettingChange,_.Tag.Incoming]),g=o("MWFBLogger").MWLogger().tags(["maw_db","txn",_.Tag.Ephemeral,_.Tag.SettingChange,_.Tag.Outgoing]),h=null,y=90*o("DateConsts").SEC_PER_DAY;function C(t,n,r,a,i,l,d,m,p){if(r<0||r>y){var _=o("WAJids").interpretAndValidateJid(l.jid).toString();throw f.mustfixThrow("EphemeralSetting duration is invalid "+r+", jidType: "+_)}var g={ephemeralExpirationInSec:r,ephemeralLastUpdatedOrSetTimestamp:a};f.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Handle Incoming Ephemeral Setting duration: ",", lastUpdated: ",". Thread: ",", Author: ",""])),r,a,String(l),n);var C=o("WAJids").interpretAsUserJid(l.jid);if(C==null)return f.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Received invalid chat jid for incoming ephemeral settings"]))),o("MAWDexieTable").dexieResolve(h);var b=o("WAJids").isAuthorMe(n)?o("MAWUserJidWrapper").getMyUserJid():n,v=o("MAWEphemeralSettingsCache").getEphemeralSettingCache(l.jid),S=v==null?void 0:v.ephemeralExpirationInSec,R=v==null?void 0:v.ephemeralLastUpdatedOrSetTimestamp;if(p)return v!=null&&!o("MAWEphemeralUtil").isLocalSettingOutdated(g,v)?a!==R?(f.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Sending Sync Response with duration ",", timestamp ",""])),S,R),o("MAWDexieTable").dexieResolve({outOfSyncEphemeralSetting:{chatJid:l.jid,correctEphemeralExpirationInSec:v.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:v.ephemeralLastUpdatedOrSetTimestamp}})):(f.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Ephemeral setting in sync"]))),o("MAWDexieTable").dexieResolve(h)):(o("MAWIndexedDb").afterTransaction({tag:"EphemeralSettingsUpdatedForUI",value:{author:o("WAJids").userIdFromJid(b),chatJid:l.jid,ephemeralSettingArgs:g,isEphemeralSettingReset:i}}),o("MAWDexieTable").dexieResolve(h));var L={ephemeralSetting:g,ephemeralSyncResponseBackoffInfo:void 0,userJid:C};return t.ephemeralSettings.put(L).then(function(){return h})}function b(e,t,n,r,a){var i=n;if(i<0)throw g.mustfixThrow("Ephemeral duration should be 0 or more");var l=o("MAWEphemeralUtil").getUserJidForEphemeralSetting(t);return o("MAWDbThreadTxns").getThread(e,t).then(function(t){return t.success?e.ephemeralSettings.get({userJid:l}).then(function(t){if(!o("MAWEphemeralUtil").shouldUpdateForOutgoingUserEphemeralSettingChange(t,i,r))return o("WAResultOrError").makeResult({shouldUpdateSetting:!1});var n=t==null?{ephemeralSetting:{ephemeralExpirationInSec:i,ephemeralLastUpdatedOrSetTimestamp:r},userJid:l}:babelHelpers.extends({},t,{ephemeralSetting:{ephemeralExpirationInSec:i,ephemeralLastUpdatedOrSetTimestamp:r}});return e.ephemeralSettings.put(n).then(function(){return o("WAResultOrError").makeResult({shouldUpdateSetting:!0})})}):o("WAResultOrError").makeResult({shouldUpdateSetting:!1})})}function v(e,t,n){var a=o("MAWEphemeralUtil").getUserJidForEphemeralSetting(t);return e.ephemeralSettings.get({userJid:a}).then(function(t){if(t==null||t.ephemeralSetting==null)throw g.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Contact "," "," and ephemeral setting "," should not be null when receiving the server ack for outgoing ephemeral setting change"])),a,String(t),String(t==null?void 0:t.ephemeralSetting)),g.mustfixThrow("Contact and ephemeral setting should not be null when receiving the server ack for outgoing ephemeral setting change");var o=babelHelpers.extends({},t,{ephemeralSetting:{ephemeralExpirationInSec:t.ephemeralSetting.ephemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:n}});return e.ephemeralSettings.put(o).then(r("emptyFunction"))})}function S(e,t){var n=o("WAJids").interpretAsUserJid(t);n==null&&g.mustfixThrow("Unexpected chatJid input to isEphemeralMessagesEnabledForContact");var r=o("MAWEphemeralSettingsCache").getEphemeralSettingCache(t);return r.ephemeralLastUpdatedOrSetTimestamp===o("WATimeUtils").castToUnixTime(0)?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("no_ephemeral_setting")):r!=null&&r.ephemeralExpirationInSec>0?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult({outOfSyncEphemeralSetting:{chatJid:t,correctEphemeralExpirationInSec:r.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:r.ephemeralLastUpdatedOrSetTimestamp}})):o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("no_ephemeral_setting"))}function R(e,t){return e.ephemeralSettings.get({userJid:t}).then(function(n){return(n==null?void 0:n.ephemeralSyncResponseBackoffInfo)==null?(f.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo no op for ",""])),t),o("WAResultOrError").makeResult()):(n.ephemeralSyncResponseBackoffInfo=void 0,f.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo reset for ",""])),t),e.ephemeralSettings.put(n).then(function(){return o("WAResultOrError").makeResult()}))})}l.handleAndWriteIncomingEphemeralSetting=C,l.handleAndWriteOutgoingUserEphemeralSettingChange=b,l.updateContactWhenEphemeralSettingChangeMarkedSent=v,l.getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg=S,l.maybeResetEphemeralSyncResponseBackoffInfo=R}),98);
__d("MAWDbMsgOrReaction",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}function l(e,t){return e==null?t.forNull():e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}function s(e,t){return e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}function u(e,t){return e==null?t.forNull():e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}i.switchOnMsgOrReaction=e,i.switchOnMsgOrReactionNullish=l,i.switchOnMsgOrReactionMaybeUnstored=s,i.switchOnMsgOrReactionMaybeUnstoredNullish=u}),66);
__d("MAWThreadUpdateType",[],(function(t,n,r,o,a,i){"use strict";var e=0,l=1,s=2,u=3,c=Object.freeze({BUMP_THREAD:s,MARK_THREAD_AS_UNREAD:u,NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:e,SNIPPET_ONLY:l});i.THREAD_UPDATE_TYPE=c}),66);
__d("MAWGetThreadUpdateTypeForAdminMsg",["FBLogger","MAWAdminMsgTypesGrouped","MAWLocalizationType","MAWThreadUpdateType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e;return t==null?(r("FBLogger")("messenger_web").mustfix("nullAdminType"),o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE):s(t)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:u(t)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:c(t)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:(d(t)||r("FBLogger")("messenger_web").mustfix("unsupportedAdminMsgType"),o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE)}function s(e){return o("MAWAdminMsgTypesGrouped").otherUserAddRemoveParticipant.includes(e)||o("MAWAdminMsgTypesGrouped").chatCustomizedByOtherUser.includes(e)||o("MAWAdminMsgTypesGrouped").callActionToNotifyAbout.includes(e)||o("MAWAdminMsgTypesGrouped").twoUsersConnected.includes(e)||o("MAWAdminMsgTypesGrouped").fallbackMsgFromOtherUser.includes(e)||o("MAWAdminMsgTypesGrouped").otherUserBumpsMessage.includes(e)||o("MAWAdminMsgTypesGrouped").otherNonAdminMsgToBeMarkedAsUnread.includes(e)||e===o("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR}function u(e){return o("MAWAdminMsgTypesGrouped").currentUserAddRemoveParticipant.includes(e)||o("MAWAdminMsgTypesGrouped").chatCustomizedByCurrentUser.includes(e)||o("MAWAdminMsgTypesGrouped").callActionNotToNotifyAbout.includes(e)||o("MAWAdminMsgTypesGrouped").fallbackMsgFromCurrentUser.includes(e)||o("MAWAdminMsgTypesGrouped").currentUserBumpsMessage.includes(e)||o("MAWAdminMsgTypesGrouped").otherNonAdminMsgToBeBumped.includes(e)||o("MAWAdminMsgTypesGrouped").limitSharingUpdate.includes(e)}function c(e){return e===o("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_ROLLBACK_ADMIN_MESSAGE||o("MAWAdminMsgTypesGrouped").dualThreadCutoverAdminMsgs.includes(e)||o("MAWAdminMsgTypesGrouped").ephemeralSettingChanges.includes(e)||o("MAWAdminMsgTypesGrouped").groupPermissionsChanged.includes(e)||o("MAWAdminMsgTypesGrouped").participantLeftGroup.includes(e)||o("MAWAdminMsgTypesGrouped").pinnedMessageUpdate.includes(e)}function d(e){return o("MAWAdminMsgTypesGrouped").cutoverAdminMsgs.includes(e)||o("MAWAdminMsgTypesGrouped").deviceChanges.includes(e)||o("MAWAdminMsgTypesGrouped").icdcAlerts.includes(e)||o("MAWAdminMsgTypesGrouped").otherNonAdminMsgToNotTriggerUpdate.includes(e)||e===o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION||e===o("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET||e===o("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG||e===o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_UK_OSA_ADMIN_MESSAGE}l.getThreadUpdateTypeForAdminMsg=e}),98);
__d("MAWGetThreadUpdateType",["FBLogger","MAWDbMsgOrReaction","MAWGetThreadUpdateTypeForAdminMsg","MAWThreadSnippetUtils","MAWThreadUpdateType","MAWUserJidWrapper","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.reaction==null;return u(e,t)}function s(e){return c(e.reactToAuthor)&&!c(e.author)}function u(e,t){return s(e)&&!t?e.senderTimestampMs==null?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE}function c(e){return e===o("WAJids").AUTHOR_ME||e===o("MAWUserJidWrapper").getMyUserJid()}function d(e){var t=e.adminType,n=e.author,a=e.msgType,i=e.xmaMessageType,l=function(t){var e=t.me,r=t.other;return o("WAJids").isAuthorMe(n)?e:r};switch(a){case"Text":case"ReceiverFetch":case"Sticker":case"Unavailable":case"Video":case"Futureproof":case"DocumentFile":case"EphemeralScreenshotAction":case"Gif":case"Image":case"Ptt":case"RavenAction":case"Raven":case"GroupPollCreate":case"GroupPollUpdate":case"BumpExistingMessage":return l({me:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD,other:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD});case"XMA":return o("MAWThreadSnippetUtils").shouldIgnoreXMAMsgForSnippet(i)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:l({me:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD,other:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD});case"Revoked":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY;case"DeleteForMe":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE;case"EditAction":return l({me:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY,other:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE});case"GroupInvite":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD;case"Admin":{if(a==="Admin")return o("MAWGetThreadUpdateTypeForAdminMsg").getThreadUpdateTypeForAdminMsg(t);throw r("FBLogger")("messenger_web").mustfixThrow("Non-admin msg passed in "+(a!=null?a:"UNKNOWN"))}case"SenderKeyDistribution":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE;case"AlertICDC":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD;case"Ciphertext":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD;case"EphemeralSettingAdmin":case"EphemeralSettingChangeFromCurrentDevice":case"EphemeralSyncResponse":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWGetThreadUpdateType] Unexpected message type: %s",a!=null?a:"UNKNOWN")}}function m(t){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstoredNullish(t,{forMessage:function(t){var e;return d({adminType:(e=t.msgContent)==null?void 0:e.adminType,author:t.author,msgType:t.type,xmaMessageType:t.xmaMessageType})},forNull:function(){return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE},forReaction:function(n){return e(n)}})}function p(e){var t=m(e);switch(t){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:return!1;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return!0;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate][snippet] Unhandled threadUpdateType: "+t)}}function _(e){var t=m(e);switch(t){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:return!1;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return!0;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate][bump] Unhandled threadUpdateType: "+t)}}l.getThreadUpdateTypeForReaction=e,l.canReactionAffectBump=s,l.getReactionThreadUpdateType=u,l.getThreadUpdateTypeForMsg=d,l.getThreadUpdateTypeForMsgOrReaction=m,l.isThreadUpdateTypeEligibleForSnippet=p,l.isThreadUpdateTypeEligibleForBump=_}),98);
__d("MAWGetBumpTimestampMs",["I64","MAWAckLevel","MAWDbMsgOrReaction","MAWExtractMsFromExternalId","MAWTimeUtils","WALongInt","WATimeUtils","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n){var r=n==null?null:o("MAWExtractMsFromExternalId").extractMsFromExternalId(n);return(e||(e=o("I64"))).add(o("MAWTimeUtils").millisTimeToTimestamp(t),e.of_int32(r!=null?r:0))}function u(t){var n=t.msg,a=t.throwIfNoServerTs,i=a?r("nullthrows")(n.serverTs):n.serverTs;return s(o("WATimeUtils").castUnixTimeToMillisTime(i!=null?i:n.ts),(e||(e=o("I64"))).of_string(n.externalId))}function c(t){return t.senderTimestampMs!=null?(e||(e=o("I64"))).of_string(o("WALongInt").longIntToDecimalString(t.senderTimestampMs)):s(o("WATimeUtils").castUnixTimeToMillisTime(t.ts),(e||(e=o("I64"))).of_string(t.externalId))}function d(t){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstoredNullish(t,{forMessage:function(n){return o("MAWAckLevel").isMsgAuthoritative(n.ack)&&n.sortOrderMs!=null?(e||(e=o("I64"))).of_float(n.sortOrderMs):u({msg:n,throwIfNoServerTs:!1})},forNull:function(){return(e||(e=o("I64"))).zero},forReaction:c})}l.calculateBumpTimestampMs=s,l.getBumpTimestampMs=d}),98);
__d("MAWDbReaction",["FBLogger","I64","MAWAckLevel","MAWGetBumpTimestampMs","MAWUserJidWrapper","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){var t=e.author,n=e.reaction,r=e.reactToAuthor,a=o("MAWUserJidWrapper").getMyUserJid();return!(n==null||n===""||r!=="@me"&&r!==a||t==="@me"||t==="@system"||t===a)}function u(e){var t=o("MAWUserJidWrapper").getMyUserJid();if(e.reactToAuthor!=="@me"&&e.reactToAuthor!==t||e.reaction==null)return null;var n=e.author==="@me"||e.author==="@system"?null:e.author;return n==null?null:babelHelpers.extends({},e,{author:n,reaction:e.reaction,reactToAuthor:"@me"})}function c(e){var t=u(e);if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot cast reaction to incomingDbReaction");return t}function d(e,t,n){var r=o("MAWUserJidWrapper").getMyUserJid();return e.find(function(e){return e.threadJid===t&&o("WAJids").authorToUserId(e.author,r)===o("WAJids").authorToUserId(n,r)})}function m(e){return e}function p(e,t,n,r,a,i,l,s,u,c,d,m,p){m===void 0&&(m=o("MAWAckLevel").ACK.clock);var _={ack:m,author:c,externalId:t,groupingKey:i,reaction:a,reactionId:n,reactToAuthor:l,reactToExternalId:r,reactToMsgId:s,senderTimestampMs:p,threadJid:e,ts:u};return d!=null?babelHelpers.extends({},_,{rowId:d}):_}function _(t){var n=o("MAWGetBumpTimestampMs").getBumpTimestampMs(t);return o("WATimeUtils").castToMillisTime((e||(e=o("I64"))).to_float(n))}l.isIncomingReaction=s,l.maybeCastToIncomingDbReaction=u,l.castToIncomingDbReaction=c,l.findMatchingReaction=d,l.reactionIdToMsgId=m,l.formatReactionForDb=p,l.getReactionTimeMs=_}),98);
__d("MAWThreadNewestMsgOrReactionUtils",["FBLogger","MAWDbMsg","MAWDbMsgTxns","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWGetThreadUpdateType","MAWODSProxy","MAWThreadUpdateType","WALogger","WAMsg","WAOdsEnums","WATimeUtils","first","last"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){return _(e,t,u)}function u(e,t){switch(e){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return t!==!0;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:return!1;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate] Unhandled threadUpdateType to create filter function : "+e)}}function c(e,t){return _(e,t,m)}function d(e){var t=e.db,n=e.jid,r=e.limit;return o("MAWDbMsgTxns").fetchMessagesFromDbWithSortOrderMs(t,n,null,!0,r,function(e){var t;return p(o("MAWGetThreadUpdateType").getThreadUpdateTypeForMsg({adminType:(t=e.msgContent)==null?void 0:t.adminType,author:e.author,msgType:e.type,xmaMessageType:e.xmaMessageType}),e.ephemeralMsgDisappeared===!0)},"before")}function m(e,t){switch(e){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return t!==!0;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:return!1;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate] Unhandled threadUpdateType to create filter function : %s",e)}}function p(e,t){switch(e){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return t!==!0;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:return!1;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCacheService] Unhandled threadUpdateType to create filter function : %s",e)}}function _(t,n,r){var a=function(a){return a==null?o("MAWDexieTable").dexieResolve(null):g(t,n,r,a)};return f(t,n,r).then(function(t){return a(t).then(function(r){if(t==null&&r==null)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[CentralizedThreadUpdate] No Reaction or Message in "," is eligible for snippet"])),n),null;if(r==null)return t;if(t==null)return r;var a=o("WATimeUtils").castToMillisTime(o("MAWDbMsg").getSortOrderWithFallback(t)),i=o("MAWDbReaction").getReactionTimeMs(r);return a>=i?t:r})})}function f(e,t,n){return o("MAWDbMsgTxns").fetchMessagesFromDbWithSortOrderMs(e,t,null,!0,1,function(e){var t;return n(o("MAWGetThreadUpdateType").getThreadUpdateTypeForMsg({adminType:(t=e.msgContent)==null?void 0:t.adminType,author:e.author,msgType:e.type,xmaMessageType:e.xmaMessageType}),e.ephemeralMsgDisappeared===!0)},"before").then(r("first"))}function g(e,t,n,a){var i=o("MAWDbMsg").getSortOrderWithFallback(a),l=function(a,l){return o("MAWDbReactionsTxns").fetchReactionsFromDbWithTimestamp(e,t,o("WATimeUtils").castToMillisTime(i),l,l==null,a,function(e){return n(o("MAWGetThreadUpdateType").getThreadUpdateTypeForReaction(e),!1)&&o("MAWDbReaction").getReactionTimeMs(e)>i})},s=[1,10],u=100,c=new Set,d=function(n,a){var t;return l((t=s[n])!=null?t:u,a).then(function(t){var a=t.filter(function(e){return!c.has(C(e))});return a.length===0?(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_THREAD_GET_NEWEST_REACTION_BATCH_NUM,key:"new."+n}),null):h(e,a).then(function(e){var a=e.newestReaction,i=e.nullMsgIds;return a!=null?(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_THREAD_GET_NEWEST_REACTION_BATCH_NUM,key:"new."+n}),a):(i.forEach(function(e){return c.add(e)}),d(n+1,r("last")(t)))})})};return d(0,null)}function h(e,t){return o("MAWDbMsgTxns").getUniqueMsgsByProtocolMsgIds(e,t.map(y)).then(function(e){var n=new Set(e.map(b)),r=new Set,o=null;return t.forEach(function(e){var t=C(e);n.has(t)?o=v(o,e):r.add(t)}),{newestReaction:o,nullMsgIds:r}})}function y(e){return{author:e.reactToAuthor,chat:e.threadJid,externalId:e.reactToExternalId}}function C(e){return o("WAMsg").craftWAMsgIdString(y(e))}function b(e){return o("WAMsg").craftWAMsgIdString({author:e.author,chat:e.threadJid,externalId:e.externalId})}function v(e,t){return e==null?t:t==null||o("MAWDbReaction").getReactionTimeMs(e)>o("MAWDbReaction").getReactionTimeMs(t)?e:t}l.getNewestMsgOrReactionForBump=s,l.filterForBump=u,l.getNewestMsgOrReactionForSnippet=c,l.getNewestIncomingMsgsForSnippet=d,l.filterForSnippet=m,l.filterForSnippetNewestIncomingMessages=p,l.getNewestReactionToNonNullMsg=h}),98);
__d("MAWThreadSnippetForAdminOrEphemeralMsg",["FBLogger","MAWAdminMsgNormalized","MAWLocalizationType","MAWLocalizationUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.adminMsgContent,n=e.adminType,a=e.snippetSenderContactId,i=n;if(i==null||t==null)return r("FBLogger")("GroupPollsE2EE").mustfix("MAWThreadSnippetForAdminOrEphemeralMsg: snippetType or adminMsgContent is null"),{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:a,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET};var l=o("MAWLocalizationUtils").isAdminMsgNormalized(i)?o("MAWAdminMsgNormalized").deconstructContactIdsFromAdminContent(i,t):{contactIds:[],contents:t},s=l.contactIds,u=l.contents;return{snippetParams:{contactIDs:[].concat(s.map(function(e){return e==="Facebook User"?"0":e})),strings:[].concat(u)},snippetSenderContactId:a,snippetType:i}}l.default=e}),98);
__d("MAWThreadSnippetForBumpExistingMessageMsg",["MAWLocalizationType","WAGlobals","WAJids","WALogger","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t,n){return{snippetParams:{contactIDs:n!=null?n:[],strings:[]},snippetSenderContactId:e,snippetType:t}}var m=function(t){return d(t,o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)};function p(t){var n=t.author,r=t.replyAuthor,a=t.replyType,i=t.snippetSenderContactId;if(o("WAJids").isAuthorSystem(n))return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Bumped message can not have AUTHOR_SYSTEM"]))),m(i);var l=a;if(l===o("WAMsgType").UNAVAILABLE)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Bump message has unavailable content type"]))),m(i);var p=r;return p==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Bump message has no quoted author"]))),m(i)):o("WAJids").isAuthorMe(n)||n===o("WAGlobals").getMyUserJid()?o("WAJids").isAuthorMe(p)||p===o("WAGlobals").getMyUserJid()?d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_OWN_MESSAGE):d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE,[o("WAJids").userIdFromJid(p)]):i==null?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Bump message sender is null"]))),m(i)):o("WAJids").isAuthorMe(p)||p===o("WAGlobals").getMyUserJid()?d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_CURRENT_USER_MESSAGE,[i]):p===n?d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_OWN_MESSAGE,[i]):d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE,[i,o("WAJids").userIdFromJid(p)])}l.default=p}),98);
__d("MAWThreadSnippetForCiphertextMsg",["MAWLocalizationType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:e,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.USER_SEND_ENCRYPTED_MESSAGE_FALLBACK}}l.default=e}),98);
__d("MAWThreadSnippetForDocumentFileMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Document file message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForFallbackMessageMsg",["MAWLocalizationType","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return{snippetParams:{contactIDs:n!=null?n:[],strings:[]},snippetSenderContactId:e,snippetType:t}}function s(t){var n=t.author,r=t.snippetSenderContactId,a=t.unsupportedType;if(o("WAJids").isAuthorMe(n))switch(a){case"liveLocationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LIVE_LOCATION_FALLBACK);case"locationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LOCATION_FALLBACK);case"contactShareMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_CONTACT_SHARE_FALLBACK);case"storyMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STORY_MENTION_FALLBACK);case"postMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POST_MENTION_FALLBACK);case"pollCreationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POLL_CREATION_FALLBACK);case"bumpMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE);case"stickerReceiverFetchMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STICKER_RECEIVER_FETCH_MESSAGE_FALLBACK);case"messengerMemory":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.MESSENGER_MEMORY_ENCRYPTED_MESSAGE_FALLBACK);default:return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)}else switch(a){case"liveLocationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LIVE_LOCATION_FALLBACK);case"locationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LOCATION_FALLBACK);case"contactShareMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_CONTACT_SHARE_FALLBACK);case"storyMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STORY_MENTION_FALLBACK);case"postMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POST_MENTION_FALLBACK);case"pollCreationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POLL_CREATION_FALLBACK);case"bumpMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE);case"metaAiMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.META_AI_SEND_MESSAGE_FALLBACK);case"stickerReceiverFetchMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STICKER_RECEIVER_FETCH_MESSAGE_FALLBACK);case"messengerMemory":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.MESSENGER_MEMORY_ENCRYPTED_MESSAGE_FALLBACK);default:return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)}}l.default=s}),98);
__d("MAWThreadSnippetForGifMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_GIF:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Animated message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_GIF,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForImageMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_IMAGE:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Image message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_IMAGE,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForPttMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_AUDIO:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Ptt message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_AUDIO,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForRavenMsg",["MAWLocalizationType","MAWMsg","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.ravenMediaType,i=t.snippetSenderContactId,l=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,s={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?l=a===o("MAWMsg").MAWRavenMsgMediaType.IMAGE?o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_IMAGE:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_VIDEO:o("WAJids").isAuthorSystem(n)||i==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Animated message can not have AUTHOR_SYSTEM"]))):(l=a===o("MAWMsg").MAWRavenMsgMediaType.IMAGE?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_IMAGE:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_VIDEO,s.contactIDs.push(i)),{snippetParams:s,snippetSenderContactId:i,snippetType:l}}l.default=s}),98);
__d("MAWThreadSnippetForMsgUtils",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r){var a=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,i={contactIDs:[],mentionJIDs:n!=null?n:[],strings:[]};return o("WAJids").isAuthorMe(t)?a=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STICKER:o("WAJids").isAuthorSystem(t)||r==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Sticker message can not have AUTHOR_SYSTEM"]))):(a=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STICKER,i.contactIDs.push(r)),{snippetParams:i,snippetSenderContactId:r,snippetType:a}}l.getMAWThreadSnippetForStickerMsg=s}),98);
__d("MAWThreadSnippetForReceiverFetchMsg",["MAWThreadSnippetForMsgUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.author,n=e.mentionedJids,r=e.snippetSenderContactId;return o("MAWThreadSnippetForMsgUtils").getMAWThreadSnippetForStickerMsg(t,n,r)}l.default=e}),98);
__d("MAWThreadSnippetForRevokedMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UNSENT_MESSAGE:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Revoked message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UNSENT_MESSAGE,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForStickerMsg",["MAWThreadSnippetForMsgUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.author,n=e.mentionedJids,r=e.snippetSenderContactId;return o("MAWThreadSnippetForMsgUtils").getMAWThreadSnippetForStickerMsg(t,n,r)}l.default=e}),98);
__d("MAWThreadSnippetForTextMsg",["MAWLocalizationType","MAWVault","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.content,a=t.isGroup,i=t.mentionedJids,l=t.snippetSenderContactId,s=t.specialTextSize,u=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,c={contactIDs:[],mentionJIDs:i,strings:[]};if(o("WAJids").isAuthorMe(n)?u=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_TEXT:o("WAJids").isAuthorSystem(n)||l==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Text message can not have AUTHOR_SYSTEM"]))):(u=a?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT_IN_GROUP:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT,c.contactIDs.push(l)),r!=null)if(s===1||s===2||s===3){var d=o("MAWVault").unvault(r);c.strings.push(d==="\uD83D\uDC4D"?"(Y)":r)}else c.strings.push(r);return{snippetParams:c,snippetSenderContactId:l,snippetType:u}}l.default=s}),98);
__d("MAWThreadSnippetForVideoMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.gifPlayback,a=t.mentionedJids,i=t.snippetSenderContactId,l=r===!0,s=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,u={contactIDs:[],mentionJIDs:a,strings:[]};return o("WAJids").isAuthorMe(n)?s=l?o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_GIF:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_VIDEO:o("WAJids").isAuthorSystem(n)||i==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Video message can not have AUTHOR_SYSTEM"]))):(s=l?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_GIF:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_VIDEO,u.contactIDs.push(i)),{snippetParams:u,snippetSenderContactId:i,snippetType:s}}l.default=s}),98);
__d("MAWThreadSnippetForXMAMsg",["MAWLocalizationType","WAArmadilloXMA.pb","WAJids","WALogger","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N;function M(t){var n=t.author,a=t.chatJid,i=t.content,l=t.mentionedJids,M=t.snippetSenderContactId,A=t.xmaMessageType,F=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,O={contactIDs:[],mentionJIDs:l,strings:[]};switch(A==null&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["XMA message does not have xmaMessageType"]))),A){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.GEN_AI_RICH_RESPONSE:if(!r("gkx")("12661")){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Encountered unexpected XMAMessageType when building a thread snippet: ",""])),A);break}case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PROFILE_DIRECTORY_ITEM:if(o("WAJids").isAuthorMe(n))if(i!=null){var B=i;F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT,B!=null&&O.strings.push(B)}else F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT;else if(o("WAJids").isAuthorSystem(n)||M==null)o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"])));else{F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,O.contactIDs.push(M);var W=i;W!=null&&O.strings.push(W)}break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_POST_MENTION:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POST_MENTION:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POST_MENTION;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_MEMORIES_SHARE:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_MEMORIES_SHARE;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STORY_MENTION:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STORY_MENTION;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LOCATION:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LOCATION;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_AI_CONTACT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_CONTACT_SHARE:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_CONTACT_SHARE;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_REEL:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_REEL;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_POST:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_POST;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_FRIEND_UPDATES_REPLY:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_POST:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_POST;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY_HIGHLIGHT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY_HIGHLIGHT;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MENTIONED_STORY_IG;var q;if(a!=null&&(q=o("WAJids").interpretAsUserJid(a)),q!=null){var U=o("WAJids").userIdFromJid(q);O.contactIDs.push(U)}else o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["XMA story mentions must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)?o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_RECEIVED_STORY_MENTION_IG;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_AUDIO_CALLED;var V=w(a);V!=null?O.contactIDs.push(V):o("WALogger").ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_AUDIO_CALLED,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:if(o("WAJids").isAuthorMe(n)&&M!=null){F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_VIDEO_CALLED;var H=w(a);H!=null?O.contactIDs.push(H):o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_VIDEO_CALLED,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MISSED_AUDIO_CALL;var G=w(a);G!=null?O.contactIDs.push(G):o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MISSED_AUDIO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MISSED_VIDEO_CALL;var z=w(a);z!=null?O.contactIDs.push(z):o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(D||(D=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MISSED_VIDEO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:o("WAJids").isAuthorMe(n)&&M!=null?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_AUDIO_CALL:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_AUDIO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:o("WAJids").isAuthorMe(n)&&M!=null?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_VIDEO_CALL:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR($||($=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_VIDEO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_EVENT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(P||(P=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_EVENT,O.contactIDs.push(M));break;default:o("WALogger").ERROR(N||(N=babelHelpers.taggedTemplateLiteralLoose(["Encountered unexpected XMAMessageType when building a thread snippet: ",""])),A)}return{snippetParams:O,snippetSenderContactId:M,snippetType:F}}function w(e){var t=e!=null?o("WAJids").interpretAsUserJid(e):null;return t!=null?o("WAJids").userIdFromJid(t):null}l.default=M}),98);
__d("MAWThreadSnippet",["FBLogger","MAWLocalizationType","MAWMsgType","MAWThreadSnippetForAdminOrEphemeralMsg","MAWThreadSnippetForBumpExistingMessageMsg","MAWThreadSnippetForCiphertextMsg","MAWThreadSnippetForDocumentFileMsg","MAWThreadSnippetForFallbackMessageMsg","MAWThreadSnippetForGifMsg","MAWThreadSnippetForImageMsg","MAWThreadSnippetForPttMsg","MAWThreadSnippetForRavenMsg","MAWThreadSnippetForReceiverFetchMsg","MAWThreadSnippetForRevokedMsg","MAWThreadSnippetForStickerMsg","MAWThreadSnippetForTextMsg","MAWThreadSnippetForVideoMsg","MAWThreadSnippetForXMAMsg","MAWUserJidWrapper","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return/^\d+$/.test(e)}function s(t){if(!o("WAJids").isAuthorSystem(t)){var n=o("WAJids").isAuthorMe(t)?o("WAJids").userIdFromJid(o("MAWUserJidWrapper").getMyUserJid()):o("WAJids").userIdFromJid(t);if(!e(n)){r("FBLogger")("messenger_web").mustfix("[MAWThreadSnippetBuildTxns] Snippet sender contact id is invalid");return}return n}}function u(e){var t=e.adminMsgContent,n=e.adminType,a=e.author,i=e.chatJid,l=e.content,u=e.gifPlayback,c=e.mentionedJids,d=e.msgType,m=e.ravenMediaType,p=e.replyAuthor,_=e.replyType,f=e.specialTextSize,g=e.unsupportedType,h=e.xmaMessageType,y=o("WAJids").switchOnMsgrChatJidType(i,{group:function(t){return!0},user:function(t){return!1}}),C=s(a);switch(d){case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return r("MAWThreadSnippetForCiphertextMsg")(C);case o("MAWMsgType").MSG_TYPE.TEXT:return r("MAWThreadSnippetForTextMsg")({author:a,content:l,isGroup:y,mentionedJids:c,snippetSenderContactId:C,specialTextSize:f});case o("MAWMsgType").MSG_TYPE.IMAGE:return r("MAWThreadSnippetForImageMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.VIDEO:return r("MAWThreadSnippetForVideoMsg")({author:a,gifPlayback:u,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.PTT:return r("MAWThreadSnippetForPttMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:return r("MAWThreadSnippetForAdminOrEphemeralMsg")({adminMsgContent:t,adminType:n,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.GIF:return r("MAWThreadSnippetForGifMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.STICKER:return r("MAWThreadSnippetForStickerMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return r("MAWThreadSnippetForDocumentFileMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.REVOKED:return r("MAWThreadSnippetForRevokedMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.XMA:return r("MAWThreadSnippetForXMAMsg")({author:a,chatJid:i,content:l,mentionedJids:c,snippetSenderContactId:C,xmaMessageType:h});case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return r("MAWThreadSnippetForBumpExistingMessageMsg")({author:a,replyAuthor:p,replyType:_,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:return r("MAWThreadSnippetForFallbackMessageMsg")({author:a,snippetSenderContactId:C,unsupportedType:g});case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return r("MAWThreadSnippetForReceiverFetchMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.RAVEN:return r("MAWThreadSnippetForRavenMsg")({author:a,mentionedJids:c,ravenMediaType:m,snippetSenderContactId:C});default:return{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:C,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET}}}l.getSnippetContactId=s,l.buildThreadSnippet=u}),98);
__d("WAProtocolMsgId",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.externalId===t.externalId&&e.author===t.author&&e.chat===t.chat}i.equals=e}),66);
__d("MAWThreadSnippetBuildTxns",["FBLogger","MAWDbMsg","MAWDbMsgOrReaction","MAWDbReaction","MAWDexieTable","MAWJidUtils","MAWLocalizationType","MAWThreadSnippet","MAWThreadSnippetUtils","MAWUserJidWrapper","WAJids","WAProtocolMsgId","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return o("WAJids").switchOnMsgrChatJidType(n,{group:function(r){return u(e,t,!0)},user:function(r){return u(e,t,!1)}})}function s(t,n){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstored(n,{forMessage:function(n){var e,r,a,i,l,s,u;return o("MAWThreadSnippet").buildThreadSnippet({adminMsgContent:(e=n.msgContent)==null?void 0:e.adminMsgContent,adminType:(r=n.msgContent)==null?void 0:r.adminType,author:n.author,chatJid:t,content:(a=n.msgContent)==null?void 0:a.content,mentionedJids:(i=n.msgContent)==null?void 0:i.mentionedJids,msgType:n.type,ravenMediaType:n.ravenMediaType,replyAuthor:(l=n.quote)==null?void 0:l.content.author,replyType:(s=n.quote)==null?void 0:s.content.type,specialTextSize:n.specialTextSize,unsupportedType:(u=n.msgContent)==null?void 0:u.subtype,xmaMessageType:n.xmaMessageType})},forReaction:function(n){var t=o("MAWDbReaction").castToIncomingDbReaction(n);return e(t.author,t.reaction,t.threadJid)}})}function u(e,t,n){var a;o("WAJids").isAuthorMe(e)?(r("FBLogger")("messenger_web").warn("[MAWThreadSnippetBuildTxns] Reaction snippet author should not be @me"),a=o("WAJids").userIdFromJid(o("MAWUserJidWrapper").getMyUserJid())):a=o("WAJids").userIdFromJid(e);var i={contactIDs:[],strings:[]},l=n?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE_IN_GROUP:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE;return i.contactIDs.push(a),i.strings.push(t),{snippetParams:i,snippetSenderContactId:a,snippetType:l}}function c(e,t,n,r){var a,i=n.newestReaction,l=n.reactionsToClear;if(i!=null&&o("WATimeUtils").castUnixTimeToMillisTime(i.ts)>((a=t.snippetMsgTs)!=null?a:0))return o("MAWDexieTable").dexieResolve({newestReaction:i,thread:d(t,i,r)});var s=l!=null&&l.length>0;return s&&t.snippetMsg!=null?e.reactions.get({reactionId:t.snippetMsg}).then(function(n){var r=!1;if(n==null)r=!0;else{var a=o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.threadJid,n.reactToExternalId);a!=null&&(r=l.some(function(e){var t=o("MAWJidUtils").maybeToProtocolMsgId(e.author,e.threadJid,e.reactToExternalId);return t!=null&&o("WAProtocolMsgId").equals(t,a)}))}return r?m(e,t).then(function(e){return{newestReaction:null,thread:e}}):o("MAWDexieTable").dexieResolve({newestReaction:null,thread:t})}):o("MAWDexieTable").dexieResolve({newestReaction:null,thread:t})}function d(e,t,n){return babelHelpers.extends({},e,{snippetMsg:t.reactionId,snippetMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(t.ts)})}function m(e,t){return o("MAWThreadSnippetUtils").recalculateSnippetFromScratch_EXPENSIVE(e,t).then(function(e){if(e==null)return r("FBLogger")("messenger_web").mustfix("[Occamadillo] ThreadUpdated handler called for clear snippet when centralized thread bump is enabled"),babelHelpers.extends({},t,{snippetMsg:void 0,snippetMsgTs:void 0});var n=o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(e));return babelHelpers.extends({},t,{snippetMsg:e.msgId,snippetMsgTs:n})})}function p(e,t){return m(e,t).then(function(t){return e.threads.put(t).then(r("emptyFunction"))})}l.buildReactionThreadSnippet=e,l.buildThreadSnippetForMsgOrIncomingReaction=s,l.getReactionSnippetParams=u,l.getThreadChangesetForReactionChanges=c,l.getThreadChangesetForNewReaction=d,l.refreshThreadSnippet=p}),98);
__d("MAWThreadSnippetUtils",["MAWDbReaction","MAWEphemeralMsgUtils","MAWJidUtils","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWThreadNewestMsgOrReactionUtils","MAWThreadSnippet","MAWThreadSnippetBuildTxns","MAWXMAUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;if(d(e.xmaMessageType))return!0;var n=((t=e.msgContent)==null?void 0:t.adminType)!=null?o("MAWLocalizationUtils").isDeviceChangeAdminMsg(e.msgContent.adminType):!1;if(e.type!==o("MAWMsgType").MSG_TYPE.ADMIN)return!1;var r=e.msgContent.adminType;return r===o("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG?!0:n}function s(t,n,r){return t.messages.where("[threadJid+sortOrderMs]").between([n.jid,Number.MIN_SAFE_INTEGER],[n.jid,Number.MAX_SAFE_INTEGER],!1,!1).filter(function(t){return(r==null||o("MAWEphemeralMsgUtils").filterNonExpiredMsg(r)(t))&&!e(t)}).reverse().first()}var u={snippetParams:{contactIDs:[],mentionJIDs:[],strings:[]},snippetSenderContactId:null,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET};function c(e,t,n,r){return r==null||r.addPoint("fetching_from_db_from_scratch_"+(n!=null?n:0)+"_start"),o("MAWThreadNewestMsgOrReactionUtils").getNewestMsgOrReactionForSnippet(e,t).then(function(e){return r==null||r.addPoint("fetching_from_db_from_scratch_"+(n!=null?n:0)+"_end"),e==null?{snippet:u}:m(t,e)})}function d(e){return o("MAWXMAUtils").isXMAStoryReply(e)||o("MAWXMAUtils").isXMAMsgHighlightsTabFriendUpdatesReply(e)}function m(e,t){var n,r,a,i,l,s,c;if(t.reactionId!=null){var d=o("MAWDbReaction").maybeCastToIncomingDbReaction(t);return d==null?{snippet:u}:{snippet:o("MAWThreadSnippetBuildTxns").buildReactionThreadSnippet(d.author,d.reaction,e),snippetMsgOrReaction:t}}switch(t.type){case o("MAWMsgType").MSG_TYPE.XMA:{var m,p,_,f,g,h,y,C=o("MAWJidUtils").toProtocolMsgId(t);return C==null?{snippet:u}:{snippet:o("MAWThreadSnippet").buildThreadSnippet({adminMsgContent:(m=t.msgContent)==null?void 0:m.adminMsgContent,adminType:(p=t.msgContent)==null?void 0:p.adminType,author:t.author,chatJid:t.threadJid,content:(_=t.msgContent)==null?void 0:_.content,mentionedJids:(f=t.msgContent)==null?void 0:f.mentionedJids,msgType:t.type,ravenMediaType:t.ravenMediaType,replyAuthor:(g=t.quote)==null?void 0:g.content.author,replyType:(h=t.quote)==null?void 0:h.content.type,specialTextSize:t.specialTextSize,unsupportedType:(y=t.msgContent)==null?void 0:y.subtype,xmaMessageType:t.xmaMessageType}),snippetMsgOrReaction:t}}default:return{snippet:o("MAWThreadSnippet").buildThreadSnippet({adminMsgContent:(n=t.msgContent)==null?void 0:n.adminMsgContent,adminType:(r=t.msgContent)==null?void 0:r.adminType,author:t.author,chatJid:t.threadJid,content:(a=t.msgContent)==null?void 0:a.content,mentionedJids:(i=t.msgContent)==null?void 0:i.mentionedJids,msgType:t.type,ravenMediaType:t.ravenMediaType,replyAuthor:(l=t.quote)==null?void 0:l.content.author,replyType:(s=t.quote)==null?void 0:s.content.type,specialTextSize:t.specialTextSize,unsupportedType:(c=t.msgContent)==null?void 0:c.subtype,xmaMessageType:t.xmaMessageType}),snippetMsgOrReaction:t}}}l.isDbMsgDisabledForThreadSnippet=e,l.recalculateSnippetFromScratch_EXPENSIVE=s,l.EMPTY_SNIPPET_DATA=u,l.getThreadSnippetFromScratch=c,l.shouldIgnoreXMAMsgForSnippet=d}),98);
__d("MAWEphemeralMsgTxns",["EBLogger","MAWBridgeMsgCountdown","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralConsts","MAWEphemeralMsgUtils","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWLoggerUtils","MAWODSProxy","MAWThreadSnippetUtils","MWFBLogger","WAJids","WAOdsEnums","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("MWFBLogger").MWLogger().tags([(p=o("MAWLoggerUtils")).Tag.Ephemeral,p.Tag.SettingSync,p.Tag.Incoming]),f=o("MWFBLogger").MWLogger().tags([p.Tag.Ephemeral,p.Tag.OnRead,p.Tag.Countdown]);function g(e,t,n){return n===void 0&&(n=function(){return!0}),o("MAWDbMsgTxns").getThreadMessagesBySortOrder(e,t,!1,!0).filter(n).limit(1).toArray().then(function(e){var t;return{needsUpdate:!0,value:(t=e[0])!=null?t:null}})}function h(e,t,n){return n.size===0?o("MAWDexieTable").dexieResolve():o("MAWDbThreadTxns").getThread(e,t).then(function(t){if(t.success){var r=t.value;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").getThreadOldestMessageId(e,r.jid),o("MAWDbMsgTxns").getThreadNewestMessageId(e,r.jid)]).then(function(t){var a=t[0],i=t[1];if(!(a==null||i==null)){var l=o("MAWEphemeralMsgUtils").filterNonExpiredMsg(n),s=n.has(a)?g(e,r.jid,l):o("MAWDexieTable").dexieResolve({needsUpdate:!1}),u=n.has(i)?o("MAWDbMsgTxns").getThreadMessagesBySortOrder(e,r.jid,!0,!1).filter(l).reverse().limit(1).toArray().then(function(t){var a=t[0];return a!=null&&o("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(a)?o("MAWThreadSnippetUtils").recalculateSnippetFromScratch_EXPENSIVE(e,r,n).then(function(e){return{needsUpdate:!0,value:e!=null?e:null}}):{needsUpdate:!0,value:a!=null?a:null}}):o("MAWDexieTable").dexieResolve({needsUpdate:!1});return o("MAWDexieTable").dexieAll([s,u]).then(function(t){var n,l,s,u,c=t[0],d=t[1];if(!(!c.needsUpdate&&!d.needsUpdate)){var m=d.needsUpdate?(n=(l=d.value)==null?void 0:l.msgId)!=null?n:void 0:i,p=d.needsUpdate?d.value!=null?o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(d.value)):void 0:r.snippetMsgTs,_=babelHelpers.extends({},r,{oldestMsg:c.needsUpdate?(s=(u=c.value)==null?void 0:u.msgId)!=null?s:null:a,snippetMsg:m,snippetMsgTs:p});e.threads.put(_)}})}})}})}function y(t,n,r){if(r===void 0&&(r=!0),n==null||n.ephemeralSetting==null||n.ephemeralSetting.ephemeralExpirationInSec===0)return o("MAWDexieTable").dexieResolve(n);var a=o("WATimeUtils").castToUnixTime(n.ts+n.ephemeralSetting.ephemeralExpirationInSec),i=o("WATimeUtils").castToUnixTime(a+o("MAWEphemeralConsts").ephemeralReportingWindowInSeconds);return n.ebTimestampMs!=null&&(o("EBLogger").EBLogger().tags(["eb_restore"]).WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Delete DM backup - S472027 follow up"]))),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"restore_dm_s472027"})),C(t,[{messageDeleteTs:i,messageExpirationTs:a,msgId:n.msgId,readTsForLogging:n.ts}]).then(function(e){var t=e[0],n=e[1],a=e[2];return a.length>0&&(f.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["markEphemeralMessageAsSent EphemeralCounter: Showing UI counter for ",""])),String(a.map(function(e){return e.msgId}))),r&&o("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:o("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(a)})),t!=null&&n!=null&&o("MAWEphemeralCleaner").addNewEphemeralTimestamp(t,n),a[0]})}function C(e,t){var n=t.map(function(e){return e.msgId});return o("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(e,n).then(function(r){var o=new Map;t.forEach(function(e){o.set(e.msgId,{messageDeleteTs:e.messageDeleteTs,messageExpirationTs:e.messageExpirationTs,readTsForLogging:e.readTsForLogging});var t=r.get(e.msgId);t!=null&&o.set(t,{messageDeleteTs:e.messageDeleteTs,messageExpirationTs:e.messageExpirationTs,readTsForLogging:e.readTsForLogging})});var a=null,i=null,l=[],s=Array.from(new Set(n.concat(Array.from(r.values()))));return e.messages.where("msgId").anyOf(s).toArray().then(function(t){if(t.length!==0)return t.forEach(function(e){var t=e.messageExpirationTs,n=e.messageDeleteTs,r=o.get(e.msgId),s=r==null?void 0:r.messageExpirationTs,c=r==null?void 0:r.messageDeleteTs;if(f.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["updating ephemeral timestamp msg ",", existing expiration ",", existing deletion ",", updated expiration ",", updated deletion ",""])),e.msgId,t,n,s,c),!(s==null||c==null)&&e.ephemeralCounterStarted!==!0){(a==null||s<a)&&(a=s),(i==null||c<i)&&(i=c);var d=babelHelpers.extends({},e,{ephemeralCounterStarted:!0,messageDeleteTs:c,messageExpirationTs:s});l.push(d)}}),e.messages.bulkPut(l)}).then(function(){return[a,i,l]})})}function b(e,t){if(t.size===0)return o("MAWDexieTable").dexieResolve();var n=[];return t.forEach(function(t,r){n.push(h(e,r,t))}),o("MAWDexieTable").dexieAll(n).then(r("emptyFunction"))}function v(e,t,n,a,i){if(t==null)return o("MAWDexieTable").dexieResolve();_.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdateEphemeralSettingOrCheckOutOfSyncAfterWritingIncomingMsg: Message from ",", chat ",", type ",""])),n,a.jid,t.type);var l=o("MAWDexieTable").dexieResolve();if(t.ephemeralSetting==null)o("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(){return o("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(e,n).then(r("emptyFunction"))},user:function(){o("MAWDbMsg").isMsgEligibleForTriggeringEphemeralSyncResponse(t)&&(l=o("MAWEphemeralSettingsTxns").getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg(e,a.jid).then(function(e){var t;return e==null||(t=e.value)==null?void 0:t.outOfSyncEphemeralSetting}))}});else if(t.messageExpirationTs!=null&&t.messageDeleteTs!=null){var s=t.ephemeralSetting,u=t.messageDeleteTs,p=t.messageExpirationTs;_.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is ephemeral: duration ",", timestamp ",""])),s.ephemeralExpirationInSec,s.ephemeralLastUpdatedOrSetTimestamp),o("MAWEphemeralCleaner").addNewEphemeralTimestamp(p,u),l=o("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(e,n,s.ephemeralExpirationInSec,s.ephemeralLastUpdatedOrSetTimestamp,!1,a,i,null,!0).then(function(e){return e==null?void 0:e.outOfSyncEphemeralSetting})}return l.then(function(t){if(t!=null)_.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is out of sync: correct duration ",", correct timestamp ",""])),t.correctEphemeralExpirationInSec,t.correctEphemeralLastUpdatedOrSetTimestamp);else return o("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(e,n).then(r("emptyFunction"))})}l.markEphemeralMessageAsSent=y,l.bulkUpdateEphemeralMessageTimestamps=C,l.updateThreadsOnMessagesExpiredFromUi=b,l.syncEphemeralSettingOnIncomingMsg=v}),98);
__d("MAWExpiredQuoteCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.QUOTE))}function d(t){if(u==null){var n="Trying to add new addNewExpiredQuoteCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ExpiredQuoteCleaner: Adding timestamps backend(",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startExpiredQuoteCleaner=c,l.addNewExpiredQuoteCleanerTimestamp=d,l.getExpiredQuoteCleaner_FOR_TESTING_ONLY=m,l.resetExpiredQuoteCleaner_FOR_TESTING_ONLY=p}),98);
__d("isE2EEConversationSearchEnabled",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("4741")}l.default=e}),98);
__d("isMAWUniversalSearchEnabled",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("4741")}l.default=e}),98);
__d("isWAFTSContentSearchEnabled",["isE2EEConversationSearchEnabled","isMAWUniversalSearchEnabled"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("isE2EEConversationSearchEnabled")()||r("isMAWUniversalSearchEnabled")()}l.default=e}),98);
__d("MAWFTSTxns",["FtsIndexEntity","MAWDexieTable","ODS","isWAFTSContentSearchEnabled","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("justknobx")._("1146");function u(t,n){return r("isWAFTSContentSearchEnabled")()?((e||(e=o("ODS"))).bumpEntityKey(9819,o("FtsIndexEntity").MIGRATE_FTS_BACKLOG_TO_WPQ_ODS_ENTITY_NAME,"purge_message_backlog.put"),t.ftsPurgeBacklog.put({externalId:n})):o("MAWDexieTable").dexieResolve(null)}function c(t,n){return!r("isWAFTSContentSearchEnabled")()||!s?o("MAWDexieTable").dexieResolve(null):((e||(e=o("ODS"))).bumpEntityKey(9819,o("FtsIndexEntity").MIGRATE_FTS_BACKLOG_TO_WPQ_ODS_ENTITY_NAME,"index_message_backlog.put"),t.ftsBackloggedMessages.put({rowId:n}))}function d(t,n){return!r("isWAFTSContentSearchEnabled")()||!s?o("MAWDexieTable").dexieResolve(null):((e||(e=o("ODS"))).bumpEntityKey(9819,o("FtsIndexEntity").MIGRATE_FTS_BACKLOG_TO_WPQ_ODS_ENTITY_NAME,"index_message_backlog.put",n.length),t.ftsBackloggedMessages.bulkPut(n.map(function(e){return{rowId:e}})))}function m(t,n){return r("isWAFTSContentSearchEnabled")()?((e||(e=o("ODS"))).bumpEntityKey(9819,o("FtsIndexEntity").MIGRATE_FTS_BACKLOG_TO_WPQ_ODS_ENTITY_NAME,"purge_thread_backlog.put"),t.ftsPurgeThreadBacklog.put({chatJid:n})):o("MAWDexieTable").dexieResolve(null)}function p(e,t,n){return e?t():n()}l.maybePutMessageToPurgeBacklog=u,l.maybePutMessageToBacklog=c,l.maybePutMessagesToBacklog=d,l.maybePutThreadToPurgeBacklog=m,l.dexieIfElse=p}),98);
__d("MAWMainTraceUtils",["LSRequestId"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("LSRequestId").generate()}l.createTraceId=e}),98);
__d("MAWBridgeUpload",["MAWMainTraceUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.actionType,n=e.attachmentContext,r=e.attachmentContextArray,o=e.authTs,a=e.echoDocument,i=e.echoEncodingLatencyNs,l=e.errorCode,s=e.errorMessage,c=e.messageId,d=e.messageType,m=e.productType,p=e.protoMsg,_=e.sortOrderMs,f=e.threadId,g=e.traceId,h=e.uploadTrackingInstanceKey,y=u(n,m!=null?m:"msgr",r);return{actionType:t,attachmentBackupContext:y,authTs:o,echoDocument:a,echoEncodingLatencyNs:i,errorCode:l,errorMessage:s,messageId:c,messageType:d,protoMsg:p,sortOrderMs:_,threadId:f,traceId:g,uploadTrackingInstanceKey:h}}function s(e,t,n,r,o,a){return{actionType:a,echoDocument:o,folderType:t,threadId:e,transportKey:n,ts:r}}function u(e,t,n){if(n!=null){var r=n.map(function(e){return{attachmentTraceId:o("MAWMainTraceUtils").createTraceId(),mediaType:e.mediaType,zippyObjectId:e.mediaObjectId}}),a={attachmentInfos:r,productType:t};return a}}l.createBridgeUploadMessage=e,l.createBridgeDeleteMessagesOfThread=s,l.createBridgeUploadAttachmentBackupContext=u}),98);
__d("MAWUploadThreadTxns",["$InternalEnum","MAWFolderTypes"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({INBOX:0,PENDING:1,OTHER:2,SPAM:3,ARCHIVED:4,HIDDEN:5});function s(t){switch(t){case o("MAWFolderTypes").FOLDER_ID.INBOX:return e.INBOX;case o("MAWFolderTypes").FOLDER_ID.PENDING:return e.PENDING;case o("MAWFolderTypes").FOLDER_ID.ARCHIVED:return e.ARCHIVED;default:return e.INBOX}}function u(e){return s(e).toString()}l.FolderType=e,l.getFolderTypeAsText=u}),98);
__d("MpsDeletedCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function d(t){if(u==null){var n="Trying to add new MpsDeletedTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MpsDeletedCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startMpsDeletedCleaner=c,l.addNewMpsDeletedTimestamp=d,l.getMpsDeletedCleaner_FOR_TESTING_ONLY=m,l.resetMpsDeletedCleaner_FOR_TESTING_ONLY=p}),98);
__d("MpsEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=null,u=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerTimestamp,"purgeDeletions"]);function c(e){s==null&&(s=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.EPHEMERAL))}function d(t){if(s==null)throw u.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for expiry(",")"])),t),s.update(t)}function m(){return s}function p(){s=null}l.startMpsEphemeralCleaner=c,l.addNewMpsEphemeralTimestamp=d,l.getEphemeralCleaner_FOR_TESTING_ONLY=m,l.resetEphemeralCleaner_FOR_TESTING_ONLY=p}),98);
__d("MpsLogger",["FBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return r("FBLogger")("mps",t)};l.MpsLogger=e}),98);
__d("WormMemoryIndex",["BinarySearch"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e){this.$1=new Map,this.$2=e}var t=e.prototype;return t.initialize=function(t){var e=this.$2.indexes;if(e!=null){for(var n of Object.keys(e))this.$1.set(n,[]);for(var r of t){var o=r[0],a=r[1];this.add(o,a)}}},t.buildKey=function(t,n){var e,r=(e=this.$2.indexes)==null?void 0:e[n];return r==null?[]:r.fields.map(function(e){return t[e]})},t.compareKeys=function(t,n){for(var e=Math.min(t.length,n.length),r=0;r<e;r++){var o=t[r],a=n[r];if(o!==a){if(typeof o=="number"&&typeof a=="number")return o-a;if(typeof o=="bigint"&&typeof a=="bigint"){if(o<a)return-1;if(o>a)return 1;continue}var i=String(o),l=String(a);if(i<l)return-1;if(i>l)return 1}}return 0},t.add=function(t,n){var e=this,r=this.$2.indexes;if(r!=null)for(var a of Object.keys(r)){var i=this.$1.get(a);if(i!=null){var l=this.buildKey(n,a),s=o("BinarySearch").findBoundInArray(i,l,function(t,n){return e.compareKeys(t.key,n)},o("BinarySearch").LEAST_STRICT_UPPER_BOUND);i.splice(s,0,{key:l,pk:t})}}},t.remove=function(t,n){var e=this,r=this.$2.indexes;if(r!=null)for(var a of Object.keys(r)){var i=this.$1.get(a);if(i!=null){for(var l=this.buildKey(n,a),s=o("BinarySearch").findBoundInArray(i,l,function(t,n){return e.compareKeys(t.key,n)},o("BinarySearch").LEAST_UPPER_BOUND),u=s;u<i.length&&this.compareKeys(i[u].key,l)===0;u++)if(i[u].pk===t){i.splice(u,1);break}}}},t.getSortedArray=function(t){return this.$1.get(t)},t.clear=function(){for(var e of this.$1.keys())this.$1.set(e,[])},t.findRange=function(t,n){var e,r,a,i,l=this,s=this.$1.get(t);if(s==null)return[0,0];var u=(e=(r=n==null?void 0:n.greaterThan)!=null?r:n==null?void 0:n.greaterThanOrEqual)!=null?e:n==null?void 0:n.only,c=(a=(i=n==null?void 0:n.lessThan)!=null?i:n==null?void 0:n.lessThanOrEqual)!=null?a:n==null?void 0:n.only,d=u==null?0:o("BinarySearch").findBoundInArray(s,u,function(e,t){return l.compareKeys(e.key,t)},(n==null?void 0:n.greaterThan)!=null?o("BinarySearch").LEAST_STRICT_UPPER_BOUND:o("BinarySearch").LEAST_UPPER_BOUND),m=c==null?s.length:(n==null?void 0:n.lessThan)!=null?o("BinarySearch").findBoundInArray(s,c,function(e,t){return l.compareKeys(e.key,t)},o("BinarySearch").LEAST_UPPER_BOUND):o("BinarySearch").findBoundInArray(s,c,function(e,t){return l.compareKeys(e.key,t)},o("BinarySearch").GREATEST_LOWER_BOUND)+1;return[d,m]},t.findExact=function(t,n){var e=this,r=this.$1.get(t);if(r==null)return-1;var a=o("BinarySearch").findBoundInArray(r,n,function(t,n){return e.compareKeys(t.key,n)},o("BinarySearch").LEAST_UPPER_BOUND);return a<r.length&&this.compareKeys(r[a].key,n)===0?a:-1},e})();l.WormMemoryIndex=e}),98);
__d("WormMemoryDriver",["BinarySearch","FBLogger","WAResolvable","WormMemoryIndex","WormStoreFunctions","err","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=0;function s(){return e+=1,e}function u(){e=0}var c=(function(){function e(e,t,n,r){var o,a;this.$3={},this.$4=Promise.resolve(),this.$5=[],this.$2=e,this.$1=t,this.$9=n,this.$6=r==null?void 0:r.blockingErrorThreshold,this.$7=(o=r==null?void 0:r.onBlockingError)!=null?o:function(){},this.$8=(a=r==null?void 0:r.onTransactionError)!=null?a:function(){};for(var i of Object.keys(t))this.$3[i]=new Map}var t=e.prototype;return t.getSchema=function(){return this.$1},t.getDbAlias=function(){return this.$2},t.$10=function(t){var e,n,o;if(this.$6!=null){var a=this.$6,i=(e=(n=(o=t==null?void 0:t.name)!=null?o:t==null?void 0:t.message)!=null?n:t==null?void 0:t.toString())!=null?e:"unknown";if(this.$5.push(i),!(this.$5.length<Math.max(a,1))){var l=this.$5[this.$5.length-1],s=this.$5.every(function(e){return e===l})?l:"mixed";r("FBLogger")("worm").mustfix("Unrecoverable error (%s): %s",this.$2,s),this.$9.log(this.$2+".error.unrecoverable."+s),this.$7(s),this.$5=[]}}},t.runInTransaction=function(t,n,a,i){var e,l=this,s=new(o("WAResolvable")).Resolvable;return(e=i.eventFlow)==null||e.addPoint("memory_txn_start"),this.$4=this.$4.then(async function(){var e,r;(e=i.eventFlow)==null||e.addPoint("memory_txn_execute");var o={};for(var u of t)o[u]=new Map(l.$3[u]);var c=t.reduce(function(e,t){var n;return babelHelpers.extends({},e,(n={},n[t]=new d(o[t],l.$1[t]),n))},{}),m={abort:function(){},commit:function(){return s.promise.then(function(){})},stores:c},p=await a(m);if(n==="readwrite")for(var _ of t)l.$3[_]=o[_];(r=i.eventFlow)==null||r.addPoint("memory_txn_commit"),s.resolve(p)}).catch(function(e){var t,n=r("getErrorSafe")(e);(t=i.eventFlow)==null||t.addPoint("memory_txn_error",{string:{error_message:n.message,error_name:n.name}}),l.$9.log(l.$2+".error.txn_error"),l.$8(n),l.$10(n),s.reject(n)}),s.promise},t.close=function(){},t.init=function(t){var e,n;return t==null||(e=t.eventFlow)==null||e.addPoint("memory_init_start"),this.$9.log(this.$2+".init"),t==null||(n=t.eventFlow)==null||n.addPoint("memory_init_end"),Promise.resolve({isNewDb:!0,isUpgraded:!1})},e})(),d=(function(){function e(e,t){var n=this;this.readIndexRange=function(e,t,o){var a=n.$2.indexes;if(a==null)throw r("err")("No indexes found");var i=a[e];if(i==null)throw r("err")("Index not found");var l=n.$3.getSortedArray(e);if(l!=null&&l.length>0&&(o==null?void 0:o.order)!=null)return Promise.resolve(n.$6(l,t,o));var s=Array.from(n.$1.values());if(t!=null){var u,c,d,m;s=p(s,(u=(c=t.lessThan)!=null?c:t.lessThanOrEqual)!=null?u:t.only,t.lessThanOrEqual!=null||t.only!=null,(d=(m=t.greaterThan)!=null?m:t.greaterThanOrEqual)!=null?d:t.only,t.greaterThanOrEqual!=null||t.only!=null,i)}return Promise.resolve(n.$5(s,o,e))},this.$1=e,this.$2=t,this.$3=new(o("WormMemoryIndex")).WormMemoryIndex(t),this.$3.initialize(this.$1.entries())}var t=e.prototype;return t.bulkAdd=function(t){var e=this;for(var n of t){if(this.$2.autoIncrement===!0&&n[this.$2.primaryKey]===void 0&&(n[this.$2.primaryKey]=s()),this.$1.has(n[this.$2.primaryKey]))throw r("err")("Item with key already exists");this.$4(n);var o=n[this.$2.primaryKey];this.$1.set(o,n),this.$3.add(o,n)}return Promise.resolve(t.map(function(t){return t[e.$2.primaryKey]}))},t.bulkPut=function(t){var e=this;for(var n of t){this.$4(n),this.$2.autoIncrement===!0&&n[this.$2.primaryKey]===void 0&&(n[this.$2.primaryKey]=s());var r=n[this.$2.primaryKey],o=this.$1.get(r);o!=null&&this.$3.remove(r,o),this.$1.set(r,n),this.$3.add(r,n)}return Promise.resolve(t.map(function(t){return t[e.$2.primaryKey]}))},t.$4=function(t){var e=this,n=this.$2.indexes;if(n!=null)for(var a of Object.entries(n)){var i=a[0],l=a[1];if(!(typeof l!="object"||l==null)){var s=l.unique;if(s!==!1){var u=this.$3.getSortedArray(i);if(u!=null){var c=this.$3.buildKey(t,i),d=o("BinarySearch").findBoundInArray(u,c,function(t,n){return e.$3.compareKeys(t.key,n)},o("BinarySearch").LEAST_UPPER_BOUND);if(d<u.length&&this.$3.compareKeys(u[d].key,c)===0){var m=t[this.$2.primaryKey];if(u[d].pk!==m)throw r("err")("ConstraintError")}}}}}},t.bulkGet=function(t){var e=this;return Promise.resolve(t.map(function(t){return e.$1.get(t)}))},t.get=function(t){return Promise.resolve(this.$1.get(t))},t.getByIndex=function(t,n,r){return o("WormStoreFunctions").getByIndex(this,t,n,r)},t.readByKeyRange=function(t,n){var e,r,o=m(Array.from(this.$1.values()),(e=t.lessThan)!=null?e:t.lessThanOrEqual,t.lessThanOrEqual!=null,(r=t.greaterThan)!=null?r:t.greaterThanOrEqual,t.greaterThanOrEqual!=null,this.$2.primaryKey);return Promise.resolve(this.$5(o,n))},t.bulkDelete=function(t){for(var e of t){var n=this.$1.get(e);n!=null&&(this.$3.remove(e,n),this.$1.delete(e))}return Promise.resolve()},t.delete=function(t){var e=this.$1.get(t);return e!=null&&(this.$3.remove(t,e),this.$1.delete(t)),Promise.resolve()},t.bulkUpsert=function(t,n){return o("WormStoreFunctions").bulkUpsert(this,this.$2,t,n)},t.$6=function(t,n,r){for(var e,o=this.$7(t,n),a=o[0],i=o[1],l=[],s=a;s<i;s++){var u=this.$1.get(t[s].pk);u!=null&&l.push(u)}return this.$8(l,r,(e=r.order)!=null?e:"asc")},t.$7=function(t,n){var e,r,a,i,l=this,s=(e=(r=n==null?void 0:n.greaterThan)!=null?r:n==null?void 0:n.greaterThanOrEqual)!=null?e:n==null?void 0:n.only,u=(a=(i=n==null?void 0:n.lessThan)!=null?i:n==null?void 0:n.lessThanOrEqual)!=null?a:n==null?void 0:n.only,c=s==null?0:o("BinarySearch").findBoundInArray(t,s,function(e,t){return l.$3.compareKeys(e.key,t)},(n==null?void 0:n.greaterThan)!=null?o("BinarySearch").LEAST_STRICT_UPPER_BOUND:o("BinarySearch").LEAST_UPPER_BOUND),d=u==null?t.length:(n==null?void 0:n.lessThan)!=null?o("BinarySearch").findBoundInArray(t,u,function(e,t){return l.$3.compareKeys(e.key,t)},o("BinarySearch").LEAST_UPPER_BOUND):o("BinarySearch").findBoundInArray(t,u,function(e,t){return l.$3.compareKeys(e.key,t)},o("BinarySearch").GREATEST_LOWER_BOUND)+1;return[c,d]},t.$8=function(t,n,r){var e=t;return n.filter!=null&&(e=e.filter(n.filter)),r==="desc"&&(e=e.reverse()),n.limit!=null&&(e=e.slice(0,n.limit)),e},t.readKeysByIndexRange=function(t,n,r){var e=this;return this.readIndexRange(t,n,r).then(function(t){return t.map(function(t){return t[e.$2.primaryKey]})})},t.getIndexRangeIterator=function(t,n,r,a){return o("WormStoreFunctions").getIndexRangeIterator(this.readIndexRange,this.$2,t,n,r,a)},t.$5=function(t,n,r){var e=t;if((n==null?void 0:n.filter)!=null&&(e=e.filter(n.filter)),(n==null?void 0:n.order)!=null&&r!=null){var o,a,i=(o=(a=this.$2.indexes)==null||(a=a[r])==null?void 0:a.fields)!=null?o:[];e=e.sort(function(e,t){for(var r of i)if(e[r]!==t[r])return n.order==="desc"?t[r]>e[r]?1:-1:e[r]>t[r]?1:-1;return 0})}return(n==null?void 0:n.limit)!=null&&(e=e.slice(0,n.limit)),e},t.readIndex=function(t,n,a){var e=this,i=this.$2.indexes;if(i==null)throw r("err")("No indexes found");var l=i[t];if(l==null)throw r("err")("Index not found");if(n==null)return Promise.resolve(this.$5(Array.from(this.$1.values()),a,t));var s=this.$3.getSortedArray(t);if(s==null)return Promise.resolve([]);for(var u=[].concat(n),c=o("BinarySearch").findBoundInArray(s,u,function(t,n){return e.$3.compareKeys(t.key,n)},o("BinarySearch").LEAST_UPPER_BOUND),d=[],m=c;m<s.length&&this.$3.compareKeys(s[m].key,u)===0;m++){var p=this.$1.get(s[m].pk);p!=null&&d.push(p)}return Promise.resolve(this.$5(d,a,t))},t.readIndexAnyOf=function(t,n,o){var e=this.$2.indexes;if(e==null)throw r("err")("No indexes found");var a=e[t];if(a==null)throw r("err")("Index not found");if(n.length===0)return Promise.resolve([]);var i=Array.from(this.$1.values());return i=i.filter(function(e){return n.some(function(t){for(var n=0;n<a.fields.length;n++)if(t[n]!==void 0&&e[a.fields[n]]!==t[n])return!1;return!0})}),Promise.resolve(this.$5(i,o,t))},t.readIndexKeys=function(t,n,r){var e=this;return this.readIndex(t,n,r).then(function(t){return t.map(function(t){return t[e.$2.primaryKey]})})},t.readAll=function(t){var e=this,n=Array.from(this.$1.values());return(t==null?void 0:t.filter)!=null&&(n=n.filter(t.filter)),(t==null?void 0:t.order)!=null&&(n=n.sort(function(n,r){var o=n[e.$2.primaryKey],a=r[e.$2.primaryKey];return o===a?0:t.order==="desc"?a>o?1:-1:o>a?1:-1})),(t==null?void 0:t.limit)!=null&&(n=n.slice(0,t.limit)),Promise.resolve(n)},t.readKeys=function(t){var e=this;return this.readAll(t).then(function(t){return t.map(function(t){return t[e.$2.primaryKey]})})},t.clear=function(){return this.$1.clear(),this.$3.clear(),Promise.resolve()},t.count=function(){return Promise.resolve(this.$1.size)},e})();function m(e,t,n,r,o,a){return e.filter(function(e){return!(r!=null&&r>e[a]||t!=null&&t<e[a]||t!=null&&n===!1&&e[a]===t||r!=null&&o===!1&&e[a]===r)})}function p(e,t,n,r,o,a){return e.filter(function(e){for(var i=0;i<a.fields.length;i++)if(r!=null&&r[i]>e[a.fields[i]]||t!=null&&t[i]<e[a.fields[i]]||i===a.fields.length-1&&(t!=null&&n===!1&&e[a.fields[i]]===t[i]||r!=null&&o===!1&&e[a.fields[i]]===r[i]))return!1;return!0})}l.TEST_ONLY_resetPK=u,l.WormMemoryDriver=c,l.WormMemoryStore=d}),98);
__d("WebReverbSchema",["FBLogger","MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver","WormMemoryDriver"],(function(t,n,r,o,a,i,l){"use strict";var e={autoIncrement:!0,indexes:{"[threadId+messageId]":{fields:["threadId","messageId"],unique:!0},"[threadId+timestampMs+messageId]":{fields:["threadId","timestampMs","messageId"],unique:!1},expiryTimestampMs:{fields:["expiryTimestampMs"],unique:!1},messageId:{fields:["messageId"],unique:!1},timestampMs:{fields:["timestampMs"],unique:!1}},nonEncryptedFields:["timestampMs","expiryTimestampMs","messageId","debugFlags"],primaryKey:"pk",secure:!0},s={autoIncrement:!0,indexes:{"[threadId+topLevelMessageId+supplementalKey]":{fields:["threadId","topLevelMessageId","supplementalKey"],unique:!0}},nonEncryptedFields:["topLevelMessageId"],primaryKey:"pk",secure:!0},u={autoIncrement:!0,indexes:{"[threadId+deletedMessageId]":{fields:["threadId","deletedMessageId"],unique:!0},"[threadId+timestampMs+deletedMessageId]":{fields:["threadId","timestampMs","deletedMessageId"],unique:!0},"[threadId+topLevelMessageId+supplementalKey]":{fields:["threadId","topLevelMessageId","supplementalKey"],unique:!1},deletionTimestampMs:{fields:["deletionTimestampMs"],unique:!1}},nonEncryptedFields:["topLevelMessageId","deletionTimestampMs"],primaryKey:"pk",secure:!0},c={autoIncrement:!0,indexes:{"[threadId+messageId+tag]":{fields:["threadId","messageId","tag"],unique:!0},"[threadId+tag+timestampMs]":{fields:["threadId","tag","timestampMs"],unique:!1}},nonEncryptedFields:["messageId","timestampMs","messagePk","tag"],primaryKey:"pk",secure:!0},d={autoIncrement:!1,indexes:{},primaryKey:"pk",secure:!0},m={dbMetadata:d,deleted:u,message:e,supplemental:s,tags:c};function p(e,t,n,a,i){var l=o("WAHex").parseHex(t),s="reverb",u=new(o("WormEAR")).WormEAR(m,s,l),c=new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,s,m,u,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:a,onTransactionError:function(t){if(t instanceof o("WormEAR").DecryptionError){var e=t;r("FBLogger")("mps").mustfix("EAR decryption error in store: %s. Dropping corrupted entity %s",e.store,e.maybeHashedPk),c.runInTransaction([e.store],"readwrite",function(t){var n=t.stores[e.store];return e.maybeHashedPk!=null?n.delete(e.maybeHashedPk):n.clear()},"delete-corrupted-entity")}}}),i);return c}function _(e){return new(o("Worm")).WormDatabase(new(o("WormMemoryDriver")).WormMemoryDriver("reverb_test",m,o("MAWWormOdsLogger").wormOdsWorkerLogger),e)}l.schema=m,l.makeWebReverbSchema=p,l.makeInMemoryReverbSchema_TEST_ONLY=_}),98);
__d("WebReverbDB",["MpsLogger","WAResolvable","WebReverbSchema","err","getErrorSafe","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;async function u(t,n,a,i,l){var u;try{var c=o("WebReverbSchema").makeWebReverbSchema(t,n,a,i,l);return e=c,u=await c.init(),s.resolve(c),u}catch(e){throw o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("Error performing WebReverb init"),e}}function c(){if(e==null)throw r("err")("Reverb DB is not initialized");return e}function d(){return s.promise}function m(e){return r("vulture")("V7Y7Nqdo8syOAwHMrSvML57TUyw="),"WebReverb - "+e}l.makeWebReverb=u,l.getWebReverbDB=c,l.getDbPromise=d,l.mpsOp=m}),98);
__d("MpsReverbDbDump",["WebReverbDB","WormDump"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t=o("WebReverbDB").getWebReverbDB();return t.dump({dbMetadata:{customFields:{mawDBMigrationCurrentMessageId:(e=o("WormDump")).wormNonSensitiveField,mawDBMigrationCurrentThread:e.wormNonSensitiveField,mawDBMigrationStartMs:e.wormNonSensitiveField,mawDBMigrationState:e.wormNonSensitiveField,pk:e.wormNonSensitiveField}},deleted:{customFields:{deletedMessageId:e.wormNonSensitiveField,deletionMessageId:e.wormNonSensitiveField,deletionTimestampMs:e.wormNonSensitiveField,isLocalOnlyMessage:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,supplementalKey:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField,topLevelMessageId:e.wormNonSensitiveField},limit:1e3},message:{customFields:{debugFlags:e.wormNonSensitiveField,expiryTimestampMs:e.wormNonSensitiveField,isLocalOnlyMessage:e.wormNonSensitiveField,isTransportErrorPlaceholder:e.wormNonSensitiveField,messageId:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,senderId:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField},limit:2500},supplemental:{customFields:{messageId:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,supplementalKey:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField,topLevelMessageId:e.wormNonSensitiveField},limit:1e3},tags:{customFields:{messageId:e.wormNonSensitiveField,messagePk:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField},limit:1e3}})}l.debugGetReverbDbDump=e}),98);
__d("WormMaintenanceSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver","WormMemoryDriver"],(function(t,n,r,o,a,i,l){"use strict";var e={autoIncrement:!0,indexes:{name:{fields:["name"],unique:!0}},nonEncryptedFields:["name","startedAtMs","finishedAtMs"],primaryKey:"pk",secure:!0},s={migrations:e};function u(e,t,n,r,a,i){var l=o("WAHex").parseHex(t),u="worm_maintenance",c=new(o("WormEAR")).WormEAR(s,u,l);return new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,u,s,c,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:r,onTransactionError:a}),i)}function c(e){return new(o("Worm")).WormDatabase(new(o("WormMemoryDriver")).WormMemoryDriver("worm_maintenance_test",s,o("MAWWormOdsLogger").wormOdsWorkerLogger),e)}l.makeWormMaintenanceSchema=u,l.makeWormMaintenanceSchema_TEST_ONLY=c}),98);
__d("WormMaintenanceDb",["FBLogger","WAResolvable","WormEAR","WormMaintenanceSchema","err","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;async function u(t){var n=t.blockingErrorThreshold,a=t.dbName,i=t.onBlockingError,l=t.qplEvent,u=t.strEncKey;try{var c=o("WormMaintenanceSchema").makeWormMaintenanceSchema(a,u,n,i,function(t){if(t instanceof o("WormEAR").DecryptionError){var n,a,i=t;r("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",i.store),r("promiseDone")((n=(a=e)==null?void 0:a.runInTransaction([i.store],"readwrite",function(e){var t=e.stores[i.store];return i.maybeHashedPk!=null?t.delete(i.maybeHashedPk):t.clear()},"delete-corrupted-entity"))!=null?n:Promise.resolve())}},l);return e=c,await c.init(),s.resolve(c),c}catch(e){throw r("FBLogger")("messenger_web").catching(r("getErrorSafe")(e)).mustfix("Error performing WORM PersistedQueue init"),e}}function c(){if(e==null)throw r("err")("WormMaintenanceDb is not initialized");return e}function d(){return s.promise}l.makeWormMaintenanceDb=u,l.getWormMaintenanceDb=c,l.getWormMaintenanceDbPromise=d}),98);
__d("MAWWormMaintenanceDbSetup",["BackendInitLoggingUtils","MAWCurrentUser","MAWIndexedDbMetadata","MAWODSProxy","MessengerWebInitData","WAOdsEnums","WormMaintenanceDb","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";async function e(){await o("BackendInitLoggingUtils").measureMawInit("worm_maintenance_db_init",async function(){await o("WormMaintenanceDb").makeWormMaintenanceDb({blockingErrorThreshold:r("justknobx")._("3218"),dbName:o("MAWIndexedDbMetadata").wormMaintenanceDbName(o("MAWCurrentUser").getID()),onBlockingError:function(t){o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WORM,key:"reverb.unrecoverable."+t})},qplEvent:r("qpl")._(1056840657,"2716"),strEncKey:r("MessengerWebInitData").accountKeyV2})})}l.mawWormDbMaintenanceDbSetup=e}),98);
__d("MpsTags",["FBLogger","MAWProtobufDeserializers","MSGDataclassTypes.flow","getErrorSafe","getMediaTypeFromConsumerMessage"],(function(t,n,r,o,a,i,l){"use strict";function e(e){try{var t,n=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(e),a=(t=n.encryptedTransportMessage())==null||(t=t.consumerMessage())==null?void 0:t.proto,i=o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(a);return s(i)}catch(e){var l=r("getErrorSafe")(e);return r("FBLogger")("wmi").tags(["mps","mps-tags"]).catching(l).mustfix("Failed to get the tag from the protobuf"),null}}function s(e){return e==="image"?o("MSGDataclassTypes.flow").MpsMessageTag.Photo:e==="video"?o("MSGDataclassTypes.flow").MpsMessageTag.Video:e==="gif"?o("MSGDataclassTypes.flow").MpsMessageTag.Gif:e==="ptt"?o("MSGDataclassTypes.flow").MpsMessageTag.Audio:e==="document"?o("MSGDataclassTypes.flow").MpsMessageTag.File:e==="sticker"||e==="md-app-state"||e==="xma-image"||e===void 0||e===null?null:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}l.getTagFromProto=e,l.getMpsMessageTagFromMediaType=s}),98);
__d("WebMpsPopulateMediaTagsDBMigration",["MpsTags","MpsTypes","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";var e=20,s=async function(n,r){var t=n!=null?o("MpsTypes").toTimestamp(parseInt(n,10)):null,a=await o("WebReverbDB").getWebReverbDB().runInTransaction(["message"],"readonly",function(n){return n.stores.message.readIndexRange("timestampMs",{greaterThan:[t!=null?t:o("MpsTypes").toTimestamp(0)]},{limit:e,order:"asc"})},"get-message-batch-after-timestamp");if(r.addPoint("messages_fetched_from_reverb",{int:{messageCount:a.length}}),a.length===0)return{hasMore:!1};var i=a.map(function(e){var t=o("MpsTags").getTagFromProto(e.payload);if(t==null)return null;var n=t;return{item:{messageId:e.messageId,messagePk:e.pk,tag:n,threadId:e.threadId,timestampMs:e.timestampMs},selector:[e.threadId,e.messageId,n]}}).filter(Boolean);return r.addPoint("tags_generated",{int:{tagCount:i.length}}),await o("WebReverbDB").getWebReverbDB().runInTransaction(["tags"],"readwrite",function(e){return e.stores.tags.bulkUpsert("[threadId+messageId+tag]",i)},"upsert-tags"),r.addPoint("tags_updated"),{hasMore:!0,nextCursor:a[a.length-1].timestampMs.toString()}};l.WebMpsPopulateMediaTagsMigrationTask=s}),98);
__d("WormDbMigrationScheduler",["FBLogger","MpsTypes","ODS","QPLFlow","WAWaitForUserUnblocked","WebMpsPopulateMediaTagsDBMigration","WorkerScheduler","WormMaintenanceDb","getErrorSafe","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=function(){return r("FBLogger")("wmi").tags(["worm_db_migration"])},d=null,m={concurrency:1,maxTaskLimit:1,maxThrottleMs:r("justknobx")._("3546"),timeoutMs:r("justknobx")._("3614")},p={"reverb-populate-media-tags":o("WebMpsPopulateMediaTagsDBMigration").WebMpsPopulateMediaTagsMigrationTask},_=new Map;function f(e,t){return e+":"+(t!=null?t:"null")}function g(e){var t;return(t=_.get(e))!=null?t:0}function h(e){_.set(e,g(e)+1)}async function y(){return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),C(p)}async function C(e){if(!r("justknobx")._("3720")){c().info("DB Migrations are disabled");return}if(d!=null){c().info("DB Migrations are already running");return}var t=!1,n=!1,o;try{for(var a=babelHelpers.asyncIterator(Object.entries(e)),i;t=!(i=await a.next()).done;t=!1){var l=i.value,s=l[0],u=l[1];await b(s,u)}}catch(e){n=!0,o=e}finally{try{t&&a.return!=null&&await a.return()}finally{if(n)throw o}}}async function b(t,n){var a=o("QPLFlow").startQPLFlow(r("qpl")._(767107656,"1154"),{annotations:{string:{migrationName:t}}}),i=await v(t),l;if(i==null?(a.addPoint("migration_state_not_found"),l=await S(t),(u||(u=o("ODS"))).bumpEntityKey(9819,"worm.db_migration",t+".started"),a.addPoint("initial_migration_state_set")):(a.addPoint("migration_state_retrieved"),l=i),l.finishedAtMs!=null){c().info("Migration "+t+" is already complete"),(u||(u=o("ODS"))).bumpEntityKey(9819,"worm.db_migration",t+".skipped"),a.addPoint("migration_already_complete"),a.endSuccess();return}var p=f(t,l.currentCursor),_=g(p);if(_>r("justknobx")._("2141")){c().INFO(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Migration "," has exceeded the max retry count"])),t),(u||(u=o("ODS"))).bumpEntityKey(9819,"worm.db_migration",t+".stuck"),a.addPoint("retry_count_exceeded"),a.endSuccess();return}d=o("WorkerScheduler").makeScheduler("WormDbMigrations",m).task({fn:function(){return n(l.currentCursor,a)},name:"worm_db_migration_"+t,priority:o("WorkerScheduler").BACKGROUND_PRIORITY});try{var y=await d.run();a.addPoint("migration_task_complete"),d=null,y.hasMore?(await R(babelHelpers.extends({},l,{currentCursor:y.nextCursor})),a.addPoint("migration_state_updated"),b(t,n)):(await R(babelHelpers.extends({},l,{currentCursor:void 0,finishedAtMs:o("MpsTypes").toTimestamp(Date.now())})),(u||(u=o("ODS"))).bumpEntityKey(9819,"worm.db_migration",t+".complete"),a.addPoint("migration_complete")),a.endSuccess()}catch(e){d=null;var C=r("getErrorSafe")(e);c().FATAL(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Runtime error when running migration ",": ",""])),t,C.message),a.endFail("runtime_error",{string:{errorMessage:C.message}}),h(p),b(t,n)}}function v(e){return o("WormMaintenanceDb").getWormMaintenanceDb().runInTransaction(["migrations"],"readonly",function(t){return t.stores.migrations.getByIndex("name",[e])},"mps-get-migration-by-name")}function S(e){return o("WormMaintenanceDb").getWormMaintenanceDb().runInTransaction(["migrations"],"readwrite",async function(t){var n={name:e,startedAtMs:o("MpsTypes").toTimestamp(Date.now())},r=await t.stores.migrations.bulkAdd([n]),a=r[0];return babelHelpers.extends({},n,{pk:a})},"mps-add-initial-migration-state")}function R(e){return o("WormMaintenanceDb").getWormMaintenanceDb().runInTransaction(["migrations"],"readwrite",async function(t){await t.stores.migrations.bulkPut([e])},"mps-set-migration-state")}l.runAllDbMigrations=y,l.getDbMigrationStateByName=v}),98);
__d("MpsReverbInit",["BrowserLockManager","MAWMpsMigrationStatus","MAWWormMaintenanceDbSetup","WebReverbDB","WormDbMigrationScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e="wmi_mps_new_db_status_lock",s=["reverb-populate-media-tags"],u=new Map(s.map(function(e){return[e,null]}));async function c(t){var n=await o("WebReverbDB").makeWebReverb(t.name,t.strEncKey,t.blockingErrorThreshold,t.onBlockingError,t.qplEvent),a=n.isNewDb;await o("MAWWormMaintenanceDbSetup").mawWormDbMaintenanceDbSetup();var i=[];if(a?i=s.map(function(e){return{migrationName:e,ready:!0}}):i=await Promise.all(s.map(async function(e){var t=await o("WormDbMigrationScheduler").getDbMigrationStateByName(e);return{migrationName:e,ready:(t==null?void 0:t.finishedAtMs)!=null}})),r("BrowserLockManager")==null){i.forEach(function(e){o("MAWMpsMigrationStatus").setDbMigrationState(e.migrationName,e.ready)});return}var l=await r("BrowserLockManager").query(),c=l.held.some(function(t){return t.name===e});if(c){s.forEach(function(e){o("MAWMpsMigrationStatus").setDbMigrationState(e,!0)});return}i.forEach(function(e){var t="LOCK_NOT_READY_MIGRATION-"+e.migrationName;if(e.ready){var n=l.held.some(function(e){return e.name===t})||l.pending.some(function(e){return e.name===t});n?o("MAWMpsMigrationStatus").setDbMigrationState(e.migrationName,!1):o("MAWMpsMigrationStatus").setDbMigrationState(e.migrationName,!0)}else o("MAWMpsMigrationStatus").setDbMigrationState(e.migrationName,!1),u.set(e.migrationName,r("BrowserLockManager").request(t,function(){return new Promise(function(){})}))})}l.initReverb=c}),98);
__d("QPLMultiplexedFlow",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=Array.from(new Set(e));return{addAnnotations:function(n){t.forEach(function(e){return e.addAnnotations(n)})},addPoint:function(n,r){t.forEach(function(e){return e.addPoint(n,r)})},endCancel:function(n,r){t.forEach(function(e){return e.endCancel(n,r)})},endFail:function(n,r){t.forEach(function(e){return e.endFail(n,r)})},endSuccess:function(n){t.forEach(function(e){return e.endSuccess(n)})},getQPLAttrs:function(){return t.map(function(e){return e.getQPLAttrs()})[0]},isActive:function(){return t.some(function(e){return e.isActive()})},start:function(){}}}i.makeQplMultiplexedFlow=e}),66);
__d("WebMpsGetDistinctSupplementals",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=new Map(e),r=new Map;return t.forEach(function(e,t){var o=n.get(t);if(o==null)n.set(t,e),r.set(t,e);else{var a=o.timestampMs,i=e.timestampMs;i>a&&(n.set(t,e),r.set(t,e))}}),{supplementals:n,supplementalsToWriteToReverb:r}}i.getDistinctSupplementals=e}),66);
__d("WebMpsGetDistinctMessages",["WebMpsGetDistinctSupplementals"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"],s=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function u(t,n){var r=new Map,a=new Map;t.forEach(function(t){var n=t.reverbTopLevel,o=n.debugFlags,i=n.expiryTimestampMs,l=n.isLocalOnlyMessage,s=n.isTransportErrorPlaceholder,u=n.pk,c=babelHelpers.objectWithoutPropertiesLoose(n,e);a.set(t.reverbTopLevel.messageId,t),r.set(t.reverbTopLevel.messageId,{expiryTimestampMs:i,supplementalProtobufs:t.supplementalProtobufs,tags:t.tags,toplevelProtobuf:c})});var i=new Map,l=new Map,u=new Map;return n.forEach(function(e){var t=e.supplementalProtobufs,n=e.tags,c=e.toplevelProtobuf,d=c.messageId,m=a.get(d);if(m==null||m.reverbTopLevel.isTransportErrorPlaceholder===!0)r.set(d,e),i.set(d,c),l.set(d,new Map(t)),u.set(d,n);else{var p=m.supplementalProtobufs,_=o("WebMpsGetDistinctSupplementals").getDistinctSupplementals(p,t),f=_.supplementals,g=_.supplementalsToWriteToReverb,h=m.reverbTopLevel,y=h.debugFlags,C=h.expiryTimestampMs,b=h.isLocalOnlyMessage,v=h.isTransportErrorPlaceholder,S=h.pk,R=babelHelpers.objectWithoutPropertiesLoose(h,s);r.set(d,{expiryTimestampMs:C,supplementalProtobufs:f,tags:m.tags,toplevelProtobuf:R}),g.size>0&&l.set(d,new Map(g))}}),{messages:Array.from(r.values()),supplementalMessagesToWriteToReverb:l,tagsToWriteToReverb:u,topLevelMessagesToWriteToReverb:i}}l.getDistinctMessages=u}),98);
__d("WebMpsGetIsMessageExpired",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e!=null&&o("WATimeUtils").cappedMillisecondsUntil(o("WATimeUtils").castMilliSecondsToUnixTime(e))<=0}l.getIsMessageExpired=e}),98);
__d("WebMpsReverbWrites",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n,r,o,a,i){var l=[o,r,n];return i(async function(i){var s,u=await i.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",l);if(!(((s=u==null?void 0:u.timestampMs)!=null?s:0)>=a)){var c={messageId:e,payload:t,supplementalKey:n,threadId:o,timestampMs:a,topLevelMessageId:r};await i.stores.supplemental.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:c,selector:l}])}})}function l(e,t,n){var r=e.messageId,o=e.threadId;return n(async function(n){var a,i=await n.stores.message.getByIndex("[threadId+messageId]",[o,r]);if(!(i!=null&&!i.isTransportErrorPlaceholder)&&!(i!=null&&i.isTransportErrorPlaceholder&&t.isTransportErrorPlaceholder)){var l=await n.stores.deleted.getByIndex("[threadId+deletedMessageId]",[e.threadId,e.messageId]),s=babelHelpers.extends({},e,{debugFlags:t.debugFlags,expiryTimestampMs:t.expiryTimestampMs,isLocalOnlyMessage:t.isLocalOnly,isTransportErrorPlaceholder:t.isTransportErrorPlaceholder,timestampMs:(a=i==null?void 0:i.timestampMs)!=null?a:e.timestampMs});if(l)l.payload=s.payload,await n.stores.deleted.bulkPut([l]),i!=null&&(i.timestampMs=e.timestampMs,await n.stores.message.bulkPut([i]));else{var u=await n.stores.message.bulkUpsert("[threadId+messageId]",[{item:s,selector:[o,r]}]),c=u[0],d=await n.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[o,r]});d.length>0&&await n.stores.tags.bulkDelete(d.map(function(e){return e.pk})),t.tags.length>0&&await n.stores.tags.bulkAdd(t.tags.map(function(e){return{messageId:s.messageId,messagePk:c,tag:e,threadId:s.threadId,timestampMs:s.timestampMs}}))}}})}i.upsertSupplementalToReverb=e,i.upsertTopLevelToReverb=l}),66);
__d("WebMpsPersistMessagesFromEb",["FBLogger","MpsLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e;async function s(t){if(!(t.length===0||t.every(function(e){return e.topLevelProtobufs.size===0&&e.supplementalProtobufs.size===0&&e.tags.size===0})))try{await o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(n){var o=t.map(function(t){var o=t.supplementalProtobufs,a=t.tags,i=t.threadId,l=t.topLevelProtobufs;return r("FBLogger")("mps").INFO(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Persisting EB messages thread: "," topLevelProtobufs: "," supplementalProtobufs: ",""])),i,Array.from(l.keys()).join(","),Array.from(o.keys()).join(",")),u(l,o,a,i,function(e){return e(n)})}).flat();return Promise.all(o)},"mps-persist-messages-from-eb")}catch(e){var n=r("getErrorSafe")(e);throw o("MpsLogger").MpsLogger().catching(n).mustfix("Runtime error performing persistMessagesFromEB"),n}}function u(e,t,n,r,a){var i=[];return e.forEach(function(e,t){var r;i.push(o("WebMpsReverbWrites").upsertTopLevelToReverb(e,{actionType:o("MpsTypes").ActionType.UpsertTopLevel,debugFlags:["EB"],isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:(r=n.get(t))!=null?r:[],targetMessageId:t},a))}),t.forEach(function(e,t){e.forEach(function(e,n){i.push(o("WebMpsReverbWrites").upsertSupplementalToReverb(e.messageId,e.payload,n,t,r,e.timestampMs,a))})}),i}l.persistMessagesFromEB=s}),98);
__d("groupBy",[],(function(t,n,r,o,a,i){function e(e,t){return e.reduce(function(e,n){return(e[t(n)]=e[t(n)]||[]).push(n),e},{})}i.default=e}),66);
__d("WebMpsBatchLoadMessage",["CoalescingLoader","MpsLogger","QPLMultiplexedFlow","WebMpsGetDistinctMessages","WebMpsGetIsMessageExpired","WebMpsPersistMessagesFromEb","WebReverbDB","getErrorSafe","getSafeQplErrorMessage","groupBy"],(function(t,n,r,o,a,i,l){"use strict";var e=["messageId"],s=["config","ctx","messageId","threadId"],u=["pk","supplementalKey","threadId","topLevelMessageId"],c=(function(){function t(t){var n=this;this.$3=async function(t){var a=r("groupBy")(t,function(e){return n.$4(e)}),i=new Map;return await Promise.all(Object.entries(a).map(async function(t){var r=t[0],a=t[1],l=a.map(function(e){return e.ctx.metric}),s=o("QPLMultiplexedFlow").makeQplMultiplexedFlow(l);s.addAnnotations({int:{coalesced_batch_size:a.length}});var u=a[0],c=u.messageId,d=babelHelpers.objectWithoutPropertiesLoose(u,e),m=babelHelpers.extends({},d,{ctx:{metric:s},messageIds:a.map(function(e){return e.messageId})}),p=await n.batchLoad(m);i.set(r,p)})),t.map(function(e){var t=i.get(n.$4(e));return t==null?void 0:t.find(function(t){return(t==null?void 0:t.toplevelProtobuf.messageId)===e.messageId})})},this.$1=t,this.$2=new(o("CoalescingLoader")).CoalescingLoader(this.$3)}var n=t.prototype;return n.$4=function(t){var e=t.config,n=t.ctx,r=t.messageId,o=t.threadId,a=babelHelpers.objectWithoutPropertiesLoose(t,s);return JSON.stringify({config:e,threadId:o})},n.$5=async function(t,n,a,i){try{i.metric.addPoint("load-message-from-reverb_start");var e=o("WebReverbDB").getWebReverbDB(),l=await e.runInTransaction(["message","supplemental","tags"],"readonly",function(e){return Promise.all(n.map(function(n){var r=e.stores.message.readIndex("[threadId+messageId]",[t,n],{limit:1}),o=a.shouldFetchTags?e.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[t,n]}):[],i=a.shouldFetchSupplementals?e.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[t,n]}):[];return Promise.all([n,r,i,o])}))},"mps-load-message");i.metric.addPoint("load-message-from-reverb_end");var s=new Map;return l.forEach(function(e){var t=e[0],n=e[1],r=n[0],a=e[2],i=e[3];if(r==null||o("WebMpsGetIsMessageExpired").getIsMessageExpired(r.expiryTimestampMs))return null;var l=new Map;a.forEach(function(e){var t=e.pk,n=e.supplementalKey,r=e.threadId,o=e.topLevelMessageId,a=babelHelpers.objectWithoutPropertiesLoose(e,u);l.set(n,a)});var c=i.map(function(e){var t=e.tag;return t});s.set(t,{reverbTopLevel:r,supplementalProtobufs:l,tags:c})}),s}catch(e){return i.metric.addPoint("load-message-from-reverb_fail"),o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("Runtime error performing loadMessageFromReverb"),new Map}},n.$6=async function(t,n,a){try{var e=this.$1,i=e.decryptedProtobufToFullMessage,l=e.eb,s=l.isEbEnabled(),u=s===!0?"true":s===!1?"false":"unset";if(a.metric.addAnnotations({string:{ebEnabled:u}}),s!==!0)return new Map;a.metric.addPoint("load-message-from-eb_start");var c=l.messagePointQuery,d=await c({ctx:a,messageIds:n,threadId:t});if(d.success===!1)return new Map;var m=i(d.value,t);return a.metric.addPoint("load-message-from-eb_end"),new Map(m.map(function(e){return[e.toplevelProtobuf.messageId,e]}))}catch(e){a.metric.addPoint("load-message-from-eb_fail");var p=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(p).mustfix("Runtime error performing loadFromEB"),new Map}},n.batchLoad=async function(t){var e=this,n=t.config,a=t.ctx,i=t.messageIds,l=t.threadId;try{a.metric.addPoint("load-message_start");var s=function(){return e.$5(l,i,n,a)},u=function(){return e.$6(l,i,a)},c=n.strategy==="local-first"?async function(){var e=await s(),t=e.size===i.length;return t?[e,new Map]:[e,await u()]}:n.strategy==="full-fetch"?function(){return Promise.all([s(),u()])}:n.strategy==="local-only"?async function(){return[await s(),new Map]}:n.strategy==="remote-only"?async function(){return[new Map,await u()]}:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+n.strategy)})(),d=await c(),m=d[0],p=d[1],_=i.map(function(e){var t=m.get(e),n=p.get(e);return o("WebMpsGetDistinctMessages").getDistinctMessages([t].filter(Boolean),[n].filter(Boolean))});return n.persistToReverb==="persist"&&o("WebMpsPersistMessagesFromEb").persistMessagesFromEB(_.map(function(e){var t=e.supplementalMessagesToWriteToReverb,n=e.tagsToWriteToReverb,r=e.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:t,tags:n,threadId:l,topLevelProtobufs:r}})),a.metric.addPoint("load-message_end"),_.map(function(e){return e.messages[0]})}catch(e){var f=r("getErrorSafe")(e);throw a.metric.addPoint("load-message_fail",{string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(f)}}),o("MpsLogger").MpsLogger().catching(f).mustfix("Runtime error performing loadMessage"),f}},n.load=function(t){return this.$2.gen(t)},t})();l.WebMpsPointQueryApi=c}),98);
__d("PackedMpsRange",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.packMpsRange=e}),66);
__d("WebMpsBatchLoadFromReverb",["MpsLogger","WebMpsGetIsMessageExpired","WebReverbDB","WormRangeIterator","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=["pk","supplementalKey","threadId","topLevelMessageId"];async function s(t,n,r,a,i,l,s,u,c,d,m){var p,_=r[0],f=r[1],g=u?function(e){return e.isLocalOnlyMessage===!1}:function(e){return!0},h=function(t){return!o("WebMpsGetIsMessageExpired").getIsMessageExpired(t.expiryTimestampMs)},y=function(t){return g(t)&&h(t)};function C(){var e=t.stores.message.getIndexRangeIterator("[threadId+timestampMs+messageId]",a,{greaterThanOrEqual:[n],lessThanOrEqual:[n]},y),r=f==null?[n,_]:[n,_,f];return e.read(r,i)}async function b(e){var r="[threadId+tag+timestampMs]",l=await Promise.all(Array.from(e).map(function(e){return t.stores.tags.getIndexRangeIterator(r,a,{greaterThanOrEqual:[n,e],lessThanOrEqual:[n,e]}).read([n,e,_],i)})),s=o("WormRangeIterator").mergeRanges(l,["timestampMs","messageId"],a,i),u=await Promise.all(s.data.map(function(e){return t.stores.message.getByIndex("[threadId+messageId]",[e.threadId,e.messageId],{filter:y})})).then(function(e){return e.filter(Boolean)}),c=o("WormRangeIterator").makeCursorInfoFromList(u,["threadId","timestampMs","messageId"],s.cursorInfo.hasNext,s.cursorInfo.hasPrevious);return{cursorInfo:c,data:u}}var v;c!=="all"?(d.metric.addPoint("load_messages_with_tags_"+m+"_start"),v=await b(c),d.metric.addPoint("load_messages_with_tags_"+m+"_end")):(d.metric.addPoint("load_messages_canoincal_"+m+"_start"),v=await C(),d.metric.addPoint("load_messages_canonical_"+m+"_end"));var S=v,R=S.cursorInfo,L=S.data;d.metric.addPoint("load_message_results_"+m+"_start"),d.metric.addAnnotations({bool:{shouldFetchTags:s}});var E=await Promise.all(L.map(async function(r){var o=l?await t.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[n,r.messageId]}):[],a=new Map;o.forEach(function(t){var n=t.pk,r=t.supplementalKey,o=t.threadId,i=t.topLevelMessageId,l=babelHelpers.objectWithoutPropertiesLoose(t,e);a.set(r,l)});var i=s?await t.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[n,r.messageId]}):[],u=i.map(function(e){var t=e.tag;return t});return{reverbTopLevel:r,supplementalProtobufs:a,tags:u}})),k=E.reduce(function(e,t){return e+t.supplementalProtobufs.size},0);return d.metric.addAnnotations({int:(p={},p["supplementalCount_"+m]=k,p)}),d.metric.addPoint("load_message_results_"+m+"_end"),{cursorInfo:{endCursor:R.endCursor!=null?[R.endCursor[1],R.endCursor[2]]:null,hasNext:R.hasNext,hasPrevious:R.hasPrevious,startCursor:R.startCursor!=null?[R.startCursor[1],R.startCursor[2]]:null},messages:E,threadId:n}}async function u(e,t,n,a,i,l){try{i.metric.addPoint("reverb_fetch_start");var u=o("WebReverbDB").getWebReverbDB(),c=new Map(await u.runInTransaction(["message","supplemental","tags"],"readonly",function(r){return Promise.all(e.map(function(e,o){return s(r,e.threadId,e.from,e.direction,e.numMessages,t,n,a,l,i,o).then(function(t){return[e,t]})}))},"mps-load-messages"));return i.metric.addPoint("reverb_fetch_end"),c}catch(e){var d=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(d).mustfix("Runtime error performing WebMpsBatchLoadFromReverb"),i.metric.addPoint("reverb_fetch_end",{bool:{reverbFail:!0}}),new Map}}l.batchLoadMessagesFromReverb=u}),98);
__d("WebMpsLoadMessagesFromEb",["MpsLogger","WAPromiseDelays","WAResultOrError","getErrorSafe","getSafeQplErrorMessage","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e={endCursor:null,hasNext:!1,hasPrevious:!1,startCursor:null};async function s(e,t,n,a,i,l){function s(){throw a.metric.addPoint("eb_fetch_timeout"),o("MpsLogger").MpsLogger().mustfixThrow("Timed out waiting for EB Fetch")}var u=e.reduce(function(e,t){return e+t.numMessages},0),c=Math.min(Math.max((u-20)/180,0),1),d=r("justknobx")._("3429")*(1+c*2),m=await o("WAPromiseDelays").withTimeout(t.messageRangeQuery({ctx:a,ranges:e,source:l,tagsFilter:i}),d,s),p=m.map(function(t,r){var a=e[r],i=a.threadId;if(t.success===!1)return t;var l=t.value,s=l.cursorInfo,u=l.messages,c=n(u,i);return o("WAResultOrError").makeResult({cursorInfo:s,messages:c,threadId:i})});return a.metric.addPoint("eb_fetch_end"),p}async function u(t,n,a,i,l){var u=n.decryptedProtobufToFullMessage,c=n.eb;try{var d=c.isEbEnabled(),m=d===!0?"true":d===!1?"false":"unset";if(a.metric.addAnnotations({string:{ebEnabled:m}}),d!==!0)return new Map(t.map(function(t){return[t,o("WAResultOrError").makeResult({cursorInfo:e,messages:[],threadId:t.threadId})]}));var p=!1;a.metric.addPoint("load-messages-from-eb_start");var _=await s(t,c,u,a,i,l),f=new Map(t.map(function(e,t){var n=_[t];return n.success===!1&&(p=!0),[e,n]}));return p&&a.metric.addAnnotations({bool:{ebFetchFailed:!0}}),a.metric.addPoint("load-messages-from-eb_end"),f}catch(e){var g=r("getErrorSafe")(e);return a.metric.addPoint("load-messages-from-eb_fail",{string:{ebFetchFailReason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}}),o("MpsLogger").MpsLogger().catching(g).mustfix("Error fetching from EB"),new Map}}l.loadMessagesFromEb=u}),98);
__d("WebMpsMergeMessageRangesFromDifferentSources",["WebMpsGetDistinctMessages","err","first","last"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function s(t,n,a,i,l){var s,u,c=o("WebMpsGetDistinctMessages").getDistinctMessages((s=n==null?void 0:n.messages)!=null?s:[],(u=t==null?void 0:t.messages)!=null?u:[]),d=c.messages,m=c.supplementalMessagesToWriteToReverb,p=c.tagsToWriteToReverb,_=c.topLevelMessagesToWriteToReverb;if(n==null||t==null){var f=n!=null?babelHelpers.extends({},n,{messages:n.messages.map(function(t){var n=t.reverbTopLevel,r=t.supplementalProtobufs,o=n.debugFlags,a=n.expiryTimestampMs,i=n.isLocalOnlyMessage,l=n.isTransportErrorPlaceholder,s=n.pk,u=babelHelpers.objectWithoutPropertiesLoose(n,e);return{expiryTimestampMs:a,supplementalProtobufs:r,tags:[],toplevelProtobuf:u}})}):t;if(f==null)throw r("err")("data-fetching-error");return{range:f,supplementalMessagesToWriteToReverb:m,tagsToWriteToReverb:p,topLevelMessagesToWriteToReverb:_}}var g=t,h=[].concat(d).sort(function(e,t){return a==="asc"?e.toplevelProtobuf.timestampMs-t.toplevelProtobuf.timestampMs:t.toplevelProtobuf.timestampMs-e.toplevelProtobuf.timestampMs}),y=h.slice(0,i),C=r("first")(y),b=r("last")(y),v=C!=null?[C.toplevelProtobuf.timestampMs,C.toplevelProtobuf.messageId]:void 0,S=b!=null?[b.toplevelProtobuf.timestampMs,b.toplevelProtobuf.messageId]:void 0,R=S!=null?g.cursorInfo.hasNext||n.cursorInfo.hasNext:!1,L=v!=null?g.cursorInfo.hasPrevious||n.cursorInfo.hasPrevious:!1;return{range:{cursorInfo:{endCursor:S,hasNext:R,hasPrevious:L,startCursor:v},messages:y,threadId:l},supplementalMessagesToWriteToReverb:m,tagsToWriteToReverb:p,topLevelMessagesToWriteToReverb:_}}l.mergeMessageRangesFromDifferentSources=s}),98);
__d("WebMpsEbCache",["MpsTypes","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a,i){var l=o("WAJids").validateChatJid(t);if(l==null)return[];var s=e.getMetadataFromCache({chatJid:l,direction:n,numberOfMessages:r,referenceMessage:i,referenceTimestamp:a==null?null:o("WATimeUtils").castToMillisTime(a)});return s.success===!1?[]:s.value.map(function(e){var t=e.offlineThreadingId,n=e.sortOrderMs;return{offlineThreadingId:t,sortOrderMs:o("MpsTypes").toTimestamp(n)}})}function s(e,t){if(e==null||t.length===0)return"no-match";if(e.cursorInfo.hasNext!==!0)return"reverb-cursor-ended";var n=new Set(e.messages.map(function(e){return e.reverbTopLevel.messageId})),r=new Set(t.map(function(e){return e.offlineThreadingId}));if(n.size!==r.size)return"no-match";if(Array.from(n).every(function(e){return r.has(e)}))return"match";for(var o=e.messages.map(function(e){return e.reverbTopLevel.timestampMs}).sort(function(e,t){return t-e}),a=t.map(function(e){return e.sortOrderMs}).sort(function(e,t){return t-e}),i=0,l=0;l<o.length;l++){var s=o[l],u=a[i];if(s<u)return"no-match";s>u||i++}return"reverb-newer"}l.loadEBMetadataCache=e,l.compareReverbVsMetadataCache=s}),98);
__d("WebMpsValidateReverbViaCacheAndFetchFromEb",["MpsLogger","WebMpsEbCache","WebMpsLoadMessagesFromEb"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n,r,a){var i=await t;if(a!=="all")return r.metric.addAnnotations({string:{ebMetadataCache:"skip"}}),{eb:await o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(e,n,r,a),reverb:i};var l=e.filter(function(e){var t=e.direction,a=e.from,l=e.numMessages,s=e.threadId,u=o("WebMpsEbCache").loadEBMetadataCache(n.eb,s,t,l,a[0],a[1]),c=o("WebMpsEbCache").compareReverbVsMetadataCache(i.get(e),u);return r.metric.addAnnotations({string:{ebMetadataCache:c}}),o("MpsLogger").MpsLogger().debug("MPS Range query metadata comparison: ",c),!(c==="match"||t==="desc"&&c==="reverb-newer")});return l.length===0?{eb:new Map,reverb:i}:{eb:await o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(l,n,r,a),reverb:i}}l.validateReverbViaCacheAndFetchFromEb=e}),98);
__d("WebMpsBatchLoadMessages",["MpsLogger","PackedMpsRange","WebMpsBatchLoadFromReverb","WebMpsLoadMessagesFromEb","WebMpsMergeMessageRangesFromDifferentSources","WebMpsPersistMessagesFromEb","WebMpsValidateReverbViaCacheAndFetchFromEb","err","getErrorSafe","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n,a){var i=n.persistToReverb,l=n.shouldFetchSupplementals,s=n.shouldFetchTags,u=n.shouldIgnoreLocalOnly,c=n.source,d=n.strategy,m=n.tagsFilter,p=e.map(function(e){return o("PackedMpsRange").packMpsRange(e)});try{a.metric.addPoint("mps_fetch_start");var _=function(){return o("WebMpsBatchLoadFromReverb").batchLoadMessagesFromReverb(p,l,s,u,a,m)},f,g;switch(d){case"full-fetch":{var h=await o("WebMpsValidateReverbViaCacheAndFetchFromEb").validateReverbViaCacheAndFetchFromEb(p,_(),t,a,m);f=h.reverb,g=h.eb;break}case"local-only":f=await _(),g=new Map;break;case"remote-only":g=await o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(p,t,a,m,c),f=new Map;break;default:throw r("err")("empty strategy")}var y=p.map(function(e){var t,n=e.direction,r=e.numMessages,a=e.threadId,i=f.get(e),l=(t=g.get(e))==null?void 0:t.value;if(!(i==null&&l==null)){var s=o("WebMpsMergeMessageRangesFromDifferentSources").mergeMessageRangesFromDifferentSources(l,i,n,r,a),u=s.range,c=s.supplementalMessagesToWriteToReverb,d=s.tagsToWriteToReverb,m=s.topLevelMessagesToWriteToReverb;return{range:u,supplementalMessagesToWriteToReverb:c,tagsToWriteToReverb:d,threadId:a,topLevelMessagesToWriteToReverb:m}}}).filter(Boolean);return i==="persist"&&o("WebMpsPersistMessagesFromEb").persistMessagesFromEB(y.map(function(e){var t=e.supplementalMessagesToWriteToReverb,n=e.tagsToWriteToReverb,r=e.threadId,o=e.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:t,tags:n,threadId:r,topLevelProtobufs:o}})),y.map(function(e){var t=e.range;return t})}catch(e){var C=r("getErrorSafe")(e);throw o("MpsLogger").MpsLogger().catching(C).mustfix("Runtime error performing loadMessages"),a.metric.addAnnotations({string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(C)}}),C}}l.batchLoadMessages=e}),98);
__d("MAWMpsCleanersContants",["DateConsts"],(function(t,n,r,o,a,i,l){"use strict";var e=30*o("DateConsts").MS_PER_DAY,s=6*o("DateConsts").MS_PER_HOUR;l.PURGE_DELETED_MESSAGES_WINDOW_IN_MS=e,l.REPORTING_WINDOW_IN_MS=s}),98);
__d("WebMpsInsertionCleaners",["MAWMpsCleanersContants","MpsDeletedCleaner","MpsEphemeralCleaner","MpsLogger","MpsTypes","WATimeUtils","err","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){try{await Promise.all(e.map(s)),await Promise.all(e.map(c))}catch(e){var t=r("getErrorSafe")(e);o("MpsLogger").MpsLogger().catching(t).mustfix("Failed to run side effects")}}function s(e){return e.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevel||e.directive.actionType===o("MpsTypes").ActionType.DeleteSupplemental||e.directive.actionType===o("MpsTypes").ActionType.DeleteThread?u(e.message.timestampMs):e.directive.actionType===o("MpsTypes").ActionType.UpsertTopLevel||e.directive.actionType===o("MpsTypes").ActionType.UpsertSupplemental||e.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder||e.directive.actionType===o("MpsTypes").ActionType.Noop?Promise.resolve():e.directive.actionType===o("MpsTypes").ActionType.Unknown||e.directive.actionType===o("MpsTypes").ActionType.Preprocess?Promise.reject(r("err")("this should not happen")):(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e.directive.actionType)})()}function u(e){var t=o("WATimeUtils").castToUnixTime(Math.ceil((e+o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS)/1e3));return o("MpsDeletedCleaner").addNewMpsDeletedTimestamp(t),Promise.resolve()}function c(e){var t,n=(t=e.directive)==null?void 0:t.expiryTimestampMs;if(n==null)return Promise.resolve();var r=o("WATimeUtils").castToUnixTime(Math.ceil(n/1e3));return o("MpsEphemeralCleaner").addNewMpsEphemeralTimestamp(r),Promise.resolve()}l.scheduleCleaners=e}),98);
__d("WebMpsInsertionFlow",["MpsLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB","err","getErrorSafe","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){try{return await o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",async function(t){for(var n of e)await u(n,function(e){return e(t)})},"mps-insertion-flow-shared"),new Map}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("Failed to persist messages")}return s(e)}async function s(e){var t=new Map,n=async function(n){await u(n,function(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(t){return e(t)},"mps-insertion-flow-separate")}).catch(function(e){t.set(n.message.messageId,e)})};for(var r of e)await n(r);return t}function u(e,t){switch(e.directive.actionType){case o("MpsTypes").ActionType.UpsertTopLevel:return c(e,t);case o("MpsTypes").ActionType.UpsertSupplemental:return d(e,t);case o("MpsTypes").ActionType.DeleteTopLevel:return m(e,t);case o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return p(e,t);case o("MpsTypes").ActionType.DeleteSupplemental:return _(e,t);case o("MpsTypes").ActionType.DeleteThread:return f(e,t);case o("MpsTypes").ActionType.Noop:return Promise.resolve();case o("MpsTypes").ActionType.Unknown:case o("MpsTypes").ActionType.Preprocess:return Promise.reject(r("err")("this should not happen"))}}async function c(e,t){var n=e.directive,r=e.message;await o("WebMpsReverbWrites").upsertTopLevelToReverb(r,n,t)}async function d(e,t){var n=e.directive,a=e.message,i=r("nullthrows")(n.supplementalKey);await o("WebMpsReverbWrites").upsertSupplementalToReverb(a.messageId,a.payload,i,n.targetMessageId,a.threadId,a.timestampMs,t)}function m(e,t){var n=e.message,r=e.directive.targetMessageId,o=[n.threadId,r];return t(async function(e){var t,a=await e.stores.message.getByIndex("[threadId+messageId]",o),i=await e.stores.deleted.getByIndex("[threadId+deletedMessageId]",o);if(!(((t=i==null?void 0:i.deletionTimestampMs)!=null?t:0)>=n.timestampMs)){var l={deletedMessageId:r,deletionMessageId:n.messageId,deletionMessagePayload:n.payload,deletionTimestampMs:n.timestampMs,isLocalOnlyMessage:!1,payload:a==null?void 0:a.payload,threadId:n.threadId,timestampMs:a==null?void 0:a.timestampMs};await e.stores.deleted.bulkUpsert("[threadId+deletedMessageId]",[{item:l,selector:o}]),a&&await e.stores.message.bulkDelete([a.pk])}})}function p(e,t){var n=e.directive,r=e.message;return o("WebMpsReverbWrites").upsertTopLevelToReverb(r,n,t)}function _(e,t){var n=e.message,o=r("nullthrows")(e.directive.supplementalKey),a=e.directive.targetMessageId,i=[n.threadId,a,o];return t(async function(t){var r=await t.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",i);if(r!=null){var l=await t.stores.deleted.getByIndex("[threadId+topLevelMessageId+supplementalKey]",i,{filter:function(t){return t.deletionTimestampMs>=n.timestampMs}});if(!l){var s={deletedMessageId:r.messageId,deletionMessageId:n.messageId,deletionMessagePayload:n.payload,deletionTimestampMs:n.timestampMs,isLocalOnlyMessage:e.directive.isLocalOnly,payload:r.payload,supplementalKey:o,threadId:n.threadId,timestampMs:r.timestampMs,topLevelMessageId:a};await t.stores.deleted.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:s,selector:i}]),await t.stores.supplemental.bulkDelete([r.pk])}}})}function f(e,t){var n=e.message;return t(async function(e){var t=await e.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[n.threadId]});await e.stores.supplemental.bulkDelete(t);var r=await e.stores.message.readIndexRange("[threadId+messageId]",{only:[n.threadId]});await e.stores.message.bulkDelete(r.map(function(e){return e.pk}));var o=await e.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:[n.threadId]});await e.stores.tags.bulkDelete(o);var a=await e.stores.deleted.readKeysByIndexRange("[threadId+deletedMessageId]",{only:[n.threadId]});await e.stores.deleted.bulkDelete(a),await e.stores.deleted.bulkAdd(r.map(function(e){return{deletedMessageId:e.messageId,deletionMessageId:n.messageId,deletionMessagePayload:n.payload,deletionTimestampMs:n.timestampMs,isLocalOnlyMessage:e.isLocalOnlyMessage,payload:e.payload,threadId:e.threadId,timestampMs:e.timestampMs}}))})}l.persistNewMessages=e}),98);
__d("WebMpsLoadDeletedMessages",["MpsTypes","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";var e=["pk","supplementalKey","threadId","topLevelMessageId"];async function s(t,n){var r=o("WebReverbDB").getWebReverbDB(),a=await r.runInTransaction(["deleted","supplemental"],"readonly",async function(n){var r=await n.stores.deleted.readIndexRange("[threadId+timestampMs+deletedMessageId]",{lessThanOrEqual:[t.threadId,o("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER)]},{limit:t.numMessages});return Promise.all(r.map(async function(r){var o=await n.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[t.threadId,r.deletedMessageId]}),a=new Map;return o.forEach(function(t){var n=t.pk,r=t.supplementalKey,o=t.threadId,i=t.topLevelMessageId,l=babelHelpers.objectWithoutPropertiesLoose(t,e);a.set(r,l)}),{deletedEntity:r,supplementalProtobufs:a}}))},"get-deleted-messages-for-spam-report"),i=a.map(function(e){if(e.deletedEntity.payload!=null){var r=e.deletedEntity.payload;if(e.deletedEntity.timestampMs!=null){var o=e.deletedEntity.timestampMs;return n([{otid:e.deletedEntity.deletedMessageId,supplementalProtobufs:new Map(e.supplementalProtobufs.entries().map(function(e){var t=e[0],n=e[1];return[t,{decryptedProtobuf:n.payload,protobufTimestampMS:n.timestampMs}]})),tags:[],toplevelProtobuf:{decryptedProtobuf:r,protobufTimestampMS:o}}],t.threadId)[0]}}}).filter(Boolean);return{messages:i,tombstones:new Set(a.map(function(e){return e.deletedEntity.deletionMessageId}))}}l.loadDeletedMessages=s}),98);
__d("WebMpsPostprocess",["MpsLogger","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n){await Promise.all(t.map(async function(t){var r=t.process(e,n),a=r instanceof Promise?await r.catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("PostProcessor Runtime failure")}):r;a!=null&&a.size>0&&a.forEach(function(e,t){o("MpsLogger").MpsLogger().catching(e).mustfix("Non-critical postprocessor fails %s",t)})})).catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("Non-critical postprocessors runtime failure")})}async function s(e,t,n){var r=new Map,a=async function(a){n.messageToQpl.all(e.map(function(e){return e.message.messageId})).addPoint(a.name+"_start");var t=a.process(e,n),i=t instanceof Promise?await t.catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("PostProcessor Runtime failure")}):t;i!=null&&i.size>0&&i.forEach(function(e,t){r.set(t,e),o("MpsLogger").MpsLogger().catching(e).mustfix("Critical postprocessor fails %s",t),n.messageToQpl.endFail(t,a.name.toLowerCase()+"-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e))}),n.messageToQpl.all(e.map(function(e){return e.message.messageId})).addPoint(a.name+"_end")};for(var i of t)await a(i);return r}l.runNonCriticalPostprocessor=e,l.runCriticalPostprocessor=s}),98);
__d("WebMpsPurgeDeletedPayload",["MAWMpsCleanersContants","MpsTypes","WATimeUtils","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",async function(t){var n=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS),r=await t.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[n]}),a=r.filter(function(e){return e.payload!=null});return e.metric.addAnnotations({int:{num_deletions:a.length}}),await t.stores.deleted.bulkPut(a.map(function(e){return babelHelpers.extends({},e,{payload:null,timestampMs:null})})),a.length},"web-mps-purge-deletions")}function s(){try{return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted"],"readonly",async function(e){var t=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS),n=await e.stores.deleted.readIndexRange("deletionTimestampMs",{greaterThan:[t]},{order:"asc"}),r=n.filter(function(e){return e.payload!=null});if(!(r.length===0||r[0].deletionTimestampMs==null))return o("WATimeUtils").castMilliSecondsToUnixTime(r[0].deletionTimestampMs+o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS)},"web-mps-next-deletion-timestamp-ms")}catch(e){throw e}}l.purgeDeletedPayload=e,l.getNextDeletionTimestampMs=s}),98);
__d("WebMpsPurgeDeletions",["MAWMpsCleanersContants","MpsTypes","WATimeUtils","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",async function(t){var n=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").PURGE_DELETED_MESSAGES_WINDOW_IN_MS),r=await t.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[n]}),a=r.map(function(e){return[e.threadId,e.deletedMessageId]});e.metric.addAnnotations({int:{num_deletions:r.length}});var i=Promise.all(a.map(function(e){return t.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:e})})).then(function(e){return e.flat()}).then(function(e){return t.stores.supplemental.bulkDelete(e)}),l=Promise.all(a.map(function(e){return t.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:e})})).then(function(e){return e.flat()}).then(function(e){return t.stores.tags.bulkDelete(e)}),s=t.stores.deleted.bulkDelete(r.map(function(e){return e.pk}));return await Promise.all([i,l,s]),r.length},"web-mps-purge-deletions")}l.purgeDeletions=e}),98);
__d("WebMpsScheduler",["WorkerScheduler","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){if(e==null){var t;e=o("WorkerScheduler").makeScheduler("MPS",{concurrency:(t=r("justknobx"))._("4338"),defaultSamplingRate:t._("4540"),maxTaskLimit:t._("4338"),maxThrottleMs:t._("4339"),timeoutMs:t._("4337")})}return e}l.mpsScheduler=s}),98);
__d("WmiMultiQplTracker",["QPLMultiplexedFlow"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map,s=(function(){function e(e){var t=this;this.$1=new Map,e.forEach(function(e){t.$1.set(e[0],e[1])})}e.from=function(n){return new e(n)};var t=e.prototype;return t.addAnnotations=function(t,n){var e;(e=this.$1.get(t))==null||e.addAnnotations(n)},t.addPoint=function(t,n,r){var e;(e=this.$1.get(t))==null||e.addPoint(n,r)},t.endSuccess=function(t){var e=this.$1.get(t);e!=null&&(e.endSuccess(),this.$1.delete(t),this.$2=null)},t.endFail=function(t,n,r){var e=this.$1.get(t);e!=null&&(e.endFail(n,{string:{errorDescription:r}}),this.$1.delete(t),this.$2=null)},t.size=function(){return this.$1.size},t.all=function(t){var e=this;if(t!=null){var n=t.map(function(t){return e.$1.get(t)}).filter(Boolean);return o("QPLMultiplexedFlow").makeQplMultiplexedFlow(n)}if(!this.$2){var r=o("QPLMultiplexedFlow").makeQplMultiplexedFlow(Array.from(this.$1.values()));return this.$2=r,r}return this.$2},t.failAllPending=function(t){this.$1.forEach(function(e){return e.endFail(t)}),this.$1.clear(),this.$2=null},e.empty_TEST_ONLY=function(){return new e([])},e})();function u(t,n){e.set(t,n)}function c(t){return e.get(t)}l.WmiMultiQplTracker=s,l.trackQplForSeqId=u,l.getQplForSeqId=c}),98);
__d("memoizeWithArgsLFUCache",["LFUCache"],(function(t,n,r,o,a,i,l){function e(e,t,n,o){var a;function i(){return a||(a=new(r("LFUCache"))(n)),a}function l(e){if(e===void 0)a=null;else{var t;(t=a)==null||t.delete(e)}}o&&o(l);var s=function(){var n=i(),r=t.apply(void 0,arguments);n.has(r)||n.set(r,e.apply(void 0,arguments));var o=n.get(r);return o};return s}l.default=e}),98);
__d("schedulePeriodicTask",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=async function(){try{await e()}finally{globalThis.setTimeout(n,t)}};globalThis.setTimeout(n,0)}i.schedulePeriodicTask=e}),66);
__d("WebMps",["DateConsts","MpsDeletedCleaner","MpsEphemeralCleaner","MpsLogger","MpsReverbDbDump","MpsReverbInit","MpsTypes","QPLFlow","WAPromiseQueue","WAResultOrError","WATimeUtils","WAWaitForUserUnblocked","WebMpsBatchLoadMessage","WebMpsBatchLoadMessages","WebMpsInsertionCleaners","WebMpsInsertionFlow","WebMpsLoadDeletedMessages","WebMpsPostprocess","WebMpsPurgeDeletedPayload","WebMpsPurgeDeletions","WebMpsPurgeExpiredMessages","WebMpsScheduler","WmiMultiQplTracker","WorkerScheduler","err","getErrorSafe","getSafeQplErrorMessage","justknobx","memoizeWithArgsLFUCache","mergeMaps","qpl","schedulePeriodicTask"],(function(t,n,r,o,a,i,l){"use strict";var e=["debug"],s=["config"],u=["debug"],c;function d(e){return JSON.stringify(e)}async function m(e){var t=e.db,n=e.dependencies,a=e.getMpsExtensionConfiguration;if(c!=null)throw r("err")("MPS already initialised");await o("MpsReverbInit").initReverb(t);var i=new p(a(),n);return c=i,i}var p=(function(){function t(t,n){var a=this;this.$3=[],this.$6=new(o("WAPromiseQueue")).PromiseQueue,this.batchLoadMessage=function(e){var t,n,i,l,s=e.config,u=e.debug,c=e.messageIds,d=e.threadId,m={persistToReverb:(t=s==null?void 0:s.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=s==null?void 0:s.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(i=s==null?void 0:s.shouldFetchTags)!=null?i:!0,strategy:(l=s==null?void 0:s.strategy)!=null?l:"full-fetch"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:u.purpose,strategy:m.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return a.$2.batchLoad({config:m,ctx:t,messageIds:c,threadId:d})},name:"batch-load-message",priority:o("WorkerScheduler").BLOCKING_PRIORITY}).then(function(e){return a.$10(e.filter(Boolean),m),o("WAResultOrError").makeResult(e)}).catch(function(e){var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in batchLoadMessage"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$11=r("memoizeWithArgsLFUCache")(function(e){var t,n,i,l,s=e.config,u=e.debug,c=e.messageId,d=e.threadId,m={persistToReverb:(t=s==null?void 0:s.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=s==null?void 0:s.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(i=s==null?void 0:s.shouldFetchTags)!=null?i:!0,strategy:(l=s==null?void 0:s.strategy)!=null?l:"full-fetch"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:u.purpose,strategy:m.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4536"),fn:async function(t){var e=await a.$2.load({config:m,ctx:t,messageId:c,threadId:d});return e!=null&&a.$10([e],m),e},name:"load-message",priority:o("WorkerScheduler").BLOCKING_PRIORITY})},function(t){var n=t.debug,r=babelHelpers.objectWithoutPropertiesLoose(t,e);return d(babelHelpers.extends({},r,{ebEnabled:a.$1.eb.isEbEnabled()}))},1,function(e){a.$3.push(e)}),this.loadMessage=function(e){return a.$11(e).then(function(e){return o("WAResultOrError").makeResult(e)}).catch(function(e){a.$7();var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in loadMessage"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$12=function(e){var t,n,i=e.config,l=e.debug,s=e.ranges;return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:l.purpose,strategy:(t=i==null?void 0:i.strategy)!=null?t:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return o("WebMpsBatchLoadMessages").batchLoadMessages(s.map(function(e){var t=e.direction,n=e.from,r=e.numMessages,a=e.threadId;return{direction:t,from:[o("MpsTypes").toTimestamp(o("WATimeUtils").miAdjustTimestamp(n[0])),n[1]],numMessages:r,threadId:a}}),a.$1,i,t)},name:"batch-load-messages",priority:(n=i.priority)!=null?n:o("WorkerScheduler").BLOCKING_PRIORITY})},this.batchLoadMessages=function(e){var t,n,i,l,u,c,d,m=e.config,p=babelHelpers.objectWithoutPropertiesLoose(e,s),_={persistToReverb:(t=m==null?void 0:m.persistToReverb)!=null?t:"persist",priority:(n=m==null?void 0:m.priority)!=null?n:o("WorkerScheduler").BLOCKING_PRIORITY,shouldFetchSupplementals:(i=m==null?void 0:m.shouldFetchSupplementals)!=null?i:!0,shouldFetchTags:(l=m==null?void 0:m.shouldFetchTags)!=null?l:!0,shouldIgnoreLocalOnly:(u=m==null?void 0:m.shouldIgnoreLocalOnly)!=null?u:!1,strategy:(c=m==null?void 0:m.strategy)!=null?c:"full-fetch",tagsFilter:(d=m==null?void 0:m.tagsFilter)!=null?d:"all"};return a.$12(babelHelpers.extends({},p,{config:_})).then(function(e){var t=e.flatMap(function(e){return e.messages});return a.$10(t,_),o("WAResultOrError").makeResult(e)}).catch(function(e){var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in batchLoadMessages"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$13=r("memoizeWithArgsLFUCache")(function(e){var t,n,i,l,s,u,c,d=e.config,m=e.debug,p=e.direction,_=e.from,f=e.numMessages,g=e.source,h=e.threadId,y={persistToReverb:(t=d==null?void 0:d.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=d==null?void 0:d.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(i=d==null?void 0:d.shouldFetchTags)!=null?i:!0,shouldIgnoreLocalOnly:(l=d==null?void 0:d.shouldIgnoreLocalOnly)!=null?l:!1,source:g,strategy:(s=d==null?void 0:d.strategy)!=null?s:"full-fetch",tagsFilter:(u=d==null?void 0:d.tagsFilter)!=null?u:"all"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:m.purpose,strategy:y.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return o("WebMpsBatchLoadMessages").batchLoadMessages([{direction:p,from:[o("MpsTypes").toTimestamp(o("WATimeUtils").miAdjustTimestamp(_[0])),_[1]],numMessages:f,threadId:h}],a.$1,y,t).then(function(e){e.length>1&&o("MpsLogger").MpsLogger().mustfix("loadMessages returned more than one range");var t=e.at(0);if(t==null)throw r("err")("loadMessages returned no result. Likely this is the result of both reverb and EB queries failing");return a.$10(t.messages,y),t})},name:"load-messages",priority:(c=d==null?void 0:d.priority)!=null?c:o("WorkerScheduler").BLOCKING_PRIORITY})},function(e){var t,n=e.debug,r=babelHelpers.objectWithoutPropertiesLoose(e,u);return d(babelHelpers.extends({},r,{config:babelHelpers.extends({},r.config,{tagsFilter:(function(e){if(e==="all"||e===void 0)return"all";{var t=e;return Array.from(t.values())}})((t=r.config)==null?void 0:t.tagsFilter)}),ebEnabled:a.$1.eb.isEbEnabled()}))},10/60,function(e){a.$3.push(e)}),this.loadMessages=function(e){return a.$13(e).then(function(e){return o("WAResultOrError").makeResult(e)}).catch(function(e){a.$7();var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Runtime error in loadMessages"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.extensionConfiguration=t,this.$1=n,this.$2=new(o("WebMpsBatchLoadMessage")).WebMpsPointQueryApi(n),this.$4(),this.$5(function(e){return n.generateDeletionMessage(e)})}var n=t.prototype;return n.saveNewMessages=function(t,n){var e=this,a=o("WebMpsScheduler").mpsScheduler().task({annotations:{string:{source:n.source}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4535"),fn:async function(){e.$7();var n={messageToQpl:o("WmiMultiQplTracker").WmiMultiQplTracker.from(t.map(function(e){return[e.message.messageId,o("QPLFlow").startQPLFlow(r("qpl")._(1056834650,"494"),{annotations:{string:{messageId:e.message.messageId,senderId:e.message.senderId,threadId:e.message.threadId}}})]}))};n.messageToQpl.all(t.map(function(e){return e.message.messageId})).addPoint("preprocess_start");var a=await e.extensionConfiguration.preprocessors.run({ctx:n,payloadList:t}),i=a.errors,l=a.payloadList;n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("preprocess_end"),i.entries().forEach(function(e){var t=e[0],r=e[1];n.messageToQpl.endFail(t,"preprocess-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r))}),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("schedule_cleaners_start"),await o("WebMpsInsertionCleaners").scheduleCleaners(l),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("schedule_cleaners_end"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persist_start");var s=await o("WebMpsInsertionFlow").persistNewMessages(l);n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persist_end"),s.entries().forEach(function(e){var t=e[0],r=e[1];n.messageToQpl.endFail(t,"persist-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r))}),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persisted"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("critical_postprocess_start");var u=await e.$8(l,n);return n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("critical_postprocess_end"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("non_critical_postprocess_start"),e.$9(l,n),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("non_critical_postprocess_end"),l.forEach(function(e){n.messageToQpl.endSuccess(e.message.messageId)}),r("mergeMaps")(i,s,u)},name:"save-new-messages",priority:o("WorkerScheduler").BLOCKING_PRIORITY});return this.$6.enqueue(function(){return a.run()})},n.$9=function(t,n){o("WebMpsPostprocess").runNonCriticalPostprocessor(t,this.extensionConfiguration.postProcessors.nonCritical,n).catch(function(e){var t=r("getErrorSafe")(e);o("MpsLogger").MpsLogger().catching(t).mustfix("Non-critical postprocessor failed with runtime error")})},n.$8=function(t,n){return o("WebMpsPostprocess").runCriticalPostprocessor(t,this.extensionConfiguration.postProcessors.critical,n).catch(function(e){var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Critical postprocessor failed with runtime error"),new Map})},n.purgeDeletions=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletions").purgeDeletions,name:"purge-deletions",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeDeletions"),0}},n.purgeDeletedPayload=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletedPayload").purgeDeletedPayload,name:"purge-deleted-payload",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeDeletedPayload"),0}},n.getNextDeletionTimestampMs=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletedPayload").getNextDeletionTimestampMs,name:"get-next-deletion-timestamp-ms",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running getNextDeletionTimestampMs")}},n.purgeExpiredMessages=async function(t){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:r("justknobx")._("4539"),fn:function(n){return o("WebMpsPurgeExpiredMessages").purgeExpiredMessages(t,n)},name:"purge-expired-messages",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeExpiredMessages"),0}},n.getNextExpiryTimestampMs=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:r("justknobx")._("4539"),fn:o("WebMpsPurgeExpiredMessages").getNextExpiryTimestampMs,name:"get-next-expire-timestamp-ms",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running getNextExpiryTimestampMs")}},n.debugDbDump=function(){return o("MpsReverbDbDump").debugGetReverbDbDump()},n.spamReportLoadMessages=function(t){var e=this;return o("WebMpsScheduler").mpsScheduler().runTask({fn:async function(){var n=await Promise.all([e.$13({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!0,shouldFetchTags:!1,shouldIgnoreLocalOnly:!1,strategy:"local-only",tagsFilter:"all"},debug:{purpose:"get-latest-msgs-for-spam-report"},direction:"desc",from:[o("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER),null],numMessages:t.numMessages,threadId:t.threadId}),o("WebMpsLoadDeletedMessages").loadDeletedMessages(t,e.$1.decryptedProtobufToFullMessage)]),r=n[0],a=n[1],i=r.messages.filter(function(e){return!a.tombstones.has(e.toplevelProtobuf.messageId)});return[].concat(i,a.messages).toSorted(function(e,t){return t.toplevelProtobuf.timestampMs-e.toplevelProtobuf.timestampMs}).slice(0,t.numMessages)},name:"get-latest-msgs-for-spam-report"})},n.$7=function(){this.$3.forEach(function(e){return e()})},n.$10=function(t,n){var e=this.extensionConfiguration.readSideEffects;if(!(e==null||t.length===0))try{e(t,n)}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("readSideEffects failed")}},n.$4=function(){var e=this;o("schedulePeriodicTask").schedulePeriodicTask(function(){return e.purgeDeletions()},o("DateConsts").MS_PER_MIN*20)},n.$5=function(t){var e=this;o("MpsEphemeralCleaner").startMpsEphemeralCleaner({getNextTs:function(){return e.getNextExpiryTimestampMs()},purgeEnabled:function(){return!0},removeExpired:function(){return e.purgeExpiredMessages(t)}}),o("MpsDeletedCleaner").startMpsDeletedCleaner({getNextTs:function(){return e.getNextDeletionTimestampMs()},purgeEnabled:function(){return!0},removeExpired:function(){return e.purgeDeletedPayload()}})},t})();function _(){if(c==null)throw r("err")("MPS not initialised");return c}function f(){c=void 0}l.makeMps=m,l.mps=_,l.resetMps_TEST_ONLY=f}),98);
__d("WebMpsPurgeExpiredMessages",["MpsTypes","WATimeUtils","WebMps","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk","timestampMs"];async function s(t,n){var r=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()),a=await o("WebReverbDB").getWebReverbDB().runInTransaction(["message","deleted"],"readonly",async function(e){var t=await e.stores.message.readIndexRange("expiryTimestampMs",{lessThanOrEqual:[r]});return n.metric.addAnnotations({int:{num_expired_messages:t.length}}),t},"web-mps-purge-deletions");if(a.length===0)return 0;var i=a.map(function(n){var a=n.debugFlags,i=n.expiryTimestampMs,l=n.isLocalOnlyMessage,s=n.isTransportErrorPlaceholder,u=n.pk,c=n.timestampMs,d=babelHelpers.objectWithoutPropertiesLoose(n,e);return{directive:null,insertionSource:o("MpsTypes").InsertionSource.Send,message:t(babelHelpers.extends({},d,{timestampMs:r}))}});return await o("WebMps").mps().saveNewMessages(i,{source:"purge-expired-messages"}),a.length}function u(){try{return o("WebReverbDB").getWebReverbDB().runInTransaction(["message"],"readonly",async function(e){var t=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()),n=await e.stores.message.readIndexRange("expiryTimestampMs",{greaterThan:[t]},{limit:1,order:"asc"});if(!(n.length===0||n[0].expiryTimestampMs==null))return o("WATimeUtils").castMilliSecondsToUnixTime(n[0].expiryTimestampMs)},"web-mps-next-expiry-timestamp-ms")}catch(e){throw e}}l.purgeExpiredMessages=s,l.getNextExpiryTimestampMs=u}),98);
__d("MAWBridgeEventTransmitter",["EBAPI","EBLogger","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTrace","MAWBridgeTypesCreators","MAWBridgeUpload","MAWIndexedDb","MAWJobDefinitions","MAWUploadThreadTxns","MpsTypes","WAJids","WALogger","WATimeUtils","WebMps"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n,a){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Issuing point query for message: ",""])),t),r("EBAPI").isEBEnabled()!==!1&&o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,shouldFetchTags:!1,strategy:"full-fetch"},debug:{purpose:"issuePointQueryOutsideTxn"},messageId:o("MpsTypes").toMessageId(t),threadId:o("MpsTypes").toThreadId(a)}).then(function(e){var t=e.value;t!=null&&o("MAWBridge").getBridge().sendAndReceive("event","uiUpdate",{events:[{tag:"RestoreNativeOp",value:{chatJid:a,decryptedMessagesProtobufs:[o("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage(t)],isPointQuery:!0,taskSource:(s||(s=o("LSIntEnum"))).ofNumber(n!=null?n:r("LSMEBTaskCreationSource").UNKNOWN)}}]}).catch(function(e){return o("EBLogger").EBLogger().tags(["eventTransmitter","mps"]).catching(e).warn("failure while executing UI update")})})}function c(e,t){o("MAWIndexedDb").afterTransaction({tag:"DeleteMessagesOfThread",value:o("MAWBridgeUpload").createBridgeDeleteMessagesOfThread(o("WAJids").threadIdForChatJid(e.jid),o("MAWUploadThreadTxns").getFolderTypeAsText(e.folder),"AdvancedCrypto",t!=null?t:o("WATimeUtils").castToMillisTime(1),null,2)})}function d(e,t,n){o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"StartTrace",value:o("MAWBridgeTrace").createBridgeStartTraceData(e,t,n)}]})}function m(e,t,n){o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:e,folder:t,threadJid:n})}]})}l.issuePointQueryOutsideTxn=u,l.deleteMessagesOfThreadAfterTxn=c,l.startTraceOutsideTxn=d,l.updateThreadOutsideTxn=m}),98);
__d("MAWQuotedMsgUtils",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.content.type==="NoteReply"?e.content.msgContent==null?e:babelHelpers.extends({},e,{content:babelHelpers.extends({},e.content,{msgContent:void 0})}):e}function s(t){return t.content.expirationTs==null||t.content.expirationTs>o("WATimeUtils").unixTime()?t:e(t)}l.dbQuotedMsgWithoutExpirableContent=e,l.dbQuotedMsgWithoutExpiredContent=s}),98);
__d("MAWGetMsgQuoteTxn",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWQuotedMsgUtils","MAWTransactionMode","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return t==null||t===o("WAJids").AUTHOR_SYSTEM?null:o("WAJids").authorAsUserJid(t)};function s(t,n,a,i){var l=n.quote,s=(l==null?void 0:l.content)||{},u=s.author,c=s.externalId;if(u==null)return o("MAWDexieTable").dexieResolve(null);var d=o("WAJids").isAuthorMe(u)?o("WAJids").AUTHOR_ME:e(u);if(l==null||d==null||c==null)return o("MAWDexieTable").dexieResolve(null);var m={author:d,chat:a,externalId:c};if(l.content.type==="NoteReply")return o("MAWDexieTable").dexieResolve({quote:o("MAWQuotedMsgUtils").dbQuotedMsgWithoutExpiredContent(l),quoteExternalId:l.content.externalId});var p=i!=null&&i==="ebrestore"?r("LSMEBTaskCreationSource").EB_POINT_QUERY_RESTORE_PROTOBUF:r("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT;return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,m).then(function(e){if(o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(m.externalId,p,m.chat),e==null||!o("MAWMsgType").isQuotedMsgType(e.type))return{quote:l,quoteExternalId:l.content.externalId};o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(e,null,!0)});var t=e.author,n=e.externalId,r=e.mediaId,a=e.msgContent,i=e.msgId,s=e.plaintextHash,u=e.specialTextSize,c=e.ts,d=e.type,_=e.xmaMessageType,f={author:t,externalId:n,mediaId:r,msgContent:a,msgId:i,plaintextHash:s,specialTextSize:u,ts:c,type:d,xmaMessageType:_};return e.messageExpirationTs!=null&&e.messageExpirationTs<o("WATimeUtils").unixTime()&&(f=babelHelpers.extends({},f,{mediaId:void 0,msgContent:void 0,type:o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL})),{quote:babelHelpers.extends({},l,{content:f}),quoteExternalId:e.externalId}})}function u(e,t,n){return s(e,t,n).then(function(e){return babelHelpers.extends({},t,{quote:e==null?void 0:e.quote,quoteExpirationTs:e==null?void 0:e.quote.content.expirationTs,quoteExternalId:e==null?void 0:e.quoteExternalId})})}function c(e,t){return e.messages.where("quoteExternalId").anyOf(t).toArray()}var d=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY},"maybeBatchGetMsgsByQuoteExternalId",function(e){return(function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return c.apply(void 0,[e].concat(n))})});l.getMsgQuoteInfo=s,l.enhanceMsgWithQuoteInfo=u,l.maybeBatchGetMsgsByQuoteExternalId=c,l.maybeBatchGetMsgsByQuoteExternalIdWithTransaction=d}),98);
__d("MAWThreadEventConst",[],(function(t,n,r,o,a,i){"use strict";var e="placeholderConvertSubscription";i.PLACEHOLDER_CONVERT_SUBSCRIPTION=e}),66);
__d("MAWUpdateQuotedMsgTxns",["MAWAuthor","MAWBridgeMsg","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n,r,a,i,l,s){var e=o("MAWAuthor").getAuthorUserJid(a);return t.messages.where("quoteExternalId").equals(r).toArray().then(function(r){if(r.length!==0){var a=r;(s==null||!s)&&(a=r.filter(function(t){var r=t.quote,a=t.threadJid;return o("MAWAuthor").getAuthorUserJid(r==null?void 0:r.content.author)===e&&a===n}));var u=a.map(function(e){var t,n=Object.assign({},(t=e.quote)==null?void 0:t.content,i.content),r=babelHelpers.extends({},e.quote,i,{content:n});return r.content.msgId==null&&l!=null&&(r.content.msgId=l),babelHelpers.extends({},e,{quote:r})});return t.messages.bulkPut(u).then(function(){return u})}})},s=function(n,r,a,i,l){l===void 0&&(l=o("MAWMsgType").MSG_TYPE.UNAVAILABLE);var t={content:{mediaId:void 0,msgContent:void 0,type:l}};return e(n,r,a,i,t).then(function(e){e!=null&&e.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})})})},u=function(t,n,r){r===void 0&&(r=o("MAWMsgType").MSG_TYPE.UNAVAILABLE);var e=n.author,a=n.chat,i=n.externalId;return t.threads.get({jid:a}).then(function(n){if(n!=null)return s(t,n.jid,i,e,r)})},c=function(n,r,a,i){var t=a.author,l=a.externalId,s=a.mediaId,u=a.msgContent,c=a.msgId,d=a.plaintextHash,m=a.ts,p=a.type;if(o("WAJids").isAuthorSystem(t))return o("MAWDexieTable").dexieResolve();var _={author:t,chat:r,externalId:l};if(!o("MAWMsgType").isQuotedMsgType(p))return o("MAWDexieTable").dexieResolve();var f=o("MAWDexieTable").dexieResolve(null);return a.type===o("MAWMsgType").MSG_TYPE.XMA&&(f=o("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(n,_).then(function(e){return e.success===!1?o("MAWDexieTable").dexieResolve(null):o("MAWDexieTable").dexieResolve(e.value)})),f.then(function(o){var a,_,f,g,h,y={author:t,externalId:l,mediaId:(a=o==null||(_=o.defaultPreview)==null?void 0:_.mediaId)!=null?a:s,msgContent:u,plaintextHash:(f=o==null||(g=o.defaultPreview)==null?void 0:g.plaintextHash)!=null?f:d,ts:m,type:p,xmaMessageType:o==null||(h=o.xma)==null?void 0:h.targetType};return e(n,r,l,t,{content:y},c,i)})};function d(e,t,n){return o("MAWDexieTable").dexieAll([c(e,n,t),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)]).then(function(n){var r=n[0],a=n[1];return r!=null?o("MAWDexieTable").dexieResolve(m(t,a)).then(function(){o("MAWDexieTable").dexieAll(r.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){return m(t,e),t})}))}):o("MAWDexieTable").dexieResolve([])})}function m(e,t){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,t)})}l.disassociateQuotedMsg=s,l.disassociateQuotedMessageByProtocolMsgId=u,l.associateQuotedMessage=c,l.associateAllReplies=d,l.issueReplyMsgUpdate=m}),98);
__d("MAWUseProtocolMsgIdForMsgId",[],(function(t,n,r,o,a,i){"use strict";function e(){return!0}i.shouldUseProtocolMsgIdForMsgId=e}),66);
__d("MAWBridgeParticipants",["MAWBridgeParticipantsUpdatedHandler","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.deliveredWatermarkTs,n=e.threadJid,r=e.type,a=e.userJid;return babelHelpers.extends({deliveredWatermarkTs:t||o("WATimeUtils").castToUnixTime(0),fbid:o("WAJids").extractUserId(a)},o("MAWBridgeParticipantsUpdatedHandler").mawToLsParticipantTypeConversion(r),{lastReadActionTs:o("WATimeUtils").castToUnixTime(0),readWatermarkTs:o("WATimeUtils").castToUnixTime(0),threadJid:n})}function s(t){return{participants:t.map(function(t){return e(t)})}}l.createBridgeParticipant=e,l.createBridgeParticipants=s}),98);
__d("MAWDbParticipantTxns",["MAWBridgeParticipants","MAWBridgeTypesCreators","MAWCurrentUser","MAWDbParticipant","MAWDexieTable","MAWIndexedDb","MAWODSProxy","MAWUserJidWrapper","MWFBLogger","WAJids","WAOdsEnums","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t,n,r){return r===void 0&&(r=!0),p(e,n.map(function(e){return babelHelpers.extends({},e,{chatJid:t})}),r)}function d(e,t){o("WAJids").switchOnMsgrChatJidType(e.threadJid,{group:r("emptyFunction"),user:function(r){e.userJid!==r&&e.userJid!==o("MAWUserJidWrapper").getMyUserJid()&&o("MWFBLogger").MWLogger().tags(["db","txn"]).mustfix("Attempting to insert participant to a mismatched one-on-one thread at %s",t)}})}function m(e){var t=e.addressable,n=e.chatJid,r=e.type,a=e.userJid;return{addressable:t,deliveredWatermarkTs:o("WATimeUtils").castToUnixTime(0),id:o("MAWDbParticipant").craftParticipantId(n,a),lastReadWatermarkTs:o("WATimeUtils").castToUnixTime(0),threadJid:n,type:r!=null?r:"participant",userJid:a}}function p(e,t,n){if(n===void 0&&(n=!0),t.length===0)return o("MAWDexieTable").dexieResolve([]);var r=t.map(function(e){return m(e)});return r.forEach(function(e){return d(e,"bulkAddParticipantsInThreads")}),e.participants.bulkPut(r).then(function(){return n&&o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:o("MAWBridgeParticipants").createBridgeParticipants(r)}),r})}function _(e,t,n,r){r===void 0&&(r=!0);var a=new Set([t,o("MAWUserJidWrapper").getMyUserJid()]),i=n.filter(function(e){var t=e.userJid;return!a.has(t)}).map(function(e){var t=e.threadJid,n=e.userJid;return[t,n]});return i.length>0&&o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_ONE_TO_ONE_THREAD_PARTICIPANT_CLEANUP,key:o("MAWCurrentUser").isEmployee()?"employee":"public"}),b(e,i,r)}function f(e,t,n,r){r===void 0&&(r=!0);var a=Array.from(new Set([t,o("MAWUserJidWrapper").getMyUserJid()])),i=new Set(n.map(function(e){return e.userJid})),l=a.filter(function(e){return!i.has(e)}),s=l.map(function(e){return{type:"participant",userJid:e}});return c(e,t,s,r).then(function(e){var t=a.reduce(function(t,r){var o=e.find(function(e){return e.userJid===r}),a=n.find(function(e){return e.userJid===r});return o!=null&&a==null?t.push(o):a!=null&&t.push(a),t},[]);return t})}function g(e,t,n){return n===void 0&&(n=!0),L(e,t).then(function(r){return _(e,t,r,n).then(function(o){return f(e,t,r,n)})})}function h(e,t){return t.forEach(function(e){return d(e,"bulkUpdateParticipants")}),e.participants.bulkPut(t).then(function(){return t.length>0&&o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:o("MAWBridgeParticipants").createBridgeParticipants(t)}),t})}function y(e,t,n){if(n.length===0)return o("MAWDexieTable").dexieResolve();var r=n.map(function(e){return[t,e]});return b(e,r)}function C(e,t,n){if(t.length===0)return o("MAWDexieTable").dexieResolve();var r=t.map(function(e){return[e,n]});return b(e,r)}function b(e,t,n){return n===void 0&&(n=!0),e.participants.where(["threadJid","userJid"]).anyOf(t).toArray().then(function(t){return e.participants.bulkDelete(t.map(function(e){return e.id})).then(function(){n&&t.forEach(function(e){var t=e.threadJid,n=e.userJid;return o("MAWIndexedDb").afterTransaction({tag:"ParticipantRemoved",value:{threadJid:t,userId:o("WAJids").extractUserId(n)}})})})})}function v(e,t){return e.participants.where("threadJid").equals(t).delete()}function S(e,t,n,r,o){return R(e,[{deliveredWatermarkTs:n,lastReadActionTs:o,lastReadWatermarkTs:r,participantKey:t}]).then(function(e){return e[0]})}function R(t,n,r){if(n.length===0)return o("MAWDexieTable").dexieResolve([]);var a=new Map,i=[];return n.forEach(function(e){i.push(e.participantKey),a.set(JSON.stringify(e.participantKey),e)}),t.participants.where(["threadJid","userJid"]).anyOf(i).toArray().then(function(n){n.length!==i.length&&r!=null&&r.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing participants "," vs ",""])),n.length,i.length);var l=[],c=[];return n.forEach(function(e){var t=a.get(JSON.stringify([e.threadJid,e.userJid]));if(t==null){r!=null&&r.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing tsData for participant ",", ",""])),e.threadJid,e.userJid);return}var n=t.deliveredWatermarkTs,o=t.lastReadActionTs,i=t.lastReadWatermarkTs,d=e.deliveredWatermarkTs,m=e.lastReadWatermarkTs,p=e.lastReadActionTs,_=n>d,f=i>m,g=p==null||o>p;if(r!=null&&r.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: participant ",", "," deliveredWatermarkTs: ",", lastReadWatermarkTs: ",", lastReadActionTs: ",""])),e.threadJid,e.userJid,n,i,o),!_&&!f&&!g){c.push(e);return}l.push(babelHelpers.extends({},e,{deliveredWatermarkTs:_?n:d,lastReadActionTs:g?o:p,lastReadWatermarkTs:f?i:m}))}),l.forEach(function(e){return d(e,"bulkUpdateParticipantTimestamps")}),t.participants.bulkPut(l).then(function(){return l.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"ReceivedReceipt",value:o("MAWBridgeTypesCreators").createBridgeReceivedReceipt(e.threadJid,o("WAJids").extractUserId(e.userJid),e.deliveredWatermarkTs)})}),[].concat(l,c)})})}function L(e,t){return e.participants.where("threadJid").equals(t).toArray()}function E(e,t){return e.participants.where("threadJid").anyOf(t).toArray()}function k(e,t){return L(e,t).then(function(e){return e.filter(function(e){return e.type==="invitedParticipant"})})}function I(e,t,n){return e.participants.where(["threadJid","userJid"]).equals([t,n]).first().then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function T(e,t){return e.participants.where(["threadJid","userJid"]).anyOf(t).toArray().then(function(e){var n=new Map(e.map(function(e){return[JSON.stringify([e.threadJid,e.userJid]),e]}));return t.map(function(e){return n.get(JSON.stringify(e))})})}l.bulkAddParticipants=c,l.logIfIllegalParticipant=d,l.bulkAddParticipantsInThreads=p,l.deleteIncorrectParticipantsInOneToOneThread=_,l.addMissingParticipantsInOneToOneThread=f,l.bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread=g,l.bulkUpdateParticipants=h,l.bulkDeleteParticipantsInThread=y,l.bulkDeleteParticipantAcrossThreads=C,l.bulkDeleteParticipants=b,l.deleteAllParticipantsForThread=v,l.updateParticipantTimestamps=S,l.bulkUpdateParticipantTimestamps=R,l.getParticipantsInThread=L,l.getParticipantsInThreads=E,l.getInvitedParticipantsInThread=k,l.getParticipant=I,l.bulkGetParticipants=T}),98);
__d("MAWWriteMsgSideEffectTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDexieTable"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=o("MAWDbMsg").getCanonicalTsFromMsg(t),r=t.author;return r!=="@me"&&r!=="@system"?o("MAWDbParticipantTxns").updateParticipantTimestamps(e,[t.threadJid,r],n,n,n):o("MAWDexieTable").dexieResolve()}l.updateParticipantTimestampsForMsg=e}),98);
__d("MAWWriteMsgTxns",["FBLogger","FtsIndexEntity","MAWAfterWriteMsgUtil","MAWBridgeMsg","MAWBuildIncomingMsgs","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbReactionsTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDeleteForMeMsgContentCleaner","MAWDeleteThreadUtil","MAWDexieTable","MAWEphemeralMsgTxns","MAWExpiredQuoteCleaner","MAWFTSTxns","MAWFolderTypes","MAWGetMsgQuoteTxn","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWLocalizationType","MAWLocalizationUtils","MAWMessageSortOrderUtils","MAWMsgType","MAWThreadEventConst","MAWTimeUtils","MAWUpdateQuotedMsgTxns","MAWUseProtocolMsgIdForMsgId","MAWWriteMsgSideEffectTxns","MAWWriteRevokeMessageTxns","ODS","Promise","WAJids","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["rowId"],s,u,c,d;function m(e,t,n,a){var i=n.ts,l=[o("WATimeUtils").castUnixTimeToMillisTime(i),n.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN],s=l[0],u=l[1];return o("MAWGetOrCreateThreadTxns").getExistingThread(e,t.jid).then(function(t){if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");var i=o("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(e,t.jid),l=o("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(e,t.jid);return o("MAWDexieTable").dexieAll([i,l]).then(function(e){var r,i,l,c=e[0],d=e[1],m=o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?null:d==null?1:o("MAWDbMsg").getInChatMsgIdFromMsgId(d.msgId)+1,p=o("WATimeUtils").castToMillisTime((r=d==null?void 0:d.sortOrderMs)!=null?r:0),_=s>p&&!u?s:p,f=(i=o("MAWTimeUtils").ensureValidMillisTime(t.lastReadMsgTs))!=null?i:0,g=o("WATimeUtils").castToMillisTime((l=d==null?void 0:d.sortOrderMs)!=null?l:0),h=f<g,y=n.author===o("WAJids").AUTHOR_ME||n.type===o("MAWMsgType").MSG_TYPE.ADMIN&&o("MAWLocalizationUtils").isParticipantChangeAdminMsg(n.msgContent.adminType)&&!h,C=babelHelpers.extends({},n,{msgId:m!=null?o("MAWDbMsg").craftMsgIdV2(t.chatId,m,n):o("MAWJidUtils").formatProtocolMsgIdFromMsg(n)}),b=o("MAWDbMsgTxns").calculateOldestMsg(c,d,C,a),v=b.oldestMsg;return{isOldestMsgUpdated:c!=null&&v!==c.msgId,msgId:C.msgId,prevOldestMsg:c,updatedSnippet:void 0,updatedThread:babelHelpers.extends({},t,{lastReadMsg:y?C.msgId:t.lastReadMsg,lastReadMsgTs:y?_:t.lastReadMsgTs,newestMsgTs:_,oldestMsg:v,snippetMsg:t.snippetMsg,snippetMsgTs:t.snippetMsgTs,threadOrder:o("MAWDbThread").craftThreadOrder(_,t.jid)})}})})}function p(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).equals([n.jid,r]).filter(function(e){return e.type!==o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN&&e.type!==o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION?!1:e.type===t.type&&e.msgContent.adminType===t.msgContent.adminType}).first().then(function(r){return r!=null?r:h(e,t,n)})}function _(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).equals([n.jid,r]).filter(function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN&&e.msgContent.adminType===t.msgContent.adminType}).first().then(function(r){return r!=null?((d||(d=o("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",t.msgContent.adminType),r):h(e,t,n)})}function f(e,t,n){return e.messages.where("threadJid").equals(n.jid).filter(function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN&&(e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED||e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT)}).first().then(function(r){return r!=null?((d||(d=o("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",t.msgContent.adminType),r):h(e,t,n)})}function g(e,t){return e.messages.add(t).then(function(e){return babelHelpers.extends({},t,{rowId:e})})}function h(e,t,r,a){a===void 0&&(a={});var i=a,l=i.isFirstMsg,u=l===void 0?!1:l,d=i.isOutgoing,p=d===void 0?!1:d,_=i.openMessageOtid,f=i.openMessageParticipantCount,h=i.optimisticMsg,y=i.participantCount,C=i.quotedReplyAttachmentMeta,b=i.shouldUpdateUi,v=b===void 0?!0:b,S=i.sortOrderMs;return m(e,r,t,S).then(function(r){var a=r.isOldestMsgUpdated,i=r.msgId,l=r.prevOldestMsg,d=r.updatedThread,m=babelHelpers.extends({},t,{msgId:i,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(t)});return o("MAWDexieTable").dexieAll([g(e,m),e.threads.put(d),o("MAWFTSTxns").dexieIfElse(o("FtsIndexEntity").isFtsIndexQueueExperiment(),function(){return(c||(c=n("Promise"))).resolve()},function(){return o("MAWFTSTxns").maybePutMessageToBacklog(e,m.externalId)})]).then(function(e){var t=e[0],n=e[1];return p&&o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["writeMsgAfterTransaction - sortOrderMs: ",""])),t.sortOrderMs),v&&o("MAWAfterWriteMsgUtil").writeMsgAfterTransaction({dbMsg:t,isFirstMsg:u,openMessageOtid:_,openMessageParticipantCount:f,optimisticMsg:h,participantCount:y,quotedReplyAttachmentMeta:C,updatedThread:d}),t})})}function y(e,t,n){return o("MAWGetOrCreateThreadTxns").getExistingThread(e,n.jid).then(function(a){if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");return(o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?o("MAWDexieTable").dexieResolve(null):o("MAWDbUnrenderedMsgTxns").getNextUnrenderedMsgIdNumberForThread(e,a)).then(function(r){var i=babelHelpers.extends({},t,{msgId:r!=null?o("MAWDbMsg").craftUnrenderedMsgId(a.chatId,r):o("MAWJidUtils").formatProtocolMsgIdFromExternalId(n.jid,t.externalId)});return o("MAWDexieTable").dexieAll([e.unrenderedMessages.add(i),e.threads.put(a)]).then(function(e){var t=e[0],n=e[1];return babelHelpers.extends({},i,{rowId:t})})})})}function C(e,t,n){return o("MAWDexieTable").dexieAll([b(e,t,n),o("MAWDbEditMsgHistoryTxns").getEditHistoryByOriginalMsgExternalIdAndThreadJid(e,[[t.externalId,n.jid]]).then(function(e){return{editMsgHistories:e,originalEditMsgHistory:e.find(function(e){return e.editExternalId===t.externalId})}})]).then(function(e){var t=e[0],n=e[1],r=n.editMsgHistories,o=n.originalEditMsgHistory;return babelHelpers.extends({},t,{editMsgHistories:r,existingEditMsgHistory:o!=null?o:null})})}function b(e,t,n){var r=[t.externalId,n.jid,t.author],a=r[0],i=r[1],l=r[2];return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,a,i,l),o("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(e,a,l,i),o("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(e,a,l,i),o("MAWDbMsgTxns").checkIfMsgIsDeletedForMeOrRevoked(e,a,i,l),o("MAWDbPendingStanzaTxns").maybeGetDeleteThreadFromPendingStanza(e,i).then(function(e){return o("MAWDeleteThreadUtil").isMsgDeletedViaDeleteThread(t.ts,e)})]).then(function(e){var t=e[0],n=e[1],r=e[2],o=e[3],a=e[4];return{existingMsg:t!=null?t:null,isDeletedWithThread:a,isDeleteForMeOrRevoked:o,pendingDeleteForMeStanza:r!=null?r:null,pendingRevokedStanza:n!=null?n:null}})}function v(e,t,n,r,a){return r===void 0&&(r=!0),o("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(e,t.externalId,t.author,n.jid).then(function(i){if(i!=null)return L(e,t,n,i,!0);var l=t.author;o("WALogger").DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["handle"," Msg: Message from ",", chat ",""])),t.type,l,n.jid);var s=babelHelpers.extends({},babelHelpers.extends({},t,{threadJid:n.jid}));return n.folder===o("MAWFolderTypes").FOLDER_ID.OTHER&&(s.altIndex=s.altIndex===o("MAWDbMsg").FUTUREPROOF_ALT_INDEX?o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX:o("MAWDbMsg").SPAM_ALT_INDEX),o("MAWGetMsgQuoteTxn").getMsgQuoteInfo(e,s,n.jid,a).then(function(t){t!=null&&(s=babelHelpers.extends({},s,{quote:t==null?void 0:t.quote,quoteExpirationTs:t==null?void 0:t.quote.content.expirationTs,quoteExternalId:t==null?void 0:t.quoteExternalId}));var a=s.quoteExpirationTs;return a!=null&&a>o("WATimeUtils").unixTime()&&o("MAWExpiredQuoteCleaner").addNewExpiredQuoteCleanerTimestamp(a),o("MAWDexieTable").dexieAll([o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(e,n.jid,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsg(e,s)]).then(function(t){var a=t[0],i=t[1],l=t[2];return h(e,s,n,{quotedReplyAttachmentMeta:i,shouldUpdateUi:r}).then(function(t){return o("MAWDexieTable").dexieAll([o("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(e,s),o("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(e,t,r)]).then(function(e){var n=e[1];return a!=null&&r&&a.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,l)})}),n||t})})})})})}function S(t,n,r,a,i,l){var s=babelHelpers.extends({},babelHelpers.extends({},n,{msgId:r.msgId,protocolMsgId:r.protocolMsgId,rowId:r.rowId,serverTs:r.serverTs,sortOrderMs:r.sortOrderMs,threadJid:a.jid,ts:r.ts}));return o("MAWDexieTable").dexieAll([o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(t,a.jid,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(t,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsg(t,s),o("MAWGetMsgQuoteTxn").getMsgQuoteInfo(t,s,a.jid,l),o("MAWDbMsgTxns").getThreadNewestMessageId(t,a.jid)]).then(function(l){var u,c=l[0],d=l[1],m=l[2],p=l[3],_=l[4];return s=babelHelpers.extends({},s,{quote:p==null?void 0:p.quote,quoteExternalId:p==null?void 0:p.quoteExternalId}),((u=r.editCount)!=null?u:0)>0&&i!=null&&n.type===o("MAWMsgType").MSG_TYPE.TEXT?o("MAWDbEditMsgHistoryTxns").updateEditMsgHistoryWithNewIncomingMsg(t,i,n).then(function(){return r}):t.messages.put(s).then(function(){return o("MAWDbThreadTxns").needsRetroactiveReadReceiptInThread(t,s)}).then(function(e){if(e)return s.altIndex=o("MAWDbMsg").craftToBeReadAltIndex(a.chatId),t.messages.put(s)}).then(function(){if(o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(s,m)}),o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(s,d)}),o("MAWIndexedDb").afterTransactionThreadEvent({chatJid:a.jid,msgId:s.msgId},o("MAWThreadEventConst").PLACEHOLDER_CONVERT_SUBSCRIPTION),c!=null&&c.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,m)})}),s.msgId===_){var n=s,r=n.rowId,i=babelHelpers.objectWithoutPropertiesLoose(n,e);o("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(t,i)}return s})})}function R(e,t,r,a){var i=o("MAWBuildIncomingMsgs").buildUnstoredDeleteForMeMsg(t,r);return o("MAWDexieTable").dexieAll([o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:i.author,chatJid:i.threadJid,externalId:i.externalId}]),y(e,i,r),e.pendingStanzas.delete(a.rowId),o("MAWFTSTxns").dexieIfElse(o("FtsIndexEntity").isFtsIndexQueueExperiment(),function(){return(c||(c=n("Promise"))).resolve()},function(){return o("MAWFTSTxns").maybePutMessageToPurgeBacklog(e,t.externalId)})]).then(function(e){var t=e[0],n=e[1];return o("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(i.messageDeleteForMeTs),babelHelpers.extends({},i,{msgId:n.msgId,rowId:n.rowId})})}function L(e,t,n,a,i){i===void 0&&(i=!1);var l=o("MAWDbPendingStanzaTxns").getRevokedContent(a);if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("missing revoked content");var s=o("MAWBuildIncomingMsgs").buildUnstoredRevokedMsg(t,n,l);return o("MAWDexieTable").dexieAll([h(e,s,n),e.pendingStanzas.delete(a.rowId)]).then(function(t){var r=t[0];return o("MAWWriteRevokeMessageTxns").markIncomingMessageRevoked(e,r,n).then(function(){return r})})}l.writeDedupedEphemeralSettingAdminMessage=p,l.writeDedupedAdminMessage=_,l.writeDedupedUsersConnectedAdminMessage=f,l.writeMsg=h,l.writeUnrenderedMsg=y,l.prepareTextMsgWriteData=C,l.prepareMsgWriteData=b,l.writeNewIncomingMsg=v,l.writeCiphertextUpdate=S,l.handleDeleteForMeMessage=R,l.handleOutOfOrderRevokedMessage=L}),98);
__d("MAWDbDeletedMessages",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({ChatDelete:"chat_delete",Revoke:"revoke"});i.DbDeletedMsgReasonEnum=e}),66);
__d("MAWMediaManagerDeferred",["promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("MAWMediaManager").__setRef("MAWMediaManagerDeferred");function s(t){r("promiseDone")(e.load().then(function(e){e.getMawMediaManager().dequeueDownload(t)}))}l.dequeueDownload=s}),98);
__d("MAWUnsendMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function d(t){if(u==null){var n="Trying to add new UnsendMsgContentCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["UnsendMsgContentCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startUnsendMsgContentCleaner=c,l.addNewUnsendMsgContentCleanerTimestamp=d,l.getUnsendMsgContentCleaner_FOR_TESTING_ONLY=m,l.resetUnsendMsgContentCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWWriteDeleteMessageTxns",["FtsIndexEntity","MAWAckLevel","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDeleteForMeMsgContentCleaner","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWMediaManagerDeferred","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUpdateQuotedMsgTxns","MAWXMAUtils","Promise","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s=6*o("WATimeUtils").HOUR_SECONDS,u=30*o("WATimeUtils").DAY_SECONDS;function c(t,r){var a=r.protocolMsgId,i=a.author,l=a.chat,s=a.externalId;return o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").getThread(t,l),t.unrenderedMessages.get({externalId:s}),o("MAWFTSTxns").dexieIfElse(o("FtsIndexEntity").isFtsIndexQueueExperiment(),function(){return(e||(e=n("Promise"))).resolve()},function(){return o("MAWFTSTxns").maybePutMessageToPurgeBacklog(t,s)})]).then(function(e){var n=e[0],r=e[1];return n.success?r!=null&&r.threadJid===n.value.jid&&r.author===i?o("WAResultOrError").makeError("duplicate_delete_for_me"):o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,a).then(function(e){if(e==null){var r={ack:o("MAWAckLevel").ACK.received,author:i,externalId:s,threadJid:n.value.jid,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME},l=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+u),c={deleteTs:l,externalIdWithType:s+"_"+o("MAWDbPendingStanza").PENDING_DELETE_FOR_ME,pendingContent:{content:r,type:o("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME}};return t.pendingStanzas.add(c).then(function(){return o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(l),o("WAResultOrError").makeResult()})}return o("MAWDexieTable").dexieResolve(d(t,e,i,a.chat,n.value)).then(function(){return o("WAResultOrError").makeResult()})}):o("WAResultOrError").makeError("missing_thread")})}function d(e,t,n,a,i){var l,u,c=o("MAWDexieTable").dexieResolve();o("MAWXMAUtils").isXMAStoryReply((l=t.quote)==null?void 0:l.content.xmaMessageType)&&(c=m(e,t));var d={ack:t.ack,author:n,externalId:t.externalId,mediaId:t.mediaId,messageDeleteForMeTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+s),msgContent:(u=o("MAWDbMsg").getMsgContent(t))==null?void 0:u.content,msgId:t.msgId,quote:t.quote,reportingMeta:t.reportingMeta,serverTs:void 0,threadJid:a,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME,xmaMessageType:t.xmaMessageType},_=o("MAWDexieTable").dexieAll([p(e,t.author,t.externalId,t.threadJid),o("MAWDbMsgTxns").deleteDbMsg(e,t.rowId),c]).then(function(){if(o("MAWDbMsg").isMediaMsg(t)){var n=t.mediaId,a=t.plaintextHash;n!=null&&(a!=null?(o("MAWMediaManagerDeferred").dequeueDownload(a),o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:n,msgId:t.msgId,plaintextHash:a,threadJid:t.threadJid}})):o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:n,msgId:t.msgId,threadJid:t.threadJid}}))}return o("MAWDexieTable").dexieAll([o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(e,i)]).then(r("emptyFunction"))});return _.then(function(){return o("MAWDexieTable").dexieAll([e.unrenderedMessages.add(d),o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:n,chatJid:t.threadJid,externalId:t.externalId}]),o("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(e,t.threadJid,t.externalId,t.author,o("MAWMsgType").MSG_TYPE.REVOKED)]).then(function(){return o("MAWDbMsgTxns").maybeUpdateThreadMsgsForDeleteForMe(e,i.jid,t.msgId,t.sortOrderMs).then(function(){return o("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(d.messageDeleteForMeTs),o("WAResultOrError").makeResult()})})})}function m(e,t){return o("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(e,t.msgId).then(function(t){return o("MAWDbMsgTxns").maybeGetMsg(e,t==null?void 0:t.msgId).then(function(t){if(t!=null)return o("MAWDbMsgTxns").deleteDbMsg(e,t.rowId)})})}function p(e,t,n,r){return e.messages.where("quoteExternalId").equals(n).filter(function(e){var n;return e.type===o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE&&((n=e.quote)==null?void 0:n.content.author)===t&&e.threadJid===r}).toArray().then(function(t){if(t.length===0)return o("MAWDexieTable").dexieResolve([]);var n=t.map(function(e){return e.rowId});return o("MAWDbMsgTxns").bulkDeleteDbMsg(e,n).then(function(){return t})})}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=s,l.handleDeleteForMe=c,l.deleteXMAStoryReplyMsg=m,l.deleteBumpMsgs=p}),98);
__d("MAWWriteRevokeMessageTxns",["FBLogger","FtsIndexEntity","LSMEBTaskCreationSource","MAWAckLevel","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbDeletedMessages","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbProtocolMsgIdMiddleware","MAWDbReactionsTxns","MAWDexieTable","MAWEphemeralUtil","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWMediaManagerDeferred","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUnsendMsgContentCleaner","MAWUpdateQuotedMsgTxns","MAWWriteDeleteMessageTxns","MAWWriteMsgTxns","MAWXMAUtils","Promise","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s=6*o("WATimeUtils").HOUR_SECONDS,u=30*o("WATimeUtils").DAY_SECONDS;function c(t,a,i,l,s,c){if(c!=null&&l==null){var m,p=babelHelpers.extends({},a,{originalTs:o("WATimeUtils").castMilliSecondsToUnixTime(c),threadJid:i.jid,unsendMsgContentDeleteTs:(m=a.serverTs)!=null?m:a.ts});return o("MAWWriteMsgTxns").writeMsg(t,p,i).then(function(e){return e.type==="Revoked"?e:null})}var f=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+u),g=a.author,h=a.externalId,y=a.revokedExternalId,C=s!=null?_(t,s):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([l==null?o("MAWDbMsgTxns").maybeGetMsgByExternalId(t,a.revokedExternalId,i.jid,a.author):o("MAWDexieTable").dexieResolve(l),o("MAWFTSTxns").dexieIfElse(o("FtsIndexEntity").isFtsIndexQueueExperiment(),function(){return(e||(e=n("Promise"))).resolve()},function(){return o("MAWFTSTxns").maybePutMessageToPurgeBacklog(t,h)})]).then(function(e){var n=e[0];if((l==null||n!=null)&&r("FBLogger")("messenger_web").warn("Revoked message missing originalMsg incorrectly"),n==null){var s={deleteTs:f,externalIdWithType:y+"_"+o("MAWDbPendingStanza").PENDING_REVOKED,pendingContent:{content:{ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:g,externalId:h,revokedExternalId:y,threadJid:i.jid,ts:a.ts,type:"Revoked"},type:o("MAWDbPendingStanza").PENDING_TYPE.REVOKED}};return o("MAWDexieTable").dexieAll([t.pendingStanzas.add(s),C]).then(function(e){var n=e[0],a=e[1];o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(f),o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(y,r("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,i.jid),a===!0&&o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(t,i)})}return C.then(function(){return d(t,n,i,a.externalId,a.revokedExternalId,a.serverTs,a.ts,!1)})})}function d(e,t,n,r,a,i,l,u){var c,d=babelHelpers.extends({},t,{altIndex:void 0,externalId:r,msgContent:o("MAWDbMsg").getMsgContent(t),originalTs:(c=t.serverTs)!=null?c:t.ts,revokedExternalId:a,serverTs:i,threadJid:n.jid,ts:l,type:"Revoked",unsendMsgContentDeleteTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+s)});return o("MAWDbProtocolMsgIdMiddleware").appendProtocolMsgId(d),u?o("MAWDexieTable").dexieResolve(d):m(e,t,d,n).then(function(){return d})}function m(t,r,a,i){var l,s=o("MAWXMAUtils").isXMAStoryReply((l=r.quote)==null?void 0:l.content.xmaMessageType)?o("MAWWriteDeleteMessageTxns").deleteXMAStoryReplyMsg(t,r):o("MAWDexieTable").dexieResolve(),u=o("MAWJidUtils").toProtocolMsgId(r),c=u!=null?t.deletedMessages.add(babelHelpers.extends({},u,{reason:o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):o("MAWDexieTable").dexieResolve();return o("MAWWriteDeleteMessageTxns").deleteBumpMsgs(t,r.author,r.externalId,r.threadJid).then(function(){return o("MAWDexieTable").dexieAll([t.messages.put(a),o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(t,[{author:a.author,chatJid:a.threadJid,externalId:a.revokedExternalId}]),o("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(t,a.threadJid,a.revokedExternalId,a.author,o("MAWMsgType").MSG_TYPE.REVOKED),s,c,o("MAWFTSTxns").dexieIfElse(o("FtsIndexEntity").isFtsIndexQueueExperiment(),function(){return(e||(e=n("Promise"))).resolve()},function(){return o("MAWFTSTxns").maybePutMessageToPurgeBacklog(t,r.externalId)})]).then(function(){if(o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(a)}),r!=null&&o("MAWDbMsg").isMediaMsg(r)){var e=r.mediaId,n=r.plaintextHash;e!=null&&(n!=null?(o("MAWMediaManagerDeferred").dequeueDownload(n),o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:r.msgId,plaintextHash:n,threadJid:r.threadJid}})):o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:r.msgId,threadJid:r.threadJid}}))}return o("MAWEphemeralUtil").maybeClearEphemeralMsgCountdown(r),o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(t,i)})})}function p(e,t,n){if(t.type!==o("MAWMsgType").MSG_TYPE.REVOKED)throw r("FBLogger")("messenger_web").mustfixThrow("Cant mark unrevoked message revoked");var a=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.revokedExternalId),i=a!=null?e.deletedMessages.add(babelHelpers.extends({},a,{reason:o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):o("MAWDexieTable").dexieResolve();return o("MAWWriteDeleteMessageTxns").deleteBumpMsgs(e,t.author,t.revokedExternalId,t.threadJid).then(function(r){return r.length>0&&o("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:o("MAWBridgeTypesCreators").createBridgeDeleteMessages(t.threadJid,r)}),o("MAWDexieTable").dexieAll([o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:t.author,chatJid:t.threadJid,externalId:t.revokedExternalId}]),o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(e,n),i]).then(function(){o("MAWUnsendMsgContentCleaner").addNewUnsendMsgContentCleanerTimestamp(t.unsendMsgContentDeleteTs),o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(t)})})})}function _(e,t){return t.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT?e.messages.delete(t.rowId).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:o("MAWBridgeTypesCreators").createBridgeDeleteMessages(t.threadJid,[t])}),!0}):o("MAWDexieTable").dexieResolve(!1)}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=s,l.writeIncomingRevokeMsg=c,l.revokeUnstoredMsg=d,l.markExistingMsgRevoked=m,l.markIncomingMessageRevoked=p}),98);
__d("MAWBridgeTraceEvent",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum").Mirrored(["ReceivedReceipt","ReceivedSent","FlowEndForFailure","FlowEndForSuccess"]),l=e;i.default=l}),66);
__d("MAWCastToMsgrServerMediaType",["EncryptedBackupsUploadEntity","MAWDbMedia","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,n){if(n===void 0&&(n=!1),n&&t==="image")return"xma";switch(t){case"image":case"video":case"gif":case"sticker":return t;case"document":return"file";case"ptt":return"audio";case"xma-image":return"xma";case"preview":return"preview";default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaType: "," for castToMsgrServerMediaType method"])),t),null}}function d(e,t){if(t===void 0&&(t=!1),t&&e===o("MAWDbMedia").MEDIA_TYPE.IMAGE)return"xma";switch(e){case"Image":return"image";case"Video":return"video";case"Gif":return"gif";case"Sticker":return"sticker";case"DocumentFile":return"file";case"Ptt":return"audio";default:return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["invalid client mediaType: "," for castClientMediaTypeToServerMediaType method"])),e),null}}function m(e){switch(e){case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return"image";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return"video";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return"gif";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER:return"sticker";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return"file";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return"audio";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA:return"xma";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW:return"preview";default:return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["invalid attachment mediaType: "," for castMediaAttachmentTypeToServerMediaType method"])),e),null}}l.castToMsgrServerMediaType=c,l.castClientMediaTypeToServerMediaType=d,l.castMediaAttachmentTypeToServerMediaType=m}),98);
__d("WADbDeviceRegistration",["gkx"],(function(t,n,r,o,a,i,l){"use strict";var e=25,s=6,u=s,c="https://reg-e2ee.facebook.com",d=r("gkx")("13108")?"https://reg-e2ee.messenger.com":c,m="https://v.whatsapp.net",p="https://reg-e2ee.instagram.com",_="/v2/fb_icdc_fetch",f="/v2/fb_register_v2",g="Device has already been registered to WA servers",h="Device registration finished successfully",y="Device registration retries failed "+s+" times. No longer attempting registration.",C="Device registration response was null",b="Current user id is zero",v="CryptoAuthToken is empty",S="CryptoAuthToken is expired",R={failed:"failed",finished:"finished"};l.MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE=e,l.MAX_DEVICE_REGISTRATION_RETRIES=s,l.MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES=u,l.REG_FB_DOMAIN=c,l.REG_MSGR_DOMAIN=d,l.REG_WA_DOMAIN=m,l.REG_IGD_DOMAIN=p,l.ICDC_ENDPOINT=_,l.REGISTRATION_ENDPOINT=f,l.DEVICE_ALREADY_REGISTERED=g,l.DEVICE_SUCCESSFULLY_REGISTERED=h,l.FAILED_REGISTRATION_RETRIES=y,l.NULL_RESPONSE_FROM_SERVER=C,l.DEVICE_REGISTER_ERROR_ZERO_AS_USER_ID=b,l.DEVICE_REGISTER_ERROR_EMPTY_CAT_TOKEN=v,l.DEVICE_REGISTER_ERROR_EXPIRED_CAT_TOKEN=S,l.RegistrationStatesEnum=R}),98);
__d("WorkerUtils",[],(function(t,n,r,o,a,i){"use strict";function e(){try{return"WorkerGlobalScope"in t&&t instanceof t.WorkerGlobalScope}catch(e){return!1}}function l(){try{return"SharedWorkerGlobalScope"in t&&t instanceof t.SharedWorkerGlobalScope}catch(e){return!1}}i.isWorkerContext=e,i.isSharedWorkerContext=l}),66);
__d("getOrchestratorVersion",["qex"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e;return(e=r("qex")._("263"))!=null?e:"default"}l.default=e}),98);
__d("MAWMainWebWorkerConfig",["MAWGK","MAWParseXMAFBConfig","WADbDeviceRegistration","WorkerUtils","getOrchestratorVersion","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s=1,u={armadilloWebProcessFutureproof:function(){return r("MAWGK").armadillo_web_process_futureproof},getSignalFutureMessagesMax:function(){return r("justknobx")._("847")},icdcAlertTriggerFailureCounter:function(){return r("justknobx")._("1970")},icdcCooldownIntervalInMinutes:function(){return r("justknobx")._("1971")},icdcIntervalInMinutes:function(){return r("justknobx")._("1972")},isDocumentReceiveEnabled:function(){return!r("gkx")("23924")},isFrankingDropOnInvalid:function(){return r("gkx")("23973")},isFrankingDropOnMissing:function(){return r("gkx")("23974")},isICDCErrorEnabled:function(){return r("gkx")("23975")},isMetaAiInvocationMessageRenderEnabled:function(){return r("gkx")("12661")},isPollsEnabled:function(){return!1},isProgressiveJpegSendEnabled:function(){return!0},isSharedWorkerContext:function(){return(e||(e=o("WorkerUtils"))).isSharedWorkerContext()},jpegThumbnailTargetByteSizeKB:function(){return r("justknobx")._("2338")},maxPrekeysToUpload:function(){return 200},maxUsersForNotifyDeviceChange:function(){return o("WADbDeviceRegistration").MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE},newClockSkewCalculation:function(){return r("gkx")("18494")},orchestratorVersion:function(){return r("getOrchestratorVersion")()},pjpegPreviewAvoidLastScan:function(){return!0},sessionDropIfTooOld:function(){return r("justknobx")._("2240")},skipProcessingGroupInvite:function(){return!0},waDanglingQueue:function(){return!0}},c={productTypeForEBAttachments:"msgr",supportedTypesVersion:function(){return r("MAWGK").armadillo_web_process_futureproof?s+1:s},supportedXMATargetTypes:function(){return o("MAWParseXMAFBConfig").FB_FULLY_SUPPORTED_TARGET_TYPES}};l.waConfig=u,l.mawConfig=c}),98);
__d("MAWConfig",["MAWMainWebWorkerConfig"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWMainWebWorkerConfig").mawConfig;function s(){return e}function u(t){e=t}l.getConfig=s,l.setConfig=u}),98);
__d("MAWJobsIndexedDb",["FBLogger","MAWCurrentUser","MAWErrorObject","MAWIndexedDbMetadata","MAWQplProxy","MAWTransactionMode","Promise","WAExceededStorageQuota","WALogger","WAWorkerGlobalScope","emptyFunction","promiseDone","qex","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null,c=null,d="jobs";function m(){return r("qex")._("940")}function p(){if(u==null)throw r("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return u}function _(){if(c==null)throw r("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return c.then(function(){return p()})}function f(){return u!=null}var g=[function(e){var t=e.target.result,n=t.createObjectStore(d,{autoIncrement:!0,keyPath:"jobId"});n.createIndex("uniqKey","uniqKey")},r("emptyFunction"),r("emptyFunction")];function h(e){return c=null,u=null,y(e).then(function(){return u.version})}function y(t){var a;if(c!=null)return c;if(u!=null)return(s||(s=n("Promise"))).resolve();var i=o("MAWCurrentUser").getID(),l=o("MAWIndexedDbMetadata").jobsDbName(i),d=(a=t!=null?t:m())!=null?a:g.length,p=r("qpl")._(25310776,"6155");return c=new(s||(s=n("Promise")))(function(t,n){var r=indexedDB.open(l,d);r.onupgradeneeded=function(e){for(var t=0;t<g.length;t++){var n=g[t],r=t+1;C(e,r)&&n(e)}},r.onsuccess=function(n){var r=n.target.result;r.onversionchange=function(){var t;o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_versionchange"),o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[JobsDb initialization] upgradeneeded is triggered in another worker. This should not happen."]))),r.close(),(t=o("WAWorkerGlobalScope").workerGlobalScope.location)==null||t.reload==null||t.reload()},u=r,o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_ready"),t()},r.onerror=function(){o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_failed"),n(r.error)}}),c}function C(e,t){var n=e.newVersion,r=e.oldVersion;return r<t&&n>=t}function b(e){return e===o("MAWTransactionMode").READWRITE?"readwrite":"readonly"}function v(e,t,n,a){var i=b(t);return function(t){return function(){for(var l=arguments.length,s=new Array(l),d=0;d<l;d++)s[d]=arguments[d];var m=a!=null?o("MAWQplProxy").startQplUserFlow(a):null,p=function(l){return _().then(function(n){var r=function(r){var t=n.transaction(e,r!=null?b(r):i,{durability:"relaxed"});return o("WAExceededStorageQuota").listenToQuotaExceededError(t),t.objectStore(e)};return t.apply(void 0,[r].concat(s))}).then(function(e){return m==null||m.endSuccess(),e}).catch(function(t){m==null||m.endFail("job_transaction_fail");var a=o("MAWErrorObject").getErrorObject(t);if((a==null?void 0:a.name)==="InvalidStateError"&&l===1)return c=null,u=null,r("promiseDone")(y()),p(l-1);throw a instanceof Error?r("FBLogger")("maw_db").catching(a).mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",n,e):r("FBLogger")("maw_db").mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",n,e)})};return p(1)}}}l.getJobsDbVersion=m,l.getJobDB=p,l.isJobDBInitted=f,l.dbMigrations=g,l.makeJobsDbIgnoringPreviousCreations=h,l.makeJobsDb=y,l.makeJobsTransactor=v}),98);
__d("MAWJobPersistenceAccessorsApi",["MAWJobActionsV2","MAWJobsIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t,n;return{deletePersistedJob:(e=o("MAWJobsIndexedDb")).makeJobsTransactor("jobs",(t=o("MAWTransactionMode")).READWRITE,"deletePersistedJob")((n=o("MAWJobActionsV2")).deletePersistedJob),loadAllJobs:e.makeJobsTransactor("jobs",t.READONLY,"loadAllJobs")(n.readAllPersistedJobs),maybeCreateJob:e.makeJobsTransactor("jobs",t.READWRITE,"maybeCreateJob")(n.maybeCreateJob),readPersistedJob:e.makeJobsTransactor("jobs",t.READONLY,"readPersistedJob")(n.readPersistedJob),updatePersistedJob:e.makeJobsTransactor("jobs",t.READWRITE,"updatePersistedJob")(n.updatePersistedJob)}}l.getJobPersistenceAccessors=e}),98);
__d("WAJobRequirement",["Promise","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e){var t=this;this.$1=(s||(s=n("Promise"))).resolve(),this.$2=!0,this.$3=null,this.$4=function(){var e=t.$3;if(e!=null)return t.$3=null,(s||(s=n("Promise"))).all(e).then(t.$4);t.$2=!0},this.name=e}var r=t.prototype;return r.addBlocker=function(r){var t=this,a=r.catch(function(n){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["JobRequirement[","] blocker errored ",""])),t.name,n).sendLogs("job-blocker-rejected")});if(this.$2)this.$2=!1,this.$1=(s||(s=n("Promise"))).all([this.$1,a]).then(this.$4);else{var i=this.$3;i!=null?i.push(a):this.$3=[a]}},r.waitUntilSatisfied=function(){return this.$1},r.isSatisfied=function(){return this.$2},r.isSatisfiable=function(){return!0},t})(),c=(function(e){function t(t){var r;return r=e.call(this,t)||this,e.prototype.addBlocker.call(r,new(s||(s=n("Promise")))(function(){})),r}babelHelpers.inheritsLoose(t,e);var r=t.prototype;return r.addBlocker=function(){},r.isSatisfiable=function(){return!1},t})(u);function d(e,t){var r=e.filter(function(e){return!e.isSatisfiable()});if(r.length>0){var o=r.map(function(e){return e.name});return function(e){return t==null||t("unsatisfiable",o,e),r[0].waitUntilSatisfied()}}var a=e.map(function(){return(s||(s=n("Promise"))).resolve()}),i=(s||(s=n("Promise"))).resolve(),l=null,u=function(){if(a.every(function(t,n){return t===e[n].waitUntilSatisfied()})){l=null;return}var t=[],r=e.map(function(e){var n=e.waitUntilSatisfied();return e.isSatisfied()||(t.push(e.name),n.then(function(){var n=t.indexOf(e.name);t.splice(n,1)})),n});return a=r,l=t,(s||(s=n("Promise"))).all(r).then(u)};return function(e){if(l==null){var n=u();n!=null&&(i=i.then(function(){return n}))}return t==null||t(l==null?"satisfied":"unsatisfied",l,e),i}}l.JobRequirement=u,l.UnsatisfiableJobRequirement=c,l.joinRequirements=d}),98);
__d("WAJobPriorityBucket",["WAJobOrchestratorTypes","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e){var t;this.tasks=[],this.pendingTasks=[],this.lastJobStartedTimestampMs=null,this.jobMaxConcurrency=(t=e.jobMaxConcurrencyMap)!=null?t:{}}var n=t.prototype;return n.updateConfig=function(t){var e;this.jobMaxConcurrency=(e=t.jobMaxConcurrencyMap)!=null?e:{}},n.getStats=function(){return[].concat(this.tasks,this.pendingTasks).reduce(function(e,t){var n,r=(n=e[t.jobName])!=null?n:0;return e[t.jobName]=r+1,e},{})},n.next=function(){var e=this;if(this.tasks.length===0)return null;var t=this.pendingTasks.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),n=this.tasks.filter(function(n){var r,a;return((r=t.get(n.jobName))!=null?r:0)<((a=e.jobMaxConcurrency[n.jobName])!=null?a:o("WAJobOrchestratorTypes").DEFAULT_CONCURRENCY)});return n.length>0?[n[0]]:null},n.add=function(t,n,r,o){var e={jobId:r,jobInfo:n,jobName:t,run:o};return this.tasks.push(e),e},n.markJobTaskPending=function(n){this.pendingTasks.includes(function(e){return e.jobId===n.jobId})&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),n.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.lastJobStartedTimestampMs=Date.now(),this.pendingTasks.push(n),this.tasks=this.tasks.filter(function(e){return e.jobId!==n.jobId})},n.markJobTaskDone=function(t){this.pendingTasks=this.pendingTasks.filter(function(e){return e.jobId!==t}),this.tasks.includes(function(e){return e.jobId===t})&&o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),t).sendLogs("JobOrchestrator::markJobTaskDone")},n.count=function(){return this.tasks.length},n.pendingCount=function(){return this.pendingTasks.length},n.clearWaitingTasks=function(){this.tasks=[]},n.clear=function(){this.tasks=[],this.pendingTasks=[]},n.getLastJobStartedTimestamp=function(){return this.lastJobStartedTimestampMs},t})(),c=(function(e){function t(){return e.apply(this,arguments)||this}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.next=function(){var e=this,t,n;if(this.tasks.length===0)return null;var r=this.pendingTasks.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),o=this.tasks.filter(function(t){var n,o;return((n=r.get(t.jobName))!=null?n:0)<((o=e.jobMaxConcurrency[t.jobName])!=null?o:1)});if(o.length===0)return null;var a=(t=this.jobMaxConcurrency[o[0].jobName])!=null?t:1,i=(n=r.get(o[0].jobName))!=null?n:0;if(a>1&&i<a){var l=o.filter(function(e){return e.jobName===o[0].jobName}),s=Math.min(l.length,a-i);return l.slice(0,s)}return[o[0]]},t})(u);l.BaseJobBucket=u,l.LowJobBucket=c}),98);
__d("WAMetrics",["Promise","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){var t=o("WATimeUtils").performanceAbsoluteNow();return new(e||(e=n("Promise")))(function(e){setTimeout(function(){e(o("WATimeUtils").performanceAbsoluteNow()-t)},0)})}l.getEventLoopDelay=s}),98);
__d("WAConcurrentBucketJobQueue",["WABase64","WACryptoDependencies","WACustomError","WAJobOrchestratorTypes","WAJobPriorityBucket","WALogger","WAMetrics","WANullthrows","WAPromiseTimeout","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=30,c=new Map([[o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]);function d(e){var t=new Uint8Array(e);return o("WACryptoDependencies").getCrypto().getRandomValues(t),o("WABase64").encodeB64(t)}var m=(function(){function t(){this.$1=!1,this.$2=0,this.$3=0,this.$4=0,this.$5=new Map,this.$6=new Map,this.$7=new Map,this.$9=0}var n=t.prototype;return n.init=function(t,n){var e,a,i,l,s,c;if(this.$1)throw r("err")("WAConcurrentBucketJobQueue has already initialized");this.$4=(e=t==null?void 0:t.bestEffortWaitTimeoutSec)!=null?e:u,this.$2=t.maxConcurrency,this.$3=t.maxConcurrency,this.$8=n,this.$7=this.$11(t==null?void 0:t.jobPrioritiesQuota),this.$6=new Map(this.$7),this.$5=new Map,this.$9=Date.now();var d=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(a=t.maxConcurrencyPerJob)!=null?a:{}}),m=new(o("WAJobPriorityBucket")).LowJobBucket({jobMaxConcurrencyMap:(i=t.maxConcurrencyPerJob)!=null?i:{}}),p=new(o("WAJobPriorityBucket")).LowJobBucket({jobMaxConcurrencyMap:(l=t.maxConcurrencyPerJob)!=null?l:{}}),_=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(s=t.maxConcurrencyPerJob)!=null?s:{}}),f=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(c=t.maxConcurrencyPerJob)!=null?c:{}});this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION,d),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,d),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.OFFLINE,_),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.HISTORY_SYNC,f),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,m),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,p),this.$1=!0},n.updateConfig=function(n){this.$3+=n.maxConcurrency-this.$2,this.$2=n.maxConcurrency,this.$5.forEach(function(e){var t;return e.updateConfig({jobMaxConcurrencyMap:(t=n.maxConcurrencyPerJob)!=null?t:{}})}),this.$7=this.$11(n==null?void 0:n.jobPrioritiesQuota),o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated WAConcurrentBucketJobQueue config"])))},n.isInitialized=function(){return this.$1},n.clearQueue=function(){if(!this.$1)throw r("err")("WAConcurrentBucketJobQueue not initialized");this.$5.forEach(function(e){return e.clear()})},n.clearQueueByPriority=function(t){var e;if(!this.$1)throw r("err")("WAConcurrentBucketJobQueue not initialized");(e=this.$5.get(t))==null||e.clearWaitingTasks()},n.getIntStats=function(){var e=this,t=function(n){var t,r,o=e.$5.get(n);return((t=o==null?void 0:o.count())!=null?t:0)+((r=o==null?void 0:o.pendingCount())!=null?r:0)};return{highPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}},n.getStringStats=function(){var e=this,t=function(n){var t,r,o=(t=(r=e.$5.get(n))==null?void 0:r.getStats())!=null?t:{},a=Object.keys(o).reduce(function(e,t){var n=e[0],r=e[1],a=o[t];return a>n?[a,t]:[n,r]},[0,null]),i=a[1];return i};return{highPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}},n.enqueue=function(t,n,a,i){var e,l,s=this;if(!this.$1)return Promise.reject(r("err")("WAConcurrentBucketJobQueue not initialized"));var u,c,m=new Promise(function(e,t){u=e,c=t}),p=babelHelpers.extends({priority:o("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},a),_=this.getJobBucketByType(p.priority);if(!_)return Promise.reject(r("err")("WAConcurrentBucketJobQueue no bucket for job with name "+t+" was found."));o("WAMetrics").getEventLoopDelay().then(function(e){i!=null&&i.isActive()&&(i==null||i.addPoint("measure_event_loop_delay",{int:{eventLoopDelay:e}}))}),i==null||i.addPoint("scheduling_job",{string:babelHelpers.extends({},this.getStringStats(),{priority:p.priority}),int:babelHelpers.extends({},this.getIntStats(),{maxTimeoutMs:(e=a==null?void 0:a.maxTimeoutMs)!=null?e:0})});var f=p.priority+"-"+t+"-"+((l=a==null?void 0:a.jobId)!=null?l:d(8)),g=_.add(t,p,f,async function(){try{s.$8.logJobStarted(f);var e=await s.$12(n(),a==null?void 0:a.maxTimeoutMs);s.$8.logJobCompleted(f),u(e)}catch(e){e instanceof o("WACustomError").TimeoutError?s.$8.logJobTimeout(f):s.$8.logJobError(f),c(e)}});return this.$8.logJobCreated({jobId:f,jobName:t,jobPriority:p.priority,pendingJobsCount:_.count()}),a&&a.priority===o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$13(g),this.$14(),m},n.getAvailableThreadsCount=function(){return this.$3},n.getJobQuotaConfig=function(){return this.$7},n.getRemainingJobCountMap=function(){return this.$6},n.getJobBucketByType=function(t){return this.$5.get(t)},n.getSnapshot=function(t){var e=this.getJobBucketByType(t);return e?e.getStats():null},n.$11=function(t){var e;return t?e=new Map(t):e=new Map(c),e.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,0),e},n.$15=function(t){var e;return(e=this.$6.get(t))!=null?e:0},n.$16=function(){this.$6=new Map(this.$7)},n.$17=function(t){var e=this;t===void 0&&(t=!0);var n=0,r=null,a=0;this.$5.forEach(function(t,o){n+=t==null?void 0:t.count(),a+=e.$15(o),r==null&&t.count()>0&&e.$15(o)>0&&(r=t)});var i=r==null||a===0;return i&&this.$16(),this.$18(n,i)?this.getJobBucketByType(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT):r==null&&t?this.$17(!1):r},n.$18=function(t,n){var e,r=this;function a(e,t){var n=Date.now();return e>n?!1:n-e<t*1e3}function i(e,t){var n=Math.ceil(e-Date.now())+t*1e3;return n>0?n:0}var l=this.getJobBucketByType(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT),s=t-((e=l==null?void 0:l.count())!=null?e:0),u=l==null?void 0:l.getLastJobStartedTimestamp();if((l==null?void 0:l.count())===0)return!1;if(u==null&&a(this.$9,this.$4)){if(this.$10==null){var c=i(this.$9,this.$4);this.$10=setTimeout(function(){r.$14(),r.$10=null},c)}return!1}return s>0&&u!=null&&a(u,this.$4)?!1:n},n.$19=function(t){var e=this.$20(t);return r("WANullthrows")(this.$5.get(e))},n.$20=function(t){var e=t.split("-")[0],n=o("WAJobOrchestratorTypes").JOB_PRIORITY.cast(e);if(!n)throw r("err")("ConcurrentBucketQueue cannot extract known job priority type from id: "+t);return n},n.$21=function(t){var e=this.$20(t);this.$15(e)>0?this.$6.set(e,this.$15(e)-1):this.$6.set(e,0)},n.$14=function(){for(var e=this;this.$3>0;){var t=this.$17(),n=t==null?void 0:t.next();if(n==null)break;n.forEach(function(t){e.$21(t.jobId),e.$13(t)})}},n.$12=function(t,n){return n!==void 0?o("WAPromiseTimeout").promiseTimeout(t,n):t},n.$13=async function(t){var e=this,n=this.$19(t.jobId);this.$3--,n.markJobTaskPending(t);var r=t.jobId,a=t.jobName,i=t.run;try{var l;await this.$12(i(),((l=t.jobInfo)==null?void 0:l.maxTimeoutMs)===void 0?o("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(e){if(e instanceof o("WACustomError").TimeoutError)this.$8.logJobTimeout(r),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),a);else throw e}finally{this.$3++,n.markJobTaskDone(r),this.$3>0&&setTimeout(function(){return e.$14()},0)}},t})();l.WAConcurrentBucketJobQueue=m}),98);
__d("WAConcurrentPreemptiveJobQueue",["WACustomError","WAJobOrchestratorTypes","WALogger","WAPromiseTimeout","WARandomHex","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=(function(){function t(){this.$1=!1,this.$2=0,this.$3=0,this.$4={},this.$5=[],this.$6=[]}var n=t.prototype;return n.init=function(t,n){var e;if(this.$1)throw r("err")("ConcurrentPreemptiveJobQueue has already initialized");this.$2=t.maxConcurrency,this.$3=t.maxConcurrency,this.$4=(e=t.maxConcurrencyPerJob)!=null?e:{},this.$7=n,this.$1=!0},n.updateConfig=function(n){var t;this.$3+=n.maxConcurrency-this.$2,this.$2=n.maxConcurrency,this.$4=(t=n.maxConcurrencyPerJob)!=null?t:{},o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated ConcurrentPreemptiveJobQueue config"])))},n.isInitialized=function(){return this.$1},n.clearQueueByPriority=function(t){if(!this.$1)throw r("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=this.$5.filter(function(e){var n;return((n=e.jobInfo)==null?void 0:n.priority)!==t})},n.clearQueue=function(){if(!this.$1)throw r("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=[],this.$6=[]},n.enqueue=function(t,n,a){var e,i=this;if(!this.$1)return Promise.reject(r("err")("ConcurrentPreemptiveJobQueue not initialized"));var l,s,u=new Promise(function(e,t){l=e,s=t}),c=babelHelpers.extends({priority:o("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},a),d=(e=a==null?void 0:a.jobId)!=null?e:o("WARandomHex").randomHex(8).substr(0,64),m=this.$8(t,c,d,async function(){try{i.$7.logJobStarted(d);var e=await i.$9(n(),a==null?void 0:a.maxTimeoutMs);i.$7.logJobCompleted(d),l(e)}catch(e){e instanceof o("WACustomError").TimeoutError?i.$7.logJobTimeout(d):i.$7.logJobError(d),s(e)}});return a&&a.priority===o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$10(m),this.$11(),u},n.getAvailableThreadsCount=function(){return this.$3},n.getJobMaxConcurrency=function(){return this.$4},n.getSnapshot=function(t){},n.$11=function(){for(;this.$3>0;){var e=this.$12();if(e==null)break;this.$10(e)}},n.$9=function(t,n){return n!==void 0?o("WAPromiseTimeout").promiseTimeout(t,n):t},n.$10=async function(t){var e=this;this.$3--,this.$13(t);var n=t.jobId,r=t.jobName,a=t.run;try{var i;await this.$9(a(),((i=t.jobInfo)==null?void 0:i.maxTimeoutMs)===void 0?o("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(e){if(e instanceof o("WACustomError").TimeoutError)this.$7.logJobTimeout(n),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),r);else throw e}finally{this.$3++,this.$14(n),setTimeout(function(){return e.$11()},0)}},n.$8=function(t,n,r,o){var e={jobId:r,jobInfo:n,jobName:t,run:o};return this.$7.logJobCreated({jobId:r,jobName:t,jobPriority:n.priority,pendingJobsCount:this.$5.length}),this.$5.push(e),e},n.$13=function(t){this.$6.includes(function(e){return e.jobId===t.jobId})&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),t.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.$6.push(t),this.$5=this.$5.filter(function(e){return e.jobId!==t.jobId})},n.$14=function(t){this.$6=this.$6.filter(function(e){return e.jobId!==t}),this.$5.includes(function(e){return e.jobId===t})&&o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),t).sendLogs("JobOrchestrator::markJobTaskDone")},n.$12=function(){var e=this;if(this.$5.length===0)return null;var t=this.$6.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),n=this.$5.filter(function(n){var r,o;return((r=t.get(n.jobName))!=null?r:0)<((o=e.$4[n.jobName])!=null?o:1)});return n[0]},t})();l.WAConcurrentPreemptiveJobQueue=d}),98);
__d("WADefaultJobNoQueue",["WAJobOrchestratorTypes","WARandomHex","err"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(){this.$2=!1}var t=e.prototype;return t.init=function(t,n){if(this.$2)throw r("err")("DefaultNoQueue has already initialized");this.$1=n,this.$2=!0},t.updateConfig=function(t){},t.isInitialized=function(){return this.$2},t.clearQueue=function(){},t.clearQueueByPriority=function(t){},t.getSnapshot=function(){throw r("err")("getSnapshot is not implemented for DefaultNoQueue")},t.enqueue=async function(t,n,r){var e,a,i=(e=r==null?void 0:r.jobId)!=null?e:o("WARandomHex").randomHex(8).substr(0,64);this.$1.logJobCreated({jobId:i,jobName:t,jobPriority:(a=r==null?void 0:r.priority)!=null?a:o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,pendingJobsCount:0});try{this.$1.logJobStarted(i);var l=await n();return this.$1.logJobCompleted(i),l}catch(e){throw this.$1.logJobError(i),e}},e})();l.WADefaultJobNoQueue=e}),98);
__d("WAOrchestratorJobStatsLogger",["QPLFlow"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n){this.jobName=e,this.pendingJobsCount=n,this.jobPriority=t}var t=e.prototype;return t.logJobAdded=function(){this.webcJobAddedT=Date.now(),this.eventFlow=o("QPLFlow").startNoopQPLFlow()},t.logJobStarted=function(){this.webcJobStartedT=Date.now(),this.eventFlow.addPoint("start_job",{int:{startedAt:this.webcJobStartedT}})},t.logJobCompleted=function(t){this.webcJobCompletedT=Date.now(),this.jobResultType=t;var e={int:{pendingJobsCount:this.pendingJobsCount,completedAt:this.webcJobCompletedT}};t==="completed"?this.eventFlow.endSuccess(e):this.eventFlow.endFail(t,e)},e})(),s=(function(){function t(){this.$1=new Map}var n=t.prototype;return n.logJobCreated=function(n){var t=n.jobId,r=n.jobName,o=n.jobPriority,a=n.pendingJobsCount,i=new e(r,o,a);i.logJobAdded(),this.$1.set(t,i)},n.logJobStarted=function(t){var e=this.$1.get(t);e==null||e.logJobStarted()},n.logJobCompleted=function(t){this.$2(t,"completed")},n.logJobError=function(t){this.$2(t,"error")},n.logJobTimeout=function(t){this.$2(t,"timeout")},n.logJobAborted=function(t){this.$2(t,"aborted")},n.$2=function(t,n){var e=this.$1.get(t);e==null||e.logJobCompleted(n),this.$1.delete(t)},t})();l.JobInfoEvent=e,l.JobStatsLogger=s}),98);
__d("WAOrchestrator",["WAConcurrentBucketJobQueue","WAConcurrentPreemptiveJobQueue","WADefaultJobNoQueue","WAGlobals","WAJobOrchestratorTypes","WAOrchestratorJobStatsLogger"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e={maxConcurrency:1},t="default",n={},r=e,a=new(o("WAOrchestratorJobStatsLogger")).JobStatsLogger;return function(i,l){var c,d,m,p,_;i===void 0&&(i=!1);var f=i?t:o("WAGlobals").getConfig().orchestratorVersion(),g=(c=u())!=null?c:e,h;if(l==null||l.addPoint("get_orchestrator",{string:{orchestrator:f},int:{maxConcurrency:g.maxConcurrency,highPriorityQuota:(d=(m=g.jobPrioritiesQuota)==null?void 0:m.get(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH))!=null?d:0,lowPriorityQuota:(p=(_=g.jobPrioritiesQuota)==null?void 0:_.get(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW))!=null?p:0}}),n[f])return s(r,g)&&(r=g,n[f].updateConfig(g)),n[f];switch(f){case"preemptive":{h=new(o("WAConcurrentPreemptiveJobQueue")).WAConcurrentPreemptiveJobQueue;break}case"bucket":{h=new(o("WAConcurrentBucketJobQueue")).WAConcurrentBucketJobQueue;break}default:h=new(o("WADefaultJobNoQueue")).WADefaultJobNoQueue;break}return h.init(g,a),n[f]=h,r=g,h}}function s(e,t){var n,r,o,a;return e.maxConcurrency!==t.maxConcurrency||((n=e.jobPrioritiesQuota)==null?void 0:n.size)!==((r=t.jobPrioritiesQuota)==null?void 0:r.size)||Object.keys((o=e.maxConcurrencyPerJob)!=null?o:{}).length!==Object.keys((a=t.maxConcurrencyPerJob)!=null?a:{}).length?!0:JSON.stringify(e)!==JSON.stringify(t)}function u(){var e={jobPrioritiesQuota:new Map([[o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]),maxConcurrency:5,maxConcurrencyPerJob:{}};return e}l.getInstanceDelegate=e}),98);
__d("WAPromiseBackoffs",["Promise","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){if(e===0)return 0;for(var n=g(t.algo),r=1;r<e;r++)n();return d(t,n())}function u(e){var t=e.relativeDelay,n=t===void 0?!1:t,r=null,o=g(e.algo);return function(){var t=r;if(t==null)return r=n?Date.now():0,0;var a=d(e,o());if(n){var i=Date.now(),l=i-t;l>0&&(a=Math.max(0,a-l)),r=i}return a}}function c(t){var r=u(t);return function(o){return new(e||(e=n("Promise")))(function(e){var t=r();t>0?setTimeout(e,t,o):e(o)})}}function d(e,t){var n=e.jitter,r=n===void 0?.1:n,o=e.max,a=e.min,i=t;return o!=null&&i>o&&(i=o),a!=null&&i<a&&(i=a),r!==0&&(i=Math.ceil(i*(1+r*Math.random()))),i}function m(e){var t=e.second-e.first,n=e.first-t;return function(){var e=t+n;return n=t,t=e,e}}function p(e){var t=e.base,n=t===void 0?2:t,r=e.first;return function(){var e=r;return r*=n,e}}function _(e){var t=e.delay;return function(){return t}}function f(e){var t=e.backoff,n=e.toMs,r=g(t);return function(){return n(r())}}function g(e){switch(e.type){case"fibonacci":return m(e);case"exponential":return p(e);case"constant":return _(e);case"adjust":return f(e);default:throw r("err")("makeTimeFunc unrecognized backoff "+e.type)}}l.getDelay=s,l.createTimer=u,l.createPromiseTimer=c}),98);
__d("WAPersistedJobManager",["WAJobRequirement","WALogger","WAPromiseBackoffs","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M=1,w=(function(){function e(e){this.feature=e}var t=e.prototype;return t.toString=function(){return"RequiresPage: "+this.feature},e})(),A=(function(){function e(e){this.backoffOptions=e}var t=e.prototype;return t.toString=function(){return"RetryOnBackoff"},e})(),F=(function(e){function t(){return e.apply(this,arguments)||this}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.toString=function(){return"NonRetryableError"},t})(babelHelpers.wrapNativeSuper(Error)),O=function(t){this.result=t},B="$unstarted",W="$finished",q=(function(){function t(t){var n=this,r=t.accessors,a=t.isRestartAfterCrash,i=t.unfinishedJobEntries,l=new Map,u=i.then(function(t){var i=[],u=[];return t.forEach(function(e){e.stepHardStartCountAfterTimeout>=5?i.push(e):u.push(e)}),Promise.all(i.map(function(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),V(t),t.step).sendLogs("job-stuck-"+t.type),r.deletePersistedJob(t.jobId)})).then(function(){u.forEach(function(e){l.has(e.jobId)||(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",": restarting"])),U(e)),l.set(e.jobId,n.$1(e,a)))})})});this.implementationLoaders=new Map,this.implementations=new Map,this.stepBlockers=new WeakMap,this.accessors=r,this.activeJobs=l,this.initialJobsPromise=u,this.listeners=t.listeners,this.deprecatedJobs=t.deprecatedJobs}var n=t.prototype;return n.loadAndRunJobFromId=function(t){var e=this.activeJobs.get(t);if(e!=null)return e;var n=this.$2(t);return this.activeJobs.set(t,n),n},n.$2=async function(t){var e=this.accessors,n=this.initialJobsPromise;await n;var r=await e.readPersistedJob(t);return r?this.$1(r,!1):(o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]))),null)},n.$3=function(t){var e=this.implementationLoaders,n=this.implementations,r=n.get(t);if(r)return r;var o=e.get(t);if(!o)return null;var a=o();return n.set(t,a),a},n.$4=function(t,n){if(n==null||n.length===0)return Promise.resolve();var e=this.stepBlockers,r=e.get(n);return r==null&&(r=o("WAJobRequirement").joinRequirements(n.map(function(e){return e()}),G),e.set(n,r)),r(t)},n.$5=function(t,n,r,a){var e=this;r===void 0&&(r=!1);var i=t.step,l=n.findIndex(function(e){return e.stepName===i}),s=n[l].info(t.current,t.original,z(t,r)),u=s.code,m=s.requirements,p=this.$4(t,m);return a&&(p=p.then(a)),p.then(function(){return o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),H(t)),u(t.current,t.original,z(t,r))}).then(function(a){if(a instanceof O)return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),H(t)),a.result;var i=l+1;if(i>=n.length)return a;var s=n[i];return t.step=s.stepName,t.current=a,t.stepHardStartCountAfterTimeout=0,t.stepFirstStartTime=o("WATimeUtils").unixTime(),t.stepUnexpectedErrorCount=0,t.waitUntil=null,t.backedOffCount=0,e.accessors.updatePersistedJob(t).then(function(){return e.$5(t,n,r)})})},n.$1=async function(t,n){var e,r=this,a=this.accessors,i=this.activeJobs,l=this.deprecatedJobs,s=this.listeners,u=s.onJobFinished,c=s.onJobStarted,d=await this.$3(t.type),D=l[t.type];if(!d){if(D){if(D==="NOOP")return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),t.type),await a.deletePersistedJob(t.jobId),null}else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),t.type).sendLogs("missing-job-implementation"),await a.deletePersistedJob(t.jobId),null;d=await D()}var x=d;D&&o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),t.type);var $=(e=t.stepFirstStartTime)!=null?e:o("WATimeUtils").unixTime();if(t.stepFirstStartTime=$,t.stepUnexpectedErrorCount=t.stepUnexpectedErrorCount||0,t.backedOffCount=t.backedOffCount||0,t.step===W){var P=t.waitUntil,N=o("WATimeUtils").secondsUntil($);return P!=null&&o("WATimeUtils").isInFuture(P)&&N>0&&(o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),U(t)),P=o("WATimeUtils").castToUnixTime(P-N),o("WATimeUtils").isInFuture(P)&&(t.stepFirstStartTime=o("WATimeUtils").castToUnixTime($-N),t.waitUntil=P,await this.accessors.updatePersistedJob(t))),(P==null||!o("WATimeUtils").isInFuture(P))&&(o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),U(t)),await a.deletePersistedJob(t.jobId)),i.delete(t.jobId),t.current}var F=t.step!==B?d.find(function(e){return e.stepName===t.step}):d[0];if(!F)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),t.type,t.step).sendLogs("missing-job-step"),await a.deletePersistedJob(t.jobId),null;t.step=F.stepName;var O=function(){var e=t.waitUntil,a=Promise.resolve();if(e!=null){var i=o("WATimeUtils").futureUnixTime(o("WATimeUtils").DAY_SECONDS);e>i?(o("WALogger").LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),H(t),e,i),t.waitUntil=i,a=r.accessors.updatePersistedJob(t).then(function(){return o("WATimeUtils").delayUntil(i)})):(o("WALogger").LOG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),H(t),e),a=o("WATimeUtils").delayUntil(e))}return a.then(function(){var e=function(){return t.waitUntil=null,o("WATimeUtils").happenedWithin($,o("WATimeUtils").DAY_SECONDS)||t.stepHardStartCountAfterTimeout++,r.accessors.updatePersistedJob(t)};return r.$5(t,x,n,e).catch(function(e){if(e instanceof w)return o("WALogger").LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["",": requires page"])),H(t)),t.stepHardStartCountAfterTimeout>0&&(--t.stepHardStartCountAfterTimeout,r.accessors.updatePersistedJob(t)),new Promise(function(){});if(e instanceof A){o("WALogger").LOG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),H(t));var n=o("WAPromiseBackoffs").getDelay(++t.backedOffCount,e.backoffOptions);return t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(n/1e3)),t.stepHardStartCountAfterTimeout>0&&--t.stepHardStartCountAfterTimeout,r.accessors.updatePersistedJob(t).then(O)}else if(t.stepUnexpectedErrorCount<M)return o("WALogger").WARN(S||(S=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),H(t),t.stepUnexpectedErrorCount),o("WALogger").WARN(R||(R=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),H(t),e),t.stepUnexpectedErrorCount++,r.accessors.updatePersistedJob(t).then(O);throw e})})},q=O(),V=q.then(async function(e){o("WALogger").LOG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),H(t));var n=null;try{n=u(t.jobId,t.type,t.original,e)}catch(e){o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),t.type,e).sendLogs("onJobFinished-threw")}n!=null&&n>0?(t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(n/1e3)),t.step=W,t.current=e,t.stepFirstStartTime=o("WATimeUtils").unixTime(),await r.accessors.updatePersistedJob(t)):(await a.deletePersistedJob(t.jobId),i.delete(t.jobId))},async function(e){o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),t.type,e).sendLogs("job-threw-exception-"+t.type);var r=x.find(function(e){return e.stepName===t.step});if(!r)o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),t.type,t.step);else{var l=r.info(t.current,t.original,z(t,n));l.stopRetryIf!=null&&await l.stopRetryIf.onStopRetry(t.current,t.original,z(t,n))}await a.deletePersistedJob(t.jobId),i.delete(t.jobId)});try{c(t.jobId,t.type,t.original)}catch(e){o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),t.type,e).sendLogs("onJobStarted-threw")}return V.then(function(){return q})},n.addPersistedJobImplementation=function(t,n){var e=this.deprecatedJobs,r=this.implementationLoaders;if(r.has(t)){o("WALogger").ERROR(D||(D=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),t).sendLogs("repeat-job-loader");return}e&&e[t],r.set(t,n)},n.fireAndForget=function(t){var e=this;this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;return e.loadAndRunJobFromId(n)})},n.waitUntilPersisted=function(t){var e=this;return this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;e.loadAndRunJobFromId(n)})},n.waitUntilCompleted=function(t){var e=this;return this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;return e.loadAndRunJobFromId(n)})},n.fireAndForgetNonPersisted=function(t){o("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["fireAndForgetNonPersisted not implemented in PersistedJobManager"])))},n.waitUntilCompletedNonPersisted=function(t){return Promise.resolve(function(){return o("WALogger").LOG($||($=babelHelpers.taggedTemplateLiteralLoose(["waitUntilCompletedNonPersisted not implemented in PersistedJobManager"])))})},t})();function U(e){return"Job["+e.jobId+"] ("+e.type+")"}function V(e){return"[Job "+e.type+"] "}function H(e){return"Job["+e.jobId+"] ("+e.type+"."+e.step+")"}function G(e,t,n){e==="unsatisfiable"?o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),H(n),t):e==="unsatisfied"&&o("WALogger").LOG(N||(N=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),H(n),t)}function z(e,t){return t===void 0&&(t=!1),{jobStartTime:e.startTime,afterCrash:t,interruptJob:j}}function j(e){return new O(e)}l.RequiresPage=w,l.RetryOnBackoff=A,l.NonRetryableError=F,l.InterruptJob=O,l.UNSTARTED_JOB=B,l.FINISHED_JOB=W,l.PersistedJobManager=q}),98);
__d("WaJobInMemoryAccessors",["Promise","WARandomHex","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){var t=-1,r=new Map;return{deletePersistedJob:function(o){return(e||(e=n("Promise"))).resolve(r.delete(o))},loadAllJobs:function(){return(e||(e=n("Promise"))).resolve(Array.from(r.values()))},maybeCreateJob:function(i){var a,l=JSON.stringify([i.type,(a=i.uniqKey)!=null?a:o("WARandomHex").randomHex(32)]),s={backedOffCount:0,current:i.args,original:i.args,startTime:o("WATimeUtils").unixTime(),step:"$unstarted",stepFirstStartTime:null,stepHardStartCountAfterTimeout:0,stepUnexpectedErrorCount:0,type:i.type,uniqKey:l,version:i.version,waitUntil:null,scheduleConfig:i.scheduleConfig},u=function(){var o=t--,a=babelHelpers.extends({},s,{jobId:o});return r.set(o,a),(e||(e=n("Promise"))).resolve({id:o,newlyCreated:!0})};if(i.uniqKey!=null){var c=Array.from(r.values()).filter(function(e){return e.uniqKey===l});if(c.length===0)return u();var d=null;return c.forEach(function(e){e.step!=="$finished"?d=e:r.delete(e.jobId)}),d!=null?(e||(e=n("Promise"))).resolve({id:d.jobId,newlyCreated:!1}):u()}return u()},readPersistedJob:function(o){var t=r.get(o);return(e||(e=n("Promise"))).resolve(t&&babelHelpers.extends({},t))},updatePersistedJob:function(o){return(e||(e=n("Promise"))).resolve(r.set(o.jobId,babelHelpers.extends({},o)))}}}l.getJobInMemoryAccessors=s}),98);
__d("WAPersistedJobManagerV2",["QPLFlow","WAJobOrchestratorTypes","WAJobRequirement","WALogger","WAOrchestrator","WAPersistedJobManager","WAPromiseBackoffs","WAResolvable","WATimeUtils","WaJobInMemoryAccessors","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F=1;function O(e){var t=e.code,n=e.annotations,r=n===void 0?{}:n,o=e.eventFlow,a=o===void 0?B(r):o;return t(a).then(function(e){return a.endSuccess(),e}).catch(function(e){throw a.endFail("error",{string:{error:""+e}}),e})}function B(e){return e===void 0&&(e={}),o("QPLFlow").startNoopQPLFlow()}var W=(function(){function t(t){var n=this;this.$1=[];var r=t.accessors,a=t.ignoreForceNonPersistedJobList,i=t.isRestartAfterCrash,l=t.unfinishedJobEntries;this.getOrchestratorDelegate=o("WAOrchestrator").getInstanceDelegate(),this.activeJobs=new Map,this.implementationLoaders=new Map,this.implementations=new Map,this.stepBlockers=new WeakMap,this.accessors=r,this.isRestartAfterCrash=i||!1,this.listeners=t.listeners,this.deprecatedJobs=t.deprecatedJobs,this.inMemoryAccessors=o("WaJobInMemoryAccessors").getJobInMemoryAccessors(),this.offlineQueueMode=!0,this.$1=a,t.offlineQueueCompletePromise!=null?t.offlineQueueCompletePromise.finally(function(){n.offlineQueueMode=!1}):this.offlineQueueMode=!1,this.initialJobsPromise=l.then(function(t){var r=[],a=[];return t.forEach(function(e){e.stepHardStartCountAfterTimeout>=5?r.push(e):a.push(e)}),Promise.all(r.map(function(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),U(t),t.step).sendLogs("job-stuck-"+t.type),n.accessors.deletePersistedJob(t.jobId)})).then(function(){a.forEach(function(e){var t=n.$2(e.jobId);if(t.alreadyActive===!0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[JOB MANAGER] Restarting job with the same id"])));return}t.deferred.resolve(O({code:function(r){return n.$3(e,n.accessors,{eventFlow:r})},annotations:{string:{name:e.type},bool:{offlineQueueMode:n.offlineQueueMode}}}))})})})}var n=t.prototype;return n.$4=async function(t,n,a){var e;a===void 0&&(a={});var i=this.$2(t);if((e=a.eventFlow)==null||e.addPoint("start_load_and_run",{bool:{skipped:i.alreadyActive}}),i.alreadyActive===!0)return i.deferred;var l=await n.readPersistedJob(t);if(l==null)throw o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]))).sendLogs("missing-job-entry"),r("err")("Persisted job missing for given ID "+t);return i.deferred.resolve(this.$3(l,n,a)),i.deferred.promise},n.$3=function(t,n,r){var e,a;return r===void 0&&(r={}),(e=r.eventFlow)==null||e.addPoint("enqueueing_job",{string:{name:t.type}}),this.getOrchestratorDelegate(((a=t.scheduleConfig)==null?void 0:a.priority)===o("WAJobOrchestratorTypes").JOB_PRIORITY.SKIP,r.eventFlow).enqueue(t.type,this.$5(t,n,r),t.scheduleConfig,r.eventFlow)},n.$6=function(t,n,r){var e=this;return r===void 0&&(r={}),n.maybeCreateJob(t).then(function(t){var o,a=t.id;return(o=r.eventFlow)==null||o.addPoint("job_persisted",{int:{jobId:a},bool:{nonPersisted:n===e.inMemoryAccessors}}),a})},n.$2=function(t){var e=this.activeJobs.get(t);if(e!=null)return{alreadyActive:!0,deferred:e};var n=new(o("WAResolvable")).Resolvable;return this.activeJobs.set(t,n.promise),{alreadyActive:!1,deferred:n}},n.$5=function(t,n,r){var e=this;return function(){return e.$7(t,n,r)}},n.$8=function(t){var e=this.implementationLoaders,n=this.implementations,r=n.get(t);if(r)return r;var o=e.get(t);if(!o)return null;var a=o();return n.set(t,a),a},n.$9=function(t,n){if(n==null||n.length===0)return Promise.resolve();var e=this.stepBlockers,r=e.get(n);return r==null&&(r=o("WAJobRequirement").joinRequirements(n.map(function(e){return e()}),H),e.set(n,r)),r(t)},n.$10=function(t,n,r,a,i){var e,l=this;i===void 0&&(i={});var s=t.step;(e=i.eventFlow)==null||e.addPoint("start_step");var u=n.findIndex(function(e){return e.stepName===s}),m=n[u].info(t.current,t.original,G(t,this.isRestartAfterCrash)),p=m.code,_=m.requirements,f=this.$9(t,_);return a&&(f=f.then(a)),f.then(function(){var e;return o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),V(t)),(e=i.eventFlow)==null||e.addPoint("run_step"),p(t.current,t.original,G(t,l.isRestartAfterCrash,i.eventFlow))}).then(function(e){var a;if((a=i.eventFlow)==null||a.addPoint("step_is_complete"),e instanceof o("WAPersistedJobManager").InterruptJob)return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),V(t)),e.result;var s=u+1;if(s>=n.length)return e;var c=n[s];return t.step=c.stepName,t.current=e,t.stepHardStartCountAfterTimeout=0,t.stepFirstStartTime=o("WATimeUtils").unixTime(),t.stepUnexpectedErrorCount=0,t.waitUntil=null,t.backedOffCount=0,r.updatePersistedJob(t).then(function(){return l.$10(t,n,r,void 0,i)})})},n.$7=async function(t,n,r){var e,a,i=this;r===void 0&&(r={});var l=this.activeJobs,s=this.deprecatedJobs,u=this.listeners,c=u.onJobFinished,d=u.onJobStarted;(e=r.eventFlow)==null||e.addPoint("run_job");var T=await this.$8(t.type),D=s[t.type];if(!T){if(D){if(D==="NOOP")return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),t.type),await n.deletePersistedJob(t.jobId),null}else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),t.type).sendLogs("missing-job-implementation"),await n.deletePersistedJob(t.jobId),null;T=await D()}var x=T;D&&o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),t.type);var $=(a=t.stepFirstStartTime)!=null?a:o("WATimeUtils").unixTime();if(t.stepFirstStartTime=$,t.stepUnexpectedErrorCount=t.stepUnexpectedErrorCount||0,t.backedOffCount=t.backedOffCount||0,t.step===o("WAPersistedJobManager").FINISHED_JOB){var P=t.waitUntil,N=o("WATimeUtils").secondsUntil($);return P!=null&&o("WATimeUtils").isInFuture(P)&&N>0&&(o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),q(t)),P=o("WATimeUtils").castToUnixTime(P-N),o("WATimeUtils").isInFuture(P)&&(t.stepFirstStartTime=o("WATimeUtils").castToUnixTime($-N),t.waitUntil=P,await n.updatePersistedJob(t))),(P==null||!o("WATimeUtils").isInFuture(P))&&(o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),q(t)),await n.deletePersistedJob(t.jobId)),l.delete(t.jobId),t.current}var M=t.step!==o("WAPersistedJobManager").UNSTARTED_JOB?T.find(function(e){return e.stepName===t.step}):T[0];if(!M)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),t.type,t.step).sendLogs("missing-job-step"),await n.deletePersistedJob(t.jobId),null;t.step=M.stepName;var w=function(){var e=t.waitUntil,a=Promise.resolve();if(e!=null){var l=o("WATimeUtils").futureUnixTime(o("WATimeUtils").DAY_SECONDS);e>l?(o("WALogger").LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),V(t),e,l),t.waitUntil=l,a=n.updatePersistedJob(t).then(function(){return o("WATimeUtils").delayUntil(l)})):(o("WALogger").LOG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),V(t),e),a=o("WATimeUtils").delayUntil(e))}return a.then(function(){var e=function(){return t.waitUntil=null,o("WATimeUtils").happenedWithin($,o("WATimeUtils").DAY_SECONDS)||t.stepHardStartCountAfterTimeout++,n.updatePersistedJob(t)};return i.$10(t,x,n,e,r).catch(function(e){if(e instanceof o("WAPersistedJobManager").RetryOnBackoff){var a;o("WALogger").LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),V(t)),(a=r.eventFlow)==null||a.addPoint("retry_on_backoff");var i=o("WAPromiseBackoffs").getDelay(++t.backedOffCount,e.backoffOptions);return t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(i/1e3)),t.stepHardStartCountAfterTimeout>0&&--t.stepHardStartCountAfterTimeout,n.updatePersistedJob(t).then(w)}else{if(!(e instanceof o("WAPersistedJobManager").NonRetryableError)&&t.stepUnexpectedErrorCount<F){var l;return(l=r.eventFlow)==null||l.addPoint("retry_on_unexpected_error"),o("WALogger").WARN(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),V(t),t.stepUnexpectedErrorCount),o("WALogger").WARN(S||(S=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),V(t),e),t.stepUnexpectedErrorCount++,n.updatePersistedJob(t).then(w)}throw e}})})},A=w(),O=A.then(async function(e){o("WALogger").LOG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),V(t));var r=null;try{r=c(t.jobId,t.type,t.original,e)}catch(e){o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),t.type,e).sendLogs("onJobFinished-threw")}r!=null&&r>0?(t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(r/1e3)),t.step=o("WAPersistedJobManager").FINISHED_JOB,t.current=e,t.stepFirstStartTime=o("WATimeUtils").unixTime(),await n.updatePersistedJob(t)):(await n.deletePersistedJob(t.jobId),l.delete(t.jobId))},async function(e){o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),t.type,e).sendLogs("job-threw-exception-"+t.type);var r=x.find(function(e){return e.stepName===t.step});if(!r)o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),t.type,t.step);else{var a=r.info(t.current,t.original,G(t,i.isRestartAfterCrash));a.stopRetryIf!=null&&await a.stopRetryIf.onStopRetry(t.current,t.original,G(t,i.isRestartAfterCrash))}await n.deletePersistedJob(t.jobId),l.delete(t.jobId)});try{d(t.jobId,t.type,t.original)}catch(e){o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),t.type,e).sendLogs("onJobStarted-threw")}return O.then(function(){return A})},n.addPersistedJobImplementation=function(t,n){var e=this.deprecatedJobs,r=this.implementationLoaders;if(r.has(t)){o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),t).sendLogs("repeat-job-loader");return}e&&e[t],r.set(t,n)},n.fireAndForget=function(t){var e=this;if(this.$1.indexOf(t.type)===-1){o("WALogger").LOG(D||(D=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.fireAndForgetNonPersisted(t);return}o("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type),O({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.accessors,n).then(function(t){return e.$4(t,e.accessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},n.waitUntilPersisted=async function(t){var e=this;if(this.$1.indexOf(t.type)===-1)return o("WALogger").LOG($||($=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.fireAndForgetNonPersisted(t),Promise.resolve();o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type);var n=B({string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}});return await this.initialJobsPromise,n.addPoint("initial_jobs_promise_fulfilled"),this.$6(t,this.accessors,{eventFlow:n}).then(function(t){O({code:function(r){var n={eventFlow:r};return e.$4(t,e.accessors,n)},eventFlow:n})}).catch(function(e){throw n.endFail("error",{string:{error:""+e}}),e})},n.waitUntilCompleted=function(t){var e=this;return this.$1.indexOf(t.type)===-1?(o("WALogger").LOG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.waitUntilCompletedNonPersisted(t)):(o("WALogger").LOG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type),O({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.accessors,n).then(function(t){return e.$4(t,e.accessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}}))},n.fireAndForgetNonPersisted=function(t){var e=this;O({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.inMemoryAccessors,n).then(function(t){return e.$4(t,e.inMemoryAccessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},n.waitUntilCompletedNonPersisted=function(t){var e=this;return O({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.inMemoryAccessors,n).then(function(t){return e.$4(t,e.inMemoryAccessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},t})();function q(e){return"Job["+e.jobId+"] ("+e.type+")"}function U(e){return"[Job "+e.type+"] "}function V(e){return"Job["+e.jobId+"] ("+e.type+"."+e.step+")"}function H(e,t,n){e==="unsatisfiable"?o("WALogger").LOG(w||(w=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),V(n),t):e==="unsatisfied"&&o("WALogger").LOG(A||(A=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),V(n),t)}function G(e,t,n){return t===void 0&&(t=!1),{jobStartTime:e.startTime,afterCrash:t,interruptJob:z,eventFlow:n}}function z(e){return new(o("WAPersistedJobManager")).InterruptJob(e)}l.PersistedJobManager=W}),98);
__d("WAWaitForComms",["WACommsConnectionState","WAResolvable"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAResolvable")).Resolvable;function s(){return e.promise}function u(){o("WACommsConnectionState").WACommsConnectionState.set(!1),e.isSettled&&(e=new(o("WAResolvable")).Resolvable)}function c(){o("WACommsConnectionState").WACommsConnectionState.set(!0),e.resolve()}function d(){return!e.resolveWasCalled()}function m(t){return e.reject(t)}l.waitForComms=s,l.commsConnectionLost=u,l.unblockComms=c,l.isStillWaitingForComms=d,l.failComms=m}),98);
__d("MAWJobManager",["MAWBridge","MAWDefinePersistedJob","MAWJobPersistenceAccessorsApi","WAPersistedJobManagerV2","WAWaitForComms","WAWaitForUserUnblocked","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAPersistedJobManagerV2")).PersistedJobManager({accessors:o("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors(),deprecatedJobs:{removeCurrentDevice:"NOOP"},ignoreForceNonPersistedJobList:["sendMsg","sendBumpMsg","sendReactionMsg","sendMediaMsg","sendWrittenMsg","downloadAndHandleMedia"],isRestartAfterCrash:!1,listeners:{onJobFinished:function(t,n,r,a){return o("MAWBridge").getBridge().fireAndForget("event","onJobFinished",{id:t,originalArgs:r,result:a,type:n},!0),null},onJobStarted:r("emptyFunction")},offlineQueueCompletePromise:o("WAWaitForUserUnblocked").waitForUserUnblocked(),unfinishedJobEntries:o("WAWaitForComms").waitForComms().then(function(){return o("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors().loadAllJobs()})});function s(){return o("MAWDefinePersistedJob").persistedJobsApi}function u(){return e}l.getPersistedJobsApi=s,l.getJobManager=u}),98);
__d("WAJobBuilder",["Promise","WAPersistedJobManager","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(){function e(e){this.steps=e}var t=e.prototype;return t.step=function(t,n){return this.$1(t,typeof n=="function"?{code:n}:n)},t.$1=function(n,r){var t=r.code,a=r.requirements,i=r.stopRetryIf,l=d(a,t,i);if(i){var s=i.appCrashed,u=i.onStopRetry,p=i.timePassedSeconds,_=d(null,m(u),i);p!=null&&(l=c(function(e,t,n){var r=n.jobStartTime;return o("WATimeUtils").happenedWithin(r,p)},l,_)),s&&(l=c(function(e,t,n){var r=n.afterCrash;return!r},l,_))}return new e([].concat(this.steps,[{stepName:n,info:l}]))},t.finalStep=function(t,n){var e=this.step(t,n);return{end:function(){return e.steps}}},e})();function u(){return new s([])}function c(e,t,n){return function(r,o,a){return e(r,o,a)?t(r,o,a):n(r,o,a)}}function d(e,t,n){var r={requirements:e,code:t,stopRetryIf:n};return function(){return r}}function m(t){return function(r,a,i){return(e||(e=n("Promise"))).resolve(t(r,a,i)).then(function(e){return e instanceof o("WAPersistedJobManager").InterruptJob?e:new(o("WAPersistedJobManager")).InterruptJob(e)})}}l.JobBuilder=s,l.definePersistedJob=u}),98);
__d("MAWDefinePersistedJob",["MAWJobManager","Promise","WAJobBuilder"],(function(t,n,r,o,a,i,l){"use strict";var e,s={definePersistedJob:function(){return o("WAJobBuilder").definePersistedJob()}};function u(t){var r=o("MAWJobManager").getJobManager();Object.keys(t).forEach(function(o){var a=t[o];r.addPersistedJobImplementation(o,function(){return(e||(e=n("Promise"))).resolve(a)})})}function c(e){var t=o("MAWJobManager").getJobManager();Object.keys(e).forEach(function(n){var r=e[n];t.addPersistedJobImplementation(n,r)})}l.persistedJobsApi=s,l.setMsgrJobImplementations=u,l.setMsgrDeferredJobImplementations=c}),98);
__d("MAWMediaGalleryEBTaggingUtils",["LSThreadMediaGalleryGroup","MAWMpsGating","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("13725")}function s(e){return u(e)!=null}function u(e){return e===r("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS?r("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS:e===r("LSThreadMediaGalleryGroup").FILES_ONLY&&o("MAWMpsGating").isMpsMediaGalleryEnabled()?r("LSThreadMediaGalleryGroup").FILES_ONLY:void 0}l.isMediaGalleryEBTaggingRestoreEnabled=e,l.isMediaGalleryGroupSupportedForTaggedRestore=s,l.toMediaGalleryGroupForTaggedRestore=u}),98);
__d("MAWMediaPreviewDownloadManager",["WAResolvable"],(function(t,n,r,o,a,i,l){"use strict";var e=1e4,s=[],u=new Map;function c(e){if(!u.has(e)){_();var t=new(o("WAResolvable")).Resolvable;u.set(e,t),s.push(e)}}function d(e,t){var n=u.get(e);n!=null&&(n.reject(t),p(e))}function m(e){return u.get(e)}function p(e){u.delete(e)}function _(){if(s.length>=e){var t=s.shift();t!=null&&u.delete(t)}}function f(){s=[],u.clear()}l.markMediaPreviewAsDownloading=c,l.markMediaPreviewAsFailed=d,l.getMediaPreviewDownloadingResolvable=m,l.removeMediaPreviewDownloadingResolvable=p,l.clear=f}),98);
__d("MAWUnsafeCoerce",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.unsafeCoerce=e}),66);
__d("MAWUpdateClientRestoreStatusOperationType",[],(function(t,n,r,o,a,i){"use strict";var e=0,l=1;i.upsertClientRestoreStatus=e,i.markCompleteClientRestoreStatus=l}),66);
__d("MpsMediaEntryCache",["FBLogger","MpsMessageToBridgeWrapper","WADirectPath","WAHashUtils","WALongInt","WAMediaUtils","WAProgressiveJpegGetScanLengths","WATimeUtils","getErrorSafe","getMediaTypeFromConsumerMessage","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map;function s(t){var n,r,o=e.get(t.plaintextHash);if(((n=t.mediaKeyTimestamp)!=null?n:0)>=((r=o==null?void 0:o.mediaKeyTimestamp)!=null?r:0))return e.set(t.plaintextHash,t),t}function u(e){try{var t=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(e);return[c(t),p(t)].concat(m(t)).filter(Boolean)}catch(e){var n=r("getErrorSafe")(e);if(n.message.includes("FormatError"))return r("FBLogger")("mps").catching(n).warn("Error in hydrateCache"),[];throw r("FBLogger")("mps").catching(n).mustfixThrow("Error in hydrateCache")}}function c(e){var t,n=e.deserialize(),r=(t=n.encryptedTransportMessage())==null?void 0:t.consumerMessage();if(r!=null)return d(e,r)}function d(e,t){var n,r,a,i,l,s,u,c,d,m=(n=(r=(a=(i=(l=t.audioMessage())==null?void 0:l.payload)!=null?i:(s=t.documentMessage())==null?void 0:s.payload)!=null?a:(u=t.imageMessage())==null?void 0:u.payload)!=null?r:(c=t.stickerMessage())==null?void 0:c.payload)!=null?n:(d=t.videoMessage())==null?void 0:d.payload;if(m!=null){var p=o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(t.proto);return _(m,p,e)}}function m(e){var t,n,r=(t=e.deserialize().encryptedTransportMessage())==null?void 0:t.armadillo(),o=r==null?void 0:r.extendedContentMessage();if(o==null||r==null)return[];var a="xma-image",i=o.previews().map(function(t){return _(t,a,e)}),l=o.headerImage();l!=null&&i.push(_(l,a,e));var s=o.favicon();s!=null&&i.push(_(s,a,e));var u=(n=o.associatedMessage())==null?void 0:n.consumerMessage();return u!=null&&i.push(d(e,u)),i.filter(Boolean)}function p(e){var t,n=(t=e.deserialize().encryptedTransportMessage())==null?void 0:t.armadillo(),a=n==null?void 0:n.noteReply(),i=a==null?void 0:a.stickerContent(),l=a==null?void 0:a.videoContent(),s=i!=null?i:l;if(s!=null){var u=l!=null?o("getMediaTypeFromConsumerMessage").getMediaTypeForVideo(l):void 0,c=i!=null?"sticker":void 0,d=r("nullthrows")(u!=null?u:c);return _(s,d,e)}}function _(e,t,n){var a,i,l,u,c,d,m,p,_,f,g,h,y,C=e.ancillary,b=e.integral;if(C==null||b==null){var v=Object.entries({ancillary:C,integral:b}).filter(function(e){var t=e[0],n=e[1];return n==null}).map(function(e){var t=e[0];return t}).join(", ");r("FBLogger")("mps").warn("invalid media entry, missing %s. type %s",v,t);return}var S=o("WADirectPath").validateDirectPath((a=b.transport)==null||(a=a.integral)==null?void 0:a.directPath).value,R=(i=b.transport)==null||(i=i.integral)==null?void 0:i.mediaKeyTimestamp,L=R!=null?o("WATimeUtils").castLongIntToUnixTime(R):void 0,E=(l=b.transport)==null||(l=l.integral)==null?void 0:l.fileSha256,k=E!=null?o("WAHashUtils").toPlaintextHash(E):void 0;if(S==null||E==null||k==null||t==null){var I=Object.entries({directPath:S,fileSha256:E,mediaType:t,plaintextHash:k}).filter(function(e){var t=e[0],n=e[1];return n==null}).map(function(e){var t=e[0];return t}).join(", ");r("FBLogger")("mps").warn("Missing media entry fields: %s. type :%s",I,t);return}var T=null,D=C.scanLengths,x=C.scansSidecar;x!=null&&D!=null&&(T={scanLengths:D.map(o("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength),sidecar:x});var $=void 0,P=(u=b.transport)==null||(u=u.ancillary)==null||(u=u.thumbnail)==null?void 0:u.downloadableThumbnail;if(P!=null){var N;$={directPath:o("WADirectPath").validateDirectPath(P.directPath).value,fileEncSha256:P.fileEncSha256,fileSha256:P.fileSha256,mediaKey:P.mediaKey==null?void 0:o("WAMediaUtils").castToMediaKey(P.mediaKey),mediaKeyTimestamp:o("WATimeUtils").castLongIntToUnixTime((N=P.mediaKeyTimestamp)!=null?N:0),objectId:P.objectId==null?void 0:o("WAMediaUtils").stringToDeliveryObjectId(P.objectId)}}var M={directPath:S,downloadableThumbnail:$,fileEncSha256:(c=b.transport)==null||(c=c.integral)==null?void 0:c.fileEncSha256,filename:null,fileSha256:E,mediaKey:((d=b.transport)==null||(d=d.integral)==null?void 0:d.mediaKey)==null?void 0:o("WAMediaUtils").castToMediaKey((m=b.transport)==null||(m=m.integral)==null?void 0:m.mediaKey),mediaKeyTimestamp:L,objectId:(b==null||(p=b.transport)==null||(p=p.ancillary)==null?void 0:p.objectId)==null?void 0:o("WAMediaUtils").stringToDeliveryObjectId(b==null||(_=b.transport)==null||(_=_.ancillary)==null?void 0:_.objectId),progressiveJpegDetails:T,serverMediaType:t,size:o("WALongInt").numberOrThrowIfTooLarge((f=b==null||(g=b.transport)==null||(g=g.ancillary)==null?void 0:g.fileLength)!=null?f:0),uploadToken:void 0},w=o("WAMediaUtils").encodeMediaEntryWithUpdatedPath(M,S);return s({decodedMediaEntry:M,mediaEntry:w,mediaKeyTimestamp:L,message:{messageId:n.message.messageId,threadId:n.message.threadId},plaintextHash:k,serverMediaType:t,thumbnailHash:((h=$)==null?void 0:h.fileSha256)!=null?o("WAHashUtils").toPlaintextHash((y=$)==null?void 0:y.fileSha256):void 0})}function f(t){return e.get(t)}function g(){e.clear()}l.storeEntry=s,l.hydrateCache=u,l.getEntry=f,l.clear__TEST_ONLY=g}),98);
__d("WATypedArraysCast",["WABase64"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return t instanceof e?t:typeof t=="string"?new e(o("WABase64").decodeB64(t)):new e(t)}l.castTypedArrays=e}),98);
__d("WACryptoHmac",["WACryptoDependencies","WATypedArraysCast"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=new Uint8Array(e),u={name:"HMAC",hash:"SHA-256"},c={name:"HMAC",hash:"SHA-512"},d={name:"HMAC",hash:"SHA-1"};function m(e,t){var n=o("WATypedArraysCast").castTypedArrays(Uint8Array,t);return o("WACryptoDependencies").getCrypto().subtle.importKey("raw",n,e,!1,["sign"]).then(function(t){return{key:t,algo:e}})}function p(e){return m(u,e)}function _(e,t,n){var r=e.algo,a=e.key;return o("WACryptoDependencies").getCrypto().subtle.sign(r,a,t).then(function(e){return n!=null&&n!==0?e.slice(0,n):e})}function f(e,t){return m(u,e!=null?e:s).then(function(e){return _(e,t)})}function g(e,t,n){return m(u,e).then(function(e){return _(e,t,n)})}function h(e,t,n){return m(c,e).then(function(e){return _(e,t,n)})}function y(e,t,n){return m(d,e).then(function(e){return _(e,t,n)})}l.SHA256_BYTE_LENGTH=e,l.DEFAULT_SALT=s,l.encodeKeySha256=p,l.sign=_,l.extractSha256=f,l.hmacSha256=g,l.hmacSha512=h,l.hmacSha1=y}),98);
__d("WACryptoHkdf",["Promise","WABinary","WACryptoHmac","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s=255*o("WACryptoHmac").SHA256_BYTE_LENGTH;function u(t,a,i){if(i<0||i>s)return(e||(e=n("Promise"))).reject(r("err")("HKDF::expand given bad length "+i));for(var l,u=Math.ceil(i/o("WACryptoHmac").SHA256_BYTE_LENGTH),c=o("WABinary").Binary.build(a).readByteArrayView(),d=new(o("WABinary")).Binary,m=o("WACryptoHmac").encodeKeySha256(t).then(function(e){return l=e,new Uint8Array(0)}),p=function(t){m=m.then(function(e){return o("WACryptoHmac").sign(l,o("WABinary").Binary.build(e,c,t).readByteArrayView())}).then(function(e){var t=new Uint8Array(e);return d.writeByteArray(t),t})},_=1;_<=u;_++)p(_);return m.then(function(){return d.readBuffer(i)})}function c(e,t,n){return o("WACryptoHmac").extractSha256(null,e).then(function(e){return u(new Uint8Array(e),t,n)})}function d(e,t,n,r){return o("WACryptoHmac").extractSha256(t,e).then(function(e){return u(new Uint8Array(e),n,r)})}l.expand=u,l.extractAndExpand=c,l.extractWithSaltAndExpand=d}),98);
__d("WACryptoPrimitives",["tweetnacl"],(function(t,n,r,o,a,i,l){"use strict";var e,s={scalarbase:(e=o("tweetnacl")).lowlevel.scalarbase,crypto_hash:e.lowlevel.crypto_hash,modL:e.lowlevel.modL,pack25519:e.lowlevel.pack25519,S:e.lowlevel.S,M:e.lowlevel.M,A:e.lowlevel.A,Z:e.lowlevel.Z,D:e.lowlevel.D,unpack25519:e.lowlevel.unpack25519,pow2523:e.lowlevel.pow2523,crypto_verify_32:e.lowlevel.crypto_verify_32,set25519:e.lowlevel.set25519,add:e.lowlevel.add,scalarmult:e.lowlevel.scalarmult};l.hash=e.hash,l.scalarMult=e.scalarMult,l.verify=e.verify,l.secretbox=e.secretbox,l.lowlevel=s,l.keypairFromSecretKey=e.box.keyPair.fromSecretKey,l.keyPair=e.box.keyPair,l.signDetachedVerify=e.sign.detached.verify}),98);
__d("WACryptoUtils",["WACryptoDependencies","WACryptoPrimitives","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return u(new Uint8Array(e),new Uint8Array(t))}function s(e,t){var n=new TextDecoder;return n.decode(e).toLowerCase()===n.decode(t).toLowerCase()}function u(e,t){return e.length===0&&t.length===0||o("WACryptoPrimitives").verify(e,t)}function c(e,t){return e.length===0&&t.length===0||o("WACryptoPrimitives").verify(e,t)}function d(e,t){return e.length===0&&t.length===0||o("WACryptoPrimitives").verify(e,t)}function m(e){if(e!==(e|0))throw r("err")("bound must be int32");if(e<=0)throw r("err")("bound must not be positive");for(var t=new Int32Array(1),n=-1>>>1,a=e*Math.floor(n/e),i=-1;i===-1;){o("WACryptoDependencies").getCrypto().getRandomValues(t);var l=t[0]>>>1;l<a&&(i=l%e)}return i}l.arrayBuffersEqual=e,l.arrayBuffersEqualCaseInsensitive=s,l.uint8ArraysEqual=u,l.rawKeysEqual=c,l.serializedPubKeysEqual=d,l.randomNumberLessThan=m}),98);
__d("WADeepEquals",[],(function(t,n,r,o,a,i){"use strict";function e(t,n){if(t===n)return!0;if(!t||!n||typeof t!="object"&&typeof n!="object")return!1;var r=Array.isArray(t),o=Array.isArray(n);if(r!==o)return!1;var a=!0;if(r){var i=t.length;if(i!==n.length)return!1;for(var l=0;a&&l<i;l++)a=e(t[l],n[l]);return a}for(var s=Object.keys(t),u=0;a&&u<s.length;u++){var c=s[u];a=n.propertyIsEnumerable(c)&&e(t[c],n[c])}return a&&Object.keys(n).length===s.length}i.deepEqual=e}),66);
__d("WAGetAgeBucketForMediaKeyTimestamp",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){if(e==null)return"Missing";if(o("WATimeUtils").isInFuture(e))switch(!0){case o("WATimeUtils").happenedWithin(e,1*o("WATimeUtils").DAY_SECONDS):return"< 1 day in future";case o("WATimeUtils").happenedWithin(e,7*o("WATimeUtils").DAY_SECONDS):return"1-7 days in future";default:return"> 7 days in future"}switch(!0){case o("WATimeUtils").happenedWithin(e,1*o("WATimeUtils").DAY_SECONDS):return"< 1 day";case o("WATimeUtils").happenedWithin(e,7*o("WATimeUtils").DAY_SECONDS):return"1-7 days";case o("WATimeUtils").happenedWithin(e,14*o("WATimeUtils").DAY_SECONDS):return"7-14 days";case o("WATimeUtils").happenedWithin(e,21*o("WATimeUtils").DAY_SECONDS):return"14-21 days";case o("WATimeUtils").happenedWithin(e,30*o("WATimeUtils").DAY_SECONDS):return"21-30 days";case o("WATimeUtils").happenedWithin(e,40*o("WATimeUtils").DAY_SECONDS):return"30-40 days";case o("WATimeUtils").happenedWithin(e,50*o("WATimeUtils").DAY_SECONDS):return"40-50 days";case o("WATimeUtils").happenedWithin(e,60*o("WATimeUtils").DAY_SECONDS):return"50-60 days";default:return"> 60 days"}}l.getAgeBucketForMediaKeyTimestamp=e}),98);
__d("WAIsMediaExpiredError",[],(function(t,n,r,o,a,i){"use strict";var e=function(t){switch(t){case"signature-expired":return!0;case"hash-mismatch":case"ciphertext-hash-mismatch":case"enc-hash-mismatch":case"decryption-error":case"max-attempts-exceeded":case"request-error":case"download-throttled":case"media-not-found":case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"no-host":case"backoff":case"body-network-error":case"disconnected":case"runtime-error":case"access-expired":case"http-fetch-exception":case"http-fetch-aborted":case"unspecified-http-error":case"server-timeout":case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return!1;default:return!0}};i.isMediaExpiredError=e}),66);
__d("WAStartMediaDownloadQplFlow",["QPLFlow","WAGetPlatformFromStanzaId","WAGetStorageQplAnnotations","WAJids","WAMediaUtils","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=6e5;function s(t){var n=t.downloadEntry,a=t.isPreview,i=t.msgType,l=t.protocolMsgId,s=t.triggerUIView,u=t.xmaMediaType,c=o("QPLFlow").startQPLFlow(r("qpl")._(25312150,"83"),{annotations:{bool:{isTransformStreamSupported:o("WAMediaUtils").isTransformStreamSupported()},string:{chat_type:l==null?null:o("WAJids").switchOnMsgrChatJidType(l.chat,{group:function(){return"group"},user:function(){return"user"}}),downloadEntry:a===!0?n+"-preview":n,e2eePlatform:l==null?null:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(l.externalId),msgType:i,trigger_ui_view:s,xmaMediaType:u!=null?u:void 0}},timeoutInMs:e});return o("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(e){c.addAnnotations(e)}),babelHelpers.extends({},c,{downloadEntry:n,triggerUIView:s})}l.QPL_MEDIA_DOWNLOAD_TIMEOUT_IN_MS=e,l.startMediaDownloadQplFlow=s}),98);
__d("isMAWUniversalSearchWithEBEnabled",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("4741")}l.default=e}),98);