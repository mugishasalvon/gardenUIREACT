;/*FB_PKG_DELIM*/

__d("EBGetContactEpochHead",["EBMinosSecureMailboxKeysForContact","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){var t=e.rawContactId;if(t==null)return Promise.reject(o("WAResultOrError").makeError("invalid-arguments"));var n=await o("EBMinosSecureMailboxKeysForContact").getSecureMailboxKeysForContact(t);return n==null?o("WAResultOrError").makeResult():o("WAResultOrError").makeResult({epochHead:n.epoch_head,epochHeadCreationTime:n.epoch_head_creation_time})}l.getContactEpochHead=e}),98);
__d("EBGetMessageKeys",["EBMinosDb","FBLogger","WAResultOrError","WebMps","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=async function(t,n){var e=await o("EBMinosDb").getEBMinosDb(),r=await e.runInTransaction(["secure_minos_message_epoch_heads"],"readonly",function(e){return e.stores.secure_minos_message_epoch_heads.readIndex("[thread_id+message_id]",[t,n])},"LoadNewMinosMessageEpochHead");return r.length===0?null:{epochHead:r[0].epoch_head}};async function u(t){var n=t.messageId,a=t.threadId;try{if(n==null||a==null)return o("WAResultOrError").makeError("invalid-arguments");var i=await o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,strategy:"local-only"},debug:{purpose:"get-message-keys"},messageId:n,threadId:a}),l=await s(a,n);if(l==null)return o("WAResultOrError").makeError("no-epoch-head-found");if(i.success===!1)return o("WAResultOrError").makeError(i.error);var u=i.value;if(u==null)return o("WAResultOrError").makeError("no-message");var c=new Map;await Promise.all(Array.from(u.supplementalProtobufs).map(async function(e){var t=e[0],n=e[1],r=await s(a,n.messageId);if(r==null)return o("WAResultOrError").makeError("no-epoch-head-found");c.set(t,babelHelpers.extends({},n,{senderEpochHead:r.epochHead}))}));var d=babelHelpers.extends({},u.toplevelProtobuf,{senderEpochHead:l.epochHead});return o("WAResultOrError").makeResult(babelHelpers.extends({},u,{supplementalProtobufs:c,toplevelProtobuf:d}))}catch(t){throw r("FBLogger")("wmi_minos").catching(r("getErrorSafe")(t)).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Runtime error in EBGetMessageKeys"]))),t}}l.getMessageKeys=u}),98);
__d("MAWAdminWriteUserDeviceMsgTxn",["MAWAckLevel","MAWAdminMsgHelpers","MAWDbMsgTxns","MAWDexieTable","MAWExternalId","MAWGetUserDeviceChangeAdminType","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e={add:"add",remove:"remove",update:"update"};function s(e,t,n,a,i){return o("MAWDbMsgTxns").getIsThreadEmpty(e,n.jid).then(function(l){if(l)return o("MAWDexieTable").dexieResolve();var s=t===o("MAWUserJidWrapper").getMyUserJid(),u=o("MAWGetUserDeviceChangeAdminType").getUserDeviceAdminType(a,s),c=s?[]:[o("WAJids").userIdFromJid(t)],d=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:c,adminType:u,version:1},n.jid,o("MAWExternalId").generateExternalId(),i);return o("MAWWriteMsgTxns").writeMsg(e,d,n).then(r("emptyFunction"))})}function u(e,t,n,a){var i=o("MAWAdminMsgHelpers").UNKNOWN_USER,l=t===o("MAWUserJidWrapper").getMyUserJid(),s={ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:l?o("WAJids").AUTHOR_ME:t,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.ICDC_ALERT_ADMIN_MESSAGE,authorName:i},threadJid:n.jid,ts:a!=null?a:o("WATimeUtils").unixTime(),type:o("MAWMsgType").MSG_TYPE.ICDC_ALERT};return o("MAWWriteMsgTxns").writeMsg(e,s,n).then(r("emptyFunction"))}l.DeviceChange=e,l.writeUserDeviceAdminMsg=s,l.writeICDCAlert=u}),98);
__d("MpsFutureProofKey",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({WCEPlaintextPayloadFutureProofPlaceholder:0,WCEPlaintextPayloadFutureProofNoPlaceholder:1,WCEPlaintextPayloadFutureProofIgnore:2});i.WCEPlaintextPayloadFutureProof=e}),66);
__d("WABuildMpsPayload",["MpsFutureProofKey","MpsTypes","WAArmadilloBackupMessage.pb","WAArmadilloMiTransportAdminMessage.pb","WAArmadilloTransportEvent.pb","WAGlobals","WAJids","WALogger","WATimeUtils","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){var n=o("WAJids").extractUserId(t.senderJid),r;t.hideDecryptionFailure!=null&&(r=t.hideDecryptionFailure?o("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofNoPlaceholder:o("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofPlaceholder);var a=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloBackupMessage.pb").BackupMessageSpec,babelHelpers.extends({},e,{metadata:{frankingMetadata:{frankingTag:t.frankingTag,reportingTag:t.reportingTag},messageId:t.externalId,payloadVersion:2,senderId:n,futureProofBehavior:r,timestampMs:t.timestampMs}})).readBuffer();return a}function d(e,t){var n=o("WAJids").extractUserId(t.senderJid),r=o("MpsTypes").toThreadId(t.threadId),a=t.millisServerTs!=null?t.millisServerTs:t.serverTs*1e3+o("WAGlobals").getDependencies().extractMsFromStanzaId(t.externalId),i=c(e,{senderJid:t.senderJid,externalId:t.externalId,frankingTag:t.frankingTag,reportingTag:t.reportingTag,hideDecryptionFailure:t.hideDecryptionFailure,threadId:t.threadId,timestampMs:o("MpsTypes").toTimestamp(a)});return{messageId:o("MpsTypes").toMessageId(t.externalId),payload:o("MpsTypes").toBytes(i),senderId:n,threadId:r,timestampMs:o("MpsTypes").toTimestamp(a)}}function m(t,n,r){try{var a={};switch(r.type){case"message":a={encryptedTransportMessage:r.applicationPayload};break;case"ciphertext":a={encryptedTransportEvent:{payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{placeholder:{type:o("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE}}).readBuffer(),version:3}};break;case"unavailable":a={encryptedTransportEvent:{payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{placeholder:{type:o("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE}}).readBuffer(),version:3}};break;default:r.type}var i=n.type==="Available"?n.originalMsgTimestampMs:null;return d(a,babelHelpers.extends({senderJid:o("WAJids").extractUserJid(n.from),externalId:t.stanzaId},i!=null?{millisServerTs:o("WATimeUtils").castToMillisTime(i)}:{serverTs:t.serverTs},{frankingTag:t.frankingTag,reportingTag:t.reportingTag,hideDecryptionFailure:t.hideDecryptionFailure,threadId:n.chat}))}catch(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["buildMpsMessagePayload: ",""])),t),null}}function p(e,t,n){if(n.payload==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["buildMpsAppdataPayload: No appdata payload"]))),null;try{return d({encryptedTransportMessage:n.payload},{senderJid:o("WAJids").extractUserJid(e.from),externalId:e.stanzaId,serverTs:t,threadId:o("WAJids").extractUserJid(e.from)})}catch(e){return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["buildMpsAppdataPayload: ",""])),e),null}}function _(e,t,n,r,a){var i={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupMembershipAddModeChanged:{mode:n}}).readBuffer(),version:3};return d({miTransportAdminMessage:i},{serverTs:r!=null?r:o("WATimeUtils").unixTime(),externalId:a,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function f(e,t,n,r,a,i){var l={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupAdminChanged:{targetUserId:n.map(o("WAJids").extractUserId),action:r}}).readBuffer(),version:3};return d({miTransportAdminMessage:l},{serverTs:a!=null?a:o("WATimeUtils").unixTime(),externalId:i,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function g(e,t,n,r,a,i){var l={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupParticipantChanged:{targetUserId:n.map(o("WAJids").extractUserId),action:r}}).readBuffer(),version:3};return d({miTransportAdminMessage:l},{serverTs:a!=null?a:o("WATimeUtils").unixTime(),externalId:i,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function h(e,t,n,r,a){var i={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupNameChanged:{groupName:n}}).readBuffer(),version:3};return d({miTransportAdminMessage:i},{serverTs:r!=null?r:o("WATimeUtils").unixTime(),externalId:a,hideDecryptionFailure:!1,senderJid:t,threadId:e})}function y(e,t,n){var r={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{event:{icdcAlert:{type:o("WAArmadilloTransportEvent.pb").TransportEvent$Event$IcdcAlert$Type.DETECTED}}}).readBuffer(),version:3};return d({encryptedTransportEvent:r},{serverTs:t!=null?t:o("WATimeUtils").unixTime(),externalId:n,hideDecryptionFailure:!1,senderJid:e,threadId:e})}function C(e,t,n,r,a,i){var l={payload:o("encodeProtobuf").encodeProtobuf(o("WAArmadilloTransportEvent.pb").TransportEventSpec,{event:{deviceChange:{type:r,devicePlatform:a,deviceModel:i}}}).readBuffer(),version:3};return d({encryptedTransportEvent:l},{serverTs:t!=null?t:o("WATimeUtils").unixTime(),externalId:n,hideDecryptionFailure:!1,senderJid:e,threadId:e})}l.buildBackupProtobufBytes=c,l.buildMpsMessage=d,l.buildMpsMessageFromIncomingMessage=m,l.buildMpsAppdataPayload=p,l.buildMpsGroupMemberAddType=_,l.buildMpsGroupAdminChangedMsg=f,l.buildMpsGroupParticipantsChanged=g,l.buildMpsGroupNameChangedMsg=h,l.buildMpsIcdcAdminMessage=y,l.buildMpsDeviceChangeAdminMessage=C}),98);
__d("EBMinosWriteKeyChangeAdminMessage",["EBMinosTypes","FBLogger","MAWAdminWriteUserDeviceMsgTxn","MAWBridge","MAWDbAppMeta","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWIndexedDb","MAWTransactionMode","MpsTypes","WAArmadilloTransportEvent.pb","WABuildMpsPayload","WADbContact","WAGlobals","WAJids","WAStanzaUtils","WebMps","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return e.appMeta.get({key:o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert}).then(function(e){var t;return(t=e==null?void 0:e.value.allowSecurityAlert)!=null?t:!1})}function u(e,t){var n=o("WAGlobals").getMyUserJid()===t;return!n&&e}async function c(e){var t=e.deviceChangeType,n=t===void 0?o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED:t,a=e.epochHeadCreationTime,i=e.userJid;try{var l=o("MAWExternalId").generateExternalId(),s=o("WABuildMpsPayload").buildMpsDeviceChangeAdminMessage(i,a,o("WAStanzaUtils").toStanzaId(l),n),u={directive:null,insertionSource:o("MpsTypes").InsertionSource.Receive,message:s};await o("WebMps").mps().saveNewMessages([u],{source:"eb-minos-device-change"}),r("FBLogger")("wmi_minos").info("Sent device change transport event for user %s with type %s",i,String(n))}catch(e){var c=r("getErrorSafe")(e);throw r("FBLogger")("wmi_minos").catching(c).mustfix("Failed to send device change transport event for user %s",i),c}}async function d(t){var n=t.contactId,a=t.epochHeadCreationTime,i=o("EBMinosTypes").userFbidToUserJid(n);if(i==null)return r("FBLogger")("wmi_minos").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Invalid userJid generated in writeKeyChangeAdminMessage"]))),Promise.resolve();var l=await o("MAWIndexedDb").makeMsgrTransactor({participants:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"writeKeyChangeAdminMessage",function(e){return function(){return o("MAWDbThreadTxns").getAllThreadsForUsers(e,[i])}})(),d=l.get(i),m=await o("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersRelationships",{users:[i]});if(d==null||(d==null?void 0:d.length)===0)return Promise.resolve();var p=d.filter(function(e){var t=o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(){return"group"},user:function(){return"one_to_one"}});return t==="one_to_one"}),_=await Promise.all([c({deviceChangeType:o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED,epochHeadCreationTime:a,userJid:i}),o("MAWIndexedDb").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READONLY,ftsBackloggedMessages:o("MAWTransactionMode").READWRITE,groupInfo:o("MAWTransactionMode").READONLY,messages:o("MAWTransactionMode").READWRITE,threads:o("MAWTransactionMode").READWRITE},"writeKeyChangeAdminMessage",function(e){return function(){return o("MAWDexieTable").dexieAll(p.map(function(t){return s(e).then(function(n){u(n,i)&&m.get(i)===o("WADbContact").TWO_WAY_CONTACT?o("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(e,i,t,"update",a):o("MAWDexieTable").dexieResolve()})}))}})()]),f=_[1];return f}l.saveDeviceChangeTransportEvent=c,l.writeMinosKeyChangeAdminMessage=d}),98);
__d("MAWDbAddDeviceChangeAlertsTxn",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.deviceChangeAlerts.add(t)}i.addDeviceChangeAlertsTxn=e}),66);
__d("MAWDbDeviceChangeAlerts",[],(function(t,n,r,o,a,i){"use strict";var e="add",l="keyChange",s="remove";function u(e){return e}i.ADD=e,i.KEY_CHANGE=l,i.REMOVE=s,i.unsafeCoerceToDeviceChangeAlertsID=u}),66);
__d("WAXmlParsingFailure",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e,t){this.parser=e,this.reason=t}var t=e.prototype;return t.toString=function(){return"XmlParsingFailure: "+this.parser+": "+this.reason},e})();i.XmlParsingFailure=e}),66);
__d("WAParsableXmlNode",["WAHasProperty","WAXmlParsingFailure","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){throw new TypeError('"'+e+'" is read-only')}var s=(function(){function e(e,t){var n=this;this.$1=e,this.$2=t,this.$3=Array.isArray(t.content)?t.content.map(function(t){return new n.constructor(e,t)}):null}var t=e.prototype;return t.name=function(){return this.$1},t.node=function(){return this.$2},t.hasAttr=function(t){return r("WAHasProperty")(this.$2.attrs,t)},t.assertTag=function(t){this.$2.tag!==t&&this.throw("to be <"+t+">")},t.tag=function(){return this.$2.tag},t.maybeChild=function(t){var e=this.$3;if(!e)return null;for(var n=0;n<e.length;n++)if(e[n].tag()===t)return e[n];return null},t.hasChild=function(t){return!!this.maybeChild(t)},t.child=function(t){var e=this.maybeChild(t);return e||this.throw("to have child <"+t+">")},t.assertAttr=function(t,n){var e=this.attrString(t);e!==n&&this.throw('to have "'+t+'"="'+n+'", but instead has "'+e+'"')},t.attrString=function(t){return r("WAHasProperty")(this.$2.attrs,t)?this.decodeAsString(this.$2.attrs[t]):this.throw('to have attribute "'+t+'"')},t.forEachAttributeKey=function(t){var e=this.$2.attrs;Object.keys(e).forEach(function(e){return t(e)})},t.maybeAttrString=function(t){return this.hasAttr(t)?this.decodeAsString(this.$2.attrs[t]):null},t.maybeAttrInt=function(t,n,r){return this.hasAttr(t)?this.attrInt(t,n,r):null},t.attrEnumValues=function(t,n,r){var e=new Set(n),o=this.attrString(t);if(!e.has(o)){if(r!=null)return r;var a=Array.from(e).join("|");return this.throw('to have "'+t+'"={'+a+'} but has value "'+o+'"')}return o},t.attrEnum=function(t,n){var e=this.attrString(t);if(!r("WAHasProperty")(n,e)){var o=Object.keys(n).join("|");return this.throw('to have "'+t+'"={'+o+'} but has value "'+e+'"')}return n[e]},t.attrEnumOrNullIfUnknown=function(t,n){var e=this.attrString(t);return r("WAHasProperty")(n,e)?n[e]:null},t.maybeAttrEnum=function(t,n){return this.hasAttr(t)?this.attrEnum(t,n):null},t.attrInt=function(t,n,r){var e=this.attrString(t);return this.$4(e,t,n,r)},t.$4=function(t,n,r,o){var e=parseInt(t,10);return Number.isNaN(e)?this.throw('to have "'+n+'"={integer} but has value "'+t+'"'):r!==void 0&&e<r?this.throw('to have "'+n+'"={at least '+r+"} but has value "+e):o!==void 0&&e>=o?this.throw('to have "'+n+'"={below '+o+"} but has value "+e):e},t.forEachChild=function(t){var e=this.$3;if(e)e.forEach(function(e){return t(e)});else if(this.$2.content!=null)return this.throw("to have children")},t.forEachChildWithTag=function(t,n){this.forEachChild(function(e){e.tag()===t&&n(e)})},t.mapChildren=function(t){var e=this.$3;return!e&&this.$2.content!=null?this.throw("to have children"):e?e.map(function(e){return t(e)}):[]},t.mapChildrenWithTag=function(t,n){var e=this.$3;return!e&&this.$2.content!=null?this.throw("to have children"):e?e.filter(function(e){return e.tag()===t}).map(function(e){return n(e)}):[]},t.mapFirstChild=function(t){var e=this.$3;return!e||e.length===0?this.throw("to have children"):t(e[0])},t.hasContent=function(){return!this.$3&&!!this.$2.content},t.hasChildren=function(){return this.$3!=null},t.getChildren=function(){return this.$3},t.mapAttrKeys=function(t){var e=this.getAttrKeys();return e&&e.length?e.map(t):[]},t.getAttrKeys=function(){return Object.keys(this.$2.attrs)},t.hasAttrs=function(){var e=this.$2.attrs?Object.keys(this.$2.attrs):[];return e.length>0},t.getNode=function(){return this.$2},t.unsafeSetChildren=function(t){this.$3=t},t.unsafeSetNodeContent=function(t){this.$2.content=t},t.contentUint=function(t){var e=this.contentBytes(t);return u(e,t)},t.contentBytes=function(t){if(t===void 0&&(t=-1),this.$3)return this.throw("to have binary content, but has children instead");if(this.$2.content!=null){var e=this.$2.content;return t!==-1&&e.length!==t?this.throw("to be "+t+" bytes, but got "+e.length+" instead"):e}else return this.throw("to have content")},t.contentString=function(){return this.$3?this.throw("to have string content, but has children instead"):this.$2.content!=null?this.$2.content:this.throw("to have content")},t.contentInt=function(t,n){var e=this.contentString();return this.$4(e,"content",t,n)},t.contentEnum=function(t){var e=this.contentString();if(!r("WAHasProperty")(t,e)){var n=Object.keys(t).join("|");return this.throw("to have content {"+n+'} but has value "'+e+'"')}return t[e]},t.decodeAsString=function(t){if(typeof t!="string")throw r("err")("decodeAsString: attribute is "+typeof t+" not a string: "+t);return t},t.throw=function(t){throw new(o("WAXmlParsingFailure")).XmlParsingFailure(this.$1,"expected <"+this.$2.tag+"> "+t)},t.toString=function(){return this.$2.toString()},e})();function u(e,t){for(var n=0,r=0;r<t;r++)n=n*256+e[r];return n}l.ParsableXmlNode=s,l.convertBytesToUint=u}),98);
__d("WASignalOther",["WACryptoDependencies","WACryptoHkdf","WACryptoUtils","WAParsableXmlNode","decodeProtobuf","encodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e={name:"AES-CBC"},s={name:"HMAC",hash:"SHA-256"};function u(e,t){if(e.length!==t)throw r("err")("Signal expected "+t+" bytes, given "+e.length);return e}function c(e,t){return u(new Uint8Array(e),t)}function d(e){var t=e.buffer,n=e.byteOffset,r=e.length;return n===0&&r===t.byteLength?t:t.slice(n,n+r)}function m(e,t){return e.readByteArrayView(t)}function p(e){return new Uint8Array(e)}function _(e,t,n){if(e.length-t<n)throw r("err")("Can not split off "+n+" bytes from index "+t+" of "+e.length+" bytes");return e.slice(t,t+n)}function f(e){var t=e==="extendedRange"?2147483646:16380;return o("WACryptoUtils").randomNumberLessThan(t)+1}function g(e){return b(e)}function h(e){return o("WAParsableXmlNode").convertBytesToUint(e,4)}function y(){var e=2147483647;return o("WACryptoUtils").randomNumberLessThan(e)+1}function C(e){return b(e)}function b(e,t,n){if(t===void 0&&(t=0),n===void 0&&(n=4294967296),typeof e=="number"&&t<=e&&e<n&&Math.floor(e)===e)return e;throw r("err")("Expected integer in range ["+t+", "+n+"), given "+String(e))}function v(e,t){return o("encodeProtobuf").encodeProtobuf(e,t).readByteArrayView()}function S(e,t,n){return n(o("decodeProtobuf").decodeProtobuf(e,t))}function R(e,t,n,r){return o("WACryptoHkdf").extractWithSaltAndExpand(e,t,n,r).then(function(e){return new Uint8Array(e)})}function L(t,n){var r,a;return n==="hmac-sha256"?(r=s,a=["sign"]):(r=e,a=["encrypt","decrypt"]),o("WACryptoDependencies").getCrypto().subtle.importKey("raw",t,r,!1,a)}function E(e){return e}function k(e){return e}function I(e,t){return o("WACryptoUtils").arrayBuffersEqual(e,t)}l.AES_CBC=e,l.HMAC_SHA256=s,l.ensureSize=u,l.toBytes=c,l.toBuffer=d,l.readBytes=m,l.makeBytes=p,l.sliceBytes=_,l.makeRegistrationId=f,l.castRegistrationId=g,l.castRegistrationIdFromBytes=h,l.makeSenderKeyId=y,l.castSenderKeyId=C,l.ensureIntInRange=b,l.encodeSignalProto=v,l.decodeSignalProto=S,l.hkdf=R,l.makeCryptoKey=L,l.castToByteEncoded=E,l.castToSessionHash=k,l.areSessionHashesEqual=I}),98);
__d("EBMinosWriteSecureStorageAlert",["EBMinosTypes","FBLogger","MAWDbAddDeviceChangeAlertsTxn","MAWDbDeviceChangeAlerts","MAWIndexedDb","MAWTransactionMode","MAWUnsafeCoerce","Promise","WAJids","WASignalOther"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){var a=t.contactId,i=t.epochHead,l=t.epochHeadCreationTime,u=o("WAJids").validateDeviceJid(o("EBMinosTypes").userFbidToUserJid(o("EBMinosTypes").unsafeCastToUserFbId(a)));return u==null?(r("FBLogger")("wmi_minos").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Invalid deviceJid generated in writeMinosSecureStorageAlert"]))),(s||(s=n("Promise"))).resolve()):o("MAWIndexedDb").makeMsgrTransactor({deviceChangeAlerts:o("MAWTransactionMode").READWRITE},"writeMinosSecureStorageAlert",function(e){return function(){return o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:u,epochHead:i,identity:o("MAWUnsafeCoerce").unsafeCoerce(o("WASignalOther").toBytes(i,32)),isArchived:!1,model:"secure_storage",platform:"Meta",ts:l})}})()}l.writeMinosSecureStorageAlert=u}),98);
__d("EncryptedBackupsResignCdnUrl",["MAWBridge","MAWConfig","MAWLoggerUtils","WAJids","WAPromiseDelays","WAResolvable","WAResultOrError","cr:10071","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new Map;function u(e){return s.get(e)}function c(t){var n=t.deliveryObjectId,r=t.logger,a=t.mediaDownloadFlow,i=t.mediaKey,l=t.mediaType,s=t.msgId,u=t.protocolMsgId,c=t.sortOrderMs;return a.addPoint("resign_cdn_url_start"),d({deliveryObjectId:n,mediaDownloadFlow:{addAnnotations:function(t){a==null||a.addAnnotations(babelHelpers.extends({},t))},addPoint:function(t,n){a==null||a.addPoint(t,babelHelpers.extends({},n))}},mediaKey:i,mediaType:l,msgId:s,protocolMsgId:u,sortOrderMs:c}).then(function(e){return e.success?(a==null||a.addPoint("resign_cdn_url_end"),e):(a.addPoint("resign_cdn_url_fail",{string:{resignCdnUrlFailReason:e.error}}),e)}).catch(function(t){return r.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["resignCdnUrl runtime-error: ",""])),t),a.addPoint("resign_cdn_url_fail",{string:{resignCdnUrlFailReason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(t)}}),o("WAResultOrError").makeError("resign-cdn-url-runtime-error")})}async function d(e){var t=e.deliveryObjectId,r=e.mediaDownloadFlow,a=e.mediaKey,i=e.mediaType,l=e.msgId,u=e.protocolMsgId,c=e.sortOrderMs;if(n("cr:10071")!==null){var d=await n("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:u.chat,deliveryObjectId:t,externalId:u.externalId,mediaDownloadFlow:r,mediaKey:a,mediaType:i,sortOrderMs:c});return d.success?o("WAResultOrError").makeResult(d.value):d}else{var m=o("MAWLoggerUtils").getInstanceKey(),p=new(o("WAResolvable")).Resolvable;return s.set(m,p),o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:t,mediaType:i,messageId:u.externalId,msgId:l,productType:o("MAWConfig").getConfig().productTypeForEBAttachments,skipLegacyMediaDownloadFlow:!0,sortOrder:c,threadId:o("WAJids").threadIdForChatJid(u.chat),threadJid:u.chat,traceId:m}}]}),o("WAPromiseDelays").withTimeout(p.promise,900*1e3,function(){return o("WAResultOrError").makeError("resign-cdn-url-timeout")}).finally(function(){s.delete(m)})}}l.getRestoredCdnUrlResolvable=u,l.resignCdnUrl=c}),98);
__d("WADbTransactor",["MAWDexie","MAWIndexedDb","MAWTransactionMode","WAExceededStorageQuota","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){var r=Object.keys(e),a=r.some(function(t){return e[t]===o("MAWTransactionMode").READWRITE})?o("MAWTransactionMode").READWRITE:o("MAWTransactionMode").READONLY;return function(){for(var e=arguments.length,i=new Array(e),l=0;l<e;l++)i[l]=arguments[l];return o("MAWIndexedDb").getSignalDB(t).then(function(e){return s(a,r,function(){return n(e.stores).apply(void 0,i)})}).then(function(e){return e}).catch(function(e){throw d(e,t)})}}function s(e,t,n){if(r("MAWDexie").currentTransaction!=null)throw r("err")("protocolDB transactor %s cannot be called within another transaction");return o("MAWIndexedDb").getSignalDB().then(function(r){return r.transact(e,t,n)})}function u(e){return e instanceof Error?e:typeof e=="string"?r("err")(e):null}async function c(e,t,n,r){var a=e+"_"+r,i=await o("MAWIndexedDb").getDB(a);return i.transact(t,[e],function(){return n(i.stores[e])}).then(function(e){return e}).catch(function(e){throw d(e,a)})}function d(e,t){var n;o("WAExceededStorageQuota").checkQuotaExceededError(e);var a=u(e);return a?(a.message="["+((n=a==null?void 0:a.toString())!=null?n:"unknown error")+"] Error performing %s transaction "+t,a):r("err")("[unknown error] Error performing %s transaction "+t)}l.makeSignalTransactor=e,l.persistedQueueTransactor=c}),98);
__d("WAClearSignalStores",["MAWDexieTable","MAWTransactionMode","WADbTransactor"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({tasks:o("MAWTransactionMode").READWRITE},"clearSignalStores",function(e){return function(){return o("MAWDexieTable").dexieAll([e.tasks.clear()]).then(function(){})}});l.clearSignalStores=e}),98);
__d("WAClearSignalStoresV2",["WASignalDB"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return o("WASignalDB").getDb().runInTransaction(["identity","contacts","meta","prekey","prekeyGeneration","senderKeySessions","session","signedPrekey","personalSenderKeyStatuses"],"readwrite",async function(e){await Promise.all([e.stores.identity.clear(),e.stores.contacts.clear(),e.stores.meta.clear(),e.stores.prekey.clear(),e.stores.prekeyGeneration.clear(),e.stores.senderKeySessions.clear(),e.stores.session.clear(),e.stores.signedPrekey.clear(),e.stores.personalSenderKeyStatuses.clear()])},o("WASignalDB").signalOp("clearSignalStores"))};l.clearSignalStores=e}),98);
__d("MAWClearSignalAndTempStores",["MAWDeleteOldLogsFromDisk","MAWJobActionsV2","MAWJobsIndexedDb","MAWLoggingSwitches","MAWTransactionMode","Promise","WAClearSignalStores","WAClearSignalStoresV2","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MAWJobsIndexedDb").makeJobsTransactor("jobs",o("MAWTransactionMode").READWRITE,"clearJob")(o("MAWJobActionsV2").clearJobs),u=function(){return(e||(e=n("Promise"))).all([o("MAWLoggingSwitches").removeLoggingFromBridge&&o("MAWDeleteOldLogsFromDisk").clearLogs(),o("WAClearSignalStores").clearSignalStores(),s(),o("WAClearSignalStoresV2").clearSignalStores()]).then(r("emptyFunction"))};l.clearSignalAndTempStores=u}),98);
__d("MAWCreateMaybeAddPointForMediaRender",["MAWQplProxy","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return function(t,n){e!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25302828,"2195"),t,{annotations:n,instanceKey:e},!0)}}l.createMaybeAddPointForMediaRender=e}),98);
__d("WATypedArraysConcat",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n){n===void 0&&(n=0);var r=t.reduce(function(e,t){return e+t.length},n),o=new e(r),a=0;return t.forEach(function(e){o.set(e,a),a+=e.length}),o}i.concatTypedArrays=e}),66);
__d("WACryptoAesCbc",["WABinary","WACryptoDependencies","WAPromiseDelays","WATypedArraysCast","WATypedArraysConcat","err"],(function(t,n,r,o,a,i,l){"use strict";var e=16,s=1024,u=16,c=1024*1024,d=e*c,m=(function(){function t(e,t,n,r){this.$4=null,this.$6=!1,this.$1=e,this.$2=t,this.$3=n;var a={name:"AES-CBC",iv:r};this.$5=o("WACryptoDependencies").getCrypto().subtle.importKey("raw",n,"AES-CBC",!1,[t]).then(function(e){return{algo:a,key:e}})}var n=t.prototype;return n.append=function(n){var t=this;this.$7("append");var r,a=this.$4;if(a)if(a.writeByteArray(n),a.size()>s){var i=a.size()%e;r=a.readByteArrayView(a.size()-i),a.size()||(this.$4=null)}else r=null;else if(n.length>s){var l=n.length%e;l?(this.$4=new(o("WABinary")).Binary(n),r=this.$4.readByteArrayView(n.length-l)):r=n}else this.$4=new(o("WABinary")).Binary(n),r=null;var u=r;return u&&(this.$5=this.$5.then(function(n){var r=n.algo,a=n.key;if(t.$2==="encrypt")return o("WACryptoDependencies").getCrypto().subtle.encrypt(r,a,u).then(function(n){return t.$1.writeByteArray(new Uint8Array(n,0,n.byteLength-e)),new Uint8Array(n,n.byteLength-2*e,e)});var i=u.slice(-e);return o("WACryptoDependencies").getCrypto().subtle.decrypt(r,a,u).then(function(e){return t.$1.writeBuffer(e),i})}).then(function(e){var n={name:"AES-CBC",iv:e};return o("WACryptoDependencies").getCrypto().subtle.importKey("raw",t.$3,"AES-CBC",!1,[t.$2]).then(function(e){return{algo:n,key:e}})})),this.$5.then(function(){})},n.finalize=function(t){var e=this;this.$7("finalize");var n;if(this.$4){var r=this.$4;t&&r.writeByteArray(t),n=r.readByteArrayView(),this.$4=null}else t&&(n=t);if(n){var a=n;return this.$5.then(function(t){var n=t.algo,r=t.key;return e.$2==="encrypt"?o("WACryptoDependencies").getCrypto().subtle.encrypt(n,r,a):o("WACryptoDependencies").getCrypto().subtle.decrypt(n,r,a)}).then(function(t){e.$1.writeBuffer(t)})}else return this.$5.then(function(){})},n.$7=function(t){if(this.$6)throw r("err")("AesCbcStream."+t+" called after finalize")},t})();function p(e){return{name:"AES-CBC",iv:o("WATypedArraysCast").castTypedArrays(Uint8Array,e)}}function _(e){return o("WACryptoDependencies").getCrypto().subtle.importKey("raw",o("WATypedArraysCast").castTypedArrays(Uint8Array,e),"AES-CBC",!1,["encrypt"])}function f(e){if(e)return o("WATypedArraysCast").castTypedArrays(Uint8Array,e);var t=new Uint8Array(u);return o("WACryptoDependencies").getCrypto().getRandomValues(t),t}function g(t){var n=t.byteLength,r=e-n%e;return Number.isNaN(r)?n:n+r}function h(e,t,n){var r=p(t);return Promise.resolve(o("WACryptoDependencies").getCrypto().subtle.importKey("raw",o("WATypedArraysCast").castTypedArrays(Uint8Array,e),"AES-CBC",!1,["decrypt"])).then(function(e){return o("WACryptoDependencies").getCrypto().subtle.decrypt(r,e,n)})}function y(e,t){return Promise.resolve().then(function(){var n=t.slice(0,u),r=t.slice(u);return h(e,n,r)})}function C(e,t,n){return Promise.resolve().then(function(){var r=f(n),a=p(r);return Promise.resolve(_(e)).then(function(e){return o("WACryptoDependencies").getCrypto().subtle.encrypt(a,e,t)}).then(function(e){return o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[r,new Uint8Array(e)]).buffer})})}async function b(t){var n=t.encKey,a=t.plaintext,i=t.optionalIv,l=t.chunkSize,s=l===void 0?d:l,u=t.delayInBetween,c=u===void 0?!1:u;if(s%e!==0)throw r("err")("chunkSize must be a multiple of "+e+", "+s+" received");var m=await _(n),p=new Uint8Array(a),h=Math.ceil(p.byteLength/s),y=f(i),C=new Uint8Array(g(p)+y.byteLength);C.set(y);for(var b=0,S=y,R;b<h;b++){var L=b===h-1,E=b*s;R=p.subarray(E,E+s);var k=await v(L,R,S,m),I=k.encryptedChunk,T=k.nextIv;C.set(I,y.byteLength+b*s),S=T,c===!0&&await o("WAPromiseDelays").releaseToMainThread()}return C.buffer}async function v(t,n,r,a){var i=await o("WACryptoDependencies").getCrypto().subtle.encrypt(p(r),a,n).then(function(n){return t?new Uint8Array(n):new Uint8Array(n).subarray(0,-e)}),l=i.slice(-e);return{encryptedChunk:i,nextIv:l}}l.AES_CBC_BLOCK_SIZE=e,l.AesCbcStream=m,l.importRawKey=_,l.getIv=f,l.aesCbcDecrypt=h,l.aesCbcDecryptSplit=y,l.aesCbcEncrypt=C,l.aesCbcEncryptWithChunking=b,l.aesCbcEncryptChunk=v}),98);
__d("WAConcurrentIterate",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n){for(var r=[],o=[],a=0,i=async function(){for(;a<e;){var n=a;a++,o[n]=await t(n)}},l=Math.min(e,n),s=0;s<l;s++)r.push(i());return Promise.all(r).then(function(){return o})}i.concurrentIterate=e}),66);
__d("WAMediaCryptoSidecar",["WAConcurrentIterate","WACryptoHmac","WAMediaUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e==="video"}var s=16,u=10,c=64*1024;function d(e,t,n){n===void 0&&(n=1);var r=t.buffer.byteLength,a=Math.ceil((r-s)/c),i=new Uint8Array(u*a);return o("WAConcurrentIterate").concurrentIterate(a,function(n){var r=n*c,a=r+s+c,l=t.subarray(r,a);return o("WACryptoHmac").sign(e,l).then(function(e){var t=new Uint8Array(e,0,u);i.set(t,n*u)})},n).then(function(){return o("WAMediaUtils").castToStreamingSidecar(i.buffer)})}l.shouldHaveStreamingSidecar=e,l.calculateStreamingSidecar=d}),98);
__d("WAMediaHkdfInfo",["err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"document":return"WhatsApp Document Keys";case"image":case"sticker":case"xma-image":return"WhatsApp Image Keys";case"video":case"gif":return"WhatsApp Video Keys";case"audio":case"ptt":return"WhatsApp Audio Keys";case"md-app-state":return"WhatsApp App State Keys";case"md-msg-hist":return"WhatsApp History Keys";default:throw r("err")("getMediaHkdfInfo: unexpected media type "+e)}}function s(){return"Messenger Preview Keys"}l.getMediaHkdfInfo=e,l.getPreviewMediaHkdfInfo=s}),98);
__d("WAMediaCrypto",["WABinary","WACryptoAesCbc","WACryptoDependencies","WACryptoHkdf","WACryptoHmac","WACryptoSha256","WACryptoUtils","WACustomError","WAHashUtils","WAMediaCryptoSidecar","WAMediaHkdfInfo","WATagsLogger","WATypedArraysConcat","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["WAMediaCrypto"]),c=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="HmacValidationError",n}return babelHelpers.inheritsLoose(t,e),t})(o("WACustomError").CustomError),d=new Uint8Array([2,2]);function m(e,t){return o("WACryptoHkdf").extractAndExpand(new Uint8Array(e),t,112).then(function(e){return{iv:new Uint8Array(e,0,16),cipherKey:new Uint8Array(e,16,32),hmacKey:new Uint8Array(e,48,32),refKey:new Uint8Array(e,80,32)}})}function p(e,t){var n=o("WAMediaHkdfInfo").getMediaHkdfInfo(t);return m(e,n)}function _(e){var t=o("WAMediaHkdfInfo").getPreviewMediaHkdfInfo();return m(e,t)}async function f(e){var t=new Map,n=await _(e);t.set("preview",n);var r=["document","image","video","audio","md-app-state","md-msg-hist"];return await Promise.all(r.map(function(n){return p(e,n).then(function(e){t.set(n,e)})})),t}function g(e){switch(e){case"image":case"video":return e;default:return null}}var h=16,y=16,C=10,b=64*1024;async function v(e,t,n,r,a){var i=new(o("WABinary")).Binary;i.ensureCapacity(y+r.byteLength+h+C),i.writeByteArray(t);for(var l=new(o("WACryptoAesCbc")).AesCbcStream(i,"encrypt",e,t),s=0,u=s+b;u<r.byteLength;){var c=r.slice(s,u);await l.append(new Uint8Array(c)),s=u,u+=b}var d=await r.slice(s);await l.finalize(new Uint8Array(d));var m=i.peek(function(e){return e.readByteArrayView()}),p=await o("WACryptoHmac").encodeKeySha256(n),_=await o("WACryptoHmac").sign(p,m);i.writeByteArray(new Uint8Array(_,0,C));var f=i.readByteArrayView(),g=f.subarray(y),v=await Promise.all([o("WACryptoDependencies").getCrypto().subtle.digest("SHA-256",g),o("WAMediaCryptoSidecar").shouldHaveStreamingSidecar(a)?o("WAMediaCryptoSidecar").calculateStreamingSidecar(p,f):void 0]),S=v[0],R=v[1];return{ciphertext:g,ciphertextHash:S,sidecar:R,ivCiphertext:m,ivCiphertextHmac:f}}async function S(e,t,n){var r=await o("WACryptoHmac").encodeKeySha256(e),a=o("WABinary").Binary.build(t,n).readByteArrayView();return o("WACryptoHmac").sign(r,a)}async function R(e,t,n,r,a){if(!(10<=a.length&&a.length<=32))throw new c("Bad hmac size "+a.length);var i=o("WABinary").Binary.build(t,n).readByteArrayView(),l=await o("WACryptoHmac").hmacSha256(r,i).then(function(e){return new Uint8Array(e)}),s=l.slice(0,a.length);if(!I(s,a))throw new c("hmacAndDecrypt hmac mismatch");var u=await o("WACryptoAesCbc").aesCbcDecrypt(e,t,n),d=await o("WACryptoDependencies").getCrypto().subtle.digest("SHA-256",u);return{plaintextHash:o("WAHashUtils").toPlaintextHash(d),plaintext:u}}function L(e,t,n,r,a){if(!(10<=a.length&&a.length<=32))throw new c("Bad hmac size "+a.length);var i=o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[t,n]);return o("WACryptoHmac").hmacSha256(r,i,a.length).then(function(e){return new Uint8Array(e)}).then(function(e){if(!o("WACryptoUtils").uint8ArraysEqual(e,a))throw new c("hmacAndDecrypt hmac mismatch")}).then(function(){var e=n.byteLength%h===C;return e===!0?n.subarray(0,-10):n}).then(function(n){return E(e,t,n)})}function E(e,t,n){var r=n.subarray(-h);return o("WACryptoAesCbc").aesCbcEncrypt(e,d,r).then(function(e){return e.slice(y)}).then(function(e){return o("WABinary").Binary.build(n,e).readByteArrayView()}).then(function(n){return o("WACryptoAesCbc").aesCbcDecrypt(e,t,n)}).then(function(e){return new Uint8Array(e,0,e.byteLength-d.byteLength)}).then(function(e){return{plaintext:e,nextIv:r}})}async function k(t,n,a,i,l,c){l>c.scanLengths.length&&u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["decryptPartialChunks targetScan greater length of scanLength array"])));var d=Math.min(l,c.scanLengths.length);if(d<1)throw u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unable to decrypt partial due to invalid target scan"]))),r("err")("Unable to decrypt partial due to invalid target scan");for(var m=new(o("WABinary")).Binary,p=[],_=0;_<d;_++)p.push(new Uint8Array(c.sidecar,_*10,10));for(var f=0,g=n,h=0,y=0;y<d;y++){var C=c.alignedScanLengths[y],b=f+C,v=a.subarray(f,b),S=await L(t,g,v,i,p[y]),R=S.nextIv,E=S.plaintext;m.write(E),f+=C,g=R,h+=c.scanLengths[y]}var k=m.readBuffer(h),I=await o("WACryptoSha256").sha256(k);return{plaintextHash:o("WAHashUtils").toPlaintextHash(I),plaintext:k}}function I(e,t){if(e.length!==t.length)return!1;for(var n=1,r=e.length,o=0;o<r;o++)n&=e[o]===t[o]?1:0;return n!==0}l.HmacValidationError=c,l.DEFAULT_PADDING=d,l.computeMediaKeys=p,l.computeMediaKeysForPreview=_,l.deprecated_getAllCommonComputedMediaKeys=f,l.convertServerMediaTypeToPreviewMediaType=g,l.CBC_BLOCK_SIZE=h,l.IV_LENGTH=y,l.HMAC_LENGTH=C,l.encryptAndHmac=v,l.hmacCiphertext=S,l.hmacAndDecrypt=R,l.hmacAndDecryptPartial=L,l.decryptPartialChunks=k}),98);
__d("WAAlignChunkLengthsToMultipleOfAesBlockSize",[],(function(t,n,r,o,a,i){"use strict";function e(e){return parseInt((e+15)/16,10)*16}function l(t,n){for(var r=[],o=0,a=0,i=0,l=0;l<t.length;++l)if(o+=t[l],l===t.length-1&&n!=null&&n>0){o>a?r.push(n-a):(r.pop(),r.push(n-i));break}else if(o>a){var s=e(o-a);i=a,r.push(s),a+=s}return r}i.alignChunkSizeToMultipleAesBlockSize=e,i.alignChunkLengthsToMultipleOfAesBlockSize=l}),66);
__d("WAProgressiveJpegAlignScanLengths",["WAAlignChunkLengthsToMultipleOfAesBlockSize"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.scanLengths,n=e.totalEncryptedBytes;return o("WAAlignChunkLengthsToMultipleOfAesBlockSize").alignChunkLengthsToMultipleOfAesBlockSize(t.map(function(e){return e}),n).map(function(e){return e})}function s(e){return e}l.progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize=e,l.toProgressiveJpegAlignedScanLength=s}),98);
__d("WAProgressiveJpegGetPJpegDetails",["WAMediaCrypto","WAProgressiveJpegAlignScanLengths","WAProgressiveJpegGetScanLengths","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("WATagsLogger").TAGS(["WAProgressiveJpegDetails"]);function m(e){var t=e.ciphertextLength,n=e.progressiveJpegDetails;return babelHelpers.extends({},n,{alignedScanLengths:o("WAProgressiveJpegAlignScanLengths").progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize({scanLengths:n.scanLengths,totalEncryptedBytes:t})})}async function p(e,t,n){var r=t.byteLength-o("WAMediaCrypto").IV_LENGTH,a=o("WAProgressiveJpegGetScanLengths").getProgressiveJpegScanLengths(e),i=o("WAProgressiveJpegAlignScanLengths").progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize({scanLengths:a,totalEncryptedBytes:r}),l=await _(i,t,n);return{scanLengths:a,sidecar:l}}async function _(e,t,n){for(var r=new Uint8Array(e.length*10),a=0,i=0,l=t.slice(0,16),s=t.slice(16),u=0;u<e.length;u++){var c=e[u];i=a+c;var d=s.subarray(a,i),m=(await o("WAMediaCrypto").hmacCiphertext(n,l,d)).slice(0,10);r.set(new Uint8Array(m),u*10),l=d.slice(d.length-16,d.length),a=i}return r.buffer}function f(t){return t.sidecar.byteLength%o("WAMediaCrypto").HMAC_LENGTH!==0?(d.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar has an invalid length"]))),o("WAResultOrError").makeError("pjpeg-check-sidecar-invalid-length")):t.scanLengths.length>0&&t.sidecar.byteLength===0?(d.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar is missing"]))),o("WAResultOrError").makeError("pjpeg-check-no-sidecar")):t.scanLengths.length===0?o("WAResultOrError").makeResult(!1):t.scanLengths.length*o("WAMediaCrypto").HMAC_LENGTH!==t.sidecar.byteLength?(d.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar size mismatch"]))),o("WAResultOrError").makeError("pjpeg-check-scan-length-mismatch")):t.scanLengths.length<3?(d.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg has too few scans"]))),o("WAResultOrError").makeError("pjpeg-too-few-scans")):o("WAResultOrError").makeResult(!0)}function g(e,t){var n=0;if(t===0)return 0;for(var r=0;r<t;r++){var o=e[r];o!=null&&(n+=o)}return n}function h(e){var t=e.progressiveJpegDetails;if(t==null)return o("WAResultOrError").makeResult(null);var n=f(t);return n.success===!1?n:n.value===!0?o("WAResultOrError").makeResult({scanLengths:t.scanLengths,sidecar:t.sidecar}):o("WAResultOrError").makeResult(null)}l.getExtendedProgressiveJpegDetails=m,l.getProgressiveJpegDetails=p,l.isValidProgressiveJpegDetails=f,l.getTotalByteSizeForScan=g,l.maybeGetProgressiveJpegDetailsUsingMediaEntry=h}),98);
__d("WADownloadDownloadablePreview",["WADownloadMedia","WAMediaCrypto","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WAStartMediaDownloadQplFlow"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WADownloadMedia").mediaDownloadLogger.TAGS(["DownloadDownloadablePreview"]);async function f(t,n,r,a,i,l,f){var g=l.handleMediaPreviewBeforeDownload,h=l.handleMediaPreviewDownloadFailed,y=a.downloadableThumbnail,C=y==null?void 0:y.directPath,b=C!=null,v=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(a);if(_.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["thumbnail_available: ",""])),b),y==null||C==null)return _.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["No downloadableThumbnail. Skipping..."]))),o("WAResultOrError").makeError("preview-not-supported");_.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["DownloadableThumbnail exists. Attempting to download."])));var S=y.fileEncSha256,R=y.fileSha256,L=y.mediaKey,E=y.objectId,k=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:t,downloadEntry:i,msgType:null,triggerUIView:f,isPreview:!0});if(k.addAnnotations({bool:{duplicateDirectPath:C===a.directPath,isProgressiveJpeg:v.success===!0,hasObjectId:E!=null},string:{mediaType:"preview",fullSizeMediaType:a.serverMediaType}}),k.addPoint("wa_protocol_media_download_start"),C==null||S==null||R==null||L==null)return _.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - mediaEntryData "," is incomplete for media preview"])),a),k.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"preview-incomplete-media-entry"}}),o("WAResultOrError").makeError("media-entry-invalid");var I=o("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(r);if(I==null)return _.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - unsupported preview media type ",""])),r),k.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"preview-unsupported-type"}}),o("WAResultOrError").makeError("request-error");await g(n);var T=await o("WADownloadMedia").downloadMediaImpl({downloadFlow:k,mediaTypeDetails:{messageType:I,type:"preview"},directPath:C,fileEncSha256:S,fileSha256:R,mediaKey:L});return T.success===!1?(_.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["failed to download media. Reason: ",""])),T.error),h(n,T.error),k.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:T.error}}),T):(_.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["finished downloading"]))),k.addPoint("wa_protocol_media_download_end"),k.endSuccess(),o("WAResultOrError").makeResult(T.value))}l.maybeDownloadDownloadablePreview=f}),98);
__d("WADecryptMedia",["WAMediaCrypto","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WATagsLogger").TAGS(["WADecryptMedia"]);async function f(t,n,r,a){_.WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Encountered enc-hash-mismatch - looking for a potential working hmac salt"])));var i=r.type==="preview"?"preview":r.mediaType,l=await o("WAMediaCrypto").deprecated_getAllCommonComputedMediaKeys(a),d;for(var m of l){var p=m[0],f=m[1];try{if(p===i)continue;_.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Trying "," as an alternative hmac salt."])),p);var g=o("WAResultOrError").makeResult(await o("WAMediaCrypto").hmacAndDecrypt(f.cipherKey,f.iv,t,f.hmacKey,n));return d={hmacAndDecryptResult:g,alternativeHmacSaltUsed:p},_.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Found a working hmac salt using ","."])),p),d}catch(e){_.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose([""," is not a working hmac salt."])),p);continue}}return{hmacAndDecryptResult:o("WAResultOrError").makeError("enc-hash-mismatch")}}async function g(e){var t=e.ciphertextHmac,n=e.mediaKey,r=e.mediaTypeDetails,a=e.plaintextHash;_.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Using default plaintext verifier"])));var i=t.byteLength-o("WAMediaCrypto").HMAC_LENGTH,l=new Uint8Array(t,i),s=new Uint8Array(t,0,i),u;r.type==="preview"?u=o("WAMediaCrypto").computeMediaKeysForPreview(n):u=o("WAMediaCrypto").computeMediaKeys(n,r.mediaType);var c,g=null;if(c=await u.then(function(e){var t=e.cipherKey,n=e.hmacKey,r=e.iv;return o("WAMediaCrypto").hmacAndDecrypt(t,r,s,n,l)}).then(o("WAResultOrError").makeResult).catch(function(e){return _.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Error ",""])),e),e instanceof o("WAMediaCrypto").HmacValidationError?o("WAResultOrError").makeError("enc-hash-mismatch"):o("WAResultOrError").makeError("decryption-error")}),c.success===!1&&c.error==="enc-hash-mismatch"){var h=await f(s,l,r,n);c=h.hmacAndDecryptResult,g=h.alternativeHmacSaltUsed}if(!c.success)return c;var y=c.value,C=y.plaintext,b=y.plaintextHash;return a!==b?o("WAResultOrError").makeError("hash-mismatch"):(_.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Success"]))),o("WAResultOrError").makeResult({plaintext:C,alternativeHmacSaltUsed:g}))}l.decryptMedia=g}),98);
__d("WAArrayUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}function l(e,t){var n=e.pop();t<e.length&&(e[t]=n)}function*s(e,t){for(var n=0;n<e.length;n+=t)yield e.slice(n,n+t)}function u(t,n){return c(t,n,e)}function c(e,t,n){var r=new Map;for(var o of e){var a,i=t(o),l=(a=r.get(i))!=null?a:[];l.push(n(o)),r.set(i,l)}return r}i.removeIndexWithoutPreservingOrder=l,i.peekEvery=s,i.groupBy=u,i.groupByAndMap=c}),66);
__d("WABaseGlobals",["err"],(function(t,n,r,o,a,i,l){"use strict";var e=null;function s(t){e=t}function u(){if(e==null)throw r("err")("Trying to access WAGlobals before being set");return e}function c(e){var t=u();t.myJids=e}function d(){var e,t=(e=u().myJids)==null?void 0:e.deviceJid;if(t==null)throw r("err")("Trying to access myDeviceJid, but it's not set");return t}function m(){var e,t=(e=u().myJids)==null?void 0:e.userJid;if(t==null)throw r("err")("Trying to access myUserJid, but it's not set");return t}function p(){return u().jidUtils}function _(){return u().qpl}function f(){return e==null?!1:u().newClockSkewCalculation()}l.setGlobals=s,l.setMyJids=c,l.getMyDeviceJid=d,l.getMyUserJid=m,l.getJidUtilsApi=p,l.getQplConfig=_,l.newClockSkewCalculation=f}),98);
__d("WAErrors",["WACustomError"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="BufferTooLargeError",n}return babelHelpers.inheritsLoose(t,e),t})((e=o("WACustomError")).CustomError),u=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="Disconnected",n}return babelHelpers.inheritsLoose(t,e),t})(e.CustomError),c=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="Offline",n}return babelHelpers.inheritsLoose(t,e),t})(u),d=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="MaxRetries",n}return babelHelpers.inheritsLoose(t,e),t})(e.CustomError),m=(function(e){function t(t){var n;return n=e.call(this,t!=null?t:"")||this,n.name="Aborted",n}return babelHelpers.inheritsLoose(t,e),t})(e.CustomError);l.BufferTooLargeError=s,l.Disconnected=u,l.Offline=c,l.MaxRetries=d,l.Aborted=m}),98);
__d("WANotifyConnectionChangeFactory",[],(function(t,n,r,o,a,i){"use strict";var e=15e3;function l(t,n,r){r===void 0&&(r=e);var o={timeoutID:null,connectionStatus:"disconnected",optimismLevel:"optimist"},a=function(){var e=o.connectionStatus,t=o.optimismLevel;t==="optimist"?o.timeoutID=setTimeout(function(){o.optimismLevel="realist",n(e)},r):n(e)};return function(e){o.connectionStatus=e,e==="disconnected"||e==="in_handshake"?a():(o.timeoutID!=null&&(clearTimeout(o.timeoutID),o.timeoutID=null),n(e)),t(e)}}i.notifyConnectionChangeFactory=l}),66);
__d("WAPromiseRetryLoop",["Promise","WALogger","WAPromiseBackoffs","WAPromiseDelays","WAResolvable","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=(function(){function t(e){var t=this;this.$2=new(o("WAResolvable")).Resolvable,this.$3=null,this.$4=null,this.$5=0,this.$6=new(o("WAResolvable")).Resolvable,this.endWithValue=function(e){t.$5++,t.$2.resolve(e)},this.$1=e}var a=t.prototype;return a.resetTimeoutAfter=function(t){this.$4=Date.now()+t},a.cancelReset=function(){this.$4=null},a.reset=function(){this.$2.resolveWasCalled()||(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: resetting ",""])),this.$1.name),this.$5++,this.$6.resolve(),this.$7())},a.start=function(){this.$2.resolveWasCalled()||(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: starting ",""])),this.$1.name),this.$5!==0&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop was called several times. You may have race conditions"]))),this.$5++,this.$6.resolve(),this.$7())},a.pauseOnNextIteration=function(){o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: pause requested on next iteration"]))),this.$6.resolve(),this.$6=new(o("WAResolvable")).Resolvable},a.unpause=function(){this.$6.resolveWasCalled()||o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: loop unpaused"]))),this.$6.resolve()},a.$7=function(){var e=this,t=this.$1,r=this.$5,a=o("WAPromiseBackoffs").createTimer(this.$1.timer);a();var i=function(){return e.$1.isPauseEnabled!==!0?(f||(f=n("Promise"))).resolve():(e.$6.resolveWasCalled()||o("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: loop paused - waiting for unpause"]))),e.$6.promise)},l=function(){if(!e.$2.resolveWasCalled()&&r===e.$5){var n=Date.now();return e.$3=(0,t.code)(e.endWithValue).then(function(){if(!e.$2.resolveWasCalled()){var r=t.resetDelay;(r!==void 0&&Date.now()>=n+r||e.$4!=null&&e.$4<=Date.now())&&(o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: resetting ",""])),t.name),a=o("WAPromiseBackoffs").createTimer(e.$1.timer)),e.$4=null;var s=a();return o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["PromiseRetryLoop: retrying "," in ","ms"])),t.name,s),o("WAPromiseDelays").delayMs(s).then(i).then(l)}}),e.$3}};this.$3=(f||(f=n("Promise"))).resolve().then(l)},a.promise=function(){var e=this;return this.$2.resolveWasCalled()?this.$2.promise:this.$3?(f||(f=n("Promise"))).race([this.$2.promise,this.$3.then(function(){return e.$2.promise})]):(f||(f=n("Promise"))).reject(r("err")("PromiseRetryLoop "+this.$1.name+" had promise() called before start()"))},t})();l.PromiseRetryLoop=g}),98);
__d("WASmaxInPingsEnums",["WAJids"],(function(t,n,r,o,a,i,l){var e={validators:[o("WAJids").validateDomainJid,o("WAJids").validateUserJid],typeName:"DomainJid|UserJid"};l.DOMAINJID_USERJID=e}),98);
__d("WAWapJid",["$InternalEnum","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e={JID:0,JID_U:1,JID_AD:1,JID_FB:3,JID_INTEROP:4},s=n("$InternalEnum")({WHATSAPP:0,LID:1,HOSTED:128,HOSTED_LID:129}),u=(function(){function t(e){this.$1=e}t.createAD=function(r,o,a){return new t({type:e.JID_AD,user:r,device:a==null?0:a,agent:o==null?0:o,domainType:s.WHATSAPP})},t.createJidU=function(r,o,a){return new t({type:e.JID_U,user:r,device:a==null?0:a,domainType:o==null?s.WHATSAPP:o})},t.createFbJid=function(r,o){var n=o==null?0:o;return new t({type:e.JID_FB,user:r,device:n})},t.createInteropJid=function(r,o,a){var n=o==null?0:o;return new t({type:e.JID_INTEROP,user:r,device:n,integrator:a})},t.create=function(r,o){return new t({type:e.JID,user:r,server:o})};var n=t.prototype;return n.toString=function(){if(this.$1.type===e.JID_AD||this.$1.type===e.JID_U){var t=this.$1,n=t.device,r=t.domainType,a=t.user,i="";return r===s.WHATSAPP?i=o("WAJids").WA_USER_JID_SUFFIX:r===s.HOSTED?i=o("WAJids").HOSTED_SUFFIX:r===s.HOSTED_LID?i=o("WAJids").HOSTED_LID_SUFFIX:i=o("WAJids").LID_SUFFIX,n===0?a+"@"+i:a+":"+n+"@"+i}else if(this.$1.type===e.JID_FB){var l=this.$1,u=l.device,c=l.user,d=o("WAJids").MSGR_USER_JID_SUFFIX;return c+":"+u+"@"+d}else if(this.$1.type===e.JID_INTEROP){var m=this.$1,p=m.device,_=m.integrator,f=m.user,g=o("WAJids").INTEROP_USER_JID_SUFFIX;return _+"-"+f+":"+p+"@"+g}else{this.$1.type;var h=this.$1,y=h.server,C=h.user;return C!=null?C+"@"+y:y}},n.getInnerJid=function(){return this.$1},t})();l.WAP_JID_SUBTYPE=e,l.DomainType=s,l.WapJid=u}),98);
__d("WASmaxParseUtils",["WABase64","WABinary","WACryptoUtils","WADeepEquals","WAHasProperty","WAResultOrError","WAStanzaUtils","WAWapJid","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WAResultOrError").makeResult();function s(t,n){return t.tag!==n?O(t,"to be <"+n+">"):e}function u(e,t){return B(e,t)?W(e,e.attrs[t]):O(e,'to have attribute "'+t+'"')}function c(e,t,n,r){var a=u(e,t);if(!a.success)return a;var i=n(a.value);return i!=null?o("WAResultOrError").makeResult(i):O(e,'to have "'+t+'"={'+r+'}, but instead has "'+a.value+'"')}function d(e,t,n){var r=P(e);if(!r.success)return r;var a=t(r.value);return a!=null?o("WAResultOrError").makeResult(a):O(e,"to have "+n+' content, but instead has "'+r.value+'"')}function m(t,n,r){var o=u(t,n);if(o.success){if(o.value!==r)return O(t,'to have "'+n+'"="'+r+'", but instead has "'+o.value+'"')}else return o;return e}function p(e,t){return c(e,t,o("WAStanzaUtils").toStanzaId,"stanzaID")}function _(e,t){return c(e,t,o("WAStanzaUtils").validateCallId,"callID")}function f(e,t){return c(e,t,q,"integer")}function g(e,t,n,r){var a=f(e,t);if(!a.success)return a;var i=a.value;return n!==void 0&&i<n?O(e,'to have "'+t+'"={at least '+n+"} but has value "+i):r!==void 0&&i>r?O(e,'to have "'+t+'"={at most '+r+"} but has value "+i):o("WAResultOrError").makeResult(i)}function h(e){var t=e.content;return t instanceof Uint8Array?O(e,"to have children"):o("WAResultOrError").makeResult(t)}function y(t,n){var r=h(t);if(!r.success)return r;var a=r.value;if(a==null)return e;for(var i=null,l=0;l<a.length;l++){var s=a[l];if(s.tag===n){if(i!=null)return O(t,"to have 1 child <"+n+">, but found more than 1");i=s}}return o("WAResultOrError").makeResult(i)}function C(t,n,r){var o=y(t,n);return o.success?o.value==null?e:r(o.value):o}function b(e,t,n){var r=C(e,t,n);if(!r.success)return r;var a=r.value;return a==null?O(e,"to have 1 child <"+t+">, but found 0"):o("WAResultOrError").makeResult(a)}function v(e,t){var n=y(e,t);return n.success?n.value==null?O(e,"to have 1 child <"+t+">, but found 0"):o("WAResultOrError").makeResult(n.value):n}function S(e,t,n,r,a){var i=U(e,t,n,r);if(!i.success)return i;for(var l=[],s=0;s<i.value.length;s++){var u=a(i.value[s]);if(!u.success)return u;l.push(u.value)}return o("WAResultOrError").makeResult(l)}function R(e,t,n,r,a){var i=U(e,t,n,r);if(!i.success)return i;for(var l=i.value.length,s=0;s<l;s++){var u=a(i.value[s]);if(!u.success)return u}return o("WAResultOrError").makeResult(l)}function L(e,t,n){var r=S(e,t,0,1/0,n);if(!r.success)return r;for(var a=0;a<r.value.length;a++)if(!o("WADeepEquals").deepEqual(r.value[0],r.value[a]))return O(e,"to have homogeneous children, but found two children that are not equal");return r}function E(e,t,n){var r=L(e,t,n);return r.success?o("WAResultOrError").makeResult(r.value.length):r}function k(t,n,r,o,a){return B(n,r)?t(n,r,o,a):e}function I(t,n,r,a){if(a==null)return e;var i=k(t,n,r);return i.success?i.value===a?o("WAResultOrError").makeResult(a):i.value==null?e:O(n,'to have "'+r+'"={'+a+'}, but instead has "'+i.value+'"'):i}function T(e,t,n,r){var a=e(t,n);return a.success?a.value===r?o("WAResultOrError").makeResult(r):O(t,'to have "'+n+'"={'+r+'}, but instead has "'+a.value+'"'):a}function D(e,t,n){var r=e(t);return r.success?r.value===n?o("WAResultOrError").makeResult(n):O(t,'to have content "'+n+'", but instead has "'+r.value+'"'):r}function x(e,t,n){var r=u(e,t);if(!r.success)return r;var a=n[r.value];if(a!=null)return o("WAResultOrError").makeResult(a);var i=Object.values(n).join("|");return O(e,'to have "'+t+'"={'+i+'}, but instead has "'+r.value+'"')}function $(e,t){var n=P(e);if(!n.success)return n;var r=t[n.value];if(r!=null)return o("WAResultOrError").makeResult(r);var a=Object.values(t).join("|");return O(e,'to have content "'+a+'", but instead has "'+n.value+'"')}function P(e){var t=N(e);if(t.success)try{var n=new(o("WABinary")).Binary(t.value),a=n.readString(n.size());return o("WAResultOrError").makeResult(a)}catch(t){return O(e,"to have string content, but run into decoding error: "+r("getErrorSafe")(t).message)}else return t}function N(e){var t=e.content;return t==null?O(e,"to have content"):Array.isArray(t)?O(e,"to have content, but has children instead"):o("WAResultOrError").makeResult(t)}function M(e,t){var n=N(e);return n.success?o("WACryptoUtils").uint8ArraysEqual(n.value,t)?o("WAResultOrError").makeResult(t):O(e,'to have content ":binary:'+o("WABase64").encodeB64(t)+'", but instead has ":binary:'+o("WABase64").encodeB64(n.value)+'"'):n}function w(e,t,n){var r=e.content;if(r==null)return t===void 0||t<1?o("WAResultOrError").makeResult(new Uint8Array([])):O(e,"to have content");if(Array.isArray(r))return O(e,"to have content, but has children instead");var a=r.length;return t!==void 0&&a<t?O(e,"to have binary content at least "+t+" bytes but has "+a+" bytes"):n!==void 0&&a>n?O(e,"to have binary content at most "+n+" bytes but has "+a+" bytes"):o("WAResultOrError").makeResult(r)}function A(e){return d(e,q,"integer")}function F(e){return e}function O(e,t){return o("WAResultOrError").makeError("expected <"+e.tag+">: "+t)}function B(e,t){return r("WAHasProperty")(e.attrs,t)}function W(e,t){return t instanceof o("WAWapJid").WapJid?o("WAResultOrError").makeResult(t.toString()):typeof t=="string"?o("WAResultOrError").makeResult(t):O(e,"decodeAsString: attribute is "+typeof t+" not a string: "+String(t))}function q(e){var t=parseInt(e,10);return Number.isNaN(t)?null:t}function U(e,t,n,r){var a=h(e);if(!a.success)return a;var i=a.value;if(i==null)return n!==0?O(e,"to have at least "+n+" <"+t+"> children, but found 0"):o("WAResultOrError").makeResult([]);for(var l=[],s=0;s<i.length;s++){var u=i[s];u.tag===t&&l.push(u)}var c=l.length;return c<n?O(e,"to have at least "+n+" <"+t+"> children, but found "+c):c>r?O(e,"to have at most "+r+" <"+t+"> children, but found "+c):o("WAResultOrError").makeResult(l)}var V={};function H(e,t,n){var r=t.map(function(e,t){return e+": "+n[t].error});return O(e,["to match any of following mixins: "+t.join(", ")+", but all mixins failed."].concat(r).join(" "))}l.voidSuccess=e,l.assertTag=s,l.attrString=u,l.attrValidate=c,l.contentValidate=d,l.assertAttr=m,l.attrStanzaId=p,l.attrCallId=_,l.attrInt=f,l.attrIntRange=g,l.maybeChildren=h,l.optionalChild=y,l.optionalChildWithTag=C,l.childWithTag=b,l.flattenedChildWithTag=v,l.mapChildrenWithTag=S,l.countChildrenWithTag=R,l.mapHomogeneousChildrenWithTag=L,l.countHomogeneousChildrenWithTag=E,l.optional=k,l.optionalLiteral=I,l.literal=T,l.literalContent=D,l.attrStringEnum=x,l.contentStringEnum=$,l.contentString=P,l.contentBytes=N,l.contentLiteralBytes=M,l.contentBytesRange=w,l.contentInt=A,l.identity=F,l.errorMessage=O,l.emptyObject=V,l.errorMixinDisjunction=H}),98);
__d("WASmaxParseJid",["WAJids","WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateUserJid,"UserJid")}function s(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateLidUserJid,"LidUserJid")}function u(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateDeviceJid,"DeviceJid")}function c(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateGroupJid,"GroupJid")}function d(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateCallJid,"CallJid")}function m(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateDomainJid,"DomainJid")}function p(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateBroadcastJid,"BroadcastJid")}function _(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateStatusJid,"StatusJid")}function f(e,t){return o("WASmaxParseUtils").attrValidate(e,t,o("WAJids").validateNewsletterJid,"NewsletterJid")}function g(e,t,n){var r=o("WASmaxParseUtils").attrString(e,t);if(!r.success)return r;for(var a=n.typeName,i=n.validators,l=0;l<i.length;l++){var s=i[l](r.value);if(s!=null)return o("WAResultOrError").makeResult(s)}return o("WASmaxParseUtils").errorMessage(e,'to have "'+t+'"={'+a+'}, but instead has "'+r.value+'"')}function h(e,t,n,r){var a=e(t,n);return!a.success||a.value===r?a:o("WASmaxParseUtils").errorMessage(t,'to have "'+n+'"={'+r+'}, but instead has "'+a.value+'"')}function y(e,t,n,r){var a=o("WASmaxParseUtils").optional(e,t,n);return!a.success||a.value==null||a.value===r?a:o("WASmaxParseUtils").errorMessage(t,'to have "'+n+'"={'+r+'}, but instead has "'+a.value+'"')}l.attrUserJid=e,l.attrLidUserJid=s,l.attrDeviceJid=u,l.attrGroupJid=c,l.attrCallJid=d,l.attrDomainJid=m,l.attrBroadcastJid=p,l.attrStatusJid=_,l.attrNewsletterJid=f,l.attrJidEnum=g,l.literalJid=h,l.optionalLiteralJid=y}),98);
__d("WASmaxParseReference",["WAHasProperty","WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,o){var a=m(t,n);if(!a.success)return _(a);var i=e(a.value,n[n.length-1],r,o);return i.success?i:_(i)}function s(t,n,r,a,i){return p(n,r)?e(t,n,r,a,i):o("WASmaxParseUtils").voidSuccess}function u(t,n){return e(o("WASmaxParseUtils").attrString,t,n)}function c(e,t){return p(e,t)?u(e,t):o("WASmaxParseUtils").voidSuccess}function d(e,t){var n=m(e,t);if(!n.success)return _(n);var r=o("WASmaxParseUtils").contentString(n.value);return r.success?r:_(r)}function m(e,t){for(var n=t.length,r=e,a=0;a<n-1;a++){var i=t[a],l=o("WASmaxParseUtils").flattenedChildWithTag(r,i);if(!l.success)return l;r=l.value}return o("WAResultOrError").makeResult(r)}function p(e,t){var n=m(e,t);return n.success&&r("WAHasProperty")(n.value.attrs,t[t.length-1])}function _(e){return o("WAResultOrError").makeError("in the reference, "+e.error)}l.attrFromReference=e,l.optionalAttrFromReference=s,l.attrStringFromReference=u,l.optionalAttrStringFromReference=c,l.contentStringFromReference=d}),98);
__d("WASmaxInPingsClientResponseServerResponse",["WAResultOrError","WASmaxInPingsEnums","WASmaxParseJid","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseJid").attrJidEnum(e,"from",o("WASmaxInPingsEnums").DOMAINJID_USERJID);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"type","result");if(!a.success)return a;var i=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",i.value);if(!l.success)return l;var s=o("WASmaxParseUtils").attrInt(e,"t");return s.success?o("WAResultOrError").makeResult({from:r.value,type:a.value,t:s.value}):s}l.parseClientResponseServerResponse=e}),98);
__d("WAWapDict",[],(function(t,n,r,o,a,i){"use strict";var e=3,l=["xmlstreamstart","xmlstreamend","s.whatsapp.net","type","participant","from","receipt","id","notification","disappearing_mode","status","jid","broadcast","user","devices","device_hash","to","offline","message","result","class","xmlns","duration","notify","iq","t","ack","g.us","enc","urn:xmpp:whatsapp:push","presence","config_value","picture","verified_name","config_code","key-index-list","contact","mediatype","routing_info","edge_routing","get","read","urn:xmpp:ping","fallback_hostname","0","chatstate","business_hours_config","unavailable","download_buckets","skmsg","verified_level","composing","handshake","device-list","media","text","fallback_ip4","media_conn","device","creation","location","config","item","fallback_ip6","count","w:profile:picture","image","business","2","hostname","call-creator","display_name","relaylatency","platform","abprops","success","msg","offline_preview","prop","key-index","v","day_of_week","pkmsg","version","1","ping","w:p","download","video","set","specific_hours","props","primary","unknown","hash","commerce_experience","last","subscribe","max_buckets","call","profile","member_since_text","close_time","call-id","sticker","mode","participants","value","query","profile_options","open_time","code","list","host","ts","contacts","upload","lid","preview","update","usync","w:stats","delivery","auth_ttl","context","fail","cart_enabled","appdata","category","atn","direct_connection","decrypt-fail","relay_id","mmg-fallback.whatsapp.net","target","available","name","last_id","mmg.whatsapp.net","categories","401","is_new","index","tctoken","ip4","token_id","latency","recipient","edit","ip6","add","thumbnail-document","26","paused","true","identity","stream:error","key","sidelist","background","audio","3","thumbnail-image","biz-cover-photo","cat","gcm","thumbnail-video","error","auth","deny","serial","in","registration","thumbnail-link","remove","00","gif","thumbnail-gif","tag","capability","multicast","item-not-found","description","business_hours","config_expo_key","md-app-state","expiration","fallback","ttl","300","md-msg-hist","device_orientation","out","w:m","open_24h","side_list","token","inactive","01","document","te2","played","encrypt","msgr","hide","direct_path","12","state","not-authorized","url","terminate","signature","status-revoke-delay","02","te","linked_accounts","trusted_contact","timezone","ptt","kyc-id","privacy_token","readreceipts","appointment_only","address","expected_ts","privacy","7","android","interactive","device-identity","enabled","attribute_padding","1080","03","screen_height"],s=["read-self","active","fbns","protocol","reaction","screen_width","heartbeat","deviceid","2:47DEQpj8","uploadfieldstat","voip_settings","retry","priority","longitude","conflict","false","ig_professional","replaced","preaccept","cover_photo","uncompressed","encopt","ppic","04","passive","status-revoke-drop","keygen","540","offer","rate","opus","latitude","w:gp2","ver","4","business_profile","medium","sender","prev_v_id","email","website","invited","sign_credential","05","transport","skey","reason","peer_abtest_bucket","America/Sao_Paulo","appid","refresh","100","06","404","101","104","107","102","109","103","member_add_mode","105","transaction-id","110","106","outgoing","108","111","tokens","followers","ig_handle","self_pid","tue","dec","thu","joinable","peer_pid","mon","features","wed","peer_device_presence","pn","delete","07","fri","audio_duration","admin","connected","delta","rcat","disable","collection","08","480","sat","phash","all","invite","accept","critical_unblock_low","group_update","signed_credential","blinded_credential","eph_setting","net","09","background_location","refresh_id","Asia/Kolkata","privacy_mode_ts","account_sync","voip_payload_type","service_areas","acs_public_key","v_id","0a","fallback_class","relay","actual_actors","metadata","w:biz","5","connected-limit","notice","0b","host_storage","fb_page","subject","privatestats","invis","groupadd","010","note.m4r","uuid","0c","8000","sun","372","1020","stage","1200","720","canonical","fb","011","video_duration","0d","1140","superadmin","012","Opening.m4r","keystore_attestation","dleq_proof","013","timestamp","ab_key","w:sync:app:state","0e","vertical","600","p_v_id","6","likes","014","500","1260","creator","0f","rte","destination","group","group_info","syncd_anti_tampering_fatal_exception_enabled","015","dl_bw","Asia/Jakarta","vp8/h.264","online","1320","fb:multiway","10","timeout","016","nse_retry","urn:xmpp:whatsapp:dirty","017","a_v_id","web_shops_chat_header_button_enabled","nse_call","inactive-upgrade","none","web","groups","2250","mms_hot_content_timespan_in_seconds","contact_blacklist","nse_read","suspended_group_deletion_notification","binary_version","018","https://www.whatsapp.com/otp/copy/","reg_push","shops_hide_catalog_attachment_entrypoint","server_sync",".","ephemeral_messages_allowed_values","019","mms_vcache_aggregation_enabled","iphone","America/Argentina/Buenos_Aires","01a","mms_vcard_autodownload_size_kb","nse_ver","shops_header_dropdown_menu_item","dhash","catalog_status","communities_mvp_new_iqs_serverprop","blocklist","default","11","ephemeral_messages_enabled","01b","original_dimensions","8","mms4_media_retry_notification_encryption_enabled","mms4_server_error_receipt_encryption_enabled","original_image_url","sync","multiway","420","companion_enc_static","shops_profile_drawer_entrypoint","01c","vcard_as_document_size_kb","status_video_max_duration","request_image_url","01d","regular_high","s_t","abt","share_ext_min_preliminary_image_quality","01e","32","syncd_key_rotation_enabled","data_namespace","md_downgrade_read_receipts2","patch","polltype","ephemeral_messages_setting","userrate","15","partial_pjpeg_bw_threshold","played-self","catalog_exists","01f","mute_v2"],u=["reject","dirty","announcement","020","13","9","status_video_max_bitrate","fb:thrift_iq","offline_batch","022","full","ctwa_first_business_reply_logging","h.264","smax_id","group_description_length","https://www.whatsapp.com/otp/code","status_image_max_edge","smb_upsell_business_profile_enabled","021","web_upgrade_to_md_modal","14","023","s_o","smaller_video_thumbs_status_enabled","media_max_autodownload","960","blocking_status","peer_msg","joinable_group_call_client_version","group_call_video_maximization_enabled","return_snapshot","high","America/Mexico_City","entry_point_block_logging_enabled","pop","024","1050","16","1380","one_tap_calling_in_group_chat_size","regular_low","inline_joinable_education_enabled","hq_image_max_edge","locked","America/Bogota","smb_biztools_deeplink_enabled","status_image_quality","1088","025","payments_upi_intent_transaction_limit","voip","w:g2","027","md_pin_chat_enabled","026","multi_scan_pjpeg_download_enabled","shops_product_grid","transaction_id","ctwa_context_enabled","20","fna","hq_image_quality","alt_jpeg_doc_detection_quality","group_call_max_participants","pkey","America/Belem","image_max_kbytes","web_cart_v1_1_order_message_changes_enabled","ctwa_context_enterprise_enabled","urn:xmpp:whatsapp:account","840","Asia/Kuala_Lumpur","max_participants","video_remux_after_repair_enabled","stella_addressbook_restriction_type","660","900","780","context_menu_ios13_enabled","mute-state","ref","payments_request_messages","029","frskmsg","vcard_max_size_kb","sample_buffer_gif_player_enabled","match_last_seen","510","4983","video_max_bitrate","028","w:comms:chat","17","frequently_forwarded_max","groups_privacy_blacklist","Asia/Karachi","02a","web_download_document_thumb_mms_enabled","02b","hist_sync","biz_block_reasons_version","1024","18","web_is_direct_connection_for_plm_transparent","view_once_write","file_max_size","paid_convo_id","online_privacy_setting","video_max_edge","view_once_read","enhanced_storage_management","multi_scan_pjpeg_encoding_enabled","ctwa_context_forward_enabled","video_transcode_downgrade_enable","template_doc_mime_types","hq_image_bw_threshold","30","body","u_aud_limit_sil_restarts_ctrl","other","participating","w:biz:directory","1110","vp8","4018","meta","doc_detection_image_max_edge","image_quality","1170","02c","smb_upsell_chat_banner_enabled","key_expiry_time_second","pid","stella_interop_enabled","19","linked_device_max_count","md_device_sync_enabled","02d","02e","360","enhanced_block_enabled","ephemeral_icon_in_forwarding","paid_convo_status","gif_provider","project_name","server-error","canonical_url_validation_enabled","wallpapers_v2","syncd_clear_chat_delete_chat_enabled","medianotify","02f","shops_required_tos_version","vote","reset_skey_on_id_change","030","image_max_edge","multicast_limit_global","ul_bw","21","25","5000","poll","570","22","031","1280","WhatsApp","032","bloks_shops_enabled","50","upload_host_switching_enabled","web_ctwa_context_compose_enabled","ptt_forwarded_features_enabled","unblocked","partial_pjpeg_enabled","fbid:devices","height","ephemeral_group_query_ts","group_join_permissions","order","033","alt_jpeg_status_quality","migrate","popular-bank","win_uwp_deprecation_killswitch_enabled","web_download_status_thumb_mms_enabled","blocking","url_text","035","web_forwarding_limit_to_groups","1600","val","1000","syncd_msg_date_enabled","bank-ref-id","max_subject","payments_web_enabled","web_upload_document_thumb_mms_enabled","size","request","ephemeral","24","receipt_agg","ptt_remember_play_position","sampling_weight","enc_rekey","mute_always","037","034","23","036","action","click_to_chat_qr_enabled","width","disabled","038","md_blocklist_v2","played_self_enabled","web_buttons_message_enabled","flow_id","clear","450","fbid:thread","bloks_session_state","America/Lima","attachment_picker_refresh","download_host_switching_enabled","1792","u_aud_limit_sil_restarts_test2","custom_urls","device_fanout","optimistic_upload","2000","key_cipher_suite","web_smb_upsell_in_biz_profile_enabled","e","039","siri_post_status_shortcut","pair-device","lg","lc","stream_attribution_url","model","mspjpeg_phash_gen","catalog_send_all","new_multi_vcards_ui","share_biz_vcard_enabled","-","clean","200","md_blocklist_v2_server","03b","03a","web_md_migration_experience","ptt_conversation_waveform","u_aud_limit_sil_restarts_test1"],c=["64","ptt_playback_speed_enabled","web_product_list_message_enabled","paid_convo_ts","27","manufacturer","psp-routing","grp_uii_cleanup","ptt_draft_enabled","03c","business_initiated","web_catalog_products_onoff","web_upload_link_thumb_mms_enabled","03e","mediaretry","35","hfm_string_changes","28","America/Fortaleza","max_keys","md_mhfs_days","streaming_upload_chunk_size","5541","040","03d","2675","03f","...","512","mute","48","041","alt_jpeg_quality","60","042","md_smb_quick_reply","5183","c","1343","40","1230","043","044","mms_cat_v1_forward_hot_override_enabled","user_notice","ptt_waveform_send","047","Asia/Calcutta","250","md_privacy_v2","31","29","128","md_messaging_enabled","046","crypto","690","045","enc_iv","75","failure","ptt_oot_playback","AIzaSyDR5yfaG7OG8sMTUj8kfQEb8T9pN8BM6Lk","w","048","2201","web_large_files_ui","Asia/Makassar","812","status_collapse_muted","1334","257","2HP4dm","049","patches","1290","43cY6T","America/Caracas","web_sticker_maker","campaign","ptt_pausable_enabled","33","42","attestation","biz","04b","query_linked","s","125","04a","810","availability","1411","responsiveness_v2_m1","catalog_not_created","34","America/Santiago","1465","enc_p","04d","status_info","04f","key_version","..","04c","04e","md_group_notification","1598","1215","web_cart_enabled","37","630","1920","2394","-1","vcard","38","elapsed","36","828","peer","pricing_category","1245","invalid","stella_ios_enabled","2687","45","1528","39","u_is_redial_audio_1104_ctrl","1025","1455","58","2524","2603","054","bsp_system_message_enabled","web_pip_redesign","051","verify_apps","1974","1272","1322","1755","052","70","050","1063","1135","1361","80","1096","1828","1851","1251","1921","key_config_id","1254","1566","1252","2525","critical_block","1669","max_available","w:auth:backup:token","product","2530","870","1022","participant_uuid","web_cart_on_off","1255","1432","1867","41","1415","1440","240","1204","1608","1690","1846","1483","1687","1749","69","url_number","053","1325","1040","365","59","Asia/Riyadh","1177","test_recommended","057","1612","43","1061","1518","1635","055","1034","1375","750","1430","event_code","1682","503","55","865","78","1309","1365","44","America/Guayaquil","535","LIMITED","1377","1613","1420","1599","1822","05a","1681","password","1111","1214","1376","1478","47","1082","4282","Europe/Istanbul","1307","46","058","1124","256","rate-overlimit","retail","u_a_socket_err_fix_succ_test","1292","1370","1388","520","861","psa","regular","1181","1766","05b","1183","1213","1304","1537"],d=["1724","profile_picture","1071","1314","1605","407","990","1710","746","pricing_model","056","059","061","1119","6027","65","877","1607","05d","917","seen","1516","49","470","973","1037","1350","1394","1480","1796","keys","794","1536","1594","2378","1333","1524","1825","116","309","52","808","827","909","495","1660","361","957","google","1357","1565","1967","996","1775","586","736","1052","1670","bank","177","1416","2194","2222","1454","1839","1275","53","997","1629","6028","smba","1378","1410","05c","1849","727","create","1559","536","1106","1310","1944","670","1297","1316","1762","en","1148","1295","1551","1853","1890","1208","1784","7200","05f","178","1283","1332","381","643","1056","1238","2024","2387","179","981","1547","1705","05e","290","903","1069","1285","2436","062","251","560","582","719","56","1700","2321","325","448","613","777","791","51","488","902","Asia/Almaty","is_hidden","1398","1527","1893","1999","2367","2642","237","busy","065","067","233","590","993","1511","54","723","860","363","487","522","605","995","1321","1691","1865","2447","2462","NON_TRANSACTIONAL","433","871","432","1004","1207","2032","2050","2379","2446","279","636","703","904","248","370","691","700","1068","1655","2334","060","063","364","533","534","567","1191","1210","1473","1827","069","701","2531","514","prev_dhash","064","496","790","1046","1139","1505","1521","1108","207","544","637","final","1173","1293","1694","1939","1951","1993","2353","2515","504","601","857","modify","spam_request","p_121_aa_1101_test4","866","1427","1502","1638","1744","2153","068","382","725","1704","1864","1990","2003","Asia/Dubai","508","531","1387","1474","1632","2307","2386","819","2014","066","387","1468","1706","2186","2261","471","728","1147","1372","1961"],m=[s,u,c,d];i.DICT_VERSION=e,i.SINGLE_BYTE_TOKEN=l,i.DICTIONARY_0_TOKEN=s,i.DICTIONARY_1_TOKEN=u,i.DICTIONARY_2_TOKEN=c,i.DICTIONARY_3_TOKEN=d,i.DICTIONARIES=m}),66);
__d("WAXmlFormatter",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=e.replace(/>\s{0,}</g,"><").replace(/</g,"~::~<").replace(/\s*xmlns:/g,"~::~xmlns:").replace(/\s*xmlns=/g,"~::~xmlns=").split("~::~"),n=t.length,r=!1,o=0,a="",i=0,s=["\n"];for(i=0;i<100;i++)s.push(s[i]+"    ");var u=function(t,n){var e=/^<[\w:\-.,]+/.exec(t[n-1]),r=/^<\/[\w:\-.,]+/.exec(t[n]);return e!=null&&r!=null&&e[0]===r[0]};for(i=0;i<n;i++)t[i].search(/<!/)>-1?(a+=s[o]+t[i],r=!0,(t[i].search(/-->/)>-1||t[i].search(/\]>/)>-1||t[i].search(/!DOCTYPE/)>-1)&&(r=!1)):t[i].search(/-->/)>-1||t[i].search(/\]>/)>-1?(a+=t[i],r=!1):u(t,i)?(a+=t[i],r||o--):t[i].search(/<\w/)>-1&&t[i].search(/<\//)===-1&&t[i].search(/\/>/)===-1?(t[i]=l(t[i]),a=r?a+=t[i]:a+=s[o++]+t[i]):t[i].search(/<\w/)>-1&&t[i].search(/<\//)>-1?a=r?a+=t[i]:a+=s[o]+t[i]:t[i].search(/<\//)>-1?a=r?a+=t[i]:a+=s[o===0?o:--o]+t[i]:t[i].search(/\/>/)>-1?a=r?a+=t[i]:a+=s[o]+t[i]:t[i].search(/<\?/)>-1||t[i].search(/xmlns:/)>-1||t[i].search(/xmlns=/)>-1?a+=s[o]+t[i]:a+=t[i];return a[0]==="\n"?a.slice(1):a}function l(e){var t=e.match(/(<query.*>|<result>)(\{.*\})/);if(t===null)return e;try{var n=t[1],r=JSON.stringify(JSON.parse(t[2]),null,2);return n+"\n"+r}catch(t){return e+"[Error formatting JSON]"}}i.default=e}),66);
__d("WAXmlNode",["WAHex"],(function(t,n,r,o,a,i,l){"use strict";var e={},s=(function(){function t(t,n,r){n===void 0&&(n=e),r===void 0&&(r=null),this.tag=t,this.attrs=n,this.content=r}var n=t.prototype;return n.toString=function(){var e="<"+this.tag;e+=u(this.attrs);var t=this.content;return Array.isArray(t)?e+=">"+t.map(String).join("")+"</"+this.tag+">":t instanceof Uint8Array?e+=">"+c(t)+"</"+this.tag+">":t!=null?e+=">"+String(t)+"</"+this.tag+">":e+=" />",e},t})();function u(e){for(var t=Object.keys(e),n="",r=0;r<t.length;r++){var o=t[r];n+=" "+o+'="'+e[o].toString()+'"'}return n}function c(e){var t="";return e.length===0?t="<!-- empty binary -->":e.length<50?t=o("WAHex").bytesToDebugString(e):t="<!-- "+e.length+" bytes -->",t}l.XmlNode=s,l.attrsToString=u,l.uint8ArrayToDebugString=c}),98);
__d("WAWap",["WAAssertUnreachable","WABinary","WACryptoDependencies","WAJids","WALogger","WALongInt","WATextEncoding","WAWapDict","WAWapJid","WAXmlFormatter","WAXmlNode","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=(s=o("WAJids")).MSGR_USER_DOMAIN.replace("@",""),d=s.WA_USER_DOMAIN.replace("@",""),m=s.LID_DOMAIN.replace("@",""),p=s.INTEROP_DOMAIN.replace("@",""),_=s.HOSTED_DOMAIN.replace("@",""),f=2,g=128,h=0,y=236,C=237,b=238,v=239,S=[y,C,b,v],R=245,L=246,E=247,k=248,I=249,T=250,D=251,x=252,$=253,P=254,N=255,M=["0","1","2","3","4","5","6","7","8","9","-",".","\uFFFD","\uFFFD","\uFFFD","\uFFFD"],w=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],A="",F=1,O={sentinel:"DROP_ATTR"},B=(u=o("WAWapJid")).WapJid.create(null,"g.us"),W=u.WapJid.create(null,s.WA_SERVER_JID_SUFFIX),q=u.WapJid.create("status","broadcast"),U=u.WapJid.create(null,"newsletter"),V=u.WapJid.create(null,"hosted"),H=u.WapJid.create(null,"hosted.lid"),G=u.WapJid.create(null,"call"),z={},j=!1;function K(){j=!0}var Q=o("WATextEncoding").newTextEncoder(),X=(function(){function e(e,t,n){t===void 0&&(t=z),n===void 0&&(n=null),this.tag=e,this.attrs=t,this.content=n}var t=e.prototype;return t.toString=function(){var e="<"+this.tag;e+=o("WAXmlNode").attrsToString(this.attrs);var t=this.content;return Array.isArray(t)?e+=">"+t.map(String).join("")+"</"+this.tag+">":t?e+=">"+o("WAXmlNode").uint8ArrayToDebugString(t)+"</"+this.tag+">":e+=" />",j&&(e=r("WAXmlFormatter")(e)),e},e})();function Y(e,t,n){var a=null;if(t&&t.children!=null)throw r("err")('Children should not be passed via props (see eslint check "react/no-children-props")');if(Array.isArray(n))a=n.filter(Boolean);else if(typeof n=="string")a=o("WABinary").Binary.build(n).readByteArrayView();else if(n instanceof ArrayBuffer)a=new Uint8Array(n);else if(n instanceof Uint8Array)a=n;else{for(var i=[],l=2;l<arguments.length;l++){var s=arguments[l];s&&i.push(s)}a=i}Array.isArray(a)&&a.length===0&&(a=null);var u={};if(t){var c=t;Object.keys(c).forEach(function(t){if(!["__self","__source"].includes(t)){var n=c[t];if(n==null)throw r("err")("Attr "+t+" in <"+e+"> is null");n!==O&&(u[t]=n)}})}return new X(e,u,a)}var J=Y;function Z(e){return e instanceof o("WAWapJid").WapJid?e.toString():e}function ee(e){var t=e.content;return Array.isArray(t)?t=t.map(ee):typeof t=="string"&&(t=o("WABinary").Binary.build(t).readByteArrayView()),new X(e.tag,e.attrs||z,t)}function te(e){var t=e instanceof X?e:ee(e),n=new(o("WABinary")).Binary;ne(t,n);var r=0,a=n.readByteArrayView(),i=new Uint8Array(1+a.length);return i[0]=r,i.set(a,1),i}function ne(e,t){if(e==null)t.writeUint8(h);else if(e instanceof X)oe(e,t);else if(e instanceof o("WAWapJid").WapJid)re(e,t);else if(typeof e=="string")se(e,t);else if(e instanceof Uint8Array)ce(e,t);else{var n=typeof e;throw r("err")("Invalid payload type "+n)}}function re(e,t){var n=e.getInnerJid();if(n.type===o("WAWapJid").WAP_JID_SUBTYPE.JID_U){var r=n.device,a=n.domainType,i=n.user;t.writeUint8(E),t.writeUint8(a),t.writeUint8(r),ne(i,t)}else if(n.type===o("WAWapJid").WAP_JID_SUBTYPE.JID_FB){var l=n.device,s=n.user;t.writeUint8(L),ne(s,t),t.writeUint16(l),ne(c,t)}else if(n.type===o("WAWapJid").WAP_JID_SUBTYPE.JID_INTEROP){var u=n.device,d=n.integrator,m=n.user;t.writeUint8(R),ne(m,t),t.writeUint16(u),t.writeUint16(d)}else{var p=n.server,_=n.user;t.writeUint8(T),_!=null?ne(_,t):t.writeUint8(h),ne(p,t)}}function oe(e,t){if(e.tag===void 0){t.writeUint8(k),t.writeUint8(h);return}var n=1;e.attrs&&(n+=Object.keys(e.attrs).length*2),e.content&&n++,n<256?(t.writeUint8(k),t.writeUint8(n)):n<65536&&(t.writeUint8(I),t.writeUint16(n)),ne(e.tag,t),e.attrs&&Object.keys(e.attrs).forEach(function(n){se(n,t),ne(e.attrs[n],t)});var r=e.content;if(Array.isArray(r)){r.length<256?(t.writeUint8(k),t.writeUint8(r.length)):r.length<65536&&(t.writeUint8(I),t.writeUint16(r.length));for(var o=0;o<r.length;o++)oe(r[o],t)}else r&&ne(r,t)}var ae,ie;function le(e){for(var t=new Map,n=0;n<e.length;n++)t.set(e[n],n);return t}function se(e,t){if(e===""){t.writeUint8(x),t.writeUint8(0);return}ae==null&&(ae=le(o("WAWapDict").SINGLE_BYTE_TOKEN));var n=ae.get(e);if(n!=null){t.writeUint8(n+1);return}if(ie==null){ie=[];for(var r=0;r<o("WAWapDict").DICTIONARIES.length;++r)ie.push(le(o("WAWapDict").DICTIONARIES[r]))}for(var a=0;a<ie.length;++a){var i=ie[a].get(e);if(i!=null){t.writeUint8(S[a]),t.writeUint8(i);return}}var l=o("WABinary").numUtf8Bytes(e);if(l<128){var s=/[^0-9.-]+?/,u=/[^0-9A-F]+?/;if(s.exec(e)){if(!u.exec(e)){ue(e,D,t);return}}else{ue(e,N,t);return}}de(l,t),t.writeString(e)}function ue(e,t,n){var o=e.length%2===1;n.writeUint8(t);var a=Math.ceil(e.length/2);o&&(a|=g),n.writeUint8(a);for(var i=0,l=0;l<e.length;l++){var s=e.charCodeAt(l),u=null;if(48<=s&&s<=57?u=s-48:t===N?s===45?u=10:s===46&&(u=11):t===D&&65<=s&&s<=70&&(u=s-55),u==null)throw r("err")("Cannot nibble encode "+s);l%2===0?(i=u<<4,l===e.length-1&&(i|=15,n.writeUint8(i))):(i|=u,n.writeUint8(i))}}function ce(e,t){de(e.length,t),t.writeByteArray(e)}function de(e,t){if(e<256)t.writeUint8(x),t.writeUint8(e);else if(e<1048576)t.writeUint8($),t.writeUint8(e>>>16&255),t.writeUint8(e>>>8&255),t.writeUint8(e&255);else if(e<4294967296)t.writeUint8(P),t.writeUint32(e);else throw r("err")("Binary with length "+e+" is too big for WAP protocol")}function me(t,n){var r=new(o("WABinary")).Binary(t),a=r.readUint8(),i=a&f;return i?(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Decoding compressed stanza"]))),n(r.readByteArrayView()).then(function(e){return ge(new(o("WABinary")).Binary(e))})):Promise.resolve(ge(r))}function pe(e){var t=new(o("WABinary")).Binary(e),n=t.readUint8(),a=n&f;if(a)throw r("err")("Cannot pass compressed stanza to decodeStanzaDebug");return ge(t)}function _e(e,t){var n=e.readUint8();if(n===h)return null;if(n===k)return fe(e,e.readUint8());if(n===I)return fe(e,e.readUint16());if(n===x){var a=e.readUint8();return Re(e,a,t)}if(n===$){var i=e.readUint8(),l=e.readUint8(),s=e.readUint8(),u=((i&15)<<16)+(l<<8)+s;return Re(e,u,t)}if(n===P){var c=e.readUint32();return Re(e,c,t)}if(n===T)return Ce(e);if(n===L)return be(e);if(n===R)return ve(e);if(n===E)return Se(e);if(n===N){var d=e.readUint8(),m=d>>>7,p=d&127;return Le(e,M,m,p)}if(n===D){var _=e.readUint8(),f=_>>>7,g=_&127;return Le(e,w,f,g)}if(n<=0||n>=240)throw r("err")("Unable to decode WAP buffer");if(n>=y&&n<=v){var C=n-y,b=o("WAWapDict").DICTIONARIES[C];if(b===void 0)throw r("err")("Missing WAP dictionary "+C);var S=e.readUint8(),A=b[S];if(A===void 0)throw r("err")("Invalid value index "+S+" in dict "+C);return A}var F=o("WAWapDict").SINGLE_BYTE_TOKEN[n-1];if(F===void 0)throw r("err")("Undefined token with index "+n);return F}function fe(e,t){for(var n=[],r=0;r<t;r++)n.push(ge(e));return n}function ge(e){var t=e.readUint8(),n;if(t===k)n=e.readUint8();else if(t===I)n=e.readUint16();else throw r("err")("Failed to decode node since type byte "+String(t)+" is invalid");var a=void 0,i=null;if(n===0)throw r("err")("Failed to decode node, list cannot be empty");var l=he(e);for(n-=1;n>1;){a||(a={});var s=he(e),u=_e(e,!0);a[s]=u,n-=2}return n===1&&(i=_e(e,!1),i instanceof o("WAWapJid").WapJid&&(i=String(i)),typeof i=="string"&&(i=Q.encode(i))),new X(l,a,i)}function he(e){var t=_e(e,!0);if(typeof t!="string")throw r("err")("WAWap:decodeString got invalid value, string expected");return t}function ye(e){var t=_e(e,!0);if(t!=null&&typeof t!="string")throw r("err")("WAWap:decodeNullableString got invalid value, string expected");return t}function Ce(e){var t=ye(e),n=he(e);return o("WAWapJid").WapJid.create(t,n)}function be(e){var t=he(e),n=e.readUint16();return he(e),o("WAWapJid").WapJid.createFbJid(t,n)}function ve(e){var t=he(e),n=e.readUint16(),r=e.readUint16();return he(e),o("WAWapJid").WapJid.createInteropJid(t,n,r)}function Se(e){var t=null,n=e.readUint8();if(n===0)t=o("WAWapJid").DomainType.WHATSAPP;else if(n===1)t=o("WAWapJid").DomainType.LID;else if((1&n)===0&&(128&n)!==0)t=o("WAWapJid").DomainType.HOSTED;else if(n===129)t=o("WAWapJid").DomainType.HOSTED_LID;else throw r("err")("decodeJidU - Invalid domain type encoding "+n);var a=e.readUint8(),i=he(e);return o("WAWapJid").WapJid.createJidU(i,t,a)}function Re(e,t,n){return n===void 0&&(n=!1),n?e.readString(t):e.readByteArrayView(t)}function Le(e,t,n,r){for(var o=new Array(r*2-n),a=0;a<o.length-1;a+=2){var i=e.readUint8();o[a]=t[i>>>4],o[a+1]=t[i&15]}if(n){var l=e.readUint8();o[o.length-1]=t[l>>>4]}return o.join("")}function Ee(){if(!A){var e=new Uint16Array(2);o("WACryptoDependencies").getCrypto().getRandomValues(e),A=String(e[0])+"."+String(e[1])+"-"}return""+A+F++}function ke(e){switch(e.type){case"group":return e.groupJid;case"status":return o("WAJids").STATUS_JID;case"device":return e.deviceJid;case"newsletter":return e.newsletterJid;case"hosted":return e.hostedDeviceJid;case"hostedLid":return e.hostedLidDeviceJid;default:return e.type,e.broadcastJid}}function Ie(e){switch(e.type){case"group":return e.author;case"status":return e.author;case"broadcast":return e.author;default:return e.type,null}}function Te(e){return e.type==="status"||e.type==="group"||e.type==="broadcast"?xe(e.author):O}function De(e){return xe(ke(e))}function xe(e){var t=o("WAJids").validateDomainJid(e);if(t!=null)return $e(t);var n=e.split("@"),a=n[0],i=n[1],l=null,s=null;if((i===d||i===c||i===p||i===m||i===_||i===o("WAJids").HOSTED_LID_SUFFIX)&&a.indexOf(":")!==-1){var u=a.split(":");a=u[0],l=u[1],s=parseInt(l,10)}if(i===p){var f=a.split("-"),g=f[0],h=f[1];return o("WAWapJid").WapJid.createInteropJid(h,s,parseInt(g,10))}else if(i===c)return o("WAWapJid").WapJid.createFbJid(a,s);var y=null;if(i===m)y=o("WAWapJid").DomainType.LID;else if(i===_){if(s!==99)throw r("err")("wid unexpected deviceId");y=o("WAWapJid").DomainType.HOSTED}else if(i===o("WAJids").HOSTED_LID_SUFFIX){if(s!==99)throw r("err")("lid invalid deviceId");y=o("WAWapJid").DomainType.HOSTED_LID}else y=o("WAWapJid").DomainType.WHATSAPP;return s!=null&&s!==0?o("WAWapJid").WapJid.createJidU(a,y,s):o("WAWapJid").WapJid.create(a,i)}function $e(e){return e==="s.whatsapp.net"?W:e==="g.us"?B:e==="newsletter"?U:e==="call"?G:r("WAAssertUnreachable")(e)}function Pe(e){return xe(e)}function Ne(e){return xe(e)}function Me(e){return xe(e)}function we(e){return xe(e)}function Ae(e){return xe(e)}function Fe(e){return xe(e)}function Oe(e){return e.jidType==="phoneDevice"||e.jidType==="msgrDevice"||e.jidType==="lidDevice"?xe(e.deviceJid):e.jidType==="phoneUser"||e.jidType==="msgrUser"||e.jidType==="lidUser"?xe(e.userJid):e.jidType==="group"?xe(e.groupJid):e.jidType==="status"?xe(e.statusJid):e.jidType==="call"?xe(e.callJid):e.jidType==="interopDevice"?xe(e.deviceJid):e.jidType==="interopUser"?xe(e.userJid):e.jidType==="newsletter"?xe(e.newsletterJid):e.jidType==="hosted"?xe(e.hostedDeviceJid):e.jidType==="hostedLid"?xe(e.hostedLidDeviceJid):e.jidType==="bot"?xe(e.botJid):(e.jidType,xe(e.broadcastJid))}function Be(e){return e}function We(e){return e.toString()}function qe(e){return e}function Ue(e){return e}function Ve(e){return e==null?O:e}function He(e){return e.toString()}function Ge(e){return o("WALongInt").longIntToDecimalString(e)}function ze(e,t){t===void 0&&(t=4);for(var n=e,r=new Uint8Array(t),o=t-1;o>=0;o--)r[o]=n&255,n>>>=8;return r}l.DROP_ATTR=O,l.G_US=B,l.S_WHATSAPP_NET=W,l.STATUS_BROADCAST=q,l.NEWSLETTER=U,l.HOSTED=V,l.HOSTED_LID=H,l.CALL=G,l.enableXMLFormat=K,l.WapNode=X,l.makeWapNode=Y,l.wap=J,l.decodeAsString=Z,l.makeStanza=ee,l.encodeStanza=te,l.decodeStanza=me,l.decodeStanzaDebug=pe,l.generateId=Ee,l.extractToJid=ke,l.extractParticipantJid=Ie,l.PARTICIPANT_JID=Te,l.TO_JID=De,l.JID=xe,l.DOMAIN_JID=$e,l.USER_JID=Pe,l.DEVICE_JID=Ne,l.GROUP_JID=Me,l.BROADCAST_JID=we,l.CALL_JID=Ae,l.NEWSLETTER_JID=Fe,l.TO_WAP_JID=Oe,l.STANZA_ID=Be,l.SMAX_ID=We,l.CUSTOM_STRING=qe,l.CALL_ID=Ue,l.MAYBE_CUSTOM_STRING=Ve,l.INT=He,l.LONG_INT=Ge,l.BIG_ENDIAN_CONTENT=ze}),98);
__d("WASmaxJsx",["WAWap"],(function(t,n,r,o,a,i,l){"use strict";l.smax=o("WAWap").wap}),98);
__d("WASmaxMixins",["WAArrayBufferUtils","WAWapJid"],(function(t,n,r,o,a,i,l){"use strict";var e="smax$any";function s(e,t){return c(e,t),d(e,t),t.content instanceof Uint8Array?p(e,t.content):t.content!=null&&_(e,t.content),e}function u(e,t,n,r){return n!=null?e(t,n,r):t}function c(t,n){var r=t.tag,o=n.tag;if(o!==e&&r!==o)throw new Error("tag mismatch: "+r+" != "+o)}function d(e,t){var n=e.attrs,r=t.attrs;Object.keys(r).forEach(function(e){var t=r[e],o=n[e];if(t!=null&&o!=null){if(m(t,o))return;throw new Error("conflict for key: "+e)}n[e]=t})}function m(e,t){return typeof e=="string"&&typeof t=="string"?e===t:e instanceof o("WAWapJid").WapJid&&t instanceof o("WAWapJid").WapJid?e.toString()===t.toString():!1}function p(e,t){var n=e.content;if(n instanceof Uint8Array){if(!o("WAArrayBufferUtils").uint8ArraysEqualUNSAFE(n,t))throw new Error("elementValue mismatch: bytes dose not equal");return}if(n!=null)throw new Error("elementValue mismatch: destination has children");e.content=t}function _(e,t){var n=e.content;if(n instanceof Uint8Array)throw new Error("children mismatch: destination has element value");if(n==null||n.length===0){e.content=t;return}if(!f(n,t))throw new Error("children mismatch: child counts are not compatible");var r=[],o=Array.from(n);t.forEach(function(e){var t=o.findIndex(function(t){return t.tag===e.tag});if(t===-1)r.push(e);else{var n=o.splice(t,1),a=s(n[0],e);r.push(a)}}),o.forEach(function(e){return r.push(e)}),e.content=r}function f(e,t){for(var n=g(t),r=g(e),o=Object.keys(n),a=0;a<o.length;a++){var i=o[a],l=n[i],s=r[i];if(l!=null&&s!=null&&l!==s)return!1}return!0}function g(e){return e.reduce(function(e,t){var n=t.tag,r=e[n];return e[n]=r==null?1:r+1,e},{})}l.mergeStanzas=s,l.optionalMerge=u}),98);
__d("WASmaxOutPingsClientWellFormedToMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("iq",{to:o("WAWap").S_WHATSAPP_NET});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeClientWellFormedToMixin=s}),98);
__d("WASmaxOutPingsClientRequest",["WASmaxJsx","WASmaxOutPingsClientWellFormedToMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxOutPingsClientWellFormedToMixin").mergeClientWellFormedToMixin(o("WASmaxJsx").smax("iq",{id:o("WAWap").generateId(),type:"get",xmlns:"w:p"}));return e}l.makeClientRequest=e}),98);
__d("WAComms",["WAArrayUtils","WABaseGlobals","WAErrors","WALogger","WANotifyConnectionChangeFactory","WAPromiseRetryLoop","WAResolvable","WAShiftTimer","WASmaxInPingsClientResponseServerResponse","WASmaxOutPingsClientRequest","WASmaxParseUtils","WATimeUtils","WAWap","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w=null,A=null,F=1,O=0,B=(function(){function t(t,n,r){var a=this,i,l,c;this.nextSocketId=1,this.pendingIqs=new Map,this.ackHandlers=[],this.pendingSmaxStanzas=new Map,this.$2=new(o("WAResolvable")).Resolvable,this.socketAbortController=null,this.activePing=null,this.$3=new Set,this.socketId=O,this.socket=null,this.softCloseSocket=null,this.handleStanza=function(t,n,r){var i=o("WASmaxParseUtils").attrString(t,"id");if(i.success&&t.tag!=="receipt"){var l=i.value,u=a.pendingSmaxStanzas.get(l);if(u)return a.pendingSmaxStanzas.delete(l),u.resolve(t),a.maybeScheduleHealthCheck(),"NO_ACK"}var c=ue(t);if(c!=null){var d=a.pendingIqs.get(c);d?(a.pendingIqs.delete(c),d.resolve(t),a.maybeScheduleHealthCheck()):(o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["handleIq no handler for iq with id ",""])),c),o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleIq no handler for iq"]))))}else if(t.tag==="ack")a.handleAck(t);else return t.tag==="failure"&&a.config.shouldBlockReceivingUntilSuccess?a.$1(t,n,r):a.$2.promise.then(function(){return a.$1(t,n,r)});return"NO_ACK"},this.healthCheckTimer=new(o("WAShiftTimer")).ShiftTimer(function(){a.socketId&&a.sendPing()}),this.deadSocketTimer=new(o("WAShiftTimer")).ShiftTimer(function(e){e===a.socketId&&(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," expired"])),e),a.softCloseSocket&&a.softCloseSocket())}),this.$1=t,this.onConnectionChange=o("WANotifyConnectionChangeFactory").notifyConnectionChangeFactory((i=n.handlers.onConnectionChange)!=null?i:function(){},(l=n.handlers.onOptimisticConnectionChange)!=null?l:function(){}),this.gzipInflate=r,this.config=n,this.socketLoop=new(o("WAPromiseRetryLoop")).PromiseRetryLoop({name:"MainSocketLoop",code:Y,timer:(c=n.socketReconnectBackoffAlgo)!=null?c:{jitter:.1,max:n.maxSocketLoopWaitTime,algo:{type:"fibonacci",first:1e4,second:1e4},relativeDelay:!0},resetDelay:3e4,isPauseEnabled:n.isPauseEnabled===!0})}var n=t.prototype;return n.filterPending=function(t){var e=[];function n(n){t(n)&&e.push(n)}return this.pendingIqs.forEach(n),this.ackHandlers.forEach(n),this.pendingSmaxStanzas.forEach(n),e},n.sendPendingStanza=function(t){t.cleanup==null||t.cleanup(),t.cleanup=void 0,this.callStanza(t.stanza)},n.maybeSendPendingStanza=function(t){if(t.attempt>=this.config.maxRetries){var e,n;(e=(n=this.config.handlers).onDropStanza)==null||e.call(n,t),t.cleanup==null||t.cleanup(),t.cleanup=void 0,this.removeHandler(t,"max-retries")}else if(this.socket){t.attempt+=1,this.sendPendingStanza(t);return}else o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket, will resend stanza when socket opens"])))},n.callStanzaAsync=async function(t,n){var e=await this.callStanza(t,n);return e},n.callStanza=function(t,n){var e=this.castStanza(t,n);return this.deadSocketTimer.onOrBefore(this.config.deadSocketTime,this.socketId),this.healthCheckTimer.cancel(),e},n.castStanzaAsync=async function(t){var e=await this.castStanza(t);return e},n.castStanza=function(t,n){var e=this;try{var r,a,i=(r=(a=this.config.handlers).onBeforeCastStanzaForE2E)==null?void 0:r.call(a,t,n);if(i!=null)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Dropping stanza since onBeforeCastStanza matched. We return mock response directly."]))),Array.isArray(i)?Promise.all(i.map(function(t){return Promise.resolve(e.handleStanza(t,e.socketId,O))})):(this.handleStanza(i,this.socketId,O),Promise.resolve())}catch(e){}var l=this.socketOrThrow("castStanza");try{return l.sendFrame(o("WAWap").encodeStanza(t)).then(function(){e.config.handlers.onCastStanza==null||e.config.handlers.onCastStanza(t,n)}).catch(function(e){if(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["castStanza async error ",""])),e),e instanceof o("WAErrors").BufferTooLargeError)return Promise.reject(e)})}catch(e){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["castStanza error ",""])),e)}return Promise.resolve()},n.socketOrThrow=function(t){var e=this.socket;if(e)return e;throw r("err")("Comms."+t+" called while no socket")},n.startHandlingRequests=function(){return o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Comms.startHandlingRequests"]))),this.$2.resolve(),this.$2.promise.then(function(){})},n.parseAndHandleStanza=function(t,n){var e=this;t===this.socketId&&(this.deadSocketTimer.cancel(),A&&(A.resolve(),A=null));var r=o("WAWap").decodeStanza(n,this.gzipInflate).catch(function(e){throw o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Failure parsing stanza!"]))),e}).then(function(r){e.config.handlers.onHandleStanza==null||e.config.handlers.onHandleStanza(r,t,n.byteLength);var o=e.activePing;return o&&o.socketId===t&&o.stanzaId===ue(r)?(e.activePing=null,o.handler.resolve(r),e.maybeScheduleHealthCheck(),"NO_ACK"):e.handleStanza(r,t,n.byteLength)}).then(function(n){if(t===e.socketId){if(n==="CLOSE_SOCKET"){o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[comms] job response is CLOSE_SOCKET"])));var r=e.socket;r&&r.close()}else n==="NO_ACK"||e.castStanza(n);return"NO_ACK"}});this.$3.add(r),r.finally(function(){return void e.$3.delete(r)})},n.handleAck=function(t){for(var e=this.ackHandlers,n=-1,r=null;!r&&++n<e.length;)r=e[n].parseAndTest(t);if(r){var a,i,l=e[n];o("WAArrayUtils").removeIndexWithoutPreservingOrder(e,n),(a=(i=this.config.handlers).onHandleAck)==null||a.call(i,t),l.resolve(r),this.maybeScheduleHealthCheck()}else o("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["handleAck: unrecognized ",""])),t)},n.removeHandler=function(t,n){if(n===void 0&&(n="disconnect"),t.type==="iq"||t.type==="smax"){var e=t.stanza.attrs.id;if(!e||typeof e!="string"||t.type==="iq"&&!this.pendingIqs.delete(e)||t.type==="smax"&&!this.pendingSmaxStanzas.delete(e))return}else{t.type;var r=this.ackHandlers.indexOf(t);if(r===-1)return;o("WAArrayUtils").removeIndexWithoutPreservingOrder(this.ackHandlers,r)}n==="disconnect"?t.resolve(Promise.reject(new(o("WAErrors")).Disconnected)):n==="abort"?t.resolve(Promise.reject(new(o("WAErrors")).Aborted)):t.resolve(Promise.reject(new(o("WAErrors")).MaxRetries))},n.maybeScheduleHealthCheck=function(){if(!this.healthCheckTimer.isScheduled()&&!(this.activePing||this.ackHandlers.length||this.pendingIqs.size||this.pendingSmaxStanzas.size)){var e=this.config.healthCheckInterval,t=Math.ceil(e*1e3*(1+Math.random()));this.healthCheckTimer.onOrBefore(t)}},n.sendPing=async function(){var e=se("sendPing");if(!e.socketId)return o("WALogger").LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[comms] sendPing when socket dead"]))),!1;if(e.activePing&&e.activePing.socketId===e.socketId)return o("WALogger").LOG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[comms] sendPing ping still pending"]))),!1;e.activePing&&e.activePing.handler.resolve();var t=o("WASmaxOutPingsClientRequest").makeClientRequest(),n=t.attrs.id;if(typeof n!="string")return o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[comms] No stanzaId in ping request stanza"]))),!1;var r=new(o("WAResolvable")).Resolvable;e.activePing={socketId:e.socketId,stanzaId:n,handler:r};var a=Date.now();e.callStanza(t);var i=await r.promise,l=Date.now();if(i){var s=o("WASmaxInPingsClientResponseServerResponse").parseClientResponseServerResponse(i,t);if(s.success){var u=l-a,c=Math.round(u/2),d=o("WATimeUtils").castToUnixTime(s.value.t),m=o("WABaseGlobals").newClockSkewCalculation()?Math.round((a+c)/1e3-d):Math.round(Date.now()/1e3-d);return e.config.handlers.onClockSkewUpdate==null||e.config.handlers.onClockSkewUpdate(m),!0}}return!1},t})();function W(){return w}function q(e,t,n,r){r===void 0&&(r=!0),!w&&(w=new B(e,t,n),r&&setTimeout(z,0))}function U(){var e=se("stopComms");e.socketLoop.endWithValue(),e.socket&&J(),w=null}function V(){var e=se("closeSocketAndPreventRetry");e.socketLoop.endWithValue(),e.socket&&(o("WALogger").LOG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocketAndPreventRetry called"]))),J())}function H(){var e=se("closeSocketAndPause");e.socketLoop.pauseOnNextIteration(),e.socket&&(o("WALogger").LOG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocketAndPause called"]))),J())}function G(){var e=se("closeSocketAndResume");e.socketLoop.unpause(),e.socket&&(o("WALogger").LOG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocketAndResume called"]))),J())}function z(){se("openSocketLoop").socketLoop.start()}function j(){o("WALogger").LOG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["[comms] maybeResetSocketLoop"]))),X()||se("maybeResetSocketLoop").socketLoop.reset()}function K(){se("forceResetSocketLoop").socketLoop.reset()}function Q(){var e,t=se("socketAbortController");(e=t.socketAbortController)==null||e.abort(),t.softCloseSocket==null||t.softCloseSocket()}function X(){var e;return!!((e=w)!=null&&e.socket)}function Y(){var e,t=se("socketLoopIteration"),n=t.nextSocketId++;o("WALogger").LOG(E||(E=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," opening"])),n);var r=function(){t.onConnectionChange("in_handshake")};return t.config.handlers.onSocketLoopIteration==null||t.config.handlers.onSocketLoopIteration(t.socketAbortController),typeof AbortController=="function"&&(t.socketAbortController=new AbortController),t.config.openChatSocket(r,(e=t.socketAbortController)==null?void 0:e.signal).then(function(e){if(e.success){var r=e.value;t.config.handlers.onSocketOpen==null||t.config.handlers.onSocketOpen();var a=new(o("WAResolvable")).Resolvable;return o("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," opened"])),n),t.socketId=n,t.socket=r,t.softCloseSocket=function(){t.softCloseSocket=null,t.socket&&t.config.shouldCloseStaleSocket&&(J(),t.socket=null),a.resolve()},t.socketLoop.resetTimeoutAfter(1e4),t.deadSocketTimer.cancel(),t.maybeScheduleHealthCheck(),r.setOnFrame(function(e){return t.parseAndHandleStanza(n,e)}),r.setOnClose(function(){o("WALogger").LOG(I||(I=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," closed"])),n),t.activePing&&n===t.activePing.socketId&&(t.activePing.handler.resolve(),t.activePing=null),t.filterPending(function(e){return e.attachedToSocketId===n}).forEach(function(e){return void t.removeHandler(e)}),n===t.socketId&&(t.socketId=O,t.socket=null,t.onConnectionChange("disconnected"),t.config.handlers.onDisconnect==null||t.config.handlers.onDisconnect(),a.resolve())}),t.onConnectionChange("connected"),t.config.handlers.onConnect==null||t.config.handlers.onConnect(),t.filterPending(function(e){return!e.attachedToSocketId}).sort(function(e,t){return e.orderedId-t.orderedId}).forEach(function(e){switch(e.type){case"smax":case"iq":t.maybeSendPendingStanza(e);break;case"ack":t.callStanza(e.stanza);break;default:e.type;break}}),a.promise}else{var i=e.error;switch(i){case"max-hunters":o("WALogger").WARN(T||(T=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration socket closed while in noise handshake using treasureHunt strategy"])));break;case"disconnected":o("WALogger").WARN(D||(D=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration socket disconnected while in noise handshake"])));break;default:return}}}).catch(function(e){e instanceof o("WAErrors").Disconnected?o("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration socket closed while in noise handshake"]))):o("WALogger").ERROR($||($=babelHelpers.taggedTemplateLiteralLoose(["[comms] socketLoopIteration failed ",""])),e)})}function J(){var e=se("closeSocket");e.socket&&(o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose(["[comms] Socket "," closed"])),e.socketId),o("WALogger").LOG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["[comms] closeSocket called"]))),e.socket.close())}function Z(){se("onStreamErrorReceived").socketLoop.cancelReset()}function ee(){return se("waitForConnection").sendPing(),A||(A=new(o("WAResolvable")).Resolvable),A.promise}function te(e,t){var n=se("castStanza");n.socket?n.castStanza(e,t):o("WALogger").LOG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket"])))}function ne(e){var t=se("castStanza");return t.socketId===e}function re(e,t,n,a,i){return n===void 0&&(n=0),i===void 0&&(i="iq"),new Promise(function(l){var s=se("sendIq"),u=e.attrs.id;if(!u||typeof u!="string")throw r("err")("[comms] sendIq given iq without id: "+String(e));var c=s.socketId;if(t&&!c){l(Promise.reject(new(o("WAErrors")).Offline));return}var d=function(t){t===void 0&&(t="disconnect");var e=i==="iq"?s.pendingIqs.get(u):s.pendingSmaxStanzas.get(u);if(!e){l(Promise.reject(r("err")("[comms] _sendIq unexisting stanza to be cancelled: "+u)));return}s.removeHandler(e,t)},m=null;if(n>0){var p=setTimeout(d,n*1e3);m=function(){clearTimeout(p)}}if(a!=null)if(a.aborted){l(Promise.reject(new(o("WAErrors")).Disconnected));return}else{var _=function(){d("abort")};a.addEventListener("abort",_),m=function(){a.removeEventListener("abort",_)}}var f={resolve:l,stanza:e,attachedToSocketId:t?c:O,orderedId:F++,attempt:0,cleanup:m};if(i==="iq"){var g=babelHelpers.extends({type:i},f);s.pendingIqs.set(u,g),s.config.handlers.onSendIq==null||s.config.handlers.onSendIq(e),s.maybeSendPendingStanza(g)}else{var h=babelHelpers.extends({type:i},f);s.pendingSmaxStanzas.set(u,h),s.maybeSendPendingStanza(h)}})}function oe(e,t){var n,r,o,a=(n=t==null?void 0:t.withoutRetry)!=null?n:!1,i=(r=t==null?void 0:t.timeoutSeconds)!=null?r:0,l=(o=t==null?void 0:t.signal)!=null?o:null;return re(e,a,i,l,"smax")}function ae(){var e=se("sendPing");return e.sendPing()}function ie(){return se("startHandlingRequests").startHandlingRequests()}function le(){w&&w.deadSocketTimer.cancel()}function se(e){if(w)return w;throw r("err")("[comms] "+e+" called before startComms")}function ue(e){if(e.tag==="iq"){var t=e.attrs.type;if(t==="result"||t==="error")return o("WAWap").decodeAsString(e.attrs.id)||null}return null}function ce(){return F++}function de(){w=null,A=new(o("WAResolvable")).Resolvable,F=1}l.DEFAULT_SOCKET_ID=O,l.getComms=W,l.startComms=q,l.stopComms=U,l.closeSocketAndPreventRetry=V,l.closeSocketAndPause=H,l.closeSocketAndResume=G,l.openSocketLoop=z,l.maybeResetSocketLoop=j,l.forceResetSocketLoop=K,l.forceAbortSocketConnection=Q,l.isSocketConnected=X,l.socketLoopIteration=Y,l.closeSocket=J,l.onStreamErrorReceived=Z,l.waitForConnection=ee,l.castSmaxStanza=te,l.isActiveSocket=ne,l._sendIq=re,l.sendSmaxStanza=oe,l.sendPing=ae,l.startHandlingRequests=ie,l.cancelDeadSocketTimer=le,l.singletonOrThrowIfUninitialized=se,l.getAndIncrementNextOrderedId=ce,l.resetStateForTests=de}),98);
__d("WADecimalStringMod",["WALogger","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n){if(!/^\d+$/.test(t))throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(['"','" is not a valid decimal string'])),t),r("err")("decimalStringMod is given an invalid decimal string");var a=t.length;if(a<16||a===16&&t<="9007199254740991")return Number(t)%n;if(a>20||a===20&&t>"18446744073709551615")throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(['"','" is over 64 bits'])),t),r("err")("decimalStringMod is given value over 64 bits");for(var i=0,l=0;l<t.length;l++){var u=Number(t[l]);i=(i*10+u)%n}return i}l.decimalStringMod=u}),98);
__d("WACreateGetVcaEnabledBucket",["WAArrayBufferUtils","WADecimalStringMod","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){return function(){return t==null?null:o("WAArrayBufferUtils").arrayBufferMod(e,t)+100}}function u(t,n){return function(){if(n==null)return null;var r=t.split("/"),a=r[r.length-1],i=a.split("_")[1];return/^\d+$/.test(i)?i==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["mediaRouteSelection: can't get fbId from mediaDirectPath"]))),null):o("WADecimalStringMod").decimalStringMod(i,n)+100:null}}l.createGetVcaEnabledBucket=s,l.msgrCreateGetVcaEnabledBucket=u}),98);
__d("WAExtractNcHotTimestamp",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){if(e==null)return null;var t=s(e);if(t.has("_nc_hot")){var n=parseInt(t.get("_nc_hot"),10);return Number.isInteger(n)?o("WATimeUtils").castToUnixTime(n):null}else return null}function s(e){var t=e.split("?");return new URLSearchParams(t.length===2?t[1]:"")}l.extractNcHotTimestamp=e}),98);
__d("WASignalLocalStorageProtocol.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={},_={},f={},g={},h={},y={},C={},b={},v={},S={};s.name="SessionStructure",s.internalSpec={sessionVersion:[1,(e=o("WAProtoConst")).TYPES.UINT32],localIdentityPublic:[2,e.TYPES.BYTES],remoteIdentityPublic:[3,e.TYPES.BYTES],rootKey:[4,e.TYPES.BYTES],previousCounter:[5,e.TYPES.UINT32],senderChain:[6,e.TYPES.MESSAGE,d],receiverChains:[7,e.FLAGS.REPEATED|e.TYPES.MESSAGE,d],pendingKeyExchange:[8,e.TYPES.MESSAGE,c],pendingPreKey:[9,e.TYPES.MESSAGE,u],remoteRegistrationId:[10,e.TYPES.UINT32],localRegistrationId:[11,e.TYPES.UINT32],needsRefresh:[12,e.TYPES.BOOL],aliceBaseKey:[13,e.TYPES.BYTES]},u.name="SessionStructure$PendingPreKey",u.internalSpec={preKeyId:[1,e.TYPES.UINT32],signedPreKeyId:[3,e.TYPES.INT32],baseKey:[2,e.TYPES.BYTES]},c.name="SessionStructure$PendingKeyExchange",c.internalSpec={sequence:[1,e.TYPES.UINT32],localBaseKey:[2,e.TYPES.BYTES],localBaseKeyPrivate:[3,e.TYPES.BYTES],localRatchetKey:[4,e.TYPES.BYTES],localRatchetKeyPrivate:[5,e.TYPES.BYTES],localIdentityKey:[7,e.TYPES.BYTES],localIdentityKeyPrivate:[8,e.TYPES.BYTES]},d.name="SessionStructure$Chain",d.internalSpec={senderRatchetKey:[1,e.TYPES.BYTES],senderRatchetKeyPrivate:[2,e.TYPES.BYTES],chainKey:[3,e.TYPES.MESSAGE,p],messageKeys:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,m]},m.name="SessionStructure$Chain$MessageKey",m.internalSpec={index:[1,e.TYPES.UINT32],cipherKey:[2,e.TYPES.BYTES],macKey:[3,e.TYPES.BYTES],iv:[4,e.TYPES.BYTES]},p.name="SessionStructure$Chain$ChainKey",p.internalSpec={index:[1,e.TYPES.UINT32],key:[2,e.TYPES.BYTES]},_.name="RecordStructure",_.internalSpec={currentSession:[1,e.TYPES.MESSAGE,s],previousSessions:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,s]},f.name="PreKeyRecordStructure",f.internalSpec={id:[1,e.TYPES.UINT32],publicKey:[2,e.TYPES.BYTES],privateKey:[3,e.TYPES.BYTES]},g.name="SignedPreKeyRecordStructure",g.internalSpec={id:[1,e.TYPES.UINT32],publicKey:[2,e.TYPES.BYTES],privateKey:[3,e.TYPES.BYTES],signature:[4,e.TYPES.BYTES],timestamp:[5,e.TYPES.FIXED64]},h.name="IdentityKeyPairStructure",h.internalSpec={publicKey:[1,e.TYPES.BYTES],privateKey:[2,e.TYPES.BYTES]},y.name="SenderKeyStateStructure",y.internalSpec={senderKeyId:[1,e.TYPES.UINT32],senderChainKey:[2,e.TYPES.MESSAGE,v],senderSigningKey:[3,e.TYPES.MESSAGE,C],senderMessageKeys:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,b]},C.name="SenderKeyStateStructure$SenderSigningKey",C.internalSpec={public:[1,e.TYPES.BYTES],private:[2,e.TYPES.BYTES]},b.name="SenderKeyStateStructure$SenderMessageKey",b.internalSpec={iteration:[1,e.TYPES.UINT32],seed:[2,e.TYPES.BYTES]},v.name="SenderKeyStateStructure$SenderChainKey",v.internalSpec={iteration:[1,e.TYPES.UINT32],seed:[2,e.TYPES.BYTES]},S.name="SenderKeyRecordStructure",S.internalSpec={senderKeyStates:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,y]},l.SessionStructureSpec=s,l.SessionStructure$PendingPreKeySpec=u,l.SessionStructure$PendingKeyExchangeSpec=c,l.SessionStructure$ChainSpec=d,l.SessionStructure$Chain$MessageKeySpec=m,l.SessionStructure$Chain$ChainKeySpec=p,l.RecordStructureSpec=_,l.PreKeyRecordStructureSpec=f,l.SignedPreKeyRecordStructureSpec=g,l.IdentityKeyPairStructureSpec=h,l.SenderKeyStateStructureSpec=y,l.SenderKeyStateStructure$SenderSigningKeySpec=C,l.SenderKeyStateStructure$SenderMessageKeySpec=b,l.SenderKeyStateStructure$SenderChainKeySpec=v,l.SenderKeyRecordStructureSpec=S}),98);
__d("WASignalKeys",["WACryptoDependencies","WACryptoPrimitives","WASignalLocalStorageProtocol.pb","WASignalOther","decodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e=5,s=16777215;function u(e,t){return{publicKey:e,privateKey:t}}function c(e){var t=o("WACryptoPrimitives").keypairFromSecretKey(e),n=t.publicKey,r=t.secretKey;return u(o("WASignalOther").ensureSize(n,32),o("WASignalOther").ensureSize(r,32))}function d(e,t){return{publicKey:o("WASignalOther").toBytes(e,32),privateKey:o("WASignalOther").toBytes(t,32)}}function m(){var e=o("WACryptoPrimitives").keyPair(),t=e.publicKey,n=e.secretKey;return n[0]&=248,n[31]=64|n[31]&63,u(o("WASignalOther").ensureSize(t,32),o("WASignalOther").ensureSize(n,32))}function p(e,t){return u(o("WASignalOther").sliceBytes(t,1,32),e)}function _(e,t){return{serializedPubKey:t,privateKey:e}}function f(){var e=m();return _(e.privateKey,g(e))}function g(t){var n=o("WASignalOther").makeBytes(33);return n[0]=e,n.set(t.publicKey,1),n}function h(t){var n=o("WASignalOther").makeBytes(33);return n[0]=e,n.set(o("WASignalOther").ensureSize(t,32),1),n}function y(e){return _(e.privateKey,g(e))}function C(e,t){for(var n=e>=s?0:e-1,r=[],a=0;a<t;a++){var i=n+1>=s?1:n+1,l=m(),u=o("WASignalOther").encodeSignalProto(o("WASignalLocalStorageProtocol.pb").PreKeyRecordStructureSpec,{id:i,publicKey:g(l),privateKey:l.privateKey});r.push({plainObject:{id:i,keyPair:l},record:u}),n=i}return r}function b(e){try{var t=o("decodeProtobuf").decodeProtobuf(o("WASignalLocalStorageProtocol.pb").PreKeyRecordStructureSpec,e),n=t.id,r=t.privateKey,a=t.publicKey;return n==null||a==null||r==null?null:{id:v(n),keyPair:p(o("WASignalOther").toBytes(r,32),R(new Uint8Array(a)))}}catch(e){return null}}function v(e){return o("WASignalOther").ensureIntInRange(e,1,s)}function S(e){return o("WASignalOther").ensureIntInRange(e,0,s)}function R(t){if(t.length===0||t[0]!==e)throw r("err")("Unrecognized public key type");return o("WASignalOther").ensureSize(t,33)}function L(){var e=o("WASignalOther").makeBytes(32);return o("WACryptoDependencies").getCrypto().getRandomValues(e),e}function E(e,t){return o("WACryptoPrimitives").scalarMult(e,t.subarray(1)).buffer}l.KEY_TYPE=e,l.PRE_KEY_NON_INCLUSIVE_UPPER_BORDER=s,l.makeKeyPairFrom=c,l.makeKeyPairFromArrayBuffers=d,l.makeKeyPair=m,l.makeKeyPairFromSerialized=p,l.makeSerializedKeyPairFrom=_,l.makeSerializedKeyPair=f,l.serializePubKey=g,l.serializeIdentity=h,l.toSerializedKeyPair=y,l.makePreKeys=C,l.deserializePreKey=b,l.castToPreKeyId=v,l.castToSignedPreKeyId=S,l.castToSerializedPubKey=R,l.makeRawSenderKey=L,l.ecdh=E}),98);
__d("WAParsableWapNode",["WABinary","WAJids","WALogger","WALongInt","WAParsableXmlNode","WASignalKeys","WATimeUtils","WAWap","WAWapJid","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(e){function t(t,n){var r;return r=e.call(this,"XmppParsingFailure: "+t+": "+n)||this,r.name="XmppParsingFailure",r.parser=t,r.reason=n,r}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.toString=function(){return"XmppParsingFailure: "+this.parser+": "+this.reason},t})(babelHelpers.wrapNativeSuper(Error)),c=(function(t){function n(e,n){return t.call(this,e,n)||this}babelHelpers.inheritsLoose(n,t);var a=n.prototype;return a.assertFromServer=function(){var e=this.attrString("from");e!==o("WAJids").WA_SERVER_JID_SUFFIX&&this.throw('to have "from"="s.whatsapp.net", but instead has "'+e+'"')},a.attrUserJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.botJid!=null?n.botJid:n.userJid==null?this.throw('to have "'+t+'"={UserJid}, but instead has "'+e+'"'):n.userJid},a.attrPhoneUserJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="phoneUser"?n.userJid:this.throw('to have "'+t+'"={PhoneUserJid}, but instead has "'+e+'"')},a.attrLidUserJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="lidUser"?n.userJid:this.throw('to have "'+t+'"={LidUserJid}, but instead has "'+e+'"')},a.maybeAttrUserJid=function(t){return this.hasAttr(t)?this.attrUserJid(t):null},a.maybeAttrPhoneUserJid=function(t){return this.hasAttr(t)?this.attrPhoneUserJid(t):null},a.maybeAttrLidUserJid=function(t){return this.hasAttr(t)?this.attrLidUserJid(t):null},a.attrGroupJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.groupJid==null?this.throw('to have "'+t+'"={GroupJid}, but instead has "'+e+'"'):n.groupJid},a.maybeAttrGroupJid=function(t){return this.hasAttr(t)?this.attrGroupJid(t):null},a.attrChatJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.userJid!=null?n.userJid:n.groupJid!=null?n.groupJid:n.botJid!=null?n.botJid:this.throw('to have "'+t+'"={ChatJid}, but instead has "'+e+'"')},a.attrPhoneChatJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="phoneUser"?n.userJid:n.jidType==="group"?n.groupJid:this.throw('to have "'+t+'"={ChatJid}, but instead has "'+e+'"')},a.attrDeviceJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.deviceJid!=null?n.deviceJid:n.userJid!=null?o("WAJids").defaultDeviceJidForUser(n.userJid):n.hostedDeviceJid!=null?n.hostedDeviceJid:n.hostedLidDeviceJid!=null?n.hostedLidDeviceJid:n.botJid!=null?n.botJid:this.throw('to have "'+t+'"={DeviceJid}, but instead has "'+e+'"')},a.attrPhoneDeviceJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="phoneDevice"?n.deviceJid:n.jidType==="phoneUser"?o("WAJids").defaultPhoneDeviceJidForUser(n.userJid):this.throw('to have "'+t+'"={PhoneDeviceJid}, but instead has "'+e+'"')},a.attrLidDeviceJid=function(t){var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="lidDevice"?n.deviceJid:n.jidType==="lidUser"?o("WAJids").defaultLidDeviceJidForLidUserJid(n.userJid):this.throw('to have "'+t+'"={LidDeviceJid}, but instead has "'+e+'"')},a.attrDeviceId=function(t){var e=this.attrInt(t);return o("WAJids").interpretAsDeviceId(e)},a.attrFromJidChat=function(){var t=this.attrJidWithType();switch(t.jidType){case"msgrUser":{var n=t.userJid,a=o("WAJids").defaultDeviceJidForUser(n);return{type:"device",chat:n,deviceJid:a,author:a}}case"interopUser":{var i=t.userJid,l=o("WAJids").defaultDeviceJidForUser(i);return{type:"device",chat:i,deviceJid:l,author:l}}case"phoneUser":{var s=t.userJid,u=o("WAJids").defaultDeviceJidForUser(s);return{type:"device",chat:s,deviceJid:u,author:u}}case"lidUser":{var c=t.userJid,d=o("WAJids").defaultLidDeviceJidForLidUserJid(c);return{type:"device",chat:c,deviceJid:d,author:d}}case"phoneDevice":{var m=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(m),deviceJid:m,author:m}}case"msgrDevice":{var p=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(p),deviceJid:p,author:p}}case"interopDevice":{var _=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(_),deviceJid:_,author:_}}case"lidDevice":{var f=t.deviceJid;return{type:"device",chat:o("WAJids").extractUserJid(f),deviceJid:f,author:f}}case"group":{var g=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return g==null?this.throw("expected to have participant JID for group"):{type:"group",chat:t.groupJid,groupJid:t.groupJid,author:g}}case"broadcast":{var h=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return h==null?this.throw("expected to have participant JID for group"):{type:"broadcast",broadcastJid:t.broadcastJid,chat:o("WAJids").extractUserJid(h),author:h}}case"hosted":{var y=t.hostedDeviceJid;return{type:"device",chat:o("WAJids").extractUserJid(y),deviceJid:y,author:y}}case"hostedLid":{var C=t.hostedLidDeviceJid;return{type:"device",chat:o("WAJids").extractUserJid(C),deviceJid:C,author:C}}case"call":throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["ParsableWapNode: attrFromJid() is called with ",""])),t.callJid),r("err")("ParsableWapNode: attrFromJid() does not support CallJid");default:return t.jidType,this.throw("attrFromJidChat should not be used with jid of type "+t.jidType)}},a.attrFromJidPhoneChat=function(){var e=this.attrJidWithType();switch(e.jidType){case"phoneUser":{var t=e.userJid,n=o("WAJids").defaultPhoneDeviceJidForUser(t);return{type:"device",chat:t,deviceJid:n,author:n}}case"phoneDevice":{var a=e.deviceJid;return{type:"device",chat:o("WAJids").extractPhoneUserJid(a),deviceJid:a,author:a}}case"group":{var i=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return i==null?this.throw("expected to have participant JID for group"):{type:"group",chat:e.groupJid,groupJid:e.groupJid,author:i}}case"broadcast":{var l=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return l==null?this.throw("expected to have participant JID for group"):{type:"broadcast",broadcastJid:e.broadcastJid,chat:o("WAJids").extractPhoneUserJid(l),author:l}}case"call":throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ParsableWapNode: attrFromJid() is called with ",""])),e.callJid),r("err")("ParsableWapNode: attrFromJid() does not support CallJid");default:return e.jidType,this.throw("attrFromJidChat should not be used with jid of type "+e.jidType)}},a.attrFromPhoneJid=function(){var e=this.attrJidWithType();if(e.jidType==="status"){var t=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return t==null?this.throw("to have participant for status msg"):{type:"status",author:t}}else return this.attrFromJidPhoneChat()},a.attrFromJid=function(){var e=this.attrJidWithType();if(e.jidType==="status"){var t=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return t==null?this.throw("to have participant for status msg"):{type:"status",author:t}}return e.jidType==="newsletter"?{type:"newsletter",newsletterJid:e.newsletterJid}:e.jidType==="hosted"?{type:"hosted",hostedDeviceJid:e.hostedDeviceJid}:e.jidType==="hostedLid"?{type:"hostedLid",hostedLidDeviceJid:e.hostedLidDeviceJid}:this.attrFromJidChat()},a.attrJidWithType=function(t){t===void 0&&(t="from");var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="unknown"?this.throw('to have "'+t+'"={Jid}, but instead has "'+e+'"'):n},a.attrWapJid=function(t){t===void 0&&(t="from");var e=this.attrString(t),n=o("WAJids").interpretAndValidateJid(e);return n.jidType==="unknown"?o("WAWapJid").WapJid.create(null,e):o("WAWap").JID(o("WAJids").extractFromJid(n))},a.attrLongInt=function(t){var e=this.attrString(t);return o("WALongInt").decimalStringToLongInt(e)},a.attrTime=function(t){return o("WATimeUtils").castToUnixTime(this.attrInt(t))},a.maybeAttrTime=function(t){return this.hasAttr(t)?this.attrTime(t):null},a.attrFutureTime=function(t){var e=this.attrInt(t);return o("WATimeUtils").futureUnixTime(e)},a.contentString=function(){if(this.hasChildren())return this.throw("to have string content, but has children instead");if(this.hasContent()){var e=new(o("WABinary")).Binary(this.contentBytes());return e.readString(e.size())}else return this.throw("to have content")},a.decodeAsString=function(t){return o("WAWap").decodeAsString(t)},a.contentSerializedPubKey=function(){return this.hasContent()?o("WASignalKeys").serializeIdentity(this.contentBytes()):this.throw("to have content")},a.createParseError=function(t){return new u(this.name(),"expected <"+this.tag()+"> "+t)},a.throw=function(t){throw this.createParseError(t)},n})(o("WAParsableXmlNode").ParsableXmlNode);l.XmppParsingFailure=u,l.ParsableWapNode=c}),98);
__d("WADeprecatedWapParser",["WAParsableWapNode","err"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t){this.$1=e,this.$2=t}var t=e.prototype;return t.parse=function(t){var e=new(o("WAParsableWapNode")).ParsableWapNode(this.$1,t);try{return{success:this.$2(e)}}catch(e){if(e instanceof o("WAParsableWapNode").XmppParsingFailure)return{error:e};throw e}},t.parseOrThrow=function(t){var e=this.parse(t);if(e.error)throw r("err")(String(e.error));return e.success},e})();l.default=e}),98);
__d("WAAckParser",["WADeprecatedWapParser","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e=new(r("WADeprecatedWapParser"))("ack",function(e){return e.assertTag("ack"),{id:e.attrString("id"),ts:e.maybeAttrString("t"),class:e.attrString("class"),type:e.maybeAttrString("type"),from:e.attrJidWithType(),participant:e.hasAttr("participant")?e.attrDeviceJid("participant"):null,recipient:e.hasAttr("recipient")?e.attrUserJid("recipient"):null}});function s(e,t){return e.id===t.id&&(t.class===void 0||e.class===t.class)&&(t.type===void 0||e.type===t.type)&&(t.from===void 0||u(e.from,t.from))&&(t.participant===void 0||e.participant===t.participant)&&(t.recipient===void 0||e.recipient===t.recipient)&&(t.ts===void 0||e.ts===t.ts)}function u(e,t){if(o("WAJids").extractFromJid(e)===t)return!0;if(e.userJid!=null)return o("WAJids").defaultDeviceJidForUser(e.userJid)===t;if(e.deviceJid!=null){var n=e.deviceJid;return o("WAJids").extractDeviceId(n)===0&&o("WAJids").extractUserJid(n)===t}return!1}l.AckParser=e,l.ackMatchesTemplate=s,l.fromJidsAreEqual=u}),98);
__d("WAParseIqResponse",["WAWap"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){var r=e.content;if(r&&Array.isArray(r)&&r[0]){var a=r[0];if(a.tag==="error"){var i=a.attrs||{},l;n&&(typeof n=="function"?l=n(e):l=n.parseOrThrow(a));var u=l;return{success:!1,errorCode:parseInt(i.code,10),errorText:o("WAWap").decodeAsString(i.text)||"",errorType:o("WAWap").decodeAsString(i.type)||"",errorBackoff:parseInt(i.backoff,10),toString:s,customError:u}}}return typeof t=="function"?{success:!0,result:t(e)}:{success:!0,result:t.parseOrThrow(e)}}function s(){return"IqError "+this.errorCode+": "+this.errorText}l.parseIqResponse=e}),98);
__d("WADeprecatedSendIq",["Promise","WAAckParser","WAArrayUtils","WAComms","WALogger","WAParseIqResponse"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){return o("WAComms")._sendIq(e,!1).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t)})}function c(e,t,n){return o("WAComms")._sendIq(e,!1).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t,n)})}function d(e,t,n){return o("WAComms")._sendIq(e,!1,n).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t)})}function m(e,t){return o("WAComms")._sendIq(e,!0).then(function(e){return o("WAParseIqResponse").parseIqResponse(e,t)})}function p(e,t){return _(e,t).then(function(){})}function _(t,r){return new(s||(s=n("Promise")))(function(a){var i=o("WAComms").singletonOrThrowIfUninitialized("deprecatedSendStanzaAndReturnAck"),l=function(t){var e=o("WAAckParser").AckParser.parse(t);return!e.error&&o("WAAckParser").ackMatchesTemplate(e.success,r)?t:null},u={type:"ack",parseAndTest:l,resolve:a,stanza:t,attachedToSocketId:o("WAComms").DEFAULT_SOCKET_ID,orderedId:o("WAComms").getAndIncrementNextOrderedId()};if(i.ackHandlers.push(u),!i.socket){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket, will send stanza when socket opens"])));return}i.callStanza(t).catch(function(e){var t=i.ackHandlers.indexOf(u);t!==-1&&(o("WAArrayUtils").removeIndexWithoutPreservingOrder(i.ackHandlers,t),u.resolve((s||(s=n("Promise"))).reject(e)))})})}function f(e,t){o("WAComms").castSmaxStanza(e,t)}l.deprecatedSendIq=u,l.deprecatedSendIqErrorParser=c,l.deprecatedSendIqIfConnectedWithin=d,l.deprecatedSendIqWithoutRetry=m,l.deprecatedSendStanzaAndWaitForAck=p,l.deprecatedSendStanzaAndReturnAck=_,l.deprecatedCastStanza=f}),98);
__d("WAMediaConnParser",["WADeprecatedWapParser","WAServerMediaType"],(function(t,n,r,o,a,i,l){"use strict";var e=new(r("WADeprecatedWapParser"))("mediaConnParser",function(e){var t,n,r=e.child("media_conn"),o=c(r);return{hosts:o,authToken:r.attrString("auth"),authTokenExpiryTs:r.attrFutureTime("auth_ttl"),routesExpiryTs:r.attrFutureTime("ttl"),maxBuckets:r.attrInt("max_buckets"),maxManualRetry:(t=r.maybeAttrInt("max_manual_retry",0,4))!=null?t:3,maxAutoDownloadRetry:(n=r.maybeAttrInt("max_auto_download_retry",0,4))!=null?n:3}});function s(e){var t,n;if(e.hasAttr("fallback_hostname"))return{domain:e.attrString("fallback_hostname"),class:e.maybeAttrString("fallback_class"),ip4:(t=e.maybeAttrString("fallback_ip4"))!=null?t:void 0,ip6:(n=e.maybeAttrString("fallback_ip6"))!=null?n:void 0}}function u(e){var t,n,r,o;return{domain:e.attrString("hostname"),fallback:s(e),uploadable:d(e,"upload"),downloadable:d(e,"download"),isFallback:e.maybeAttrString("type")==="fallback",downloadBuckets:(t=(n=e.maybeChild("download_buckets"))==null?void 0:n.mapChildren(function(e){return parseInt(e.tag(),10)}))!=null?t:[],class:e.maybeAttrString("class"),ip4:(r=e.maybeAttrString("ip4"))!=null?r:void 0,ip6:(o=e.maybeAttrString("ip6"))!=null?o:void 0}}function c(e){return e.mapChildrenWithTag("host",u)}function d(e,t){return e.hasChild(t)?e.child(t).mapChildren(function(e){var t=e.tag();return o("WAServerMediaType").castToServerMediaType(t)}).filter(Boolean):o("WAServerMediaType").SERVER_MEDIA}l.mediaConnParser=e}),98);
__d("WAGatherMediaInfo",["WADeprecatedSendIq","WAErrors","WALogger","WAMediaConnParser","WAPromiseManagement","WAPromiseRetryLoop","WAResultOrError","WAWap"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=507,p=o("WAPromiseManagement").cacheWhilePending(function(){return"gatherMediaInfo"},_);function _(){var e=new(o("WAPromiseRetryLoop")).PromiseRetryLoop({name:"gatherMediaInfo",timer:{jitter:.25,max:987e3,algo:{type:"fibonacci",first:6e3,second:12e3},relativeDelay:!0},code:g});return e.start(),e.promise()}var f=60;function g(t){var n,r=(n=o("WAWap")).wap("iq",{id:n.generateId(),to:n.S_WHATSAPP_NET,type:"set",xmlns:"w:m"},n.wap("media_conn",null));return o("WADeprecatedSendIq").deprecatedSendIqIfConnectedWithin(r,o("WAMediaConnParser").mediaConnParser,f).then(function(n){if(n.success)o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got "," hosts"])),n.result.hosts.length),t(o("WAResultOrError").makeResult(n.result));else if(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo failure ",""])),n),n.errorCode===m){var r=n.errorBackoff;o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got "," seconds backoff"])),r),t(o("WAResultOrError").makeError({type:"backoff",backoffMs:r*1e3}))}else n.errorCode<500&&(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got client error: ",""])),n.errorCode),t(o("WAResultOrError").makeError({type:"client-error",code:n.errorCode,text:n.errorText})))}).catch(function(e){e instanceof o("WAErrors").Disconnected?t(o("WAResultOrError").makeError("disconnected")):o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo error ",""])),e)})}l.gatherMediaInfo=p}),98);
__d("WAMediaRouteSelection",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=null,n=null,r=null,a=e.hosts,i=e.mediaType,l=e.operation;if(e.operation==="download"){var s,u=e.catHotTimespan,c=e.getVcaEnabledBucket,d=e.ncHot,m=new Map;a.forEach(function(e){e.downloadBuckets.forEach(function(t){m.set(t,e)})});var p=m.get(0);u>0&&d!=null&&o("WATimeUtils").happenedWithin(o("WATimeUtils").castToUnixTime(d),u)?t=1:c&&(t=c());var _=null;t!=null&&(_=m.get(t)),(s=_)!=null&&s.downloadable.includes(i)?n=_:p!=null&&p.downloadable.includes(i)&&(n=p)}for(var f=0;f<a.length;f++){var g=a[f];if((l==="upload"&&g.uploadable.includes(i)||l==="download"&&g.downloadable.includes(i))&&(n==null?n=g:g.isFallback&&r==null&&(r=g)),n!=null&&r!=null)break}return{selectedHost:n,fallbackHost:r,bucket:t}}l.mediaRouteSelection=e}),98);
__d("WAGetMediaRoute",["$InternalEnum","WACreateGetVcaEnabledBucket","WAExtractNcHotTimestamp","WAGatherMediaInfo","WAMediaRouteSelection","WAPromiseManagement","WAResultOrError","WATagsLogger","WATimeUtils","WAWaitForComms","WAWorkerGlobalScope"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("WATagsLogger").TAGS(["GetMediaRoute"]),g=86400,h=n("$InternalEnum")({Fresh:"fresh",Cached:"cached",Stale:"stale"}),y=null,C=!1,b=null;async function v(t,n){n==null||n.addPoint("get_cached_or_fresh_media_access_start");var r=await E();if(n==null||n.addPoint("get_cached_or_fresh_media_access_end"),!r.success)return f.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to get mediaAccess: ",""])),r.error),n==null||n.addPoint("get_media_access_failed",{string:{mediaAccessStatus:r.error}}),r;n==null||n.addAnnotations({string:{mediaAccessStatus:r.value.state}});var a=r.value.mediaAccess,i=a.authToken,l=a.hosts,u=a.maxBuckets,c=t.operation==="upload"?o("WAMediaRouteSelection").mediaRouteSelection({operation:"upload",mediaType:t.serverMediaType,hosts:l}):o("WAMediaRouteSelection").mediaRouteSelection({operation:"download",mediaType:t.serverMediaType,hosts:l,catHotTimespan:g,ncHot:o("WAExtractNcHotTimestamp").extractNcHotTimestamp(t.directPath),getVcaEnabledBucket:o("WACreateGetVcaEnabledBucket").msgrCreateGetVcaEnabledBucket(t.directPath,u)}),d=c.bucket,m=c.fallbackHost,p=c.selectedHost;return p==null?(f.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error: no media host"]))),o("WAResultOrError").makeError("no-host")):o("WAResultOrError").makeResult({authToken:i,selectedHost:p,fallbackHost:m,bucket:d})}function S(){var e=b;e!=null&&(o("WAWorkerGlobalScope").workerGlobalScope.clearTimeout(e),b=null)}function R(e){S();var t=Math.max(e.authTokenExpiryTs-o("WATimeUtils").unixTime(),0);if(!(t<=300)){var n=o("WATimeUtils").pastUnixTime(300,e.authTokenExpiryTs),r=o("WATimeUtils").pastUnixTime(Math.floor(t*.2),e.authTokenExpiryTs),a=n<r?n:r,i=o("WATimeUtils").cappedMillisecondsUntil(a),l=Math.floor(Math.random()*o("WATimeUtils").MINUTE_MILLISECONDS),s=o("WAWorkerGlobalScope").workerGlobalScope.setTimeout(function(){f.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["AuthTTL approaching expiry, refreshing MediaAccess routes"]))),L().catch(function(e){f.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Error occurred during authTTL automatic refresh: ",""])),e)})},i+l);b=s}}var L=o("WAPromiseManagement").cacheWhilePending(function(){return"all"},async function(){if(C)return f.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["mediaAccess has gone, but we are still locked by backoff"]))),o("WAResultOrError").makeError("backoff");await o("WAWaitForComms").waitForComms(),f.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["mediaAccess has gone, gather a new one"]))),S();var e=await o("WAGatherMediaInfo").gatherMediaInfo();if(e.success)return y=e.value,R(e.value),o("WAResultOrError").makeResult({mediaAccess:e.value,state:h.Fresh});var t=e.error,n=t==="disconnected"?"disconnected":t.type;return f.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Can not get mediaAccess: ",""])),n),t==="disconnected"||t.type==="client-error"?o("WAResultOrError").makeError("disconnected"):(t.type,C=!0,o("WAWorkerGlobalScope").workerGlobalScope.setTimeout(function(){C=!1,L().catch(function(e){f.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Error occurred on gather after backoff expiry: ",""])),e)})},t.backoffMs),o("WAResultOrError").makeError("backoff"))}),E=function(){var e=y;if(e==null)return L();if(o("WATimeUtils").isInFuture(e.routesExpiryTs))return Promise.resolve(o("WAResultOrError").makeResult({mediaAccess:e,state:h.Cached}));var t=L();return o("WATimeUtils").isInFuture(e.authTokenExpiryTs)?Promise.resolve(o("WAResultOrError").makeResult({mediaAccess:e,state:h.Stale})):t};function k(){y=null,C=!1,S()}l.getMediaRoute=v,l.getCachedOrFreshMediaAccess=E,l.clearCachedMediaAccessForTest=k}),98);
__d("WAMediaOperationsRetrier",["WALogger","WAPromiseBackoffs"],(function(t,n,r,o,a,i,l){"use strict";var e,s=4,u={algo:{type:"constant",delay:1e3},jitter:0},c=(function(){function t(e,t,n){this.$1=e,this.routesInfo=t,this.$2=o("WAPromiseBackoffs").createPromiseTimer(u),this.$3=0,this.$4=!1,this.$5=n}var n=t.prototype;return n.run=async function(n,r){for(;this.$3<s;){await this.$2();var t=void 0;if(this.$3>0){var a;t=this.$3>=s-2&&!this.$4,o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["MediaOperationsRetrier:"," wait for internet, attempt = ",""])),this.$1,this.$3),await((a=this.$5)==null?void 0:a.call(this))}else t=!1;var i=this.routesInfo;if(!i)return null;var l=i.host;t&&i.fallbackHost&&(l=i.fallbackHost);var u=await n(l,i.authToken,this.$3,r);if(u.success)return u.value;++this.$3,this.$4=u.error.progressMade}return null},t})();l.MAX_ATTEMPTS=s,l.BACKOFF_OPTIONS=u,l.MediaOperationsRetrier=c}),98);
__d("WACreateMediaDownloadRetrier",["WAComms","WAGetMediaRoute","WAMediaOperationsRetrier","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){var t=e.directPath,n=e.eventFlow,r=e.fileEncSha256,a=e.mediaTypeDetails,i=a.type==="regular"?a.mediaType:"preview";n==null||n.addPoint("get_media_route_start");var l=await o("WAGetMediaRoute").getMediaRoute({operation:"download",serverMediaType:i,fileEncSha256:r,directPath:t},n);if(!l.success)return n==null||n.addPoint("get_media_route_fail"),l;n==null||n.addPoint("get_media_route_end");var s=l.value,u=s.authToken,c=s.fallbackHost,d=s.selectedHost,m=new(o("WAMediaOperationsRetrier")).MediaOperationsRetrier("download",{host:{domain:d.domain,class:d.class},fallbackHost:c&&{domain:c.domain,class:c.class},authToken:u,timeElapsed:null},o("WAComms").waitForConnection);return o("WAResultOrError").makeResult({retrier:m,mediaRouteDetails:l.value})}l.createMediaDownloadRetrier=e}),98);
__d("WAHttpDownloadMedia",["WAErrorMessage","WALogger","WAMediaQplHelper","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="URL signature expired";async function m(t,n){var r=n!=null?n:{},a=r.abortSignal,i=r.mediaMetrics;i==null||i.addPoint("http_fetch_start");var l=await self.fetch(t,{method:"GET",mode:"cors",cache:"no-store",signal:a}).then(function(e){return i==null||i.addPoint("http_fetch_end"),o("WAResultOrError").makeResult(e)}).catch(function(t){var n=o("WAErrorMessage").maybeGetMessageFromError(t);return i==null||i.addPoint("http_fetch_fail",{string:{httpFetchError:n}}),o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to initiate fetch: ",", message: ",""])),t,n),t.name==="AbortError"?o("WAResultOrError").makeError("http-fetch-aborted"):o("WAResultOrError").makeError("http-fetch-exception")});if(l.success===!1)return l;var m=l.value,p=m.headers.get("content-length"),_=m.status;switch(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Fetch Media HTTP status ",""])),_),i==null||i.addAnnotations({string:{ciphertextMediaSizeBucket:p!=null?o("WAMediaQplHelper").convertIntegerSizeToStringBucket(Number(p)):null},int:{httpStatus:_}}),_){case 200:case 206:return o("WAResultOrError").makeResult(m);case 401:return o("WAResultOrError").makeError("access-expired");case 403:return m.text().then(function(e){return e===d?o("WAResultOrError").makeError("signature-expired"):o("WAResultOrError").makeError("access-expired")}).catch(function(e){return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to parse request body: ",""])),e),o("WAResultOrError").makeError("access-expired")});case 404:case 410:return o("WAResultOrError").makeError("media-not-found");case 408:return o("WAResultOrError").makeError("server-timeout");case 416:return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Download Media Error: can not resume from offset"]))),o("WAResultOrError").makeError("request-error");case 429:case 507:return o("WAResultOrError").makeError("download-throttled");default:return _>=400&&_<500?o("WAResultOrError").makeError("request-error"):o("WAResultOrError").makeError("unspecified-http-error")}}l.httpDownloadMedia=m}),98);
__d("WAHttpUtils",["err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){if(!/^https:\/\/[-\w.]+\.\w+$/.test(e))throw r("err")('buildUrl given invalid host "'+e+'"');if(!t.startsWith("/"))throw r("err")('buildUrl given invalid path "'+t+'"');var o=n,a=""+e+t;if(!o)return a;var i=Object.keys(o).map(function(e){var t=o[e];t instanceof ArrayBuffer&&(t=new Uint8Array(t));var n=t instanceof Uint8Array?Array.from(t).map(function(e){return"%"+e.toString(16)}).join(""):encodeURIComponent(t.toString());return encodeURIComponent(e)+"="+n});if(i.length>0){var l=i.join("&");return a.includes("?")?a+"&"+l:a+"?"+l}else return a}l.buildUrl=e}),98);
__d("WAMediaUrl",["WABase64","WAGlobals","WAHttpUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=1;function s(t,n,r,a,i,l,s){var u=o("WAGlobals").getDependencies().mediaUploadRoot(),c=o("WABase64").encodeB64UrlSafe(r),d=o("WABase64").encodeB64UrlSafe(n),m={auth:i,token:d};return l&&(m.resume=e),s!=null&&s>0&&(m.bytestart=s),o("WAHttpUtils").buildUrl("https://"+a,u+"/"+t+"/"+c,m)}function u(e,t,n,r,a,i,l){var s=o("WABase64").encodeB64UrlSafe(t),u={hash:s,mode:r};return a!=null&&(u._nc_cat=a),i!=null&&i>=0&&(u.bytestart=i),l!=null&&l>0&&(u.byteend=l),o("WAHttpUtils").buildUrl("https://"+n,e,u)}l.RESUME_PARAM=e,l.buildUploadUrl=s,l.buildDownloadUrl=u}),98);
__d("WADownloadCiphertext",["WAAssertUnreachable","WABase64","WACreateMediaDownloadRetrier","WACryptoSha256","WACryptoUtils","WAHashUtils","WAHttpDownloadMedia","WALogger","WAMediaUrl","WAPromiseManagement","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;async function p(t){var n=t.abortSignal,a=t.directPath,i=t.eventFlow,l=t.fileEncSha256,p=t.fromBytes,_=t.mediaTypeDetails,g=t.plaintextHash,h=t.toBytes;o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Start download ciphertext for hash: ",""])),o("WAHashUtils").sanitisePlaintextHash(g)),i.addPoint("create_retrier_start");var y=await o("WACreateMediaDownloadRetrier").createMediaDownloadRetrier({mediaTypeDetails:_,directPath:a,eventFlow:i,fileEncSha256:l});if(!y.success)return i.addPoint("create_retrier_fail"),y;i.addPoint("create_retrier_end");var C=y.value,b=C.mediaRouteDetails,v=C.retrier,S=await v.run(function(e,t,r){var d=e.domain,m="http_download_media_"+r,_=o("WAMediaUrl").buildDownloadUrl(a,l,d,"manual",b.bucket,p,h);return i.addPoint(m+"_start"),o("WAHttpDownloadMedia").httpDownloadMedia(_,{mediaMetrics:i,abortSignal:n,cachePolicy:r>0?"no-store":"force-cache"}).then(function(e){if(e.success)return e.value.arrayBuffer().then(function(e){return i.addPoint(m+"_end"),o("WAResultOrError").makeResult(o("WAResultOrError").makeResult(e))}).catch(function(e){return i.addPoint("response_array_buffer_error"),i.addPoint(m+"_fail"),o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to parse request body ",""])),e),o("WAResultOrError").makeResult(o("WAResultOrError").makeError("body-network-error"))});i.addPoint(m+"_fail");var t=e.error;switch(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Download Media Error: ",""])),t),i.addPoint(t),t){case"signature-expired":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("signature-expired"));case"http-fetch-aborted":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("http-fetch-aborted"));case"http-fetch-exception":case"server-timeout":case"unspecified-http-error":return o("WAResultOrError").makeError({progressMade:!0});default:return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(t))}}).catch(function(e){return i.addPoint(m+"_fail"),o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["downloadCiphertext http download exception: ",""])),e),o("WAResultOrError").makeError({progressMade:!1})})});if(S==null)return o("WALogger").WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia given up"]))),o("WAResultOrError").makeError("max-attempts-exceeded");if(S.success===!1){var R=S.error;switch(o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext failed: ",""])),R),R){case"signature-expired":case"http-fetch-aborted":case"media-not-found":case"download-throttled":case"body-network-error":case"request-error":return o("WAResultOrError").makeError(R);case"access-expired":return o("WAResultOrError").makeError("disconnected");default:throw r("WAAssertUnreachable")(R)}}else{var L=S.value;return!f(p,h)&&!o("WACryptoUtils").arrayBuffersEqual(await o("WACryptoSha256").sha256(L),l)?o("WAResultOrError").makeError("ciphertext-hash-mismatch"):(i.addPoint("download_finish",{int:{byteLength:L.byteLength},bool:{isPartialDownload:f(p,h)}}),o("WAResultOrError").makeResult(L))}}var _=o("WAPromiseManagement").cacheWhilePending(function(e){var t=e.fileEncSha256,n=e.fromBytes,r=e.toBytes;return o("WABase64").encodeB64UrlSafe(t)+"-"+(n!=null?n:"X")+"-"+(r!=null?r:"X")},p);function f(e,t){return e!=null&&e>0?!0:t!=null}l.cachedDownloadCiphertext=_}),98);
__d("WADownloadAndDecryptMedia",["WADecryptMedia","WADownloadCiphertext","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){var t=e.abortSignal,n=e.directPath,r=e.eventFlow,a=e.fileEncSha256,i=e.mediaKey,l=e.mediaTypeDetails,s=e.plaintextHash,u=await o("WADownloadCiphertext").cachedDownloadCiphertext({abortSignal:t,mediaTypeDetails:l,fileEncSha256:a,directPath:n,eventFlow:r,plaintextHash:s});if(u.success!==!0)return u;var c=await o("WADecryptMedia").decryptMedia({mediaKey:i,mediaTypeDetails:l,plaintextHash:s,ciphertextHmac:u.value});return c.success!==!0?c:(c.value.alternativeHmacSaltUsed!=null&&r.addAnnotations({string:{alternativeHmacSaltUsed:c.value.alternativeHmacSaltUsed}}),o("WAResultOrError").makeResult(c.value.plaintext))}l.downloadAndDecryptMedia=e}),98);
__d("WACreateMediaDecrypterStream",["WABinary","WAMediaCrypto","WAResultOrError","WATagsLogger","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WATagsLogger").TAGS(["WADecryptStream"]);function f(t,n,r,a,i){if(a.byteLength===0)return _.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["expectedHmacs must have at least one element"]))),o("WAResultOrError").makeError("missing-expected-hmacs");if(a.byteLength!==i.length*o("WAMediaCrypto").HMAC_LENGTH)return _.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["expectedHmacs and ciphertextLengths must have the same length"]))),o("WAResultOrError").makeError("hmac-chiphertext-array-mismatch");var l=g(a),m=n,p=new(o("WABinary")).Binary,f=0,y=async function(n,a){for(p.writeByteArray(n);f<l.length&&p.size()>=i[f];f++){var e=p.readByteArrayView(i[f]);_.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Processing scan "," of size ",""])),f,e.length);var s=f===i.length-1;try{var d=await o("WAMediaCrypto").hmacAndDecryptPartial(t,m,e,r,l[f]),g=d.nextIv,y=d.plaintext;s?a.enqueue(h(y)):a.enqueue(y),m=g}catch(e){_.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Unable to decrypt chunk. isLastChunk: "," error: ",""])),s,e),e instanceof o("WAMediaCrypto").HmacValidationError?a.error("enc-hash-mismatch"):a.error("decryption-error")}}},C=new TransformStream({transform:function(t,n){var e=t;return y(e,n)},flush:function(t){p.size()>0&&_.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unexpected ciphertext in buffer following flush"])))}});return o("WAResultOrError").makeResult(C)}function g(e){var t=[];if(e.byteLength%o("WAMediaCrypto").HMAC_LENGTH!==0)throw r("err")("Sidecar length is not a multiple of hmac length");for(var n=0;n<e.byteLength;n+=o("WAMediaCrypto").HMAC_LENGTH){var a=new Uint8Array(e,n,o("WAMediaCrypto").HMAC_LENGTH);t.push(a)}return t}function h(e){if(e.length<o("WAMediaCrypto").CBC_BLOCK_SIZE)return _.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Plaintext size is less than CBC_BLOCK_SIZE"]))),e;var t=e[e.length-1];return t===0||t>o("WAMediaCrypto").CBC_BLOCK_SIZE?(_.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Invalid PKCS padding length"]))),e):e.subarray(0,-t)}l.createDefaultDecryptStream=f}),98);
__d("WAMediaProgressiveJpegTransformStream",["WABinary"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.scanLengths,n=[],r=0;for(var a of t)r+=a,n.push(r);var i=new(o("WABinary")).Binary,l=0,s=0,u=new TransformStream({transform:function(r,o){var e=r;for(s+=e.byteLength,i.writeByteArray(e);l<t.length&&n[l]<s;l++){var a=i.readByteArrayView(t[l]);o.enqueue(a)}},flush:function(t){t.enqueue(i.readByteArrayView())}});return u}l.makeProgressiveJpegHandlerTransformStream=e}),98);
__d("WADownloadProgressiveJpegPlaintextStreamerWithoutRetry",["WACreateMediaDecrypterStream","WAHttpDownloadMedia","WAMediaCrypto","WAMediaProgressiveJpegTransformStream","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["WADownloadProgressiveJpegPlaintextStreamer"]);function c(e){return e}async function d(t){var n=t.abortSignal,r=t.cachePolicy,a=t.downloadUrl,i=t.eventFlow,l=t.mediaKey,c=t.progressiveJpegDetails,d=t.serverMediaType,m=await o("WAHttpDownloadMedia").httpDownloadMedia(a,{mediaMetrics:i,abortSignal:n,cachePolicy:r});if(m.success!==!0)return m;var p=m.value.body;if(p==null)return o("WAResultOrError").makeError("body-network-error");var _=m.value.headers.get("Content-Length");if(_==null)return u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Content-Length header is missing"]))),o("WAResultOrError").makeError("missing-content-length-header");var f=Number(_);if(Number.isNaN(f))return u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Content-Length header is not a number"]))),o("WAResultOrError").makeError("invalid-content-length-header");var g=o("WAProgressiveJpegGetPJpegDetails").getExtendedProgressiveJpegDetails({progressiveJpegDetails:c,ciphertextLength:f}),h=await o("WAMediaCrypto").computeMediaKeys(l,d),y=o("WACreateMediaDecrypterStream").createDefaultDecryptStream(h.cipherKey,h.iv,h.hmacKey,g.sidecar,g.alignedScanLengths);if(y.success!==!0)return y;var C=y.value,b=o("WAMediaProgressiveJpegTransformStream").makeProgressiveJpegHandlerTransformStream(g),v=p.pipeThrough(C).pipeThrough(b);return o("WAResultOrError").makeResult(v)}l.unsafeCastToDownloadAndDecryptPJpegStream=c,l.downloadProgressiveJpegPlaintextUsingStreamsWithoutRetry=d}),98);
__d("WADownloadProgressiveJpegPlaintextStreamer",["WAAssertUnreachable","WACreateMediaDownloadRetrier","WADownloadProgressiveJpegPlaintextStreamerWithoutRetry","WAMediaUrl","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("WATagsLogger").TAGS(["WADownloadProgressiveJpegPlaintextStreamer"]);async function u(t){var n=t.abortSignal,a=t.directPath,i=t.eventFlow,l=t.fileEncSha256,u=t.mediaKey,c=t.progressiveJpegDetails,d=t.serverMediaType,m=await o("WACreateMediaDownloadRetrier").createMediaDownloadRetrier({directPath:a,eventFlow:i,fileEncSha256:l,mediaTypeDetails:{type:"regular",mediaType:d}});if(!m.success)return m;var p=m.value,_=p.mediaRouteDetails,f=p.retrier,g=_.bucket,h=await f.run(async function(e,t,s){var m=e.domain,p=o("WAMediaUrl").buildDownloadUrl(a,l,m,"manual",g),_=await o("WADownloadProgressiveJpegPlaintextStreamerWithoutRetry").downloadProgressiveJpegPlaintextUsingStreamsWithoutRetry({abortSignal:n,downloadUrl:p,eventFlow:i,mediaKey:u,progressiveJpegDetails:c,serverMediaType:d,cachePolicy:s>0?"no-store":"force-cache"});if(_.success===!0)return o("WAResultOrError").makeResult(_);var f=_.error;switch(f){case"http-fetch-exception":case"server-timeout":case"unspecified-http-error":case"invalid-content-length-header":case"missing-content-length-header":return o("WAResultOrError").makeError({progressMade:!0});case"access-expired":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("disconnected"));case"body-network-error":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError("request-error"));case"media-not-found":case"request-error":case"download-throttled":case"signature-expired":case"http-fetch-aborted":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(f));case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(f));default:throw r("WAAssertUnreachable")(f)}});return h==null?(s.WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Download with stream given up"]))),o("WAResultOrError").makeError("max-attempts-exceeded")):h}l.downloadProgressiveJpegPlaintextUsingStreams=u}),98);
__d("WAPrepareMediaDownload",["Promise","WAErrorMessage","WAGetAgeBucketForMediaKeyTimestamp","WAHashUtils","WAMediaQplHelper","WAProgressiveJpegGetPJpegDetails","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=typeof((e=navigator.storage)==null?void 0:e.getDirectory)=="function",m=typeof self.caches=="object",p=0;function _(e){var t,r=e.hash,a=e.logger,i=e.mediaDownloadFlow,l=e.mediaEntry,_=l.directPath,f=l.downloadableThumbnail,g=l.mediaKeyTimestamp,h=l.serverMediaType,y=l.size,C=o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(g);a.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["start download ",". mediaKeyTimestampAgeBucket: ",", size: ",", serverMediaType: ",""])),o("WAHashUtils").sanitisePlaintextHash(r),C,y,h);var b=(t=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(l).value)!=null?t:null;return i.addPoint("wa_protocol_media_download_start",{string:{mediaType:h,mediaKeyTimestampAgeBucket:C,sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)},bool:{isOPFSSupported:d,isWebCacheSupported:m,duplicateDirectPath:(f==null?void 0:f.directPath)===_,hasDownloadableThumbnail:(f==null?void 0:f.directPath)!=null,isProgressiveJpeg:b!=null}}),{logDownloadResult:function(t){return p++,i.addAnnotations({int:{concurrentDownloadCount:p}}),t.then(function(e){if(e.success){var t=e.value.plaintext.byteLength;i.addPoint("wa_protocol_media_download_end",{string:{media_size:o("WAMediaQplHelper").convertIntegerSizeToStringBucket(t)}})}else i.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:e.error}});return e}).catch(function(e){i.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"runtime-error"}});var t=o("WAErrorMessage").maybeGetMessageFromError(e);return a.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media due to runtime-error: ",""])),t),(c||(c=n("Promise"))).resolve(o("WAResultOrError").makeError("runtime-error"))}).finally(function(){p--})}}}l.prepareMediaDownload=_}),98);
__d("WAProgressiveJpegAddJPEGTrailingTag",["WATypedArraysConcat"],(function(t,n,r,o,a,i,l){"use strict";var e=new Uint8Array([255,217]);function s(t){return o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[new Uint8Array(t),e]).buffer}l.JPEG_TRAILING_TAG=e,l.addJPEGTrailingTag=s}),98);
__d("WAStreamAsyncIterator",[],(function(t,n,r,o,a,i){"use strict";function e(e){return l.apply(this,arguments)}function l(){return l=babelHelpers.wrapAsyncGenerator(function*(e){var t=e.getReader();try{for(;;){var n=yield babelHelpers.awaitAsyncGenerator(t.read()),r=n.done,o=n.value;if(r)return;yield o}}finally{t.releaseLock()}}),l.apply(this,arguments)}i.streamAsyncIterator=e}),66);
__d("WADownloadMedia",["WAByteArray","WACryptoSha256","WACryptoUtils","WADownloadAndDecryptMedia","WADownloadDownloadablePreview","WADownloadProgressiveJpegPlaintextStreamer","WADownloadProgressiveJpegPreview","WAErrorMessage","WAHashUtils","WAMediaCrypto","WAMediaUtils","WAPrepareMediaDownload","WAProgressiveJpegAddJPEGTrailingTag","WAProgressiveJpegGetPJpegDetails","WAPromiseManagement","WAResultOrError","WAStreamAsyncIterator","WATagsLogger","WATypedArraysConcat"],(function(t,n,r,o,a,i,l){"use strict";var e=["hash"],s,u,c,d,m,p,_,f,g,h,y,C,b,v,S=o("WATagsLogger").TAGS(["MediaDownload"]);function R(e){var t=e.downloadMediaMetric,n=e.handleMediaPreviewBeforeDownload,r=e.handleMediaPreviewDownload,a=e.handleMediaPreviewDownloadFailed,i=e.hash,l=e.mediaEntry,s=e.protocolMsgId,u=o("WAPrepareMediaDownload").prepareMediaDownload({mediaDownloadFlow:t,mediaEntry:l,hash:i,logger:S}),c=u.logDownloadResult;return c(E({downloadMediaMetric:t,hash:i,mediaEntry:l,protocolMsgId:s,handleMediaPreviewDownload:r,handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:a}))}var L=async function(t){var e=t.downloadMediaMetric,n=t.handleMediaPreviewBeforeDownload,r=t.handleMediaPreviewDownload,a=t.handleMediaPreviewDownloadFailed,i=t.hash,l=t.mediaEntry,p=t.protocolMsgId,_=o("WAMediaUtils").validateDecodedMediaEntryForDownload(l);if(!_.success)return S.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["mediaEntry is incomplete. ",""])),_.error),_;var f=_.value,g=f.directPath,h=f.fileEncSha256,y=f.fileSha256,C=f.mediaKey,b=f.serverMediaType,v=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(l);v.success===!1&&(S.WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to get ProgressiveJpeg details: ",""])),v.error),e.addPoint(v.error));var R=v.success===!0?v.value:null,L=function(t){if(t==null)return Promise.resolve();var e=o("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(b);return e==null?(S.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - unsupported preview media type ",""])),b),Promise.resolve()):r(i,t,e,p).then(function(){})};if(R!=null&&o("WAMediaUtils").isTransformStreamSupported()&&b==="image"){var E=await x({directPath:g,downloadFlow:e,fileEncSha256:h,handleMediaPreviewBlob:L,hash:i,mediaKey:C,progressiveJpegDetails:R,serverMediaType:b,fileSha256:y,handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:a});if(E.success)return o("WAResultOrError").makeResult({mimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType(b),plaintext:E.value,serverMediaType:b});var I=E.error;switch(S.WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Media Streaming failed to download progressive jpeg. Reason: ",". PlaintextHash: ",""])),I,o("WAHashUtils").sanitisePlaintextHash(i)),I){case"signature-expired":case"request-error":return S.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Skipping fallback for ",". PlaintextHash: ",""])),I,o("WAHashUtils").sanitisePlaintextHash(i)),o("WAResultOrError").makeError(I)}}e==null||e.addPoint("fallback_to_non_streaming_download");var T=D({hash:i,mediaEntry:l,progressiveJpegDetails:R,protocolMsgId:p,serverMediaType:b,handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:a,downloadEntry:e.downloadEntry,triggerUIView:e.triggerUIView});return T.then(function(e){return e.success===!1?L(null):L(e.value)}),k({downloadMediaMetric:e,mediaEntry:_.value})},E=o("WAPromiseManagement").cacheWhilePending(function(e){var t=e.hash;return t},L),k=async function(t){var e=t.abortSignal,n=t.downloadMediaMetric,r=t.mediaEntry,a=r.directPath,i=r.fileEncSha256,l=r.fileSha256,s=r.mediaKey,u=r.serverMediaType,c=await T({abortSignal:e,downloadFlow:n,mediaTypeDetails:{mediaType:u,type:"regular"},directPath:a,fileEncSha256:i,fileSha256:l,mediaKey:s});return c.success?o("WAResultOrError").makeResult({mimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType(u),plaintext:c.value,serverMediaType:u}):c},I=o("WAPromiseManagement").cacheWhilePending(function(e){var t=e.hash;return t},function(t){var n=t.hash,r=babelHelpers.objectWithoutPropertiesLoose(t,e),a=o("WAPrepareMediaDownload").prepareMediaDownload({hash:n,mediaDownloadFlow:r.downloadMediaMetric,mediaEntry:r.mediaEntry,logger:S}),i=a.logDownloadResult;return i(k(r))});async function T(e){var t=e.abortSignal,n=e.directPath,r=e.downloadFlow,a=e.fileEncSha256,i=e.fileSha256,l=e.mediaKey,s=e.mediaTypeDetails,u=o("WAHashUtils").toPlaintextHash(i),c=await o("WADownloadAndDecryptMedia").downloadAndDecryptMedia({abortSignal:t,directPath:n,eventFlow:r,fileEncSha256:a,mediaKey:l,mediaTypeDetails:s,plaintextHash:u});if(c.success===!1){var d=c.error;switch(d){case"signature-expired":case"media-not-found":return o("WAResultOrError").makeError(d);case"enc-hash-mismatch":return S.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia: enc-hash-mismatch"]))),o("WAResultOrError").makeError(d);default:return o("WAResultOrError").makeError(d)}}else{var m=c.value;return o("WAResultOrError").makeResult(m)}}function D(e){var t=e.downloadEntry,n=e.handleMediaPreviewBeforeDownload,r=e.handleMediaPreviewDownloadFailed,a=e.hash,i=e.mediaEntry,l=e.progressiveJpegDetails,s=e.protocolMsgId,u=e.serverMediaType,c=e.triggerUIView;return l==null?o("WADownloadDownloadablePreview").maybeDownloadDownloadablePreview(s,a,u,i,t,{handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:r},c):o("WADownloadProgressiveJpegPreview").maybeDownloadProgressiveJpegPreview({protocolMsgId:s,hash:a,serverMediaType:u,mediaEntry:i,progressiveJpegDetails:l,handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:r,downloadEntry:t,triggerUIView:c}).then(function(e){return e.success!==!0?o("WADownloadDownloadablePreview").maybeDownloadDownloadablePreview(s,a,u,i,t,{handleMediaPreviewBeforeDownload:n,handleMediaPreviewDownloadFailed:r},c):e})}async function x(e){var t=e.directPath,n=e.downloadFlow,r=e.fileEncSha256,a=e.fileSha256,i=e.handleMediaPreviewBeforeDownload,l=e.handleMediaPreviewBlob,s=e.handleMediaPreviewDownloadFailed,u=e.hash,c=e.mediaKey,d=e.progressiveJpegDetails,m=e.serverMediaType,p=S.TAGS(["MediaStreaming"]);p.LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Using Media Streaming to download ProgressiveJpeg. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("media_streaming_start");var R=o("WADownloadProgressiveJpegPreview").getPreviewTargetScan(d.scanLengths)-1;p.LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Targeting scanIndex "," for preview. PlaintextHash: ",""])),R,o("WAHashUtils").sanitisePlaintextHash(u)),n.addAnnotations({int:{scans:d.scanLengths.length}}),i(u);var L=await o("WADownloadProgressiveJpegPlaintextStreamer").downloadProgressiveJpegPlaintextUsingStreams({directPath:t,eventFlow:n,fileEncSha256:r,mediaKey:c,progressiveJpegDetails:d,serverMediaType:m});if(L.success===!1)return n.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:L.error}}),s(u,L.error),L;n.addPoint("download_pjpeg_preview_start");var E=[],k=0;try{var I=!1,T=!1,D;try{for(var x=babelHelpers.asyncIterator(o("WAStreamAsyncIterator").streamAsyncIterator(L.value)),$;I=!($=await x.next()).done;I=!1){var P=$.value;{if(P==null)continue;if(p.LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Processing scan "," for plaintextHash ",""])),k,o("WAHashUtils").sanitisePlaintextHash(u)),E.push(P),k===R){n.addPoint("media_streaming_preview_processed"),p.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Handling preview from scan "," for plaintextHash ",""])),k,o("WAHashUtils").sanitisePlaintextHash(u));var N=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(E,[o("WAProgressiveJpegAddJPEGTrailingTag").JPEG_TRAILING_TAG])));l(N),n.addPoint("download_pjpeg_preview_end")}k++}}}catch(e){T=!0,D=e}finally{try{I&&x.return!=null&&await x.return()}finally{if(T)throw D}}k<R&&(p.ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["pjpeg stream ended before reaching previewTargetScanIndex for plaintextHash ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("download_pjpeg_preview_fail"));var M=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(E))),w=await o("WACryptoSha256").sha256(M);return o("WACryptoUtils").arrayBuffersEqual(a,w)?(p.LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download successful. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("media_streaming_end"),o("WAResultOrError").makeResult(M)):(p.WARN(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download failed due to plaintext hash mismatch. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(u)),n.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:"hash-mismatch"}}),o("WAResultOrError").makeError("hash-mismatch"))}catch(e){return p.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Exception occurred during Media Streaming: Reason: ",""])),e),k<R&&(n.addPoint("download_pjpeg_preview_fail"),s(u,o("WAErrorMessage").maybeGetMessageFromError(e))),n==null||n.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:o("WAErrorMessage").maybeGetMessageFromError(e)}}),o("WAResultOrError").makeError("stream-error")}}l.mediaDownloadLogger=S,l.downloadMedia=R,l.downloadFullMediaOnly=k,l.cachedDownloadFullMediaOnly=I,l.downloadMediaImpl=T}),98);
__d("WADownloadProgressiveJpegPlaintext",["WADownloadCiphertext","WAMediaCrypto","WAProgressiveJpegAddJPEGTrailingTag","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("WATagsLogger").TAGS(["DownloadProgressiveJpeg"]);async function d(e){var t=e.abortSignal,n=e.directPath,r=e.eventFlow,a=e.fileEncSha256,i=e.mediaKey,l=e.mediaTypeDetails,s=e.plaintextHash,u=e.progressiveJpegDetails,c=e.size,d=e.targetScan,_=o("WAProgressiveJpegGetPJpegDetails").getExtendedProgressiveJpegDetails({progressiveJpegDetails:u,ciphertextLength:p(c)}),f=o("WAProgressiveJpegGetPJpegDetails").getTotalByteSizeForScan(_.alignedScanLengths,d),g=await o("WADownloadCiphertext").cachedDownloadCiphertext({abortSignal:t,mediaTypeDetails:l,fileEncSha256:a,directPath:n,fromBytes:0,toBytes:f-1,eventFlow:r,plaintextHash:s});return g.success!==!0?g:m(i,l,d,_,g.value)}async function m(t,n,r,a,i){c.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Using progressiveJpeg decryptAndVerify"])));var l=new Uint8Array(i),d;n.type==="preview"?d=o("WAMediaCrypto").computeMediaKeysForPreview(t):d=o("WAMediaCrypto").computeMediaKeys(t,n.mediaType);var m=await d.then(function(e){var t=e.cipherKey,n=e.hmacKey,i=e.iv;return o("WAMediaCrypto").decryptPartialChunks(t,i,l,n,r,a)}).then(o("WAResultOrError").makeResult).catch(function(e){return c.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Error ",""])),e),e instanceof o("WAMediaCrypto").HmacValidationError?o("WAResultOrError").makeError("enc-hash-mismatch"):o("WAResultOrError").makeError("decryption-error")});if(!m.success)return m;c.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["ProgressiveJpeg download and decrypt successful. Partial: ",""])),r<a.scanLengths.length);var p=o("WAProgressiveJpegAddJPEGTrailingTag").addJPEGTrailingTag(m.value.plaintext);return o("WAResultOrError").makeResult(p)}function p(e){if(e==null)return null;var t=o("WAMediaCrypto").CBC_BLOCK_SIZE-e%o("WAMediaCrypto").CBC_BLOCK_SIZE;return e+t+o("WAMediaCrypto").HMAC_LENGTH}l.downloadProgressiveJpegPlaintext=d}),98);
__d("WALoggerTag",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum").Mirrored(["CryptoManager","MediaPreview","PrekeyGenerateAndUpload","SignedPrekey","SignedPrekeyRotation","OneTimePrekey"]),l=e;i.default=l}),66);
__d("WAProgressiveJpegGetTargetScanLengthForBytes",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){for(var n=0,r=0,o=0;o<e.length&&(r=o+1,n+=e[o],!(n>=t));o++);return r}i.getTargetScanBasedOnByteSize=e}),66);
__d("WADownloadProgressiveJpegPreview",["WADownloadMedia","WADownloadProgressiveJpegPlaintext","WAGlobals","WALoggerTag","WAProgressiveJpegGetTargetScanLengthForBytes","WAResultOrError","WAStartMediaDownloadQplFlow"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WADownloadMedia").mediaDownloadLogger.TAGS([r("WALoggerTag").MediaPreview]),c=3;async function d(t){var n=t.downloadEntry,r=t.handleMediaPreviewBeforeDownload,a=t.handleMediaPreviewDownloadFailed,i=t.hash,l=t.mediaEntry,c=t.progressiveJpegDetails,d=t.protocolMsgId,p=t.serverMediaType,_=t.triggerUIView,f=l.directPath,g=l.fileEncSha256,h=l.mediaKey,y=l.size;if(f==null||g==null||h==null)return o("WAResultOrError").makeError("pjpeg-failed");var C=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:d,downloadEntry:n,isPreview:!0,msgType:null,triggerUIView:_});C.addAnnotations({bool:{isProgressiveJpeg:!0},string:{mediaType:"preview",fullSizeMediaType:l.serverMediaType},int:{mediaEntrySize:l.size}}),u.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Starting progressiveJpeg preview download"]))),C.addPoint("wa_protocol_media_download_start");var b=o("WAGlobals").getConfig().pjpegPreviewAvoidLastScan()===!0?c.scanLengths.length-1:c.scanLengths.length,v=Math.min(m(c.scanLengths,y),b);await r(i);var S=await o("WADownloadProgressiveJpegPlaintext").downloadProgressiveJpegPlaintext({directPath:f,eventFlow:C,fileEncSha256:g,mediaKey:h,mediaTypeDetails:{mediaType:p,type:"regular"},progressiveJpegDetails:c,plaintextHash:i,targetScan:v,size:y});if(!S.success)return a(i,S.error),C.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:S.error}}),o("WAResultOrError").makeError("pjpeg-failed");var R=S.value;return u.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Finished progressiveJpeg preview download"]))),C.addPoint("wa_protocol_media_download_end"),C.endSuccess(),o("WAResultOrError").makeResult(R)}function m(e,t){var n=o("WAGlobals").getConfig().jpegThumbnailTargetByteSizeKB()*1024,r=o("WAProgressiveJpegGetTargetScanLengthForBytes").getTargetScanBasedOnByteSize(e,n);return(t==null||t===0)&&(r=Math.min(r,e.length-1)),r=Math.max(r,c),r}function p(e){var t=e.abortSignal,n=e.hash,r=e.mediaDownloadFlow,a=e.mediaEntry,i=e.progressiveJpegDetails,l=e.serverMediaType,s=a.directPath,u=a.fileEncSha256,c=a.mediaKey,d=a.size,p=o("WAGlobals").getConfig().pjpegPreviewAvoidLastScan()===!0?i.scanLengths.length-1:i.scanLengths.length,_=Math.min(m(i.scanLengths,d),p);return o("WADownloadProgressiveJpegPlaintext").downloadProgressiveJpegPlaintext({abortSignal:t,directPath:s,fileEncSha256:u,mediaKey:c,mediaTypeDetails:{mediaType:l,type:"regular"},progressiveJpegDetails:i,plaintextHash:n,targetScan:_,size:d,eventFlow:r})}l.maybeDownloadProgressiveJpegPreview=d,l.getPreviewTargetScan=m,l.maybeDownloadProgressiveJpegPreviewV2=p}),98);
__d("WAFindMostRecentMediaEntry",["WAMediaUtils","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=null;for(var n of e){var r,a,i=n[0],l=n[1],s=o("WAMediaUtils").decodeMediaEntryData(l);(((r=t)==null?void 0:r[1].mediaKeyTimestamp)==null||s.mediaKeyTimestamp!=null&&s.mediaKeyTimestamp>((a=t)==null?void 0:a[1].mediaKeyTimestamp))&&(t=[i,s])}return t!=null?o("WAResultOrError").makeResult(t):o("WAResultOrError").makeError("no-media-entry")}l.findMostRecentMediaEntry=e}),98);
__d("WAGetKaleidoscopeWasm",["WAWasmModuleCache","bx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("bx").getURL(r("bx")("33861")),s=function(){return o("WAWasmModuleCache").loadWasmModule(e)};l.getKaleidoscopeWasm=s}),98);
__d("WAMediaUtilsWasmUrl",["bx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("bx").getURL(r("bx")("237"));l.WAMediaUtilsWasmUrl=e}),98);
__d("WAPreloadWamediaUtilsWasm",["WAMediaUtilsWasmUrl","WAWasmModuleCache"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){o("WAWasmModuleCache").loadWasmModule(o("WAMediaUtilsWasmUrl").WAMediaUtilsWasmUrl)};l.preloadWamediaUtilsWasm=e}),98);
__d("WAPreloadWebpCheckWasm",["WAWasmModuleCache","bx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("bx").getURL(r("bx")("6946")),s=function(){o("WAWasmModuleCache").loadWasmModule(e)};l.preloadWebpCheckWasm=s}),98);
__d("WAPrewarmMediaValidate",["WAGetKaleidoscopeWasm","WALogger","WAPreloadWamediaUtilsWasm","WAPreloadWebpCheckWasm","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){if(r("gkx")("3272")){o("WAGetKaleidoscopeWasm").getKaleidoscopeWasm().catch(function(t){var n=r("getErrorSafe")(t);o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["prewarm Kaleidoscop wasm failed with error: ",""])),n.message)});return}if(t==null){o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["prewarmMediaValidate: serverMediaType is null"])));return}(t==="sticker"||t==="image")&&o("WAPreloadWebpCheckWasm").preloadWebpCheckWasm(),(t==="video"||t==="audio")&&o("WAPreloadWamediaUtilsWasm").preloadWamediaUtilsWasm()}l.prewarmMediaValidate=u}),98);
__d("WAMediaManagerPrepareMediaDownload",["Promise","WAErrorMessage","WAGetAgeBucketForMediaKeyTimestamp","WAHashUtils","WAMediaQplHelper","WAPrewarmMediaValidate","WAProgressiveJpegGetPJpegDetails","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=0;function d(t){var r,a=t.hash,i=t.logger,l=t.mediaDownloadFlow,d=t.mediaEntry,m=d.directPath,p=d.downloadableThumbnail,_=d.mediaKeyTimestamp,f=d.serverMediaType,g=d.size;o("WAPrewarmMediaValidate").prewarmMediaValidate(f);var h=o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(_);i.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start download ",". entry: "," mediaKeyTimestampAgeBucket: ",", size: ",", serverMediaType: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),l.downloadEntry,h,g,f);var y=(r=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(d).value)!=null?r:null;return l.addPoint("wa_protocol_media_download_start",{bool:{duplicateDirectPath:(p==null?void 0:p.directPath)===m,hasDownloadableThumbnail:(p==null?void 0:p.directPath)!=null,isProgressiveJpeg:y!=null},string:{mediaKeyTimestampAgeBucket:h,mediaType:f}}),{logDownloadResult:function(t){return c++,l.addAnnotations({int:{concurrentDownloadCount:c}}),t.then(function(e){if(e.success){var t=e.value.validatedResult.validatedPlaintext.byteLength;l.addPoint("wa_protocol_media_download_end",{string:{media_size:o("WAMediaQplHelper").convertIntegerSizeToStringBucket(t)}})}else l.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:e.error}});return e}).catch(function(e){l.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"runtime-error"}});var t=o("WAErrorMessage").maybeGetMessageFromError(e);return i.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media due to runtime-error: ",""])),t),(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("runtime-error"))}).finally(function(){c--})}}}l.mediaManagerPrepareMediaDownload=d}),98);
__d("WAIsMp4",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112}i.isMp4=e}),66);
__d("WAIsWebP",[],(function(t,n,r,o,a,i){"use strict";function e(e){return!(e.length<12||e[0]!==82||e[1]!==73||e[2]!==70||e[3]!==70||e[8]!==87||e[9]!==69||e[10]!==66||e[11]!==80)}i.isWebP=e}),66);
__d("WAKaleidoscopeLogger",["FBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){return r("FBLogger")("wmi").tags(["Kaleidoscope"])};l.ksLogger=e}),98);
__d("WAKaleidoscopeCheck",["WAGetKaleidoscopeWasm","WAKaleidoscopeLogger","WAResultOrError","WASI","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_="input",f="output",g="/"+_,h="/"+f;function y(e){var t,n=e.input,r=e.mediaType,o=e.rawMimeType,a=e.stderr,i=e.stdout;return{args:["kaleidoscope","check","--json-report="+f,"--mimetype-hint="+o,_],fs:(t={},t[g]={path:g,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"binary",content:new Uint8Array(n)},t[h]={path:h,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"string",content:""},t),stdout:i,stderr:a,moduleName:"WAKaleidoscopeCheck_CLI"}}function C(t){var n=t.getWasmModule;return async function(a){var t,i,l,_,f=a.input,g=a.mediaType,C=a.rawMimeType,b=o("WASI").createWasi(y({input:f,rawMimeType:C,mediaType:g,stderr:function(n){o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n)},stdout:function(t){o("WAKaleidoscopeLogger").ksLogger().DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",""])),t)}})),v=b.getImportObject,S=b.start,R=await n(),L=await WebAssembly.instantiate(R,v()),E=S(L),k=E.exitCode,I=E.fs;if(k!==0)return o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed with exit code ",""])),k),o("WAResultOrError").makeError("wasm-runtime-error");var T=(t=I[h])==null?void 0:t.content;if(typeof T!="string")return o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed invalid result type"]))),o("WAResultOrError").makeError("wasm-result-not-json");var D={};try{D=JSON.parse(T)}catch(e){return o("WAKaleidoscopeLogger").ksLogger().catching(r("getErrorSafe")(e)).MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed to parse JSON"]))),o("WAResultOrError").makeError("wasm-invalid-json")}return typeof((i=D)==null?void 0:i.score)!="number"?(o("WAKaleidoscopeLogger").ksLogger().MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck score is null"]))),o("WAResultOrError").makeError("wasm-invalid-json")):(o("WAKaleidoscopeLogger").ksLogger().DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck called with rawMimeType: ",", mediaType: ",""])),C,g),o("WAResultOrError").makeResult({mimetype:((l=D)==null?void 0:l.mimetype)||"application/octet-stream",extension:((_=D)==null?void 0:_.extension)||null,score:D.score}))}}var b=C({getWasmModule:o("WAGetKaleidoscopeWasm").getKaleidoscopeWasm});l.kaleidoscopeCheck=b}),98);
__d("WAMp4Check",["WAMediaUtilsWasmUrl","WAResultOrError","WASI","WAWasmModuleCache"],(function(t,n,r,o,a,i,l){"use strict";var e="input",s="output",u="/"+e,c="/"+s;function d(t){var n,r=t.input,o=t.stderr,a=t.stdout;return{args:["wamediautil","mp4check","--error-tolerance=2","--json-report="+s,e],fs:(n={},n[u]={path:u,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"binary",content:new Uint8Array(r)},n[c]={path:c,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"string",content:""},n),stdout:a,stderr:o,moduleName:"WAMp4Check_CLI"}}function m(e){var t=e.getWasmModule,n=e.logError,r=e.logMessage;return async function(a){var e,i,l,s,u,m,p,_,f,g,h,y,C,b=a.input,v=o("WASI").createWasi(d({input:b,stderr:n,stdout:r})),S=v.getImportObject,R=v.start,L=await t(),E=await WebAssembly.instantiate(L,S()),k=R(E),I=k.exitCode,T=k.fs;if(I!==0)return n("mp4Check failed with exit code "+I),o("WAResultOrError").makeError("invalid-media");var D=(e=T[c])==null?void 0:e.content;if(typeof D!="string")return n("mp4check failed invalid result type"),o("WAResultOrError").makeError("runtime-error");var x=(i=JSON.parse(D))!=null?i:{};return o("WAResultOrError").makeResult({videoStreamReport:(x==null?void 0:x.video_stream_report)==null?null:{streamType:(l=x.video_stream_report)==null?void 0:l.stream_type,calculatedFps:(s=x.video_stream_report)==null?void 0:s.calculated_fps,nominalFps:(u=x.video_stream_report)==null?void 0:u.nominal_fps,videoWidth:(m=x.video_stream_report)==null?void 0:m.video_width,videoHeight:(p=x.video_stream_report)==null?void 0:p.video_height,duration:(_=x.video_stream_report)==null?void 0:_.duration,avgBitsPerSecond:(f=x.video_stream_report)==null?void 0:f.avg_bits_per_second},audioStreamReport:(x==null?void 0:x.audio_stream_report)==null?null:{streamType:(g=x.audio_stream_report)==null?void 0:g.stream_type,samplingRate:(h=x.audio_stream_report)==null?void 0:h.sampling_rate,numberOfChannels:(y=x.audio_stream_report)==null?void 0:y.number_of_channels,avgBitsPerSecond:(C=x.audio_stream_report)==null?void 0:C.avg_bits_per_second}})}}var p=function(){return o("WAWasmModuleCache").loadWasmModule(o("WAMediaUtilsWasmUrl").WAMediaUtilsWasmUrl)};l.createMp4Check=m,l.getMp4CheckWasm=p}),98);
__d("WAParseWav",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=new DataView(e);return e.byteLength<44||t.getUint32(0)!==1380533830||t.getUint32(8)!==1463899717?null:e}function l(e){var t=new DataView(e),n=t.getUint16(22,!0),r=t.getUint32(24,!0);return{numChannels:n,sampleRate:r}}i.validateWav=e,i.parseWav=l}),66);
__d("WAWebPCheck",["WAResultOrError","WASI","WAWasmModuleCache","bx"],(function(t,n,r,o,a,i,l){"use strict";var e="input",s="/"+e;function u(t){var n,r=t.input,o=t.stderr,a=t.stdout;return{args:["webpcheck",e],fs:(n={},n[s]={path:s,timestamps:{access:new Date,change:new Date,modification:new Date},mode:"binary",content:new Uint8Array(r)},n),stdout:a,stderr:o,moduleName:"WAWebPCheck_CLI"}}function c(e){var t=e.getWasmModule,n=e.logError,r=e.logMessage;return async function(a){var e=a.input,i=o("WASI").createWasi(u({input:e,stderr:n,stdout:r})),l=i.getImportObject,s=i.start,c=await t(),d=await WebAssembly.instantiate(c,l()),m=s(d),p=m.exitCode;return p!==0?(n("WebPCheck failed with exit code "+p),o("WAResultOrError").makeError("invalid-media")):o("WAResultOrError").makeResult()}}var d=r("bx").getURL(r("bx")("6946")),m=function(){return o("WAWasmModuleCache").loadWasmModule(d)};l.createWebPCheck=c,l.getWebpCheckWasm=m}),98);
__d("WAValidateMedia",["FBLogger","WAIsMp4","WAIsOgg","WAIsWebP","WAKaleidoscopeCheck","WAMp4Check","WAParseWav","WAResultOrError","WAWebPCheck","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=function(){return r("FBLogger")("wmi").tags(["WAValidateMedia"])};function m(t,n){return n.addPoint("media_validation_start"),(r("gkx")("3272")?p(t):_(t)).then(function(e){return e.success?n.addPoint("media_validation_end",{bool:{is_validation_setup_failed:e.value.validationSetupFailed,is_validation_skipped:e.value.skipValidation},string:{validated_mime_type:e.value.mimeType}}):n.addPoint("media_validation_fail",{string:{validationError:e.error}}),e}).catch(function(a){var i=r("getErrorSafe")(a);return d().catching(i).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["validateMedia threw an exception: ",""])),i.message),n.addPoint("media_validation_fail",{string:{validationError:i.message}}),o("WAResultOrError").makeResult({skipValidation:!0,mimeType:null,validatedPlaintext:t,validationSetupFailed:!0})})}async function p(e){var t=await o("WAKaleidoscopeCheck").kaleidoscopeCheck({input:e,rawMimeType:"application/octet-stream",mediaType:"unknown"});if(!t.success)return d().MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["kaleidoscopeCheck failed with error: ",""])),t.error),o("WAResultOrError").makeError("runtime-error");var n=t.value,r=n.mimetype,a=n.score;return a>=80?o("WAResultOrError").makeError("invalid-media"):o("WAResultOrError").makeResult({skipValidation:!1,mimeType:r,validatedPlaintext:e,validationSetupFailed:!1,isKaleidoscopeCheck:!0})}function _(e){var t=new Uint8Array(e);if(o("WAIsWebP").isWebP(t))return h(e);if(o("WAIsMp4").isMp4(t))return y(e);if(o("WAIsOgg").isOgg(t))return Promise.resolve(o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"audio/ogg",validatedPlaintext:e,validationSetupFailed:!1,audioStreamReport:null}));var n=o("WAParseWav").validateWav(e);return n!=null?Promise.resolve(C(n)):Promise.resolve(o("WAResultOrError").makeResult({mimeType:null,skipValidation:!0,validatedPlaintext:e,validationSetupFailed:!1}))}var f=function(t){t!==""&&d().WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["",""])),t)},g=function(t){t!==""&&d().DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",""])),t)};async function h(e){var t=o("WAWebPCheck").createWebPCheck({getWasmModule:o("WAWebPCheck").getWebpCheckWasm,logError:f,logMessage:g}),n=await t({input:e});return n.success?o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"image/webp",validatedPlaintext:e,validationSetupFailed:!1}):n}async function y(e){var t=o("WAMp4Check").createMp4Check({getWasmModule:o("WAMp4Check").getMp4CheckWasm,logError:f,logMessage:g}),n=await t({input:e});if(!n.success)return o("WAResultOrError").makeError(n.error);var r=n.value,a=r.audioStreamReport,i=r.videoStreamReport;return i==null?a==null?o("WAResultOrError").makeError("invalid-media"):o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"audio/mp4",validatedPlaintext:e,validationSetupFailed:!1,audioStreamReport:a}):o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"video/mp4",validatedPlaintext:e,validationSetupFailed:!1,videoStreamReport:i,audioStreamReport:a})}function C(e){var t=o("WAParseWav").parseWav(e),n=t.numChannels,r=t.sampleRate;return o("WAResultOrError").makeResult({skipValidation:!1,mimeType:"audio/wav",validatedPlaintext:e,validationSetupFailed:!1,audioStreamReport:{streamType:"LPCM",samplingRate:r,numberOfChannels:n}})}l.validateMedia=m}),98);
__d("WADownloadFullSizeOnlyTask",["EncryptedBackupsResignCdnUrl","MAWCastToMsgrServerMediaType","MAWEBSwitch","WADownloadMedia","WAFindMostRecentMediaEntry","WAIsMediaExpiredError","WAMediaManagerPrepareMediaDownload","WAMediaUtils","WAResultOrError","WAValidateMedia","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;async function c(e){var t=e.abortSignal,n=e.dbCallbacks,r=e.fullSizePlaintextHash,a=e.logger,i=e.mediaDownloadFlow;i.addPoint("get_media_entries_start");var l=await n.getMediaEntries(r);if(!l.success)return i.addPoint("get_media_entries_fail"),{fullsizePromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};var s=l.value;i.addPoint("get_media_entries_end");var u=o("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(s);if(!u.success)return{fullsizePromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};var c=u.value,m=c[0],p=c[1],_=o("WAMediaUtils").validateDecodedMediaEntryForDownload(p);if(!_.success)return{fullsizePromise:Promise.resolve(_)};var f=_.value,g=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:r,logger:a,mediaDownloadFlow:i,mediaEntry:f}),h=g.logDownloadResult,y=d({abortSignal:t,dbCallbacks:n,logger:a,mediaDownloadFlow:i,mediaEntries:s,msgIdOfRecentMediaEntry:m,recentMediaEntry:f}).then(async function(e){if(!e.success)return e;var t=await o("WAValidateMedia").validateMedia(e.value.plaintext,i);return t.success?o("WAResultOrError").makeResult({msgIdAndMediaEntry:[m,f],serverMediaType:e.value.serverMediaType,unvalidatedMimeType:e.value.mimeType,validatedResult:t.value}):t});return{fullsizePromise:h(y)}}async function d(t){var n=t.abortSignal,a=t.dbCallbacks,i=t.logger,l=t.mediaDownloadFlow,c=t.mediaEntries,d=t.msgIdOfRecentMediaEntry,m=t.recentMediaEntry,p=r("MAWEBSwitch").isEnabled()&&r("gkx")("23960");p&&l.addPoint("forcing_eb_download");var _=p?o("WAResultOrError").makeError("signature-expired"):await o("WADownloadMedia").downloadFullMediaOnly({abortSignal:n,downloadMediaMetric:l,mediaEntry:m});if(_.success||!o("WAIsMediaExpiredError").isMediaExpiredError(_.error)||!r("MAWEBSwitch").isEnabled())return _;var f=await a.getProtocolMsgIdAndSortOrderMs(d);if(f==null)return o("WAResultOrError").makeError("missing-sort-order-ms-for-restore");var g=f.protocolMsgId,h=f.sortOrderMs,y=m,C=d,b=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(y.serverMediaType);if(b==null||y.objectId==null)return i.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and can not restore: ",""])),_.error),_;var v=await o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:y.objectId,logger:i,mediaDownloadFlow:l,mediaKey:y.mediaKey,mediaType:b,msgId:C,protocolMsgId:g,sortOrderMs:h});if(!v.success)return i.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and restore failed: ",""])),v.error),v;var S=await o("WADownloadMedia").downloadFullMediaOnly({abortSignal:n,downloadMediaMetric:babelHelpers.extends({},l,{addPoint:function(t,n){l.addPoint("second_"+t,n)}}),mediaEntry:babelHelpers.extends({},y,{directPath:v.value})});return S.success?o("WAResultOrError").makeResult(S.value):(i.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media after restore CDN URL: ",""])),S.error),S)}l.startDownloadFullSizeTask=c,l.downloadOrRestoreFullSize=d}),98);
__d("WADownloadMediaPreviewV2",["WADownloadMedia","WADownloadProgressiveJpegPreview","WAMediaCrypto","WAMediaUtils","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e;async function s(t){var n=t.abortSignal,r=t.hash,a=t.logger,i=t.mediaDownloadFlow,l=t.mediaEntry,s=t.progressiveJpegDetails,u=l.serverMediaType,c=o("WAMediaUtils").getMimeTypeFromServerMediaType(u),d=s==null?o("WAResultOrError").makeError("jpeg-stream-not-supported"):await o("WADownloadProgressiveJpegPreview").maybeDownloadProgressiveJpegPreviewV2({abortSignal:n,hash:r,serverMediaType:u,mediaEntry:l,progressiveJpegDetails:s,mediaDownloadFlow:i});if(d.success===!0)return o("WAResultOrError").makeResult({plaintext:d.value,mimeType:c,serverMediaType:u});i.addPoint("fallback_to_downloadable_thumbnail");var m=l.downloadableThumbnail;if((m==null?void 0:m.directPath)==null)return o("WAResultOrError").makeError("media-not-found");var p=o("WAMediaUtils").validateDownloadableThumbnailForDownload(m);if(p.success===!1)return a.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["preview mediaEntry is incomplete: ",""])),p.error),o("WAResultOrError").makeError(p.error[0]);var _=p.value,f=_.directPath,g=_.fileEncSha256,h=_.fileSha256,y=_.mediaKey,C=o("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(u);if(C==null)return o("WAResultOrError").makeError("request-error");var b=await o("WADownloadMedia").downloadMediaImpl({abortSignal:n,downloadFlow:i,mediaTypeDetails:{messageType:C,type:"preview"},directPath:f,fileEncSha256:g,fileSha256:h,mediaKey:y});return b.success===!1?b:o("WAResultOrError").makeResult({plaintext:b.value,mimeType:c,serverMediaType:u})}l.downloadMediaPreview=s}),98);
__d("WAIsPreviewSupported",["$InternalEnum","WAProgressiveJpegGetPJpegDetails"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum").Mirrored(["NO","YES"]),s=n("$InternalEnum").Mirrored(["NO","YES","DuplicatedWithFullSize"]);function u(t){var n=t.serverMediaType;switch(n){case"image":{var r,a,i=(r=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(t).value)!=null?r:null,l=i!=null?e.YES:e.NO;if(((a=t.downloadableThumbnail)==null?void 0:a.directPath)==null)return[l,s.NO];t.downloadableThumbnail.directPath;var u=t.downloadableThumbnail.directPath===t.directPath?s.DuplicatedWithFullSize:s.YES;return[l,u]}case"video":{var c;if(((c=t.downloadableThumbnail)==null?void 0:c.directPath)==null)return[e.NO,s.NO];t.downloadableThumbnail.directPath;var d=t.downloadableThumbnail.directPath===t.directPath?s.NO:s.YES;return[e.NO,d]}case"sticker":case"ptt":case"audio":case"document":case"gif":case"ppic":case"md-app-state":case"md-msg-hist":case"kyc-id":case"template":case"thumbnail-image":case"thumbnail-video":case"thumbnail-gif":case"thumbnail-document":case"thumbnail-link":case"novi-video":case"novi-image":case"payment-bg-image":case"xma-image":case"biz-cover-photo":case"preview":case"newsletter-audio":case"newsletter-document":case"newsletter-image":case"newsletter-gif":case"newsletter-music-artwork":case"newsletter-ptt":case"newsletter-sticker":case"newsletter-sticker-pack":case"newsletter-thumbnail-link":case"newsletter-video":case"newsletter-ptv":case"sticker-pack":case"thumbnail-sticker-pack":case"music-artwork":case"group-history":case"ads-image":case"ads-video":case"ptv":return[e.NO,s.NO];default:return[e.NO,s.NO]}}l.PjpegPreviewSupport=e,l.DownloadablePreviewSupport=s,l.checkPreviewSupport=u}),98);
__d("WADownloadPreviewOnlyTask",["EncryptedBackupsResignCdnUrl","MAWEBSwitch","WADownloadMediaPreviewV2","WAFindMostRecentMediaEntry","WAIsMediaExpiredError","WAIsPreviewSupported","WAMediaManagerPrepareMediaDownload","WAMediaUtils","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WAValidateMedia","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s;async function u(e){var t=e.abortSignal,n=e.dbCallbacks,r=e.fullSizePlaintextHash,a=e.logger,i=e.mediaDownloadFlow;i.addPoint("get_media_entries_start");var l=await n.getMediaEntries(r);if(!l.success)return i.addPoint("get_media_entries_fail"),{previewPromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};i.addPoint("get_media_entries_end");var s=l.value,u=o("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(s);if(!u.success)return{previewPromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};var d=u.value,m=d[0],p=d[1],_=o("WAMediaUtils").validateDecodedMediaEntryForDownload(p);if(!_.success)return{previewPromise:Promise.resolve(_)};var f=_.value,g=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:r,logger:a,mediaDownloadFlow:i,mediaEntry:f}),h=g.logDownloadResult,y=c({abortSignal:t,dbCallbacks:n,fullSizePlaintextHash:r,logger:a,mediaDownloadFlow:i,mediaEntries:l.value,msgIdOfRecentMediaEntry:m,recentMediaEntry:f}).then(async function(e){if(!e.success)return e;var t=await o("WAValidateMedia").validateMedia(e.value.plaintext,i);return t.success?o("WAResultOrError").makeResult({msgIdAndMediaEntry:[m,f],serverMediaType:e.value.serverMediaType,unvalidatedMimeType:e.value.mimeType,validatedResult:t.value}):t});return{previewPromise:h(y)}}async function c(t){var n,a=t.abortSignal,i=t.dbCallbacks,l=t.fullSizePlaintextHash,u=t.logger,c=t.mediaDownloadFlow,d=t.mediaEntries,m=t.msgIdOfRecentMediaEntry,p=t.recentMediaEntry,_=r("MAWEBSwitch").isEnabled()&&r("gkx")("23960");_&&c.addPoint("forcing_eb_download");var f=o("WAIsPreviewSupported").checkPreviewSupport(p),g=f[0],h=f[1];if(g===o("WAIsPreviewSupported").PjpegPreviewSupport.NO&&h===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO)return o("WAResultOrError").makeError("preview-not-supported");var y=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(p),C=y.success===!0?y.value:null,b={abortSignal:a,hash:l,logger:u,mediaDownloadFlow:c,progressiveJpegDetails:C};c.addPoint("download_preview_start",{string:{preview_downloadable_support:h,preview_pjpeg_support:g}});var v=_?o("WAResultOrError").makeError("signature-expired"):await o("WADownloadMediaPreviewV2").downloadMediaPreview(babelHelpers.extends({},b,{mediaEntry:p}));if(v.success)return c.addPoint("download_preview_end"),o("WAResultOrError").makeResult({mimeType:v.value.mimeType,plaintext:v.value.plaintext,serverMediaType:v.value.serverMediaType});if(c.addPoint("download_preview_fail"),!o("WAIsMediaExpiredError").isMediaExpiredError(v.error)||!r("MAWEBSwitch").isEnabled()||r("gkx")("1327")!==!0)return v;var S=await i.getProtocolMsgIdAndSortOrderMs(m);if(S==null)return o("WAResultOrError").makeError("missing-sort-order-ms-for-restore");var R=S.protocolMsgId,L=S.sortOrderMs,E=p,k=m,I=h===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO||((n=E.downloadableThumbnail)==null?void 0:n.objectId)==null?null:o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:E.downloadableThumbnail.objectId,logger:u,mediaDownloadFlow:c,mediaKey:E.mediaKey,mediaType:"preview",msgId:k,protocolMsgId:R,sortOrderMs:L}),T=g===o("WAIsPreviewSupported").PjpegPreviewSupport.NO||E.objectId==null?null:o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:E.objectId,logger:u,mediaDownloadFlow:c,mediaKey:E.mediaKey,mediaType:"image",msgId:k,protocolMsgId:R,sortOrderMs:L}),D=await Promise.all([I,T]),x=D[0],$=D[1];if((x==null?void 0:x.success)!==!0&&($==null?void 0:$.success)!==!0){var P;return u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and restore failed. downloadableThumbnail error: ",". pjpegPreview error: ",""])),x==null?void 0:x.error,$==null?void 0:$.error),(P=$!=null?$:x)!=null?P:o("WAResultOrError").makeError("preview-not-supported")}c.addPoint("second_download_preview_start");var N=await o("WADownloadMediaPreviewV2").downloadMediaPreview(babelHelpers.extends({},b,{mediaDownloadFlow:babelHelpers.extends({},c,{addPoint:function(t,n){c.addPoint("second_"+t,n)}}),mediaEntry:babelHelpers.extends({},E,{directPath:($==null?void 0:$.success)===!0?$.value:E.directPath,downloadableThumbnail:E.downloadableThumbnail==null?null:babelHelpers.extends({},E.downloadableThumbnail,{directPath:(x==null?void 0:x.success)===!0?x.value:E.downloadableThumbnail.directPath})})}));return N.success?(c.addPoint("second_download_preview_end"),o("WAResultOrError").makeResult({mimeType:N.value.mimeType,plaintext:N.value.plaintext,serverMediaType:N.value.serverMediaType})):(u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media after restore CDN URL: ",""])),N.error),c.addPoint("second_download_preview_fail"),N)}l.startDownloadPreviewTask=u,l.downloadOrRestorePreviewOnly=c}),98);
__d("WADownloadProgressiveJpegUsingMediaStreaming",["WAByteArray","WACryptoSha256","WACryptoUtils","WADownloadProgressiveJpegPlaintextStreamer","WADownloadProgressiveJpegPreview","WAErrorMessage","WAMediaUtils","WAProgressiveJpegAddJPEGTrailingTag","WAResolvable","WAResultOrError","WAStreamAsyncIterator","WATypedArraysConcat"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;async function f(t){var n=t.abortSignal,r=t.directPath,a=t.downloadFlow,i=t.fileEncSha256,l=t.fileSha256,m=t.logger,p=t.mediaKey,_=t.progressiveJpegDetails,f=t.serverMediaType,h=m.TAGS(["MediaStreaming"]);h.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Using Media Streaming to download ProgressiveJpeg."]))),a.addPoint("create_pjpeg_stream_start");var y=await o("WADownloadProgressiveJpegPlaintextStreamer").downloadProgressiveJpegPlaintextUsingStreams({abortSignal:n,directPath:r,eventFlow:a,fileEncSha256:i,mediaKey:p,progressiveJpegDetails:_,serverMediaType:f}).catch(function(e){return h.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["create DownloadAndDecryptPJpegStream unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")});if(y.success===!1)return a.addPoint("create_pjpeg_stream_fail"),y;a.addPoint("create_pjpeg_stream_end");var C=new(o("WAResolvable")).Resolvable,b=!1,v=g({downloadFlow:a,fileSha256:l,mediaStreamingLogger:h,previewResolvable:C,progressiveJpegDetails:_,progressiveJpegDownloadStream:y.value,serverMediaType:f}).then(function(e){return b=!0,h.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["handleProgressiveJpegDownloadStream completed"]))),e}).catch(function(e){return b=!0,h.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["handleProgressiveJpegDownloadStream unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),C.reject(e),o("WAResultOrError").makeError("runtime-error")}),S=o("WAMediaUtils").getMimeTypeFromServerMediaType(f);function R(e){return e.success===!1?e:o("WAResultOrError").makeResult({mimeType:S,plaintext:e.value,serverMediaType:f})}var L=v.then(R),E=C.promise.then(R),k=await C.promise;if(k.success===!0&&b===!0&&h.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["fullsizeResolvable is settled before previewResolvable"]))),k.success===!0)return o("WAResultOrError").makeResult({fullsizePromise:L,previewPromise:E});var I=await v;return k.success,I.success===!0?o("WAResultOrError").makeResult({fullsizePromise:L,previewPromise:E}):(I.success,I)}async function g(e){var t=e.downloadFlow,n=e.fileSha256,r=e.mediaStreamingLogger,a=e.previewResolvable,i=e.progressiveJpegDetails,l=e.progressiveJpegDownloadStream;t.addPoint("download_pjpeg_preview_start");var s=0,u=o("WADownloadProgressiveJpegPreview").getPreviewTargetScan(i.scanLengths)-1;try{var c=[],d=!1,f=!1,g;try{for(var h=babelHelpers.asyncIterator(o("WAStreamAsyncIterator").streamAsyncIterator(l)),y;d=!(y=await h.next()).done;d=!1){var C=y.value;{if(C==null)continue;if(c.push(C),s===u){t.addPoint("media_streaming_preview_processed");var b=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(c,[o("WAProgressiveJpegAddJPEGTrailingTag").JPEG_TRAILING_TAG])));a.resolve(o("WAResultOrError").makeResult(b)),t.addPoint("download_pjpeg_preview_end")}s++}}}catch(e){f=!0,g=e}finally{try{d&&h.return!=null&&await h.return()}finally{if(f)throw g}}a.isSettled===!1&&(r.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["pjpeg stream ended before reaching previewTargetScanIndex"]))),a.resolve(o("WAResultOrError").makeError("runtime-error")),t.addPoint("download_pjpeg_preview_fail"));var v=o("WAByteArray").uint8ArrayToBuffer(o("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(c))),S=await o("WACryptoSha256").sha256(v);return o("WACryptoUtils").arrayBuffersEqual(n,S)?o("WAResultOrError").makeResult(v):(r.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download failed due to plaintext hash mismatch."]))),o("WAResultOrError").makeError("hash-mismatch"))}catch(e){return r.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Exception occurred during Media Streaming: Reason: ",""])),e),a.isSettled===!1&&(a.resolve(o("WAResultOrError").makeError("runtime-error")),t.addPoint("download_pjpeg_preview_fail")),o("WAResultOrError").makeError("runtime-error")}}l.downloadProgresiveJpegUsingMediaStreaming=f}),98);
__d("WADownloadFullSizeAndPreviewTask",["EncryptedBackupsResignCdnUrl","MAWCastToMsgrServerMediaType","MAWEBSwitch","UserAgent","WADownloadFullSizeOnlyTask","WADownloadPreviewOnlyTask","WADownloadProgressiveJpegUsingMediaStreaming","WAErrorMessage","WAFindMostRecentMediaEntry","WAHashUtils","WAIsMediaExpiredError","WAIsPreviewSupported","WAMediaManagerPrepareMediaDownload","WAMediaUtils","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WAStartMediaDownloadQplFlow","WAValidateMedia","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h;async function y(t){var n=t.abortSignal,r=t.dbCallbacks,a=t.fullSizePlaintextHash,i=t.logger,l=t.mediaDownloadFlow;l.addPoint("get_media_entries_start");var c=await r.getMediaEntries(a);if(!c.success)return l.addPoint("get_media_entries_fail"),{fullsizePromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry")),previewPromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};l.addPoint("get_media_entries_end");var d=c.value,m=o("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(d);if(!m.success)return{fullsizePromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry")),previewPromise:Promise.resolve(o("WAResultOrError").makeError("missing-media-entry"))};var p=m.value,_=p[0],f=p[1],g=o("WAMediaUtils").validateDecodedMediaEntryForDownload(f);return g.success?b({abortSignal:n,dbCallbacks:r,fullSizePlaintextHash:a,logger:i,mediaDownloadFlow:l,mediaEntries:d,msgIdOfRecentMediaEntry:_,recentMediaEntry:g.value}).then(function(e){return i.DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["outter promise: ",""])),e.success===!0?"success":e.error),e.success?e.value:(i.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["outter promise failed: ",""])),e.error),{fullsizePromise:Promise.resolve(e),previewPromise:Promise.resolve(e)})}):(i.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaEntry for download: ",""])),g.error),{fullsizePromise:Promise.resolve(g),previewPromise:Promise.resolve(g)})}async function C(e,t,n){var r=await e;if(!r.success)return Promise.resolve(r);var a=await o("WAValidateMedia").validateMedia(r.value.plaintext,n);return a.success?o("WAResultOrError").makeResult({msgIdAndMediaEntry:t,serverMediaType:r.value.serverMediaType,unvalidatedMimeType:r.value.mimeType,validatedResult:a.value}):a}async function b(e){var t=e.abortSignal,n=e.dbCallbacks,r=e.fullSizePlaintextHash,a=e.logger,i=e.mediaDownloadFlow,l=e.mediaEntries,s=e.msgIdOfRecentMediaEntry,u=e.recentMediaEntry,d=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:r,logger:a,mediaDownloadFlow:i,mediaEntry:u}),m=d.logDownloadResult,p={abortSignal:t,dbCallbacks:n,logger:a,mediaDownloadFlow:i,mediaEntries:l,msgIdOfRecentMediaEntry:s,recentMediaEntry:u},_=await v(babelHelpers.extends({},p,{fullSizePlaintextHash:r}));if(_.success){var f=_.value,g=f.fullsizePromise,h=f.previewPromise,y=g.then(function(e){return e.success?e:(i.addPoint("fallback_to_non_streaming_download",{string:{streaming_fallback_reason:e.error}}),o("WADownloadFullSizeOnlyTask").downloadOrRestoreFullSize(p))}),b=[s,u];return o("WAResultOrError").makeResult({fullsizePromise:m(C(y,b,i)),previewPromise:C(h,b,i)})}var R=L(_.error);if(!R.shouldFallback)return o("WAResultOrError").makeError(R.error);i.addPoint("fallback_to_non_streaming_download",{string:{streaming_fallback_reason:R.error}}),a.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["fallback to non-streaming download"])));var E=C(o("WADownloadFullSizeOnlyTask").downloadOrRestoreFullSize(p),[s,u],i),k=S(babelHelpers.extends({},p,{fullSizePlaintextHash:r,fullsizePromise:E}));return o("WAResultOrError").makeResult({fullsizePromise:m(E),previewPromise:k})}async function v(e){var t,n=e.abortSignal,a=e.dbCallbacks,i=e.logger,l=e.mediaDownloadFlow,s=e.mediaEntries,u=e.msgIdOfRecentMediaEntry,c=e.recentMediaEntry,g=r("MAWEBSwitch").isEnabled()&&r("gkx")("23960");g&&l.addPoint("forcing_eb_download");var h=c.directPath,y=c.fileEncSha256,C=c.fileSha256,b=c.mediaKey,v=c.serverMediaType,S=(t=o("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(c).value)!=null?t:null;if(S==null||c.serverMediaType!=="image"||!o("WAMediaUtils").isTransformStreamSupported()||r("UserAgent").isBrowser("Safari < 18")||r("UserAgent").isBrowser("Mobile Safari < 18"))return c.serverMediaType==="image"&&S==null&&(i.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["skip pjpeg streaming because pjpeg metadata is null"]))),i.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["media entry: ",""])),c)),o("WAResultOrError").makeError("jpeg-stream-not-supported");l.addPoint("media_streaming_start");var L=g?o("WAResultOrError").makeError("signature-expired"):await o("WADownloadProgressiveJpegUsingMediaStreaming").downloadProgresiveJpegUsingMediaStreaming({abortSignal:n,directPath:h,downloadFlow:l,fileEncSha256:y,fileSha256:C,logger:i,mediaKey:b,progressiveJpegDetails:S,serverMediaType:v}).catch(function(e){return i.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["downloadProgresiveJpegUsingMediaStreaming unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")});if(L.success)return l.addPoint("media_streaming_end"),L;if(!o("WAIsMediaExpiredError").isMediaExpiredError(L.error)||!r("MAWEBSwitch").isEnabled())return R(l,L),L;var E=await a.getProtocolMsgIdAndSortOrderMs(u);if(E==null)return o("WAResultOrError").makeError("missing-sort-order-ms-for-restore");var k=E.protocolMsgId,I=E.sortOrderMs,T=c,D=u,x=T.fileEncSha256,$=T.fileSha256,P=T.mediaKey,N=T.serverMediaType,M=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(N);if(M==null||T.objectId==null)return i.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media and can not restore: ",""])),L.error),L;var w=await o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:T.objectId,logger:i,mediaDownloadFlow:l,mediaKey:T.mediaKey,mediaType:M,msgId:D,protocolMsgId:k,sortOrderMs:I});if(!w.success)return w;l.addPoint("second_media_streaming_start");var A=await o("WADownloadProgressiveJpegUsingMediaStreaming").downloadProgresiveJpegUsingMediaStreaming({abortSignal:n,directPath:w.value,downloadFlow:babelHelpers.extends({},l,{addPoint:function(t,n){l.addPoint("second_"+t,n)}}),fileEncSha256:x,fileSha256:$,logger:i,mediaKey:P,progressiveJpegDetails:S,serverMediaType:N}).catch(function(e){return i.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["downloadProgresiveJpegUsingMediaStreaming unexpected runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")});return A.success?(l.addPoint("second_media_streaming_end"),A):(R(l,A),A)}function S(e){var t=e.abortSignal,n=e.dbCallbacks,r=e.fullSizePlaintextHash,a=e.fullsizePromise,i=e.logger,l=e.mediaDownloadFlow,s=e.mediaEntries,u=e.msgIdOfRecentMediaEntry,c=e.recentMediaEntry,d=c.serverMediaType,m=o("WAIsPreviewSupported").checkPreviewSupport(c),p=m[0],_=m[1];if(p===o("WAIsPreviewSupported").PjpegPreviewSupport.NO&&_===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO)return i.LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["preview not supported"]))),Promise.resolve(o("WAResultOrError").makeError("preview-not-supported"));if(_===o("WAIsPreviewSupported").DownloadablePreviewSupport.DuplicatedWithFullSize)return i.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["preview duplicated with fullsize"]))),a;var f=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:l.downloadEntry,isPreview:!0,msgType:null,protocolMsgId:null,triggerUIView:null}),y=o("WAMediaManagerPrepareMediaDownload").mediaManagerPrepareMediaDownload({hash:r,logger:i,mediaDownloadFlow:f,mediaEntry:c}),b=y.logDownloadResult;f.addAnnotations({bool:{isMediaManager:!0},string:{downloadKind:"fullsizeAndPreview",fullSizeMediaType:d,mediaType:"preview",sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)}});var v=o("WADownloadPreviewOnlyTask").downloadOrRestorePreviewOnly({abortSignal:t,dbCallbacks:n,fullSizePlaintextHash:r,logger:i,mediaDownloadFlow:f,mediaEntries:s,msgIdOfRecentMediaEntry:u,recentMediaEntry:c});return b(C(v,[u,c],f)).then(function(e){return e.success?f.endSuccess():f.endFail(e.error,{string:{failReason:e.error}}),e}).catch(function(e){return f.endFail("runtime-error",{string:{failReason:o("WAErrorMessage").maybeGetMessageFromError(e)}}),o("WAResultOrError").makeError("runtime-error")})}function R(e,t){e.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:o("WAErrorMessage").maybeGetMessageFromError(t.error)}})}function L(e){switch(e){case"runtime-error":case"jpeg-stream-not-supported":return{error:e,shouldFallback:!0};case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return{error:e,shouldFallback:!0};case"missing-media-entry":case"missing-media-entry-for-restore":case"missing-sort-order-ms-for-restore":case"preview-not-supported":return{error:e,shouldFallback:!1};case"derive-primary-key-secret-error":case"derive-access-token-secret-error":case"direct-path-undefined":case"direct-path-corrupted":case"direct-path-empty":case"create-payload-failed":case"resign-cdn-url-request-error":case"resign-cdn-url-runtime-error":case"resign-cdn-url-timeout":case"resign-cdn-url-gql-error":return{error:e,shouldFallback:!1};case"invalid-media":return{error:e,shouldFallback:!1};case"decryption-error":case"enc-hash-mismatch":case"hash-mismatch":case"ciphertext-hash-mismatch":return{error:e,shouldFallback:!0};case"access-expired":case"disconnected":case"backoff":case"body-network-error":case"http-fetch-exception":case"http-fetch-aborted":case"no-host":case"server-timeout":case"unspecified-http-error":case"media-not-found":case"download-throttled":case"request-error":case"max-attempts-exceeded":case"signature-expired":case"media-entry-invalid":return{error:e,shouldFallback:!1};case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":return{error:e,shouldFallback:!1}}}l.startDownloadFullSizeAndPreviewTask=y}),98);
__d("WAMediaManagerLogger",["WAHashUtils","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WATagsLogger").TAGS(["MediaManager"]);function s(t){var n=t.downloadKind,r=t.fullSizePlaintextHash,a=e.TAGS(["download","hash:"+o("WAHashUtils").sanitisePlaintextHash(r),n]);return a}function u(t){var n=t.plaintextHash,r=t.uploadKind,a=e.TAGS(["upload","hash:"+o("WAHashUtils").sanitisePlaintextHash(n),r]);return a}l.baseLogger=e,l.createDownloadLogger=s,l.createUploadLogger=u}),98);
__d("WAMediaManagerTypes",["WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.success?o("WAResultOrError").makeResult({serverMediaType:e.value.serverMediaType,unvalidatedMimeType:e.value.unvalidatedMimeType,validatedResult:e.value.validatedResult}):e}l.transformInternalMediaDownloadResult=e}),98);
__d("WAMediaManagerWorkerScheduler",["WorkerScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return e==null&&(e=o("WorkerScheduler").makeScheduler("MediaManager",{concurrency:16,maxTaskLimit:32,maxThrottleMs:3e4,timeoutMs:6e4})),e}l.mediaManagerWorkerScheduler=s}),98);
__d("WACreateRetrier",["WAComms","WAGetMediaRoute","WAMediaOperationsRetrier","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t){var n=await o("WAGetMediaRoute").getMediaRoute({operation:"upload",serverMediaType:e},t);if(!n.success)return n;var r=n.value,a=r.authToken,i=r.fallbackHost,l=r.selectedHost,s=new(o("WAMediaOperationsRetrier")).MediaOperationsRetrier("upload",{host:{domain:l.domain,class:l.class},fallbackHost:i&&{domain:i.domain,class:i.class},authToken:a,timeElapsed:null},o("WAComms").waitForConnection);return o("WAResultOrError").makeResult(s)}l.createUploadRetrier=e}),98);
__d("WAHttpRegularUploadMedia",["WADirectPath","WALogger","WAResultOrError","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;async function c(t,n){var a;try{a=await fetch(t,{method:"POST",mode:"cors",cache:"no-store",headers:{"Content-Type":"text/plain"},body:new Blob([n])})}catch(t){throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["HttpRegularUploadMedia: fail to initiate fetch ",""])),t),t}var i=a,l=i.status;switch(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Fetch Media HTTP status ",""])),l),l){case 200:return a.json().then(function(e){if(!Object.prototype.hasOwnProperty.call(e,"direct_path"))throw r("err")("direct_path not available in wa upload http response");if(typeof e.direct_path!="string")throw r("err")('directPath: "'+e.direct_path+'" is not a string');if(e.object_id&&typeof e.object_id!="string")throw r("err")('objectId: "'+e.object_id+'" is not a string');if(e.handle&&typeof e.handle!="string")throw r("err")('handle: "'+e.handle+'" is not a string');var t={directPath:o("WADirectPath").unsafeCastToDirectPath(e.direct_path),objectId:e.object_id,handle:e.handle};return o("WAResultOrError").makeResult(t)}).catch(function(e){return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["HttpRegularUploadMedia: fail to parse request body ",""])),e),o("WAResultOrError").makeError("body-network-error")});case 408:return o("WAResultOrError").makeError("server-timeout");case 413:return o("WAResultOrError").makeError("payload-too-large");case 415:return o("WAResultOrError").makeError("invalid-media");case 429:case 507:return o("WAResultOrError").makeError("upload-throttled");default:return l>=400&&l<500?o("WAResultOrError").makeError("request-error"):o("WAResultOrError").makeError("unspecified-http-error")}}l.httpRegularUploadMedia=c}),98);
__d("WAHttpResumeCheck",["WADirectPath","WALogger","WAMediaUtils","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;async function p(t){var n;try{n=await fetch(t,{method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"text/plain"}})}catch(t){throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: fail to initiate fetch ",""])),t),t}var r=n,a=r.status;switch(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: response status ",""])),a),a){case 200:return n.json().then(function(e){var t=e.direct_path,n=e.object_id,r=e.resume;if(r==="complete")return t==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: direct_path is missing"]))),o("WAResultOrError").makeResult({type:"media-not-found"})):n==null?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: object_id is missing"]))),o("WAResultOrError").makeResult({type:"media-not-found"})):o("WAResultOrError").makeResult({type:"media-found",directPath:o("WADirectPath").unsafeCastToDirectPath(t),objectId:o("WAMediaUtils").stringToDeliveryObjectId(n)});var a=parseInt(r,10);return a===0?o("WAResultOrError").makeResult({type:"media-not-found"}):Number.isNaN(a)?(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: resume is NaN: ",""])),r),o("WAResultOrError").makeResult({type:"media-not-found"})):o("WAResultOrError").makeResult({type:"media-partial-found",resumeFromBytes:a})}).catch(function(e){return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: fail to parse request body ",""])),e),o("WAResultOrError").makeError("body-network-error")});case 404:return o("WAResultOrError").makeResult({type:"media-not-found"});case 408:return o("WAResultOrError").makeError("server-timeout");case 429:case 507:return o("WAResultOrError").makeError("upload-throttled");default:return a>=400&&a<500?o("WAResultOrError").makeError("request-error"):o("WAResultOrError").makeError("unspecified-http-error")}}l.httpResumeCheck=p}),98);
__d("WAEncryptAndUploadPlaintext",["WABase64","WAErrorMessage","WAGlobals","WAHttpRegularUploadMedia","WAHttpResumeCheck","WALogger","WAMediaCrypto","WAMediaUrl","WAProgressiveJpegGetPJpegDetails","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;async function f(t){var n=t.fromOffset,r=n===void 0?0:n,a=t.mediaKey,i=t.mediaKeyTimestamp,l=t.mediaUploadFlow,f=t.plaintext,g=t.plaintextHash,h=t.serverMediaType,y=t.uploadRetrier,C=t.uploadToken;l.addPoint("encrypt_and_upload_plaintext_start"),l.addPoint("compute_media_keys_start");var b=h==="preview"?await o("WAMediaCrypto").computeMediaKeysForPreview(a):await o("WAMediaCrypto").computeMediaKeys(a,h),v=b.cipherKey,S=b.hmacKey,R=b.iv;l.addPoint("compute_media_keys_end"),l.addPoint("encrypt_and_hmac_start");var L=await o("WAMediaCrypto").encryptAndHmac(v,R,S,f,h),E=L.ciphertext,k=L.ciphertextHash,I=L.ivCiphertextHmac,T=L.sidecar;l.addPoint("encrypt_and_hmac_end");var D=null;if(h==="image"){l.addPoint("get_progressive_jpeg_details_start");var x=await o("WAProgressiveJpegGetPJpegDetails").getProgressiveJpegDetails(new Uint8Array(f),I,S),$=o("WAProgressiveJpegGetPJpegDetails").isValidProgressiveJpegDetails(x);$.success===!1?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: Created invalid progressiveJpeg details during encrypt and upload: ",""])),$.error),l.addPoint($.error)):$.value===!0&&o("WAGlobals").getConfig().isProgressiveJpegSendEnabled()&&(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: Found valid progressiveJpeg details. Adding to media entry."]))),D=x,l.addPoint("get_progressive_jpeg_details_end"))}var P={fileSha256:o("WABase64").decodeB64UrlSafe(g),fileEncSha256:k,mediaKey:a,mediaKeyTimestamp:i,serverMediaType:h,uploadToken:C,sidecar:T,progressiveJpegDetails:D,size:f.byteLength,filename:void 0,lastDownloadAttemptTimestamp:void 0,directPath:void 0},N,M=await y.run(async function(e,t,n){var a=e.domain,i=r;if(n>0){l.addPoint("network_retry",{int:{network_retry_attempt:n}});try{l.addPoint("resume_check_start");var s=o("WAMediaUrl").buildUploadUrl(h,C,k,a,t,!0),p=await o("WAHttpResumeCheck").httpResumeCheck(s);if(p.success){l.addPoint("resume_check_end");var _=p.value;if(_.type==="media-found")return l.addAnnotations({bool:{existingMediaFound:!0}}),o("WAResultOrError").makeResult(o("WAResultOrError").makeResult({directPath:_.directPath,objectId:null,handle:null}));_.type==="media-partial-found"&&(i=_.resumeFromBytes)}l.addPoint("resume_check_fail",{string:{resume_check_error:p.error}})}catch(e){l.addPoint("resume_check_fail",{string:{resume_check_error:o("WAErrorMessage").maybeGetMessageFromError(e)}}),o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: error during retrier ",""])),e)}}i>0&&i<E.byteLength?(l.addAnnotations({int:{fromOffset:i},bool:{continuedFromOffset:!0}}),N=E.subarray(i)):N=E;var f=o("WAMediaUrl").buildUploadUrl(h,C,k,a,t,!1,i);return o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: start upload media to ",""])),f),l.addPoint("http_upload_start"),o("WAHttpRegularUploadMedia").httpRegularUploadMedia(f,N).then(function(e){if(e.success)return l.addPoint("http_upload_end",{int:{attempt:n}}),o("WAResultOrError").makeResult(e);var t=e.error;switch(l.addPoint("http_upload_fail",{string:{http_upload_error:t}}),o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext error: ",""])),t),t){case"server-timeout":case"unspecified-http-error":return o("WAResultOrError").makeError({progressMade:!0});default:return o("WAResultOrError").makeResult(o("WAResultOrError").makeError(t))}}).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);return l.addPoint("http_upload_fail",{string:{http_upload_error:t}}),o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext error: ",""])),t),o("WAResultOrError").makeError({progressMade:!1})})});if(M==null)return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext given up"]))),o("WAResultOrError").makeError("max-attempts-exceeded");if(M.success===!1)return M;var w=M.value,A=w.directPath,F=w.handle,O=w.objectId,B=babelHelpers.extends({},P,{directPath:A,handle:F,objectId:O});o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: upload success "," ",""])),{directPath:A},{objectId:O});var W="undefined";return O!=null&&(W=O.length>60?"new":"old"),l.addPoint("encrypt_and_upload_plaintext_end",{string:{object_id_type:W}}),o("WAResultOrError").makeResult(B)}l.encryptAndUploadPlaintext=f}),98);
__d("WAUploadMediaQuick",["WACreateRetrier","WAEncryptAndUploadPlaintext","WAMediaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;async function s(t){var n=t.logger,r=t.mediaUploadFlow,a=t.plaintext,i=t.plaintextHash,l=t.serverMediaType;n.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start uploadMediaQuick"]))),r.addPoint("create_upload_retrier_start");var s=await o("WACreateRetrier").createUploadRetrier(l,r);if(!s.success)return r.addPoint("create_upload_retrier_fail"),s;r.addPoint("create_upload_retrier_end"),r.addPoint("create_media_key_start");var u=o("WAMediaUtils").createMediaKey(),c=o("WAMediaUtils").createUploadToken(),d=o("WATimeUtils").unixTime();r.addPoint("create_media_key_end");var m=await o("WAEncryptAndUploadPlaintext").encryptAndUploadPlaintext({mediaKey:u,mediaKeyTimestamp:d,serverMediaType:l,mediaUploadFlow:r,plaintext:a,plaintextHash:i,uploadRetrier:s.value,uploadToken:c});return m}l.uploadMediaQuick=s}),98);
__d("mapWorkerSchedulerTask",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return babelHelpers.extends({},e,{promise:e.promise.then(t),run:function(){return e.run().then(t)}})}i.mapWorkerSchedulerTask=e}),66);
__d("WAMediaManager",["$InternalEnum","WADownloadFullSizeAndPreviewTask","WADownloadFullSizeOnlyTask","WADownloadPreviewOnlyTask","WAErrorMessage","WAHashUtils","WAMediaManagerCache","WAMediaManagerLogger","WAMediaManagerTypes","WAMediaManagerWorkerScheduler","WAResultOrError","WAUploadMediaQuick","WorkerScheduler","gkx","mapWorkerSchedulerTask"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S=n("$InternalEnum").Mirrored(["HIGH","MEDIUM","LOW"]);function R(){return{fullsizeCache:new Map,previewCache:new Map,uploadCache:new Map}}function L(t){var n=t.createCacheState,a=t.dbCallbacks,i=o("WAMediaManagerWorkerScheduler").mediaManagerWorkerScheduler(),l=o("WAMediaManagerCache").createAttachmentCache(a.getProtocolMsgIdAndSortOrderMs,n),v=function(n){var t=o("WAMediaManagerLogger").createDownloadLogger({downloadKind:"fullsize",fullSizePlaintextHash:n.fullSizePlaintextHash}),r=l.getFullsize(n);if(t.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),r.type),r.type==="cache-hit")return r.cache;var c=new AbortController,d=i.task({fn:function(){return o("WADownloadFullSizeOnlyTask").startDownloadFullSizeTask({abortSignal:c.signal,dbCallbacks:a,fullSizePlaintextHash:n.fullSizePlaintextHash,logger:t,mediaDownloadFlow:n.mediaDownloadFlow})},name:"media-manager-download-fullsize-only",priority:E(n.priority)}),m=d.run();return r.setDownloadCache({abortController:c,fullSizePlaintextHash:n.fullSizePlaintextHash,mediaDownloadFlow:n.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(d,function(e){return e.fullsizePromise})}),m.then(function(e){return e.fullsizePromise}).then(function(e){return x(n.fullSizePlaintextHash,e,r.setDownloadedAttachmentToUploadCache)}).catch(function(e){return t.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){t.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["end"])))})},S=function(t){var e=o("WAMediaManagerLogger").createDownloadLogger({downloadKind:"preview",fullSizePlaintextHash:t.fullSizePlaintextHash}),n=l.getPreview(t);if(e.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",""])),n.type),n.type==="cache-hit")return n.cache;var r=new AbortController,s=i.task({fn:function(){return o("WADownloadPreviewOnlyTask").startDownloadPreviewTask({abortSignal:r.signal,dbCallbacks:a,fullSizePlaintextHash:t.fullSizePlaintextHash,logger:e,mediaDownloadFlow:t.mediaDownloadFlow})},name:"media-manager-download-preview-only",priority:E(t.priority)});n.setDownloadCache({abortController:r,fullSizePlaintextHash:t.fullSizePlaintextHash,mediaDownloadFlow:t.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(s,function(e){return e.previewPromise})});var u=s.run();return u.then(function(e){return e.previewPromise}).then(function(e){return $(e,n.setDownloadedAttachmentToUploadCache)}).catch(function(t){return e.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["end"])))})},R=function(t){var e=o("WAMediaManagerLogger").createDownloadLogger({downloadKind:"fullsizeAndPreview",fullSizePlaintextHash:t.fullSizePlaintextHash}),n=l.getFullsizeAndPreview(t),r=n.fullsizeCacheResult,s=n.previewCacheResult;if(e.DEV(p||(p=babelHelpers.taggedTemplateLiteralLoose(["fullsize: ",", preview: ",""])),r.type,s.type),r.type==="cache-hit"&&s.type==="cache-hit")return{fullsizePromise:r.cache,previewPromise:s.cache};if(s.type==="cache-hit"){var u=v(t);return{fullsizePromise:u,previewPromise:s.cache}}if(r.type==="cache-hit"){var c=S(t);return{fullsizePromise:r.cache,previewPromise:c}}r.type,s.type;var d=new AbortController,m=i.task({fn:function(){return o("WADownloadFullSizeAndPreviewTask").startDownloadFullSizeAndPreviewTask({abortSignal:d.signal,dbCallbacks:a,fullSizePlaintextHash:t.fullSizePlaintextHash,logger:e,mediaDownloadFlow:t.mediaDownloadFlow})},name:"media-manager-download-fullsize-and-preview",priority:E(t.priority)});r.setDownloadCache({abortController:d,fullSizePlaintextHash:t.fullSizePlaintextHash,mediaDownloadFlow:t.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(m,function(e){return e.fullsizePromise})}),s.setDownloadCache({abortController:d,fullSizePlaintextHash:t.fullSizePlaintextHash,mediaDownloadFlow:t.mediaDownloadFlow,scheduledTask:o("mapWorkerSchedulerTask").mapWorkerSchedulerTask(m,function(e){return e.previewPromise})});var y=m.run();return{fullsizePromise:y.then(function(e){return e.fullsizePromise}).then(function(e){return x(t.fullSizePlaintextHash,e,r.setDownloadedAttachmentToUploadCache)}).catch(function(t){return e.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["fullsizePromise runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(f||(f=babelHelpers.taggedTemplateLiteralLoose(["fullsize end"])))}),previewPromise:y.then(function(e){return e.previewPromise}).then(function(e){return $(e,s.setDownloadedAttachmentToUploadCache)}).catch(function(t){return e.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["previewPromise runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["preview end"])))})}},L=function(t){var e=o("WAMediaManagerLogger").createUploadLogger({plaintextHash:t.plaintextHash,uploadKind:"fullsize"}),n;if(r("gkx")("19103")&&(n=l.getUploadedAttachment(t),e.DEV(y||(y=babelHelpers.taggedTemplateLiteralLoose(["cache result: ",""])),n.type),t.mediaUploadFlow.addAnnotations({string:{dedupe_result:n.type}}),n.type==="in-thread-cache-hit"))return n.cache;var a=o("WAUploadMediaQuick").uploadMediaQuick({logger:e,mediaUploadFlow:t.mediaUploadFlow,plaintext:t.plaintext,plaintextHash:t.plaintextHash,serverMediaType:t.serverMediaType}).catch(function(t){return e.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["runtime-error: ",""])),o("WAErrorMessage").maybeGetMessageFromError(t)),o("WAResultOrError").makeError("runtime-error")}).finally(function(){e.DEV(b||(b=babelHelpers.taggedTemplateLiteralLoose(["upload end"])))});return n!=null&&r("gkx")("19103")&&n.setUploadCache({chatJid:t.chatJid,plaintextHash:t.plaintextHash,scheduledTask:a}),a};return{clearCache:l.clearCache,dequeueDownload:l.cancelTask,enqueueDownloadFullSize:T("fullsize",v),enqueueDownloadFullSizeAndPreview:T("fullsizeAndPreview",R),enqueueDownloadPreview:T("preview",S),enqueueUploadFullSize:D(L)}}function E(e){return e===S.HIGH?o("WorkerScheduler").BLOCKING_PRIORITY:e===S.MEDIUM?o("WorkerScheduler").REGULAR_PRIORITY:e===S.LOW?o("WorkerScheduler").BACKGROUND_PRIORITY:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}var k=typeof((v=navigator.storage)==null?void 0:v.getDirectory)=="function",I=typeof self.caches=="object";function T(e,t){return function(n){var r=n.fullSizePlaintextHash,a=n.mediaDownloadFlow;try{a.addPoint("enqueue_start",{bool:{isOPFSSupported:k,isWebCacheSupported:I},string:{downloadKind:e,sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)}});var i=t(n);return a.addPoint("enqueue_end"),i}catch(e){throw a.addPoint("enqueue_fail"),e}}}function D(e){return function(t){var n=t.mediaUploadFlow,r=t.plaintextHash;try{n.addPoint("enqueue_start",{string:{sanitisedMediaHash:o("WAHashUtils").sanitisePlaintextHash(r)}});var a=e(t);return n.addPoint("enqueue_end"),a}catch(e){throw n.addPoint("enqueue_fail"),e}}}function x(e,t,n){if(!t.success)return t;if(r("gkx")("19103")===!1)return o("WAMediaManagerTypes").transformInternalMediaDownloadResult(t);var a=t.value.msgIdAndMediaEntry,i=a[0],l=a[1];return n({mediaEntry:l,msgId:i,plaintextHash:e}),o("WAMediaManagerTypes").transformInternalMediaDownloadResult(t)}function $(e,t){if(!e.success)return e;if(r("gkx")("19103")===!1)return o("WAMediaManagerTypes").transformInternalMediaDownloadResult(e);var n=e.value.msgIdAndMediaEntry,a=n[0],i=n[1],l=i.downloadableThumbnail;return l==null||l.directPath==null||l.fileEncSha256==null||l.fileSha256==null||l.mediaKey==null||l.mediaKeyTimestamp==null||l.objectId==null||t({mediaEntry:babelHelpers.extends({},i,{directPath:l.directPath,downloadableThumbnail:null,fileSha256:l.fileSha256,mediaKey:l.mediaKey,mediaKeyTimestamp:l.mediaKeyTimestamp,objectId:l.objectId,serverMediaType:"preview",size:e.value.validatedResult.validatedPlaintext.byteLength}),msgId:a,plaintextHash:o("WAHashUtils").toPlaintextHash(l.fileSha256)}),o("WAMediaManagerTypes").transformInternalMediaDownloadResult(e)}l.MediaTaskPriority=S,l.createCacheState=R,l.createMediaManager=L,l.toWorkerSchedulerPriority=E}),98);
__d("WAMediaManagerCache",["Promise","WAErrorMessage","WAHashUtils","WAMediaManager","WAMediaManagerLogger","WAMediaManagerTypes","WAPromiseDelays","WAResultOrError","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["mediaKeyTimestamp","objectId","size"],s,u,c,d,m,p,_,f=3e4,g=1e3*60*60*24*2;function h(e,t){t===void 0&&(t=o("WAMediaManager").createCacheState);var r=t(),a=r.fullsizeCache,i=r.previewCache,l=r.uploadCache,h=function(t){var e=t.abortController,n=t.fullSizePlaintextHash,r=t.mediaDownloadFlow,i=t.scheduledTask;a.set(n,{abortController:e,mediaDownloadFlow:r,task:i}),i.promise.then(function(e){var t=e.success;return t?o("WAPromiseDelays").delayMs(f):void 0}).finally(function(){a.delete(n)})},b=function(t){var e=t.abortController,n=t.fullSizePlaintextHash,r=t.mediaDownloadFlow,a=t.scheduledTask;i.set(n,{abortController:e,mediaDownloadFlow:r,task:a}),a.promise.then(function(e){var t=e.success;return t?o("WAPromiseDelays").delayMs(f):void 0}).finally(function(){i.delete(n)})},v=function(t){var e=t.chatJid,n=t.plaintextHash,r=t.scheduledTask,a=t.cacheTtlMs,i=a===void 0?g:a,s=l.get(n)||new Map;s.set(e,r),l.set(n,s),r.then(function(e){var t=e.success;return t?o("WAPromiseDelays").delayMs(i):void 0}).finally(function(){l.delete(n)})},S=function(r){var t=r.mediaEntry,a=r.msgId,i=r.plaintextHash;e(a).then(function(e){if(e==null){o("WAMediaManagerLogger").baseLogger.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["missing chatJid, skip setDownloadedAttachmentToUploadCache"])));return}var r=e.protocolMsgId.chat,a=C(t);if(a==null){o("WAMediaManagerLogger").baseLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["can not covert mediaEntry from download to upload for cache"])));return}var l=o("WATimeUtils").timeoutFor(a.mediaKeyTimestamp,g/1e3);if(l!==0){var c=o("WATimeUtils").pastUnixTime(o("WATimeUtils").DAY_SECONDS,a.mediaKeyTimestamp);o("WATimeUtils").isInFuture(c)||v({cacheTtlMs:l,chatJid:r,plaintextHash:i,scheduledTask:(_||(_=n("Promise"))).resolve(o("WAResultOrError").makeResult(a))})}}).catch(function(e){o("WAMediaManagerLogger").baseLogger.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["setDownloadedAttachmentToUploadCache getProtocolMsgIdAndSortOrderMs: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e))})};return{cancelTask:function(t){var e=o("WAMediaManagerLogger").baseLogger.TAGS(["hash:"+o("WAHashUtils").sanitisePlaintextHash(t),"cancelTask"]);e.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["start"])));var n=[a,i];for(var r of n){var l=r.get(t);if(l!=null){var s=l.task.cancel();l.mediaDownloadFlow.addPoint("cancel_download_triggered"),s===!1?(l.abortController.abort(),l.mediaDownloadFlow.addPoint("http_abort_cancel"),e.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["http abort cancel"])))):(l.mediaDownloadFlow.addPoint("worker_task_cancel_cancel"),e.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["worker task cancel"])))),r.delete(t)}}},clearCache:function(){i.clear(),a.clear(),l.clear()},getFullsize:function(t){var e=a.get(t.fullSizePlaintextHash);return e!=null?(y(t.mediaDownloadFlow,"hit","fullsize"),e.task.promote(o("WAMediaManager").toWorkerSchedulerPriority(t.priority)),{cache:e.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}):(y(t.mediaDownloadFlow,"miss","fullsize"),{setDownloadCache:h,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"})},getFullsizeAndPreview:function(t){var e=o("WAMediaManager").toWorkerSchedulerPriority(t.priority),n=a.get(t.fullSizePlaintextHash),r=i.get(t.fullSizePlaintextHash);return n!=null&&r!=null?(y(t.mediaDownloadFlow,"hit","fullsize-and-preview"),n.task.promote(e),r.task.promote(e),{fullsizeCacheResult:{cache:n.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"},previewCacheResult:{cache:r.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}}):n!=null?(y(t.mediaDownloadFlow,"hit","fullsize"),n.task.promote(e),{fullsizeCacheResult:{cache:n.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"},previewCacheResult:{setDownloadCache:b,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"}}):r!=null?(y(t.mediaDownloadFlow,"hit","preview"),r.task.promote(e),{fullsizeCacheResult:{setDownloadCache:h,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"},previewCacheResult:{cache:r.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}}):(y(t.mediaDownloadFlow,"miss","fullsize-and-preview"),{fullsizeCacheResult:{setDownloadCache:h,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"},previewCacheResult:{setDownloadCache:b,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"}})},getPreview:function(t){var e=i.get(t.fullSizePlaintextHash);return e!=null?(y(t.mediaDownloadFlow,"hit","preview"),e.task.promote(o("WAMediaManager").toWorkerSchedulerPriority(t.priority)),{cache:e.task.promise.then(o("WAMediaManagerTypes").transformInternalMediaDownloadResult),type:"cache-hit"}):(y(t.mediaDownloadFlow,"miss","preview"),{setDownloadCache:b,setDownloadedAttachmentToUploadCache:S,type:"cache-miss"})},getUploadedAttachment:function(t){var e=l.get(t.plaintextHash);if(e==null)return{setUploadCache:v,type:"cache-miss-no-plaintext-hash"};var n=e.get(t.chatJid);return n==null?{setUploadCache:v,type:"cache-miss-no-thread"}:{cache:n,type:"in-thread-cache-hit"}}}}function y(e,t,n){e.addAnnotations({string:{media_manager_cache_result:t,media_manager_cache_type:n}})}function C(t){var n=t.mediaKeyTimestamp,r=t.objectId,o=t.size,a=babelHelpers.objectWithoutPropertiesLoose(t,e);return n==null||r==null||o==null?null:babelHelpers.extends({},a,{mediaKeyTimestamp:n,objectId:r,size:o})}l.DOWNLOAD_TASK_CACHE_TTL_MS=f,l.UPLOAD_TASK_CACHE_TTL_MS=g,l.createAttachmentCache=h}),98);
__d("blobToDataUri",["err"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){var t=new FileReader,n=new Promise(function(e,n){t.onloadend=e,t.onerror=n});t.readAsDataURL(e),await n;var o=t.result;if(typeof o!="string")throw r("err")('Unexpected result type "%s" when reading Blob as DataURL.',o instanceof ArrayBuffer?"ArrayBuffer":typeof o);return o}l.default=e}),98);
__d("MAWGetThumbnailBlobDataUrlByMediaIdApi",["MAWCreateMaybeAddPointForMediaRender","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWIndexedDb","MAWMaybeWithTimeout","MAWMediaManager","MAWMediaPreviewDownloadManager","MAWTransactionMode","MWFBLogger","WAErrorMessage","WAHashUtils","WAMediaManager","WAResultOrError","WAStartMediaDownloadQplFlow","blobToDataUri"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v=o("MWFBLogger").MWMediaLogger().tags(["getThumbnailBlobDataUrlByMediaId"]),S=async function(n,a,i){v.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Get thumbnail blob for "," from , from ",""])),n,a);var t=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(i),l={string:{description:a,fetch_by:"mediaId"}};t("fetch_thumbnail_blob_api_start",l),t("get_media_from_db_start",l);var g=await k(n);if(t("get_media_from_db_finish",{bool:{db_media_found:g!=null}}),g==null)throw v.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["No media found for ",""])),n),t("fetch_thumbnail_blob_api_fail_no_media_found_in_db",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because media is not in the media db. mediaId is %s, from %s",n,a);var h=T(g);if(h.success===!0){v.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Found jpegThumbnail entry for ",""])),n),t("fetch_thumbnail_blob_api_success",l);var y=await r("blobToDataUri")(h.value);if(!y)throw v.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),n),t("fetch_thumbnail_blob_api_fail_no_data_uri",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",n,a);return v.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),n),y}var C=h.error;switch(C){case"missing_jpeg_thumbnail":if(g.mediaType===o("MAWDbMedia").MEDIA_TYPE.IMAGE||g.mediaType===o("MAWDbMedia").MEDIA_TYPE.VIDEO){var b=await L(g,i);if(b!=null){t("fetch_thumbnail_blob_api_success",l);var S=await r("blobToDataUri")(b);if(!S)throw v.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),n),t("fetch_thumbnail_blob_api_fail_no_data_uri",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",n,a);return v.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),n),S}if((g==null?void 0:g.mediaType)===o("MAWDbMedia").MEDIA_TYPE.VIDEO)throw t("fetch_thumbnail_blob_api_fail_not_able_to_generate_video_thumbnail_on_the_fly",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId in time (for video). mediaId is %s, from %s",n,a);var R=await E(g,i);if(R==null)throw t("fetch_thumbnail_blob_api_fail_not_able_to_generate_image_thumbnail_on_the_fly",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId in time or to generate thumnbail on the fly. mediaId is %s, from %s",n,a);t("fetch_thumbnail_blob_api_success",l);var I=await r("blobToDataUri")(R);if(!I)throw v.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),n),t("fetch_thumbnail_blob_api_fail_no_data_uri",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",n,a);return v.DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),n),I}throw t("fetch_thumbnail_blob_api_fail_missing_thumbnail",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media (missing_jpeg_thumbnail). mediaId is %s, from %s",n,a);case"invalid_media":throw t("fetch_thumbnail_blob_api_fail_invalid_media",l),v.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media. mediaId is %s, from %s",n,a)}},R=async function(t,n,a){var e=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(a),i={string:{description:n,fetch_by:"hashedPlaintextHash"}};e("fetch_thumbnail_blob_api_start",i),v.DEBUG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Get thumbnail blob for "," from ",""])),o("WAHashUtils").sanitisePlaintextHash(t),n);var l=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"UILayout",msgType:null,protocolMsgId:null,triggerUIView:null}),s=o("MAWMediaManager").getMawMediaManager(),u=s.enqueueDownloadFullSizeAndPreview({fullSizePlaintextHash:t,mediaDownloadFlow:l,priority:o("WAMediaManager").MediaTaskPriority.HIGH}),c=await u.previewPromise;if(c.success){var d;l.endSuccess();var m=c.value.validatedResult.validatedPlaintext,p=new Blob([m],{type:(d=c.value.validatedResult.mimeType)!=null?d:void 0}),_=await r("blobToDataUri")(p);return _}if(c.error!=="preview-not-supported")throw l.endFail(c.error,{string:{failReason:c.error}}),o("MWFBLogger").MPSLogger().mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash. plaintextHash is %s, from %s, error: %s",o("WAHashUtils").sanitisePlaintextHash(t),n,c.error);var f=await u.fullsizePromise;if(f.success){var h;l.endSuccess();var y=f.value.validatedResult.validatedPlaintext,C=new Blob([y],{type:(h=f.value.validatedResult.mimeType)!=null?h:void 0}),b=await r("blobToDataUri")(C);return b}throw l.endFail(f.error,{string:{failReason:f.error}}),o("MWFBLogger").MPSLogger().mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash. plaintextHash is %s, from %s, error: %s",o("WAHashUtils").sanitisePlaintextHash(t),n,f.error)},L=function(t,n){var e=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(n);e("fetch_thumbnail_blob_api_thumbnail_download_start");var r=o("MAWMediaPreviewDownloadManager").getMediaPreviewDownloadingResolvable(t.plaintextHash);return r==null?(e("fetch_thumbnail_blob_api_thumbnail_download_fail_no_resolvable"),Promise.resolve(null)):o("MAWMaybeWithTimeout").maybeWithTimeout(r.promise,1e4,function(){throw v.mustfixThrow("timeout waiting for thumbnail to download")}).then(function(t){return e("fetch_thumbnail_blob_api_thumbnail_download_success"),t}).catch(function(t){var n=o("WAErrorMessage").maybeGetMessageFromError(t);return v.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Exception when waiting for thumbnail to download: ",""])),n),e("fetch_thumbnail_blob_api_thumbnail_download_fail_exception",{string:{wait_for_thumbnail_download_exception:n}}),null})},E=o("MAWIndexedDb").makeMsgrTransactor({chunk:(b=o("MAWTransactionMode")).READONLY,media:b.READONLY},"generateThumbnailFromMediaChunk",function(e){return function(t,n){var r=o("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(n);return r("fetch_thumbnail_blob_api_thumbnail_generate_from_media_start"),o("MAWDbChunkTxns").maybeGetChunkFromHash(e,t.hashedPlaintextHash).then(function(e){if(e==null){v.MUSTFIX(y||(y=babelHelpers.taggedTemplateLiteralLoose(["getImageThumbnail: unable to get a thumbnail as the media chunk is missing"]))),r("fetch_thumbnail_blob_api_thumbnail_generate_from_media_fail_chunk_missing");return}return v.WARN(C||(C=babelHelpers.taggedTemplateLiteralLoose(["getImageThumbnail: using media chunk as the thumbnail"]))),r("fetch_thumbnail_blob_api_thumbnail_generate_from_media_success"),new Blob([e.blobData],{type:e.mimetype})})}}),k=o("MAWIndexedDb").makeMsgrTransactor({media:b.READONLY},"getFullMedia",function(e){return function(t){return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t)}}),I=o("MAWIndexedDb").makeMsgrTransactor({media:b.READONLY},"getFullMedia",function(e){return function(t){return o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(e,t)}}),T=function(t){var e=D(t);if(e.success===!1)return e;var n=e.value.jpegThumbnail;return n!=null?o("WAResultOrError").makeResult(new Blob([n],{type:"image/jpeg"})):o("WAResultOrError").makeError("missing_jpeg_thumbnail")},D=function(t){var e,n;switch(t.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:return o("WAResultOrError").makeResult({jpegThumbnail:(e=t.validatedImageInfo)==null?void 0:e.jpegThumbnail});case o("MAWDbMedia").MEDIA_TYPE.VIDEO:return o("WAResultOrError").makeResult({jpegThumbnail:(n=t.validatedVideoInfo)==null?void 0:n.jpegThumbnail});case o("MAWDbMedia").MEDIA_TYPE.PTT:case o("MAWDbMedia").MEDIA_TYPE.STICKER:case o("MAWDbMedia").MEDIA_TYPE.GIF:case o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return o("WAResultOrError").makeError("invalid_media");default:return t.mediaType,o("WAResultOrError").makeError("invalid_media")}};l.getThumbnailBlobDataUrlByMediaId=S,l.getThumbnailBlobDataUrlByHashedPlaintextHash=R,l.getFullMediaWithPlaintextHash=I}),98);
__d("MAWMediaManager",["MpsMediaManager","WAMediaManager","memoize"],(function(t,n,r,o,a,i,l){"use strict";var e=r("memoize")(function(){return o("WAMediaManager").createCacheState()}),s=r("memoize")(function(){return o("MpsMediaManager").getMpsMediaManager(e)}),u=function(){return s()};l.getMawMediaManager=u}),98);
__d("WmiChunkApi",["CoalescingLoader","MAWDbChunkTxns","MAWDexieTable","MAWIndexedDb","MAWMediaUtils","MAWTransactionMode","emptyFunction","memoizeWithArgsLFUCache"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READONLY},"wms_getCachedChunkResult",function(e){return function(t){return o("MAWDbChunkTxns").maybeBulkGetChunksFromPlaintextHash(e,t)}}),n=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READWRITE},"wms_storeChunk",function(t){return function(n){return n.map(function(t){return e(t[0])}),o("MAWDexieTable").dexieAll(n.map(function(e){return o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(t,e[0],e[1],e[2],e[3])})).then(r("emptyFunction"))}}),a=new(o("CoalescingLoader")).CoalescingLoader(async function(n){var r=await t(n);return n.map(function(t){var n=r.get(t);return n==null&&e(t),n})}),i=new(o("CoalescingLoader")).CoalescingLoader(async function(e){return await n(e),[]}),l=r("memoizeWithArgsLFUCache")(function(e){return a.gen(e)},function(e){return e},1,function(t){e=t}),s=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READWRITE},"wms_deleteChunk",function(t){return function(n){n.map(e);var r=n.map(o("MAWMediaUtils").genHMACPlaintextHash);return t.chunk.where("hashedPlaintextHash").anyOf(r).delete()}});return{delete:s,get:l,store:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.gen(t)}}}l.getChunkApi=e}),98);
__d("MediaServiceLogger",["FBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return r("FBLogger")("wmi_media_service",t)};l.MediaServiceLogger=e}),98);
__d("WmiMediaServiceSchema",["$InternalEnum","MAWWormOdsLogger","MediaServiceLogger","WAHex","Worm","WormEAR","WormIDbDriver","WormMemoryDriver"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum").Mirrored(["XMA","Sticker"]),s={autoIncrement:!0,indexes:{"[plaintextHash+updatedAtMs]":{fields:["plaintextHash","updatedAtMs"],unique:!1},"[threadId+messageId+plaintextHash]":{fields:["threadId","messageId","plaintextHash"],unique:!0}},nonEncryptedFields:["updatedAtMs","messageId"],primaryKey:"pk",secure:!0},u={autoIncrement:!1,indexes:{},nonEncryptedFields:["refCount"],primaryKey:"mediaId",secure:!0},c={autoIncrement:!1,indexes:{receiverFetchType:{fields:["receiverFetchType"],unique:!1}},nonEncryptedFields:["receiverFetchType"],primaryKey:"receiverFetchId",secure:!0},d={mediaReferrenceCount:u,messageChunk:s,receiverFetchInfo:c};function m(e){var t=e.blockingErrorThreshold,n=e.dbName,r=e.onBlockingError,a=e.qplEvent,i=e.strEncKey,l=o("WAHex").parseHex(i),s="wmi_media_service",u=new(o("WormEAR")).WormEAR(d,s,l),c=new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(n,s,d,u,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:t,onBlockingError:r,onTransactionError:function(t){if(t instanceof o("WormEAR").DecryptionError){if(o("MediaServiceLogger").MediaServiceLogger().mustfix("EAR decryption error in store: %s. Dropping corrupted entity %s",t.store,t.maybeHashedPk),t.store==="messageChunk"){var e=t.maybeHashedPk;c.runInTransaction(["messageChunk"],"readwrite",function(t){return e!=null?t.stores.messageChunk.delete(e):t.stores.messageChunk.clear()},"delete-corrupted-entity")}else if(t.store==="mediaReferrenceCount"){var n=t.maybeHashedPk;c.runInTransaction(["mediaReferrenceCount"],"readwrite",function(e){return n!=null?e.stores.mediaReferrenceCount.delete(n):e.stores.mediaReferrenceCount.clear()},"delete-corrupted-entity")}else if(t.store==="receiverFetchInfo"){var r=t.maybeHashedPk;c.runInTransaction(["receiverFetchInfo"],"readwrite",function(e){return r!=null?e.stores.receiverFetchInfo.delete(r):e.stores.receiverFetchInfo.clear()},"delete-corrupted-entity")}}}}),a);return c}function p(e){return new(o("Worm")).WormDatabase(new(o("WormMemoryDriver")).WormMemoryDriver("wmi_media_service_test",d,o("MAWWormOdsLogger").wormOdsWorkerLogger),e)}l.ReceiverFetchType=e,l.SCHEMA=d,l.makeSchema=m,l.makeInMemorySchema_TEST_ONLY=p}),98);
__d("WmiMediaServiceDb",["MediaServiceLogger","WAResolvable","WmiMediaServiceSchema","err","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;async function u(t){try{var n=o("WmiMediaServiceSchema").makeSchema(t);return e=n,await n.init(),s.resolve(n),n}catch(e){throw o("MediaServiceLogger").MediaServiceLogger().catching(r("getErrorSafe")(e)).mustfix("Error performing Media Service init"),e}}function c(){if(e==null)throw r("err")("DB is not initialized");return e}l.makeMediaServiceDb=u,l.getDb=c}),98);
__d("WmiMediaServiceDownloadQueue",["WormPersistedQueue","WormPersistedQueueSchema"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WormPersistedQueueSchema").toWormPersistedQueueId(e)}var s=null;function u(){return s==null&&(s=new(o("WormPersistedQueue")).WormPersistedQueue("mediaDownloadQueue")),s}l.generateDownloadQueueId=e,l.getDownloadQueue=u}),98);
__d("WmiMediaService",["MpsTypes","WmiChunkApi","WmiMediaServiceDb","WmiMediaServiceDownloadQueue","err","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e){this.$1=e,this.$2=o("WmiChunkApi").getChunkApi()}var t=e.prototype;return t.enqueueMediaDownload=async function(t){await o("WmiMediaServiceDownloadQueue").getDownloadQueue().put(t.map(function(e){return{attemptCount:0,queueId:o("WmiMediaServiceDownloadQueue").generateDownloadQueueId(e)}}))},t.getChunk=async function(t){var e,n=await this.$2.get(t);return n==null?null:{blobData:n.blobData,isProgressivePreview:(e=n.isProgressivePreview)!=null?e:!1,mimetype:n.mimetype,plaintextHash:n.plaintextHash}},t.getMessageChunkForHash=function(t){return this.$1.runInTransaction(["messageChunk"],"readonly",async function(e){var n=await e.stores.messageChunk.readIndexRange("[plaintextHash+updatedAtMs]",{only:[t]},{limit:1,order:"desc"});return n.at(0)},"WmiGetMessagesForHash")},t.handleMessageDeletion=function(t,n){return this.$3(function(e){return e.stores.messageChunk.readIndexRange("[threadId+messageId+plaintextHash]",{only:[t,n]})})},t.handleThreadDeletion=function(t){return this.$3(function(e){return e.stores.messageChunk.readIndexRange("[threadId+messageId+plaintextHash]",{only:[t]})})},t.storeChunk=function(t){var e=t.blobData,n=t.isProgressivePreview,r=t.mimetype,o=t.plaintextHash;return this.$2.store(o,e,r,n)},t.storeMessageChunks=function(t){return this.$1.runInTransaction(["messageChunk"],"readwrite",async function(e){await e.stores.messageChunk.bulkUpsert("[threadId+messageId+plaintextHash]",t.map(function(e){return{item:{messageId:e.messageId,plaintextHash:e.plaintextHash,threadId:e.threadId,updatedAtMs:o("MpsTypes").toTimestamp(Date.now())},selector:[e.threadId,e.messageId,e.plaintextHash]}}))},"WmiMediaServiceStoreChunkMessage")},t.$3=async function(t){var e=await this.$1.runInTransaction(["messageChunk"],"readwrite",async function(e){var n=await t(e);await e.stores.messageChunk.bulkDelete(n.map(function(e){return e.pk}));var r=new Set(n.map(function(e){return e.plaintextHash})),o=await e.stores.messageChunk.readIndexAnyOf("[plaintextHash+updatedAtMs]",Array.from(r).map(function(e){return[e]}));return o.forEach(function(e){return r.delete(e.plaintextHash)}),Array.from(r)},"WmiMediaServiceDeleteMessageChunkEntries");e.length>0&&await this.$2.delete(Array.from(e))},e})(),s=null;async function u(t){if(s!=null)throw r("err")("Media Service already initialised");var n=await o("WmiMediaServiceDb").makeMediaServiceDb(t);s=new e(n)}function c(){return r("nullthrows")(s,"Media Service not initialised")}function d(){s=null}l.MediaService=e,l.wmiMediaServiceSetup=u,l.mediaService=c,l.wmiMediaServiceClear__TESTONLY=d}),98);
__d("MpsMediaManager",["MAWGetThumbnailBlobDataUrlByMediaIdApi","MpsMediaEntryCache","MpsMessageToBridgeWrapper","MpsToBridgeMessageId","WAIsPreviewSupported","WAJids","WAMediaManager","WAMediaManagerCache","WAMediaUtils","WAResultOrError","WAStanzaUtils","WAValidateMedia","WebMps","WmiMediaService","getErrorSafe","memoize","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e=["kind"];function s(e){throw new TypeError('"'+e+'" is read-only')}async function u(e){var t=e.fullSizePlaintextHash,n=e.mediaDownloadFlow,r=o("MpsMediaEntryCache").getEntry(t);if(r!=null)return n.addPoint("media_entry_cache_hit"),r;var a=await o("WmiMediaService").mediaService().getMessageChunkForHash(t);if(a==null){n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"missing_message_chunk"}});return}var i=await o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"MpsMediaManager-getEntryWithFallback"},messageId:a.messageId,threadId:a.threadId}),l=i.value;if(l==null){n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"missing_reverb_message"}});return}o("MpsMediaEntryCache").hydrateCache(l.toplevelProtobuf);var s=o("MpsMediaEntryCache").getEntry(t);return s==null?(n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"unable_to_cache"}}),null):(n.addPoint("media_entry_cache_miss",{string:{media_entry_recache_result:"success"}}),s)}async function c(e){var t=o("MpsToBridgeMessageId").bridgeMsgIdToMps(e),n=t.messageId,r=t.threadId,a=await o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-first"},debug:{purpose:"mps_media_manager"},messageId:n,threadId:r});if(a.value){var i=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(a.value.toplevelProtobuf),l=i.getAuthor();if(!o("WAJids").isAuthorSystem(l))return{protocolMsgId:{author:l,chat:i.getChatJid(),externalId:o("WAStanzaUtils").toStanzaId(i.getExternalId())},sortOrderMs:i.message.timestampMs}}}var d=function(t){return o("WAMediaManager").createMediaManager({createCacheState:t,dbCallbacks:{getMediaEntries:function(t){var e=o("MpsMediaEntryCache").getEntry(t);if(e==null)return Promise.resolve(o("WAResultOrError").makeError("no-media-by-plaintext-hash"));var n=e.mediaEntry,r=e.message,a=o("MpsToBridgeMessageId").mpsToBridgeMsgId(r.threadId,r.messageId);return Promise.resolve(o("WAResultOrError").makeResult(new Map([[a,n]])))},getProtocolMsgIdAndSortOrderMs:c}})};function m(e){var t=o("WAIsPreviewSupported").checkPreviewSupport(e.decodedMediaEntry),n=t[0],r=t[1];return(function(t){if(Array.isArray(t)&&t.length===2&&t[0]===o("WAIsPreviewSupported").PjpegPreviewSupport.YES)return{kind:"progressive",thumbnailHash:e.plaintextHash};if(Array.isArray(t)&&t.length===2&&t[1]===o("WAIsPreviewSupported").DownloadablePreviewSupport.YES)return e.thumbnailHash!=null?{kind:"withThumbnail",thumbnailHash:e.thumbnailHash}:{kind:"noPreview"};if(Array.isArray(t)&&t.length===2&&t[1]===o("WAIsPreviewSupported").DownloadablePreviewSupport.DuplicatedWithFullSize)return{kind:"duplicatedWithFullSize",thumbnailHash:e.plaintextHash};if(Array.isArray(t)&&t.length===2&&t[1]===o("WAIsPreviewSupported").DownloadablePreviewSupport.NO)return{kind:"noPreview"};throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+t)})([n,r])}async function p(e,t,n){if(e!=null){var r=await o("WAValidateMedia").validateMedia(e,t);if(r.value!=null)return o("WAResultOrError").makeResult({serverMediaType:n,unvalidatedMimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType(n),validatedResult:r.value})}}async function _(e,t,n){var r=await o("WmiMediaService").mediaService().getChunk(e),a=await p(r==null?void 0:r.blobData,t,n);if(!(r==null||a==null))return t.addAnnotations({bool:{from_chunk:!0}}),{chunk:r,result:a}}function f(e,t,n,a){if(n.success===!0){var i;o("WmiMediaService").mediaService().storeChunk({blobData:n.value.validatedResult.validatedPlaintext,isProgressivePreview:a,mimetype:(i=n.value.validatedResult.mimeType)!=null?i:n.value.unvalidatedMimeType,plaintextHash:e}).then(function(){return t.addAnnotations({string:{chunk_store_result:"success"}})}).catch(function(e){var n=r("getErrorSafe")(e).message;t.addAnnotations({string:{chunk_store_result:n}})})}}async function g(e,t,n){var r,a=n.fullSizePlaintextHash,i=n.mediaDownloadFlow;if(e.success||e.error!=="signature-expired")return e;var l=await o("MAWGetThumbnailBlobDataUrlByMediaIdApi").getFullMediaWithPlaintextHash(a);if(l==null)return i.addAnnotations({string:{signature_expired_fallback:"media not found"}}),e;var s=(r=l.validatedAudioInfo)!=null?r:l.validatedVideoInfo,u=s==null?void 0:s.jpegThumbnail;if(u==null)return i.addAnnotations({string:{signature_expired_fallback:"thumbnail not found"}}),e;var c=await o("WAValidateMedia").validateMedia(u,i);return c.value==null?(i.addAnnotations({string:{signature_expired_fallback:"validation failed"}}),e):(i.addAnnotations({string:{signature_expired_fallback:"success"}}),o("WAResultOrError").makeResult({serverMediaType:t.serverMediaType,unvalidatedMimeType:o("WAMediaUtils").getMimeTypeFromServerMediaType("image"),validatedResult:c.value}))}var h=function(n){var t=d(n),a=o("WAMediaManagerCache").createAttachmentCache(c,n),i={clearCache:t.clearCache,dequeueDownload:t.dequeueDownload,enqueueDownloadFullSize:async function(n){n.mediaDownloadFlow.addAnnotations({string:{downloadKind:"fullsize"}});var e=a.getFullsize(n);if(e.type==="cache-hit")return e.cache;var r=await u(n);if(!r)return o("WAResultOrError").makeError("missing-media-entry");var i=await _(n.fullSizePlaintextHash,n.mediaDownloadFlow,r.serverMediaType);if(i!=null&&!i.chunk.isProgressivePreview)return i.result;n.mediaDownloadFlow.addPoint("mps_actual_download");var l=await t.enqueueDownloadFullSize(n);return f(n.fullSizePlaintextHash,n.mediaDownloadFlow,l,!1),l},enqueueDownloadFullSizeAndPreview:function(i){i.mediaDownloadFlow.addAnnotations({string:{downloadKind:"fullsizeAndPreview"}});var n=a.getFullsizeAndPreview(i),l=n.fullsizeCacheResult,s=n.previewCacheResult;if(l.type==="cache-hit"&&s.type==="cache-hit")return{fullsizePromise:l.cache,previewPromise:s.cache};var c=r("memoize")(function(){return u(i)}),d=r("memoize")(async function(){var e=r("nullthrows")(await c()),t=_(i.fullSizePlaintextHash,i.mediaDownloadFlow,e.serverMediaType);return t});i.mediaDownloadFlow.addPoint("mps_actual_download");var p=r("memoize")(function(){return t.enqueueDownloadFullSizeAndPreview(i)});return{fullsizePromise:(async function(){var e=await c();if(e==null)return o("WAResultOrError").makeError("missing-media-entry");var t=await d();if(t!=null&&!t.chunk.isProgressivePreview)return t.result;var n=await p().fullsizePromise;return f(i.fullSizePlaintextHash,i.mediaDownloadFlow,n,!1),n})(),previewPromise:(async function(){var t=await c();if(t==null)return o("WAResultOrError").makeError("missing-media-entry");var n=m(t);if(n.kind==="noPreview")return o("WAResultOrError").makeError("preview-not-supported");var r=await(function(n){if((typeof n=="object"&&n!==null||typeof n=="function")&&n.kind==="duplicatedWithFullSize"||(typeof n=="object"&&n!==null||typeof n=="function")&&n.kind==="progressive")return d();if((typeof n=="object"&&n!==null||typeof n=="function")&&n.kind==="withThumbnail"){var r=n.kind,o=babelHelpers.objectWithoutPropertiesLoose(n,e);return _(o.thumbnailHash,i.mediaDownloadFlow,t.serverMediaType)}throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+n)})(n);if(r!=null)return r.result;var a=await p().previewPromise,l=await g(a,t,i);return n.kind==="withThumbnail"&&f(n.thumbnailHash,i.mediaDownloadFlow,l,!1),l})()}},enqueueDownloadPreview:async function(n){n.mediaDownloadFlow.addAnnotations({string:{downloadKind:"preview"}});var e=a.getPreview(n);if(e.type==="cache-hit")return e.cache;var r=await u(n);if(r==null)return o("WAResultOrError").makeError("missing-media-entry");var i=m(r),l=i.kind==="progressive";if(i.kind==="noPreview")return o("WAResultOrError").makeError("preview-not-supported");var s=i.thumbnailHash,c=await _(s,n.mediaDownloadFlow,r.serverMediaType);if(c!=null)return c.result;n.mediaDownloadFlow.addPoint("mps_actual_download");var d=await t.enqueueDownloadPreview(n),p=await g(d,r,n);return f(s,n.mediaDownloadFlow,p,l),p},enqueueUploadFullSize:function(){return t.enqueueUploadFullSize.apply(t,arguments)}};return i};l.getMpsMediaManager=h}),98);