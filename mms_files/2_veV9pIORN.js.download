;/*FB_PKG_DELIM*/

__d("EBEncryptMessageTypes",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}function l(e){return e}function s(e){return e}function u(e){return e}function c(e){return e}function d(e){return e}function m(e){return e}function p(e){return e}function _(e){return e}function f(e){return e}function g(e){return e}function h(e){return e}function y(e){return e}i.unsafeCastToAAD=e,i.unsafeCastToSecretKey=l,i.unsafeCastToPlaintext=s,i.unsafeCastToCiphertext=u,i.unsafeCastToMsgData=c,i.unsafeCastToMacKey=d,i.unsafeCastToHmac=m,i.unsafeCastToEBCreateDerivedKeysIkm=p,i.unsafeCastToEBCreateDerivedKeysInfo=_,i.unsafeCastToEBCreateDerivedKeysSalt=f,i.unsafeCastToEBCreateDerivedKeyLength=g,i.unsafeCastToEBDerivedKey=h,i.castEBDerivedKeyToArrayBuffer=y}),66);
__d("EchoCommonUtils",[],(function(t,n,r,o,a,i){"use strict";var e="Echo-Doc-Version";function l(e,t){var n=e.localKey,r=e.transportKey;return n+"@"+r+"-"+t}function s(e,t,n){return e==null?{localKey:t,transportKey:n}:{displayName:e,localKey:t,transportKey:n}}i.ECHO_COMMON_FIELD_DOCUMENT_VERSION=e,i.getEchoAddressFieldNameWithSuffix=l,i.craftEchoAddress=s}),66);
__d("EchoConstants",[],(function(t,n,r,o,a,i){"use strict";var e=new Set(["\0","","","","","","","\x07","\b","	","\n","\v","\f","\r","","","","","","","","","","","","","","\x1B","","","","",'"'," ","(",")",",",":",";","<",">","@","[","]","\\"]);i.ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE=e}),66);
__d("EchoDecodingUtils",["invariant","EchoConstants","WALogger"],(function(t,n,r,o,a,i,l,s){"use strict";var e,u,c,d,m,p,_,f,g,h,y,C,b,v=new Set([]);function S(t,n){if(t.length!==0){var r=t.indexOf(":");if(r===-1){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] This is a raw line and we cannot decode its field name and value."])));return}var a=t.substring(0,r).trim(),i=t.substring(r+1).trim();if(a.length===0){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Field name is blank"])));return}if(i.length===0){n.has(a)&&n.delete(a);return}n.set(a,i)}}function R(e,t,n,r){n===void 0&&(n=new Set);for(var a=!1,i=t==="conditional"&&e[0]==='"',l="",s=i?1:0;s<e.length;){var u=e[s];if(t==="conditional"&&!i&&u==='"'||!i&&n.has(u))break;if(i&&!a&&u==='"'){i=!1,s++;break}if(i&&!a&&u==="\\"){if(s===e.length-1)break;a=!0}else a&&u==="r"?l+="\r":a&&u==="n"?l+="\n":l+=u,a=!1;s++}if(i||l.length===0){var d=r!=null?r:"unknown";return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail decoding because we didn't have a closing quote. Error Field: ",""])),d),{remainder:e,result:null,success:!1}}return{remainder:e.substring(s),result:l,success:!0}}function L(e,t){if(e.length===0)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddress"]))),{remainder:e,result:null,success:!1};var n=e.trimLeft(),r=R(n,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,t);if(!r.success)return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] conditional quote mode decode failed"]))),{remainder:e,result:null,success:!1};if(r.result!=null||s(0,47923),r.remainder[0]==="@"){var a=E(r.remainder,r.result,t);return{remainder:a.remainder,result:a.result,success:a.success}}var i=r.result,l=r.remainder.trimLeft();if(l.startsWith("<")){var u=E(l.substring(1),void 0,t),c=u.result,_=u.remainder;if(u.success&&c!=null&&_.startsWith(">"))return i.length===0?{remainder:_.substring(1),result:c,success:!0}:{remainder:_.substring(1),result:babelHelpers.extends({},c,{displayName:i}),success:!0}}return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echoDecodeAddress failed"]))),{remainder:e,result:null,success:!1}}function E(e,t,n){var r=t==null?e.trimLeft():e,a=t;if(a==null){var i=R(r,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,n);if(!i.success)return o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] parse localKey in address failed"]))),{remainder:e,result:null,success:!1};a=i.result,r=i.remainder}if(a==null||a.length===0||r[0]!=="@")return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid localKey in address detected"]))),{remainder:e,result:null,success:!1};var l=R(r.substring(1),"never",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,n),s=l.result;return l.success&&s!=null&&s.length>0?{remainder:l.remainder,result:{localKey:a,transportKey:s},success:!0}:(o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid transportKey in address detected"]))),{remainder:e,result:null,success:!1})}function k(e,t){if(e.length===0)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddressList detected"]))),{result:null,success:!1};var n=L(e,t);if(!n.success)return o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Address  decode failed with value: ",""])),e),{result:null,success:!1};n.result!=null||s(0,47927);for(var r=[n.result],a=n.remainder;a.startsWith(",");){var i=L(a.substring(1).trimLeft(),t);if(i.success)i.result!=null&&r.push(i.result),a=i.remainder;else break}return{result:r,success:!0}}function I(e){var t=new Map,n=e.split("\r\n");return n.length===1&&n[0]===e?(o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail to decode if the input string does not have CRLF"]))),t):(n.forEach(function(e){return S(e,t)}),t)}function T(e,t){var n=e.get(t);if(n==null||n.length===0||n==='""')return{result:null,success:!1};var r=R(n,"conditional",v,t),o=r.result,a=r.success;return{result:o,success:a}}function D(e,t){var n,r=x(e,t);return{result:(n=r.result)!=null?n:0,success:r.success}}function x(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=parseInt(n,10);return isNaN(r)?(o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] "," not a valid number in echo message"])),t),{result:null,success:!1}):Number.isSafeInteger(r)?{result:r,success:!0}:{result:r>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,success:!0}}function $(e,t){var n,r=P(e,t);return{result:(n=r.result)!=null?n:!1,success:r.success}}function P(e,t){var n=x(e,t);return!n.success||n.result!==0&&n.result!==1?{result:null,success:!1}:{result:n.result===1,success:!0}}function N(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=L(n,t),o=r.result,a=r.success;return{result:o,success:a}}function M(e,t){var n=e.get(t);return n==null||n.length===0?{result:null,success:!1}:k(n,t)}function w(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=n.split(",").map(function(e){return e.trim()}).filter(Boolean);return r.length===0?{result:null,success:!1}:{result:r,success:!0}}l.echoDecodeFields=I,l.echoDecodeStringField=T,l.echoDecodeIntField=D,l.echoDecodeNullableIntField=x,l.echoDecodeBooleanField=$,l.echoDecodeNullableBooleanField=P,l.echoDecodeAddressField=N,l.echoDecodeAddressListField=M,l.echoDecodeObjectIdListField=w}),98);
__d("EchoEncodingUtils",["EchoConstants","EchoMessage","FBLogger","MAWMsgType","WABase64"],(function(t,n,r,o,a,i,l){"use strict";var e=new Set(['"',"\\","\n","\r","\0"]),s=new Set(["\0","","","","","","","\x07","\b","	","\n","\v","\f","\r","","","","","","","","","","","","","","\x1B","","","","",'"',"\\"]);function u(e,t){for(var n of t)if(e.indexOf(n)>=0)return!0;return!1}function c(t,n,o){if(o===void 0&&(o=new Set),t.length<=0)throw r("FBLogger")("wmi_eb").mustfixThrow("The input string must be non-empty");var a=n;if(n==="conditional"&&(u(t,o)?a="always":a="never"),a==="never")return t;for(var i='"',l=0;l<t.length;l++){var s=t[l];e.has(s)?(i+="\\",s==="\r"?i+="r":s==="\n"?i+="n":i+=s):i+=s}return i+'"'}function d(e){if(!Number.isSafeInteger(e))throw r("FBLogger")("wmi_eb").mustfixThrow("The input value must be a safe integer");return e.toString()}function m(e){var t="",n=e.displayName,r=e.localKey,a=e.transportKey;return n!=null&&n.length>0&&(t+=c(n,"always")+" <"),t+=c(r,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE)+"@"+a,n!=null&&n.length>0&&(t+=">"),t}function p(e,t,n){n!=null&&n.length!==0&&e.set(t,c(n,"conditional",s))}function _(e,t,n){if(n!=null){var r=d(n);p(e,t,r)}}function f(e,t,n){if(n!=null){var r=d(n?1:0);p(e,t,r)}}function g(e,t,n){n!=null&&e.set(t,m(n))}function h(e,t,n){if(n!=null){var r="";n.forEach(function(e,t){r+=m(e),t<n.length-1&&(r+=", ")}),e.set(t,r)}}function y(e){var t="";return e.forEach(function(e,n){t=t+n+": "+e+"\r\n"}),t}function C(e){return o("WABase64").encodeB64UrlSafe(e)}function b(e){switch(e){case o("MAWMsgType").MSG_TYPE.TEXT:return o("EchoMessage").EchoXMessageContentType.TEXT;case o("MAWMsgType").MSG_TYPE.IMAGE:return o("EchoMessage").EchoXMessageContentType.IMAGE;case o("MAWMsgType").MSG_TYPE.VIDEO:return o("EchoMessage").EchoXMessageContentType.VIDEO;case o("MAWMsgType").MSG_TYPE.PTT:return o("EchoMessage").EchoXMessageContentType.AUDIO;case o("MAWMsgType").MSG_TYPE.STICKER:return o("EchoMessage").EchoXMessageContentType.STICKER;case o("MAWMsgType").MSG_TYPE.GIF:return o("EchoMessage").EchoXMessageContentType.GIF;case o("MAWMsgType").MSG_TYPE.XMA:return o("EchoMessage").EchoXMessageContentType.XMA;case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("EchoMessage").EchoXMessageContentType.DOCUMENT;case o("MAWMsgType").MSG_TYPE.REACTION:return o("EchoMessage").EchoXMessageContentType.REACTION;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("EchoMessage").EchoXMessageContentType.EPHEMERAL_SETTINGS;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return o("EchoMessage").EchoXMessageContentType.EPHEMERAL_SYNC_RESPONSE;case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return o("EchoMessage").EchoXMessageContentType.MESSAGE_DELETE_FOR_ME;case o("MAWMsgType").MSG_TYPE.REVOKED:return o("EchoMessage").EchoXMessageContentType.UNSEND;case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return o("EchoMessage").EchoXMessageContentType.GROUP_INVITES;case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return o("EchoMessage").EchoXMessageContentType.BUMP;default:return o("EchoMessage").EchoXMessageContentType.UNKNOWN}}l.echoSetStringField=p,l.echoSetIntField=_,l.echoSetBooleanField=f,l.echoSetAddressField=g,l.echoSetAddressListField=h,l.echoEncodeFields=y,l.convertMediaKeyToString=C,l.convertDbMsgTypeToXMessageContentType=b}),98);
__d("EchoMessage",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","EchoMessageMediaFieldUtils","EchoMessageMediaGroupFieldUtil","EchoMessageQuoteFieldUtils","EchoMessageReceiptStatusFieldUtils","EchoMessageXMAFieldUtils","FBLogger","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f="Message-ID",g="Thread-ID",h="Sort-Order",y="Display-Timestamp",C="Authoritative-Timestamp",b="From",v="Text",S="Text-Size",R="Send-Error",L="Is-Tombstoned",E="Expire-Timestamp",k="Delete-Timestamp",I="Ephemeral-Duration",T="Message-Content-Type",D="X-Message-Content-Type",x="Message-Content-Subtype",$="Is-Forwarded",P="X-Offline-Threading-ID",N="X-Thread-ID",M="X-Message-Placeholder-Type",w="Reactions",A="Reaction-Authoritative-Timestamps",F="X-Reaction-Offline-Threading-IDs",O="Echo-Serialization-Origin",B="Revoke-Sent-Timestamp",W="Revoke-Unsent-Timestamp",q="Edit-Count",U="Edit-Contents-",V="Edit-Timestamps-",H="Group-ID",G="Group-Index",z="Group-Size",j="Receiver-Fetch-Id",K="Message-Ephemerality-Type",Q=1,X=(_=n("$InternalEnum"))({NONE:"none",SMALL:"small",MEDIUM:"medium",LARGE:"large"}),Y=_({NONE:"none",UNSEND:"unsend"}),J=_({DECRYPTION_FAILURE:"decryption_failure",UNSUPPORTED_NEEDS_UPDATE:"unsupported_needs_update",TEXT:"text",ADMIN_MESSAGE:"admin_message",MEDIA:"media",XMA:"xma",NULL_STATE:"null_state",PLACEHOLDER:"placeholder"}),Z=_({UNKNOWN:"unknown",TEXT:"text",IMAGE:"image",VIDEO:"video",AUDIO:"audio",STICKER:"sticker",GIF:"gif",URL:"url",EPHEMERAL_SETTINGS:"ephemeral_settings",LOCATION:"location",DOCUMENT:"document",UNSEND:"unsend",SCREENSHOT_ACTION:"screenshot_action",REACTION:"reaction",XMA:"xma",VISUAL_MESSAGE_VIDEO:"visual_message_video",VISUAL_MESSAGE_IMAGE:"visual_message_image",VISUAL_MESSAGE_ACTION:"visual_message_action",SCREEN_RECORDING_ACTION:"screen_recording_action",MESSAGE_DELETE_FOR_ME:"message_delete_for_me",ENCRYPTED_BACKUP_NEW_DEVICE_ENROLLMENT:"encrypted_backup_new_device_enrollment",SENDER_KEY:"sender_key",DELETE_THREAD:"delete_thread",READ_THREAD:"read_thread",UNREAD_THREAD:"unread_thread",REACTION_UNSEND:"reaction_unsend",GROUP_INVITES:"group_invites",EPHEMERAL_SYNC_RESPONSE:"ephemeral_sync_response",BUMP:"bump"}),ee=_({NO_PLACEHOLDER:"0",DECRYPTION_FAILURE:"-1",CLIENT_NOT_SUPPORTED_NEED_UPDATE:"-2",UNAVIALABLE_DEVICE:"-3"}),te=_({UNKNOWN:"Unknown",WEB:"Web",MOBILE:"Mobile"});function ne(e){var t=new Map;return de(t,e),"mediaData"in e&&e.mediaData&&o("EchoMessageMediaFieldUtils").echoMessageSetMediaMetadataFields(t,e.mediaData),o("EchoEncodingUtils").echoEncodeFields(t)}function re(e,t){var n,r=[],a=0,i=new Set;return t.forEach(function(n,a,l){var s=a.startsWith(U),u=a.startsWith(V);if(s||u){var c=a.slice(s?U.length:V.length);if(!i.has(c)){var d,m;i.add(c);var p=(d=o("EchoDecodingUtils").echoDecodeStringField(t,""+U+c).result)!=null?d:"",_=((m=o("EchoDecodingUtils").echoDecodeIntField(t,""+V+c).result)!=null?m:0)/1e3;r.push({messageId:c,originalMessageId:e,text:p,timestamp:_})}}}),a=(n=o("EchoDecodingUtils").echoDecodeIntField(t,q).result)!=null?n:0,{editCount:a,editHistory:r}}function oe(t){var n=o("EchoDecodingUtils").echoDecodeFields(t);if(n.size===0)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fieldsMap is empty for the echo message"]))),null;var a=o("EchoDecodingUtils").echoDecodeStringField(n,f),i=o("EchoDecodingUtils").echoDecodeStringField(n,g),l=o("EchoDecodingUtils").echoDecodeIntField(n,h),_=o("EchoDecodingUtils").echoDecodeIntField(n,y),q=o("EchoDecodingUtils").echoDecodeStringField(n,T),U=o("EchoDecodingUtils").echoDecodeStringField(n,D),V=o("EchoDecodingUtils").echoDecodeStringField(n,x);if(a.success&&i.success&&l.success){var H=a.result;if(H==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded messageId cannot be null");var G=i.result;if(G==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded threadId cannot be null");var z=q==null?void 0:q.result;if(z==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded contentTypeString cannot be null");var X=re(H,n),Z=X.editCount,ee=X.editHistory,te={contentSubtype:se(V.result),contentType:ie(z),displayTimestampMs:_.success?_.result:l.result,editCount:Z,editHistory:ee,messageId:H,sortOrderMs:l.result,threadId:G},ne=le(U.result);ne!=null&&(te.xContentType=ne);var oe=o("EchoDecodingUtils").echoDecodeAddressField(n,b);oe.success&&oe.result!=null&&(te.from=oe.result);var de=o("EchoDecodingUtils").echoDecodeNullableBooleanField(n,L);de.success&&de.result!=null&&(te.isTombstoned=de.result);var me=o("EchoDecodingUtils").echoDecodeStringField(n,v);me.success&&me.result!=null&&(te.text=me.result);var pe=o("EchoDecodingUtils").echoDecodeStringField(n,S);if(pe.success&&pe.result!=null){var _e=ae(pe.result);te.textSize=_e}var fe=o("EchoDecodingUtils").echoDecodeStringField(n,M);if(fe.success&&fe.result!=null){var ge=ue(fe.result);te.xMessagePlaceholderType=ge}var he=o("EchoDecodingUtils").echoDecodeStringField(n,R);he.success&&he.result!=null&&(te.sendError=he.result);var ye=o("EchoDecodingUtils").echoDecodeNullableIntField(n,E);ye.success&&ye.result!=null&&(te.expireTimestampMs=ye.result);var Ce=o("EchoDecodingUtils").echoDecodeNullableIntField(n,k);Ce.success&&Ce.result!=null&&(te.deleteTimestampMs=Ce.result);var be=o("EchoDecodingUtils").echoDecodeNullableIntField(n,I);be.success&&be.result!=null&&(te.ephemeralDurationInSec=be.result);var ve=o("EchoDecodingUtils").echoDecodeStringField(n,K);ve.success&&ve.result!=null&&ve.result==="view_once"&&(te.viewOnce=!0);var Se=o("EchoDecodingUtils").echoDecodeNullableIntField(n,C);Se.success&&Se.result!=null&&(te.authoritativeTimestampMs=Se.result);var Re=o("EchoMessageReceiptStatusFieldUtils").echoMessageDecodeReceiptStatusDataFields(n);Re.length>0&&(te.receiptStatusList=Re);var Le=o("EchoDecodingUtils").echoDecodeNullableBooleanField(n,$);Le.success&&Le.result!=null&&(te.isForwarded=Le.result),o("EchoMessageMediaGroupFieldUtil").decodeMessageMediaGroupFields(n,te);var Ee=o("EchoDecodingUtils").echoDecodeStringField(n,P);Ee.success&&Ee.result!=null&&(te.xOfflineThreadingId=Ee.result);var ke=o("EchoDecodingUtils").echoDecodeStringField(n,N);ke.success&&ke.result!=null&&(te.xThreadId=ke.result);var Ie=o("EchoDecodingUtils").echoDecodeStringField(n,O);Ie.success&&Ie.result!=null&&(te.serializationOrigin=ce(Ie.result));var Te=o("EchoDecodingUtils").echoDecodeNullableIntField(n,o("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION);te.version=Te.success&&Te.result!=null?Te.result:Q;var De=o("EchoDecodingUtils").echoDecodeAddressListField(n,w);De.success&&De.result!=null&&(te.reactions=De.result);var xe=o("EchoDecodingUtils").echoDecodeAddressListField(n,A);xe.success&&xe.result!=null&&(te.reactionAuthoritativeTimestampMs=xe.result);var $e=o("EchoDecodingUtils").echoDecodeAddressListField(n,F);$e.success&&$e.result!=null&&(te.reactionXOfflineThreadingIds=$e.result);var Pe=o("EchoMessageQuoteFieldUtils").echoMessageDecodeQuoteFields(n);Pe!=null&&(te.quoteData=Pe);var Ne=(te==null?void 0:te.contentType)===J.XMA&&n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE)&&(n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID)||n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS)),Me=n.has(j);if(n.has(j)){var we=o("EchoMessageMediaFieldUtils").decodeReceiverFetchData(n),Ae=o("EchoDecodingUtils").echoDecodeStringField(n,j),Fe=Ae.result,Oe=Ae.success;we==null||!Oe||Fe==null?o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode media data for Receiver Fetch, Message origin: ",""])),te.serializationOrigin):(te.receiverFetchData=we,te.receiverFetchId=Fe)}if(((te==null?void 0:te.contentType)===J.MEDIA||Ne)&&!Me){var Be=o("EchoMessageMediaFieldUtils").echoMessageDecodeMediaDataFields(n,te==null?void 0:te.contentType,te==null?void 0:te.xContentType),We="[labyrinth_web] mandatory media data is missing from media message, msgId: "+te.messageId+".";Be!=null?(Be.length!==1&&Be.length!==2&&((te==null?void 0:te.contentType)===J.MEDIA&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin),(te==null?void 0:te.contentType)===J.XMA&&o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin)),te.mediaData=Be[0],Be.length===2&&(te.previewMediaData=Be[1])):((te==null?void 0:te.contentType)===J.MEDIA&&o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin),(te==null?void 0:te.contentType)===J.XMA&&o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin))}if(te.contentType===J.PLACEHOLDER&&te.contentSubtype===Y.UNSEND){var qe=o("EchoDecodingUtils").echoDecodeNullableIntField(n,B);qe.success&&qe.result!=null&&(te.revokeSentTimestampMs=qe.result);var Ue=o("EchoDecodingUtils").echoDecodeNullableIntField(n,W);Ue.success&&Ue.result!=null&&(te.revokeUnsentTimestampMS=Ue.result)}if(te.contentType===J.XMA){var Ve=o("EchoMessageXMAFieldUtils").decodeXMAFields(n);if(Ve!=null)te.xmaData=Ve;else return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory xma data is missing from xma message, msgId: ",""])),te.messageId),null}return te}else return null}function ae(e){var t;return(t=X.cast(e))!=null?t:X.NONE}function ie(e){var t;return(t=J.cast(e))!=null?t:J.TEXT}function le(e){return Z.cast(e)}function se(e){var t;return(t=Y.cast(e))!=null?t:Y.NONE}function ue(e){var t;return(t=ee.cast(e))!=null?t:ee.NO_PLACEHOLDER}function ce(e){var t;return(t=te.cast(e))!=null?t:te.UNKNOWN}function de(e,t){var n,r;(r=o("EchoEncodingUtils")).echoSetStringField(e,f,t.messageId),r.echoSetStringField(e,g,t.threadId),r.echoSetIntField(e,h,t.sortOrderMs),r.echoSetIntField(e,y,t.displayTimestampMs),r.echoSetIntField(e,C,t.authoritativeTimestampMs),r.echoSetAddressField(e,b,t.from),r.echoSetStringField(e,v,t.text),t.textSize!=null&&o("EchoEncodingUtils").echoSetStringField(e,S,t.textSize),t.xMessagePlaceholderType!=null&&o("EchoEncodingUtils").echoSetStringField(e,M,t.xMessagePlaceholderType),o("EchoEncodingUtils").echoSetStringField(e,R,t.sendError),o("EchoEncodingUtils").echoSetBooleanField(e,L,t.isTombstoned),o("EchoEncodingUtils").echoSetIntField(e,E,t.expireTimestampMs),o("EchoEncodingUtils").echoSetIntField(e,k,t.deleteTimestampMs),o("EchoEncodingUtils").echoSetIntField(e,I,t.ephemeralDurationInSec),t.contentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,T,t.contentType),t.xContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,D,t.xContentType),o("EchoMessageReceiptStatusFieldUtils").echoMessageSetReceiptStatusDataFields(e,t.receiptStatusList),o("EchoEncodingUtils").echoSetBooleanField(e,$,t.isForwarded),o("EchoEncodingUtils").echoSetStringField(e,P,t.xOfflineThreadingId),o("EchoEncodingUtils").echoSetStringField(e,N,t.xThreadId),o("EchoEncodingUtils").echoSetIntField(e,o("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION,t.version),t.contentSubtype!=null&&o("EchoEncodingUtils").echoSetStringField(e,x,t.contentSubtype),o("EchoEncodingUtils").echoSetAddressListField(e,w,t.reactions),o("EchoEncodingUtils").echoSetAddressListField(e,A,t.reactionAuthoritativeTimestampMs),o("EchoEncodingUtils").echoSetAddressListField(e,F,t.reactionXOfflineThreadingIds),o("EchoMessageQuoteFieldUtils").echoMessageSetQuoteFields(e,t),t.serializationOrigin!=null&&o("EchoEncodingUtils").echoSetStringField(e,O,t.serializationOrigin),t.revokeSentTimestampMs!=null&&o("EchoEncodingUtils").echoSetIntField(e,B,t.revokeSentTimestampMs),t.revokeUnsentTimestampMS!=null&&o("EchoEncodingUtils").echoSetIntField(e,W,t.revokeUnsentTimestampMS),o("EchoMessageMediaGroupFieldUtil").echoMessageSetMediaGroupFields(e,t);var a=t.xmaData;a!=null&&o("EchoMessageXMAFieldUtils").echoMessageSetXMAFields(e,a),((n=t.editHistory)==null?void 0:n.length)>0&&(o("EchoEncodingUtils").echoSetIntField(e,q,t.editCount),t.editHistory.forEach(function(t){var n=t.messageId;n!=null&&(o("EchoEncodingUtils").echoSetStringField(e,U+n,t.text),o("EchoEncodingUtils").echoSetIntField(e,V+n,t.timestamp*1e3))})),t.receiverFetchId!=null&&o("EchoEncodingUtils").echoSetStringField(e,j,t.receiverFetchId)}l.ECHO_SERIALIZATION_ORIGIN=O,l.ECHO_MESSAGE_FIELD_NAME_EDIT_COUNT=q,l.ECHO_MESSAGE_FIELD_NAME_EDIT_CONTENT_PREFIX=U,l.ECHO_MESSAGE_FIELD_NAME_EDIT_TS_PREFIX=V,l.ECHO_MESSAGE_FIELD_GROUP_ID=H,l.ECHO_MESSAGE_FIELD_GROUP_INDEX=G,l.ECHO_MESSAGE_FIELD_GROUP_SIZE=z,l.ECHO_MESSAGE_FIELD_RECEIVER_FETCH_ID=j,l.ECHO_MESSAGE_FIELD_NAME_EPHEMERALITY_TYPE=K,l.ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION=Q,l.MessageTextSize=X,l.EchoMessageContentSubtype=Y,l.EchoMessageContentType=J,l.EchoXMessageContentType=Z,l.EchoMessagePlaceholderType=ee,l.EchoSerializationOriginType=te,l.encodeEchoMessage=ne,l.decodeEchoMessage=oe}),98);
__d("EchoMessageMediaFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","EchoMessage","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R="X-Object-Id",L="X-Attachment-Object-Ids",E="Attachment-Type",k="Content-Type",I="X-Encrypted-Hash",T="X-Attachment-Type",D="X-Backup-Ent-Fbid",x="X-Backup-Status",$="X-Content-Type",P="X-Direct-Path",N="Height",M="X-Media-Key",w="X-Media-Key-Timestamp",A="Playable-Duration",F="Preview-Height",O="Preview-Content-Type",B="Preview-Width",W="Size",q="Width",U="X-Plaintext-Hash",V="File-Name",H="Header-Attribution-Content-Type",G=(S=n("$InternalEnum"))({IMAGE:"image",STICKER:"sticker",VIDEO:"video",GIF:"animated_image",PTT:"audio",XMA:"xma",DOCUMENT:"document"}),z=S({IMAGE_JPEG:"image/jpeg",IMAGE_PNG:"image/png",STICKER:"image/webp",GIF:"image/gif",AUDIO_MP4:"audio/mp4",AUDIO_WAV:"audio/wav",XMA:"xma"}),j=S({INVALID:"-1",IMAGE:"0",PTT:"1",AUDIO:"2",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",PROFILE_PICTURE:"7",APP_STATE:"8",HISTORY_SYNC:"9",THUMBNAIL_IMAGE:"10",THUMBNAIL_VIDEO:"11",THUMBNAIL_GIF:"12",THUMBNAIL_DOCUMENT:"13",THUMBNAIL_LINK:"14",NOVI_IMAGE:"15",NOVI_VIDEO:"16",KYCID:"17",WAFFLE_IMAGE:"18",WAFFLE_VIDEO:"19",WAFFLE_GIF:"20",PAYMENT_BG_IMAGE:"21",XMA_IMAGE:"22",PAYMENT_BR_DOCUMENT:"23",BIZ_COVER_PHOTO:"24",MESSENGER_PREVIEW:"25"}),K=S({FULL:"full",PREVIEW:"preview"});function Q(t,n){var r=t.attachmentObjectId,a=t.attachmentType,i=t.backupEntFbid,l=t.directPath,p=t.filename,_=t.encryptedHash,f=t.height,g=t.mediaBackupStatus,h=t.mediaContentType,y=t.mediaKey,C=t.mediaKeyTimestamp,b=t.mediaPlayableDuration,v=t.plaintextHash,S=t.previewContentHeight,R=t.previewContentType,L=t.previewContentWidth,E=t.size,k=t.width,I=t.xAttachmentType,T=t.xContentType,D=t.xmaData,x=t.mediaEntryData;if(r==null)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment object id from required media metadata fields, msgId: ",""])),n);else if(a==null)o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment type from required media metadata fields, msgId: ",""])),n);else if(l==null)o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing direct path field from required media metadata fields, msgId: ",""])),n);else if(v==null)o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing plaintextHash field from required media metadata fields, msgId: ",""])),n);else if(T==null)o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xContentType field from required media metadata fields, msgId: ",""])),n);else if(I==null)o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xAttachmentType field from required media metadata fields, msgId: ",""])),n);else return{attachmentObjectId:r,attachmentType:a,backupEntFbid:i,directPath:l,encryptedHash:_,filename:p,height:f,mediaBackupStatus:g,mediaContentType:h,mediaEntryData:x,mediaKey:y,mediaKeyTimestamp:C,mediaPlayableDuration:b,plaintextHash:v,previewContentHeight:S,previewContentType:R,previewContentWidth:L,size:E,width:k,xAttachmentType:I,xContentType:T,xmaData:D}}function X(e,t){var n;(n=o("EchoEncodingUtils")).echoSetStringField(e,R,t.attachmentObjectId),n.echoSetStringField(e,E,t.attachmentType),n.echoSetStringField(e,U,t.plaintextHash),n.echoSetStringField(e,I,t.encryptedHash),n.echoSetIntField(e,W,t.size),n.echoSetStringField(e,M,t.mediaKey),n.echoSetIntField(e,w,t.mediaKeyTimestamp),n.echoSetStringField(e,P,t.directPath),t.mediaContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,k,t.mediaContentType),o("EchoEncodingUtils").echoSetIntField(e,q,t.width),o("EchoEncodingUtils").echoSetIntField(e,N,t.height),t.previewContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,O,t.previewContentType),t.headerAttributionContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,H,t.headerAttributionContentType),o("EchoEncodingUtils").echoSetIntField(e,B,t.previewContentWidth),o("EchoEncodingUtils").echoSetIntField(e,F,t.previewContentHeight),o("EchoEncodingUtils").echoSetIntField(e,A,t.mediaPlayableDuration),t.xAttachmentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,T,t.xAttachmentType),o("EchoEncodingUtils").echoSetStringField(e,$,t.xContentType),o("EchoEncodingUtils").echoSetStringField(e,D,t.backupEntFbid),o("EchoEncodingUtils").echoSetStringField(e,x,t.mediaBackupStatus),o("EchoEncodingUtils").echoSetStringField(e,V,t.filename)}function Y(e,t,n){var r={},a=!1,i=!1,l=!1;if(ne(e)){var s=re(e,t,n);if(s==null)return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: primary attachment object id is null. msgType: "," mediaType: ",""])),t,n),null;s.length!==2&&o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to get primary and secondary attachment object ids"])));var u=!1,c=!1,d=!1,m=s[0],f=s[1],g={};if(a=ee(e,r,m),u=ee(e,g,f),i=Z(e,r,t,m,m),c=Z(e,g,t,f,m),l=J(e,r,m),d=J(e,g,f),!a||!i||!l||!u||!c||!d)return null;var h=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,y=Q(r,h),C=Q(g,h);if(y!=null&&C!=null)return[y,C]}else{if(a=ee(e,r),i=Z(e,r,t),l=J(e,r),!a||!i||!l)return null;var b=Q(r);if(b!=null)return[b]}return null}function J(e,t,n){var r,a=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,i=(r=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?r:"",l=[{fieldName:"height",id:N},{fieldName:"width",id:q},{fieldName:"size",id:W},{fieldName:"previewContentHeight",id:F},{fieldName:"previewContentWidth",id:B},{fieldName:"mediaKeyTimestamp",id:n!=null?n+"-"+w:w}],s=[{attachmentTypes:[j.VIDEO,j.AUDIO],fieldName:"mediaPlayableDuration",id:A}];for(var u of s){var c=u.attachmentTypes,d=u.fieldName,m=u.id,p=o("EchoDecodingUtils").echoDecodeIntField(e,m),_=p.result,g=p.success;if(g&&_!=null)t[d]=_;else if(!(t.xAttachmentType!=null&&!te(c,t.xAttachmentType)||t.attachmentType===G.XMA))return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. xAttachmentType: ",", AttachmentType: ",". EchoOrigin: "," xOfflineThreadingId: ",""])),d,t.xAttachmentType,t.attachmentType,i,a),!1}return l.map(function(n){var r=n.fieldName,a=n.id,i=o("EchoDecodingUtils").echoDecodeIntField(e,a),l=i.result,s=i.success;s&&l!=null&&(t[r]=l)}),!0}function Z(e,t,n,r,a){var i,l=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,s,u,c,d=(i=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?i:"",m=[{fieldName:"filename",id:V}];r!=null&&a!=null?(t.attachmentObjectId=r,s=[{fieldName:"plaintextHash",id:r+"-"+U},{fieldName:"directPath",id:r+"-"+P},{fieldName:"xContentType",id:r+"-"+$}],m.push({fieldName:"mediaKey",id:r+"-"+M}),u=a+"-"+D,c=r+"-"+I):(s=[{fieldName:"attachmentObjectId",id:R},{fieldName:"plaintextHash",id:U},{fieldName:"directPath",id:P},{fieldName:"xContentType",id:$}],m.push({fieldName:"mediaKey",id:M}),u=D,c=I),m.push({fieldName:"backupEntFbid",id:u}),m.push({fieldName:"mediaContentType",id:k}),m.push({fieldName:"encryptedHash",id:c});var p=a!=null?a+"-"+x:x;m.push({fieldName:"mediaBackupStatus",id:p});var _=[];for(var f of s){var y=f.fieldName,C=f.id,b=o("EchoDecodingUtils").echoDecodeStringField(e,C),v=b.result,S=b.success;S&&v!=null?t[y]=v:_.push(y)}if(_.length>0){var L=_.join(", ");return n===o("EchoMessage").EchoMessageContentType.XMA?o("WALogger").WARN(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: ",""])),L,t.attachmentType,d):o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""])),L,t.attachmentType,d,l),!1}return m.map(function(n){var r=n.fieldName,a=n.id,i=o("EchoDecodingUtils").echoDecodeStringField(e,a),l=i.result,s=i.success;s&&l!=null&&(t[r]=l)}),!0}function ee(e,t,n){var r,a=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,i=(r=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?r:"",l=o("EchoDecodingUtils").echoDecodeStringField(e,E),s=l.result==="file"?G.DOCUMENT:G.cast(l.result);s!=null&&(t.attachmentType=s);var u=o("EchoDecodingUtils").echoDecodeStringField(e,O),c=z.cast(u.result);c!=null&&(t.previewContentType=c);var d=o("EchoDecodingUtils").echoDecodeStringField(e,H),m=d.result;m!=null&&(t.headerAttributionContentType=m);var p=o("EchoDecodingUtils").echoDecodeStringField(e,n!=null?n+"-"+T:T),_=null;return p.success&&p.result!=null&&(_=oe(p.result),_!=null&&(t.xAttachmentType=_)),s!=null&&(c!=null||s===G.DOCUMENT||s===G.PTT)?!0:(o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing enum fields from media fields: attachmentType: "," mediaPreviewContentType: "," mediaAttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""])),s,c,p,i,a),!1)}function te(e,t){return e.reduce(function(e,n){return e||n===t},!1)}function ne(e){return e.has(L)}function re(e,t,n){var r=o("EchoDecodingUtils").echoDecodeObjectIdListField(e,L),a=r.result,i=r.success;if(!i||a==null||a.length!==2)return o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: can not parse objects ids. "," msgType: "," mediaType: ",""])),a,t,n),null;var l=a.find(function(t){var n=t+"-"+x,r=o("EchoDecodingUtils").echoDecodeStringField(e,n),a=r.result,i=r.success;if(i&&a!=null)return!0});if(l!=null){var s=l===a[0]?a[1]:a[0];return[l,s]}if(l=a.find(function(t){var n=t+"-"+$,r=o("EchoDecodingUtils").echoDecodeStringField(e,n),a=r.result,i=r.success;if(i&&a!=null&&K.cast(a)===K.FULL)return!0}),l!=null){var u=l===a[0]?a[1]:a[0];return[l,u]}return a}function oe(e){var t=j.cast(e);return t==null&&o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid media attachment type: ",""])),e),t!=null?t:j.INVALID}function ae(e){var t={},n=ee(e,t);if(!n)return null;var r=o("EchoDecodingUtils").echoDecodeStringField(e,k),a=o("EchoDecodingUtils").echoDecodeIntField(e,N),i=o("EchoDecodingUtils").echoDecodeIntField(e,q),l=o("EchoDecodingUtils").echoDecodeStringField(e,E);return!r.success||!a.success||!i.success||!l.success||r.result==null||a.result==null||i.result==null||l.result==null?(o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing media fields for receiver fetch"]))),null):{mimetype:r.result,previewHeight:a.result,previewWidth:i.result,type:l.result}}l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID=R,l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS=L,l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE=E,l.AttachmentType=G,l.EchoMessageMediaPreviewType=z,l.EchoMessageActMediaAttachmentType=j,l.convertMediaMetadataDetailsToMediaMetadata=Q,l.echoMessageSetMediaMetadataFields=X,l.echoMessageDecodeMediaDataFields=Y,l.setMediaIntFields=J,l.setMediaEnumFields=ee,l.getAttachmentObjectIdsFromMultiBlobMediaMsg=re,l.decodeReceiverFetchData=ae}),98);
__d("EchoMessageMediaGroupFieldUtil",["EchoDecodingUtils","EchoEncodingUtils","EchoMessage"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){t.groupId!=null&&o("EchoEncodingUtils").echoSetStringField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID,t.groupId),t.groupIndex!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX,t.groupIndex),t.groupSize!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE,t.groupSize)}function s(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID);n.success&&n.result!=null&&(t.groupId=n.result);var r=o("EchoDecodingUtils").echoDecodeIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX);r.success&&r.result!=null&&(t.groupIndex=r.result);var a=o("EchoDecodingUtils").echoDecodeIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE);a.success&&a.result!=null&&(t.groupSize=a.result)}l.echoMessageSetMediaGroupFields=e,l.decodeMessageMediaGroupFields=s}),98);
__d("EchoMessageQuoteFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils"],(function(t,n,r,o,a,i,l){"use strict";var e="Reply-Message-Id",s="Reply-Message-Sender",u="Reply-Sort-Order",c="Reply-Type",d="Reply-Status",m=n("$InternalEnum").Mirrored(["BUMP"]),p=n("$InternalEnum")({VALID:"valid"});function _(e){var t={quoteMessageId:"<not set>",quoteMessageSender:{localKey:"<not set>",transportKey:"<not set>"},quoteSortOrderInMs:0},n=g(e,t),r=h(e,t),o=y(e,t),a=C(e,t);return!n||!r||!o||!a?null:t}function f(t,n){var r=n.quoteData;r!=null&&(o("EchoEncodingUtils").echoSetStringField(t,e,r.quoteMessageId),o("EchoEncodingUtils").echoSetAddressField(t,s,r.quoteMessageSender),o("EchoEncodingUtils").echoSetIntField(t,u,r.quoteSortOrderInMs),r.status!=null&&o("EchoEncodingUtils").echoSetStringField(t,d,r.status),r.replyType!=null&&o("EchoEncodingUtils").echoSetStringField(t,c,r.replyType))}function g(e,t){var n=[{fieldName:"quoteMessageSender",id:s}];for(var r of n){var a=r.fieldName,i=r.id,l=o("EchoDecodingUtils").echoDecodeAddressField(e,i),u=l.result,c=l.success;if(c&&u!=null)t[a]=u;else return!1}return!0}function h(t,n){var r=[{fieldName:"quoteMessageId",id:e}];for(var a of r){var i=a.fieldName,l=a.id,s=o("EchoDecodingUtils").echoDecodeStringField(t,l),u=s.result,c=s.success;if(c&&u!=null)n[i]=u;else return!1}return!0}function y(e,t){var n=[{fieldName:"quoteSortOrderInMs",id:u}];for(var r of n){var a=r.fieldName,i=r.id,l=o("EchoDecodingUtils").echoDecodeIntField(e,i),s=l.result,c=l.success;if(c&&s!=null)t[a]=s;else return!1}return!0}function C(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,c),r=m.cast(n.result);r!=null&&(t.replyType=r);var a=o("EchoDecodingUtils").echoDecodeStringField(e,d),i=p.cast(a.result);return i!=null&&(t.status=i),!0}l.EchoMessageQuoteReplyType=m,l.EchoMessageQuoteStatus=p,l.echoMessageDecodeQuoteFields=_,l.echoMessageSetQuoteFields=f}),98);
__d("EchoMessageReceiptStatusFieldUtils",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s="Receipt-Status",u="Receipt-Timestamp",c=n("$InternalEnum")({UNKNOWN:"unknown",SENDING:"sending",SERVER_RECEIVED:"server_received",DELIVERED:"delivered",READ:"read",ERROR:"error",NON_RETRYABLE_ERROR:"non_retryable_error"});function d(e,t){t==null||t.length===0||t.forEach(function(t){o("EchoEncodingUtils").echoSetStringField(e,o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(t.address,s),t.status),t.timestampMs!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(t.address,u),t.timestampMs)})}function m(e){var t=[];return p(e).forEach(function(n){var r=o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(n,s),a=o("EchoDecodingUtils").echoDecodeStringField(e,r);if(a.success){var i,l=(i=c.cast(a.result))!=null?i:c.UNKNOWN,d=o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(n,u),m=o("EchoDecodingUtils").echoDecodeNullableIntField(e,d);m.result!=null?t.push({address:n,status:l,timestampMs:m.result}):t.push({address:n,status:l})}}),t}function p(t){var n=new Set;for(var r of t.keys())if(r.includes(s))try{var a=r.split("@"),i=a[0],l=_(a[1]);n.add({localKey:i,transportKey:l})}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error occurred while decoding participants from echo doc, error: ",""])),t)}return Array.from(n)}function _(e){var t=e.split(s);return t[0].split("-")[0]}l.MessageReceiptStatus=c,l.echoMessageSetReceiptStatusDataFields=d,l.echoMessageDecodeReceiptStatusDataFields=m}),98);
__d("EchoMessageXMAFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="XMA-Default-CTA",m="XMA-Gating-Type",p="XMA-Header-Subtitle",_="XMA-Header-Title",f="XMA-Is-Tombstoned",g="XMA-Layout-Type",h="XMA-Max-Subtitle-Num-Lines",y="XMA-Max-Title-Num-Lines",C="XMA-Subtitle-Text",b="XMA-Target-Expiry",v="XMA-Target-ID",S="XMA-Target-Type",R="XMA-Target-Username",L="XMA-Title-Text",E="XMA-Content-Ref",k="XMA-Dataclass",I=n("$InternalEnum").Mirrored(["SINGLE","HSCROLL","VSTACK","PORTRAIT","STANDARD_DXMA","LIST_DXMA","GRID"]),T=n("$InternalEnum").Mirrored(["NONE","IG_STORY_PHOTO_MENTION","IG_SINGLE_IMAGE_POST_SHARE","IG_MULTIPOST_SHARE","IG_SINGLE_VIDEO_POST_SHARE","IG_STORY_PHOTO_SHARE","IG_STORY_VIDEO_SHARE","IG_CLIPS_SHARE","IG_IGTV_SHARE","IG_SHOP_SHARE","IG_PROFILE_SHARE","IG_STORY_PHOTO_HIGHLIGHT_SHARE","IG_STORY_VIDEO_HIGHLIGHT_SHARE","IG_STORY_REPLY","IG_STORY_REACTION","FB_FEED_SHARE","FB_STORY_REPLY","FB_STORY_SHARE","FB_STORY_MENTION","FB_FEED_VIDEO_SHARE","FB_GAMING_CUSTOM_UPDATE","FB_PRODUCER_STORY_REPLY","FB_PROFILE_DIRECTORY_ITEM","FB_FEED_POST_REACTION_REPLY","MSG_EXTERNAL_LINK_SHARE","MSG_RECEIVER_FETCH","RTC_AUDIO_CALL","RTC_VIDEO_CALL","RTC_MISSED_AUDIO_CALL","RTC_MISSED_VIDEO_CALL","RTC_GROUP_AUDIO_CALL","RTC_GROUP_VIDEO_CALL","FB_EVENT","FB_SHORT","MSG_LOCATION_SHARING","MSG_LOCATION_SHARING_V2","MSG_MEMORIES_SHARE"]),D=n("$InternalEnum").Mirrored(["NONE","PRIVATE","SENSITIVE","MISINFORMATION","MEDIA_LABEL","POST_COVER","POST_LABEL","WARNING_SCREENS","INFO","EYE_OFF","NEWS_OFF","WARNING"]);function x(e,t){t.xmaLayoutType!=null&&o("EchoEncodingUtils").echoSetStringField(e,g,t.xmaLayoutType),t.xmaTargetType!=null&&o("EchoEncodingUtils").echoSetStringField(e,S,t.xmaTargetType),o("EchoEncodingUtils").echoSetStringField(e,R,t.xmaTargetUsername),o("EchoEncodingUtils").echoSetStringField(e,v,t.xmaTargetId),t.xmaTargetExpiry!=null&&o("EchoEncodingUtils").echoSetIntField(e,b,t.xmaTargetExpiry),o("EchoEncodingUtils").echoSetStringField(e,d,t.xmaDefaultCTA),o("EchoEncodingUtils").echoSetStringField(e,_,t.xmaHeaderTitle),o("EchoEncodingUtils").echoSetStringField(e,p,t.xmaHeaderSubtitle),o("EchoEncodingUtils").echoSetStringField(e,L,t.xmaTitleText),o("EchoEncodingUtils").echoSetStringField(e,C,t.xmaSubtitleText),t.xmaMaxTitleNumLines!=null&&o("EchoEncodingUtils").echoSetIntField(e,y,t.xmaMaxTitleNumLines),t.xmaMaxSubtitleNumLines!=null&&o("EchoEncodingUtils").echoSetIntField(e,h,t.xmaMaxSubtitleNumLines),t.xmaGatingType!=null&&o("EchoEncodingUtils").echoSetStringField(e,m,t.xmaGatingType),t.xmaDataclass!=null&&o("EchoEncodingUtils").echoSetStringField(e,k,t.xmaDataclass),o("EchoEncodingUtils").echoSetBooleanField(e,f,t.xmaIsTombstoned),t.xmaContentRef!=null&&o("EchoEncodingUtils").echoSetStringField(e,E,t.xmaContentRef)}function $(t){var n=M(t,f);if(n==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xmaIsTombstoned from xma fields"]))),null;var r=D.cast(o("EchoDecodingUtils").echoDecodeStringField(t,m).result),a=I.cast(o("EchoDecodingUtils").echoDecodeStringField(t,g).result),i=T.cast(o("EchoDecodingUtils").echoDecodeStringField(t,S).result);return{xmaContentRef:P(t,E),xmaDataclass:P(t,k),xmaDefaultCTA:P(t,d),xmaGatingType:r,xmaHeaderSubtitle:P(t,p),xmaHeaderTitle:P(t,_),xmaIsTombstoned:n,xmaLayoutType:a,xmaMaxSubtitleNumLines:N(t,h),xmaMaxTitleNumLines:N(t,y),xmaSubtitleText:P(t,C),xmaTargetExpiry:N(t,b),xmaTargetId:P(t,v),xmaTargetType:i,xmaTargetUsername:P(t,R),xmaTitleText:P(t,L)}}function P(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields"])),t)}function N(e,t){var n=o("EchoDecodingUtils").echoDecodeIntField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"])),t)}function M(e,t){var n=o("EchoDecodingUtils").echoDecodeBooleanField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"])),t)}l.XMALayoutType=I,l.XMAContentType=T,l.XMAGatingType=D,l.echoMessageSetXMAFields=x,l.decodeXMAFields=$}),98);
__d("SymmetricEncryptionCreateDecryptedData",["CryptoLogger","EncryptedBackupsSymmetricEncryptionUtils","HChaCha20","Promise","RetUtil","SymmetricEncryptionPaddingUtils","XPlatReactCrypto"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("CryptoLogger").CryptoLogger("symmetric_encryption_create_decrypted_data"),u=function(r,a,i){if(i.byteLength<o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes+o("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLengthInBytes)return s.mustfix("cipher text is invalid"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult());var t=new Uint8Array(i),l=t.slice(0,o("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes),u=new(o("HChaCha20")).HChaCha20,c=t.slice(o("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes).buffer,d=u.hChaCha20Bytes(l.slice(0,o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer,r);return o("XPlatReactCrypto").subtleImportKey("raw",d,"AES-GCM",!1,["decrypt"]).then(function(e){return o("XPlatReactCrypto").subtleDecrypt({additionalData:a,iv:new Uint8Array(l.slice(o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer),name:"AES-GCM",tagLength:o("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLength},e,c)}).then(function(e){var t=o("SymmetricEncryptionPaddingUtils").stripPadding(e);return t==null&&s.mustfix("Failed to strip padding for symmetric decryption"),o("RetUtil").getNullableRetResult(t)}).catch(function(t){return o("CryptoLogger").captureError(s,t).mustfix("symmetric data decryption failed"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult())})};l.default=u}),98);
__d("LSSymmetricEncryptionCreateDecryptedData.nop",["EBEncryptMessageTypes","SymmetricEncryptionCreateDecryptedData"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n,a,i,l){return r("SymmetricEncryptionCreateDecryptedData")(o("EBEncryptMessageTypes").unsafeCastToSecretKey(a),o("EBEncryptMessageTypes").unsafeCastToAAD(i),o("EBEncryptMessageTypes").unsafeCastToCiphertext(l))};e.__nop_name__="LSSymmetricEncryptionCreateDecryptedData",l.default=e}),98);
__d("validateMAWMediaAndComposeEntryForProtoMsg",["FBLogger","WAMediaUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("DbMedia is null in validateMediaAndComposeEntryForProtoMsg");var n=null;if(e!=null&&t.mediaId!=null){if(!t.msgIds.includes(e))throw r("FBLogger")("messenger_web").mustfixThrow("the media ("+t.mediaId+") is not linked to the msg ("+e+")");n=t.mediaEntries.get(e)}else n=t.mediaEntry;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("media entry not found in validateMediaAndComposeEntryForProtoMsg");var o=t.plaintextHash,a=s(o,n);return[t,a]}function s(e,t){var n=o("WAMediaUtils").mediaEntryDataToRawData(e,t);if(n.fileSha256==null||n.mediaKey==null||n.fileEncSha256==null||n.directPath==null||n.mediaKeyTimestamp==null)throw r("FBLogger")("messenger_web").mustfixThrow("missing fields in mediaEntryData");return babelHelpers.extends({},n,{directPath:n.directPath,fileEncSha256:n.fileEncSha256,fileSha256:n.fileSha256,mediaKey:n.mediaKey,mediaKeyTimestamp:n.mediaKeyTimestamp})}l.validateMAWMediaAndComposeEntryForProtoMsg=e,l.validateMediaEntry=s}),98);
__d("MAWAsArmadilloApplication",["FBLogger","MAWEncodeMediaTransportProtocol","MAWMsg","MAWMsgType","MAWVault","MAWXMAEncodeUtils","WAArmadilloApplication.pb","WAGlobals","WAJids","WATimeUtils","getErrorSafe","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,a){switch(e.type){case o("MAWMsgType").MSG_TYPE.XMA:{if((t==null?void 0:t.xma)==null)throw r("FBLogger")("messenger_web").mustfixThrow("XMA content should have XMA payload");var i=o("MAWXMAEncodeUtils").encodeXMA(e,t);return i}case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return u(e,n);case o("MAWMsgType").MSG_TYPE.RAVEN:return p(e,a);case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return d(e);default:throw r("FBLogger")("messenger_web").mustfixThrow(e.type+" should not be handled as ArmadilloApplication")}}function u(e,t){var n;if(e.type!==o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE||((n=e.quote)==null?void 0:n.content)==null||t==null)return null;var r=e.quote.content,a=o("WAJids").interpretAndValidateJid(t),i=o("WAJids").isAuthorMe(e.author)?o("WAGlobals").getMyUserJid():e.author,l=o("WAJids").isAuthorMe(r.author)?o("WAGlobals").getMyUserJid():r.author;function s(){return a.jidType==="msgrUser"?l:a.jidType==="group"?a.groupJid:null}function u(){return i===l?null:a.jidType==="group"?l:null}var c=s(),d=u();if(c==null)return null;if(e)return{payload:{content:{bumpExistingMessage:{key:{fromMe:i===l,id:r.externalId,participant:d,remoteJid:c}}}}}}function c(e){var t,n,r,a=(t=e.quote)==null?void 0:t.content,i=a==null||(n=a.msgContent)==null?void 0:n.content,l=a==null?void 0:a.expirationTs,s=e==null||(r=e.msgContent)==null?void 0:r.content;if(a==null||i==null||s==null)return null;var u=l!=null?o("WATimeUtils").castUnixTimeToMillisTime(l):void 0;return{payload:{content:{noteReplyMessage:{noteText:{text:o("MAWVault").unvault(i)},noteTimestampMs:u,textContent:{text:o("MAWVault").unvault(s)}}}}}}function d(e){var t=e.ravenActionToMsgExternalId;if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("msg ravenActionToMsgExternalId is null in encodeRavenActionMessage");var n=Number(e.actionType),a;if(n===0)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.PLAYED;else if(n===1)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.SCREENSHOT;else if(n===2)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.FORCE_DISABLE;else throw r("FBLogger")("messenger_web").mustfixThrow("msg actionType is not in enum in encodeRavenActionMessage");var i=e.actionTimestamp==null?Date.now():o("WATimeUtils").castUnixTimeToMillisTime(e.actionTimestamp),l={actionTimestamp:i,actionType:a,key:{id:t}};return{payload:{content:{ravenActionNotifMessage:l}}}}function m(e){return e===o("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE?0:e===o("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY?1:e===o("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT?2:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}function p(t,n){if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("media is null in encodeRavenMessage");var a,i;try{var l=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(t.msgId,n);a=l[0],i=l[1]}catch(t){var s=r("getErrorSafe")(t);r("FBLogger")("messenger_web").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Media entry is invalid, fallback to the placeholder: ",""])),s.message),a=void 0,i=void 0}if(a==null||i==null)return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType)}}}};switch(t.ravenMediaType){case o("MAWMsg").MAWRavenMsgMediaType.IMAGE:{var u=o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToImageTransport(a,i);return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType),imageMessage:{payload:u,version:1}}}}}}case o("MAWMsg").MAWRavenMsgMediaType.VIDEO:{var c=o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToVideoTransport(a,i);return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType),videoMessage:{payload:c,version:1}}}}}}}}l.asArmadilloApplication=s,l.encodeNoteReplyMessage=c}),98);
__d("MAWAsConsumerApplication",["FBLogger","I64","LSIntEnum","MAWDbMedia","MAWEncodeMediaTransportProtocol","MAWJids","MAWMsgType","MAWVault","WAAssertUnreachable","WAConsumerApplication.pb","WAGlobals","WAJids","WAMediaTransport.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,a){switch(e.type){case o("MAWMsgType").MSG_TYPE.TEXT:return p(e);case o("MAWMsgType").MSG_TYPE.IMAGE:return _(e,t);case o("MAWMsgType").MSG_TYPE.VIDEO:return C(e,t);case o("MAWMsgType").MSG_TYPE.PTT:return v(e,t);case o("MAWMsgType").MSG_TYPE.REVOKED:return R(e.revokedExternalId);case o("MAWMsgType").MSG_TYPE.GIF:return C(e,t);case o("MAWMsgType").MSG_TYPE.STICKER:return h(e,t);case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return x(e,t);case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:case o("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return null;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:throw r("FBLogger")("messenger_web").mustfixThrow("Implemented ephemeral setting message in MAWAsConsumerApplication");case o("MAWMsgType").MSG_TYPE.XMA:throw r("FBLogger")("messenger_web").mustfixThrow("XMA content message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case o("MAWMsgType").MSG_TYPE.ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support converting to protoMsg with "+e.type+" type","maw_db");case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:throw r("FBLogger")("messenger_web").mustfixThrow("Raven content message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.EDIT_ACTION:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support editing messages right now since the sending flow is not implemented yet. ");case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return E(e,n);case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:throw r("FBLogger")("messenger_web").mustfixThrow("Bump message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return T(e,a);case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support group poll creation messages yet as the sending flow is not implemented.");case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support group poll update messages yet as the sending flow is not implemented.");default:return r("WAAssertUnreachable")(e.type)}}function c(e,t){if(t==null)return d(e);switch(t.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:return f(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.VIDEO:return b(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.PTT:return S(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.GIF:return b(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.STICKER:return y(e.msgId,t);default:return null}}function d(e){var t=null;if(e.type===o("MAWMsgType").MSG_TYPE.REVOKED&&e.msgContent!=null&&e.msgContent.content!=null)t=e.msgContent.content;else if(e.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME&&e.msgContent!=null)t=e.msgContent;else return null;return{payload:{content:{messageText:{mentionedJid:[],text:o("MAWVault").unvault(t)}}}}}function m(e){if(e!=null){var t=e===1?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:e===2?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;return{specialTextSize:t}}}function p(e){var t={payload:{content:{messageText:{commands:e.msgContent.commands,mentionedJid:e.msgContent.mentionedJids,text:o("MAWVault").unvault(e.msgContent.content)}}}},n=m(e.specialTextSize);return n!=null&&(t.metadata=n),t}function _(e,t){return f(e.msgId,t,e)}function f(e,t,n){var r=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),a=r[0],i=r[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedImageMessage(a,i,n)}function g(e){function t(){var t=o("WAJids").validateGroupJid(e.threadJid);return t!=null?t:o("WAJids").isAuthorMe(e.author)?e.threadJid:o("WAGlobals").getMyUserJid()}var n=t();return{payload:{content:{editMessage:{key:{fromMe:!0,id:e.originalMsgExternalId,remoteJid:n},message:{mentionedJid:e.msgContent.mentionedJids,text:o("MAWVault").unvault(e.msgContent.content)},timestampMs:e.editTs*1e3}}}}}function h(e,t){return y(e.msgId,t)}function y(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedStickerMessage(r,a)}function C(e,t){return b(e.msgId,t)}function b(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedVideoMessage(r,a)}function v(e,t){return S(e.msgId,t)}function S(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedAudioMessage(r,a)}function R(e){return{payload:{applicationData:{revoke:{key:{fromMe:!0,id:e}}}}}}function L(e){var t=o("WAJids").isAuthorMe(e.reactToAuthor)?o("WAGlobals").getMyUserJid():e.reactToAuthor;function n(){var n=o("WAJids").isAuthorMe(e.author)?o("WAGlobals").getMyUserJid():e.author;return n===t}var r=n(),a=o("WAJids").interpretAsGroupJid(e.threadJid)!=null,i={groupingKey:e.groupingKey==null?void 0:e.groupingKey,key:{fromMe:r,id:e.reactToExternalId,participant:a&&!r?t:void 0,remoteJid:e.threadJid},senderTimestampMs:e.senderTimestampMs,text:e.reaction==null?void 0:e.reaction};return{payload:{content:{reactionMessage:i}}}}function E(e,t){if(e.threadJid==null)throw r("FBLogger")("messenger_web").mustfixThrow("msg threadJid is null in encodeGroupInviteMessage");if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("DbGroupInvite is null in encodeGroupInviteMessage");var n=o("WAJids").interpretAsGroupJid(e.threadJid);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("groupJid is null in encodeGroupInviteMessage");return{payload:{content:{groupInviteMessage:{groupJid:n,groupName:e.groupName,inviteCode:t.inviteCode,inviteExpiration:t.inviteExpirationTs}}}}}function k(t){return(e||(e=o("I64"))).equal(t.displayedContentTypes,(s||(s=o("LSIntEnum"))).ofNumber(1))||(e||(e=o("I64"))).equal(t.displayedContentTypes,(s||(s=o("LSIntEnum"))).ofNumber(256))||t.textHasLinks||t.isUnsent?I(t):null}function I(e){var t,n=(t=e.mentionIds)==null||(t=t.split(","))==null?void 0:t.map(o("MAWJids").toUserJid);return{payload:{content:{messageText:{mentionedJid:n!=null?n:[],text:e.text}}}}}function T(e,t){if(e.receiverFetchId==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch message without receiver fetch id");if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch message without receiver fetch info");switch(t.type){case"sticker":return D(t);default:throw r("FBLogger")("messenger_web").mustfixThrow("Unsupported receiver fetch type: "+t.type)}}function D(e){if(e.receiverFetchId==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch sticker message without receiver fetch id");var t={ancillary:{accessibilityLabel:e.accessibilitySummaryText,height:e.previewHeight,isThirdParty:!1,receiverFetchId:e.receiverFetchId,width:e.previewWidth},integral:{receiverFetchId:e.receiverFetchId,transport:{ancillary:{mimetype:o("MAWEncodeMediaTransportProtocol").STICKER_MIME_TYPE,thumbnail:{thumbnailHeight:e.previewHeight,thumbnailWidth:e.previewWidth}},integral:{}}}},n=o("encodeProtobuf").encodeProtobuf(o("WAMediaTransport.pb").StickerTransportSpec,t);return{payload:{content:{stickerMessage:{sticker:{payload:n.readBuffer(),version:1}}}}}}function x(e,t){return $(e.msgId,t)}function $(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedFileMessage(r,a)}l.asConsumerApplication=u,l.deletedMsgAsConsumerApplicationForSpamReporting=c,l.encodeConsumerApplicationMetadata=m,l.encodeEditMessage=g,l.encodeReactionMessage=L,l.asConsumerApplicationLSDb=k,l.encodeReceiverFetchStickerMessage=D,l.encodeFileMessage=x}),98);
__d("WAFranking",["$InternalEnum","QPLFlow","WACryptoDependencies","WACryptoHmac","WACryptoUtils","WAFrankingTypes","WAGlobals"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=0,u=n("$InternalEnum").Mirrored(["KEEP","DROP"]);function c(){var t=new Uint8Array(e);return o("WACryptoDependencies").getCrypto().getRandomValues(t),o("WAFrankingTypes").castToFrankingKey(t)}function d(e){return e!=null?e:s}function m(e,t){return o("WACryptoHmac").hmacSha256(e,t).then(function(e){return o("WAFrankingTypes").castToFrankingTag(new Uint8Array(e))})}async function p(e,t,n,r){switch(r){case void 0:case 0:{var a=await o("WACryptoHmac").hmacSha256(t,e);return o("WACryptoUtils").uint8ArraysEqual(new Uint8Array(a),n)}default:return!0}}async function _(e,t){var n,r,a,i=o("WAGlobals").getConfig().isFrankingDropOnInvalid(),l=o("QPLFlow").startQPLFlow(o("WAGlobals").getWaQpl().franking);if((t==null?void 0:t.frankingTag)!=null&&((n=e.metadata)==null?void 0:n.frankingKey)==null){var s;return t.frankingTag=null,t.reportingTag=null,l.endFail("missingFrankingKey",{bool:{doesFrankingTagExist:(t==null?void 0:t.frankingTag)!=null,doesFrankingKeyExist:((s=e.metadata)==null?void 0:s.frankingKey)!=null,doesFrankingContentExist:e.frankingContent!=null}}),{decision:u.KEEP,updatedReportingMeta:t}}if((t==null?void 0:t.frankingTag)!=null&&e.version==="v3"&&e.type==="subprotocol"&&((r=e.metadata)==null?void 0:r.frankingKey)!=null&&e.frankingContent!=null){var c=t.frankingTag,d=e.frankingContent,m=e.metadata.frankingVersion,_=o("WAFrankingTypes").castToFrankingKey(new Uint8Array(e.metadata.frankingKey));return _==null?(l.endFail("tagButNoKey"),i?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t}):await p(new Uint8Array(d),_,c,m)?(t.frankingKey=_,t.reportingContent=d,l.endSuccess(),{decision:u.KEEP,updatedReportingMeta:t}):(l.endFail("tagMismatch"),i?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t})}return l.endFail("potentialDropCandidate",{bool:{doesFrankingTagExist:(t==null?void 0:t.frankingTag)!=null,doesFrankingKeyExist:((a=e.metadata)==null?void 0:a.frankingKey)!=null,doesFrankingContentExist:e.frankingContent!=null}}),o("WAGlobals").getConfig().isFrankingDropOnMissing()?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t}}l.FrankingDecision=u,l.createFrankingKey=c,l.getFrankingVersion=d,l.genFrankingTag=m,l.validateFrankingTag=p,l.handleAndValidateFrankingFromIncomingMsg=_}),98);
__d("WAAsMessageApplication",["WAAsConsumerApplication","WAConsumerApplication.pb","WAFranking","WAMsgApplication.pb","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;switch(e.type){default:t=o("WAAsConsumerApplication").asConsumerApplication(e)}var n=e.forwardingScore!=null?e.forwardingScore:0,r=e.isForwarded!=null?e.isForwarded:!1,a={metadata:{chatEphemeralSetting:null,forwardingScore:n,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion(),isForwarded:r,quotedMessage:null}};if(t!=null){var i=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);a.payload={subProtocol:{consumerMessage:{payload:i.readBuffer(),version:1}}}}return o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,a).readByteArrayView()}function s(e){return e}function u(e){return e.buffer}l.asMessageApplication=e,l.castToMessageApplicationBytes=s,l.castMessageApplicationBytesToBytes=u}),98);
__d("MAWAsMessageApplication",["I64","LSIntEnum","LSMessageReplySourceTypeV2","MAWAsArmadilloApplication","MAWAsConsumerApplication","MAWJids","MAWMsgType","WAArmadilloApplication.pb","WAAsMessageApplication","WAConsumerApplication.pb","WAFranking","WAGlobals","WAJids","WAMsgApplication.pb","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,r,a,i){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,c(e,t,n,r,a,i)).readByteArrayView())}function c(e,t,n,r,a,i){var l,s;switch(e.type){case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:l=o("MAWAsArmadilloApplication").asArmadilloApplication(e,void 0,void 0,t);break;case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:l=o("MAWAsArmadilloApplication").asArmadilloApplication(e,void 0,a);break;case o("MAWMsgType").MSG_TYPE.XMA:l=o("MAWAsArmadilloApplication").asArmadilloApplication(e,r);break;default:s=o("MAWAsConsumerApplication").asConsumerApplication(e,t,n,i)}var u,c,d=e.forwardingScore!=null?e.forwardingScore:0,m=e.isForwarded!=null?e.isForwarded:!1;if(e.quote!=null){var p=e.quote;u={participant:p.content.author===o("WAJids").AUTHOR_ME?o("WAGlobals").getMyDeviceJid():p.content.author,stanzaId:p.content.externalId}}if(e.ephemeralSetting){var _=e.ephemeralSetting;e.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?c={ephemeralExpiration:_.ephemeralExpirationInSec,isEphemeralSettingReset:e.isEphemeralSettingReset}:c={ephemeralExpiration:_.ephemeralExpirationInSec,ephemeralSettingTimestamp:_.ephemeralLastUpdatedOrSetTimestamp*1e3}}var f={metadata:{chatEphemeralSetting:c,forwardingScore:d,frankingKey:y(e.reportingMeta),frankingVersion:o("WAFranking").getFrankingVersion(),groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize,isForwarded:m,quotedMessage:u}};if(s!=null){var g=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,s);f.payload={subProtocol:{consumerMessage:{payload:g.readBuffer(),version:1}}}}else if(l!=null){var h=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,l);f.payload={subProtocol:{armadillo:{payload:h.readBuffer(),version:1}}}}return f}function d(t){var n,a=o("MAWAsConsumerApplication").asConsumerApplicationLSDb(t),i,l,u=t.isForwarded!=null?t.isForwarded:!1,c=u?1:0;t.replySourceTypeV2&&!(e||(e=o("I64"))).equal(t.replySourceTypeV2,(s||(s=o("LSIntEnum"))).ofNumber(r("LSMessageReplySourceTypeV2").NONE))&&t.replyToUserId!=null&&(i={participant:t.replyToUserId===o("WAJids").AUTHOR_ME?o("WAGlobals").getMyDeviceJid():o("MAWJids").toUserJid((e||(e=o("I64"))).to_string(t.replyToUserId)),stanzaId:t.messageId});var d={metadata:{chatEphemeralSetting:l,forwardingScore:c,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion(),groupId:(n=t==null?void 0:t.groupId)!=null?n:void 0,groupIndex:t.groupIndex!=null?(e||(e=o("I64"))).to_float(t.groupIndex):void 0,groupSize:t.groupSize!=null?(e||(e=o("I64"))).to_float(t.groupSize):void 0,isForwarded:u,quotedMessage:i}};if(a!=null){var m=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,a);d.payload={subProtocol:{consumerMessage:{payload:m.readBuffer(),version:1}}}}return d}function m(e){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,p(e)).readByteArrayView())}function p(e){var t=o("MAWAsConsumerApplication").encodeReactionMessage(e),n=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:n.readBuffer(),version:1}}}}}function _(e){var t=o("MAWAsArmadilloApplication").encodeNoteReplyMessage(e);if(t==null)return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()}};var n=e.ephemeralSetting,r=n?{ephemeralExpiration:n.ephemeralExpirationInSec,ephemeralSettingTimestamp:n.ephemeralLastUpdatedOrSetTimestamp*1e3}:void 0,a=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,t);return{metadata:{chatEphemeralSetting:r,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{armadillo:{payload:a.readBuffer(),version:1}}}}}function f(e){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,g(e)).readByteArrayView())}function g(e){var t=o("MAWAsConsumerApplication").encodeEditMessage(e),n=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:n.readBuffer(),version:1}}}}}function h(e,t){var n,r,a=o("MAWAsConsumerApplication").deletedMsgAsConsumerApplicationForSpamReporting(e,t);if(a==null)return null;var i=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,a);return{metadata:{frankingKey:y(e.reportingMeta),frankingVersion:((n=e.reportingMeta)==null?void 0:n.frankingVersion)!=null?(r=e.reportingMeta)==null?void 0:r.frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:i.readBuffer(),version:1}}}}}function y(e){return(e==null?void 0:e.frankingKey)!=null?e.frankingKey:o("WAFranking").createFrankingKey()}l.encodeMessageApplication=u,l.asMessageApplication=c,l.asMessageApplicationLSDb=d,l.encodeReactionMessageApplication=m,l.asReactionMessageApplication=p,l.asNoteReplyMessageApplication=_,l.encodeEditMessageApplication=f,l.asEditMessageApplication=g,l.deletedMsgAsMessageApplicationForSpamReporting=h}),98);
__d("MAWXMAEncodeUtils",["MAWAsMessageApplication","MAWEncodeMediaTransportProtocol","MAWMsgType","MAWParseSubprotocolVersionConsts","MAWVault","WALogger","WAMsgApplication.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){var r=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),a=r[0],i=r[1];return{payload:o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToImageTransport(a,i),version:n}}function u(t,n){var r=t.msgContent,a=t.msgId,i=r||{},l=i.commands,u=i.content,c=i.mentionedJids,d=n.associatedMessage,m=n.favicon,p=n.header,_=n.previews,f=n.xma,g=null;if(d!=null)if(d.type!==o("MAWMsgType").MSG_TYPE.TEXT)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Non-text associated message for the XMA content is not supported"])));else{var h=o("MAWAsMessageApplication").asMessageApplication(d),y=o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,h);g={payload:y.readBuffer(),version:o("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION}}var C=p!=null&&a!=null?s(a,p,o("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION):null,b=m!=null&&a!=null?s(a,m,o("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION):null,v=_!=null&&a!=null?_.map(function(e){return s(a,e,o("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)}):null,S=f.defaultCTA==null?void 0:[f.defaultCTA].concat(f.ctas).filter(Boolean);return{payload:{content:{extendedContentMessage:{associatedMessage:g!=null?g:void 0,commands:l,contentRef:f.contentRef,ctas:S,favicon:b!=null?b:void 0,headerImage:C!=null?C:void 0,headerTitle:f.headerTitle,maxSubtitleNumOfLines:f.maxSubtitleNumOfLines,maxTitleNumOfLines:f.maxTitleNumOfLines,mentionedJid:c,messageText:u==null?void 0:o("MAWVault").unvault(u),overlayDescription:f.overlayDescription,overlayIconGlyph:f.overlayIconGlyph,overlayTitle:f.overlayTitle,previews:v!=null?v:[],sentWithMessageId:g?f.externalId:void 0,subtitleText:f.subtitleText,targetExpiringAtSec:f.targetExpiringAtSec,targetId:f.targetId,targetType:f.targetType,targetUsername:f.targetUsername,titleText:f.titleText,xmaDataclass:f.xmaDataclass,xmaLayoutType:f.xmaLayoutType}}}}}l.encodeXMA=u}),98);
__d("MAWBulkEditMsgsTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbEditMsgHistoryTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWUnsafeCoerce","MAWUserJidWrapper","WAJids","WAMsgMap","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=new Set,r=[];return t.forEach(function(e){var t=e.chatJid,o=e.msg;n.add(t),r.push(o.originalMsgExternalId)}),o("MAWDexieTable").dexieAll([e.messages.where("externalId").anyOf(r).toArray(),e.messages.where("quoteExternalId").anyOf(r).toArray(),e.editMsgHistory.where("originalMsgExternalId").anyOf(r).toArray()]).then(function(e){var t=e[0],n=e[1],r=e[2];return{editMsgHistory:r,originalMsgs:t,quoteMessages:n}})}function s(e,t,n){var a=n.editMsgHistory,i=n.originalMsgs,l=n.quoteMessages,s=i.reduce(function(e,t){var n=o("MAWJidUtils").toProtocolMsgId(t);return n==null?e:e.set(n,t)},new(o("WAMsgMap")).MsgMap),u=a.reduce(function(e,t){var n=o("MAWJidUtils").toProtocolMsgId(t);return n==null?e:e.set(n,t)},new(o("WAMsgMap")).MsgMap),d=c(t,{messageHistoriesToEdit:u,messagesToEdit:s}),m=d[0],p=d[1],_=d[2];return o("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(e,m).then(function(){var t=new(o("WAMsgMap")).MsgMap;p.entries().forEach(function(e){var n,a,i=e[0],l=e[1],u=s.get(i);if(u==null){r("FBLogger")("messenger_web").warn("Cannot find the original msg for the edit action.");return}if(u.type!==o("WAMsgType").MSG_TYPE.TEXT&&u.type!==o("WAMsgType").MSG_TYPE.CIPHERTEXT)throw r("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",u.type);var c=babelHelpers.extends({},u,{editCount:((n=u.editCount)!=null?n:0)+((a=_.get(i))!=null?a:0),msgContent:l.editMsgContent,type:o("WAMsgType").MSG_TYPE.TEXT});t.set(i,c)});var n=l.map(function(e){var n=e.quote,a=e.quoteExternalId,i=e.threadJid;if(n==null){r("FBLogger")("messenger_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",e.externalId);return}var l=n.content.author,s=o("MAWJidUtils").maybeToProtocolMsgId(l==="@me"?o("MAWUserJidWrapper").getMyUserJid():l,i,a);if(s!=null){var u=t.get(s);if(u!=null)return babelHelpers.extends({},e,{quote:babelHelpers.extends({},n,{content:babelHelpers.extends({},n.content,{msgContent:babelHelpers.extends({},u.msgContent)})})})}}).filter(Boolean);return e.messages.bulkPut(t.values().concat(n)).then(function(){t.values().forEach(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})}).then(function(){n.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})})})})}function u(e,t){var n,a,i,l;switch(e.type){case o("WAMsgType").MSG_TYPE.TEXT:case o("WAMsgType").MSG_TYPE.EDIT_ACTION:return{author:e.author,editExternalId:e.externalId,editTs:(n=e.serverTs)!=null?n:e.ts,msgContent:(a=e.editMsgContent)!=null?a:o("MAWUnsafeCoerce").unsafeCoerce(e.msgContent),originalMsgExternalId:(i=e.originalMsgExternalId)!=null?i:e.externalId,sendStatus:o("MAWAckLevel").ACK.sent,specialTextSize:e.specialTextSize,threadJid:t};case o("WAMsgType").MSG_TYPE.CIPHERTEXT:return{author:e.author,editExternalId:e.externalId,editTs:(l=e.serverTs)!=null?l:e.ts,msgContent:{content:""},originalMsgExternalId:e.externalId,sendStatus:o("MAWAckLevel").ACK.sent,specialTextSize:e.specialTextSize,threadJid:t};default:throw e.type,r("FBLogger")("messenger_web").mustfixThrow("MAWBulkEditMsgsTxns::getMessageHistory: Unexpected msg type")}}function c(e,t){var n=t.messageHistoriesToEdit,a=t.messagesToEdit,i=[],l=new(o("WAMsgMap")).MsgMap,s=new(o("WAMsgMap")).MsgMap;return e.forEach(function(e){var t=e.chatJid,c=e.msg,d=o("MAWJidUtils").maybeToProtocolMsgId(c.author,t,c.originalMsgExternalId);if(d==null)throw r("FBLogger")("messenger_web").mustfixThrow("[protocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",o("WAJids").isAuthorSystem(c.author),!!t,!!c.originalMsgExternalId);var m=o("MAWJidUtils").maybeToProtocolMsgId(c.author,t,c.externalId);if(m==null)throw r("FBLogger")("messenger_web").mustfixThrow("[editMsgProtocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",o("WAJids").isAuthorSystem(c.author),!!t,!!c.externalId);if(n.get(m)==null){var p;i.push(u(c,t));var _=(p=s.get(d))!=null?p:0,f=a.get(d);if(s.set(d,_+1),n.get(d)==null&&_===0&&f!=null){if(f.type!==o("WAMsgType").MSG_TYPE.TEXT&&f.type!==o("WAMsgType").MSG_TYPE.CIPHERTEXT)throw r("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",f.type);i.push(u(f,t))}}var g=l.get(d),h=g==null?void 0:g.serverTs,y=c==null?void 0:c.serverTs;(h==null||y==null||h<y)&&l.set(d,c)}),[i,l,s]}l.prepareDataForMessageEdit=e,l.bulkEditMsgs=s,l.getMessageHistory=u}),98);
__d("MAWBulkPutReactionsWithThreadUpdateTxn",["FBLogger","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWThreadSnippetBuildTxns","WAArrayGroupBy","WAJids","WAMsgMap","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.reduce(function(e,t){var n=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.reactToExternalId);return n==null||e.set(n,o("MAWDbReactionsTxns").coerceToReaction(t)),e},new(o("WAMsgMap")).MsgMap).values()}function s(t,n,a){if(n.length===0)return o("MAWDexieTable").dexieResolve();var i=e(n),l=i.map(function(e){var t=a.get(e.threadJid);if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Should not have got here - expect thread to exist for flow");return e}),s=o("WAArrayGroupBy").groupBy(l,function(e){var t=e.threadJid;return t}),u=s.map(function(e){var n=e[0],r=e[1],i=a.get(n);if(i==null||r.length===0)return null;for(var l=null,s=r.length-1;s>=0&&(l=o("MAWDbReaction").maybeCastToIncomingDbReaction(r[s]),l==null);s--);var u=r.filter(function(e){return e.reaction==null}),c=o("WAJids").interpretAsGroupJid(i.jid)!=null;return o("MAWThreadSnippetBuildTxns").getThreadChangesetForReactionChanges(t,i,{newestReaction:l,reactionsToClear:u},c)}).filter(Boolean);return o("MAWDexieTable").dexieAll(u).then(function(e){return o("MAWDexieTable").dexieAll([t.threads.bulkPut(e.map(function(e){var t=e.thread;return t})),t.reactions.bulkPut(l)]).then(r("emptyFunction"))})}l.bulkPutReactionsWithThreadUpdates=s}),98);
__d("MAWDeletedReactionsCache",["WAMsgMap"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAMsgMap")).MsgMap;l.DeletedReactionsCache=e}),98);
__d("MAWBulkWriteReactionsTxns",["FBLogger","LSMEBTaskCreationSource","MAWAuthor","MAWBridgeEventTransmitter","MAWBulkPutReactionsWithThreadUpdateTxn","MAWDbMsg","MAWDbReaction","MAWDbReactionsTxns","MAWDeletedReactionsCache","MAWDexieTable","MAWJidUtils","MAWODSProxy","MAWUseProtocolMsgIdForMsgId","WAArrayGroupBy","WAJids","WAOdsEnums","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=[],a=[];return t.forEach(function(e){var t=e.chatJid,r=e.unstoredReaction,o=r.reactToExternalId;n.push(t),a.push(o)}),o("MAWDexieTable").dexieAll([e.threads.where("jid").anyOf(n).toArray(),e.messages.where("externalId").anyOf(a).toArray(),e.reactions.where("reactToExternalId").anyOf(a).toArray()]).then(function(n){var a=n[0],i=n[1],l=n[2],u=new Map(a.map(function(e){return[e.jid,e]})),c=new Map(o("WAArrayGroupBy").groupBy(i,function(e){return e.externalId})),d=new Map(o("WAArrayGroupBy").groupBy(l,function(e){return e.reactToExternalId})),m=[],p=o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId(),_=function(n){return t.forEach(function(e){var t=e.chatJid,a=e.unstoredReaction,i=a.author,l=a.externalId,_=a.groupingKey,f=a.reaction,g=a.reactToAuthor,h=a.reactToExternalId,y=a.senderTimestampMs,C=a.ts,b=u.get(t);if(b==null)return"missing_thread";var v=null;if(!p&&n!=null){var S=new Map(n),R=S.get(b.jid);if(R==null)throw r("FBLogger")("messenger_web").mustfixThrow("nextInChatReactionId should not be null");S.set(b.jid,R+1),v=o("MAWDbMsg").craftReactionId(b.chatId,R)}else v=o("MAWJidUtils").formatProtocolMsgIdFromExternalId(b.jid,l);var L=d.get(a.reactToExternalId)||[],E=o("MAWDbReaction").findMatchingReaction(L,b.jid,i);if(E!=null&&o("MAWDbReaction").getReactionTimeMs(E)>o("MAWDbReaction").getReactionTimeMs(a))return"newer_reaction_exists";if(E!=null&&a.reaction==null){var k={author:a.author,chat:a.threadJid,externalId:a.externalId};o("MAWDeletedReactionsCache").DeletedReactionsCache.set(k,E)}var I=o("MAWAuthor").getAuthorUserJid(g),T=c.get(a.reactToExternalId);T==null&&(a.reactToExternalId===a.externalId?r("FBLogger")("messenger_web").warn("reactToExternalId is same as externalId"):r("gkx")("16596")||o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.reactToExternalId,r("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT_REACTIONS,b.jid));var D=s(b,I,T),x=o("MAWDbReaction").formatReactionForDb(b.jid,l,v,h,f,_,g,D==null&&p?o("MAWJidUtils").formatProtocolMsgIdFromExternalId(b.jid,h):D==null?void 0:D.msgId,C,i!=null?i:o("WAJids").AUTHOR_ME,E==null?void 0:E.rowId,void 0,y);m.push(x)}),{chatJidToDbThread:u,unstoredDbReactionsForInsertion:m}};if(!p){var f=a.map(function(t){return o("MAWDbReactionsTxns").getNextReactionIdNumberForThread(e,t).then(function(e){return[t.jid,e]})});return o("MAWDexieTable").dexieAll(f).then(_)}return _(null)})}function s(e,t,n){var a,i=(a=n==null?void 0:n.filter(function(n){return n.threadJid===e.jid&&t===o("MAWAuthor").getAuthorUserJid(n.author)}))!=null?a:[];return i.length>1&&(r("FBLogger")("maw_mutation_validator").warn("%s matching duplicate messages found for a reaction",i.length),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_MUTATION_VALIDATOR,key:"match_reaction_to_message.invalid"})),i[0]}function u(e,t){var n=t.chatJidToDbThread,r=t.unstoredDbReactionsForInsertion;return o("MAWBulkPutReactionsWithThreadUpdateTxn").bulkPutReactionsWithThreadUpdates(e,r,n)}l.prepareReactionsData=e,l.bulkWriteReactions=u}),98);
__d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMAGatingType.INFO:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO;case o("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF;case o("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF;case o("EchoMessageXMAFieldUtils").XMAGatingType.WARNING:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING;case o("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE;case o("EchoMessageXMAFieldUtils").XMAGatingType.NONE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaGatingType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE}}l.convertXMAGatingTypeToExtendedContentOverlayIconGlyph=s}),98);
__d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;case o("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT;case o("EchoMessageXMAFieldUtils").XMALayoutType.HSCROLL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.HSCROLL;case o("EchoMessageXMAFieldUtils").XMALayoutType.STANDARD_DXMA:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.STANDARD_DXMA;case o("EchoMessageXMAFieldUtils").XMALayoutType.LIST_DXMA:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.LIST_DXMA;case o("EchoMessageXMAFieldUtils").XMALayoutType.GRID:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.GRID;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaLayoutType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE}}l.convertXMALayoutTypeToExtendedContentXMLLayoutType=s}),98);
__d("MAWConvertXMATargetTypeToExtendedContentTargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_SHORT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING_V2:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_MEMORIES_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_POST_REACTION_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaTargetType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE}}l.convertXMATargetTypeToExtendedContentTargetType=s}),98);
__d("MAWDexieCastToPromise",["Promise","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return(e||(e=n("Promise"))).resolve(t)}function u(e){return r("vulture")("Fs7u2qpGsgGUHBjaeXKvgOwLL5I="),e}l.dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING=s,l.promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING=u}),98);
__d("MAWEBRestoreTrackingUtils",["LSIntEnum","LSMEBTaskCreationSource","MAWQplProxy","MWEBODSEntityName.enum","ODS","QPLUserFlow","WAHashStringToNumber","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u={dyi:r("justknobx")._("467"),frontloaded:20,initial:20,paginated:r("justknobx")._("3177"),point:1,search:r("justknobx")._("2477")};function c(t,n,a,i){n!=null&&C({querySource:a,runningInWorker:i!=null?i:!1,taskSource:t,traceId:n,triggerType:"paginated"}),(e||(e=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore.request.paginated")}function d(t){var n=t.querySource,a=t.runningInWorker,i=t.taskSource,l=t.traceId;l!=null&&C({querySource:n,runningInWorker:a!=null?a:!1,taskSource:i,traceId:l,triggerType:"initial"}),(e||(e=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore.request.initial")}function m(t,n,a){n!=null&&C({querySource:"LS",runningInWorker:a!=null?a:!1,taskSource:t,traceId:n,triggerType:"dyi"}),(e||(e=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore.request.dyi")}function p(t,n,a){n!=null&&C({querySource:"LS",runningInWorker:a!=null?a:!1,taskSource:t,traceId:n,triggerType:"frontloaded"}),(e||(e=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore.request.frontloaded")}function _(t,n,a,i){n!=null&&C({querySource:a,runningInWorker:i!=null?i:!1,taskSource:t,traceId:n,triggerType:"point"}),(e||(e=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore.request.point")}function f(t){var n=t.querySource,a=t.runningInWorker,i=t.traceId;i!=null&&C({querySource:n,runningInWorker:a!=null?a:!1,taskSource:r("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB,traceId:i,triggerType:"search"}),(e||(e=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore.request.search")}function g(t,n){t!=null&&(n!=null&&n?o("MAWQplProxy").sendQPLSuccessThroughBridge(r("qpl")._(521476165,"2432"),void 0,o("WAHashStringToNumber").hashStringToNumber(t)):r("QPLUserFlow").endSuccess(r("qpl")._(521476165,"2432"),{instanceKey:o("WAHashStringToNumber").hashStringToNumber(t)})),(e||(e=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore.decryption.success")}function h(t,n,a,i){a===void 0&&(a="restore_failure"),t!=null&&(n!=null&&n?o("MAWQplProxy").sendQPLFailThroughBridge(r("qpl")._(521476165,"2432"),a,i,o("WAHashStringToNumber").hashStringToNumber(t)):r("QPLUserFlow").endFailure(r("qpl")._(521476165,"2432"),a,{annotations:i,instanceKey:o("WAHashStringToNumber").hashStringToNumber(t)})),(e||(e=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore.decryption.failure")}function y(e){L("protobuf",e)}function C(e){var t=e.querySource,n=e.runningInWorker,a=e.taskSource,i=e.traceId,l=e.triggerType;if(n!=null&&n){var s;o("MAWQplProxy").startQplUserFlow(r("qpl")._(521476165,"2432"),{bool:{runningInWorker:n===!0},int:{requestedMessagesCount:(s=u[l])!=null?s:10},string:{querySource:t,taskSource:E(a),traceId:i,triggerType:l}},{providedInstanceKey:o("WAHashStringToNumber").hashStringToNumber(i),providedTimeoutInMs:r("justknobx")._("2950")})}else{var c;r("QPLUserFlow").start(r("qpl")._(521476165,"2432"),{annotations:{bool:{runningInWorker:!1},int:{requestedMessagesCount:(c=u[l])!=null?c:10},string:{querySource:t,taskSource:E(a),traceId:i,triggerType:l}},instanceKey:o("WAHashStringToNumber").hashStringToNumber(i),timeoutInMs:r("justknobx")._("2950")})}}function b(e){var t=e.pointName,n=e.traceId;r("QPLUserFlow").addPoint(r("qpl")._(521476165,"2432"),t,{instanceKey:o("WAHashStringToNumber").hashStringToNumber(n)})}function v(e){var t=e.annotations,n=e.pointName,a=e.traceId;r("QPLUserFlow").addAnnotations(r("qpl")._(521476165,"2432"),t,{instanceKey:o("WAHashStringToNumber").hashStringToNumber(a)}),r("QPLUserFlow").addPoint(r("qpl")._(521476165,"2432"),n,{instanceKey:o("WAHashStringToNumber").hashStringToNumber(a)})}function S(e){var t=e.annotations,n=e.pointName,a=e.traceId;a!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(521476165,"2432"),n,{annotations:t,instanceKey:o("WAHashStringToNumber").hashStringToNumber(a)})}function R(e){var t=e.pointName,n=e.traceId;o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(521476165,"2432"),t,{instanceKey:o("WAHashStringToNumber").hashStringToNumber(n)})}function L(t,n){var a=n?(s||(s=o("LSIntEnum"))).unwrapIntEnum(n):null;(e||(e=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore."+t+"."+E(a))}function E(e){var t;return(t=e==null?void 0:e.toString())!=null?t:"unknown"}l.markEBRestorePaginated=c,l.markEBRestoreInitial=d,l.markEBRestoreDYI=m,l.markEBRestoreFrontloaded=p,l.markEBRestorePoint=_,l.markEBRestoreSearch=f,l.markEBRestoreSuccess=g,l.markEBRestoreFail=h,l.markEBRestoreProtobuf=y,l.addQPLRestorePoint=b,l.addQPLRestorePointWithAnnotations=v,l.addQPLRestorePointWithAnnotationsWorker=S,l.addQPLRestorePointWorker=R}),98);
__d("MAWEchoToProtobufConversionLoggingUtils",["QPLUserFlow","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){r("QPLUserFlow").start(r("qpl")._(521484676,"2684"),{annotations:t,instanceKey:e})}function s(e,t,n){r("QPLUserFlow").endFailure(r("qpl")._(521484676,"2684"),t,{annotations:n,instanceKey:e})}function u(e,t){r("QPLUserFlow").endSuccess(r("qpl")._(521484676,"2684"),{annotations:t,instanceKey:e})}function c(e,t,n){n&&r("QPLUserFlow").addAnnotations(r("qpl")._(521484676,"2684"),n,{instanceKey:e}),r("QPLUserFlow").addPoint(r("qpl")._(521484676,"2684"),t,{instanceKey:e})}l.startQplUserFlow=e,l.endFailure=s,l.endSuccess=u,l.addPoint=c}),98);
__d("MAWGetMsgForProtocolMsgIdTxn",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"getMsgForProtocolMsgIdTxn",function(e){return function(t){return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t).then(function(e){return e!=null?o("WAResultOrError").makeResult(e):o("WAResultOrError").makeError("message-not-found")})}});l.getMsgForProtocolMsgIdTxn=e}),98);
__d("MAWHandleXmaTransactionUtil",["MAWBridgeXMA","MAWDbChunkTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t){var n=!1;return e!=null&&t.defaultPreviewMediaId===e.mediaId&&(n=await _(e)),o("MAWBridgeXMA").createBridgeXMA(e,t,{hasMedia:n,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}function s(e,t,n){return u(e,t,n).then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:e})})}function u(e,t,n){var r=n==null?o("MAWDexieTable").dexieResolve(!1):o("MAWDbChunkTxns").hasMediaChunk(e,n.hashedPlaintextHash);return r.then(function(e){return o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:e,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})})}function c(e,t,n,r,a){return d(e,t,n,r,a).then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:e})})}function d(e,t,n,r,a){var i=m(n,r,a,e);return i.then(function(e){var r=e.hasMedia,a=e.hasXmaFaviconMedia,i=e.hasXmaHeaderMedia;return o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:r,hasXmaFaviconMedia:a,hasXmaHeaderMedia:i})})}function m(e,t,n,r){if(e!=null||t!=null||n!=null){var a=[e,t,n].filter(Boolean).map(function(e){return e.hashedPlaintextHash});return o("MAWDbChunkTxns").hasMediaChunks(r,a).then(function(r){return{hasMedia:e!=null&&r.get(e.hashedPlaintextHash)===!0,hasXmaFaviconMedia:t!=null&&r.get(t.hashedPlaintextHash)===!0,hasXmaHeaderMedia:n!=null&&r.get(n.hashedPlaintextHash)===!0}})}else return o("MAWDexieTable").dexieResolve({hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}function p(e,t,n,r,a){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(m(e,t,n,a).then(function(t){var n=t.hasMedia,a=t.hasXmaFaviconMedia,i=t.hasXmaHeaderMedia;return o("MAWBridgeXMA").createBridgeXMA(e,r,{hasMedia:n,hasXmaFaviconMedia:a,hasXmaHeaderMedia:i})}))}var _=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READONLY},"MAWHandleXmaTransactionUtil.hasMediaChunkTransaction",function(e){return(function(t){return o("MAWDbChunkTxns").hasMediaChunk(e,t.hashedPlaintextHash)})});l.checkMediaChunkTransactionAndCreatedBridgeXma=e,l.checkMediaChunkAndHandleXmaAfterTransaction=s,l.checkMediaChunkAndCreatedBridgeXma=u,l.checkAllMediaChunksAndHandleXmaAfterTransaction=c,l.checkAllMediaChunksAndCreateBridgeXma=d,l.verifyAllMediaChunksForXMA=m,l.checkAllMediaChunksAndCreateBridgeXma_DEPRECATED=p}),98);
__d("MAWLegacyDownloadManager",[],(function(t,n,r,o,a,i){"use strict";var e=1e4,l=(function(){function t(){this.$1=[],this.$2=new Map}var n=t.prototype;return n.setToDownloadManager=function(t,n){this.$3(),this.$2.set(t,n),this.$1.push(t)},n.getFromDownloadManager=function(t){return this.$2.get(t)},n.removeFromMediaDownloadManager=function(t){this.$2.delete(t);var e=this.$1.filter(function(e){return e!==t});this.setDownloadManagerQueue(e)},n.setDownloadManagerQueue=function(t){this.$1=t},n.$3=function(){if(this.$1.length>=e){var t=this.$1.shift();this.$2.delete(t)}},t})();i.LegacyDownloadManager=l}),66);
__d("MAWLegacyMediaDownloadManager",["MAWLegacyDownloadManager"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("MAWLegacyDownloadManager")).LegacyDownloadManager,s=new(o("MAWLegacyDownloadManager")).LegacyDownloadManager;function u(t,n){e.setToDownloadManager(t,n)}function c(t){return e.getFromDownloadManager(t)}function d(t){e.removeFromMediaDownloadManager(t)}function m(e,t){s.setToDownloadManager(e,t)}function p(e){return s.getFromDownloadManager(e)}function _(e){s.removeFromMediaDownloadManager(e)}l.setToMediaDownloadManager=u,l.getFromMediaDownloadManager=c,l.removeFromMediaDownloadManager=d,l.setToMediaPlaintextDownloadManager=m,l.getFromMediaPlaintextDownloadManager=p,l.removeFromMediaPlaintextDownloadManager=_}),98);
__d("MAWMediaType",["WAServerMediaType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"XMA":return"xma-image";case"EphemeralScreenshotAction":case"Raven":case"RavenAction":case"EditAction":case"NoteReply":case"BumpExistingMessage":return null;default:return o("WAServerMediaType").getMediaType(e)}}l.getMediaType=e}),98);
__d("MAWRavenUtils",["EphemeralMediaViewMode","MAWMsg","RavenMessagingState"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){switch(t){case o("MAWMsg").MAWRavenMsgEphemeralMediaState.PERMANENT:return r("RavenMessagingState").PERMANENT;case o("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN:return r("RavenMessagingState").UNSEEN;case o("MAWMsg").MAWRavenMsgEphemeralMediaState.SEEN:return r("RavenMessagingState").SEEN;case o("MAWMsg").MAWRavenMsgEphemeralMediaState.REPLAYED:return r("RavenMessagingState").REPLAYED;case o("MAWMsg").MAWRavenMsgEphemeralMediaState.EXPIRED:return r("RavenMessagingState").EXPIRED}},s=function(t){switch(t){case o("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT:return r("EphemeralMediaViewMode").PERMANENT;case o("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY:return r("EphemeralMediaViewMode").REPLAYABLE;case o("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE:return r("EphemeralMediaViewMode").READ_ONCE}},u=function(t,n){return{ephemeralMediaState:n,ephemeralMediaViewMode:s(t)}};function c(t,n){switch(n){case o("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE:return t===o("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN?r("RavenMessagingState").SEEN:e(t);case o("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY:return t===o("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN?r("RavenMessagingState").SEEN:t===o("MAWMsg").MAWRavenMsgEphemeralMediaState.SEEN?r("RavenMessagingState").REPLAYED:e(t);case o("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT:return e(t)}}l.getEphemeralMediaState=e,l.getEphemeralMediaViewMode=s,l.deriveRavenSettings=u,l.getNextRavenMessageEphemeralState=c}),98);
__d("MAWMediaAfterTxns",["MAWBridgeTypesCreators","MAWDbMedia","MAWDexieTable","MAWIndexedDb","MAWMediaType","MAWMediaUtils","MAWRavenUtils","MpsMediaEntryCache","MpsTypes","WAHashUtils","WAMediaUtils","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,a,i,l,u){return a.messages.where("msgId").anyOf(t.msgIds).toArray().then(function(c){var d=e.threadJid,m=o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(c,d),p=o("MAWMediaUtils").createHdTypesForBridgeMedia(c),_=e.ravenEphemeralType!=null&&e.ravenEphemeralMediaState!=null?o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:d,filteredMsgIds:m,hasMediaForUI:n,hdTypes:p,media:t,ravenSettings:o("MAWRavenUtils").deriveRavenSettings(e.ravenEphemeralType,e.ravenEphemeralMediaState),sortOrderMs:e.sortOrderMs,transportKey:l}):o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:d,filteredMsgIds:m,hasMediaForUI:n,hdTypes:p,media:t,sortOrderMs:e.sortOrderMs,transportKey:l});if(u===!0){var f,g,h,y=r("nullthrows")(t.mediaEntries.get(e.msgId)),C=o("WAMediaUtils").decodeMediaEntryData(y),b=(f=(g=t.validatedImageInfo)==null?void 0:g.thumbnailPlaintextHash)!=null?f:(h=t.validatedVideoInfo)==null?void 0:h.thumbnailPlaintextHash;if(b==null){var v=C.downloadableThumbnail;(v==null?void 0:v.fileSha256)!=null&&(b=o("WAHashUtils").toPlaintextHash(v.fileSha256))}o("MpsMediaEntryCache").storeEntry({decodedMediaEntry:C,mediaEntry:y,mediaKeyTimestamp:t.ts,message:{messageId:o("MpsTypes").toMessageId(e.externalId),threadId:o("MpsTypes").toThreadId(e.threadJid)},plaintextHash:t.plaintextHash,serverMediaType:r("nullthrows")(o("MAWMediaType").getMediaType(t.mediaType)),thumbnailHash:b})}return s(a,babelHelpers.extends({},_,{skipShouldUpdateHasMore:i}),void 0,u)})}function s(e,t,n,r){return u(t)?o("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(e,t,n).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:e},r)}):(o("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:t},r),o("MAWDexieTable").dexieResolve())}function u(e){if(e.ephemeralMediaState!=null||e.ephemeralMediaViewMode!=null)return!1;switch(e.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:case o("MAWDbMedia").MEDIA_TYPE.VIDEO:case o("MAWDbMedia").MEDIA_TYPE.GIF:case o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return!0;default:return!1}}l.handleNewMediaAfterTxn=e,l.handleNewMediaAfterTxnWithBridgeMedia=s}),98);
__d("MAWVideoAudioValidationUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return{audioAvgBitsPerSecond:e.audioAvgBitsPerSecond!=null?Math.round(e.audioAvgBitsPerSecond):null,audioNumberOfChannels:e.audioNumberOfChannels!=null?Math.round(e.audioNumberOfChannels):null,audioSamplingRate:e.audioSamplingRate!=null?Math.round(e.audioSamplingRate):null,audioStreamType:e.audioStreamType,validatedMimeType:e.validatedMimeType,videoAvgBitsPerSecond:e.videoAvgBitsPerSecond!=null?Math.round(e.videoAvgBitsPerSecond):null,videoCalculatedFps:e.videoCalculatedFps!=null?Math.round(e.videoCalculatedFps):null,videoDuration:e.videoDuration!=null?Math.round(e.videoDuration):null,videoHeight:e.videoHeight!=null?Math.round(e.videoHeight):null,videoNominalFps:e.videoNominalFps!=null?Math.round(e.videoNominalFps):null,videoStreamType:e.videoStreamType,videoWidth:e.videoWidth!=null?Math.round(e.videoWidth):null}}i.normalizeValidationResult=e}),66);
__d("MAWHandleMediaDownloadApi",["MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLegacyMediaDownloadManager","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWMediaUtils","MAWMsgType","MAWTransactionMode","MAWVideoAudioValidationUtils","MAWXMAUtils","MWFBLogger","Promise","WAArmadilloXMA.pb","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=o("MWFBLogger").MWMediaLogger().tags([o("MAWLoggerUtils").Tag.MediaDownload,o("MAWLoggerUtils").Tag.MessageReceive]);function p(t,r,a,i,l,c){m.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start persisting media blob"])));var p=t.db,_=o("MAWMediaUtils").genHMACPlaintextHash(r),h=t.persistChunk?o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(t.db,r,i,a):null;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(p,l),p.media.where("hashedPlaintextHash").equals(_).first(),h]).then(function(e){var t=e[0],l=e[1],_=e[2];if(l==null)return m.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Media is null when storing downloaded blob"]))),o("WAResultOrError").makeError("missing-media-on-save");var h,y=!1;return h=o("MAWLegacyMediaDownloadManager").getFromMediaPlaintextDownloadManager(r),h==null&&(h=o("MAWLegacyMediaDownloadManager").getFromMediaDownloadManager(l.mediaId),y=!0),h!=null&&(m.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["resolve MediaPlaintextDownloadManager promise"]))),h((d||(d=n("Promise"))).resolve(new Blob([i],{type:a}))),o("MAWLegacyMediaDownloadManager").removeFromMediaPlaintextDownloadManager(r),y&&o("MAWLegacyMediaDownloadManager").removeFromMediaDownloadManager(l.mediaId)),f(p,t).then(function(e){return e?p.messages.where("msgId").anyOf(l.msgIds).toArray().then(function(e){return o("MAWDbXMATxns").getXMAFromMsgs(p,e).then(function(e){return o("MAWDexieTable").dexieAll(e.map(function(e){if(!o("MAWXMAUtils").isXMAStoryReply(e.targetType)&&e.defaultPreviewMediaId===l.mediaId)return o("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(p,e,l)}))}).then(function(){return e})}).then(function(e){return g(p,e)}):p.messages.where("msgId").anyOf(l.msgIds).toArray().then(function(e){return p.threads.where("jid").anyOf(e.map(function(e){return e.threadJid})).toArray().then(function(n){return o("MAWDexieTable").dexieAll(n.map(function(n){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(e),a=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n.jid,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(e,n.jid),hasMediaForUI:!0,hdTypes:r,media:l,sortOrderMs:t==null?void 0:t.sortOrderMs});return o("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(p,a,e)}))}).then(function(){return e})}).then(function(e){return g(p,e)})}).then(function(){var e,t,n,r,a,s,u,d,m,_,f,g=l.mediaType===o("MAWDbMedia").MEDIA_TYPE.VIDEO?o("MAWVideoAudioValidationUtils").normalizeValidationResult({audioAvgBitsPerSecond:c==null||(e=c.audioStreamReport)==null?void 0:e.avgBitsPerSecond,audioNumberOfChannels:c==null||(t=c.audioStreamReport)==null?void 0:t.numberOfChannels,audioSamplingRate:c==null||(n=c.audioStreamReport)==null?void 0:n.samplingRate,audioStreamType:c==null||(r=c.audioStreamReport)==null?void 0:r.streamType,validatedMimeType:c==null?void 0:c.mimeType,videoAvgBitsPerSecond:c==null||(a=c.videoStreamReport)==null?void 0:a.avgBitsPerSecond,videoCalculatedFps:c==null||(s=c.videoStreamReport)==null?void 0:s.calculatedFps,videoDuration:c==null||(u=c.videoStreamReport)==null?void 0:u.duration,videoHeight:c==null||(d=c.videoStreamReport)==null?void 0:d.videoHeight,videoNominalFps:c==null||(m=c.videoStreamReport)==null?void 0:m.nominalFps,videoStreamType:c==null||(_=c.videoStreamReport)==null?void 0:_.streamType,videoWidth:c==null||(f=c.videoStreamReport)==null?void 0:f.videoWidth}):void 0,h=o("MAWDbMediaTxns").updateMedia(p,l,{size:i.byteLength,validatedResult:g});return h}).then(function(){return o("WAResultOrError").makeResult()})})}var _=o("MAWIndexedDb").makeMsgrTransactor({chunk:(c=o("MAWTransactionMode")).READONLY,media:c.READWRITE,messages:c.READONLY,receiverFetchInfo:c.READONLY,threads:c.READONLY,xma:c.READONLY},"handleMediaDownload",function(e){return(function(t,n,r,o,a){return p({db:e,persistChunk:!1},t,n,r,o,a)})});function f(e,t){var n;return t==null?o("MAWDexieTable").dexieResolve(!1):t.type===o("MAWMsgType").MSG_TYPE.XMA?o("MAWDexieTable").dexieResolve(!0):((n=t.quote)==null?void 0:n.content.xmaMessageType)===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY?o("MAWDexieTable").dexieResolve(t.type===o("MAWMsgType").MSG_TYPE.TEXT):o("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(e,t.msgId).then(function(e){return e!=null})}function g(e,t){return o("MAWGetMsgQuoteTxn").maybeBatchGetMsgsByQuoteExternalId(e,t.map(function(e){return e.externalId})).then(function(t){return t.map(function(t){return t.source="eb_restore",o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})})}l.handleMediaDownload=_}),98);
__d("MAWMediaDownloadStatusForUI",["MAWBridge","MAWLoggerUtils","MAWMediaDownloadStatus","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MWFBLogger").MWMediaLogger().tags([o("MAWLoggerUtils").Tag.MediaDownload,o("MAWLoggerUtils").Tag.MessageReceive]);function u(e){var t=e.details,n=e.hash,r=e.status,o=e.type,a=e.validationResult;c({details:t,hash:n,status:r,type:o,validationResult:a})}function c(e){var t=e.details,n=e.hash,r=e.status,a=e.type,i=e.validationResult;o("MAWBridge").getBridge().fireAndForget("event","updateMediaStatus",{details:t,key:n,status:r,type:a,validationResult:i})}function d(t){switch(t){case"disconnected":case"backoff":case"body-network-error":case"no-host":case"download-throttled":case"max-attempts-exceeded":case"runtime-error":case"access-expired":case"http-fetch-exception":case"http-fetch-aborted":case"unspecified-http-error":case"server-timeout":return r("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE;case"request-error":case"media-not-found":case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"decryption-error":case"enc-hash-mismatch":case"hash-mismatch":case"ciphertext-hash-mismatch":case"signature-expired":return r("MAWMediaDownloadStatus").NOT_MANUAL_RETRYABLE_FAILURE;default:return s.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["getStatusTypeFromWAAPIDownloadMediaError: Unknown error type ",""])),String(t)),r("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE}}l.sendMediaDownloadStatusToUI=u,l.getStatusFromWAAPIDownloadMediaError=d}),98);
__d("MAWMediaBackupTxns",["FBLogger","MAWDbMediaTxns","MAWDexieTable","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=1;function m(t,n,a,i,l,p){return p===void 0&&(p=0),i==null?o("MAWDexieTable").dexieResolve():o("MAWDbMediaTxns").maybeGetMediaBackupRowFromObjectId(t,i).then(function(_){if(_==null){var f={mediaId:n,msgId:a,objectId:i};return l!=null&&(f=babelHelpers.extends({},f,{fbid:l})),t.mediaBackup.add(f).then(function(e){return babelHelpers.extends({},f,{mediaBackupId:e})}).catch(function(u){if(u.name==="ConstraintError"){if(p<d)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry. Will attempt a retry. Error: ",""])),u),m(t,n,a,i,l,p+1);throw r("FBLogger")("messenger_web").mustfixThrow("Failed to add mediaBackup entry. Original error: %s, %s",u.name,u.message)}throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry: ",""])),u),u})}else{if(_.mediaId!==n||_.msgId!==a)return o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"]))),_;if(_.fbid==null&&l!=null){var g=babelHelpers.extends({},_,{fbid:l});return t.mediaBackup.put(g).then(function(e){return g})}else o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"])));return _}})}l.linkMediaBackup=m}),98);
__d("WASortedLists",[],(function(t,n,r,o,a,i){"use strict";function e(){return[]}function l(){return[]}function s(e,t){return e.filter(t)}function u(e,t){return g(e.map(t))}function c(e,t){for(var n=e.length===t.length,r=0;n&&r<e.length;r++)e[r]!==t[r]&&(n=!1);return n}function d(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return e;return e.concat([t]).sort()}function m(e,t){if(e.length<t.length)return!1;for(var n=!0,r=0,o=0;n&&o<t.length;o++)do n=e[r]===t[o];while(!n&&++r<e.length);return n}function p(e,t){for(var n=[],r=0,o=0;r<e.length;r++){for(var a=e[r];o<t.length&&a>t[o];)o++;(o===t.length||a<t[o])&&n.push(a)}return n}function _(e,t){for(var n=[],r=0,o=0;r<e.length&&o<t.length;){var a=e[r],i=t[o];a<i?r++:(a===i&&(n.push(a),r++),o++)}return n}function f(e,t){for(var n=[],r=0,o=0;r<e.length&&o<t.length;)e[r]<t[o]?n.push(e[r++]):e[r]===t[o]?(n.push(e[r++]),o++):n.push(t[o++]);for(;r<e.length;)n.push(e[r++]);for(;o<t.length;)n.push(t[o++]);return n}function g(e){return h(e.slice().sort())}function h(e){for(var t=!1,n=0;n<e.length-1;n++)e[n]===e[n+1]&&(t=!0);if(!t)return e;for(var r=[],o=0;o<e.length-1;o++)e[o]!==e[o+1]&&r.push(e[o]);return r.push(e[e.length-1]),r}function y(e){return Array.from(e).sort()}function C(e){return e.slice().sort()}function b(e,t,n){for(var r=null,o=0;!r&&o<e.length;o++)e[o]===t&&(r=e.slice(),r[o]=n,r=h(r.sort()));return r||e}function v(e){return[e]}function S(e){return e.length<1}function R(e,t,n){return e.slice(t,n)}i.emptySet=e,i.emptyList=l,i.filter=s,i.map=u,i.areEqual=c,i.addToSet=d,i.contains=m,i.subtract=p,i.intersect=_,i.joinUniq=f,i.sortAndDedupe=g,i.asSortedSet=y,i.sort=C,i.swapIn=b,i.singleElement=v,i.isEmpty=S,i.slice=R}),66);
__d("MAWMediaManagementTxns",["EBLogger","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWMediaAfterTxns","MAWMediaBackupTxns","MAWMediaUtils","MAWMsgType","MAWODSProxy","MAWSupportedDocumentTypes","MAWWriteMsgTxns","MWFBLogger","WAErrorMessage","WAHashUtils","WAMediaUtils","WAOdsEnums","WASortedLists","WATimeUtils","emptyFunction","gkx","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=o("MWFBLogger").MWMediaLogger().tags(["MAWMediaManagementTxns"]),h=r("gkx")("23924");function y(e,t,n,r){var a,i=n==null||t.type===o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE&&(h||!o("MAWSupportedDocumentTypes").isAllowedType((a=n.validatedDocumentFileInfo)==null?void 0:a.filename));return o("MAWWriteMsgTxns").prepareMsgWriteData(e,t,r).then(function(e){return babelHelpers.extends({},e,{shouldDropDocument:i})})}function C(e,t,n,r,a){a===void 0&&(a=!1);var i={validatedAudioInfo:t.validatedAudioInfo,validatedDocumentFileInfo:t.validatedDocumentFileInfo,validatedImageInfo:t.validatedImageInfo,validatedVideoInfo:t.validatedVideoInfo},l=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),s=l.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(l.objectId):null;return R(e,n,r,t.plaintextHash,t.mediaType,t.size,t.mediaEntry,i,s,void 0,a,void 0,t.accessibilitySummaryText)}function b(e,t,n,r,a,i,l){a===void 0&&(a=!1),l===void 0&&(l=!0);var s=o("MAWMediaUtils").genHMACPlaintextHash(t.plaintextHash),u=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),c=u.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(u.objectId):null;return o("MAWDexieTable").dexieAll([L(e,n,r,c,void 0,a),o("MAWDbChunkTxns").hasMediaChunk(e,s)]).then(function(t){var r=t[0],o=t[1];return E(e,n,r,a,i,l,o)})}function v(e,t,n,r,a,i,l,s){a===void 0&&(a=!1),i===void 0&&(i=!1),s===void 0&&(s=!0);var u={validatedAudioInfo:t.validatedAudioInfo,validatedDocumentFileInfo:t.validatedDocumentFileInfo,validatedImageInfo:t.validatedImageInfo,validatedVideoInfo:t.validatedVideoInfo},c=o("MAWMediaUtils").genHMACPlaintextHash(t.plaintextHash),d=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),m=d.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(d.objectId):null;return o("MAWDexieTable").dexieAll([S(e,n,t.plaintextHash,t.mediaType,t.size,t.mediaEntry,u,m,void 0,a,t.accessibilitySummaryText),o("MAWDbChunkTxns").hasMediaChunk(e,c)]).then(function(t){var r=t[0],o=t[1];return E(e,n,r,a,l,s,o)})}function S(e,t,n,r,o,a,i,l,s,u,c){return u===void 0&&(u=!1),R(e,t.msgId,t.type,n,r,o,a,i,l,s,u,void 0,c).then(function(n){return L(e,t,n,l,void 0,u)})}function R(t,n,r,a,i,l,d,m,p,_,f,h,y){return f===void 0&&(f=!1),h===void 0&&(h=0),y===void 0&&(y=null),o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(t,a).then(function(C){var b=new Map(C==null?void 0:C.mediaEntries),v=x(d,p,_);if(v!=null&&b.set(n,v),C){var S;h>0&&g.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Media found after retry for plaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(a)),C.msgIds||g.mustfix("Media missing msgIds: media type=%s",C.mediaType),C.mediaType||g.mustfix("Media missing mediaType: type=%s ; msg type=%s",i,r);var L=babelHelpers.extends({},C,m,{accessibilitySummaryText:y!=null?y:void 0,mediaEntries:b,mediaType:(S=C.mediaType)!=null?S:i,msgIds:o("WASortedLists").addToSet(C.msgIds||o("WASortedLists").emptySet(),n)});return t.media.put(L).then(function(){return L})}else{var E=o("MAWMediaUtils").genHMACPlaintextHash(a),k=babelHelpers.extends({accessibilitySummaryText:y!=null?y:void 0,fbid:_!=null?_:void 0,hashedPlaintextHash:E,mediaEntries:b,mediaType:i,msgIds:o("WASortedLists").singleElement(n),objectId:p!=null?p:void 0,plaintextHash:a,size:l,ts:o("WATimeUtils").unixTime()},m);return t.media.add(k).then(function(e){return babelHelpers.extends({},k,{mediaId:e})}).catch(function(e){var C=o("WAErrorMessage").maybeGetMessageFromError(e);if(h>0)throw g.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry: plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),E,C),g.catching(e).MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry."]))),e;return g.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),E,C),o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_MEDIA_DB_DUPLICATE_MEDIA,key:"retry"}),R(t,n,r,a,i,l,d,m,p,_,f,h+1,y)})}})}function L(e,t,n,r,a,i){i===void 0&&(i=!1);var l=i?o("MAWDexieTable").dexieResolve():o("MAWDbMsgTxns").updateMediaId(e,t,n.mediaId,n.plaintextHash);return l.then(function(){return o("MAWMediaBackupTxns").linkMediaBackup(e,n.mediaId,t.msgId,r,a).then(function(){return n})})}function E(e,t,n,r,a,i,l){return r===void 0&&(r=!1),i===void 0&&(i=!0),o("EBLogger").EBLogger().tags(["restore","handleUnstoredDbMedia"]).DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Inserted media with plaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(n.plaintextHash)),t.type!==o("MAWMsgType").MSG_TYPE.REVOKED&&!r&&i?o("MAWMediaAfterTxns").handleNewMediaAfterTxn(t,n,l,e,void 0,a).then(function(){return n}):o("MAWDexieTable").dexieResolve(n)}var k=function(t,n,r,a,i,l,s,u,c,d,m){return c===void 0&&(c=!1),o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,n).then(function(e){if(e==null)throw g.mustfixThrow("Do not have the media message in db when attachHashToMediaMsg");return S(t,e,r,l,s,m,u,a,i,c,d)})},I=function(t,n,a){return o("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(t,n).then(function(e){if(e!=null){var n=babelHelpers.extends({},e);return a.validatedAudioInfo!=null&&(n.validatedAudioInfo=babelHelpers.extends({},e.validatedAudioInfo,a.validatedAudioInfo)),a.validatedVideoInfo!=null&&(n.validatedVideoInfo=babelHelpers.extends({},e.validatedVideoInfo,a.validatedVideoInfo)),a.validatedImageInfo!=null&&(n.validatedImageInfo=babelHelpers.extends({},e.validatedImageInfo,a.validatedImageInfo)),a.validatedDocumentFileInfo!=null&&(n.validatedDocumentFileInfo=babelHelpers.extends({},e.validatedDocumentFileInfo,a.validatedDocumentFileInfo)),t.media.update(n.mediaId,n).then(r("emptyFunction"))}else g.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing, can't update media info"])))})},T=function(t,n,r,a){return o("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(t,n).then(function(e){if(e!=null){var n=a?e.mediaEntries.set(r,a):e.mediaEntries,i=babelHelpers.extends({},e,{mediaEntries:n});return t.media.update(i.mediaId,i)}else return g.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][updateMediaWithEncodedMediaEntryData] media entry is missing, can't upate media with encoded data"]))),o("MAWDexieTable").dexieResolve()})};function D(e,t,n,r,a,i,l,s,u,c,d,m){return c===void 0&&(c=!1),o("MAWDexieTable").dexieAll([k(e,t,r,a,i,l,u.size,s,c,d,m),o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(e,r,n,u.type)]).then(function(e){var t=e[0];return t})}function x(e,t,n){var r,a=e;return a!=null&&t!=null&&(r=o("WAMediaUtils").decodeMediaEntryData(a),a=o("WAMediaUtils").encodeMediaEntryWithUpdatedObjectId(r,t)),a!=null&&n!=null&&(r=o("WAMediaUtils").decodeMediaEntryData(a),a=o("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(r,n)),a}function $(e,t,n){var r=new Map;return e.mediaEntries.forEach(function(e,a){var i=o("WAMediaUtils").decodeMediaEntryData(e),l=i.objectId===t?o("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(i,n):e;r.set(a,l)}),r}function P(e,t,n,r,a){a===void 0&&(a=!0);var i=new Map;return t.forEach(function(e){var t,n=(t=i.get(e.hashedPlaintextHash))!=null?t:[];n.push(e),i.set(e.hashedPlaintextHash,n)}),o("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(e,[].concat(Array.from(i.keys()))).then(function(l){var s=new Map(l.map(function(e){return[e.hashedPlaintextHash,e]})),u=new Map;t.forEach(function(e){var t=s.get(e.hashedPlaintextHash);if(e!=null){var n=x(e==null?void 0:e.entry,e==null?void 0:e.objectId,e==null?void 0:e.fbId);if(t){var r=n?t.mediaEntries.set(e.msgId,n):t.mediaEntries,a=babelHelpers.extends({},t,{mediaEntries:r,msgIds:o("WASortedLists").addToSet(t.msgIds,e.msgId)});s.set(e.hashedPlaintextHash,a)}else B(u,e,n)}});var c=new Map,d=new Map,m=Array.from(u.values()).filter(function(e){return N(e,c,d)});return o("MAWDexieTable").dexieAll([e.media.bulkAdd(m),e.media.bulkPut(Array.from(s.values()))]).then(function(){return M(e,[].concat(Array.from(i.keys())),i,n,r,a)})})}function N(e,t,n){if(e.objectId!=null){var r=t.get(e.objectId);if(r!=null&&r!==e.hashedPlaintextHash)return g.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same objectId assigned for different mediaIds. objectId: "," shared by  hashedPlaintextHashes: "," ",""])),e.objectId,r,e.hashedPlaintextHash),!1}if(e.fbid!=null){var o=n.get(e.fbid);if(o!=null&&o!==e.hashedPlaintextHash)return g.MUSTFIX(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same FBId assigned for different mediaIds. fbId: "," - shared by hashedPlaintextHashes: "," ",""])),e.fbid,o,e.hashedPlaintextHash),!1}return e.objectId!=null&&t.set(e.objectId,e.hashedPlaintextHash),e.fbid!=null&&n.set(e.fbid,e.hashedPlaintextHash),!0}function M(e,t,n,r,a,i){return o("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(e,t).then(function(t){return o("MAWDexieTable").dexieAll([F(e,t,n)]).then(function(){return i&&w(t,n,r,e,a),t})})}function w(e,t,n,a,i){e.forEach(function(e){var l=t.get(e.hashedPlaintextHash);l!=null&&!A(l)&&r("promiseDone")(o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(a.messages.where("msgId").anyOf(e.msgIds).toArray().then(function(t){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(t),l=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(t,n),hasMediaForUI:!1,hdTypes:r,media:e,transportKey:i});return o("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,l)})))})}function A(e){return e.reduce(function(e,t){return e||t.isXMAShare},!1)}function F(e,t,n){var r=t.reduce(function(e,t){var r;return(r=n.get(t.hashedPlaintextHash))==null||r.filter(function(e){return e!=null&&!e.isXMAShare}).forEach(function(n){return e.set(n.msgId,t.mediaId)}),e},new Map);return o("MAWDbMsgTxns").bulkUpdateMediaId(e,r)}function O(e,t){var n,r,a=e?new Map([[t.msgId,e]]):new Map;return babelHelpers.extends({fbid:(n=t.fbId)!=null?n:void 0,hashedPlaintextHash:t.hashedPlaintextHash,mediaEntries:a,mediaType:t.mediaType,msgIds:o("WASortedLists").singleElement(t.msgId),objectId:(r=t.objectId)!=null?r:void 0,plaintextHash:t.plaintextHash,size:t.size,ts:o("WATimeUtils").unixTime()},t.mediaInfo)}function B(e,t,n){var r=e.get(t.hashedPlaintextHash);r==null?e.set(t.hashedPlaintextHash,O(n,t)):(n!=null&&r.mediaEntries.set(t.msgId,n),r.msgIds.push(t.msgId))}l.prepareMediaWriteData=y,l.handleUnstoredDbMediaCreation=C,l.handleUnstoredDbMediaLinking=b,l.handleUnstoredDbMedia=v,l.linkMedia=S,l.createOrUpdateMediaRow=R,l.attachHashToMediaMsg=k,l.updateMediaEntryWithValidatedMediaInfo=I,l.updateMediaWithEncodedMediaEntryData=T,l.attachHashAndSaveMedia=D,l.updateBackupFbidInMediaEntries=$,l.bulkLinkMedia=P,l.linkMessageAndMediaBackupForMediaList=M}),98);
__d("MAWMediaRetryInfo",[],(function(t,n,r,o,a,i){"use strict";var e=new Map;function l(t,n){e.set(t,n)}function s(t){return e.get(t)}function u(t){e.has(t)&&e.delete(t)}i.setRetriedMediaInfo=l,i.getRetriedMediaInfo=s,i.clearRetriedMediaInfo=u}),66);
__d("WAAPI",["cr:21048"],(function(t,n,r,o,a,i,l){"use strict";l.default=n("cr:21048")}),98);
__d("MAWHandleEchoMediaMsgsRestoreV2",["EBLogger","EchoMessage","EchoMessageMediaFieldUtils","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTypesCreators","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWEncodeMediaTransportProtocol","MAWFrontendMediaUtils","MAWGetMsgForProtocolMsgIdTxn","MAWHandleMediaDownloadApi","MAWIndexedDb","MAWJids","MAWJobDefinitions","MAWJobManager","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaManagementTxns","MAWMediaRetryInfo","MAWMediaUtils","MAWSupportedDocumentTypes","MAWTransactionMode","WAAPI","WAArmadilloXMA.pb","WABase64","WAGetAgeBucketForMediaKeyTimestamp","WAGetStorageQplAnnotations","WAHashUtils","WAIsMediaExpiredError","WAJids","WAJobOrchestratorTypes","WAMediaUtils","WAStartMediaDownloadQplFlow","WATimeUtils","cr:10071","getErrorSafe","gkx","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F,O,B,W,q,U,V=o("EBLogger").EBLogger().tags(["restore"]);function H(e){var t=K(e);return t.then(function(t){var n=new Map;return e.forEach(function(e){var r=t.get(e),o=r==null?void 0:r.blobData;n.set(e,o)}),Promise.resolve(n)})}function G(e){return e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG?"image/jpeg":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_PNG?"image/png":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER?"image/webp":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF?"image/gif":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4?"audio/mp4":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV?"audio/wav":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.XMA?"xma":(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}async function z(t,n,a){if(t.length===0)return Promise.resolve();var i=[],l=[],v=new Map,S=new Map;t.map(function(t){var n,a=t.mediaData,h=t.messageTimestamp,y=X(a.plaintextHash),C=a.attachmentObjectId,b=a.attachmentType,R=a.backupEntFbid,L=a.directPath,E=a.filename,k=a.height,I=a.mediaContentType,T=a.mediaKeyTimestamp,D=a.mediaPlayableDuration,x=a.previewContentHeight,$=a.previewContentType,P=a.previewContentWidth,N=a.size,M=a.width,w=o("WAHashUtils").stringToPlaintextHash(y),A=o("MAWMediaUtils").genHMACPlaintextHash(w);l.push(A);var F=I!=null?o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(I,t.isXMA):$!=null?o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(G($)):null;if(F==null)return V.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - media content type null, msg id: ",""])),t.externalId),V.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - media content type null"]))),Promise.resolve();if(b===o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT&&!o("MAWSupportedDocumentTypes").isAllowedType(E))return V.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - document extension is disallowed, msg id: ",""])),t.externalId),Promise.resolve();var O=t.mediaData.encryptedHash;if(O==null)return V.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash cannot be null, msg id: ",""])),t.externalId),V.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash cannot be null"]))),Promise.resolve();var B=t.mediaData.mediaKey;if(B==null)return V.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Media key cannot be null, msg id: ",""])),t.externalId),V.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Media key cannot be null"]))),Promise.resolve();var W=F.mediaType,q=F.serverMediaType,U=o("WAMediaUtils").stringToDeliveryObjectId(C),H=R!=null?o("WAMediaUtils").stringToBackupEntFbid(R):void 0,z=t.threadJId,j=Y({filename:E,height:k,mediaPlayableDuration:D,mediaType:W,previewContentHeight:x,previewContentWidth:P,width:M});S.set(U,{filename:E,height:k,mediaPlayableDuration:D,mediaType:W,messageTimestamp:h,plaintextHash:w,previewContentHeight:x,previewContentWidth:P,serverMediaType:q,threadJId:z,width:M});var K=null;if(t.previewMediaData!=null)try{K=Z(t.previewMediaData),K!=null&&K.objectId==null&&V.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["downloadableThumbnail was created without metadata, source: echo"])))}catch(e){var Q=r("getErrorSafe")(e);V.catching(Q).DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Unable to construct downloadableThumbnail from previewMediaData, msg id: ",""])),t.externalId),V.catching(Q).MUSTFIX(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Unable to construct downloadableThumbnail from previewMediaData"])))}if(O!=null){var ee=J(y,O,B,L,T,q,E,H,U,K,N);i.push({entry:ee,fbId:H,hashedPlaintextHash:A,isXMAShare:t.isXMA,mediaInfo:j,mediaType:W,msgId:t.msgId,objectId:U,plaintextHash:w,size:N!=null?N:0})}var te=(n=v.get(A))!=null?n:[];te.push(t),v.set(A,te)});var R=a!==r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,L=await j(i,n,R),E=await H(l),k=[];E.forEach(function(e,t){var l=v.get(t);l==null||l.forEach(function(l){if(l!=null){if(e!=null){V.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["media for message: "," is already downloaded on the device"])),l.externalId);var s=L.find(function(e){return e.plaintextHash===l.mediaData.plaintextHash});if(s==null){V.DEBUG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message with mediaKey ",""])),l.mediaData.mediaKey);return}return Q(s.msgIds).then(function(e){var t=e.filter(function(e){return o("MAWDbMsg").isMediaMsg(e)});if(t.length>0){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(t),a=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:l.threadJId,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(t,n),hasMediaForUI:!0,hdTypes:r,media:s,transportKey:"EncryptedBackups"}),i=o("MAWMediaUtils").annotateBridgeMediaForDisplay(a,t);o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMedia",value:i}]})}})}var u=S.get(o("WAMediaUtils").stringToDeliveryObjectId(l.mediaData.attachmentObjectId));if(!(l==null||u==null)){var c=u.filename,d=u.height,m=u.mediaPlayableDuration,p=u.mediaType,_=u.messageTimestamp,f=u.plaintextHash,g=u.previewContentHeight,v=u.previewContentWidth,R=u.serverMediaType,E=u.threadJId,I=u.width,T=o("WAJids").extractUserId(o("MAWJids").toUserJid(l.threadJId)),D=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(R,l.isXMA);if(D!=null){var x={attachmentObjectId:o("WAMediaUtils").stringToDeliveryObjectId(l.mediaData.attachmentObjectId),mediaType:D,messageId:l.externalId,messageTimeStamp:l.messageTimestamp,msgId:l.msgId,plaintextHash:f,productType:o("MAWConfig").getConfig().productTypeForEBAttachments,threadId:T,threadJid:E},$=i.find(function(e){return e.hashedPlaintextHash===t}),P=$==null?void 0:$.entry;if(P==null){V.DEBUG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message, plaintextHash: ",", msg id: ",""])),o("WAHashUtils").sanitisePlaintextHash(o("WAHashUtils").stringToPlaintextHash(l.mediaData.plaintextHash)),l.externalId),V.MUSTFIX(b||(b=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message"])));return}if(a===r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE)return;var N=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:{author:l.author,chat:l.threadJId,externalId:l.externalId},triggerUIView:null});k.push(ee({author:l.author,directPath:l.mediaData.directPath,echoMsg:l.echoMsg,externalId:l.externalId,filename:c,hashedPlaintextHash:t,height:d,isXMA:l.isXMA,mediaPlayableDuration:m,mediaType:p,messageTimestamp:_,plaintextHash:f,previewContentHeight:g,previewContentWidth:v,threadJId:E,width:I},void 0,x,void 0,o("WAMediaUtils").decodeMediaEntryData(P),N))}}}})}),await Promise.all(k)}var j=(q=o("MAWIndexedDb")).makeMsgrTransactor({media:(U=o("MAWTransactionMode")).READWRITE,mediaBackup:U.READWRITE,messages:U.READWRITE},"restoreLinkMedias",function(e){return(function(t,n,r){return o("MAWMediaManagementTxns").bulkLinkMedia(e,t,n,"EncryptedBackups",r)})}),K=q.makeMsgrTransactor({chunk:U.READONLY},"getChunksByHash",function(e){return function(t){return o("MAWDbChunkTxns").maybeBulkGetChunksFromHash(e,t)}}),Q=q.makeMsgrTransactor({messages:U.READONLY},"getMessagesForMsgIds",function(e){return function(t){return e.messages.where("msgId").anyOf(t).toArray()}});function X(e){if(e.endsWith("="))for(var t="",n=0;n<e.length;n++){var r=e.charAt(n);if(r==="=")return t;t+=r}return e}function Y(e){var t=e.height,n=e.mediaType,r=e.width,a=e.previewContentHeight,i=e.previewContentWidth,l=e.mediaPlayableDuration,s=e.filename;return{validatedAudioInfo:n==="Ptt"&&l!=null?{duration:re(l),mimetype:o("MAWEncodeMediaTransportProtocol").AUDIO_WAV_MIME_TYPE,played:!1}:null,validatedDocumentFileInfo:n==="DocumentFile"?{filename:s,mimetype:o("MAWEncodeMediaTransportProtocol").FILE_MIME_TYPE}:null,validatedImageInfo:n==="Image"?{height:t,jpegThumbnailHeight:a,jpegThumbnailWidth:i,width:r}:n==="Gif"||n==="Sticker"?{height:t,jpegThumbnailHeight:t,jpegThumbnailWidth:r,width:r}:null,validatedVideoInfo:n==="Video"?{duration:l,height:t,jpegThumbnailHeight:a,jpegThumbnailWidth:i,mimetype:o("MAWEncodeMediaTransportProtocol").VIDEO_MIME_TYPE,width:r}:null}}function J(e,t,n,r,a,i,l,s,u,c,d){var m=o("WABase64").decodeB64UrlSafe(e,!0),p=o("WABase64").decodeB64UrlSafe(t,!0),_=o("WABase64").decodeB64UrlSafe(n,!0);return o("WAMediaUtils").rawDataToMediaEntry({directPath:r,downloadableThumbnail:c!=null?c:void 0,fbid:s!=null?s:void 0,fileEncSha256:p,filename:l,fileSha256:m,mediaKey:_,mediaKeyTimestamp:a!=null?o("WATimeUtils").castToUnixTime(a):void 0,objectId:u!=null?u:void 0,serverMediaType:i,size:d!=null?d:void 0})}function Z(e){var t=e.attachmentObjectId,n=e.directPath,r=e.encryptedHash,a=e.mediaKey,i=e.mediaKeyTimestamp,l=e.plaintextHash;if(r==null){V.MUSTFIX(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash is null - unable to download thumbnail"])));return}else{var s=i!=null?o("WATimeUtils").castToUnixTime(i):void 0,u=a!=null?o("WAMediaUtils").castToMediaKey(o("WABase64").decodeB64UrlSafe(a,!0)):void 0,c=o("WABase64").decodeB64UrlSafe(l,!0),d=o("WABase64").decodeB64UrlSafe(r,!0);return{directPath:n,fileEncSha256:d,fileSha256:c,mediaKey:u,mediaKeyTimestamp:s,objectId:t}}}var ee=async function(t,n,a,i,l,s){var e,u,c,d,m,p;V.DEBUG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["start media download from whatsapp infra. traceId: ",""])),n);var _=t.author,f=t.externalId,g=t.filename,h=t.hashedPlaintextHash,y=t.height,C=t.mediaPlayableDuration,b=t.mediaType,v=t.messageTimestamp,x=t.plaintextHash,$=t.previewContentHeight,P=t.previewContentWidth,N=t.threadJId,M=t.width,w={author:_,chat:N,externalId:f},A=s!=null?s:o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:w,triggerUIView:null});o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore",hash:x,status:r("MAWMediaDownloadStatus").DOWNLOADING,type:"main"});var F=((e=(u=o("MAWMediaRetryInfo").getRetriedMediaInfo(f))==null?void 0:u.isXMA)!=null?e:!1)||((c=t==null?void 0:t.isXMA)!=null?c:!1),O=((d=o("MAWMediaRetryInfo").getRetriedMediaInfo(f))==null||(d=d.echoMsg)==null?void 0:d.serializationOrigin)||(t==null||(m=t.echoMsg)==null?void 0:m.serializationOrigin)||o("EchoMessage").EchoSerializationOriginType.UNKNOWN,B=r("gkx")("23960");if(A.addPoint("download_media_start",{bool:{isEBDownloadEnforced:a==null&&B,isRetryFromMI:a==null,isXMA:F,pathMismatch:i!==l.directPath},int:{mediaEntrySize:l.size},string:{oldDirectPath:(p=t==null?void 0:t.oldDirectPath)!=null?p:"",origin:O,restorationCdnUrl:i!=null?i:""}}),o("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(e){A.addAnnotations(e)}),a!=null&&B)return V.DEBUG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["downloading media from MI directly. externalId ","."])),w.externalId),ae({decodedMediaEntry:l,isEBDownloadEnforced:B,mediaDownloadRequest:t,protocolMsgId:w,retryPayload:a});var W=o("WAMediaUtils").validateDecodedMediaEntryForDownload(l);if(!W.success){V.DEBUG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["media entry validation failed. externalId ",". traceId: ",". error: ","."])),w.externalId,n,W.error),V.MUSTFIX(E||(E=babelHelpers.taggedTemplateLiteralLoose(["media entry validation failed. error: ","."])),W.error),A.endFail("download_media_fail",{string:{failReason:W.error}});return}var q=await r("WAAPI").cachedDownloadFullMediaOnly({downloadMediaMetric:A,hash:x,mediaEntry:W.value});if(q.success){A.addPoint("download_media_end");var U=q.value,H=U.mimeType,G=U.plaintext;await o("MAWHandleMediaDownloadApi").handleMediaDownload(x,H,G,w),o("MAWMediaRetryInfo").clearRetriedMediaInfo(f);var z=Y({filename:g,height:y,mediaPlayableDuration:C,mediaType:b,previewContentHeight:$,previewContentWidth:P,width:M});await ne(h,z),V.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["media download complete. externalId ",". traceId: ",""])),w.externalId,n),A.endSuccess(),o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore_success",hash:x,status:r("MAWMediaDownloadStatus").SUCCESS,type:"main"})}else{var j=q.error;if(o("WAIsMediaExpiredError").isMediaExpiredError(j)&&a)A.addPoint("eb_resign_requested"),A.endSuccess(),V.WARN(I||(I=babelHelpers.taggedTemplateLiteralLoose(["Retry download media as signature has expired and should be renewed. externalId ",". traceId: ",""])),w.externalId,n),await ae({decodedMediaEntry:l,isEBDownloadEnforced:!1,mediaDownloadRequest:t,protocolMsgId:w,retryPayload:a});else{V.DEBUG(T||(T=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: "," "," when downloading. Message timestamp: ",". traceId: ",""])),f,j,v,n),V.MUSTFIX(D||(D=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: ",""])),j);var K={string:{directPath:l.directPath,error:"media_download_failure",restorationCdnUrl:i!=null?i:""}};A.endFail(j,K),o("MAWMediaRetryInfo").clearRetriedMediaInfo(f),o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:j,hash:x,status:o("MAWMediaDownloadStatusForUI").getStatusFromWAAPIDownloadMediaError(j),type:"main"})}}},te=q.makeMsgrTransactor({media:U.READONLY,mediaBackup:U.READONLY,messages:U.READONLY},"invokeRestoreAccessCheckSprocToDownloadAttachment",function(e){return(function(t,n,r){return o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(e,n.plaintextHash).then(function(a){if(a){V.DEBUG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["start resign cdn url through sproc"])));var i=ie(a,n.attachmentObjectId);return o("MAWDbMsgTxns").getMsgsByMsgIds(e,i).then(function(e){var i,l=e.find(function(e){return e.externalId===t});r.addPoint("resign_cdn_url_bridge_call",{bool:{isForwarded:(i=l==null?void 0:l.isForwarded)!=null?i:!1},int:{duplicateMsgsCount:e.length,msgXMAType:l==null?void 0:l.xmaMessageType,totalMediaEntries:a.mediaEntries.size},int_array:{duplicateXMATypes:e.map(function(e){var t;return(t=e.xmaMessageType)!=null?t:0})},string:{msgType:l==null?void 0:l.type},string_array:{duplicateMsgs:e.map(function(e){return e.externalId}),duplicateMsgTypes:e.map(function(e){return e.type})}}),o("MAWIndexedDb").afterTransaction({tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:n.attachmentObjectId,mediaType:n.mediaType,messageId:t,msgId:n.msgId,plaintextHash:n.plaintextHash,productType:o("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:n.messageTimeStamp,threadId:n.threadId,threadJid:n.threadJid,traceId:r.getQPLAttrs().instanceKey}})})}else V.DEBUG($||($=babelHelpers.taggedTemplateLiteralLoose(["media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ",". traceId: ",""])),t,r.getQPLAttrs().instanceKey),V.MUSTFIX(P||(P=babelHelpers.taggedTemplateLiteralLoose(["media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ","."])),t),r.endFail("missing-media")})})}),ne=q.makeMsgrTransactor({media:U.READWRITE,messages:U.READWRITE},"updateMediaWithDownloadedChunkBlob",function(e){return(function(t,n){return o("MAWMediaManagementTxns").updateMediaEntryWithValidatedMediaInfo(e,t,n)})});function re(e){var t=Math.floor(e/1e3);return t>0?t:e}function oe(e){return e==null?!1:e===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY||e===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION}async function ae(e){var t,a=e.decodedMediaEntry,i=e.isEBDownloadEnforced,l=e.mediaDownloadRequest,s=e.protocolMsgId,u=e.retryPayload,c=await o("MAWGetMsgForProtocolMsgIdTxn").getMsgForProtocolMsgIdTxn(s);if(c.success===!0&&oe(c.value.xmaMessageType))return V.DEBUG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["Skipping media restore for expirable XMA. externalId ",". xmamessageType: ",""])),s.externalId,c.value.xmaMessageType),Promise.resolve();var d=s.externalId;o("MAWMediaRetryInfo").setRetriedMediaInfo(s.externalId,l);var m=((t=a.mediaKeyTimestamp)!=null?t:0)>1725105600,p={bool:{is_after_S441705_fix:m,isEBDownloadEnforced:i},int:{mediaKeyTimestamp:a.mediaKeyTimestamp},string:{externalId:d,mediaKeyAge:o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(a.mediaKeyTimestamp),mediaType:u.mediaType,objectId:u.attachmentObjectId,restoreEntry:"EB",restoreMethod:n("cr:10071")==null?"sproc":"gql"}},_=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:s,triggerUIView:null});_.addAnnotations(p),V.DEBUG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["start restore media from backup. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey);var f=a.mediaKey;if(f==null){V.WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["media key is missing from media entry. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey),_.endFail("missing-media-key");return}return n("cr:10071")!=null?(V.DEBUG(A||(A=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [gql]. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey),n("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:s.chat,deliveryObjectId:u.attachmentObjectId,externalId:d,mediaKey:f,mediaType:u.mediaType,sortOrderMs:u.messageTimeStamp}).then(function(e){if(r("vulture")("zP4BquwZMLWLp2xHPcGqA0y9_YQ="),e.success===!1){V.DEBUG(F||(F=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql failed: ",". hash: ",". externalId ",""])),e.error,o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d),_.endFail(e.error);return}V.DEBUG(O||(O=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql success. hash: ",". externalId ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d);var t=o("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",{deliveryObjectId:u.attachmentObjectId,msgId:u.msgId,plaintextHash:u.plaintextHash,restorationCdnUrl:e.value,scheduleConfig:{priority:o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW},traceId:_.getQPLAttrs().instanceKey});return o("MAWJobManager").getJobManager().fireAndForget(t)}).catch(function(e){var t=r("getErrorSafe")(e);V.catching(t).MUSTFIX(B||(B=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql error"]))),_.endFail("runtime-error",{string:{restoreError:t.toString()}})})):(V.DEBUG(W||(W=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [sproc]. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey),te(d,u,_))}function ie(e,t){var n,r=[];return(n=e.mediaEntries)==null||n.forEach(function(e,n){var a=o("WAMediaUtils").decodeMediaEntryData(e);a.objectId===t&&r.push(n)}),r}l.downloadMediaAndWriteToMediaStore=z,l.getBase64WithoutPadding=X,l.getMediaInfo=Y,l.constructMediaEntry=J,l.constructRawDownloadableThumbnail=Z,l.handleDownloadMedia=ee,l.invokeRestoreAccessCheckSprocToDownloadAttachment=te}),98);
__d("MAWHandleEchoMsgsRestoreApiUtils",["$InternalEnum","EBLogger","EchoMessage","EchoMessageMediaFieldUtils","MAWAckLevel","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWEBRestoreTrackingUtils","MAWJids","MAWMsgType","MAWRepliesRestoreUtils","WAJids","WAResultOrError","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("EBLogger").EBLogger().tags(["restore"]),g=n("$InternalEnum")({INITIAL_RESTORE:"initial_restore",POINT_RESTORE:"point_restore",PAGINATED_RESTORE:"paginated_restore"});function h(t,n){var r=n==null?f:f.tags([n]),a=t.contentType;switch(a){case o("EchoMessage").EchoMessageContentType.TEXT:return t.xContentType===o("EchoMessage").EchoXMessageContentType.BUMP?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE):o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.TEXT);case o("EchoMessage").EchoMessageContentType.MEDIA:return t.receiverFetchId!=null&&t.receiverFetchData!=null?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH):t.mediaData==null?o("WAResultOrError").makeError("media_mandatory_fields_missing"):o("WAResultOrError").makeResult(y(t.mediaData));case o("EchoMessage").EchoMessageContentType.PLACEHOLDER:return t.contentSubtype===o("EchoMessage").EchoMessageContentSubtype.UNSEND?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.REVOKED):(r.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",", xContentType: ",",\n      subcontent type: "," ,\n      origin: ",""])),o("EchoMessage").EchoMessageContentType.getName(a),t.xContentType!=null?o("EchoMessage").EchoXMessageContentType.getName(t.xContentType):"unknown",o("EchoMessage").EchoMessageContentSubtype.getName(t.contentSubtype),t.serializationOrigin!=null?o("EchoMessage").EchoSerializationOriginType.getName(t.serializationOrigin):"unknown"),o("WAResultOrError").makeError("unsupported_message_type"));case o("EchoMessage").EchoMessageContentType.XMA:return o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.XMA);case o("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE:return o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.CIPHERTEXT);default:return r.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",""])),o("EchoMessage").EchoMessageContentType.getName(a)),o("WAResultOrError").makeError("unsupported_message_type")}}function y(e){switch(e.attachmentType){case o("EchoMessageMediaFieldUtils").AttachmentType.IMAGE:return o("MAWMsgType").MSG_TYPE.IMAGE;case o("EchoMessageMediaFieldUtils").AttachmentType.STICKER:return o("MAWMsgType").MSG_TYPE.STICKER;case o("EchoMessageMediaFieldUtils").AttachmentType.VIDEO:return o("MAWMsgType").MSG_TYPE.VIDEO;case o("EchoMessageMediaFieldUtils").AttachmentType.GIF:return o("MAWMsgType").MSG_TYPE.GIF;case o("EchoMessageMediaFieldUtils").AttachmentType.PTT:return o("MAWMsgType").MSG_TYPE.PTT;case o("EchoMessageMediaFieldUtils").AttachmentType.XMA:return o("MAWMsgType").MSG_TYPE.XMA;case o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT:return o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}}function C(e,t,n,r,a,i){var l,s=e.from;if(s==null)return f.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Author info is missing from msg: ",""])),r),o("WAResultOrError").makeError("author_missing");var d=h(e,a);if(d.success===!1)return o("WAResultOrError").makeError(d.error);if(d==null)return o("WAResultOrError").makeError("unsupported_message_type");var m=d.value;if((l=e.isTombstoned)!=null&&l)return o("WAResultOrError").makeError("message_tombstoned");switch(m){case o("MAWMsgType").MSG_TYPE.TEXT:case o("MAWMsgType").MSG_TYPE.REVOKED:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return k(e,t,n,s,m,r,a,i);case o("MAWMsgType").MSG_TYPE.IMAGE:case o("MAWMsgType").MSG_TYPE.VIDEO:case o("MAWMsgType").MSG_TYPE.STICKER:case o("MAWMsgType").MSG_TYPE.GIF:case o("MAWMsgType").MSG_TYPE.PTT:case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return b(e,t,n,s,m,r);case o("MAWMsgType").MSG_TYPE.XMA:return S(e,t,n,s,m,r);case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return o("WAResultOrError").makeResult(D(e,t,n,s,m,r));case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return R(e,t,n,s,m,r);default:return f.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Encountered unsupported media type: ",""])),m),o("WAResultOrError").makeError("unsupported_message_type")}}function b(e,t,n,r,o,a){var i=I(e,t,n,r,o,a);return v(o,i)}function v(e,t){switch(e){case o("MAWMsgType").MSG_TYPE.IMAGE:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.IMAGE}));case o("MAWMsgType").MSG_TYPE.STICKER:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.STICKER}));case o("MAWMsgType").MSG_TYPE.VIDEO:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.VIDEO}));case o("MAWMsgType").MSG_TYPE.GIF:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.GIF}));case o("MAWMsgType").MSG_TYPE.PTT:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.PTT}));case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}));default:return f.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unsupported media message type: ",""])),e),o("WAResultOrError").makeError("unsupported_media_type")}}function S(e,t,n,r,a,i){var l;if(((l=e.xmaData)==null?void 0:l.xmaTargetType)==null)return f.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Mandatory XMA Data missing for XMA message: ",""])),i),o("WAResultOrError").makeError("xma_mandatory_fields_missing");var s=e.xmaData.xmaTargetType,u=I(e,t,n,r,a,i),c=babelHelpers.extends({},u,{type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(s)}),d=e.text;return d!=null&&(c.msgContent={content:d}),o("WAResultOrError").makeResult(c)}function R(e,t,n,r,a,i){if(e.receiverFetchData==null)return f.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Mandatory receiver fetch data missing for receiver fetch message: ",""])),i),o("WAResultOrError").makeError("receiver_fetch_mandatory_fields_missing");var l=I(e,t,n,r,a,i);return o("WAResultOrError").makeResult(babelHelpers.extends({},l,{receiverFetchId:e.receiverFetchId,type:o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}))}function L(e){if(e!=null)switch(e){case o("EchoMessage").MessageTextSize.SMALL:return 1;case o("EchoMessage").MessageTextSize.MEDIUM:return 2;case o("EchoMessage").MessageTextSize.LARGE:return 3;default:return}}function E(e){return e.text==null?null:e.editHistory.length===0?e.text:e.editHistory.sort(function(e,t){return e.timestamp-t.timestamp})[0].text}function k(e,t,n,r,a,i,l,s){var u=l==null?f:f.tags([l]),c=s==="first_edit_content"?E(e):e.text;if(c==null)return o("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotationsWorker({annotations:{string:{empty_content_msg_type:a}},pointName:"unstored_text_message_empty",traceId:l}),u.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message content is empty for the message: ",", type: ",""])),i,a),o("WAResultOrError").makeError("text_message_content_empty");var d=I(e,t,n,r,a,i,l);if(a===o("MAWMsgType").MSG_TYPE.REVOKED)return c!=null&&(d.msgContent={content:c}),e.revokeSentTimestampMs!=null&&(d.originalTs=o("WATimeUtils").castToUnixTime(e.revokeSentTimestampMs)),o("WAResultOrError").makeResult(babelHelpers.extends({},d,{revokedExternalId:o("WAStanzaUtils").toStanzaId("0"),type:o("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:e.revokeUnsentTimestampMS!=null?o("WATimeUtils").castToUnixTime(e.revokeUnsentTimestampMS):d.ts}));if(a===o("MAWMsgType").MSG_TYPE.CIPHERTEXT)return o("WAResultOrError").makeResult(babelHelpers.extends({},d,{msgContent:{content:c},specialTextSize:L(e.textSize),type:o("MAWMsgType").MSG_TYPE.CIPHERTEXT}));var m=babelHelpers.extends({},d,{msgContent:{content:c},specialTextSize:L(e.textSize),type:o("MAWMsgType").MSG_TYPE.TEXT});return o("WAResultOrError").makeResult(babelHelpers.extends({},m,{editCount:Math.max(e.editHistory.length-1,0),groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize}))}function I(e,t,n,r,a,i,l){var s=T(r,n),u={ack:s===o("WAJids").AUTHOR_ME?o("MAWAckLevel").ACK.sent:o("MAWAckLevel").ACK.received,altIndex:void 0,author:s,externalId:i,groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize,isForwarded:e.isForwarded,sortOrderMs:e.sortOrderMs,threadJid:t,ts:o("WATimeUtils").castToUnixTime(e.displayTimestampMs/1e3),type:a};if(e.authoritativeTimestampMs!=null?u.serverTs=o("WATimeUtils").castToUnixTime(e.authoritativeTimestampMs/1e3):u.serverTs=o("WATimeUtils").castToUnixTime(e.sortOrderMs/1e3),e.quoteData!=null){var c=o("MAWRepliesRestoreUtils").getQuoteDataFromEchoMessage(e,n);c!=null&&(u.quote=c,u.quoteExternalId=c.content.externalId)}return u}function T(e,t){var n=o("MAWJids").toUserJid(e.localKey);return n===t?o("WAJids").AUTHOR_ME:n}function D(e,t,n,r,a,i){var l=I(e,t,n,r,a,i);return babelHelpers.extends({},l,{type:o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}l.MAWRestoreType=g,l.getDbMsgTypeFromEchoMessage=h,l.getUnstoredDbMessageFromEchoMessage=C,l.resolveAuthorFromEchoAddress=T}),98);
__d("MAWRepliesRestoreUtils",["FBLogger","MAWBridgeMsg","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWTransactionMode","MAWUpdateQuotedMsgTxns","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e=["msgId","originalTs","rowId","threadJid","unsendMsgContentDeleteTs"],s,u;function c(e,t){if(t==null||!o("MAWMsgType").isQuotedMsgType(t.type))return e;var n={author:t.author,externalId:t.externalId,ts:t.ts,type:t.type},r={content:n,remoteJid:null};return babelHelpers.extends({},e,{quote:r})}function d(e,t){if(e.quoteData!=null&&e.quoteData.quoteMessageId!=null&&e.quoteData.quoteMessageSender!=null){var n,r={author:o("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(e.quoteData.quoteMessageSender,t),externalId:(n=e.quoteData)==null?void 0:n.quoteMessageId,ts:e.displayTimestampMs,type:o("MAWMsgType").MSG_TYPE.TEXT};return{content:r,remoteJid:null}}else o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Quote data is missing for message: ",""])),e.messageId);return null}var m=o("MAWIndexedDb").makeMsgrTransactor({chunk:(u=o("MAWTransactionMode")).READONLY,media:u.READONLY,messages:u.READWRITE,threads:u.READWRITE,xma:u.READONLY},"updateQuoteDataForReplyMessages",function(e){return(function(t,n,r){n==null||n.addPoint("replies_restore_start");var a=t.restoredMsgsData;if(a){var i=a.existingMsgs,l=a.newlyAddedMsgs,s=l.concat(i);return o("MAWDexieTable").dexieAll(s.map(function(t){return o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(e,t.threadJid,t).then(function(e){var n=[];return t.quoteExternalId!=null&&n.push(t),e!=null&&n.push.apply(n,e),n})})).then(function(t){var n=t.flat();return p(e,n,r)}).then(function(e){return n==null||n.addPoint("replies_restore_end",{int:{replies:e}}),e})}return o("MAWDexieTable").dexieResolve(0)})});function p(e,t,n){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=_(t);if(t.threadJid!=null)return o("MAWGetMsgQuoteTxn").enhanceMsgWithQuoteInfo(e,n,t.threadJid).then(function(e){return babelHelpers.extends({},e,{msgId:t.msgId,originalTs:t.originalTs,protocolMsgId:t.protocolMsgId,rowId:t.rowId,threadJid:t.threadJid,unsendMsgContentDeleteTs:t.unsendMsgContentDeleteTs})});r("FBLogger")("labyrinth_web","thread_id_absent").mustfix("Reply restore: threadId cannot be null for a restored msg")})).then(function(e){return e.filter(Boolean).filter(function(e){return e.quote!=null})}).then(function(e){return e.map(function(e){return e.source="eb_restore",e})}).then(function(t){return e.messages.bulkPut(t).then(function(r){return t.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){n!==!0&&o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})}).then(function(e){var n;return(n=t==null?void 0:t.length)!=null?n:0})})}function _(t){var n=t.msgId,r=t.originalTs,o=t.rowId,a=t.threadJid,i=t.unsendMsgContentDeleteTs,l=babelHelpers.objectWithoutPropertiesLoose(t,e);return l}l.addQuoteDataToReplyMessage=c,l.getQuoteDataFromEchoMessage=d,l.updateQuoteDataForReplyMessages=m,l.enhanceAndPersistReplyMessagesWithQuoteData=p}),98);
__d("MAWHandleEchoReactionsRestore",["MAWAckLevel","MAWAuthor","MAWBulkWriteReactionsTxns","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWTransactionMode","Promise","WAJids","WALogger","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f;function g(e,t,r){r==null||r.addPoint("reactions_restore_start");var o=e.echoMsgMap,a=e.restoredMsgsData,i=0;if(a){var l=a.existingMsgs,s=a.newlyAddedMsgs,u=s.concat(l),c=a.threadJid,d=u.filter(function(e){var t=o.get(e.externalId);return y(o,e)&&t!=null&&C(t)});if(d.length===0)return(f||(f=n("Promise"))).resolve();var m=d.flatMap(function(e){var n=o.get(e.externalId),r=S(a.threadJid,t,e.externalId,e.msgId,e.author,n);return r.map(function(e){return{chatJid:c,unstoredReaction:e}})});return m.length===0?(f||(f=n("Promise"))).resolve():h(m).then(function(e){i+=m.length,r==null||r.addPoint("reactions_restore_end",{int:{reactions:i}})})}return(f||(f=n("Promise"))).resolve()}var h=o("MAWIndexedDb").makeMsgrTransactor({groupInfo:(_=o("MAWTransactionMode")).READWRITE,messages:_.READWRITE,reactions:_.READWRITE,threads:_.READWRITE},"restoreWriteReactionsToDb",function(e){return(function(t){return o("MAWBulkWriteReactionsTxns").prepareReactionsData(e,t).then(function(t){return o("MAWBulkWriteReactionsTxns").bulkWriteReactions(e,t)})})});function y(t,n){var r=t.get(n.externalId);return r==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echo document is absent for a restored msg"]))),!1):o("WAJids").isAuthorSystem(n.author)?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions for system author"]))),!1):o("MAWAuthor").getAuthorUserJid(n.author)==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions empty author"]))),!1):!0}function C(e){return e.reactions!=null&&e.reactions.length!==0&&e.reactionXOfflineThreadingIds!=null&&e.reactionXOfflineThreadingIds.length!==0&&e.reactionAuthoritativeTimestampMs!=null&&e.reactionAuthoritativeTimestampMs.length!==0}function b(e,t,n){return(e==null?void 0:e.length)===0?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction string is not a single character"]))),!1):t==null?(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction external id missing"]))),!1):n==null?(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reactToAuthor field is null"]))),!1):!0}function v(e,t,n){return(e||[]).map(function(e,r){return n==null||t==null||(n==null?void 0:n.length)<=r||(t==null?void 0:t.length)<=r?(o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction fields in backup data uneven in length"]))),[]):[e,t[r],n[r]]})}function S(e,t,n,r,a,i){var l=o("MAWAuthor").getAuthorUserJid(a);if(i==null||l==null)return[];var s=i.reactionAuthoritativeTimestampMs,u=s===void 0?[]:s,c=i.reactionXOfflineThreadingIds,d=c===void 0?[]:c,m=i.reactions;return v(m,d,u).filter(function(e){var t=e[0],n=e[1];return n!=null&&b(t.displayName,n.displayName,o("MAWAuthor").getAuthorUserJid(a))}).map(function(a){var i=a[0],s=a[1],u=a[2],c=i.displayName,d=o("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(i,t),m={ack:d===o("WAJids").AUTHOR_ME?o("MAWAckLevel").ACK.sent:o("MAWAckLevel").ACK.received,author:d,externalId:o("WAStanzaUtils").toStanzaId(s.displayName||""),groupingKey:c,reaction:c,reactToAuthor:l,reactToExternalId:n,senderTimestampMs:null,threadJid:e,ts:o("WATimeUtils").castToUnixTime(Number(u.displayName)/1e3)};return r!=null?babelHelpers.extends({},m,{reactToMsgId:r}):m})}l.writeEchoReactionsToReactionsStore=g,l.getReactionsForReactionStore=S}),98);
__d("MAWHandleEchoXMARestoreV2",["EchoMessage","MAWBridge","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMediaTxns","MAWDbMsg","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWODSProxy","MAWParseXMAProtocol","MAWTransactionMode","WAArmadilloXMA.pb","WAHashUtils","WALogger","WAMediaUtils","WAOdsEnums","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=function(t,n,r){n==null||n.addPoint("xma_restore_start");var e=t.restoredMsgsData;if(e){var a=e.newlyAddedMsgs,i=a.concat(e.existingMsgs),l=[];return i.map(function(e){var n=e.externalId,r=t.echoMsgMap.get(n);r!=null&&r.contentType===o("EchoMessage").EchoMessageContentType.XMA&&l.push(e)}),l.length===0?Promise.resolve():y(l,t.echoMsgMap,r).then(function(e){return n==null||n.addPoint("xma_restore_end",{int:{xma:e.length}}),Promise.resolve()})}return n==null||n.addPoint("xma_restore_end",{int:{xma:0}}),Promise.resolve()};function y(t,n,r){var a=new Map,i=new Map;t.forEach(function(e){var t,r,l=n.get(e.externalId),s=l==null||(t=l.mediaData)==null?void 0:t.attachmentObjectId;s!=null&&a.set(o("WAMediaUtils").stringToDeliveryObjectId(s),e);var u=l==null||(r=l.mediaData)==null?void 0:r.plaintextHash;if(u!=null){var c=o("WAHashUtils").stringToPlaintextHash(o("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(u)),d=i.get(c);i.set(c,d!=null?[].concat(d,[e.msgId]):[e.msgId])}});var l=Array.from(a.keys()),u=new Map;return C(i).then(function(i){var c=[];return l.forEach(function(e){var t,n=(t=a.get(e))==null?void 0:t.externalId;n!=null&&u.set(n,e)}),t.filter(function(e){return o("MAWDbMsg").isXMAMsg(e)}).forEach(function(t){var r=n.get(t.externalId);if(r){var a=u.get(t.externalId),l;if(a!=null){var d=i.get(a);d!=null&&(l=d.mediaId)}var m=r.serializationOrigin;m==null&&(m=o("EchoMessage").EchoSerializationOriginType.UNKNOWN);var p=v(t,r,l,m);p==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] dbXMA is null. EchoMessage origin ",""])),m):(p.targetType===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE&&t.msgContent==null&&(o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] msgContent is null for external link share XMA on Restore. Echo message origin ",""])),m),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"missing_msg_content_external_link_xma"})),c.push(p))}}),b(c).then(function(e){return e.length>0&&e.map(async function(e){var t=u.get(e.externalId);if(r!==!0){var n;t!=null&&(n=i.get(t));var a=await o("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(n,e);o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:a}]})}}),e})})}var C=o("MAWIndexedDb").makeMsgrTransactor({media:o("MAWTransactionMode").READONLY,mediaBackup:o("MAWTransactionMode").READONLY},"restoreGetMediaForXMAByObjectIds",function(e){return function(t){var n=Array.from(t.keys());return o("MAWDbMediaTxns").maybeBulkGetMediaFromPlaintextHash(e,n).then(function(e){var n=new Map;return e.forEach(function(e){var r=t.get(e.plaintextHash);r==null||r.forEach(function(t){var r=e==null?void 0:e.mediaEntries.get(t);if(e!=null&&r!=null){var a=o("WAMediaUtils").decodeMediaEntryData(r);a.objectId!=null&&n.set(o("WAMediaUtils").stringToDeliveryObjectId(a.objectId),e)}else o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][getMediaForXMAByObjectIds] mediaEntry is null for media restore"])))})}),n})}}),b=o("MAWIndexedDb").makeMsgrTransactor({xma:o("MAWTransactionMode").READWRITE},"restoreWriteXMAsToDb",function(e){return function(t){return e.xma.bulkAdd(t,{allKeys:!0}).then(function(e){return e.map(function(e,n){return babelHelpers.extends({},t[n],{xmaId:e})})})}});function v(e,t,n,r){var a,i,l,s,u,h,y,C,b,v,R,L,E,k,I,T;if(t.xmaData==null)return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaData is missing in the echo doc. Echo message origin ",""])),r),null;var D;if(t.xmaData.xmaDefaultCTA!=null){var x;D=S((x=t.xmaData)==null?void 0:x.xmaDefaultCTA)}else o("WALogger").WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaDefaultCTA field is not present in the echo doc. Echo message origin ",""])),r);var $;if(((a=t.xmaData)==null?void 0:a.xmaTargetType)!=null)$=o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(t.xmaData.xmaTargetType);else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaTargetType field is not present in the echo doc. Echo message origin ",""])),r),null;var P;((i=t.xmaData)==null?void 0:i.xmaGatingType)!=null?P=o("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(t.xmaData.xmaGatingType):o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaGatingType field is not present in the echo doc. Echo message origin ",""])),r);var N;((l=t.xmaData)==null?void 0:l.xmaLayoutType)!=null?N=o("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(t.xmaData.xmaLayoutType):o("WALogger").WARN(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaLayoutType field is not present in the echo doc. Echo message origin ",""])),r);var M;if(e.threadJid!=null)M=e.threadJid;else return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid field is not present in the restoredMsg. Echo message origin ",""])),r),null;if(D!=null&&!o("MAWParseXMAProtocol").isValidCTA(D,$,!0))return o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid CTA observed while restoring XMA. Echo message origin ",""])),r),null;var w;return((s=t.xmaData)==null?void 0:s.xmaContentRef)!=null&&(w=t.xmaData.xmaContentRef),{author:e.author,contentRef:w,ctas:[],defaultCTA:D,defaultPreviewMediaId:n!=null?n:void 0,externalId:e.externalId,headerTitle:t==null||(u=t.xmaData)==null?void 0:u.xmaHeaderTitle,isTombstoned:t==null||(h=t.xmaData)==null?void 0:h.xmaIsTombstoned,maxSubtitleNumOfLines:t==null||(y=t.xmaData)==null?void 0:y.xmaMaxSubtitleNumLines,maxTitleNumOfLines:t==null||(C=t.xmaData)==null?void 0:C.xmaMaxTitleNumLines,msgId:e.msgId,overlayIconGlyph:P,overlayTitle:t==null||(b=t.xmaData)==null?void 0:b.xmaHeaderSubtitle,previewMediaIds:n!=null?[n]:[],subtitleText:t==null||(v=t.xmaData)==null?void 0:v.xmaSubtitleText,targetExpiringAtSec:((R=t.xmaData)==null?void 0:R.xmaTargetExpiry)!=null?o("WATimeUtils").castToUnixTime(Number((L=t.xmaData)==null?void 0:L.xmaTargetExpiry)):void 0,targetId:t==null||(E=t.xmaData)==null?void 0:E.xmaTargetId,targetType:$,targetUsername:t==null||(k=t.xmaData)==null?void 0:k.xmaTargetUsername,threadJid:M,titleText:(I=t.xmaData)==null?void 0:I.xmaTitleText,xmaDataclass:(T=t.xmaData)==null?void 0:T.xmaDataclass,xmaLayoutType:N}}function S(e){return{actionUrl:e,buttonType:o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_CTA_BUTTON_TYPE.OPEN_NATIVE,nativeUrl:e}}l.writeXMAToXMAStore=h,l.getMediaForXMAByObjectIds=C,l.writeXMAsToDb=b,l.getDefaultCTA=S}),98);
__d("MessageBackupSupplementalKeyGenerator",["$InternalEnum","MAWJids","WAGlobals","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({REACTION:"reaction",EDIT:"edit",RAVEN_ACTION_MESSAGE:"raven_action_message"}),s=":";function u(e,t){return""+e+s+t}function c(e){return e.split(s)[1]}function d(e,t){var n=t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),r=new RegExp("^"+n,"i");return r.test(e)}function m(t){return d(t,e.REACTION)}function p(t){return d(t,e.EDIT)}function _(t){return d(t,e.RAVEN_ACTION_MESSAGE)}function f(t){var n=t.split(s);if(n.length===1)return{rawIdentifierString:t,type:"poll_update"};var r=n[0];if(n.length<2||n.length>3)return{prefix:r,rawIdentifierString:t,type:"unknown"};var a=n[1],i=o("MAWJids").toUserJid(a);if(r===e.REACTION)return{senderJid:i,type:"reaction"};var l=n.length===3?o("WATimeUtils").castToMillisTime(Number(n[2])):null;return r===e.RAVEN_ACTION_MESSAGE?{senderJid:i,type:"raven_action_message"}:l==null?{prefix:r,rawIdentifierString:t,type:"unknown"}:r===e.EDIT?{senderJid:i,ts:l,type:"edit"}:{prefix:r,rawIdentifierString:t,type:"unknown"}}function g(t){switch(t.type){case"edit":return""+e.EDIT+s+o("WAJids").extractUserId(t.senderJid)+s+t.ts.toString();case"reaction":return""+e.REACTION+s+o("WAJids").extractUserId(t.senderJid);case"raven_action_message":return""+e.RAVEN_ACTION_MESSAGE+s+o("WAJids").extractUserId(t.senderJid);case"poll_update":return t.rawIdentifierString}}function h(t){var n;if(o("WAJids").isAuthorMe(t))n=o("WAGlobals").getMyUserJid();else{var r=o("WAJids").interpretAndValidateJid(t);if(r.jidType==="msgrUser")n=r.userJid;else return null}var a=o("WAJids").userIdFromJid(n);return""+e.REACTION+s+a}function y(t,n){var r;if(o("WAJids").isAuthorMe(t))r=o("WAGlobals").getMyUserJid();else{var a=o("WAJids").interpretAndValidateJid(t);if(a.jidType==="msgrUser")r=a.userJid;else return null}var i=o("WAJids").userIdFromJid(r);return""+e.EDIT+s+i+s+n.toString()}l.SupplementalKeyPrefix=e,l.SUPPLEMENTAL_KEY_DELIMITER=s,l.createMessageSupplementalKey_DEPRECATED=u,l.getSupplementalSenderId_DEPRECATED=c,l.isSupplementalProtobufAReaction=m,l.isSupplementalProtobufAnEdit=p,l.isSupplementalProtobufARavenAction=_,l.parseIdentifierString=f,l.toIdentifierString=g,l.createReactionSupplementalKey=h,l.createEditSupplementalKey=y}),98);
__d("PersistedQueuesSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(t,n,r,o,a,i,l){"use strict";var e={autoIncrement:!0,indexes:{"[jid+priority+stanzaId]":{fields:["jid","priority","stanzaId"],unique:!1},priority:{fields:["priority"],unique:!1}},nonEncryptedFields:["priority","stanzaId"],primaryKey:"stanzaQueueId",secure:!0},s={autoIncrement:!0,indexes:{},nonEncryptedFields:["uploadStatus","uploadTsSec","backupActionType"],primaryKey:"queueId",secure:!0},u={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0},c={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0},d={danglingQueue:u,ebSenderUploadQueueV3:c,ebUploadQueue:s,stanzaQueue:e};function m(e,t,n,r,a,i){var l=o("WAHex").parseHex(t),s="pqdb",u=new(o("WormEAR")).WormEAR(d,s,l);return new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,s,d,u,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:r,onTransactionError:a}),i)}l.makePersistedQueueSchema=m}),98);
__d("PersistedQueueDB",["FBLogger","PersistedQueuesSchema","WAResolvable","WormEAR","err","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;async function u(t){var n=t.blockingErrorThreshold,a=t.dbName,i=t.onBlockingError,l=t.qplEvent,u=t.strEncKey;try{var c=o("PersistedQueuesSchema").makePersistedQueueSchema(a,u,n,i,function(t){if(t instanceof o("WormEAR").DecryptionError){var n,a,i=t;r("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",i.store),r("promiseDone")((n=(a=e)==null?void 0:a.runInTransaction([i.store],"readwrite",function(e){var t=e.stores[i.store];return i.maybeHashedPk!=null?t.delete(i.maybeHashedPk):t.clear()},"delete-corrupted-entity"))!=null?n:Promise.resolve())}},l);return e=c,await c.init(),s.resolve(c),c}catch(e){throw r("FBLogger")("messenger_web").catching(r("getErrorSafe")(e)).mustfix("Error performing PersistedQueue init"),e}}function c(){if(e==null)throw r("err")("PersistedQueue is not initialized");return e}function d(){return s.promise}l.makePersistedQueues=u,l.getPersistedQueues=c,l.getDbPromise=d}),98);
__d("WAThrottle",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=0,r=null,o;function a(){for(var a=Date.now(),i=a-n,l=arguments.length,s=new Array(l),u=0;u<l;u++)s[u]=arguments[u];o=s,i>=t?(clearTimeout(r),r=null,e.apply(void 0,s),n=Date.now()):r==null&&(r=setTimeout(function(){return e.apply(void 0,o)},t-i))}return a}i.throttle=e}),66);
__d("PersistedQueueApi",["PersistedQueueDB","WALogger","WAThrottle"],(function(t,n,r,o,a,i,l){"use strict";var e,s=36e5,u=function(t,n){return"PersistedQueue:"+t+":"+n};function c(){return{ack:p,clear:_,count:b,delete:f,get:d,index:m,keys:h,read:g,write:y}}function d(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){var r=n.stores[e];return r.get(t)},u(e,"get"))}function m(e,t){return{equals:function(r){return{read:function(a){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndexRange(t,{only:r},a)},u(e,"index-equal"))}}},keys:function(){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndexKeys(t)},"index-keys")},read:async function(r){var n=await o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndex(t,void 0,r)},u(e,"index-read"));return n}}}function p(e,t){return f(e,t)}function _(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",function(t){return t.stores[e].clear()},u(e,"clear"))}function f(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",async function(n){var r=n.stores[e];await r.bulkDelete(t),v(e)},u(e,"delete"))}function g(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readAll(t)},u(e,"read"))}function h(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(t){return t.stores[e].readKeys()},u(e,"keys"))}function y(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",function(n){return n.stores[e].bulkAdd(t)},u(e,"write"))}function C(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",async function(t){var n=t.stores[e],r=await n.readAll({limit:1});r.length===0&&await n.clear()},u(e,"ClearIfEmpty"))}function b(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(t){return t.stores[e].count()},u(e,"count"))}var v=o("WAThrottle").throttle(function(t){C(t).catch(function(n){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueueV2] Error during PQ clear operation of ",": ",""])),t,n)})},s);l.persistedQueueApi=c,l.persistedQueueGet=d,l.persistedQueueIndex=m,l.persistedQueueAck=p,l.persistedQueueClear=_,l.persistedQueueDelete=f,l.persistedQueueRead=g,l.persistedQueueKeys=h,l.persistedQueueWrite=y,l.clearIfEmpty=C,l.persistedQueueCount=b}),98);
__d("WAMapContentTypeToFbType",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"text":return"text";case"media":return"media";case"reaction":return"reaction";case"live_location":case"pay":case"product_list":case"poll_creation":case"poll_vote":case"scheduled_call":return"text";default:return"text"}}i.mapContentTypeToFbType=e}),66);
__d("WAPersistedQueueCache",["WAResolvable","WAShiftTimer","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r){var a=o("WATagsLogger").TAGS(["PersistedQueue",t,"cache"]),i=[],l=new(o("WAResolvable")).Resolvable,s=r!=null?r:{},u=new(o("WAShiftTimer")).ShiftTimer(function(){m()});return{commit:function(){return m()},add:function(t){i.push(t);var e=l;return c(),d(),e.promise},config:function(t){s=t}};function c(){s.cacheSize!=null&&i.length>=s.cacheSize&&m()}function d(){if(s.maxDelay!=null){var e=s.maxDelay;u.cancel(),u.onOrAfter(e)}}async function m(){if(i.length!==0){u.cancel();var t=i;i=[];var r=l;l=new(o("WAResolvable")).Resolvable;try{await n(t),r.resolve()}catch(t){throw a.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error during flush: ",""])),t),r.reject(t),t}}}}l.makePersistedQueueCache=s}),98);
__d("WAPersistedQueue",["WAPersistedQueueCache","WAPubSub"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n){var r=this;this.$1=o("WAPubSub").simplePubSub(),this.$3=e,this.$4=t,this.$2=o("WAPersistedQueueCache").makePersistedQueueCache(e,function(n){return t.write(e,n).then(function(e){r.$1.publish({type:"flush"})})},n)}var t=e.prototype;return t.subscribe=function(t){return this.$1.subscribe(t)},t.index=function(e){return this.$4.index(this.$3,e)},t.keys=function(){return this.$4.keys(this.$3)},t.get=function(t){return this.$4.get(this.$3,t)},t.read=function(t){return this.$4.read(this.$3,t)},t.addAndCommit=function(t){var e=this;return this.$1.publish({type:"new_entity"}),this.$4.write(this.$3,t).then(function(t){return e.$1.publish({type:"flush"}),t})},t.commit=function(){return this.$2.commit()},t.ack=function(t){return this.$4.ack(this.$3,t)},t.delete=function(t){return this.$4.delete(this.$3,t)},t.clear=function(){return this.$4.clear(this.$3)},t.count=function(){return this.$4.count(this.$3)},e})();function s(t,n,r){return new e(t,n,r)}l.PersistedQueue=e,l.initPersistedQueue=s}),98);
__d("WAProtocolQueue",["PersistedQueueApi","WAGlobals","WAJids","WALogger","WAMapContentTypeToFbType","WAPersistedQueue"],(function(t,n,r,o,a,i,l){"use strict";var e,s=5e3,u=null;function c(t){if(u!=null)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Protocol Queue is already initialized"]))),u;var n=o("WAPersistedQueue").initPersistedQueue("stanzaQueue",t,{cacheSize:null,maxDelay:s});return u=n,u}function d(){return u||c(o("PersistedQueueApi").persistedQueueApi())}var m=(function(){function e(){this.$1=[],this.$2=[],this.$3=[]}var t=e.prototype;return t.enqueue=function(t,n,r){this.$1.push(t),n&&this.$2.push(n),r&&this.$3.push(r)},t.flush=function(t,n,r,o){var e=this.$1,a=this.$2,i=this.$3;return this.$1=[],this.$2=[],this.$3=[],d().addAndCommit(e).then(function(){return a.forEach(function(e){return e()})}).catch(function(e){return i.forEach(function(t){return t(e)})})},e})(),p=new m;function _(e){return e.map(function(e){return e.type==="message"?f(e):babelHelpers.extends({},e)})}function f(e){switch(e.subtype){case"unavailable":{var t=e,n=o("WAJids").extractUserJid(t.from),r={id:{author:o("WAGlobals").getMyUserJid()===n?"@me":n,chat:t.jid,externalId:t.stanzaId},ts:t.serverTs,type:"UnavailableMsg"};return{incomingType:"wa-incoming",jid:t.jid,message:{decrypted:r,details:{count:null,externalId:t.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(t.jid,{group:function(n){return{author:t.from,chat:n,groupJid:n,type:"group"}},user:function(n){return{author:t.from,chat:n,deviceJid:t.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:t.offline,recipient:t.recipient,reportingMeta:t.reportingMeta,retryCount:t.retryCount,ts:t.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(t.contentType)}},priority:t.priority,stanzaId:t.stanzaId,stanzaQueueId:e.stanzaQueueId,type:t.type}}case"armadillo":{var a=e,i=o("WAJids").extractUserJid(a.from),l={folder:a.fbFolderId,id:{author:o("WAGlobals").getMyUserJid()===i?"@me":i,chat:a.jid,externalId:a.stanzaId},msg:a.message,recipientsCount:null,reportingMeta:a.reportingMeta,ts:a.serverTs,type:"IncomingMsg"};return{incomingType:e.incomingType,jid:a.jid,message:{decrypted:l,details:{count:null,externalId:a.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(t){return{author:a.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:a.from,chat:t,deviceJid:a.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:a.offline,recipient:a.recipient,reportingMeta:a.reportingMeta,retryCount:a.retryCount,ts:a.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(a.contentType)}},priority:a.priority,stanzaId:a.stanzaId,stanzaQueueId:e.stanzaQueueId,type:a.type,ebTimestampMs:a.ebTimestampMs}}case"instamadillo":{var s=e,u=o("WAJids").extractUserJid(s.from),c={folder:s.fbFolderId,id:{author:o("WAGlobals").getMyUserJid()===u?"@me":u,chat:s.jid,externalId:s.stanzaId},msg:s.message,recipientsCount:null,reportingMeta:s.reportingMeta,ts:s.serverTs,type:"InstamadilloMsg"};return{incomingType:"wa-incoming",jid:s.jid,message:{decrypted:c,details:{count:null,externalId:s.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(s.jid,{group:function(t){return{author:s.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:s.from,chat:t,deviceJid:s.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!0,offline:s.offline,recipient:s.recipient,reportingMeta:s.reportingMeta,retryCount:s.retryCount,ts:s.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(s.contentType)}},priority:s.priority,stanzaId:s.stanzaId,stanzaQueueId:e.stanzaQueueId,type:s.type}}case"ciphertext":{var d=function(){return!(m.contentType==="reaction"||m.hideDecryptionFailure===!0)},m=e,p=o("WAJids").extractUserJid(m.from),_={createPlaceholder:d(),id:{author:o("WAGlobals").getMyUserJid()===p?"@me":p,chat:m.jid,externalId:m.stanzaId},ts:m.serverTs,type:"IncomingCiphertextMsg"};return{incomingType:"wa-incoming",jid:m.jid,message:{decrypted:_,details:{count:null,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(m.contentType),externalId:m.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(m.jid,{group:function(t){return{author:m.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:m.from,chat:t,deviceJid:m.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:m.offline,recipient:m.recipient,reportingMeta:m.reportingMeta,retryCount:m.retryCount,ts:m.serverTs}},priority:m.priority,stanzaId:m.stanzaId,stanzaQueueId:e.stanzaQueueId,type:m.type}}default:return babelHelpers.extends({},e)}}var g=9,h=7,y=5,C=2;function b(e){return e}function v(e){return e}function S(e){return e}l.initProtocolQueue=c,l.protocolQueue=d,l.PQFlushable=m,l.pqFlushable=p,l.mapProtocolEntriesV2toV1=_,l.mapProcolQueueMessageV2toV1=f,l.WAProtocolQueuePriorityHigh=g,l.WAProtocolQueuePriorityMid=h,l.WAProtocolQueuePriorityLow=y,l.WAProtocolQueuePriorityBackground=C,l.appdataApplicationProtocol=b,l.extractSubProtocolFromAppdataProtocol=v,l.numberToStanzaQueueId=S}),98);
__d("MAWHandleEBRestoreWithHIM",["EBAPIWorkerCheck","EchoMessage","EncryptedBackupsUploadEntity","FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWBulkEditMsgsTxns","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMsg","MAWEchoToProtobufConversionLoggingUtils","MAWFrontendMediaUtils","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoReactionsRestore","MAWHandleEchoXMARestoreV2","MAWJids","MAWMsgType","MAWODSProxy","MAWParseXMAProtocol","MAWUnsafeCoerce","MAWUserJidWrapper","MessageBackupSupplementalKeyGenerator","MpsTags","Random","WAGlobals","WAHashUtils","WAJids","WALogger","WALongInt","WAOdsEnums","WAProtocolQueue","WAResultOrError","WASortedLists","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["originalTs","threadJid","unsendMsgContentDeleteTs"],s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k;function I(e,t){return e==="@me"||e==="@system"?t:e}function T(e,t,n,r,a){var i=[];if(e.reactionXOfflineThreadingIds!=null)for(var l=0;l<e.reactionXOfflineThreadingIds.length;++l){var s=o("MAWHandleEchoReactionsRestore").getReactionsForReactionStore(t,n,r,null,a,e),u=s.map(function(e){return{decodedMsg:{unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:e,unstoredDbReceiverFetchInfo:void 0},stanza:P(e.externalId,e.ts,I(e.author,n),t,"reaction")}});i.push.apply(i,u)}return i}function D(e,t,n,r,a){return r.map(function(r){if(r.messageId==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] messageId is null in edit, original externalId: ",""])),e),a!=null&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(a,"getUnstoredDbEditsFromEcho_messageId_missing"),null;var i=r.messageId;return{decodedMsg:{unstoredDbEditActionMsg:{ack:o("MAWAckLevel").ACK.sent,author:n,editMsgContent:{content:r.text},externalId:o("WAStanzaUtils").toStanzaId(i),originalMsgExternalId:e,serverTs:o("WATimeUtils").castToUnixTime(r.timestamp),ts:o("WATimeUtils").castToUnixTime(r.timestamp),type:o("MAWMsgType").MSG_TYPE.EDIT_ACTION},unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:void 0},stanza:P(o("WAStanzaUtils").toStanzaId(i),o("WATimeUtils").castToUnixTime(r.timestamp),n,t,"text")}}).filter(Boolean)}function x(e,t){return e.map(F).filter(Boolean).map(function(e){return $(e,t)})}function $(e,t){var n,a=o("MAWUserJidWrapper").getMyUserJid(),i=e.from,l=o("MAWHandleEchoMsgsRestoreApiUtils").getDbMsgTypeFromEchoMessage(e);if(i==null||l==null)return[];var s=e.xOfflineThreadingId;if(s==null)return r("FBLogger")("wmi_eb").warn("xOfflineThreadingId is null for Echo message"),[];var u=o("WAStanzaUtils").toStanzaId(s),c=o("WATimeUtils").castToUnixTime(((n=e.authoritativeTimestampMs)!=null?n:e.sortOrderMs)/1e3),d=o("MAWJids").toUserJid(i.localKey),m=A(e,t,a,u,"echo_content");if(m.success===!1)return[];var p=m.value,_=T(e,t,a,u,d),f=e.contentType===o("EchoMessage").EchoMessageContentType.TEXT||e.contentType===o("EchoMessage").EchoMessageContentType.PLACEHOLDER?"text":"media",g=D(u,t,d,e.editHistory);return[{decodedMsg:p,stanza:P(u,c,d,t,f)}].concat(_,g)}function P(e,t,n,r,a){var i={applicationPayload:new Uint8Array(0).buffer,backupDirective:null,icdc:null,metadata:null,protobuf:new Uint8Array(0),subprotocol:new Uint8Array(0),subprotocolType:"consumerMessage",type:"subprotocol",version:"v3"},l={folder:null,id:{author:n,chat:r,externalId:e},msg:i,recipientsCount:null,reportingMeta:null,ts:t,type:"IncomingMsg"};return{incomingType:"ebrestore",jid:r,message:{decrypted:l,details:{count:0,externalId:e,from:o("WAJids").switchOnMsgrChatJidType(r,{group:function(t){return{author:o("WAJids").defaultDeviceJidForUser(n),chat:t,groupJid:t,type:"group"}},user:function(t){return{author:o("WAJids").defaultDeviceJidForUser(n),chat:t,deviceJid:o("WAJids").defaultDeviceJidForUser(n),type:"device"}}}),hideDecryptionFailure:!0,isInstamadillo:!1,offline:null,recipient:null,reportingMeta:null,retryCount:0,ts:t,type:a}},priority:o("WAProtocolQueue").WAProtocolQueuePriorityLow,stanzaId:e,stanzaQueueId:o("MAWUnsafeCoerce").unsafeCoerce(-1),type:"message"}}function N(e){if(e.mediaData==null)return o("WAResultOrError").makeResult(null);var t=e.previewMediaData,n=e.sortOrderMs,r=e.xOfflineThreadingId,a=e.mediaData,i=a.attachmentObjectId,l=a.backupEntFbid,s=a.directPath,d=a.encryptedHash,m=a.filename,p=a.height,_=a.mediaContentType,f=a.mediaKey,g=a.mediaKeyTimestamp,h=a.mediaPlayableDuration,y=a.plaintextHash,C=a.previewContentHeight,b=a.previewContentWidth,v=a.size,S=a.width,R=e.contentType===o("EchoMessage").EchoMessageContentType.XMA,L=o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(_||"",R),E=L.mediaType,k=L.serverMediaType,I=o("WAHashUtils").stringToPlaintextHash(o("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(y)),T=null;if(t!=null)try{T=o("MAWHandleEchoMediaMsgsRestoreV2").constructRawDownloadableThumbnail(t),T!=null&&T.objectId==null&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloadableThumbnail was created without metadata, source: protobuf"])))}catch(t){o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",", msg id: ",". Echo message origin ",""])),t,r,e.serializationOrigin)}if(f==null)return o("WAResultOrError").makeError("missing_media_key");if(d==null)return o("WAResultOrError").makeError("missing_encrypted_hash");var D=o("MAWHandleEchoMediaMsgsRestoreV2").constructMediaEntry(I,d,f,s,g,k,m,l,i,T,v),x=o("MAWHandleEchoMediaMsgsRestoreV2").getMediaInfo({filename:m,height:p,mediaPlayableDuration:h,mediaType:E,previewContentHeight:C,previewContentWidth:b,width:S}),$=x.validatedAudioInfo,P=x.validatedDocumentFileInfo,N=x.validatedImageInfo,M=x.validatedVideoInfo;return o("WAResultOrError").makeResult({mediaEntry:D,mediaType:E,msgIds:o("WASortedLists").asSortedSet(new Set),plaintextHash:o("WAHashUtils").stringToPlaintextHash(y),size:v||0,ts:g!=null?o("WATimeUtils").castToUnixTime(g):o("WATimeUtils").castMilliSecondsToUnixTime(n),validatedAudioInfo:$,validatedDocumentFileInfo:P,validatedImageInfo:N,validatedVideoInfo:M})}function M(e,t){if(e.xmaData==null||e.from==null||e.xOfflineThreadingId==null)return o("WAResultOrError").makeResult(null);var n=e.from,r=e.serializationOrigin,a=e.xmaData,i=e.xOfflineThreadingId,l=a.xmaContentRef,s=a.xmaDataclass,u=a.xmaDefaultCTA,c=a.xmaGatingType,p=a.xmaHeaderSubtitle,_=a.xmaHeaderTitle,f=a.xmaIsTombstoned,g=a.xmaLayoutType,h=a.xmaMaxSubtitleNumLines,y=a.xmaMaxTitleNumLines,C=a.xmaSubtitleText,b=a.xmaTargetExpiry,v=a.xmaTargetId,S=a.xmaTargetType,R=a.xmaTargetUsername,L=a.xmaTitleText;if(S==null)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Mandatory XMA Data missing for XMA message. Echo message origin ",""])),r),o("WAResultOrError").makeError("xma_mandatory_fields_missing");var E=o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(S),k;if(u!=null&&(k=o("MAWHandleEchoXMARestoreV2").getDefaultCTA(u)),k!=null&&!o("MAWParseXMAProtocol").isValidCTA(k,E,!0))return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] defautlCTA failed validation check. Echo message origin ",""])),r),o("WAResultOrError").makeError("xma_cta_validation_failure");var I;c!=null&&(I=o("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(c));var T;b!=null&&(T=o("WATimeUtils").castToUnixTime(b));var D;return g!=null&&(D=o("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(g)),o("WAResultOrError").makeResult({unstoredDbXMA:{author:o("MAWJids").toUserJid(n.localKey),contentRef:l,ctas:[],defaultCTA:k,externalId:o("WAStanzaUtils").toStanzaId(i),headerTitle:_,isTombstoned:f,maxSubtitleNumOfLines:h,maxTitleNumOfLines:y,overlayDescription:p,overlayIconGlyph:I,overlayTitle:_,subtitleText:C,targetExpiringAtSec:T,targetId:v,targetType:E,targetUsername:R,threadJid:t,titleText:L,xmaDataclass:s,xmaLayoutType:D}})}function w(e){if(e.receiverFetchId==null||e.receiverFetchData==null)return o("WAResultOrError").makeResult(null);var t=e.receiverFetchData,n=e.receiverFetchId;return t.type!=="sticker"?(o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unsupported receiver fetch message type: ",". Echo message origin ",""])),t.type,e.serializationOrigin),o("WAResultOrError").makeError("unsupported_message_type")):o("WAResultOrError").makeResult({mimetype:t.mimetype,previewHeight:t.previewHeight,previewWidth:t.previewWidth,receiverFetchId:n,type:t.type})}function A(t,n,r,a,i){var l=o("MAWHandleEchoMsgsRestoreApiUtils").getUnstoredDbMessageFromEchoMessage(t,n,r,a,void 0,i);if(l.success===!1)return o("WAResultOrError").makeError(l.error);var s=l.value,u=s.originalTs,c=s.threadJid,d=s.unsendMsgContentDeleteTs,m=babelHelpers.objectWithoutPropertiesLoose(s,e);m.sortOrderMs=t.sortOrderMs;var p=N(t);if(p.success===!1)return p;var _=M(t,n);if(_.success===!1)return o("WAResultOrError").makeError(_.error);var f=_.value,g=w(t);if(g.success===!1)return o("WAResultOrError").makeError(g.error);var h=g.value;return o("WAResultOrError").makeResult({unstoredDbMedia:p.value,unstoredDbMsg:m,unstoredDbReaction:void 0,unstoredDbReceiverFetchInfo:h!=null?h:void 0,unstoredXMA:f!=null?f:void 0})}function F(e){try{return o("EchoMessage").decodeEchoMessage(e)}catch(e){return o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode echo message: ",""])),e),null}}function O(e,t){if(!o("EBAPIWorkerCheck").runningInWorker())throw r("FBLogger")("messenger_web").mustfixThrow("convertEchoMessagesToEBProtobufs should be called from the worker thread");var n=e.map(function(e){return B(e,t)}).filter(Boolean);return o("MAWODSProxy").odsBumpEntityKey({amount:n.length,entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.success"}),n.length!==e.length&&(o("WALogger").WARN(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to convert all echo messages to protobuf. Chat: ",", echo messages count: ",", converted echo messages count: ",""])),t,e.length,n.length),o("MAWODSProxy").odsBumpEntityKey({amount:e.length-n.length,entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.fail"})),n}function B(e,t){var n=r("Random").uint32();o("MAWEchoToProtobufConversionLoggingUtils").startQplUserFlow(n);var a=F(e);if(a==null)return o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to decode echo message"]))),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"echo_decode_failure"),null;var i=o("WAGlobals").getMyUserJid(),l=a.from,s=a.sortOrderMs,u=a.xOfflineThreadingId,c=o("WATimeUtils").castToMillisTime(s);if(u==null||l==null)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] One of the mandatory fields is null for Echo message. Echo message origin ",""])),a.serializationOrigin),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"mandatory_fields_missing"),null;var d=o("MAWJids").toUserJid(l.localKey),m=o("WAStanzaUtils").toStanzaId(u),p=A(a,t,i,m,"first_edit_content");if(p.success===!1)return o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: ",""])),p.error),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"echo_message_parsing_failure_"+p.error),null;if(p.value.unstoredDbMsg==null)return o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: unstoredDbMsg missing in UnstoredDbContent"]))),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"unstoredDbMsg_conversion_failure_unstoredDbMsg_missing"),null;var _=p.value,f=_.unstoredDbMedia,I=_.unstoredDbMsg,x=_.unstoredDbReceiverFetchInfo,$=_.unstoredXMA,P={author:d,chat:t,externalId:m};I!=null&&(I.msgId=o("MAWDbMsg").stanzaIdToMsgId(m)),($==null?void 0:$.unstoredDbXMA)!=null&&($.unstoredDbXMA.msgId=o("MAWDbMsg").stanzaIdToMsgId(m)),f!=null&&(f.msgIds=o("WASortedLists").asSortedSet(new Set([o("MAWDbMsg").stanzaIdToMsgId(m)])));var N;($==null?void 0:$.unstoredDbXMA)!=null&&(N={associatedMessage:null,defaultPreview:f!=null?f:null,favicon:null,header:f!=null?f:null,previews:f!=null?[f]:null,xma:$.unstoredDbXMA});var M={frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},w;try{w={decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeMessageApplication(I,f,null,N,t,x),msgId:P,reportingMeta:M,sortOrderMs:c})),protobufTimestampMS:c}}catch(e){return o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"top_level_protobuf_encoding_failure"),o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Exception when trying to encode top-level protobuf: ",""])),e),null}var O=new Map,B=D(m,t,d,a.editHistory).map(function(e){var t;return(t=e.decodedMsg)==null?void 0:t.unstoredDbEditActionMsg}).filter(Boolean).filter(function(e){return e.externalId!==e.originalMsgExternalId}).map(function(e){return o("MAWBulkEditMsgsTxns").getMessageHistory(e,t)});B.length>0&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"convert_edits"),B.forEach(function(e){var r=e.author,a=e.editTs,i=o("MessageBackupSupplementalKeyGenerator").createEditSupplementalKey(r,o("WATimeUtils").castUnixTimeToMillisTime(a));if(i==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_key_generation_failure"),o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create edit supplemental key"])));return}if(e.editExternalId==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_key_generation_failure"),o("WALogger").ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to fetch edit external id"])));return}var l=e.editExternalId;try{O.set(i,{decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeEditMessageApplication(e),msgId:{author:d,chat:t,externalId:l},reportingMeta:M,sortOrderMs:o("WATimeUtils").castUnixTimeToMillisTime(e.editTs)})),protobufTimestampMS:o("WATimeUtils").castUnixTimeToMillisTime(a)})}catch(e){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_protobuf_encoding_failure"),o("WALogger").ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode edit supplemental protobuf: ",""])),e)}});var W=T(a,t,i,m,d).map(function(e){var t;return(t=e.decodedMsg)==null?void 0:t.unstoredDbReaction}).filter(Boolean);W.length>0&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"convert_reactions"),W.forEach(function(e){var r=e.author,a=e.senderTimestampMs,i=e.ts,l=a!=null?o("WATimeUtils").castToMillisTime(o("WALongInt").numberOrThrowIfTooLarge(a)):o("WATimeUtils").castUnixTimeToMillisTime(i),s=o("MessageBackupSupplementalKeyGenerator").createReactionSupplementalKey(r);if(s==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"reaction_supplemental_key_generation_failure"),o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create reaction supplemental key"])));return}try{O.set(s,{decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeReactionMessageApplication(e),msgId:{author:d,chat:t,externalId:e.externalId},reportingMeta:M,sortOrderMs:l})),protobufTimestampMS:l})}catch(e){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"reaction_supplemental_protobuf_encoding_failure"),o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode reaction supplemental protobuf: ",""])),e)}}),o("MAWEchoToProtobufConversionLoggingUtils").endSuccess(n);var q;try{q=o("MpsTags").getTagFromProto(w.decryptedProtobuf)}catch(e){o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to get tag from proto: ",""])),e)}return{otid:m,supplementalProtobufs:O,tags:q!=null?[q]:[],toplevelProtobuf:w}}l.convertEchoMessages=x,l.convertEchoMessagesToEBProtobufs=O}),98);
__d("MWEBODSUtils",["CurrentMessengerUser","MWEBODSCategory","ODS"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,a){var i=o("CurrentMessengerUser").getAppID(),l=i!=null?i.toString():"unknown",s=t+"."+l;(e||(e=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),s,n,a!=null?a:1),e.bumpEntityKey(r("MWEBODSCategory"),t,n,a!=null?a:1)}l.markODSForEB=s}),98);